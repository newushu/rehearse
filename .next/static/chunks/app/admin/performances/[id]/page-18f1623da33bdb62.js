(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[670],{1517:(e,t,a)=>{"use strict";a.d(t,{AppBrand:()=>i});var r=a(5155),s=a(2619),n=a.n(s),l=a(6979);function i(e){let{href:t="/",textClassName:a="text-2xl font-bold",logoClassName:s=""}=e,i=(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)(l.v,{className:"border border-white/30 bg-white/10 text-white/60 ".concat(s)}),(0,r.jsx)("span",{className:a,children:"Performance Tool"})]});return t?(0,r.jsx)(n(),{href:t,className:"flex items-center gap-3",children:i}):i}},1712:(e,t,a)=>{Promise.resolve().then(a.bind(a,8090))},6979:(e,t,a)=>{"use strict";a.d(t,{v:()=>l});var r=a(5155),s=a(5239),n=a(2115);function l(e){let{size:t=36,className:a="",imgClassName:l=""}=e,[i,o]=(0,n.useState)(null);return(0,n.useEffect)(()=>{let e=!0;return(async()=>{try{let t=await fetch("/api/app-logo");if(!t.ok)return;let a=await t.json();e&&o(a.logoUrl||null)}catch(e){}})(),()=>{e=!1}},[]),(0,r.jsx)("div",{className:"flex items-center justify-center overflow-hidden ".concat(a),style:{width:t,height:t,borderRadius:8},children:i?(0,r.jsx)(s.default,{src:i,alt:"App logo",width:t,height:t,unoptimized:!0,className:"max-w-full max-h-full object-contain ".concat(l)}):(0,r.jsx)("span",{className:"text-[10px] font-semibold uppercase tracking-wide",children:"Logo"})})}},8090:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>w});var r=a(5155),s=a(2115),n=a(2619),l=a.n(n);function i(e){let[t,a]=(0,s.useState)([]),[r,n]=(0,s.useState)(!0),[l,i]=(0,s.useState)(null);(0,s.useEffect)(()=>{if(!e){a([]),n(!1);return}!async function(){try{let t=await fetch("/api/rehearsals?performanceId=".concat(e));if(!t.ok)throw Error("Failed to fetch rehearsals");let r=await t.json();a(r)}catch(e){i(e instanceof Error?e.message:"An error occurred")}finally{n(!1)}}()},[e]);let o=async(r,s)=>{if(!e)throw Error("Performance ID is required");try{let n=await Promise.all(s.map(t=>fetch("/api/rehearsals",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:e,title:r,date:t.date,time:t.time,location:t.location})})));for(let e of n)if(!e.ok)throw Error("Failed to create rehearsal");let l=await Promise.all(n.map(e=>e.json()));return a([...t,...l]),l}catch(e){throw i(e instanceof Error?e.message:"An error occurred"),e}},d=async e=>{try{if(!(await fetch("/api/rehearsals/".concat(e),{method:"DELETE"})).ok)throw Error("Failed to delete rehearsal");a(t.filter(t=>t.id!==e))}catch(e){throw i(e instanceof Error?e.message:"An error occurred"),e}};return{rehearsals:t,loading:r,error:l,createRehearsal:o,deleteRehearsal:d,updateRehearsal:async(e,t)=>{try{let r=await fetch("/api/rehearsals/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw Error("Failed to update rehearsal");let s=await r.json();return a(t=>t.map(t=>t.id===e?s:t)),s}catch(e){throw i(e instanceof Error?e.message:"An error occurred"),e}}}}var o=a(9815);function d(e){let{onSubmit:t,isLoading:a=!1}=e,[n,l]=(0,s.useState)({title:"",dateEntries:[{date:"",time:"",location:""}]}),[i,o]=(0,s.useState)(null),d=(e,t,a)=>{let r=[...n.dateEntries];r[e]={...r[e],[t]:a},l({...n,dateEntries:r})},c=async e=>{e.preventDefault(),o(null);let a=n.dateEntries.filter(e=>e.date&&e.time&&e.location);if(!n.title||0===a.length)return void o("Please fill in title and at least one complete date/time/location entry");try{await t(n.title,a),l({title:"",dateEntries:[{date:"",time:"",location:""}]})}catch(e){o(e instanceof Error?e.message:"An error occurred")}};return(0,r.jsxs)("form",{onSubmit:c,className:"space-y-4",children:[i&&(0,r.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:i}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Title *"}),(0,r.jsx)("input",{type:"text",value:n.title,onChange:e=>{l({...n,title:e.target.value})},placeholder:"e.g., Full Cast Rehearsal",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-4",children:"Schedule Dates & Times * (Each date can have different time/location)"}),(0,r.jsx)("div",{className:"space-y-4",children:n.dateEntries.map((e,t)=>(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Date *"}),(0,r.jsx)("input",{type:"date",value:e.date,onChange:e=>d(t,"date",e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Time *"}),(0,r.jsx)("input",{type:"time",value:e.time,onChange:e=>d(t,"time",e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Location *"}),(0,r.jsx)("input",{type:"text",value:e.location,onChange:e=>d(t,"location",e.target.value),placeholder:"e.g., Studio A",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]})]}),n.dateEntries.length>1&&(0,r.jsx)("button",{type:"button",onClick:()=>{l({...n,dateEntries:n.dateEntries.filter((e,a)=>a!==t)})},className:"mt-2 px-3 py-1 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600",children:"Remove"})]},t))}),(0,r.jsx)("button",{type:"button",onClick:()=>{l({...n,dateEntries:[...n.dateEntries,{date:"",time:"",location:""}]})},className:"mt-3 px-4 py-2 bg-gray-300 text-gray-900 rounded-lg hover:bg-gray-400 font-medium",children:"+ Add Another Date"})]}),(0,r.jsx)("button",{type:"submit",disabled:a,className:"w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors",children:a?"Scheduling...":"Schedule Rehearsal"})]})}function c(e){let{rehearsals:t,onDelete:a,onUpdate:n}=e,[l,i]=(0,s.useState)(null),[o,d]=(0,s.useState)({title:"",date:"",time:"",location:""}),c=e=>e?e.split("T")[0]:"",u=()=>{i(null)},p=async e=>{await n(e,o),i(null)};return(0,r.jsx)("div",{className:"space-y-3",children:t.map(e=>(0,r.jsxs)("div",{className:"flex justify-between items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50",children:[(0,r.jsx)("div",{className:"flex-1",children:l===e.id?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("input",{type:"text",value:o.title,onChange:e=>d(t=>({...t,title:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,r.jsx)("input",{type:"date",value:o.date,onChange:e=>d(t=>({...t,date:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsx)("input",{type:"time",value:o.time,onChange:e=>d(t=>({...t,time:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsx)("input",{type:"text",value:o.location,onChange:e=>d(t=>({...t,location:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",placeholder:"Location"})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-900",children:e.title}),(0,r.jsxs)("div",{className:"grid grid-cols-2 text-sm text-gray-600 mt-1",children:[(0,r.jsxs)("span",{children:["\uD83D\uDCC5 ",(e=>{if(!e)return"";let t=c(e);if(t){let[e,a,r]=t.split("-").map(Number);if(e&&a&&r)return new Date(e,a-1,r).toLocaleDateString()}return new Date(e).toLocaleDateString()})(e.date)]}),(0,r.jsxs)("span",{children:["\uD83D\uDD50 ",e.time]})]}),(0,r.jsxs)("div",{className:"text-sm text-gray-600 mt-1",children:["\uD83D\uDCCD ",e.location]})]})}),(0,r.jsx)("div",{className:"flex items-center gap-2 ml-4",children:l===e.id?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:()=>p(e.id),className:"px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm",children:"Save"}),(0,r.jsx)("button",{onClick:u,className:"px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm",children:"Cancel"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:()=>(e=>{let t=c(e.date);i(e.id),d({title:e.title||"",date:t,time:e.time||"",location:e.location||""})})(e),className:"px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm",children:"Edit"}),(0,r.jsx)("button",{onClick:()=>{window.confirm("Delete this rehearsal?")&&a(e.id)},className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm",children:"Delete"})]})})]},e.id))})}function u(e){let{onSubmit:t,isLoading:a=!1}=e,[n,l]=(0,s.useState)({name:"",description:"",order:0,is_group:!0}),[i,o]=(0,s.useState)("group"),[d,c]=(0,s.useState)([]),[u,p]=(0,s.useState)(null),m=e=>{l({...n,[e.target.name]:"number"===e.target.type?Number(e.target.value):e.target.value})},x=async e=>{if(e.preventDefault(),p(null),!n.name)return void p("Part name is required");try{let e="group"===i,a=d.map(e=>({title:e.title.trim(),notes:e.notes.trim()})).filter(e=>e.title.length>0);if(!e&&0===a.length)return void p("Add at least one subpart for this part.");let r=await t(n.name,n.description,n.order,e);e||await Promise.all(a.map(e=>fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:r.id,title:e.title,description:e.notes||null,mode:"position"})}))),l({name:"",description:"",order:0,is_group:!0}),o("group"),c([])}catch(e){p(e instanceof Error?e.message:"An error occurred")}};return(0,r.jsxs)("form",{onSubmit:x,className:"space-y-4",children:[u&&(0,r.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:u}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Part Name *"}),(0,r.jsx)("input",{type:"text",name:"name",value:n.name,onChange:m,placeholder:"e.g., Lead Dancers, Background Chorus",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Description"}),(0,r.jsx)("textarea",{name:"description",value:n.description,onChange:m,placeholder:"Details about this part/choreography...",rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,r.jsx)("input",{type:"radio",checked:"group"===i,onChange:()=>o("group"),className:"h-4 w-4"}),"Group part"]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,r.jsx)("input",{type:"radio",checked:"subparts"===i,onChange:()=>o("subparts"),className:"h-4 w-4"}),"Part with subparts / solos"]}),"subparts"===i&&(0,r.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2",children:[(0,r.jsx)("div",{className:"text-sm font-semibold text-gray-700",children:"Subparts"}),0===d.length&&(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"Add at least one subpart."}),(0,r.jsx)("div",{className:"space-y-2",children:d.map((e,t)=>(0,r.jsxs)("div",{className:"border border-gray-200 rounded p-2",children:[(0,r.jsx)("input",{type:"text",value:e.title,onChange:e=>{let a=[...d];a[t]={...a[t],title:e.target.value},c(a)},placeholder:"Subpart ".concat(t+1," title"),className:"w-full px-2 py-1 border border-gray-300 rounded text-sm mb-2"}),(0,r.jsx)("textarea",{value:e.notes,onChange:e=>{let a=[...d];a[t]={...a[t],notes:e.target.value},c(a)},placeholder:"Notes",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(0,r.jsx)("button",{type:"button",onClick:()=>c(d.filter((e,a)=>a!==t)),className:"mt-2 text-xs text-red-600 hover:text-red-800",children:"Remove"})]},"subpart-".concat(t)))}),(0,r.jsx)("button",{type:"button",onClick:()=>c([...d,{title:"",notes:""}]),className:"px-2 py-1 bg-blue-600 text-white rounded text-xs",children:"Add Subpart"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Order"}),(0,r.jsx)("input",{type:"number",name:"order",value:n.order,onChange:m,min:"0",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsx)("button",{type:"submit",disabled:a,className:"w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors",children:a?"Adding...":"Add Part"})]})}function p(e){let{parts:t,performanceId:a,onDelete:n,onReorder:l,onSelect:i,selectedPartId:o,variant:d="manage",enableDrag:c=!0,showPositionedNames:u=!0}=e,[p,m]=(0,s.useState)(null),[x,h]=(0,s.useState)(""),[g,b]=(0,s.useState)(""),[f,y]=(0,s.useState)(""),[j,v]=(0,s.useState)(""),[N,w]=(0,s.useState)(""),[S,_]=(0,s.useState)(""),[C,k]=(0,s.useState)(!0),[E,T]=(0,s.useState)({}),[P,D]=(0,s.useState)({}),[F,A]=(0,s.useState)(null),[O,I]=(0,s.useState)({}),[M,R]=(0,s.useState)({}),[L,U]=(0,s.useState)({}),[J,z]=(0,s.useState)({}),[B,q]=(0,s.useState)({}),[G,Y]=(0,s.useState)({}),[X,H]=(0,s.useState)({}),[V,Z]=(0,s.useState)(null),[K,Q]=(0,s.useState)(""),[W,$]=(0,s.useState)(""),[ee,et]=(0,s.useState)(""),[ea,er]=(0,s.useState)(""),[es,en]=(0,s.useState)(""),[el,ei]=(0,s.useState)(""),[eo,ed]=(0,s.useState)(null),[ec,eu]=(0,s.useState)(null),ep=e=>{if(null==e||""===e)return{min:"",sec:""};let t=Number(e);if(!Number.isFinite(t))return{min:"",sec:""};let a=Math.floor(t/60),r=Math.floor(t%60);return{min:String(a),sec:String(r)}},em=(e,t)=>{if(!e&&!t)return null;let a=e?parseInt(e,10):0,r=t?parseFloat(t):0;return Number.isNaN(a)||Number.isNaN(r)?null:60*a+r},ex=e=>{if(null==e||""===e)return"--:--";let t=Number(e);if(!Number.isFinite(t))return"--:--";let a=Math.floor(t/60),r=Math.floor(t%60);return"".concat(a,":").concat(r.toString().padStart(2,"0"))};(0,s.useEffect)(()=>{t.forEach(e=>{eh(e.id),eg(e.id)})},[t]);let eh=async e=>{try{let t=await fetch("/api/stage-positions?partId=".concat(e)),a=await t.json();T(t=>({...t,[e]:a.length})),D(t=>({...t,[e]:a.map(e=>e.student_name||"Unknown")}))}catch(e){console.error("Error fetching positions:",e)}},eg=async e=>{try{let t=await fetch("/api/subparts?partId=".concat(e));if(!t.ok)throw Error("Failed to fetch subparts");let a=await t.json();I(t=>({...t,[e]:a||[]}))}catch(e){console.error("Error fetching subparts:",e)}},eb=async e=>{let t=(M[e]||"").trim(),a=(L[e]||"").trim(),r=em(J[e]||"",B[e]||""),s=em(G[e]||"",X[e]||"");if(t)try{let n=await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:e,title:t,description:a||null,mode:"position",timepoint_seconds:r,timepoint_end_seconds:s})});if(!n.ok){let e=await n.json().catch(()=>null);throw Error((null==e?void 0:e.details)||(null==e?void 0:e.error)||"Failed to create subpart")}await eg(e),R(t=>({...t,[e]:""})),U(t=>({...t,[e]:""})),z(t=>({...t,[e]:""})),q(t=>({...t,[e]:""})),Y(t=>({...t,[e]:""})),H(t=>({...t,[e]:""}))}catch(e){console.error("Error creating subpart:",e)}},ef=async(e,t)=>{try{if(!(await fetch("/api/subparts/".concat(e),{method:"DELETE"})).ok)throw Error("Failed to delete subpart");await eg(t)}catch(e){console.error("Error deleting subpart:",e)}},ey=()=>{Z(null),Q(""),$(""),et(""),er(""),en(""),ei("")},ej=async(e,t)=>{try{let a=await fetch("/api/subparts/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:K,description:W,timepoint_seconds:em(ee,ea),timepoint_end_seconds:em(es,el)})});if(!a.ok){let e=await a.json().catch(()=>null);throw Error((null==e?void 0:e.details)||(null==e?void 0:e.error)||"Failed to update subpart")}await eg(t),ey()}catch(e){console.error("Error updating subpart:",e)}},ev=async(e,t,a)=>{var r;if(a<0||a>=((null==(r=O[e])?void 0:r.length)||0))return;let s=[...O[e]||[]],[n]=s.splice(t,1);s.splice(a,0,n),I(t=>({...t,[e]:s}));try{await Promise.all(s.map((e,t)=>fetch("/api/subparts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:t+1})})))}catch(t){console.error("Error reordering subparts:",t),await eg(e)}},eN=async e=>{try{let t=await fetch("/api/parts/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:x,description:g,timepoint_seconds:em(f,j),timepoint_end_seconds:em(N,S),is_group:C})});if(!t.ok){let e=await t.json();throw console.error("API Error:",e),Error(e.details||"Failed to update part")}m(null)}catch(e){console.error("Error updating part:",e),alert("Error updating part: ".concat(e instanceof Error?e.message:String(e)))}},ew=async(e,a)=>{if(a<0||a>=t.length)return;let r=[...t],[s]=r.splice(e,1);r.splice(a,0,s);try{let e=r.map((e,t)=>fetch("/api/parts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:t+1})}));if(!(await Promise.all(e)).every(e=>e.ok))throw Error("Some updates failed");let t=r.map((e,t)=>({...e,order:t+1}));l&&l(t)}catch(e){console.error("Error reordering parts:",e)}};return(0,r.jsx)("div",{className:"space-y-3",children:t.map((e,a)=>{var s,l,T;return(0,r.jsx)("div",{draggable:c,onDragStart:()=>A(e.id),onDragOver:e=>{c&&e.preventDefault()},onDrop:()=>{if(c&&F&&F!==e.id)ew(t.findIndex(e=>e.id===F),t.findIndex(t=>t.id===e.id)),A(null)},onClick:()=>null==i?void 0:i(e.id),className:"p-4 border rounded-lg hover:bg-gray-50 ".concat(c?"cursor-move":""," ").concat(o===e.id?"border-blue-500 bg-blue-50":"border-gray-200"),children:p===e.id?(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("input",{type:"text",value:x,onChange:e=>h(e.target.value),placeholder:"Part name",className:"w-full px-3 py-2 border border-gray-300 rounded-lg"}),(0,r.jsx)("textarea",{value:g,onChange:e=>b(e.target.value),placeholder:"Part description (optional)",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",rows:2}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,r.jsx)("input",{type:"checkbox",checked:C,onChange:e=>k(e.target.checked),className:"h-4 w-4"}),"Group part (unchecked = has subparts/solos)"]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-semibold text-gray-700 mb-1",children:"Start Time (m / s)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:f,onChange:e=>y(e.target.value),placeholder:"min",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:j,onChange:e=>v(e.target.value),placeholder:"sec",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-semibold text-gray-700 mb-1",children:"End Time (m / s)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:N,onChange:e=>w(e.target.value),placeholder:"min",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:S,onChange:e=>_(e.target.value),placeholder:"sec",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]})]})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>eN(e.id),className:"px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm",children:"Save"}),(0,r.jsx)("button",{onClick:()=>m(null),className:"px-3 py-1 bg-gray-400 text-white rounded hover:bg-gray-500 text-sm",children:"Cancel"})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex justify-between items-start mb-3",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("h3",{className:"font-bold text-gray-900",children:e.name}),e.description&&(0,r.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:e.description}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:!1===e.is_group?"Subparts/Solos":"Group"})]}),"manage"===d&&(0,r.jsxs)("div",{className:"flex gap-2 ml-4",children:[(0,r.jsx)("button",{onClick:()=>ew(a,a-1),disabled:0===a,className:"px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 text-sm",title:"Move up",children:"↑"}),(0,r.jsx)("button",{onClick:()=>ew(a,a+1),disabled:a===t.length-1,className:"px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 text-sm",title:"Move down",children:"↓"})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm mb-3",children:[(0,r.jsxs)("div",{className:"bg-blue-50 p-2 rounded",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Positioned:"}),(0,r.jsx)("span",{className:"font-bold text-blue-600 ml-2",children:null!=(T=E[e.id])?T:"-"})]}),(0,r.jsxs)("div",{className:"bg-purple-50 p-2 rounded",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Order:"}),(0,r.jsx)("span",{className:"font-bold text-purple-600 ml-2",children:e.order})]})]}),"manage"===d&&(void 0!==e.timepoint_seconds||void 0!==e.timepoint_end_seconds)&&(0,r.jsxs)("div",{className:"bg-amber-50 p-2 rounded mb-3 text-sm",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Music Timepoint:"}),(0,r.jsxs)("span",{className:"font-bold text-amber-700 ml-2",children:[ex(e.timepoint_seconds)," - ",ex(e.timepoint_end_seconds)]})]}),u&&(null==(s=P[e.id])?void 0:s.length)>0&&(0,r.jsx)("div",{className:"bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:P[e.id].join(", ")}),(null==(l=O[e.id])?void 0:l.length)>0&&(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-600 mb-1",children:"Subparts / Solos"}),(0,r.jsx)("div",{className:"space-y-1",children:O[e.id].map(t=>(0,r.jsx)("div",{className:"flex items-start justify-between gap-2 ".concat("manage"===d?"cursor-move":""),draggable:"manage"===d,onDragStart:()=>{ed(t.id),eu(e.id)},onDragOver:e=>{"manage"===d&&e.preventDefault()},onDrop:()=>{if("manage"!==d||!eo||ec!==e.id)return;let a=O[e.id].findIndex(e=>e.id===eo),r=O[e.id].findIndex(e=>e.id===t.id);ev(e.id,a,r),ed(null),eu(null)},children:V===t.id?(0,r.jsxs)("div",{className:"w-full space-y-2",children:[(0,r.jsx)("input",{type:"text",value:K,onChange:e=>Q(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("textarea",{value:W,onChange:e=>$(e.target.value),rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:ee,onChange:e=>et(e.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:ea,onChange:e=>er(e.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:es,onChange:e=>en(e.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:el,onChange:e=>ei(e.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]}),(0,r.jsxs)("select",{value:t.mode||"position",onChange:a=>fetch("/api/subparts/".concat(t.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:a.target.value})}).then(()=>eg(e.id)),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation(),children:[(0,r.jsx)("option",{value:"position",children:"Position"}),(0,r.jsx)("option",{value:"order",children:"Order"}),(0,r.jsx)("option",{value:"both",children:"Both"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:a=>{a.stopPropagation(),ej(t.id,e.id)},className:"px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700",children:"Save"}),(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),ey()},className:"px-2 py-1 bg-gray-400 text-white rounded text-xs hover:bg-gray-500",children:"Cancel"})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium text-gray-800",children:t.title}),t.description&&(0,r.jsx)("div",{className:"text-gray-500",children:t.description}),t.mode&&(0,r.jsxs)("div",{className:"text-gray-400 text-[10px] mt-1",children:["Mode: ",t.mode]}),(0,r.jsxs)("div",{className:"text-gray-400 text-[10px] mt-1",children:["Time: ",ex(t.timepoint_seconds)," - ",ex(t.timepoint_end_seconds)]})]}),(0,r.jsx)("div",{className:"flex items-center gap-2",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:e=>{e.stopPropagation();Z(t.id),Q(t.title),$(t.description||"");let a=ep(t.timepoint_seconds),r=ep(t.timepoint_end_seconds);et(a.min),er(a.sec),en(r.min),ei(r.sec)},className:"text-[10px] text-blue-600 hover:text-blue-800",children:"Edit"}),(0,r.jsx)("button",{onClick:a=>{a.stopPropagation(),ef(t.id,e.id)},className:"text-[10px] text-red-600 hover:text-red-800",children:"Remove"})]})})]})},t.id))})]}),(0,r.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-600 mb-1",children:"Add Subpart"}),(0,r.jsx)("input",{type:"text",value:M[e.id]||"",onChange:t=>R(a=>({...a,[e.id]:t.target.value})),placeholder:"Subpart title",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2",onClick:e=>e.stopPropagation()}),(0,r.jsx)("textarea",{value:L[e.id]||"",onChange:t=>U(a=>({...a,[e.id]:t.target.value})),placeholder:"Description",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2",onClick:e=>e.stopPropagation()}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:J[e.id]||"",onChange:t=>z(a=>({...a,[e.id]:t.target.value})),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:B[e.id]||"",onChange:t=>q(a=>({...a,[e.id]:t.target.value})),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:G[e.id]||"",onChange:t=>Y(a=>({...a,[e.id]:t.target.value})),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:X[e.id]||"",onChange:t=>H(a=>({...a,[e.id]:t.target.value})),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]}),(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),eb(e.id)},className:"px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700",children:"Add"})]}),"manage"===d&&(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>(e=>{m(e.id),h(e.name),b(e.description||"");let t=ep(e.timepoint_seconds),a=ep(e.timepoint_end_seconds);y(t.min),v(t.sec),w(a.min),_(a.sec),k(!1!==e.is_group)})(e),className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm",children:"Edit"}),(0,r.jsx)("button",{onClick:()=>eh(e.id),className:"px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm",children:"Refresh Count"}),(0,r.jsx)("button",{onClick:()=>{window.confirm("Delete this part?")&&n(e.id)},className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm",children:"Delete"})]})]})},e.id)})})}var m=a(6979);function x(e){let{performanceId:t}=e,[a,n]=(0,s.useState)([]),[l,o]=(0,s.useState)(!0),[d,c]=(0,s.useState)(null),[u,p]=(0,s.useState)(!1),[x,h]=(0,s.useState)(""),[g,b]=(0,s.useState)(""),[f,y]=(0,s.useState)(!1),[j,v]=(0,s.useState)([]),[N,w]=(0,s.useState)([]),[S,_]=(0,s.useState)([]),[C,k]=(0,s.useState)([]),[E,T]=(0,s.useState)(!1),[P,D]=(0,s.useState)(""),{rehearsals:F}=i(t),A=(0,s.useCallback)(async()=>{try{o(!0);let e=await fetch("/api/performances/".concat(t,"/roster"));if(!e.ok)throw Error("Failed to fetch roster");let a=await e.json();n(a)}catch(e){console.error("Error fetching roster:",e),c(e instanceof Error?e.message:"Failed to load roster")}finally{o(!1)}},[t]),O=(0,s.useCallback)(async()=>{if(t)try{T(!0);let e=await fetch("/api/rehearsal-attendance?performanceId=".concat(t));if(!e.ok){let t=await e.text();throw console.error("Attendance fetch failed:",e.status,t),Error("Failed to fetch attendance")}let a=await e.json();k(a)}catch(e){console.error("Error fetching attendance:",e)}finally{T(!1)}},[t]);(0,s.useEffect)(()=>{A()},[A]),(0,s.useEffect)(()=>{O()},[O]),(0,s.useEffect)(()=>{(async()=>{if(t)try{let e=await fetch("/api/performances/".concat(t));if(!e.ok)return;let a=await e.json();D((null==a?void 0:a.date)||"")}catch(e){console.error("Error fetching performance date:",e)}})()},[t]);let I=(0,s.useCallback)(async()=>{try{let e=await fetch("/api/students");if(!e.ok)throw Error("Failed to fetch students");let t=await e.json();_(t)}catch(e){console.error("Error fetching students:",e)}},[]);(0,s.useEffect)(()=>{u&&I()},[u,I]);let M=async e=>{try{if(!(await fetch("/api/signups/".concat(e),{method:"DELETE"})).ok)throw Error("Failed to remove student");n(a.filter(t=>t.signup_id!==e))}catch(e){console.error("Error removing student:",e),c(e instanceof Error?e.message:"Failed to remove student")}},R=e=>{w(t=>[...t,e]),h(""),b("")},L=async e=>{e.preventDefault();let a=x.trim().length>0?[...j,x.trim()]:[...j];if(0===a.length&&0===N.length)return void c("Please enter at least one name");y(!0);try{for(let e of N)if(!(await fetch("/api/signups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:t,student_id:e.id,status:"registered"})})).ok)throw Error("Failed to add to roster");for(let e of a){let a=await fetch("/api/students",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:g.trim()?g.trim():null})});if(!a.ok)throw Error("Failed to create student");let r=await a.json();if(!(await fetch("/api/signups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:t,student_id:r.id,status:"registered"})})).ok)throw Error("Failed to add to roster")}h(""),b(""),v([]),w([]),p(!1),await A()}catch(e){c(e instanceof Error?e.message:"Failed to add student")}finally{y(!1)}},U=(0,s.useMemo)(()=>{let e=new Map;for(let t of C)e.set("".concat(t.rehearsal_id,":").concat(t.student_id),t);return e},[C]),J=(0,s.useCallback)(e=>e?e.split("T")[0]:"",[]),z=(0,s.useCallback)(e=>{let t=J(e);if(!t)return new Date(e);let[a,r,s]=t.split("-").map(Number);return new Date(a,(r||1)-1,s||1)},[J]),B=(0,s.useMemo)(()=>[...F].sort((e,t)=>z(e.date).getTime()-z(t.date).getTime()),[F,z]),q=e=>z(e).toLocaleDateString(void 0,{month:"numeric",day:"numeric"}),G=(0,s.useMemo)(()=>new Set(a.map(e=>e.student_id)),[a]),Y=(0,s.useMemo)(()=>new Set(N.map(e=>e.id)),[N]),X=(0,s.useMemo)(()=>{let e=x.trim().toLowerCase();return e?S.filter(t=>!(G.has(t.id)||Y.has(t.id))&&t.name.toLowerCase().includes(e)).slice(0,8):[]},[S,x,G,Y]),H=async(e,t,a)=>{if(a)return;let r="".concat(e,":").concat(t),s=U.get(r);try{if(!s){let a=await fetch("/api/rehearsal-attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rehearsal_id:e,student_id:t,status:"present"})});if(!a.ok)throw Error("Failed to save attendance");let r=await a.json();k(e=>[...e,r]);return}if("present"===s.status){let a=await fetch("/api/rehearsal-attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rehearsal_id:e,student_id:t,status:"absent"})});if(!a.ok)throw Error("Failed to save attendance");let r=await a.json();k(e=>e.map(e=>e.id===r.id?r:e));return}if(!(await fetch("/api/rehearsal-attendance?rehearsalId=".concat(e,"&studentId=").concat(t),{method:"DELETE"})).ok)throw Error("Failed to clear attendance");k(a=>a.filter(a=>a.rehearsal_id!==e||a.student_id!==t))}catch(e){console.error("Error updating attendance:",e),c(e instanceof Error?e.message:"Failed to update attendance")}};return l?(0,r.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,r.jsx)("p",{className:"text-gray-500",children:"Loading roster..."})}):(0,r.jsx)("div",{className:"h-full flex flex-col",children:(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(m.v,{size:22,className:"border border-gray-200 bg-white text-gray-400"}),(0,r.jsxs)("h3",{className:"font-semibold text-gray-900",children:["Roster (",a.length,")"]})]}),(0,r.jsx)("button",{onClick:()=>p(!u),className:"px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700",children:u?"Cancel":"+ Add"})]}),B.length>0&&(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mb-3 text-xs text-gray-600",children:[(0,r.jsx)("span",{children:"Attendance:"}),(0,r.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,r.jsx)("span",{className:"h-3 w-3 rounded bg-green-500 inline-block"}),"Present"]}),(0,r.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,r.jsx)("span",{className:"h-3 w-3 rounded bg-red-500 inline-block"}),"Missed"]}),(0,r.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,r.jsx)("span",{className:"h-3 w-3 rounded bg-gray-300 inline-block"}),"Pending"]}),(0,r.jsx)("span",{className:"text-gray-500",children:"Click boxes to toggle."})]}),d&&(0,r.jsx)("div",{className:"bg-yellow-100 border border-yellow-400 text-yellow-700 px-3 py-2 rounded mb-4 text-sm",children:d}),u&&(0,r.jsxs)("form",{onSubmit:L,className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg space-y-2",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("input",{type:"text",value:x,onChange:e=>h(e.target.value),onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=X.find(e=>e.name.toLowerCase()===x.trim().toLowerCase());if(t)return void R(t);let a=x.trim();a&&(v(e=>[...e,a]),h(""),b(""))}},placeholder:"Name (press Enter to add)",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),X.length>0&&(0,r.jsx)("div",{className:"absolute z-10 mt-1 w-full rounded border border-gray-200 bg-white shadow-sm text-sm",children:X.map(e=>(0,r.jsxs)("button",{type:"button",onClick:()=>R(e),className:"w-full text-left px-2 py-1 hover:bg-blue-50",children:[(0,r.jsx)("span",{className:"font-medium text-gray-900",children:e.name}),e.email&&(0,r.jsxs)("span",{className:"text-gray-500",children:[" • ",e.email]})]},e.id))})]}),(0,r.jsx)("input",{type:"email",value:g,onChange:e=>b(e.target.value),placeholder:"Email (optional)",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(j.length>0||N.length>0)&&(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[N.map(e=>(0,r.jsxs)("span",{className:"inline-flex items-center gap-1 bg-green-50 border border-green-200 text-green-800 px-2 py-1 rounded text-xs",children:[e.name,(0,r.jsx)("button",{type:"button",onClick:()=>{var t;return t=e.id,void w(e=>e.filter(e=>e.id!==t))},className:"text-green-800 hover:text-green-900","aria-label":"Remove ".concat(e.name),children:"\xd7"})]},e.id)),j.map((e,t)=>(0,r.jsxs)("span",{className:"inline-flex items-center gap-1 bg-white border border-blue-200 text-blue-700 px-2 py-1 rounded text-xs",children:[e,(0,r.jsx)("button",{type:"button",onClick:()=>{v(e=>e.filter((e,a)=>a!==t))},className:"text-blue-700 hover:text-blue-900","aria-label":"Remove ".concat(e),children:"\xd7"})]},"".concat(e,"-").concat(t)))]}),(0,r.jsx)("button",{type:"submit",disabled:f,className:"w-full px-2 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400",children:f?"Adding...":"Add to Roster"})]}),0===a.length?(0,r.jsx)("p",{className:"text-gray-500 text-sm",children:"No students registered yet"}):(0,r.jsx)("div",{className:"space-y-2",children:a.map(e=>(0,r.jsxs)("div",{className:"bg-gray-50 p-2 rounded-md border border-gray-200 flex justify-between items-start group",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"font-medium text-gray-900 text-xs",children:e.name}),e.email&&(0,r.jsx)("p",{className:"text-gray-600 text-[10px]",children:e.email}),e.part_name&&(0,r.jsx)("div",{className:"mt-1",children:(0,r.jsx)("span",{className:"inline-block bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-medium",children:e.part_name})}),B.length>0&&(0,r.jsxs)("div",{className:"mt-1 flex flex-wrap gap-1",children:[P&&(0,r.jsxs)("div",{title:"Performance \xe2€\xa2 ".concat(z(P).toLocaleDateString()),className:"h-7 w-9 border bg-gray-200 text-gray-700 border-gray-300 text-[9px] leading-tight rounded flex flex-col items-center justify-center font-semibold opacity-90",children:[(0,r.jsx)("span",{children:q(P)}),(0,r.jsx)("span",{children:"P"})]}),B.map(t=>{var a;let s=U.get("".concat(t.id,":").concat(e.student_id)),n=(e=>{let t=z(e.date),a=new Date,r=new Date(a.getFullYear(),a.getMonth(),a.getDate());return t.getTime()>r.getTime()})(t),l=null!=(a=null==s?void 0:s.status)?a:"pending";return(0,r.jsxs)("button",{type:"button",onClick:()=>H(t.id,e.student_id,n),disabled:E,title:"".concat(t.title," • ").concat(z(t.date).toLocaleDateString()," ").concat(t.time),className:"h-7 w-9 border text-[9px] leading-tight rounded flex flex-col items-center justify-center font-semibold ".concat("present"===l?"bg-green-500 text-white border-green-600":"absent"===l?"bg-red-500 text-white border-red-600":"bg-gray-300 text-gray-700 border-gray-400"," ").concat(n?"opacity-70 cursor-not-allowed":"hover:opacity-90"),children:[(0,r.jsx)("span",{children:q(t.date)}),(0,r.jsx)("span",{children:"R"})]},t.id)})]})]}),(0,r.jsx)("button",{onClick:()=>M(e.signup_id),className:"ml-2 px-2 py-0.5 bg-red-500 text-white rounded text-[10px] opacity-0 group-hover:opacity-100 hover:bg-red-600 transition-opacity",title:"Remove from roster",children:"Remove"})]},e.signup_id))})]})})}function h(e,t){if(!e||0===e.length)return"?";let a=e.charAt(0).toUpperCase();return t.filter(t=>t!==e&&t.charAt(0).toUpperCase()===a).length>0?e.slice(0,2).toUpperCase():a}function g(e){let{performanceId:t,partId:a,partName:n=null,partDescription:l=null,isGroup:i=!0,onSavePositions:o}=e,[d,c]=(0,s.useState)([]),[u,p]=(0,s.useState)([]),[x,g]=(0,s.useState)(null),[b,f]=(0,s.useState)(!1),[y,j]=(0,s.useState)(!0),[v,N]=(0,s.useState)(!1),[w,S]=(0,s.useState)(null),[_,C]=(0,s.useState)("bottom"),[k,E]=(0,s.useState)(Date.now()),T=s.useRef(null),P=s.useRef(!1),[D,F]=(0,s.useState)([]),[A,O]=(0,s.useState)(null),[I,M]=(0,s.useState)({}),[R,L]=(0,s.useState)({}),[U,J]=(0,s.useState)(null),[z,B]=(0,s.useState)(!1),[q,G]=(0,s.useState)(n||""),[Y,X]=(0,s.useState)(!1),[H,V]=(0,s.useState)(!1),[Z,K]=(0,s.useState)(l||""),[Q,W]=(0,s.useState)(!1),[$,ee]=(0,s.useState)([]),[et,ea]=(0,s.useState)(""),[er,es]=(0,s.useState)(!1),[en,el]=(0,s.useState)(!1),ei=(0,s.useCallback)(async()=>{try{let e=await fetch("/api/subparts?partId=".concat(a));if(e.ok){let t=await e.json();F(t||[]),0===(t||[]).length&&O(null)}}catch(e){console.error("Error fetching subparts:",e)}},[a]);(0,s.useEffect)(()=>{!async function(){try{let e=await fetch("/api/performances/".concat(t));if(e.ok){let t=await e.json();t.stage_orientation&&C("top"===t.stage_orientation?"top":"bottom")}let r=await fetch("/api/performances/".concat(t,"/roster"));if(!r.ok)throw Error("Failed to fetch roster");let s=(await r.json()).filter(e=>e.part_id===a||!e.part_id);c(s),await ei();let n=await fetch("/api/stage-positions?partId=".concat(a));if(!n.ok)throw Error("Failed to fetch positions");let l=await n.json();p(l.map(e=>({student_id:e.student_id||"",name:e.student_name||"Unknown",x:e.x,y:e.y,id:e.id})))}catch(e){S(e instanceof Error?e.message:"Failed to load data")}finally{j(!1)}}()},[t,a,i,ei]),(0,s.useEffect)(()=>{G(n||"")},[n]),(0,s.useEffect)(()=>{K(l||"")},[l]),(0,s.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/parts?performanceId=".concat(t));if(!e.ok)return;let a=await e.json(),r=(a||[]).map(e=>({key:"part:".concat(e.id),label:"Part: ".concat(e.name)})),s=(await Promise.all((a||[]).map(async e=>{let t=await fetch("/api/subparts?partId=".concat(e.id));return t.ok?(await t.json()||[]).map(t=>({key:"subpart:".concat(t.id),label:"Subpart: ".concat(e.name," • ").concat(t.title)})):[]}))).flat();ee([...r,...s])}catch(e){console.error("Error loading position sources:",e)}})()},[t]),(0,s.useEffect)(()=>{A&&(async()=>{try{let[e,t]=await Promise.all([fetch("/api/subpart-positions?subpartId=".concat(A)),fetch("/api/subpart-order?subpartId=".concat(A))]);if(e.ok){let t=await e.json();M(e=>({...e,[A]:(t||[]).map(e=>({student_id:e.student_id||"",name:e.student_name||"Unknown",x:e.x,y:e.y,id:e.id}))}))}if(t.ok){let e=await t.json();L(t=>({...t,[A]:(e||[]).map(e=>({id:e.id,student_id:e.student_id,student_name:e.student_name||"Unknown"}))}))}}catch(e){console.error("Error fetching subpart data:",e)}})()},[A]),(0,s.useEffect)(()=>(T.current=setInterval(async()=>{if(P.current)try{if(N(!0),A&&D.length>0){let e=(I[A]||[]).map(e=>({subpart_id:A,student_id:e.student_id,x:e.x,y:e.y}));await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:A,positions:e})})}else await o(u);await fetch("/api/performances/".concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({stage_orientation:_})}),P.current=!1,E(Date.now()),S(null)}catch(e){console.error("Auto-save error:",e)}finally{N(!1)}},6e3),()=>{T.current&&clearInterval(T.current)}),[u,_,t,o,A,D,I]);let eo=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];g(e),f(t)},ed=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},ec=(e,t)=>Number.isNaN(e)||e<0?0:e>t?t:e,eu=async(e,t,a)=>{if(e.preventDefault(),!x||D.length>0&&!ej)return;let r=d.find(e=>e.student_id===x);if(b&&!r){let e=u.find(e=>e.student_id===x);e&&(r={student_id:x,name:e.name,part_name:null})}if(!r)return;let s=[...(A&&D.length>0?I[A]||[]:u).filter(e=>e.student_id!==x),{student_id:x,name:r.name,x:"top"===_?11-t:t,y:"top"===_?8-a:a}];A&&D.length>0?(M(e=>({...e,[A]:s})),await eh(s,R[A]||[])):p(s),P.current=!0,g(null),f(!1)},ep=async()=>{try{if(N(!0),A&&D.length>0){let e=(I[A]||[]).map(e=>({subpart_id:A,student_id:e.student_id,x:e.x,y:e.y}));await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:A,positions:e})})}else await o(u);await fetch("/api/performances/".concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({stage_orientation:_})}),S(null)}catch(e){S(e instanceof Error?e.message:"Failed to save positions")}finally{N(!1)}},em=(0,s.useCallback)(async e=>{A&&(L(t=>({...t,[A]:e})),await fetch("/api/subpart-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.map((e,t)=>({subpart_id:A,student_id:e.student_id,order:t+1})))}))},[A]),ex=async(e,t)=>{if(!A)return;let a=[...eN,{id:"temp-".concat(Date.now()),student_id:e,student_name:t}];await em(a)},eh=(0,s.useCallback)(async(e,t)=>{if(!A)return;let a=new Set(t.map(e=>e.student_id)),r=e.filter(e=>e.student_id&&!a.has(e.student_id)).map(e=>({id:"temp-".concat(Date.now(),"-").concat(e.student_id),student_id:e.student_id,student_name:e.name}));if(0===r.length)return;let s=[...t,...r];await em(s)},[em,A]);(0,s.useEffect)(()=>{if(!A)return;let e=I[A]||[],t=R[A]||[];0!==e.length&&eh(e,t)},[A,I,R,eh]);let eg=async()=>{if(!et)return[];let[e,t]=et.split(":");if(!t)return[];let a=await fetch("subpart"===e?"/api/subpart-positions?subpartId=".concat(t):"/api/stage-positions?partId=".concat(t));if(!a.ok)throw Error(await a.text()||"Failed to fetch source positions");return(await a.json()||[]).map(e=>({student_id:e.student_id||"",name:e.student_name||"Unknown",x:e.x,y:e.y}))},eb=async()=>{if(et){el(!0);try{let e=(await eg()).map(e=>{let t=er?11-e.x:e.x;return{...e,x:ec(t,11),y:ec(e.y,8)}});A&&D.length>0?(M(t=>({...t,[A]:e})),await eh(e,R[A]||[]),await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:A,positions:e.map(e=>({subpart_id:A,student_id:e.student_id,x:e.x,y:e.y}))})})):(p(e),await o(e)),P.current=!1,E(Date.now()),S(null)}catch(e){S(e instanceof Error?e.message:"Failed to apply positions")}finally{el(!1)}}},ef=D.find(e=>e.id===A),ey=(null==ef?void 0:ef.mode)||"position",ej=0===D.length||"order"!==ey,ev=D.length>0,eN=A&&R[A]||[],ew=A&&D.length>0?I[A]||[]:u,eS=new Set(ew.map(e=>e.student_id)),e_=new Map;ew.forEach(e=>{e_.has(e.student_id)||e_.set(e.student_id,e)});let eC=Array.from(e_.values()).map(e=>({student_id:e.student_id,name:e.name,initials:h(e.name,Array.from(e_.values()).map(e=>e.name))}));return y?(0,r.jsx)("div",{className:"text-center py-8",children:"Loading..."}):(0,r.jsxs)("div",{className:"space-y-6",children:[w&&(0,r.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:w}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-[220px_1fr] gap-6",children:[(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,r.jsxs)("h3",{className:"font-semibold text-gray-900 mb-2",children:["Students (",d.length,")"]}),(0,r.jsx)("p",{className:"text-[11px] text-gray-500 mb-3",children:"Positioned students stay here so you can assign them to subparts."}),(0,r.jsx)("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:0===d.length?(0,r.jsx)("p",{className:"text-gray-500 text-sm",children:"No students yet."}):d.map(e=>{let t=eS.has(e.student_id);return(0,r.jsxs)("div",{draggable:!0,onDragStart:()=>eo(e.student_id,!1),className:"p-3 rounded border cursor-move hover:shadow-md transition-all ".concat(t?"bg-emerald-50 border-emerald-200 hover:border-emerald-300":"bg-white border-blue-200 hover:border-blue-400"),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,r.jsx)("p",{className:"font-medium text-sm text-gray-900",children:e.name}),t&&(0,r.jsx)("span",{className:"text-[10px] px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 font-semibold",children:"Positioned"})]}),e.part_name&&(0,r.jsx)("p",{className:"text-xs text-gray-600",children:e.part_name})]},e.student_id)})}),ev&&A&&(0,r.jsxs)("div",{className:"mt-4 border-t border-gray-200 pt-4",children:[(0,r.jsx)("h4",{className:"font-medium text-gray-900 mb-2 text-sm",children:"Assigned Students"}),(0,r.jsx)("p",{className:"text-[11px] text-gray-500 mb-2",children:"Drag students here to assign them to this subpart."}),(0,r.jsx)("div",{className:"bg-white p-2 rounded border border-gray-200",onDragOver:e=>e.preventDefault(),onDrop:async()=>{if(!x)return;let e=d.find(e=>e.student_id===x);e&&await ex(e.student_id,e.name)},children:(0,r.jsx)("div",{className:"space-y-2",children:0===eN.length?(0,r.jsx)("div",{className:"text-xs text-gray-500 border border-dashed border-gray-300 rounded p-2 text-center",children:"Drop students here"}):eN.map((e,t)=>(0,r.jsxs)("div",{draggable:!0,onDragStart:()=>J(e.id),onDragOver:e=>e.preventDefault(),onDrop:async()=>{if(!U)return;let t=eN.findIndex(e=>e.id===U),a=eN.findIndex(t=>t.id===e.id);if(t<0||a<0)return;let r=[...eN],[s]=r.splice(t,1);r.splice(a,0,s),await em(r),J(null)},className:"flex items-center justify-between bg-gray-50 border border-gray-200 rounded px-2 py-1",children:[(0,r.jsxs)("div",{className:"text-xs text-gray-900",children:[(0,r.jsxs)("span",{className:"text-gray-500 mr-1",children:[t+1,"."]}),e.student_name]}),(0,r.jsx)("button",{onClick:async()=>{let t=eN.filter(t=>t.id!==e.id);await em(t)},className:"text-[10px] text-red-600 hover:text-red-800",children:"Remove"})]},e.id))})})]})]}),(0,r.jsx)("div",{children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-start justify-between gap-3 mb-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(m.v,{size:24,className:"border border-gray-200 bg-white text-gray-400"}),(0,r.jsx)("h3",{className:"font-semibold text-gray-900",children:"Stage Layout"}),z?(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("input",{type:"text",value:q,onChange:e=>G(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm"}),(0,r.jsx)("button",{onClick:async()=>{if(!a)return;let e=q.trim();if(e){X(!0);try{if(!(await fetch("/api/parts/".concat(a),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})})).ok)throw Error("Failed to update part name");B(!1)}catch(e){alert(e instanceof Error?e.message:"Failed to update part name")}finally{X(!1)}}},disabled:Y,className:"px-2 py-1 bg-green-600 text-white rounded text-xs disabled:bg-gray-400",children:Y?"Saving...":"Save"}),(0,r.jsx)("button",{onClick:()=>{B(!1),G(n||"")},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("span",{className:"text-sm text-gray-700",children:n?"- ".concat(n):""}),(0,r.jsx)("button",{onClick:()=>B(!0),className:"text-xs text-blue-600 hover:text-blue-800",children:"Edit name"})]})]}),(0,r.jsx)("div",{className:"mt-2",children:H?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("textarea",{value:Z,onChange:e=>K(e.target.value),rows:2,placeholder:"Add part notes...",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:async()=>{if(a){W(!0);try{if(!(await fetch("/api/parts/".concat(a),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:Z||null})})).ok)throw Error("Failed to update part notes");V(!1)}catch(e){alert(e instanceof Error?e.message:"Failed to update part notes")}finally{W(!1)}}},disabled:Q,className:"px-2 py-1 bg-green-600 text-white rounded text-xs disabled:bg-gray-400",children:Q?"Saving...":"Save notes"}),(0,r.jsx)("button",{onClick:()=>{V(!1),K(l||"")},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]})]}):(0,r.jsxs)("div",{className:"flex items-start gap-2",children:[(0,r.jsx)("p",{className:"text-sm text-gray-600",children:l||"No notes yet."}),(0,r.jsx)("button",{onClick:()=>V(!0),className:"text-xs text-blue-600 hover:text-blue-800",children:"Edit notes"})]})}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mt-1",children:["Front of stage: ","bottom"===_?"Bottom":"Top"]})]}),D.length>0&&(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-600",children:"Subpart"}),(0,r.jsxs)("select",{value:A||"",onChange:e=>O(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-xs",children:[(0,r.jsx)("option",{value:"",children:"Part positions"}),D.map(e=>(0,r.jsx)("option",{value:e.id,children:e.title},e.id))]}),(null==ef?void 0:ef.description)&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500",children:ef.description})]}),(0,r.jsxs)("div",{className:"flex flex-col items-end gap-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 text-xs",children:[v&&(0,r.jsx)("span",{className:"text-blue-600 font-semibold",children:"Auto-saving..."}),!v&&P.current&&(0,r.jsx)("span",{className:"text-orange-600 font-semibold",children:"Unsaved changes (auto-saves in 6s)"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsxs)("select",{value:_,onChange:e=>C(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,r.jsx)("option",{value:"bottom",children:"Front - Bottom"}),(0,r.jsx)("option",{value:"top",children:"Front - Top"})]}),(0,r.jsx)("button",{onClick:()=>{A&&D.length>0?M(e=>({...e,[A]:[]})):p([]),P.current=!0},className:"px-4 py-2 bg-gray-300 text-gray-900 rounded-lg hover:bg-gray-400 font-medium text-sm",children:"Reset All"}),(0,r.jsx)("button",{onClick:ep,disabled:v,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 font-medium text-sm",children:v?"Saving...":"Save Positions"})]})]})]}),ew.length>0&&(0,r.jsxs)("div",{className:"bg-blue-50 p-3 rounded-lg border border-blue-200",children:[(0,r.jsx)("h4",{className:"font-medium text-gray-900 mb-2 text-sm",children:"Legend"}),(0,r.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:eC.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,r.jsx)("div",{className:"w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold",children:e.initials}),(0,r.jsx)("span",{className:"text-gray-700 truncate",children:e.name})]},e.student_id))})]}),(0,r.jsxs)("div",{className:"bg-white p-3 rounded-lg border border-gray-200",children:[(0,r.jsx)("div",{className:"font-medium text-gray-900 text-sm mb-2",children:"Quick Position"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2 items-center",children:[(0,r.jsxs)("select",{value:et,onChange:e=>ea(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,r.jsx)("option",{value:"",children:"Select a part or subpart..."}),$.map(e=>(0,r.jsx)("option",{value:e.key,children:e.label},e.key))]}),(0,r.jsx)("button",{onClick:eb,disabled:!et||en,className:"px-3 py-1 bg-blue-600 text-white rounded text-sm disabled:bg-gray-400",children:en?"Applying...":"Apply"})]}),(0,r.jsxs)("label",{className:"mt-2 flex items-center gap-2 text-xs text-gray-700",children:[(0,r.jsx)("input",{type:"checkbox",checked:er,onChange:e=>es(e.target.checked),className:"h-4 w-4"}),"Horizontal flip before applying"]})]}),D.length>0&&(0,r.jsx)("div",{className:"text-sm text-gray-700 font-medium text-center",children:(null==ef?void 0:ef.title)||"Subpart"}),(0,r.jsxs)("div",{className:"flex items-center justify-center gap-3",children:[D.length>0&&ej&&(0,r.jsx)("button",{onClick:()=>{let e=D.findIndex(e=>e.id===A);e>0&&O(D[e-1].id)},disabled:!A||0===D.findIndex(e=>e.id===A),className:"px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 text-xs",children:"Prev"}),(0,r.jsxs)("div",{className:"border-2 border-gray-400 bg-gradient-to-b from-amber-100 to-amber-50 relative mx-auto",style:{width:768,height:576,backgroundImage:"\n                  linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),\n                  linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px)\n                ",backgroundSize:"".concat(64,"px ").concat(64,"px")},onDragOver:ed,children:["bottom"===_&&(0,r.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-red-500"}),"top"===_&&(0,r.jsx)("div",{className:"absolute top-0 left-0 right-0 h-1 bg-red-500"}),(0,r.jsx)("div",{className:"absolute text-red-600 font-bold text-xs bg-white bg-opacity-80 px-2 py-1 rounded",style:{..."bottom"===_&&{bottom:5,left:"50%",transform:"translateX(-50%)"},..."top"===_&&{top:5,left:"50%",transform:"translateX(-50%)"}},children:"FRONT"}),A&&D.length>0&&0===ew.length&&(0,r.jsx)("div",{className:"absolute top-8 left-0 right-0 text-center text-2xl font-bold text-gray-500",children:(null==ef?void 0:ef.title)||"Subpart"}),Array.from({length:9}).map((e,t)=>Array.from({length:12}).map((e,a)=>(0,r.jsx)("div",{onDrop:e=>eu(e,a,t),onDragOver:ed,className:"absolute cursor-cell hover:bg-blue-100 hover:bg-opacity-30 transition-colors",style:{left:64*a,top:64*t,width:64,height:64}},"".concat(a,"-").concat(t)))),ew.map((e,t)=>{let a,s,n=h(e.name,ew.map(e=>e.name));return(0,r.jsxs)("div",{draggable:!0,onDragStart:()=>eo(e.student_id,!0),className:"absolute flex items-center justify-center group cursor-move",style:{left:(a=e.x,("top"===_?11-a:a)*64),top:(s=e.y,("top"===_?8-s:s)*64),width:64,height:64},children:[(0,r.jsxs)("div",{className:"relative w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg group-hover:bg-blue-600 transition-colors",children:[n,(0,r.jsx)("button",{onClick:()=>(e=>{let t=async e=>{try{A&&D.length>0?await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:A,positions:e.map(e=>({subpart_id:A,student_id:e.student_id,x:e.x,y:e.y}))})}):await o(e),P.current=!1,E(Date.now())}catch(e){S(e instanceof Error?e.message:"Failed to save positions"),P.current=!0}};if(A&&D.length>0){let a=(I[A]||[]).filter(t=>t.student_id!==e);M(e=>({...e,[A]:a})),t(a)}else{let a=u.filter(t=>t.student_id!==e);p(a),t(a)}P.current=!0})(e.student_id),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600",title:"Remove from stage",children:"x"})]}),(0,r.jsx)("div",{className:"absolute bottom-full mb-1 whitespace-nowrap bg-gray-900 text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:e.name})]},e.id||"".concat(e.student_id,"-").concat(e.x,"-").concat(e.y,"-").concat(t))})]}),D.length>0&&ej&&(0,r.jsx)("button",{onClick:()=>{let e=D.findIndex(e=>e.id===A);e>=0&&e<D.length-1&&O(D[e+1].id)},disabled:!A||D.findIndex(e=>e.id===A)===D.length-1,className:"px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 text-xs",children:"Next"})]}),ev&&A&&null,(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,r.jsxs)("h4",{className:"font-medium text-gray-900 mb-3",children:["Positioned (",ew.length,")"]}),(0,r.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:ew.map((e,t)=>(0,r.jsxs)("div",{className:"bg-white p-2 rounded border border-green-200 text-sm",children:[(0,r.jsx)("p",{className:"font-medium text-gray-900",children:e.name}),(0,r.jsxs)("p",{className:"text-xs text-gray-600",children:["(",e.x,", ",e.y,")"]})]},e.id||"".concat(e.student_id,"-").concat(e.x,"-").concat(e.y,"-").concat(t)))})]})]})})]})]})}function b(e){let{performanceId:t,performanceTitle:a,currentMusicFile:n,onUploadSuccess:l}=e,[i,o]=(0,s.useState)(!1),[d,c]=(0,s.useState)(null),[u,p]=(0,s.useState)(!1),m=async e=>{var a;let r=null==(a=e.currentTarget.files)?void 0:a[0];if(r){o(!0),c(null),p(!1);try{let a=new FormData;a.append("file",r);let s=await fetch("/api/performances/".concat(t,"/upload-music"),{method:"POST",body:a});if(!s.ok){let e=await s.json();throw Error(e.error||"Upload failed")}let n=await s.json();p(!0),null==l||l(n.filePath,n.publicUrl),e.currentTarget.value=""}catch(e){c(e instanceof Error?e.message:"Upload failed")}finally{o(!1)}}};return(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,r.jsx)("h3",{className:"font-bold text-lg text-gray-900 mb-4",children:"Performance Music"}),n&&(0,r.jsx)("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded",children:(0,r.jsxs)("p",{className:"text-sm text-green-900",children:[(0,r.jsx)("span",{className:"font-semibold",children:"✓ Music Uploaded:"})," ",n]})}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("label",{className:"block",children:[(0,r.jsx)("div",{className:"flex items-center justify-center w-full p-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors bg-gray-50 hover:bg-blue-50",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("p",{className:"text-2xl mb-2",children:"\uD83C\uDFB5"}),(0,r.jsx)("p",{className:"text-sm font-semibold text-gray-700",children:i?"Uploading...":"Click to upload music"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"MP3, WAV, OGG (max 50MB)"})]})}),(0,r.jsx)("input",{type:"file",accept:"audio/*",onChange:m,disabled:i,className:"hidden"})]}),d&&(0,r.jsx)("div",{className:"p-3 bg-red-50 border border-red-200 rounded",children:(0,r.jsxs)("p",{className:"text-sm text-red-900",children:["❌ ",d]})}),u&&(0,r.jsx)("div",{className:"p-3 bg-green-50 border border-green-200 rounded",children:(0,r.jsx)("p",{className:"text-sm text-green-900",children:"✓ Music uploaded successfully!"})})]})]})}function f(e){let{musicUrl:t,onTimeUpdate:a,performanceTitle:n,audioRef:l,onAudioReady:i}=e,o=(0,s.useRef)(null),d=null!=l?l:o,[c,u]=(0,s.useState)(!1),[p,m]=(0,s.useState)(0),[x,h]=(0,s.useState)(0),[g,b]=(0,s.useState)(1);(0,s.useEffect)(()=>{let e=d.current;if(!e)return;let t=()=>{m(e.currentTime),null==a||a(e.currentTime)},r=()=>{h(e.duration)};return e.addEventListener("timeupdate",t),e.addEventListener("loadedmetadata",r),e.addEventListener("play",()=>u(!0)),e.addEventListener("pause",()=>u(!1)),e.addEventListener("ended",()=>u(!1)),null==i||i(e),()=>{e.removeEventListener("timeupdate",t),e.removeEventListener("loadedmetadata",r),e.removeEventListener("play",()=>u(!0)),e.removeEventListener("pause",()=>u(!1)),e.removeEventListener("ended",()=>u(!1)),null==i||i(null)}},[d,a,i]);let f=e=>{if(!e||isNaN(e))return"0:00";let t=Math.floor(e/60),a=Math.floor(e%60);return"".concat(t,":").concat(a.toString().padStart(2,"0"))};return(0,r.jsxs)("div",{className:"bg-gray-900 text-white rounded-lg p-6 shadow-xl",children:[(0,r.jsx)("audio",{ref:d,src:t}),(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("h3",{className:"font-bold text-lg mb-1",children:n?"Music for ".concat(n):"Music Player"}),!t&&(0,r.jsx)("p",{className:"text-sm text-gray-400",children:"No music uploaded yet"})]}),t&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,r.jsx)("button",{onClick:()=>{d.current&&(c?d.current.pause():d.current.play())},disabled:!t,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 rounded-lg font-semibold transition-colors",children:c?"⏸ Pause":"▶ Play"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-400",children:"\uD83D\uDD0A"}),(0,r.jsx)("input",{type:"range",min:"0",max:"1",step:"0.1",value:g,onChange:e=>{let t=parseFloat(e.target.value);b(t),d.current&&(d.current.volume=t)},className:"w-20 cursor-pointer"}),(0,r.jsxs)("span",{className:"text-xs text-gray-400 w-6",children:[Math.round(100*g),"%"]})]})]}),(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,r.jsx)("span",{className:"text-sm text-gray-300 w-12 text-right",children:f(p)}),(0,r.jsx)("input",{type:"range",min:"0",max:x||0,value:p,onChange:e=>{var t;return t=parseFloat(e.target.value),void(d.current&&(d.current.currentTime=t,m(t)))},className:"flex-1 cursor-pointer"}),(0,r.jsx)("span",{className:"text-sm text-gray-300 w-12",children:f(x)})]}),(0,r.jsx)("div",{className:"w-full bg-gray-700 rounded-full h-1",children:(0,r.jsx)("div",{className:"bg-blue-500 h-1 rounded-full transition-all",style:{width:"".concat(x?p/x*100:0,"%")}})})]})]}),!t&&(0,r.jsx)("div",{className:"text-center py-8 text-gray-400",children:(0,r.jsx)("p",{children:"Upload music in the performance settings to enable playback"})})]})}function y(e){if(!e)return"?";let t=e.trim().split(/\s+/);return 1===t.length?t[0].slice(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function j(e){let{performanceId:t,parts:a,musicUrl:n,onClose:l}=e,[i,o]=(0,s.useState)(0),[d,c]=(0,s.useState)({}),[u,p]=(0,s.useState)(!1),[x,h]=(0,s.useState)(!0),[g,b]=(0,s.useState)({}),[j,v]=(0,s.useState)({}),[N,w]=(0,s.useState)({}),[S,_]=(0,s.useState)(""),[C,k]=(0,s.useState)(null),[E,T]=(0,s.useState)(null),[P,D]=(0,s.useState)(null),[F,A]=(0,s.useState)(""),[O,I]=(0,s.useState)("bottom"),[M,R]=(0,s.useState)(null),[L,U]=(0,s.useState)(null),J=(0,s.useRef)(null),z=(0,s.useRef)(null),B=(0,s.useRef)(null),q=(0,s.useMemo)(()=>[...a].sort((e,t)=>{let a="number"==typeof e.timepoint_seconds?e.timepoint_seconds:1/0,r="number"==typeof t.timepoint_seconds?t.timepoint_seconds:1/0;return a===r?(e.order||0)-(t.order||0):a-r}),[a]),G=(0,s.useMemo)(()=>q.filter(e=>"number"==typeof e.timepoint_seconds),[q]),Y=(0,s.useMemo)(()=>{if(0===G.length)return -1;let e=0;for(let t=0;t<G.length;t++){let a=G[t].timepoint_seconds||0,r=G[t].timepoint_end_seconds;i>=a&&(null==r||i<r)?e=t:i>=a&&(e=t)}return e},[G,i]),X=Y>=0?G[Y]:null,H=Y>=0?G[Y+1]:null,V=H?Math.max(0,(H.timepoint_seconds||0)-i):null,Z=e=>{if(null==e||Number.isNaN(e))return"--:--";let t=Math.max(0,Math.floor(e)),a=Math.floor(t/60);return"".concat(a,":").concat((t%60).toString().padStart(2,"0"))},K=(0,s.useMemo)(()=>{let e=new Set;return Object.values(d).forEach(t=>{t.forEach(t=>e.add(t.student_name||"Unknown"))}),Object.values(j).forEach(t=>{t.forEach(t=>e.add(t||"Unknown"))}),Array.from(e).sort((e,t)=>e.localeCompare(t))},[d,j]),Q=(0,s.useMemo)(()=>S?q.filter(e=>!!(d[e.id]||[]).map(e=>e.student_name).includes(S)||(g[e.id]||[]).some(e=>(j[e.id]||[]).includes(S))):q,[q,S,d,g,j]),W=()=>{try{let e=window.AudioContext||window.webkitAudioContext;if(!e)return;let t=new e,a=t.createGain();a.gain.value=.3,a.connect(t.destination);let r=t.createOscillator();r.type="sine",r.frequency.value=880,r.connect(a);let s=t.currentTime;r.start(s),r.stop(s+.15),setTimeout(()=>t.close(),300)}catch(e){}},$=(e,t)=>{if(!J.current)return;T(e),D(t),k(5),W();let a=5,r=setInterval(()=>{if((a-=1)<=0){clearInterval(r),k(null),T(null),D(null),J.current.currentTime=e,J.current.play();return}k(a),W()},1e3)};(0,s.useEffect)(()=>{if(!x||null===V){z.current=V;return}let e=z.current;(null===e||e>10)&&V<=10&&(()=>{try{let e=window.AudioContext||window.webkitAudioContext;if(!e)return;let t=new e,a=t.createGain();a.gain.value=.35,a.connect(t.destination);let r=e=>{let r=t.createOscillator();r.type="sine",r.frequency.value=880,r.connect(a),r.start(e),r.stop(e+.18)},s=t.currentTime;r(s),r(s+.35),r(s+.7),setTimeout(()=>t.close(),1200)}catch(e){}})(),z.current=V},[V,x]),(0,s.useEffect)(()=>{(async()=>{p(!0);try{let e=await Promise.all(a.map(async e=>{let t=await fetch("/api/stage-positions?partId=".concat(e.id));if(!t.ok)return[e.id,[]];let a=(await t.json()||[]).map(e=>({student_id:e.student_id,student_name:e.student_name||"Unknown",x:e.x,y:e.y}));return[e.id,a]})),t={};e.forEach(e=>{let[a,r]=e;t[a]=r}),c(t);let r=await Promise.all(a.map(async e=>{let t=await fetch("/api/subparts?partId=".concat(e.id));if(!t.ok)return[e.id,[]];let a=(await t.json()||[]).map(e=>{var t,a,r;return{id:e.id,part_id:e.part_id,title:e.title,description:null!=(t=e.description)?t:null,timepoint_seconds:null!=(a=e.timepoint_seconds)?a:null,timepoint_end_seconds:null!=(r=e.timepoint_end_seconds)?r:null}});return[e.id,a]})),s={};r.forEach(e=>{let[t,a]=e;s[t]=a}),b(s);let n=r.flatMap(e=>{let[,t]=e;return t.map(e=>e.id)}),l=await Promise.all(n.map(async e=>{let t=await fetch("/api/subpart-order?subpartId=".concat(e));if(!t.ok)return[e,[]];let a=(await t.json()||[]).map(e=>e.student_name||"Unknown");return[e,a]})),i={};l.forEach(e=>{let[t,a]=e;i[t]=a}),v(i);let o=await Promise.all(n.map(async e=>{let t=await fetch("/api/subpart-positions?subpartId=".concat(e));if(!t.ok)return[e,!1];let a=await t.json();return[e,Array.isArray(a)&&a.length>0]})),d={};o.forEach(e=>{let[t,a]=e;d[t]=a}),w(d)}finally{p(!1)}})()},[a,t]),(0,s.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/performances/".concat(t));if(!e.ok)return;let a=await e.json();A((null==a?void 0:a.call_time)||""),(null==a?void 0:a.stage_orientation)&&I("top"===a.stage_orientation?"top":"bottom")}catch(e){}})()},[t]);let ee=e=>{if(!e)return null;let t=g[e.id]||[];if(0===t.length)return null;let a=t.map(e=>{let t=j[e.id]||[],a=N[e.id]||!1;return 0===t.length||a?null:{title:e.title,names:t,description:e.description||null}}).filter(Boolean);return 0===a.length?null:(0,r.jsxs)("div",{className:"bg-white border border-indigo-200 rounded-lg p-5 shadow-sm min-h-[220px]",children:[(0,r.jsx)("div",{className:"text-sm uppercase tracking-wide text-indigo-600 font-semibold mb-2",children:"Subpart Assignments"}),(0,r.jsx)("div",{className:"space-y-3 text-base text-gray-700",children:a.map(e=>(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-semibold text-gray-900",children:e.title}),e.description&&(0,r.jsx)("div",{className:"text-sm text-gray-500",children:e.description}),(0,r.jsx)("div",{className:"text-gray-600",children:e.names.join(", ")})]},e.title))})]})},et=(e,t,a)=>{let s=t&&d[t.id]||[],n=a?"text-5xl":"text-4xl",l=a?"text-base":"text-sm",i=a?"border-purple-700 bg-purple-100":"border-blue-700 bg-blue-100",o=a?"from-purple-200 to-purple-300":"from-blue-200 to-blue-300";return(0,r.jsxs)("div",{className:"rounded-lg border p-4 shadow-sm ".concat(i),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"".concat(l," uppercase tracking-wide text-gray-600"),children:e}),(0,r.jsx)("div",{className:"".concat(n," font-semibold text-gray-900"),children:t?t.name:"—"})]}),a&&null!==V&&V<=10&&(0,r.jsx)("div",{className:"text-7xl font-extrabold text-red-600 animate-pulse",children:Math.ceil(V)})]}),a&&null!==V&&V<=10&&(0,r.jsx)("div",{className:"mb-2 text-3xl font-extrabold text-red-600 animate-pulse",children:"GET READY"}),(0,r.jsxs)("div",{className:"border border-gray-300 bg-gradient-to-b ".concat(o," relative mx-auto"),style:{width:816,height:544,backgroundImage:"\n              linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),\n              linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px)\n            ",backgroundSize:"".concat(68,"px ").concat(68,"px")},children:["bottom"===O&&(0,r.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-red-500"}),"top"===O&&(0,r.jsx)("div",{className:"absolute top-0 left-0 right-0 h-1 bg-red-500"}),(0,r.jsx)("div",{className:"absolute text-red-600 font-bold text-xs bg-white bg-opacity-80 px-2 py-1 rounded",style:{..."bottom"===O&&{bottom:5,left:"50%",transform:"translateX(-50%)"},..."top"===O&&{top:5,left:"50%",transform:"translateX(-50%)"}},children:"FRONT"}),Array.from({length:8}).map((e,t)=>Array.from({length:12}).map((e,a)=>(0,r.jsx)("div",{className:"absolute",style:{left:68*a,top:68*t,width:68,height:68}},"".concat(a,"-").concat(t)))),s.map(e=>(0,r.jsx)("div",{className:"absolute flex items-center justify-center",style:{left:68*e.x,top:68*e.y,width:68,height:68},children:(0,r.jsx)("div",{className:"w-14 h-14 bg-blue-600 text-white text-base font-bold rounded-full flex items-center justify-center shadow-md",children:y(e.student_name)})},"".concat(e.student_id,"-").concat(e.x,"-").concat(e.y)))]})]})};return(0,s.useEffect)(()=>{if(!X)return;let e=g[X.id]||[];if(0===e.length)return;let t=e.map(e=>{let t="number"==typeof e.timepoint_seconds?e.timepoint_seconds:Number(e.timepoint_seconds),a="number"==typeof e.timepoint_end_seconds?e.timepoint_end_seconds:Number(e.timepoint_end_seconds),r=Number.isFinite(t)?t:NaN,s=Number.isFinite(a)?a:NaN;return Number.isFinite(r)?{id:e.id,start:r,end:Number.isFinite(s)?s:r}:null}).filter(Boolean);if(0===t.length)return;let a=t.find(e=>i>=e.start&&i<=e.end);U(a?a.id:null);let r=t.find(e=>i>=e.start&&i<e.start+.35);r&&B.current!==r.id&&(B.current=r.id,R(r.id),setTimeout(()=>{R(e=>e===r.id?null:e)},350))},[i,X,g]),(0,r.jsx)("div",{className:"fixed inset-0 z-50 bg-black bg-opacity-70 flex",children:(0,r.jsx)("div",{className:"flex-1 bg-gray-100 overflow-auto",children:(0,r.jsxs)("div",{className:"w-full h-full p-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-1",children:[(0,r.jsx)(m.v,{className:"border border-gray-200 bg-white text-gray-400",size:32}),(0,r.jsx)("div",{className:"text-sm uppercase tracking-wide text-gray-500",children:"Rehearse Mode"})]}),(0,r.jsx)("div",{className:"text-3xl font-bold text-gray-900",children:"Live Stage View"})]}),(0,r.jsx)("div",{className:"flex items-center gap-4",children:(0,r.jsx)("button",{onClick:l,className:"px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-800",children:"Close"})})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-[360px_1fr] gap-6",children:[(0,r.jsxs)("div",{className:"bg-white rounded-lg border border-gray-200 p-4 shadow-sm",children:[(0,r.jsx)("div",{className:"text-2xl font-semibold text-gray-900 mb-4",children:"Parts"}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-3",children:"Select a part to jump to that timepoint."}),(0,r.jsx)("div",{className:"space-y-5",children:Q.map((e,t)=>{let a=(null==X?void 0:X.id)===e.id,s=(null==H?void 0:H.id)===e.id;return(0,r.jsxs)("div",{className:"border rounded p-2 cursor-pointer transition-colors ".concat(a?"border-blue-500 bg-blue-50":"border-gray-200 bg-white"),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-900 text-xl",children:e.name}),s&&(0,r.jsx)("span",{className:"text-base font-bold text-purple-700 bg-purple-100 px-2 py-0.5 rounded",children:"NEXT"})]}),(0,r.jsx)("div",{className:"text-base text-gray-500",children:"number"==typeof e.timepoint_seconds?Z(e.timepoint_seconds):"No timepoint"}),s&&null!==V&&V<=10&&(0,r.jsx)("div",{className:"text-4xl font-extrabold text-red-600 animate-pulse",children:Math.ceil(V)}),(0,r.jsx)("div",{className:"text-base text-gray-600 mt-1",children:0===(d[e.id]||[]).length?"No positions":(d[e.id]||[]).map((t,a)=>(0,r.jsxs)("span",{children:[a>0?", ":"",(0,r.jsx)("span",{className:t.student_name===S?"font-bold text-emerald-600":"",children:t.student_name})]},"".concat(e.id,"-pos-").concat(t.student_id,"-").concat(a)))}),(g[e.id]||[]).length>0&&(0,r.jsx)("div",{className:"mt-3 space-y-3 text-sm text-gray-700",children:(g[e.id]||[]).map((t,a)=>{let s=j[t.id]||[],n="number"==typeof t.timepoint_seconds?t.timepoint_seconds:null!==t.timepoint_seconds&&void 0!==t.timepoint_seconds?parseFloat(String(t.timepoint_seconds)):NaN,l="number"==typeof t.timepoint_end_seconds?t.timepoint_end_seconds:null!==t.timepoint_end_seconds&&void 0!==t.timepoint_end_seconds?parseFloat(String(t.timepoint_end_seconds)):NaN,i=Number.isFinite(n);return(0,r.jsxs)("div",{className:"",children:[(0,r.jsxs)("div",{className:"font-semibold text-gray-900",children:[a+1,". ",t.title]}),(0,r.jsxs)("div",{className:"text-gray-600",children:["Assigned:"," ",0===s.length?"—":s.map((e,a)=>(0,r.jsxs)("span",{children:[a>0?", ":"",(0,r.jsx)("span",{className:e===S?"font-bold text-emerald-600":"",children:e})]},"".concat(t.id,"-assigned-").concat(a)))]}),(0,r.jsxs)("div",{className:"text-gray-500",children:["Notes: ",t.description?t.description:"—"]}),(0,r.jsxs)("div",{className:"text-[11px] text-gray-500",children:["Time: ",Number.isFinite(n)?Z(n):"--:--"," / ",Number.isFinite(l)?Z(l):"--:--"]}),i&&(0,r.jsxs)("button",{onClick:t=>{t.stopPropagation(),$(n,e.id)},className:"mt-1 text-[11px] text-indigo-600 hover:text-indigo-800 underline",children:["Jump to ",t.title," subpart"]})]},t.id)})}),(0,r.jsx)("div",{className:"mt-3",children:(0,r.jsx)("button",{onClick:t=>{t.stopPropagation();let a=e.timepoint_seconds,r="number"==typeof a?a:null!=a?parseFloat(a):null;null===r||Number.isNaN(r)||$(r,e.id)},className:"text-xs text-blue-700 hover:text-blue-900 underline",children:"Jump to part"})}),P===e.id&&null!==C&&(0,r.jsx)("div",{className:"mt-2 text-center text-3xl font-extrabold text-red-600 animate-pulse",children:C})]},e.id)})})]}),(0,r.jsxs)("div",{className:"space-y-6",children:[(e=>{if(!e)return null;let t=g[e.id]||[];if(0===t.length)return null;let a=t.map(e=>{let t="number"==typeof e.timepoint_seconds?e.timepoint_seconds:Number(e.timepoint_seconds),a="number"==typeof e.timepoint_end_seconds?e.timepoint_end_seconds:Number(e.timepoint_end_seconds),r=Number.isFinite(t)?t:NaN,s=Number.isFinite(a)?a:NaN;return Number.isFinite(r)?{id:e.id,title:e.title,start:r,end:Number.isFinite(s)?s:r}:null}).filter(Boolean);if(0===a.length)return null;let s="number"==typeof e.timepoint_seconds?e.timepoint_seconds:Math.min(...a.map(e=>e.start)),n="number"==typeof e.timepoint_end_seconds?e.timepoint_end_seconds:Math.max(...a.map(e=>e.end)),l=Math.max(1,n-s),o=100*Math.min(1,Math.max(0,(i-s)/l));return(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 shadow-sm",children:[(0,r.jsx)("div",{className:"text-xs uppercase tracking-wide text-gray-500 mb-2",children:"Subpart Timeline"}),(0,r.jsxs)("div",{className:"relative h-16 rounded bg-slate-50 border border-slate-200 overflow-hidden",children:[a.map((e,t)=>{let n=(e.start-s)/l*100,i=Math.max(2,(e.end-e.start)/l*100),o=L===e.id;return(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"absolute top-0 h-full text-white text-base font-bold px-2 py-1 flex flex-col items-center justify-center text-center overflow-hidden leading-tight transition-all ".concat(M===e.id?"bg-emerald-500 border-2 border-emerald-700":o?"bg-emerald-600 border-2 border-emerald-800 shadow-[0_0_12px_rgba(16,185,129,0.85)] animate-pulse":"bg-orange-700 border-2 border-orange-900"),style:{left:"".concat(n,"%"),width:"".concat(i,"%")},children:[(0,r.jsx)("div",{children:e.title}),(0,r.jsx)("div",{className:"text-sm opacity-90",children:"Subpart"})]}),t<a.length-1&&(0,r.jsx)("div",{className:"absolute top-0 h-full w-[4px] bg-orange-900",style:{left:"".concat(n+i,"%")}})]},e.id)}),(0,r.jsx)("div",{className:"absolute top-0 h-full w-[3px] bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.7)]",style:{left:"".concat(o,"%")}})]}),(0,r.jsxs)("div",{className:"mt-1 text-[11px] text-gray-500",children:[Z(s)," - ",Z(n)]})]})})(X),(0,r.jsxs)("div",{className:"grid grid-cols-1 2xl:grid-cols-2 gap-6",children:[et("Next",H,!0),et("Current",X,!1)]}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-4 text-xs text-gray-600",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"inline-block h-3 w-3 rounded-full bg-blue-600"}),"Current part"]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"inline-block h-3 w-3 rounded-full bg-purple-600"}),"Next part"]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"inline-block h-3 w-3 rounded-full bg-blue-600 border border-blue-800"}),"Student position"]})]}),(X||H)&&(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 text-xs text-gray-700",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-900 mb-2",children:"Legend"}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[11px] font-semibold text-blue-700 uppercase tracking-wide mb-2",children:"Current Part"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2",children:[Array.from(new Map((X&&d[X.id]||[]).map(e=>[e.student_id,e])).values()).map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("div",{className:"w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-[10px] font-bold",children:y(e.student_name)}),(0,r.jsx)("span",{className:"truncate",children:e.student_name})]},"current-".concat(null==X?void 0:X.id,"-").concat(e.student_id))),0===(X&&d[X.id]||[]).length&&(0,r.jsx)("div",{className:"text-[11px] text-gray-500",children:"No positions"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[11px] font-semibold text-purple-700 uppercase tracking-wide mb-2",children:"Next Part"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2",children:[Array.from(new Map((H&&d[H.id]||[]).map(e=>[e.student_id,e])).values()).map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("div",{className:"w-6 h-6 bg-purple-600 text-white rounded-full flex items-center justify-center text-[10px] font-bold",children:y(e.student_name)}),(0,r.jsx)("span",{className:"truncate",children:e.student_name})]},"next-".concat(null==H?void 0:H.id,"-").concat(e.student_id))),0===(H&&d[H.id]||[]).length&&(0,r.jsx)("div",{className:"text-[11px] text-gray-500",children:"No positions"})]})]})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsx)("div",{className:"min-h-[180px]",children:ee(X)}),(0,r.jsx)("div",{className:"min-h-[180px]",children:ee(H)})]}),(0,r.jsxs)("div",{className:"max-w-xl space-y-3",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-3 rounded-lg border-2 border-blue-600 bg-blue-50 p-3",children:[(0,r.jsx)("div",{className:"text-xs font-extrabold uppercase tracking-widest text-blue-700",children:"Filter by person"}),(0,r.jsxs)("select",{value:S,onChange:e=>_(e.target.value),className:"min-w-[160px] px-2 py-1 border border-blue-200 rounded text-sm bg-white",children:[(0,r.jsx)("option",{value:"",children:"All"}),K.map(e=>(0,r.jsx)("option",{value:e,children:e},e))]}),(0,r.jsxs)("div",{className:"ml-auto flex items-center gap-3 text-xs font-semibold text-blue-700",children:[F&&(0,r.jsxs)("div",{children:["Call Time: ",(0,r.jsx)("span",{className:"font-bold",children:F})]}),(0,r.jsxs)("label",{className:"flex items-center gap-2",children:[(0,r.jsx)("input",{type:"checkbox",checked:x,onChange:e=>h(e.target.checked),className:"h-4 w-4"}),"Ring at T-10"]})]})]}),(0,r.jsx)(f,{musicUrl:n||void 0,onTimeUpdate:e=>o(e),audioRef:J})]})]})]})]})})})}var v=a(1517);function N(e){let{partId:t}=e,[a,n]=(0,s.useState)([]),[l,i]=(0,s.useState)(!1),[o,d]=(0,s.useState)(""),[c,u]=(0,s.useState)(""),[p,m]=(0,s.useState)(""),[x,h]=(0,s.useState)(""),[g,b]=(0,s.useState)(""),[f,y]=(0,s.useState)(""),[j,v]=(0,s.useState)(null),[N,w]=(0,s.useState)(""),[S,_]=(0,s.useState)(""),[C,k]=(0,s.useState)(""),[E,T]=(0,s.useState)(""),[P,D]=(0,s.useState)(""),[F,A]=(0,s.useState)(""),O=e=>{if(null==e||""===e)return{min:"",sec:""};let t=Number(e);if(!Number.isFinite(t))return{min:"",sec:""};let a=Math.floor(t/60),r=Math.floor(t%60);return{min:String(a),sec:String(r)}},I=(e,t)=>{if(!e&&!t)return null;let a=e?parseInt(e,10):0,r=t?parseFloat(t):0;return Number.isNaN(a)||Number.isNaN(r)?null:60*a+r},M=e=>{if(null==e||""===e)return"--:--";let t=Number(e);if(!Number.isFinite(t))return"--:--";let a=Math.floor(t/60),r=Math.floor(t%60);return"".concat(a,":").concat(r.toString().padStart(2,"0"))},R=(0,s.useCallback)(async()=>{if(!t)return void n([]);try{i(!0);let e=await fetch("/api/subparts?partId=".concat(t));if(!e.ok)throw Error("Failed to fetch subparts");let a=await e.json();n(a||[])}catch(e){console.error("Error fetching subparts:",e)}finally{i(!1)}},[t]);return((0,s.useEffect)(()=>{R()},[R]),t)?(0,r.jsxs)("div",{className:"border-t border-gray-200 pt-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-900",children:"Subparts / Solos"}),(0,r.jsx)("button",{onClick:R,className:"text-xs text-blue-600 hover:text-blue-800",children:"Refresh"})]}),l&&(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-2",children:"Loading..."}),0===a.length&&!l&&(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-2",children:"No subparts yet."}),(0,r.jsx)("div",{className:"space-y-2",children:a.map(e=>(0,r.jsx)("div",{className:"border border-gray-200 rounded p-2 text-xs",children:j===e.id?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("input",{type:"text",value:N,onChange:e=>w(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("textarea",{value:S,onChange:e=>_(e.target.value),rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:C,onChange:e=>k(e.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:E,onChange:e=>T(e.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:P,onChange:e=>D(e.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:F,onChange:e=>A(e.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:async()=>{try{if(!(await fetch("/api/subparts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:N,description:S,timepoint_seconds:I(C,E),timepoint_end_seconds:I(P,F)})})).ok)throw Error("Failed to update subpart");v(null),await R()}catch(e){alert(e instanceof Error?e.message:"Failed to update subpart")}},className:"px-2 py-1 bg-green-600 text-white rounded text-xs",children:"Save"}),(0,r.jsx)("button",{onClick:()=>v(null),className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]})]}):(0,r.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium text-gray-800",children:e.title}),e.mode&&(0,r.jsxs)("div",{className:"text-[10px] text-gray-400",children:["Mode: ",e.mode]}),e.description&&(0,r.jsx)("div",{className:"text-gray-600",children:e.description}),null!==e.timepoint_seconds||null!==e.timepoint_end_seconds?(0,r.jsxs)("div",{className:"text-[10px] text-gray-400",children:["Time: ",M(e.timepoint_seconds)," - ",M(e.timepoint_end_seconds)]}):(0,r.jsx)("div",{className:"text-[10px] text-gray-400",children:"Time: --:-- - --:--"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>{v(e.id),w(e.title),_(e.description||"");let t=O(e.timepoint_seconds),a=O(e.timepoint_end_seconds);k(t.min),T(t.sec),D(a.min),A(a.sec)},className:"text-[10px] text-blue-600 hover:text-blue-800",children:"Edit"}),(0,r.jsx)("button",{onClick:async()=>{if(window.confirm("Delete this subpart?"))try{if(!(await fetch("/api/subparts/".concat(e.id),{method:"DELETE"})).ok)throw Error("Failed to delete subpart");await R()}catch(e){alert(e instanceof Error?e.message:"Failed to delete subpart")}},className:"text-[10px] text-red-600 hover:text-red-800",children:"Delete"})]})]})},e.id))}),(0,r.jsxs)("div",{className:"mt-3 border-t border-gray-200 pt-3",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-700 text-xs mb-2",children:"Add Subpart"}),(0,r.jsx)("input",{type:"text",value:o,onChange:e=>d(e.target.value),placeholder:"Subpart title",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2"}),(0,r.jsx)("textarea",{value:c,onChange:e=>u(e.target.value),placeholder:"Description",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:p,onChange:e=>m(e.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:x,onChange:e=>h(e.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:g,onChange:e=>b(e.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:f,onChange:e=>y(e.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsx)("button",{onClick:async()=>{let e=o.trim(),a=c.trim();if(e)try{if(!(await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:t,title:e,description:a||null,mode:"position",timepoint_seconds:I(p,x),timepoint_end_seconds:I(g,f)})})).ok)throw Error("Failed to create subpart");d(""),u(""),m(""),h(""),b(""),y(""),await R()}catch(e){alert(e instanceof Error?e.message:"Failed to create subpart")}},className:"px-2 py-1 bg-blue-600 text-white rounded text-xs",children:"Add Subpart"})]})]}):null}function w(e){var t,a,n;let{params:d}=e,{id:c}=(0,s.use)(d),[u,m]=(0,s.useState)(null),[h,y]=(0,s.useState)(!0),[w,C]=(0,s.useState)("rehearsals"),[k,E]=(0,s.useState)(!1),[T,P]=(0,s.useState)(!1),[D,F]=(0,s.useState)(null),[A,O]=(0,s.useState)(null),[I,M]=(0,s.useState)(!1),[R,L]=(0,s.useState)(!1),[U,J]=(0,s.useState)(!0),[z,B]=(0,s.useState)(!1),[q,G]=(0,s.useState)(null),[Y,X]=(0,s.useState)({title:"",call_time:"",timezone:"America/New_York",date:"",location:"",description:"",phone_numbers:""}),[H,V]=(0,s.useState)([]),[Z,K]=(0,s.useState)(""),[Q,W]=(0,s.useState)(""),[$,ee]=(0,s.useState)([]),[et,ea]=(0,s.useState)(""),{rehearsals:er,createRehearsal:es,deleteRehearsal:en,updateRehearsal:el}=i(c),{parts:ei,createPart:eo,deletePart:ed,setParts:ec}=function(e){let[t,a]=(0,s.useState)([]),[r,n]=(0,s.useState)(!0),[l,i]=(0,s.useState)(null);(0,s.useEffect)(()=>{if(!e){a([]),n(!1);return}!async function(){try{let t=await fetch("/api/parts?performanceId=".concat(e));if(!t.ok)throw Error("Failed to fetch parts");let r=await t.json();a(r)}catch(e){i(e instanceof Error?e.message:"An error occurred")}finally{n(!1)}}()},[e]);let o=async(r,s,n,l)=>{if(!e)throw Error("Performance ID is required");try{let i=await fetch("/api/parts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:e,name:r,description:s,order:n,is_group:l})});if(!i.ok)throw Error("Failed to create part");let o=await i.json();return a([...t,o]),o}catch(e){throw i(e instanceof Error?e.message:"An error occurred"),e}},d=async e=>{try{if(!(await fetch("/api/parts/".concat(e),{method:"DELETE"})).ok)throw Error("Failed to delete part");a(t.filter(t=>t.id!==e))}catch(e){throw i(e instanceof Error?e.message:"An error occurred"),e}};return{parts:t,loading:r,error:l,createPart:o,deletePart:d,setParts:a}}(c),{performances:eu}=(0,o.f)();(0,s.useEffect)(()=>{!async function(){try{let e=await fetch("/api/performances/".concat(c));if(!e.ok)throw Error("Failed to fetch performance");let t=await e.json();m(t);let a=t.date?(e=>{let t=new Date(e),a=6e4*t.getTimezoneOffset();return new Date(t.getTime()-a).toISOString().slice(0,16)})(t.date):"";if(X({title:t.title||"",call_time:t.call_time||"",timezone:t.timezone||"America/New_York",date:a,location:t.location||"",description:t.description||"",phone_numbers:t.phone_numbers||""}),t.music_file_path){let e="".concat("https://quqvudqzztlmgrwqudho.supabase.co","/storage/v1/object/public/performance-music/").concat(t.music_file_path);O(e)}let r=await fetch("/api/performance-contacts?performanceId=".concat(c));if(r.ok){let e=await r.json();V(e||[])}let s=await fetch("/api/performance-contacts/all");if(s.ok){let e=await s.json();ee(e||[])}}catch(e){console.error("Error fetching performance:",e)}finally{y(!1)}}()},[c]),(0,s.useEffect)(()=>{"positioning"===w&&ei.length>0&&!D&&F(ei[0].id)},[w,ei,D]);let ep=async()=>{try{L(!0);let e=await fetch("/api/rehearse-export?performanceId=".concat(c,"&embedAudio=").concat(U?"1":"0"));if(!e.ok){let t=await e.text();throw console.error("Export error:",e.status,t),Error("Failed to export rehearse HTML")}let t=await e.blob(),a=URL.createObjectURL(t),r=((null==u?void 0:u.title)||"rehearse-export").toString().replace(/[^a-z0-9]+/gi,"-").replace(/^-+|-+$/g,"").toLowerCase(),s=document.createElement("a");s.href=a,s.download="".concat(r||"rehearse-export",".html"),document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(a)}catch(e){console.error("Export failed:",e),alert("Failed to export rehearse HTML")}finally{L(!1)}};return h?(0,r.jsx)("div",{className:"min-h-screen bg-gray-100 p-6",children:(0,r.jsx)("p",{className:"text-gray-600",children:"Loading..."})}):u?(0,r.jsxs)("div",{className:"min-h-screen bg-gray-100",children:[(0,r.jsx)("nav",{className:"bg-blue-900 text-white p-4 shadow-lg",children:(0,r.jsxs)("div",{className:"max-w-7xl mx-auto flex justify-between items-center",children:[(0,r.jsx)(v.AppBrand,{href:"/"}),(0,r.jsx)("div",{className:"flex gap-4",children:(0,r.jsx)(l(),{href:"/admin",className:"hover:bg-blue-800 px-3 py-2 rounded",children:"Admin Panel"})})]})}),(0,r.jsxs)("div",{className:"flex min-h-[calc(100vh-64px)]",children:[(0,r.jsx)("div",{className:"w-64 bg-white shadow-md p-6 overflow-y-auto border-r border-gray-200",children:(0,r.jsx)(x,{performanceId:c})}),(0,r.jsx)("div",{className:"flex-1 min-w-0 p-6",children:(0,r.jsxs)("div",{className:"".concat("positioning"===w?"max-w-none mx-0":"max-w-5xl mx-auto"),children:[(0,r.jsxs)("div",{className:"mb-8",children:[(0,r.jsx)(l(),{href:"/admin",className:"text-blue-600 hover:underline mb-4 block",children:"← Back to Dashboard"}),(0,r.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:u.title}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-gray-600",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-semibold",children:"Date:"})," ",Y.date?((e,t)=>{if(!e)return"—";let a=new Date(e);return Number.isNaN(a.getTime())?"—":a.toLocaleString(void 0,{timeZone:t||"America/New_York",timeZoneName:"short"})})(Y.date,Y.timezone):"—"]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-semibold",children:"Location:"})," ",u.location]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-semibold",children:"Timezone:"})," ",Y.timezone]})]}),u.description&&(0,r.jsxs)("div",{className:"mt-4 text-gray-600",children:[(0,r.jsx)("span",{className:"font-semibold",children:"Description:"})," ",u.description]})]}),(0,r.jsxs)("div",{className:"flex gap-4 mb-8 flex-wrap",children:[(0,r.jsx)("button",{onClick:()=>C("rehearsals"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("rehearsals"===w?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Rehearsals"}),(0,r.jsx)("button",{onClick:()=>C("parts"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("parts"===w?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Parts/Choreography"}),(0,r.jsx)("button",{onClick:()=>{C("positioning"),ei.length>0&&!D&&F(ei[0].id)},className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("positioning"===w?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Stage Positions"}),(0,r.jsx)("button",{onClick:()=>C("music"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("music"===w?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Music & Rehearse"}),(0,r.jsx)("button",{onClick:()=>C("info"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("info"===w?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Performance Info"})]}),"positioning"===w?(0,r.jsx)("div",{className:"flex flex-col gap-6",children:(0,r.jsx)("div",{className:"bg-white rounded-lg shadow-md p-8",children:0===ei.length?(0,r.jsxs)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:[(0,r.jsx)("p",{className:"text-gray-600 mb-4",children:"No parts created yet."}),(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"Create parts first before positioning students."})]}):D&&(0,r.jsx)(g,{performanceId:c,partId:D,partName:null==(t=ei.find(e=>e.id===D))?void 0:t.name,partDescription:null==(a=ei.find(e=>e.id===D))?void 0:a.description,isGroup:(null==(n=ei.find(e=>e.id===D))?void 0:n.is_group)!==!1,onSavePositions:async e=>{let t=e.map(e=>({part_id:D,student_id:e.student_id,x:e.x,y:e.y}));if(!(await fetch("/api/stage-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:D,positions:t})})).ok)throw Error("Failed to save positions")}})})}):(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-8",children:["rehearsals"===w&&(0,r.jsx)(S,{rehearsals:er,showForm:k,onToggleForm:()=>E(!k),onCreateRehearsal:es,onDeleteRehearsal:en,onUpdateRehearsal:el}),"parts"===w&&(0,r.jsx)(_,{performanceId:c,parts:ei,performances:eu,showForm:T,onToggleForm:()=>P(!T),onCreatePart:eo,onDeletePart:ed,onReorderParts:ec}),"music"===w&&(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)(b,{performanceId:c,performanceTitle:u.title,currentMusicFile:u.music_file_name,onUploadSuccess:(e,t)=>{O(t),m({...u,music_file_name:e.split("/").pop()})}}),A&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Preview Music"}),(0,r.jsx)(f,{musicUrl:A,performanceTitle:u.title})]}),(0,r.jsxs)("div",{className:"bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-lg border-2 border-purple-200",children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"\uD83C\uDFAD Rehearse/Emulate Mode"}),(0,r.jsx)("p",{className:"text-gray-700 mb-4",children:"Use rehearse mode to play back your choreography with automatic grid transitions based on music timepoints."}),(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-3",children:[(0,r.jsx)("button",{disabled:!A||0===ei.length,onClick:()=>M(!0),className:"px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-semibold",children:"Start Rehearse Mode →"}),(0,r.jsx)("button",{disabled:!A||0===ei.length||R,onClick:ep,className:"px-6 py-3 bg-white text-purple-700 border border-purple-300 rounded-lg hover:bg-purple-50 disabled:bg-gray-100 disabled:text-gray-400 disabled:border-gray-200 font-semibold",children:R?"Exporting...":"Export Rehearse HTML"}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-purple-900",children:[(0,r.jsx)("input",{type:"checkbox",checked:U,onChange:e=>J(e.target.checked),className:"h-4 w-4"}),"Embed audio in export"]})]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mt-2",children:[!A&&"⚠️ Upload music first",A&&0===ei.length&&"⚠️ Create parts and set timepoints",A&&ei.length>0&&"✓ Ready to rehearse"]})]}),ei.length>0&&(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Part Timepoints"}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("p",{className:"text-gray-600 text-sm",children:'Click "Edit" on a part to set its music timepoint (when the part should appear during rehearsal).'}),(0,r.jsxs)("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[(0,r.jsx)("p",{className:"font-semibold text-blue-900 mb-2",children:"\uD83D\uDCCB Parts Timeline:"}),(0,r.jsx)("div",{className:"space-y-2",children:ei.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,r.jsx)("span",{className:"font-medium text-gray-900",children:e.name}),e.timepoint_seconds?(0,r.jsxs)("span",{className:"text-amber-700 bg-amber-100 px-2 py-1 rounded",children:["Start: ",e.timepoint_seconds,"s",e.timepoint_end_seconds?" - End: ".concat(e.timepoint_end_seconds,"s"):""]}):(0,r.jsx)("span",{className:"text-gray-400 italic",children:"No timepoint set"})]},e.id))})]})]})]})]}),"info"===w&&(0,r.jsx)("div",{className:"space-y-6",children:(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Performance Info"}),q&&(0,r.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:q}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Performance Name"}),(0,r.jsx)("input",{type:"text",value:Y.title,onChange:e=>X(t=>({...t,title:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Date & Time"}),(0,r.jsx)("input",{type:"datetime-local",value:Y.date,onChange:e=>X(t=>({...t,date:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Call Time"}),(0,r.jsx)("input",{type:"time",value:Y.call_time,onChange:e=>X(t=>({...t,call_time:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Timezone"}),(0,r.jsx)("input",{type:"text",value:Y.timezone,onChange:e=>X(t=>({...t,timezone:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:"Use IANA format (e.g., America/New_York)"})]}),(0,r.jsxs)("div",{className:"md:col-span-2",children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Location"}),(0,r.jsx)("input",{type:"text",value:Y.location,onChange:e=>X(t=>({...t,location:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Description"}),(0,r.jsx)("textarea",{rows:3,value:Y.description,onChange:e=>X(t=>({...t,description:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Important Phone Numbers"}),(0,r.jsx)("textarea",{rows:4,placeholder:"One per line",value:Y.phone_numbers,onChange:e=>X(t=>({...t,phone_numbers:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,r.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2 items-center",children:[(0,r.jsxs)("select",{value:et,onChange:e=>ea(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,r.jsx)("option",{value:"",children:"Add saved contact..."}),$.map(e=>(0,r.jsxs)("option",{value:"".concat(e.name,"||").concat(e.phone),children:[e.name," • ",e.phone]},"".concat(e.name,"-").concat(e.phone)))]}),(0,r.jsx)("button",{onClick:()=>{if(!et)return;let[e,t]=et.split("||"),a="".concat(e,": ").concat(t);X(e=>({...e,phone_numbers:e.phone_numbers?"".concat(e.phone_numbers,"\n").concat(a):a})),ea("")},className:"px-3 py-1 bg-gray-900 text-white rounded text-xs",children:"Add to phone list"})]})]}),(0,r.jsxs)("div",{className:"mt-6 border-t border-gray-200 pt-4",children:[(0,r.jsx)("h4",{className:"font-semibold text-gray-900 mb-2",children:"Contacts Directory"}),(0,r.jsx)("p",{className:"text-sm text-gray-600 mb-3",children:"Add contacts and select which ones appear in the export."}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2 items-center mb-3",children:[(0,r.jsxs)("select",{value:et,onChange:e=>ea(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,r.jsx)("option",{value:"",children:"Add saved contact..."}),$.map(e=>(0,r.jsxs)("option",{value:"".concat(e.name,"||").concat(e.phone),children:[e.name," • ",e.phone]},"".concat(e.name,"-").concat(e.phone)))]}),(0,r.jsx)("button",{onClick:async()=>{if(!et)return;let[e,t]=et.split("||"),a=await fetch("/api/performance-contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:c,name:e,phone:t,include_in_export:!0})});if(a.ok){let e=await a.json();V(t=>[...t,e]),ea("")}},className:"px-3 py-1 bg-blue-600 text-white rounded text-xs",children:"Add to contacts"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[(0,r.jsx)("input",{type:"text",placeholder:"Name",value:Z,onChange:e=>K(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg"}),(0,r.jsx)("input",{type:"text",placeholder:"Phone",value:Q,onChange:e=>W(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg"}),(0,r.jsx)("button",{onClick:async()=>{if(!Z.trim()||!Q.trim())return;let e=await fetch("/api/performance-contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:c,name:Z.trim(),phone:Q.trim(),include_in_export:!0})});if(e.ok){let t=await e.json();V(e=>[...e,t]),K(""),W("")}},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold",children:"Add Contact"})]}),(0,r.jsx)("div",{className:"space-y-2",children:H.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("div",{className:"font-medium text-gray-900",children:e.name}),(0,r.jsx)("div",{className:"text-sm text-gray-600",children:e.phone})]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,r.jsx)("input",{type:"checkbox",checked:!!e.include_in_export,onChange:async t=>{(await fetch("/api/performance-contacts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({include_in_export:t.target.checked})})).ok&&V(a=>a.map(a=>a.id===e.id?{...a,include_in_export:t.target.checked}:a))}}),"Include in export"]}),(0,r.jsx)("button",{onClick:async()=>{(await fetch("/api/performance-contacts/".concat(e.id),{method:"DELETE"})).ok&&V(t=>t.filter(t=>t.id!==e.id))},className:"text-xs text-red-600 hover:text-red-800",children:"Remove"})]},e.id))})]}),(0,r.jsx)("div",{className:"mt-6",children:(0,r.jsx)("button",{onClick:async()=>{try{B(!0),G(null);let e=await fetch("/api/performances/".concat(c),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:Y.title,date:Y.date?new Date(Y.date).toISOString():null,call_time:Y.call_time,timezone:Y.timezone,location:Y.location,description:Y.description,phone_numbers:Y.phone_numbers})});if(!e.ok){let t=await e.json().catch(()=>null);throw Error((null==t?void 0:t.details)||(null==t?void 0:t.error)||"Failed to save info")}let t=await e.json();m(t),X(e=>({...e,title:t.title||"",call_time:t.call_time||"",timezone:t.timezone||e.timezone}));let a=await fetch("/api/performance-contacts?performanceId=".concat(c));if(a.ok){let e=await a.json();V(e||[])}}catch(e){G(e instanceof Error?e.message:"Failed to save info")}finally{B(!1)}},className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold disabled:bg-gray-400",disabled:z,children:z?"Saving...":"Save Info"})})]})})]})]})}),"positioning"===w&&ei.length>0&&(0,r.jsx)("div",{className:"w-80 bg-white shadow-md p-4 border-l border-gray-200",children:(0,r.jsxs)("div",{className:"sticky top-20 space-y-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-900 mb-2",children:"Parts & Choreography"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mb-3",children:"Drag to reorder. Click a card to show positions."}),(0,r.jsx)(p,{parts:ei,performanceId:c,onDelete:ed,onReorder:ec,onSelect:e=>F(e),selectedPartId:D,variant:"select",enableDrag:!0,showPositionedNames:!0})]}),(0,r.jsx)(N,{partId:D})]})})]}),I&&(0,r.jsx)(j,{performanceId:c,parts:ei,musicUrl:A,onClose:()=>M(!1)})]}):(0,r.jsxs)("div",{className:"min-h-screen bg-gray-100 p-6",children:[(0,r.jsx)("p",{className:"text-red-600",children:"Performance not found"}),(0,r.jsx)(l(),{href:"/admin",className:"text-blue-600 hover:underline",children:"Back to Admin"})]})}function S(e){let{rehearsals:t,showForm:a,onToggleForm:s,onCreateRehearsal:n,onDeleteRehearsal:l,onUpdateRehearsal:i}=e;return(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold",children:"Schedule Rehearsals"}),(0,r.jsx)("button",{onClick:s,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold",children:a?"Cancel":"+ Schedule Rehearsal"})]}),a&&(0,r.jsx)("div",{className:"mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200",children:(0,r.jsx)(d,{onSubmit:async(e,t)=>{await n(e,t)}})}),0===t.length?(0,r.jsx)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:(0,r.jsx)("p",{className:"text-gray-600",children:"No rehearsals scheduled yet."})}):(0,r.jsx)(c,{rehearsals:t,onDelete:l,onUpdate:i})]})}function _(e){let{performanceId:t,parts:a,performances:n,showForm:l,onToggleForm:i,onCreatePart:o,onDeletePart:d,onReorderParts:c}=e,[m,x]=(0,s.useState)(""),[h,g]=(0,s.useState)(!0),[b,f]=(0,s.useState)(!1),[y,j]=(0,s.useState)(null),[v,N]=(0,s.useState)(null),w=(n||[]).filter(e=>e.id!==t);return(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[(0,r.jsx)("h3",{className:"text-lg font-bold text-blue-900 mb-2",children:"Copy Parts from Another Performance"}),(0,r.jsx)("p",{className:"text-sm text-blue-800 mb-3",children:"This copies part names/descriptions (and optionally music timepoints). It does not copy grid positions or subparts."}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-3 items-center",children:[(0,r.jsxs)("select",{value:m,onChange:e=>x(e.target.value),className:"px-3 py-2 border border-blue-300 rounded-lg text-sm min-w-[220px]",children:[(0,r.jsx)("option",{value:"",children:"Select performance to copy from..."}),w.map(e=>(0,r.jsx)("option",{value:e.id,children:e.title},e.id))]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-blue-900",children:[(0,r.jsx)("input",{type:"checkbox",checked:h,onChange:e=>g(e.target.checked),className:"h-4 w-4"}),"Copy music timepoints"]}),(0,r.jsx)("button",{onClick:async()=>{if(m){f(!0),j(null),N(null);try{let e=await fetch("/api/parts/copy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_performance_id:m,target_performance_id:t,copy_timepoints:h})});if(!e.ok){let t=await e.json();throw Error(t.error||"Failed to copy parts")}let r=await e.json();Array.isArray(r)&&r.length>0?(null==c||c([...a,...r]),N("Copied ".concat(r.length," part(s)."))):N("No parts found to copy.")}catch(e){j(e instanceof Error?e.message:"Failed to copy parts")}finally{f(!1)}}},disabled:!m||b,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 font-semibold text-sm",children:b?"Copying...":"Copy Parts"})]}),y&&(0,r.jsx)("div",{className:"mt-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded px-3 py-2",children:y}),v&&(0,r.jsx)("div",{className:"mt-3 text-sm text-green-700 bg-green-50 border border-green-200 rounded px-3 py-2",children:v})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold",children:"Parts & Choreography"}),(0,r.jsx)("button",{onClick:i,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold",children:l?"Cancel":"+ Add Part"})]}),l&&(0,r.jsx)("div",{className:"mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200",children:(0,r.jsx)(u,{onSubmit:o})}),0===a.length?(0,r.jsx)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:(0,r.jsx)("p",{className:"text-gray-600",children:"No parts created yet."})}):(0,r.jsx)(p,{parts:a,performanceId:t,onDelete:d,onReorder:c})]})}},9815:(e,t,a)=>{"use strict";a.d(t,{f:()=>s});var r=a(2115);function s(){let[e,t]=(0,r.useState)([]),[a,s]=(0,r.useState)(!0),[n,l]=(0,r.useState)(null);(0,r.useEffect)(()=>{!async function(){try{let e=await fetch("/api/performances");if(!e.ok)throw Error("Failed to fetch performances");let a=await e.json();t(a)}catch(e){l(e instanceof Error?e.message:"An error occurred")}finally{s(!1)}}()},[]);let i=async(a,r,s,n,i,o)=>{try{let l=await fetch("/api/performances",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:a,description:r,date:s,location:n,call_time:i,timezone:o})});if(!l.ok)throw Error("Failed to create performance");let d=await l.json();return t([...e,d]),d}catch(e){throw l(e instanceof Error?e.message:"An error occurred"),e}},o=async a=>{try{if(!(await fetch("/api/performances/".concat(a),{method:"DELETE"})).ok)throw Error("Failed to delete performance");t(e.filter(e=>e.id!==a))}catch(e){throw l(e instanceof Error?e.message:"An error occurred"),e}};return{performances:e,loading:a,error:n,createPerformance:i,deletePerformance:o}}}},e=>{e.O(0,[481,441,255,358],()=>e(e.s=1712)),_N_E=e.O()}]);