(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[670],{701:(e,t,a)=>{"use strict";a.d(t,{e:()=>l});var r=a(5155),n=a(2115);let s=null;var i=a(5704);function l(e){let{value:t,onChange:a,placeholder:l,className:d,disabled:o=!1}=e,c=(0,n.useRef)(null),[u,m]=(0,n.useState)(null);return(0,n.useEffect)(()=>{var e,t;let r=i.env.NEXT_PUBLIC_GOOGLE_PLACES_API_KEY||"";if(!r||!c.current)return;let n=null;return((null==(t=window.google)||null==(e=t.maps)?void 0:e.places)?Promise.resolve():s||(s=new Promise((e,t)=>{let a=document.querySelector("script[data-google-places]");if(a){a.addEventListener("load",()=>e()),a.addEventListener("error",()=>t(Error("Failed to load Google Places")));return}let n=document.createElement("script");n.src="https://maps.googleapis.com/maps/api/js?key=".concat(r,"&libraries=places"),n.async=!0,n.defer=!0,n.dataset.googlePlaces="true",n.onload=()=>e(),n.onerror=()=>t(Error("Failed to load Google Places")),document.head.appendChild(n)}))).then(()=>{if(!c.current)return;let e=new window.google.maps.places.Autocomplete(c.current,{types:["geocode"],fields:["formatted_address","name"]});n=e,e.addListener("place_changed",()=>{let t=e.getPlace(),r=(null==t?void 0:t.formatted_address)||(null==t?void 0:t.name)||"";r&&a(r)})}).catch(e=>{m(e instanceof Error?e.message:"Failed to load Google Places")}),()=>{n&&window.google.maps.event.clearInstanceListeners(n)}},[a]),(0,r.jsxs)("div",{children:[(0,r.jsx)("input",{ref:c,type:"text",value:t,onChange:e=>a(e.target.value),placeholder:l,className:d,disabled:o}),u&&(0,r.jsx)("div",{className:"text-xs text-amber-700 mt-1",children:"Location autocomplete unavailable."})]})}},1517:(e,t,a)=>{"use strict";a.d(t,{AppBrand:()=>l});var r=a(5155),n=a(2619),s=a.n(n),i=a(6979);function l(e){let{href:t="/",textClassName:a="text-2xl font-bold",logoClassName:n=""}=e,l=(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)(i.v,{className:"border border-white/30 bg-white/10 text-white/60 ".concat(n)}),(0,r.jsx)("span",{className:a,children:"Performance Tool"})]});return t?(0,r.jsx)(s(),{href:t,className:"flex items-center gap-3",children:l}):l}},1712:(e,t,a)=>{Promise.resolve().then(a.bind(a,9374))},2890:(e,t,a)=>{"use strict";a.d(t,{N:()=>r});let r=(0,a(2373).UU)("https://quqvudqzztlmgrwqudho.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1cXZ1ZHF6enRsbWdyd3F1ZGhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MzQ1NjQsImV4cCI6MjA4NDAxMDU2NH0.NwxDWyz7vQiM1r3SqMn62iLjBJQGEO1-K6qgsP74hYg")},2992:(e,t,a)=>{"use strict";function r(e){try{let t=window.localStorage.getItem(e);if(!t)return null;return JSON.parse(t)}catch(e){return null}}function n(e,t){try{window.localStorage.setItem(e,JSON.stringify(t))}catch(e){}}function s(e){try{window.localStorage.removeItem(e)}catch(e){}}a.d(t,{C_:()=>r,J1:()=>n,nr:()=>s})},5959:(e,t,a)=>{"use strict";a.d(t,{$:()=>i});var r=a(5155),n=a(2115),s=a(2890);function i(e){let{className:t}=e,[a,i]=(0,n.useState)(!1);return(0,r.jsx)("button",{onClick:async()=>{i(!0),await s.N.auth.signOut(),i(!1)},disabled:a,className:t,children:a?"Signing out...":"Sign Out"})}},6979:(e,t,a)=>{"use strict";a.d(t,{v:()=>i});var r=a(5155),n=a(5239),s=a(2115);function i(e){let{size:t=36,className:a="",imgClassName:i=""}=e,[l,d]=(0,s.useState)(null);return(0,s.useEffect)(()=>{let e=!0;return(async()=>{try{let t=await fetch("/api/app-logo");if(!t.ok)return;let a=await t.json();e&&d(a.logoUrl||null)}catch(e){}})(),()=>{e=!1}},[]),(0,r.jsx)("div",{className:"flex items-center justify-center overflow-hidden ".concat(a),style:{width:t,height:t,borderRadius:8},children:l?(0,r.jsx)(n.default,{src:l,alt:"App logo",width:t,height:t,unoptimized:!0,className:"max-w-full max-h-full object-contain ".concat(i)}):(0,r.jsx)("span",{className:"text-[10px] font-semibold uppercase tracking-wide",children:"Logo"})})}},9157:(e,t,a)=>{"use strict";a.d(t,{$H:()=>c,GI:()=>r,Kb:()=>x,P9:()=>o,Xr:()=>l,Z5:()=>u,a7:()=>p,eL:()=>h,so:()=>m,y7:()=>d});let r="America/New_York",n=e=>/[zZ]|[+-]\d{2}:\d{2}$/.test(e),s=e=>{if(!e)return null;let[t,a]=e.split(/[T ]/);if(!t||!a)return null;let r=a.slice(0,5),[n,s,i]=t.split("-"),[l,d]=r.split(":"),o=Number(n),c=Number(s),u=Number(i),m=Number(l),p=Number(d);return Number.isFinite(o)&&Number.isFinite(c)&&Number.isFinite(u)&&Number.isFinite(m)&&Number.isFinite(p)?{datePart:t,timePart:r,year:o,month:c,day:u,hour:m,minute:p}:null};function i(e){if(!e)return null;let[t,a]=e.split("T");if(!t||!a)return null;let[r,n,s]=t.split("-"),[i,l]=a.split(":"),d=Number(r),o=Number(n),c=Number(s),u=Number(i),m=Number(l);return Number.isFinite(d)&&Number.isFinite(o)&&Number.isFinite(c)&&Number.isFinite(u)&&Number.isFinite(m)?{year:d,month:o,day:c,hour:u,minute:m}:null}function l(e,t){let a=i(e);if(!a)return"";let r=new Date(Date.UTC(a.year,a.month-1,a.day,a.hour,a.minute,0)),n=function(e,t){let a=new Intl.DateTimeFormat("en-US",{timeZone:e,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(t),r={};for(let e of a)"literal"!==e.type&&(r[e.type]=e.value);return Date.UTC(Number(r.year),Number(r.month)-1,Number(r.day),Number(r.hour),Number(r.minute),Number(r.second))-t.getTime()}(t,r);return new Date(r.getTime()-n).toISOString()}function d(e,t){if(!e)return"";if(!n(e)){let t=s(e);return t?"".concat(t.datePart,"T").concat(t.timePart):e}let a=new Date(e);if(Number.isNaN(a.getTime()))return"";let r=new Intl.DateTimeFormat("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(a),i={};for(let e of r)"literal"!==e.type&&(i[e.type]=e.value);return"".concat(i.year,"-").concat(i.month,"-").concat(i.day,"T").concat(i.hour,":").concat(i.minute)}function o(e,t){if(!e)return"—";if(!n(e)){let t=s(e);if(!t)return e;let a=new Date(Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,0)),r=a.toLocaleDateString(void 0,{timeZone:"UTC"}),n=a.toLocaleTimeString(void 0,{timeZone:"UTC",hour:"numeric",minute:"2-digit"});return"".concat(r,", ").concat(n," ET")}let a=new Date(e);return Number.isNaN(a.getTime())?"—":a.toLocaleString(void 0,{timeZone:t||r,timeZoneName:"short"})}function c(e,t){if(!e)return"\xe2€”";if(!n(e)){let t=s(e);if(!t)return e;let a=new Date(Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,0)).toLocaleString(void 0,{timeZone:"UTC",weekday:"long",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"});return"".concat(a," ET")}let a=new Date(e);return Number.isNaN(a.getTime())?"\xe2€”":a.toLocaleString(void 0,{timeZone:t||r,weekday:"long",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",timeZoneName:"short"})}function u(e,t){if(!e)return"—";if(!n(e)){let t=s(e);return t?p(t.timePart):e}let a=new Date(e);return Number.isNaN(a.getTime())?"—":a.toLocaleTimeString(void 0,{timeZone:t||r,hour:"numeric",minute:"2-digit"})}function m(e,t){if(!e)return"";if(!n(e)){let t=s(e);return t?t.datePart:""}let a=new Date(e);if(Number.isNaN(a.getTime()))return"";let i=new Intl.DateTimeFormat("en-US",{timeZone:t||r,year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(a),l={};for(let e of i)"literal"!==e.type&&(l[e.type]=e.value);return"".concat(l.year,"-").concat(l.month,"-").concat(l.day)}function p(e){if(!e)return"—";let[t,a]=e.split(":"),r=Number(t),n=Number(a);return Number.isFinite(r)&&Number.isFinite(n)?new Date(Date.UTC(2e3,0,1,r,n,0)).toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit",timeZone:"UTC"}):e}function x(e){let t=i(e);if(!t)return"";let a=new Date(Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,0));a.setUTCHours(a.getUTCHours()-1);let r=String(a.getUTCHours()).padStart(2,"0"),n=String(a.getUTCMinutes()).padStart(2,"0");return"".concat(r,":").concat(n)}function h(e,t){if(!e)return!1;let a=new Date(l(e,t));if(Number.isNaN(a.getTime()))return!1;let r=a.getTime()-36e5;return Date.now()>=r}},9374:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>O});var r=a(5155),n=a(2115),s=a(2619),i=a.n(s);function l(e){let[t,a]=(0,n.useState)([]),[r,s]=(0,n.useState)(!0),[i,l]=(0,n.useState)(null);(0,n.useEffect)(()=>{if(!e){a([]),s(!1);return}!async function(){try{let t=await fetch("/api/rehearsals?performanceId=".concat(e));if(!t.ok)throw Error("Failed to fetch rehearsals");let r=await t.json();a(r)}catch(e){l(e instanceof Error?e.message:"An error occurred")}finally{s(!1)}}()},[e]);let d=async(r,n)=>{if(!e)throw Error("Performance ID is required");try{let s=await Promise.all(n.map(t=>fetch("/api/rehearsals",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:e,title:r,date:t.date,time:t.time,location:t.location})})));for(let e of s)if(!e.ok)throw Error("Failed to create rehearsal");let i=await Promise.all(s.map(e=>e.json()));return a([...t,...i]),i}catch(e){throw l(e instanceof Error?e.message:"An error occurred"),e}},o=async e=>{try{if(!(await fetch("/api/rehearsals/".concat(e),{method:"DELETE"})).ok)throw Error("Failed to delete rehearsal");a(t.filter(t=>t.id!==e))}catch(e){throw l(e instanceof Error?e.message:"An error occurred"),e}};return{rehearsals:t,loading:r,error:i,createRehearsal:d,deleteRehearsal:o,updateRehearsal:async(e,t)=>{try{let r=await fetch("/api/rehearsals/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw Error("Failed to update rehearsal");let n=await r.json();return a(t=>t.map(t=>t.id===e?n:t)),n}catch(e){throw l(e instanceof Error?e.message:"An error occurred"),e}}}}var d=a(9815);function o(e){let{onSubmit:t,isLoading:a=!1}=e,[s,i]=(0,n.useState)({title:"",dateEntries:[{date:"",time:"",location:""}]}),[l,d]=(0,n.useState)(null),o=(e,t,a)=>{let r=[...s.dateEntries];r[e]={...r[e],[t]:a},i({...s,dateEntries:r})},c=async e=>{e.preventDefault(),d(null);let a=s.dateEntries.filter(e=>e.date&&e.time&&e.location);if(!s.title||0===a.length)return void d("Please fill in title and at least one complete date/time/location entry");try{await t(s.title,a),i({title:"",dateEntries:[{date:"",time:"",location:""}]})}catch(e){d(e instanceof Error?e.message:"An error occurred")}};return(0,r.jsxs)("form",{onSubmit:c,className:"space-y-4",children:[l&&(0,r.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:l}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Title *"}),(0,r.jsx)("input",{type:"text",value:s.title,onChange:e=>{i({...s,title:e.target.value})},placeholder:"e.g., Full Cast Rehearsal",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-4",children:"Schedule Dates & Times * (Each date can have different time/location)"}),(0,r.jsx)("div",{className:"space-y-4",children:s.dateEntries.map((e,t)=>(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Date *"}),(0,r.jsx)("input",{type:"date",value:e.date,onChange:e=>o(t,"date",e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Time *"}),(0,r.jsx)("input",{type:"time",value:e.time,onChange:e=>o(t,"time",e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Location *"}),(0,r.jsx)("input",{type:"text",value:e.location,onChange:e=>o(t,"location",e.target.value),placeholder:"e.g., Studio A",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]})]}),s.dateEntries.length>1&&(0,r.jsx)("button",{type:"button",onClick:()=>{i({...s,dateEntries:s.dateEntries.filter((e,a)=>a!==t)})},className:"mt-2 px-3 py-1 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600",children:"Remove"})]},t))}),(0,r.jsx)("button",{type:"button",onClick:()=>{i({...s,dateEntries:[...s.dateEntries,{date:"",time:"",location:""}]})},className:"mt-3 px-4 py-2 bg-gray-300 text-gray-900 rounded-lg hover:bg-gray-400 font-medium",children:"+ Add Another Date"})]}),(0,r.jsx)("button",{type:"submit",disabled:a,className:"w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors",children:a?"Scheduling...":"Schedule Rehearsal"})]})}var c=a(9157);function u(e){let{rehearsals:t,onDelete:a,onUpdate:s}=e,[i,l]=(0,n.useState)(null),[d,o]=(0,n.useState)({title:"",date:"",time:"",location:""}),u=e=>e?e.split("T")[0]:"",m=()=>{l(null)},p=async e=>{await s(e,d),l(null)};return(0,r.jsx)("div",{className:"space-y-3",children:t.map(e=>(0,r.jsxs)("div",{className:"flex justify-between items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50",children:[(0,r.jsx)("div",{className:"flex-1",children:i===e.id?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("input",{type:"text",value:d.title,onChange:e=>o(t=>({...t,title:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,r.jsx)("input",{type:"date",value:d.date,onChange:e=>o(t=>({...t,date:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsx)("input",{type:"time",value:d.time,onChange:e=>o(t=>({...t,time:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsx)("input",{type:"text",value:d.location,onChange:e=>o(t=>({...t,location:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",placeholder:"Location"})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-900",children:e.title}),(0,r.jsxs)("div",{className:"grid grid-cols-2 text-sm text-gray-600 mt-1",children:[(0,r.jsxs)("span",{children:["\uD83D\uDCC5 ",(e=>{if(!e)return"";let t=u(e);if(t){let[e,a,r]=t.split("-").map(Number);if(e&&a&&r)return new Date(Date.UTC(e,a-1,r,12,0,0)).toLocaleDateString(void 0,{timeZone:c.GI})}return new Date(e).toLocaleDateString(void 0,{timeZone:c.GI})})(e.date)]}),(0,r.jsxs)("span",{children:["\uD83D\uDD50 ",(0,c.a7)(e.time)," ET"]})]}),(0,r.jsxs)("div",{className:"text-sm text-gray-600 mt-1",children:["\uD83D\uDCCD ",e.location]})]})}),(0,r.jsx)("div",{className:"flex items-center gap-2 ml-4",children:i===e.id?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:()=>p(e.id),className:"px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm",children:"Save"}),(0,r.jsx)("button",{onClick:m,className:"px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm",children:"Cancel"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:()=>(e=>{let t=u(e.date);l(e.id),o({title:e.title||"",date:t,time:e.time||"",location:e.location||""})})(e),className:"px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm",children:"Edit"}),(0,r.jsx)("button",{onClick:()=>{window.confirm("Delete this rehearsal?")&&a(e.id)},className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm",children:"Delete"})]})})]},e.id))})}function m(e){let{onSubmit:t,isLoading:a=!1}=e,[s,i]=(0,n.useState)({name:"",description:"",order:0,is_group:!0}),[l,d]=(0,n.useState)("group"),[o,c]=(0,n.useState)([]),[u,m]=(0,n.useState)(null),p=e=>{i({...s,[e.target.name]:"number"===e.target.type?Number(e.target.value):e.target.value})},x=async e=>{if(e.preventDefault(),m(null),!s.name)return void m("Part name is required");try{let e="group"===l,a=o.map(e=>({title:e.title.trim(),notes:e.notes.trim()})).filter(e=>e.title.length>0);if(!e&&0===a.length)return void m("Add at least one subpart for this part.");let r=await t(s.name,s.description,s.order,e);e||await Promise.all(a.map(e=>fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:r.id,title:e.title,description:e.notes||null,mode:"position"})}))),i({name:"",description:"",order:0,is_group:!0}),d("group"),c([])}catch(e){m(e instanceof Error?e.message:"An error occurred")}};return(0,r.jsxs)("form",{onSubmit:x,className:"space-y-4",children:[u&&(0,r.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:u}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Part Name *"}),(0,r.jsx)("input",{type:"text",name:"name",value:s.name,onChange:p,placeholder:"e.g., Lead Dancers, Background Chorus",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Description"}),(0,r.jsx)("textarea",{name:"description",value:s.description,onChange:p,placeholder:"Details about this part/choreography...",rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,r.jsx)("input",{type:"radio",checked:"group"===l,onChange:()=>d("group"),className:"h-4 w-4"}),"Group part"]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,r.jsx)("input",{type:"radio",checked:"subparts"===l,onChange:()=>d("subparts"),className:"h-4 w-4"}),"Part with subparts / solos"]}),"subparts"===l&&(0,r.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2",children:[(0,r.jsx)("div",{className:"text-sm font-semibold text-gray-700",children:"Subparts"}),0===o.length&&(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"Add at least one subpart."}),(0,r.jsx)("div",{className:"space-y-2",children:o.map((e,t)=>(0,r.jsxs)("div",{className:"border border-gray-200 rounded p-2",children:[(0,r.jsx)("input",{type:"text",value:e.title,onChange:e=>{let a=[...o];a[t]={...a[t],title:e.target.value},c(a)},placeholder:"Subpart ".concat(t+1," title"),className:"w-full px-2 py-1 border border-gray-300 rounded text-sm mb-2"}),(0,r.jsx)("textarea",{value:e.notes,onChange:e=>{let a=[...o];a[t]={...a[t],notes:e.target.value},c(a)},placeholder:"Notes",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(0,r.jsx)("button",{type:"button",onClick:()=>c(o.filter((e,a)=>a!==t)),className:"mt-2 text-xs text-red-600 hover:text-red-800",children:"Remove"})]},"subpart-".concat(t)))}),(0,r.jsx)("button",{type:"button",onClick:()=>c([...o,{title:"",notes:""}]),className:"px-2 py-1 bg-blue-600 text-white rounded text-xs",children:"Add Subpart"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Order"}),(0,r.jsx)("input",{type:"number",name:"order",value:s.order,onChange:p,min:"0",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsx)("button",{type:"submit",disabled:a,className:"w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors",children:a?"Adding...":"Add Part"})]})}function p(e){let{parts:t,performanceId:a,onDelete:s,onReorder:i,onSelect:l,selectedPartId:d,variant:o="manage",enableDrag:c=!0,showPositionedNames:u=!0,compact:m=!1,showDelete:p=!1,musicUrl:x=null}=e,[h,g]=(0,n.useState)(null),[b,f]=(0,n.useState)(""),[y,v]=(0,n.useState)(""),[j,N]=(0,n.useState)(""),[w,_]=(0,n.useState)(""),[S,k]=(0,n.useState)(""),[C,E]=(0,n.useState)(""),[T,D]=(0,n.useState)(!0),[P,O]=(0,n.useState)({}),[M,I]=(0,n.useState)({}),[F,U]=(0,n.useState)(null),[A,L]=(0,n.useState)({}),[R,J]=(0,n.useState)({}),[q,z]=(0,n.useState)({}),[G,Z]=(0,n.useState)({}),[B,X]=(0,n.useState)({}),[H,W]=(0,n.useState)({}),[K,Y]=(0,n.useState)({}),[Q,V]=(0,n.useState)(null),[$,ee]=(0,n.useState)(""),[et,ea]=(0,n.useState)(""),[er,en]=(0,n.useState)(""),[es,ei]=(0,n.useState)(""),[el,ed]=(0,n.useState)(""),[eo,ec]=(0,n.useState)(""),[eu,em]=(0,n.useState)(null),[ep,ex]=(0,n.useState)(null),eh=(0,n.useMemo)(()=>[...t].sort((e,t)=>{let a="number"==typeof e.timepoint_seconds,r="number"==typeof t.timepoint_seconds;if(a&&r){let a=e.timepoint_seconds,r=t.timepoint_seconds;return a!==r?a-r:(e.order||0)-(t.order||0)}return a!==r?a?-1:1:(e.order||0)-(t.order||0)}),[t]),eg=e=>{if(null==e||""===e)return{min:"",sec:""};let t=Number(e);if(!Number.isFinite(t))return{min:"",sec:""};let a=Math.floor(t/60),r=Math.floor(t%60);return{min:String(a),sec:String(r)}},eb=(e,t)=>{if(!e&&!t)return null;let a=e?parseInt(e,10):0,r=t?parseFloat(t):0;return Number.isNaN(a)||Number.isNaN(r)?null:60*a+r},ef=e=>{if(null==e||""===e)return"--:--";let t=Number(e);if(!Number.isFinite(t))return"--:--";let a=Math.floor(t/60),r=Math.floor(t%60);return"".concat(a,":").concat(r.toString().padStart(2,"0"))},ey=(e,t)=>{if(null==e||null==t)return"";let a=Number(e),r=Number(t);if(!Number.isFinite(a)||!Number.isFinite(r))return"";let n=Math.max(0,Math.floor(r-a)),s=Math.floor(n/60);return"".concat(s,":").concat((n%60).toString().padStart(2,"0"))};(0,n.useEffect)(()=>{t.forEach(e=>{ev(e.id),ej(e.id)})},[t]);let ev=async e=>{try{let t=await fetch("/api/stage-positions?partId=".concat(e)),a=await t.json();O(t=>({...t,[e]:a.length})),I(t=>({...t,[e]:a.map(e=>e.student_name||"Unknown")}))}catch(e){console.error("Error fetching positions:",e)}},ej=async e=>{try{let t=await fetch("/api/subparts?partId=".concat(e));if(!t.ok)throw Error("Failed to fetch subparts");let a=await t.json();L(t=>({...t,[e]:a||[]}))}catch(e){console.error("Error fetching subparts:",e)}},eN=async e=>{let t=(R[e]||"").trim(),a=(q[e]||"").trim(),r=eb(G[e]||"",B[e]||""),n=eb(H[e]||"",K[e]||"");if(t)try{let s=await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:e,title:t,description:a||null,mode:"position",timepoint_seconds:r,timepoint_end_seconds:n})});if(!s.ok){let e=await s.json().catch(()=>null);throw Error((null==e?void 0:e.details)||(null==e?void 0:e.error)||"Failed to create subpart")}await ej(e),J(t=>({...t,[e]:""})),z(t=>({...t,[e]:""})),Z(t=>({...t,[e]:""})),X(t=>({...t,[e]:""})),W(t=>({...t,[e]:""})),Y(t=>({...t,[e]:""}))}catch(e){console.error("Error creating subpart:",e)}},ew=async(e,t)=>{try{if(!(await fetch("/api/subparts/".concat(e),{method:"DELETE"})).ok)throw Error("Failed to delete subpart");await ej(t)}catch(e){console.error("Error deleting subpart:",e)}},e_=()=>{V(null),ee(""),ea(""),en(""),ei(""),ed(""),ec("")},eS=async(e,t)=>{try{let a=await fetch("/api/subparts/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:$,description:et,timepoint_seconds:eb(er,es),timepoint_end_seconds:eb(el,eo)})});if(!a.ok){let e=await a.json().catch(()=>null);throw Error((null==e?void 0:e.details)||(null==e?void 0:e.error)||"Failed to update subpart")}await ej(t),e_()}catch(e){console.error("Error updating subpart:",e)}},ek=async(e,t,a)=>{var r;if(a<0||a>=((null==(r=A[e])?void 0:r.length)||0))return;let n=[...A[e]||[]],[s]=n.splice(t,1);n.splice(a,0,s),L(t=>({...t,[e]:n}));try{await Promise.all(n.map((e,t)=>fetch("/api/subparts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:t+1})})))}catch(t){console.error("Error reordering subparts:",t),await ej(e)}},eC=e=>{g(e.id),f(e.name),v(e.description||"");let t=eg(e.timepoint_seconds),a=eg(e.timepoint_end_seconds);N(t.min),_(t.sec),k(a.min),E(a.sec),D(!1!==e.is_group)},eE=async e=>{try{let a=await fetch("/api/parts/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:b,description:y,timepoint_seconds:eb(j,w),timepoint_end_seconds:eb(S,C),is_group:T})});if(!a.ok){let e=await a.json();throw console.error("API Error:",e),Error(e.details||"Failed to update part")}let r=await a.json();r&&i&&i(t.map(t=>t.id===e?{...t,...r}:t)),g(null)}catch(e){console.error("Error updating part:",e),alert("Error updating part: ".concat(e instanceof Error?e.message:String(e)))}},eT=async(e,t)=>{if(t<0||t>=eh.length)return;let a=[...eh],[r]=a.splice(e,1);a.splice(t,0,r);try{let e=a.map((e,t)=>fetch("/api/parts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:t+1})}));if(!(await Promise.all(e)).every(e=>e.ok))throw Error("Some updates failed");let t=a.map((e,t)=>({...e,order:t+1}));i&&i(t)}catch(e){console.error("Error reordering parts:",e)}};return(0,r.jsx)("div",{className:"space-y-3",children:eh.map((e,t)=>{var a,n,i,O;let I=m&&h!==e.id,L=!1===e.is_group?"Subparts/Solos":"Group";return(0,r.jsx)("div",{draggable:c,onDragStart:()=>U(e.id),onDragOver:e=>{c&&e.preventDefault()},onDrop:()=>{if(c&&F&&F!==e.id)eT(eh.findIndex(e=>e.id===F),eh.findIndex(t=>t.id===e.id)),U(null)},onClick:()=>null==l?void 0:l(e.id),className:"p-4 border rounded-lg hover:bg-gray-50 ".concat(c?"cursor-move":""," ").concat(d===e.id?"border-blue-500 bg-blue-50":"border-gray-200"),children:h===e.id?(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("input",{type:"text",value:b,onChange:e=>f(e.target.value),placeholder:"Part name",className:"w-full px-3 py-2 border border-gray-300 rounded-lg"}),(0,r.jsx)("textarea",{value:y,onChange:e=>v(e.target.value),placeholder:"Part description (optional)",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",rows:2}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,r.jsx)("input",{type:"checkbox",checked:T,onChange:e=>D(e.target.checked),className:"h-4 w-4"}),"Group part (unchecked = has subparts/solos)"]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-semibold text-gray-700 mb-1",children:"Start Time (m / s)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:j,onChange:e=>N(e.target.value),placeholder:"min",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:w,onChange:e=>_(e.target.value),placeholder:"sec",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-semibold text-gray-700 mb-1",children:"End Time (m / s)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:S,onChange:e=>k(e.target.value),placeholder:"min",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:C,onChange:e=>E(e.target.value),placeholder:"sec",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]})]})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>eE(e.id),className:"px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm",children:"Save"}),(0,r.jsx)("button",{onClick:()=>g(null),className:"px-3 py-1 bg-gray-400 text-white rounded hover:bg-gray-500 text-sm",children:"Cancel"})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex justify-between items-start ".concat(I?"":"mb-3"),children:[(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("h3",{className:"font-bold text-gray-900 truncate",children:e.name}),!I&&e.description&&(0,r.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:e.description}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:L})]}),("manage"===o&&!I||p)&&(0,r.jsxs)("div",{className:"flex gap-2 ml-4",children:["manage"===o&&!I&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:()=>eT(t,t-1),disabled:0===t,className:"px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 text-sm",title:"Move up",children:"↑"}),(0,r.jsx)("button",{onClick:()=>eT(t,t+1),disabled:t===eh.length-1,className:"px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 text-sm",title:"Move down",children:"↓"})]}),p&&(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),window.confirm("Delete this part?")&&s(e.id)},className:"px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm",title:"Delete",children:"Delete"})]})]}),I&&(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[(0,r.jsx)("span",{className:"text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded",children:L}),(0,r.jsxs)("span",{className:"text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded",children:["Positioned: ",null!=(O=P[e.id])?O:"-"]}),(0,r.jsxs)("span",{className:"text-xs bg-purple-50 text-purple-700 px-2 py-1 rounded",children:["Order: ",e.order]}),(void 0!==e.timepoint_seconds||void 0!==e.timepoint_end_seconds)&&(0,r.jsxs)("span",{className:"text-xs bg-amber-50 text-amber-700 px-2 py-1 rounded",children:[ef(e.timepoint_seconds)," - ",ef(e.timepoint_end_seconds)]}),(void 0!==e.timepoint_seconds||void 0!==e.timepoint_end_seconds)&&(0,r.jsxs)("span",{className:"text-xs bg-emerald-50 text-emerald-700 px-2 py-1 rounded",children:["Duration: ",ey(e.timepoint_seconds,e.timepoint_end_seconds)]}),x&&(void 0!==e.timepoint_seconds||void 0!==e.timepoint_end_seconds)&&(0,r.jsx)("audio",{controls:!0,preload:"metadata",className:"h-8",onPlay:t=>{let a=Number(e.timepoint_seconds||0);Number.isFinite(a)&&(t.currentTarget.currentTime=a)},children:(0,r.jsx)("source",{src:x})}),"manage"===o&&(0,r.jsxs)("div",{className:"flex gap-2 ml-auto",children:[(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),eC(e)},className:"px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-xs",children:"Edit"}),(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),window.confirm("Delete this part?")&&s(e.id)},className:"px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs",children:"Delete"})]})]}),I&&(null==(a=A[e.id])?void 0:a.length)>0&&(0,r.jsxs)("div",{className:"mt-2 text-xs text-gray-600",children:["Subparts: ",[...A[e.id]].sort((e,t)=>{let a="number"==typeof e.timepoint_seconds?e.timepoint_seconds:1/0,r="number"==typeof t.timepoint_seconds?t.timepoint_seconds:1/0;return a!==r?a-r:(e.title||"").localeCompare(t.title||"")}).map(e=>e.title).join(", ")]}),!I&&"manage"===o&&(void 0!==e.timepoint_seconds||void 0!==e.timepoint_end_seconds)&&(0,r.jsxs)("div",{className:"bg-amber-50 p-2 rounded mb-3 text-sm",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Music Timepoint:"}),(0,r.jsxs)("span",{className:"font-bold text-amber-700 ml-2",children:[ef(e.timepoint_seconds)," - ",ef(e.timepoint_end_seconds)]}),(0,r.jsxs)("span",{className:"ml-2 text-emerald-700",children:["(Duration ",ey(e.timepoint_seconds,e.timepoint_end_seconds),")"]})]}),!I&&u&&(null==(n=M[e.id])?void 0:n.length)>0&&(0,r.jsx)("div",{className:"bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:M[e.id].join(", ")}),!I&&(null==(i=A[e.id])?void 0:i.length)>0&&(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-600 mb-1",children:"Subparts / Solos"}),(0,r.jsx)("div",{className:"space-y-1",children:A[e.id].map(t=>(0,r.jsx)("div",{className:"flex items-start justify-between gap-2 ".concat("manage"===o?"cursor-move":""),draggable:"manage"===o,onDragStart:()=>{em(t.id),ex(e.id)},onDragOver:e=>{"manage"===o&&e.preventDefault()},onDrop:()=>{if("manage"!==o||!eu||ep!==e.id)return;let a=A[e.id].findIndex(e=>e.id===eu),r=A[e.id].findIndex(e=>e.id===t.id);ek(e.id,a,r),em(null),ex(null)},children:Q===t.id?(0,r.jsxs)("div",{className:"w-full space-y-2",children:[(0,r.jsx)("input",{type:"text",value:$,onChange:e=>ee(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("textarea",{value:et,onChange:e=>ea(e.target.value),rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:er,onChange:e=>en(e.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:es,onChange:e=>ei(e.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:el,onChange:e=>ed(e.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:eo,onChange:e=>ec(e.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]}),(0,r.jsxs)("select",{value:t.mode||"position",onChange:a=>fetch("/api/subparts/".concat(t.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:a.target.value})}).then(()=>ej(e.id)),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation(),children:[(0,r.jsx)("option",{value:"position",children:"Position"}),(0,r.jsx)("option",{value:"order",children:"Order"}),(0,r.jsx)("option",{value:"both",children:"Both"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:a=>{a.stopPropagation(),eS(t.id,e.id)},className:"px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700",children:"Save"}),(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),e_()},className:"px-2 py-1 bg-gray-400 text-white rounded text-xs hover:bg-gray-500",children:"Cancel"})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium text-gray-800",children:t.title}),t.description&&(0,r.jsx)("div",{className:"text-gray-500",children:t.description}),t.mode&&(0,r.jsxs)("div",{className:"text-gray-400 text-[10px] mt-1",children:["Mode: ",t.mode]}),(0,r.jsxs)("div",{className:"text-gray-400 text-[10px] mt-1",children:["Time: ",ef(t.timepoint_seconds)," - ",ef(t.timepoint_end_seconds)]})]}),(0,r.jsx)("div",{className:"flex items-center gap-2",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:e=>{e.stopPropagation();V(t.id),ee(t.title),ea(t.description||"");let a=eg(t.timepoint_seconds),r=eg(t.timepoint_end_seconds);en(a.min),ei(a.sec),ed(r.min),ec(r.sec)},className:"text-[10px] text-blue-600 hover:text-blue-800",children:"Edit"}),(0,r.jsx)("button",{onClick:a=>{a.stopPropagation(),ew(t.id,e.id)},className:"text-[10px] text-red-600 hover:text-red-800",children:"Remove"})]})})]})},t.id))})]}),!I&&(0,r.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-600 mb-1",children:"Add Subpart"}),(0,r.jsx)("input",{type:"text",value:R[e.id]||"",onChange:t=>J(a=>({...a,[e.id]:t.target.value})),placeholder:"Subpart title",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2",onClick:e=>e.stopPropagation()}),(0,r.jsx)("textarea",{value:q[e.id]||"",onChange:t=>z(a=>({...a,[e.id]:t.target.value})),placeholder:"Description",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2",onClick:e=>e.stopPropagation()}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:G[e.id]||"",onChange:t=>Z(a=>({...a,[e.id]:t.target.value})),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:B[e.id]||"",onChange:t=>X(a=>({...a,[e.id]:t.target.value})),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:H[e.id]||"",onChange:t=>W(a=>({...a,[e.id]:t.target.value})),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:K[e.id]||"",onChange:t=>Y(a=>({...a,[e.id]:t.target.value})),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]}),(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),eN(e.id)},className:"px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700",children:"Add"})]}),!I&&"manage"===o&&(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>eC(e),className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm",children:"Edit"}),(0,r.jsx)("button",{onClick:()=>ev(e.id),className:"px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm",children:"Refresh Count"}),(0,r.jsx)("button",{onClick:()=>{window.confirm("Delete this part?")&&s(e.id)},className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm",children:"Delete"})]})]})},e.id)})})}var x=a(6979);function h(e){let{performanceId:t}=e,[a,s]=(0,n.useState)([]),[i,d]=(0,n.useState)(!0),[o,u]=(0,n.useState)(null),[m,p]=(0,n.useState)(!1),[h,g]=(0,n.useState)(""),[b,f]=(0,n.useState)(""),[y,v]=(0,n.useState)(!1),[j,N]=(0,n.useState)([]),[w,_]=(0,n.useState)([]),[S,k]=(0,n.useState)([]),[C,E]=(0,n.useState)([]),[T,D]=(0,n.useState)(!1),[P,O]=(0,n.useState)(""),{rehearsals:M}=l(t),I=(0,n.useCallback)(async()=>{try{d(!0);let e=await fetch("/api/performances/".concat(t,"/roster"));if(!e.ok)throw Error("Failed to fetch roster");let a=await e.json();s(a)}catch(e){console.error("Error fetching roster:",e),u(e instanceof Error?e.message:"Failed to load roster")}finally{d(!1)}},[t]),F=(0,n.useCallback)(async()=>{if(t)try{D(!0);let e=await fetch("/api/rehearsal-attendance?performanceId=".concat(t));if(!e.ok){let t=await e.text();throw console.error("Attendance fetch failed:",e.status,t),Error("Failed to fetch attendance")}let a=await e.json();E(a)}catch(e){console.error("Error fetching attendance:",e)}finally{D(!1)}},[t]);(0,n.useEffect)(()=>{I()},[I]),(0,n.useEffect)(()=>{F()},[F]),(0,n.useEffect)(()=>{(async()=>{if(t)try{let e=await fetch("/api/performances/".concat(t));if(!e.ok)return;let a=await e.json();O((null==a?void 0:a.date)||"")}catch(e){console.error("Error fetching performance date:",e)}})()},[t]);let U=(0,n.useCallback)(async()=>{try{let e=await fetch("/api/students");if(!e.ok)throw Error("Failed to fetch students");let t=await e.json();k(t)}catch(e){console.error("Error fetching students:",e)}},[]);(0,n.useEffect)(()=>{m&&U()},[m,U]);let A=async e=>{try{if(!(await fetch("/api/signups/".concat(e),{method:"DELETE"})).ok)throw Error("Failed to remove student");s(a.filter(t=>t.signup_id!==e))}catch(e){console.error("Error removing student:",e),u(e instanceof Error?e.message:"Failed to remove student")}},L=e=>{_(t=>[...t,e]),g(""),f("")},R=async e=>{e.preventDefault();let a=h.trim().length>0?[...j,h.trim()]:[...j];if(0===a.length&&0===w.length)return void u("Please enter at least one name");v(!0);try{for(let e of w)if(!(await fetch("/api/signups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:t,student_id:e.id,status:"registered"})})).ok)throw Error("Failed to add to roster");for(let e of a){let a=await fetch("/api/students",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:b.trim()?b.trim():null})});if(!a.ok)throw Error("Failed to create student");let r=await a.json();if(!(await fetch("/api/signups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:t,student_id:r.id,status:"registered"})})).ok)throw Error("Failed to add to roster")}g(""),f(""),N([]),_([]),p(!1),await I()}catch(e){u(e instanceof Error?e.message:"Failed to add student")}finally{v(!1)}},J=(0,n.useMemo)(()=>{let e=new Map;for(let t of C)e.set("".concat(t.rehearsal_id,":").concat(t.student_id),t);return e},[C]),q=(0,n.useCallback)(e=>e?e.split("T")[0]:"",[]),z=(0,n.useCallback)(e=>{let t=q(e);if(!t)return new Date(e);let[a,r,n]=t.split("-").map(Number);return new Date(Date.UTC(a,(r||1)-1,n||1,12,0,0))},[q]),G=(0,n.useMemo)(()=>[...M].sort((e,t)=>z(e.date).getTime()-z(t.date).getTime()),[M,z]),Z=e=>z(e).toLocaleDateString(void 0,{month:"numeric",day:"numeric",timeZone:c.GI}),B=(0,n.useMemo)(()=>new Set(a.map(e=>e.student_id)),[a]),X=(0,n.useMemo)(()=>new Set(w.map(e=>e.id)),[w]),H=(0,n.useMemo)(()=>{let e=h.trim().toLowerCase();return e?S.filter(t=>!(B.has(t.id)||X.has(t.id))&&t.name.toLowerCase().includes(e)).slice(0,8):[]},[S,h,B,X]),W=async(e,t,a)=>{if(a)return;let r="".concat(e,":").concat(t),n=J.get(r);try{if(!n){let a=await fetch("/api/rehearsal-attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rehearsal_id:e,student_id:t,status:"present"})});if(!a.ok)throw Error("Failed to save attendance");let r=await a.json();E(e=>[...e,r]);return}if("present"===n.status){let a=await fetch("/api/rehearsal-attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rehearsal_id:e,student_id:t,status:"absent"})});if(!a.ok)throw Error("Failed to save attendance");let r=await a.json();E(e=>e.map(e=>e.id===r.id?r:e));return}if(!(await fetch("/api/rehearsal-attendance?rehearsalId=".concat(e,"&studentId=").concat(t),{method:"DELETE"})).ok)throw Error("Failed to clear attendance");E(a=>a.filter(a=>a.rehearsal_id!==e||a.student_id!==t))}catch(e){console.error("Error updating attendance:",e),u(e instanceof Error?e.message:"Failed to update attendance")}};return i?(0,r.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,r.jsx)("p",{className:"text-gray-500",children:"Loading roster..."})}):(0,r.jsx)("div",{className:"h-full flex flex-col",children:(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(x.v,{size:22,className:"border border-gray-200 bg-white text-gray-400"}),(0,r.jsxs)("h3",{className:"font-semibold text-gray-900",children:["Roster (",a.length,")"]})]}),(0,r.jsx)("button",{onClick:()=>p(!m),className:"px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700",children:m?"Cancel":"+ Add"})]}),G.length>0&&(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mb-3 text-xs text-gray-600",children:[(0,r.jsx)("span",{children:"Attendance:"}),(0,r.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,r.jsx)("span",{className:"h-3 w-3 rounded bg-green-500 inline-block"}),"Present"]}),(0,r.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,r.jsx)("span",{className:"h-3 w-3 rounded bg-red-500 inline-block"}),"Missed"]}),(0,r.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,r.jsx)("span",{className:"h-3 w-3 rounded bg-gray-300 inline-block"}),"Pending"]}),(0,r.jsx)("span",{className:"text-gray-500",children:"Click boxes to toggle."})]}),o&&(0,r.jsx)("div",{className:"bg-yellow-100 border border-yellow-400 text-yellow-700 px-3 py-2 rounded mb-4 text-sm",children:o}),m&&(0,r.jsxs)("form",{onSubmit:R,className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg space-y-2",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("input",{type:"text",value:h,onChange:e=>g(e.target.value),onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=H.find(e=>e.name.toLowerCase()===h.trim().toLowerCase());if(t)return void L(t);let a=h.trim();a&&(N(e=>[...e,a]),g(""),f(""))}},placeholder:"Name (press Enter to add)",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),H.length>0&&(0,r.jsx)("div",{className:"absolute z-10 mt-1 w-full rounded border border-gray-200 bg-white shadow-sm text-sm",children:H.map(e=>(0,r.jsxs)("button",{type:"button",onClick:()=>L(e),className:"w-full text-left px-2 py-1 hover:bg-blue-50",children:[(0,r.jsx)("span",{className:"font-medium text-gray-900",children:e.name}),e.email&&(0,r.jsxs)("span",{className:"text-gray-500",children:[" • ",e.email]})]},e.id))})]}),(0,r.jsx)("input",{type:"email",value:b,onChange:e=>f(e.target.value),placeholder:"Email (optional)",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(j.length>0||w.length>0)&&(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[w.map(e=>(0,r.jsxs)("span",{className:"inline-flex items-center gap-1 bg-green-50 border border-green-200 text-green-800 px-2 py-1 rounded text-xs",children:[e.name,(0,r.jsx)("button",{type:"button",onClick:()=>{var t;return t=e.id,void _(e=>e.filter(e=>e.id!==t))},className:"text-green-800 hover:text-green-900","aria-label":"Remove ".concat(e.name),children:"\xd7"})]},e.id)),j.map((e,t)=>(0,r.jsxs)("span",{className:"inline-flex items-center gap-1 bg-white border border-blue-200 text-blue-700 px-2 py-1 rounded text-xs",children:[e,(0,r.jsx)("button",{type:"button",onClick:()=>{N(e=>e.filter((e,a)=>a!==t))},className:"text-blue-700 hover:text-blue-900","aria-label":"Remove ".concat(e),children:"\xd7"})]},"".concat(e,"-").concat(t)))]}),(0,r.jsx)("button",{type:"submit",disabled:y,className:"w-full px-2 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400",children:y?"Adding...":"Add to Roster"})]}),0===a.length?(0,r.jsx)("p",{className:"text-gray-500 text-sm",children:"No students registered yet"}):(0,r.jsx)("div",{className:"space-y-2",children:a.map(e=>(0,r.jsxs)("div",{className:"bg-gray-50 p-2 rounded-md border border-gray-200 flex justify-between items-start group",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"font-medium text-gray-900 text-xs",children:e.name}),e.email&&(0,r.jsx)("p",{className:"text-gray-600 text-[10px]",children:e.email}),e.part_name&&(0,r.jsx)("div",{className:"mt-1",children:(0,r.jsx)("span",{className:"inline-block bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-medium",children:e.part_name})}),G.length>0&&(0,r.jsxs)("div",{className:"mt-1 flex flex-wrap gap-1",children:[P&&(0,r.jsxs)("div",{title:"Performance \xe2€\xa2 ".concat(Z(P)," ET"),className:"h-7 w-9 border bg-gray-200 text-gray-700 border-gray-300 text-[9px] leading-tight rounded flex flex-col items-center justify-center font-semibold opacity-90",children:[(0,r.jsx)("span",{children:Z(P)}),(0,r.jsx)("span",{children:"P"})]}),G.map(t=>{var a;let n=J.get("".concat(t.id,":").concat(e.student_id)),s=(e=>{let t=(0,c.so)(new Date().toISOString(),c.GI);return q(e.date)>t})(t),i=null!=(a=null==n?void 0:n.status)?a:"pending";return(0,r.jsxs)("button",{type:"button",onClick:()=>W(t.id,e.student_id,s),disabled:T,title:"".concat(t.title," • ").concat(Z(t.date)," ").concat((0,c.a7)(t.time)," ET"),className:"h-7 w-9 border text-[9px] leading-tight rounded flex flex-col items-center justify-center font-semibold ".concat("present"===i?"bg-green-500 text-white border-green-600":"absent"===i?"bg-red-500 text-white border-red-600":"bg-gray-300 text-gray-700 border-gray-400"," ").concat(s?"opacity-70 cursor-not-allowed":"hover:opacity-90"),children:[(0,r.jsx)("span",{children:Z(t.date)}),(0,r.jsx)("span",{children:"R"})]},t.id)})]})]}),(0,r.jsx)("button",{onClick:()=>A(e.signup_id),className:"ml-2 px-2 py-0.5 bg-red-500 text-white rounded text-[10px] opacity-0 group-hover:opacity-100 hover:bg-red-600 transition-opacity",title:"Remove from roster",children:"Remove"})]},e.signup_id))})]})})}function g(e,t){if(!e||0===e.length)return"?";let a=e.charAt(0).toUpperCase();return t.filter(t=>t!==e&&t.charAt(0).toUpperCase()===a).length>0?e.slice(0,2).toUpperCase():a}function b(e){var t,a,s,i;let{performanceId:l,partId:d,partName:o=null,partDescription:c=null,partTimepointSeconds:u=null,partTimepointEndSeconds:m=null,isGroup:p=!0,onSavePositions:h}=e,[b,f]=(0,n.useState)([]),[y,v]=(0,n.useState)([]),[j,N]=(0,n.useState)(null),[w,_]=(0,n.useState)(!1),[S,k]=(0,n.useState)(!0),[C,E]=(0,n.useState)(!1),[T,D]=(0,n.useState)(null),[P,O]=(0,n.useState)("bottom"),[M,I]=(0,n.useState)(Date.now()),F=(0,n.useRef)(null),[U,A]=(0,n.useState)(1),L=n.useRef(null),R=n.useRef(!1),[J,q]=(0,n.useState)([]),[z,G]=(0,n.useState)(null),[Z,B]=(0,n.useState)({}),[X,H]=(0,n.useState)({}),[W,K]=(0,n.useState)({}),[Y,Q]=(0,n.useState)(null),[V,$]=(0,n.useState)(null),[ee,et]=(0,n.useState)(null),[ea,er]=(0,n.useState)(null),[en,es]=(0,n.useState)(!1),[ei,el]=(0,n.useState)(o||""),[ed,eo]=(0,n.useState)(!1),[ec,eu]=(0,n.useState)(!1),[em,ep]=(0,n.useState)(c||""),[ex,eh]=(0,n.useState)(!1),[eg,eb]=(0,n.useState)(!1),[ef,ey]=(0,n.useState)(""),[ev,ej]=(0,n.useState)(""),[eN,ew]=(0,n.useState)(""),[e_,eS]=(0,n.useState)(""),[ek,eC]=(0,n.useState)(!1),[eE,eT]=(0,n.useState)(null),[eD,eP]=(0,n.useState)([]),[eO,eM]=(0,n.useState)(""),[eI,eF]=(0,n.useState)(!1),[eU,eA]=(0,n.useState)(!1),[eL,eR]=(0,n.useState)([]),[eJ,eq]=(0,n.useState)([]),[ez,eG]=(0,n.useState)(""),[eZ,eB]=(0,n.useState)(!1),[eX,eH]=(0,n.useState)({}),[eW,eK]=(0,n.useState)([]),[eY,eQ]=(0,n.useState)({}),[eV,e$]=(0,n.useState)({}),[e0,e1]=(0,n.useState)({}),e2=(0,n.useMemo)(()=>[...J].sort((e,t)=>{let a="number"==typeof e.timepoint_seconds?e.timepoint_seconds:1/0,r="number"==typeof t.timepoint_seconds?t.timepoint_seconds:1/0;return a!==r?a-r:(e.title||"").localeCompare(t.title||"")}),[J]),e3=(0,n.useCallback)(async()=>{try{let e=await fetch("/api/subparts?partId=".concat(d));if(e.ok){let t=await e.json();q(t||[]);let a=new Set((t||[]).map(e=>e.id));(0===(t||[]).length||z&&!a.has(z))&&G(null)}}catch(e){console.error("Error fetching subparts:",e)}},[d,z]),e6=(0,n.useCallback)(async()=>{try{let e=await fetch("/api/performances/".concat(l,"/roster"));if(!e.ok)throw Error("Failed to fetch roster");let t=(await e.json()).filter(e=>e.part_id===d||!e.part_id);f(t)}catch(e){console.error("Error fetching roster:",e)}},[l,d]),e5=(0,n.useCallback)(async()=>{if(l){eB(!0);try{let[e,t]=await Promise.all([fetch("/api/equipment?performanceId=".concat(l)),fetch("/api/equipment-usage?performanceId=".concat(l))]);if(e.ok){let t=await e.json();eR(t||[])}if(t.ok){let e=await t.json();eq(e||[])}}catch(e){console.error("Error fetching equipment:",e)}finally{eB(!1)}}},[l]),e4=(0,n.useCallback)(async()=>{if(l)try{let e=await fetch("/api/parts?performanceId=".concat(l));if(!e.ok)return;let t=await e.json();eK(t||[]);let a=await Promise.all((t||[]).map(async e=>{let t=await fetch("/api/subparts?partId=".concat(e.id));if(!t.ok)return[e.id,[]];let a=await t.json();return[e.id,a||[]]})),r={};a.forEach(e=>{let[t,a]=e;r[t]=a}),eQ(r);let n=await Promise.all((t||[]).map(async e=>{let t=await fetch("/api/part-sides?partId=".concat(e.id));if(!t.ok)return[e.id,[]];let a=await t.json();return[e.id,a||[]]})),s={};n.forEach(e=>{let[t,a]=e;s[t]=a}),e$(s);let i=Object.values(r).flat().map(e=>e.id),d=await Promise.all(i.map(async e=>{let t=await fetch("/api/subpart-order?subpartId=".concat(e));if(!t.ok)return[e,[]];let a=await t.json();return[e,a||[]]})),o={};d.forEach(e=>{let[t,a]=e;o[t]=a}),e1(o)}catch(e){console.error("Error fetching equipment parts:",e)}},[l]);(0,n.useEffect)(()=>{!async function(){try{let e=await fetch("/api/performances/".concat(l));if(e.ok){let t=await e.json();t.stage_orientation&&O("top"===t.stage_orientation?"top":"bottom")}await e6(),await e3();let t=await fetch("/api/stage-positions?partId=".concat(d));if(!t.ok)throw Error("Failed to fetch positions");let a=await t.json();v(a.map(e=>({student_id:e.student_id||"",name:e.student_name||"Unknown",x:e.x,y:e.y,id:e.id})))}catch(e){D(e instanceof Error?e.message:"Failed to load data")}finally{k(!1)}}()},[l,d,p,e3,e6]),(0,n.useEffect)(()=>{e5(),e4()},[e5,e4]),(0,n.useEffect)(()=>{let e=setInterval(()=>{document.hidden||e6()},5e3);return()=>clearInterval(e)},[e6]),(0,n.useEffect)(()=>{let e=F.current;if(!e)return;let t=()=>{let t=e.clientWidth;t&&A(Math.min(1,t/768))};t();let a=new ResizeObserver(t);return a.observe(e),()=>a.disconnect()},[768]),(0,n.useEffect)(()=>{el(o||"")},[o]),(0,n.useEffect)(()=>{ep(c||"")},[c]),(0,n.useEffect)(()=>{eT({start:"number"==typeof u?u:null,end:"number"==typeof m?m:null});let e=tn(null!=u?u:null),t=tn(null!=m?m:null);ey(e.min),ej(e.sec),ew(t.min),eS(t.sec)},[u,m]),(0,n.useEffect)(()=>{G(null)},[d]);let e7=(0,n.useCallback)(async()=>{try{let e=await fetch("/api/parts?performanceId=".concat(l));if(!e.ok)return;let t=await e.json(),a=(t||[]).map(e=>({key:"part:".concat(e.id),label:"Part: ".concat(e.name)})),r=(await Promise.all((t||[]).map(async e=>{let t=await fetch("/api/subparts?partId=".concat(e.id));return t.ok?(await t.json()||[]).map(t=>({key:"subpart:".concat(t.id),label:"Subpart: ".concat(e.name," - ").concat(t.title)})):[]}))).flat();eP([...a,...r])}catch(e){console.error("Error loading position sources:",e)}},[l]);(0,n.useEffect)(()=>{e7()},[e7]);let e9=(0,n.useCallback)(async()=>{await e3(),await e7()},[e3,e7]);(0,n.useEffect)(()=>{let e=()=>{e9()},t=()=>{"visible"===document.visibilityState&&e9()};return window.addEventListener("focus",e),document.addEventListener("visibilitychange",t),()=>{window.removeEventListener("focus",e),document.removeEventListener("visibilitychange",t)}},[e9]),(0,n.useEffect)(()=>{let e=window.setInterval(()=>{e9()},3e3);return()=>window.clearInterval(e)},[e9]),(0,n.useEffect)(()=>{z&&(async()=>{try{let[e,t]=await Promise.all([fetch("/api/subpart-positions?subpartId=".concat(z)),fetch("/api/subpart-order?subpartId=".concat(z))]);if(e.ok){let t=await e.json();B(e=>({...e,[z]:(t||[]).map(e=>({student_id:e.student_id||"",name:e.student_name||"Unknown",x:e.x,y:e.y,id:e.id}))}))}if(t.ok){let e=await t.json();H(t=>({...t,[z]:(e||[]).map(e=>{var t,a;return{id:e.id,student_id:e.student_id,student_name:e.student_name||"Unknown",start_side:null!=(t=e.start_side)?t:"OS",end_side:null!=(a=e.end_side)?a:"OS"}})}))}}catch(e){console.error("Error fetching subpart data:",e)}})()},[z]),(0,n.useEffect)(()=>{J.length>0||(async()=>{try{let e=await fetch("/api/part-sides?partId=".concat(d));if(!e.ok)return;let t=await e.json();K(e=>({...e,[d]:(t||[]).map(e=>{var t,a;return{id:e.id,student_id:e.student_id,student_name:e.student_name||"Unknown",start_side:null!=(t=e.start_side)?t:"OS",end_side:null!=(a=e.end_side)?a:"OS"}})}))}catch(e){console.error("Error fetching part sides:",e)}})()},[d,J.length]),(0,n.useEffect)(()=>(L.current=setInterval(async()=>{if(R.current)try{if(E(!0),z&&J.length>0){let e=(Z[z]||[]).map(e=>({subpart_id:z,student_id:e.student_id,x:e.x,y:e.y}));await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:z,positions:e})})}else await h(y);await fetch("/api/performances/".concat(l),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({stage_orientation:P})}),R.current=!1,I(Date.now()),D(null)}catch(e){console.error("Auto-save error:",e)}finally{E(!1)}},6e3),()=>{L.current&&clearInterval(L.current)}),[y,P,l,h,z,J,Z]);let e8=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];N(e),_(t),et(null)},te=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},tt=(e,t)=>Number.isNaN(e)||e<0?0:e>t?t:e,ta=(e,t)=>{if("number"!=typeof e||"number"!=typeof t||!Number.isFinite(e)||!Number.isFinite(t))return"";let a=Math.max(0,t-e),r=Math.floor(a/60),n=Math.round(a%60);return"".concat(r,"m ").concat(n,"s")},tr=e=>{if(null==e||Number.isNaN(e))return"--:--";let t=Math.max(0,Math.floor(e)),a=Math.floor(t/60);return"".concat(a,":").concat((t%60).toString().padStart(2,"0"))},tn=e=>{if(null==e||Number.isNaN(e))return{min:"",sec:""};let t=Math.max(0,Math.floor(e));return{min:String(Math.floor(t/60)),sec:String(t%60)}},ts=(e,t)=>{if(!e&&!t)return null;let a=e?parseInt(e,10):0,r=t?parseFloat(t):0;return Number.isNaN(a)||Number.isNaN(r)?null:60*a+r},ti=async(e,t,a)=>{if(e.preventDefault(),!j||J.length>0&&!tw)return;let r=b.find(e=>e.student_id===j);if(w&&!r){let e=y.find(e=>e.student_id===j);e&&(r={student_id:j,name:e.name,part_name:null})}if(!r)return;let n=[...(z&&J.length>0?Z[z]||[]:y).filter(e=>e.student_id!==j),{student_id:j,name:r.name,x:"top"===P?11-t:t,y:"top"===P?8-a:a}];z&&J.length>0?(B(e=>({...e,[z]:n})),await to(n,X[z]||[])):v(n),R.current=!0,N(null),_(!1)},tl=async()=>{try{if(E(!0),z&&J.length>0){let e=(Z[z]||[]).map(e=>({subpart_id:z,student_id:e.student_id,x:e.x,y:e.y}));await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:z,positions:e})})}else await h(y);await fetch("/api/performances/".concat(l),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({stage_orientation:P})}),D(null)}catch(e){D(e instanceof Error?e.message:"Failed to save positions")}finally{E(!1)}},td=(0,n.useCallback)(async e=>{z&&(H(t=>({...t,[z]:e})),e1(t=>({...t,[z]:e})),await fetch("/api/subpart-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.map((e,t)=>{var a,r;return{subpart_id:z,student_id:e.student_id,order:t+1,start_side:null!=(a=e.start_side)?a:"OS",end_side:null!=(r=e.end_side)?r:"OS"}}))}))},[z]),to=(0,n.useCallback)(async(e,t)=>{if(!z)return;let a=new Set(t.map(e=>e.student_id)),r=e.filter(e=>e.student_id&&!a.has(e.student_id)).map(e=>({id:"temp-".concat(Date.now(),"-").concat(e.student_id),student_id:e.student_id,student_name:e.name,start_side:"OS",end_side:"OS"}));if(0===r.length)return;let n=[...t,...r];await td(n)},[td,z]),tc=(0,n.useMemo)(()=>z&&X[z]||[],[z,X]),tu=(0,n.useMemo)(()=>0===J.length&&W[d]||[],[W,d,J.length]),tm=(0,n.useCallback)(async e=>{K(t=>({...t,[d]:e})),e$(t=>({...t,[d]:e})),await fetch("/api/part-sides",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.map(e=>{var t,a;return{part_id:d,student_id:e.student_id,start_side:null!=(t=e.start_side)?t:"OS",end_side:null!=(a=e.end_side)?a:"OS"}}))})},[d]),tp=(0,n.useCallback)(async()=>{let e=J.length>0?tc:tu;if(0===b.length)return;let t=new Map(e.map(e=>[e.student_id,e])),a=[...e],r=new Map;if(J.length>0&&z){let e=e2.findIndex(e=>e.id===z);if(e>0){var n;let t=null==(n=e2[e-1])?void 0:n.id;r=new Map((t&&X[t]||[]).map(e=>[e.student_id,e.end_side||"OS"]))}}b.forEach(e=>{if(t.has(e.student_id))return;let n=r.get(e.student_id)||"OS";a.push({id:"temp-".concat(Date.now(),"-").concat(e.student_id),student_id:e.student_id,student_name:e.name,start_side:n,end_side:n})}),a.length!==e.length&&(J.length>0?await td(a):await tm(a))},[tc,tu,b,J.length,z,e2,X,td,tm]),tx=(0,n.useCallback)(async(e,t)=>{if(t<0||t>=J.length)return;let a=[...J],[r]=a.splice(e,1);a.splice(t,0,r),q(a);try{await Promise.all(a.map((e,t)=>fetch("/api/subparts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:t+1})})))}catch(e){console.error("Error reordering subparts:",e),await e3()}},[J,e3]);(0,n.useEffect)(()=>{if(!z)return;let e=Z[z]||[],t=X[z]||[];0!==e.length&&to(e,t)},[z,Z,X,to]),(0,n.useEffect)(()=>{tp()},[tp]);let th=async()=>{if(!eO)return[];let[e,t]=eO.split(":");if(!t)return[];let a=await fetch("subpart"===e?"/api/subpart-positions?subpartId=".concat(t):"/api/stage-positions?partId=".concat(t));if(!a.ok)throw Error(await a.text()||"Failed to fetch source positions");return(await a.json()||[]).map(e=>({student_id:e.student_id||"",name:e.student_name||"Unknown",x:e.x,y:e.y}))},tg=async()=>{if(eO){eA(!0);try{let e=(await th()).map(e=>{let t=eI?11-e.x:e.x;return{...e,x:tt(t,11),y:tt(e.y,8)}});z&&J.length>0?(B(t=>({...t,[z]:e})),await to(e,X[z]||[]),await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:z,positions:e.map(e=>({subpart_id:z,student_id:e.student_id,x:e.x,y:e.y}))})})):(v(e),await h(e)),R.current=!1,I(Date.now()),D(null)}catch(e){D(e instanceof Error?e.message:"Failed to apply positions")}finally{eA(!1)}}},tb=J.find(e=>e.id===z);(0,n.useEffect)(()=>{0!==J.length&&!z&&e2.length>0&&G(e2[0].id)},[J.length,e2,z]);let tf=tb?ta(tb.timepoint_seconds,tb.timepoint_end_seconds):"",ty=null!=(a=null!=(t=null==eE?void 0:eE.start)?t:u)?a:null,tv=null!=(i=null!=(s=null==eE?void 0:eE.end)?s:m)?i:null,tj=ta(ty,tv),tN=(null==tb?void 0:tb.mode)||"position",tw=0===J.length||"order"!==tN,t_=J.length>0,tS=(0,n.useMemo)(()=>{let e={};return tc.forEach((t,a)=>{t.student_id&&(e[t.student_id]=a+1)}),e},[tc]),tk=z&&J.length>0?Z[z]||[]:y,tC=J.length>0?tc:tu,tE=tC.filter(e=>!e.start_side).length,tT=tC.filter(e=>!e.end_side).length,tD=new Set(tk.map(e=>e.student_id)),tP=new Map;tk.forEach(e=>{tP.has(e.student_id)||tP.set(e.student_id,e)});let tO=Array.from(tP.values()).map(e=>({student_id:e.student_id,name:e.name,initials:g(e.name,Array.from(tP.values()).map(e=>e.name))})),tM=(0,n.useMemo)(()=>{let e=new Map;return b.forEach(t=>e.set(t.student_id,t.name)),e},[b]),tI=z&&J.length>0?"subpart:".concat(z):"part:".concat(d),tF=(0,n.useMemo)(()=>{let e=[];return eW.forEach((t,a)=>{let r=eY[t.id]||[];if(r.length>0)r.forEach((r,n)=>{var s;e.push({key:"subpart:".concat(r.id),part_id:t.id,subpart_id:r.id,label:r.title||t.name,timepoint:null!=(s=r.timepoint_seconds)?s:null,orderFallback:100*a+n})});else{var n;e.push({key:"part:".concat(t.id),part_id:t.id,subpart_id:null,label:t.name,timepoint:null!=(n=t.timepoint_seconds)?n:null,orderFallback:100*a})}}),e.sort((e,t)=>{let a="number"==typeof e.timepoint?e.timepoint:1/0,r="number"==typeof t.timepoint?t.timepoint:1/0;return a!==r?a-r:e.orderFallback-t.orderFallback})},[eW,eY]),tU=(0,n.useMemo)(()=>{let e=new Map;return tF.forEach((t,a)=>e.set(t.key,a)),e},[tF]),tA=(0,n.useMemo)(()=>{let e=new Map;return tF.forEach(t=>{let a=t.subpart_id&&e0[t.subpart_id]?e0[t.subpart_id]:eV[t.part_id]||[],r=new Map;a.forEach(e=>{var t,a;r.set(e.student_id,{start_side:null!=(t=e.start_side)?t:null,end_side:null!=(a=e.end_side)?a:null})}),e.set(t.key,r)}),e},[tF,eV,e0]),tL=(0,n.useMemo)(()=>{let e=new Map;return eJ.forEach(t=>{let a=t.subpart_id?"subpart:".concat(t.subpart_id):"part:".concat(t.part_id),r=e.get(a)||[];r.push(t),e.set(a,r)}),e},[eJ]),tR=(0,n.useMemo)(()=>{let e=new Map;return eJ.forEach(t=>{let a=e.get(t.equipment_id)||[];a.push(t),e.set(t.equipment_id,a)}),e},[eJ]),tJ=(0,n.useMemo)(()=>{var e;let t=null!=(e=tU.get(tI))?e:-1;return eL.map(e=>{let a=(tR.get(e.id)||[]).find(e=>(e.subpart_id?"subpart:".concat(e.subpart_id):"part:".concat(e.part_id))===tI),r=null,n=null,s=(null==a?void 0:a.student_name)||a&&tM.get(a.student_id)||"";if(a){let e=tA.get(tI),t=null==e?void 0:e.get(a.student_id);r=(null==t?void 0:t.start_side)||null,n=(null==t?void 0:t.end_side)||null}else if(t>=0){var i;let a=null!=(i=e.initial_side)?i:null;for(let r=t-1;r>=0;r-=1){let t=tF[r],n=(tL.get(t.key)||[]).find(t=>t.equipment_id===e.id);if(!n)continue;let s=tA.get(t.key),i=null==s?void 0:s.get(n.student_id);a=(null==i?void 0:i.end_side)||a;break}r=a,n=null}return{equipment:e,activeUsage:a,activeStudentName:s,startSide:r,endSide:n,isActive:!!a}}).sort((e,t)=>Number(t.isActive)-Number(e.isActive))},[eL,tF,tR,tL,tA,tU,tI,tM]),tq=(0,n.useCallback)(e=>{let t=new Set;return e.filter(e=>!t.has(e.student_id)&&(t.add(e.student_id),!0))},[]);(0,n.useEffect)(()=>{eH(e=>{let t={...e};return tJ.forEach(e=>{var a;(null==(a=e.activeUsage)?void 0:a.student_id)&&(t[e.equipment.id]=e.activeUsage.student_id)}),t})},[tJ]);let tz=(0,n.useCallback)(async()=>{let e=ez.trim();if(!e)return;let t=await fetch("/api/equipment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:l,name:e,initial_side:null})});if(!t.ok)return;let a=await t.json();eR(e=>[...e,a]),eG("")},[ez,l]),tG=(0,n.useCallback)(async(e,t)=>{let a=await fetch("/api/equipment/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok)return;let r=await a.json();eR(t=>t.map(t=>t.id===e?{...t,...r}:t))},[]),tZ=(0,n.useCallback)(async(e,t)=>{let a=tI.startsWith("subpart:")?tI.replace("subpart:",""):null,r=eX[e];if(t){if(!r)return;let t=await fetch("/api/equipment-usage",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({equipment_id:e,part_id:d,subpart_id:a,student_id:r})});if(!t.ok)return;let n=await t.json();eq(t=>[...t.filter(t=>t.equipment_id!==e||t.part_id!==d||(t.subpart_id||null)!==(a||null)),{...n,student_name:tM.get(r)||n.student_name}])}else{let t=new URLSearchParams({equipment_id:e,part_id:d});if(a&&t.set("subpart_id",a),!(await fetch("/api/equipment-usage?".concat(t.toString()),{method:"DELETE"})).ok)return;eq(t=>t.filter(t=>t.equipment_id!==e||t.part_id!==d||(t.subpart_id||null)!==(a||null)))}},[tI,eX,d,tM]),tB=(0,n.useCallback)(async(e,t)=>{let a=tI.startsWith("subpart:")?tI.replace("subpart:",""):null;if(!t)return;let r=await fetch("/api/equipment-usage",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({equipment_id:e,part_id:d,subpart_id:a,student_id:t})});if(!r.ok)return;let n=await r.json();eq(r=>[...r.filter(t=>t.equipment_id!==e||t.part_id!==d||(t.subpart_id||null)!==(a||null)),{...n,student_name:tM.get(t)||n.student_name}])},[tI,d,tM]);return S?(0,r.jsx)("div",{className:"text-center py-8",children:"Loading..."}):(0,r.jsxs)("div",{className:"space-y-6",children:[T&&(0,r.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:T}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-[220px_1fr] gap-6",children:[(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200 hidden lg:block",children:[(0,r.jsxs)("h3",{className:"font-semibold text-gray-900 mb-2",children:["Students (",b.length,")"]}),(0,r.jsx)("p",{className:"text-[11px] text-gray-500 mb-3",children:"Positioned students stay here so you can assign them to subparts."}),(0,r.jsx)("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:0===b.length?(0,r.jsx)("p",{className:"text-gray-500 text-sm",children:"No students yet."}):b.map(e=>{let t=tD.has(e.student_id),a=tC.find(t=>t.student_id===e.student_id),n=(null==a?void 0:a.start_side)||"OS",s=(null==a?void 0:a.end_side)||"OS";return(0,r.jsxs)("div",{draggable:!0,onDragStart:()=>{e8(e.student_id,!1),Q(e.student_id)},className:"p-3 rounded border cursor-move hover:shadow-md transition-all ".concat(t?"bg-emerald-50 border-emerald-200 hover:border-emerald-300":"bg-white border-blue-200 hover:border-blue-400"),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,r.jsx)("p",{className:"font-medium text-sm text-gray-900",children:e.name}),t&&(0,r.jsx)("span",{className:"text-[10px] px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 font-semibold",children:"Positioned"})]}),(0,r.jsxs)("div",{className:"text-[10px] text-gray-500 mt-1",children:["Start: ",(0,r.jsx)("span",{className:"font-semibold text-gray-700",children:n})," ","End: ",(0,r.jsx)("span",{className:"font-semibold text-gray-700",children:s})]}),e.part_name&&(0,r.jsx)("p",{className:"text-xs text-gray-600",children:e.part_name})]},e.student_id)})}),t_&&z&&(0,r.jsx)("div",{className:"mt-4 border-t border-gray-200 pt-4",children:(0,r.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-2 mb-2",children:[(0,r.jsx)("p",{className:"text-[11px] text-gray-500",children:"Everyone has a start and end side (OS, SL, SR)."}),J.length>0&&(0,r.jsx)("button",{type:"button",onClick:async()=>{var e;if(!z)return;let t=e2.findIndex(e=>e.id===z);if(t<=0)return;let a=null==(e=e2[t-1])?void 0:e.id;if(!a)return;let r=new Map((X[a]||[]).map(e=>[e.student_id,e.end_side||"OS"])),n=tc.map(e=>({...e,start_side:r.get(e.student_id)||e.start_side||"OS"}));await td(n)},className:"text-[10px] px-2 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300",children:"Set start from previous end"})]})}),!z&&(0,r.jsxs)("div",{className:"mt-4 border-t border-gray-200 pt-4",children:[(0,r.jsx)("h4",{className:"font-medium text-gray-900 mb-2 text-sm",children:"Assigned Students (Part)"}),(0,r.jsx)("div",{className:"bg-white p-2 rounded border border-gray-200",children:0===y.length?(0,r.jsx)("div",{className:"text-xs text-gray-500 text-center",children:"No positioned students"}):(0,r.jsx)("div",{className:"space-y-2",children:y.map((e,t)=>(0,r.jsx)("div",{className:"flex items-center justify-between bg-gray-50 border border-gray-200 rounded px-2 py-1",children:(0,r.jsx)("div",{className:"text-xs text-gray-900",children:e.name})},e.id||"".concat(e.student_id,"-").concat(t)))})})]})]}),(0,r.jsx)("div",{children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-start justify-between gap-3 mb-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(x.v,{size:24,className:"border border-gray-200 bg-white text-gray-400"}),(0,r.jsx)("h3",{className:"font-semibold text-gray-900",children:"Stage Layout"}),en?(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("input",{type:"text",value:ei,onChange:e=>el(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm"}),(0,r.jsx)("button",{onClick:async()=>{if(!d)return;let e=ei.trim();if(e){eo(!0);try{if(!(await fetch("/api/parts/".concat(d),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})})).ok)throw Error("Failed to update part name");es(!1)}catch(e){alert(e instanceof Error?e.message:"Failed to update part name")}finally{eo(!1)}}},disabled:ed,className:"px-2 py-1 bg-green-600 text-white rounded text-xs disabled:bg-gray-400",children:ed?"Saving...":"Save"}),(0,r.jsx)("button",{onClick:()=>{es(!1),el(o||"")},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("span",{className:"text-xl font-semibold text-gray-900",children:o||""}),(0,r.jsx)("button",{onClick:()=>es(!0),className:"text-xs text-blue-600 hover:text-blue-800",children:"Edit name"})]})]}),(0,r.jsxs)("div",{className:"mt-2",children:[ec?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("textarea",{value:em,onChange:e=>ep(e.target.value),rows:2,placeholder:"Add part notes...",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:async()=>{if(d){eh(!0);try{if(!(await fetch("/api/parts/".concat(d),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:em||null})})).ok)throw Error("Failed to update part notes");eu(!1)}catch(e){alert(e instanceof Error?e.message:"Failed to update part notes")}finally{eh(!1)}}},disabled:ex,className:"px-2 py-1 bg-green-600 text-white rounded text-xs disabled:bg-gray-400",children:ex?"Saving...":"Save notes"}),(0,r.jsx)("button",{onClick:()=>{eu(!1),ep(c||"")},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]})]}):(0,r.jsxs)("div",{className:"flex items-start gap-2",children:[(0,r.jsx)("p",{className:"text-sm text-gray-600",children:c||"No notes yet."}),(0,r.jsx)("button",{onClick:()=>eu(!0),className:"text-xs text-blue-600 hover:text-blue-800",children:"Edit notes"})]}),tj&&(0,r.jsxs)("div",{className:"mt-1 text-xs text-gray-500",children:["Duration: ",tj]}),(0,r.jsxs)("div",{className:"mt-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("div",{className:"text-xs font-semibold text-gray-600",children:"Timepoint"}),!eg&&(0,r.jsx)("button",{onClick:()=>eb(!0),className:"text-xs text-blue-600 hover:text-blue-800",children:"Edit time"})]}),eg?(0,r.jsxs)("div",{className:"mt-2 space-y-2",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[10px] text-gray-500",children:"Start (m / s)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:ef,onChange:e=>ey(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:ev,onChange:e=>ej(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[10px] text-gray-500",children:"End (m / s)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:eN,onChange:e=>ew(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:e_,onChange:e=>eS(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]})]})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:async()=>{let e=ts(ef,ev),t=ts(eN,e_);if(null!==e&&null!==t&&t<e)return void alert("End time must be after start time.");eC(!0);try{if(!(await fetch("/api/parts/".concat(d),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({timepoint_seconds:e,timepoint_end_seconds:t})})).ok)throw Error("Failed to update timepoint");eT({start:e,end:t}),eb(!1)}catch(e){alert(e instanceof Error?e.message:"Failed to update timepoint")}finally{eC(!1)}},disabled:ek,className:"px-2 py-1 bg-emerald-600 text-white rounded text-xs disabled:bg-gray-400",children:ek?"Saving...":"Save"}),(0,r.jsx)("button",{onClick:()=>{let e=tn(ty),t=tn(tv);ey(e.min),ej(e.sec),ew(t.min),eS(t.sec),eb(!1)},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]})]}):(0,r.jsxs)("div",{className:"mt-1 text-xs text-gray-600",children:[tr(ty)," - ",tr(tv)]})]})]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mt-1",children:["Front of stage: ","bottom"===P?"Bottom":"Top"]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-600",children:"Subpart"}),(0,r.jsxs)("select",{value:z||"",onChange:e=>G(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-xs",disabled:0===J.length,children:[(0,r.jsx)("option",{value:"",children:"Part positions"}),0===J.length&&(0,r.jsx)("option",{value:"",disabled:!0,children:"No subparts yet"}),e2.map(e=>(0,r.jsx)("option",{value:e.id,children:e.title},e.id))]}),(null==tb?void 0:tb.description)&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500",children:tb.description}),tf&&(0,r.jsxs)("span",{className:"text-[10px] text-gray-500",children:["Duration: ",tf]})]}),(0,r.jsxs)("div",{className:"flex flex-col items-end gap-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 text-xs",children:[C&&(0,r.jsx)("span",{className:"text-blue-600 font-semibold",children:"Auto-saving..."}),!C&&R.current&&(0,r.jsx)("span",{className:"text-orange-600 font-semibold",children:"Unsaved changes (auto-saves in 6s)"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsxs)("select",{value:P,onChange:e=>O(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,r.jsx)("option",{value:"bottom",children:"Front - Bottom"}),(0,r.jsx)("option",{value:"top",children:"Front - Top"})]}),(0,r.jsx)("button",{onClick:()=>{z&&J.length>0?B(e=>({...e,[z]:[]})):v([]),R.current=!0},className:"px-4 py-2 bg-gray-300 text-gray-900 rounded-lg hover:bg-gray-400 font-medium text-sm",children:"Reset All"}),(0,r.jsx)("button",{onClick:tl,disabled:C,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 font-medium text-sm",children:C?"Saving...":"Save Positions"})]})]})]}),J.length>0&&(0,r.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3",children:[(0,r.jsx)("div",{className:"text-xs font-semibold text-gray-700 mb-2",children:"Subparts"}),(0,r.jsx)("div",{className:"flex flex-wrap gap-2",children:e2.map((e,t)=>(0,r.jsxs)("button",{draggable:!0,onDragStart:()=>er(e.id),onDragOver:e=>e.preventDefault(),onDrop:()=>{if(!ea)return;let t=J.findIndex(e=>e.id===ea),a=J.findIndex(t=>t.id===e.id);t<0||a<0||(tx(t,a),er(null))},onClick:()=>G(e.id),className:"px-3 py-1 rounded-full text-xs font-semibold border transition-colors ".concat(z===e.id?"bg-blue-600 text-white border-blue-700":"bg-white text-gray-700 border-gray-300 hover:bg-gray-100"),title:"Drag to reorder",children:[t+1,". ",e.title]},e.id))})]}),tk.length>0&&(0,r.jsxs)("div",{className:"bg-blue-50 p-3 rounded-lg border border-blue-200",children:[(0,r.jsx)("h4",{className:"font-medium text-gray-900 mb-2 text-sm",children:"Legend"}),(0,r.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:tO.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,r.jsx)("div",{className:"w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold",children:e.initials}),(0,r.jsx)("span",{className:"text-gray-700 truncate",children:e.name})]},e.student_id))})]}),(0,r.jsxs)("div",{className:"bg-white p-3 rounded-lg border border-gray-200",children:[(0,r.jsx)("div",{className:"font-medium text-gray-900 text-sm mb-2",children:"Quick Position"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2 items-center",children:[(0,r.jsxs)("select",{value:eO,onChange:e=>eM(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,r.jsx)("option",{value:"",children:"Select a part or subpart..."}),eD.map(e=>(0,r.jsx)("option",{value:e.key,children:e.label},e.key))]}),(0,r.jsx)("button",{onClick:tg,disabled:!eO||eU,className:"px-3 py-1 bg-blue-600 text-white rounded text-sm disabled:bg-gray-400",children:eU?"Applying...":"Apply"})]}),(0,r.jsxs)("label",{className:"mt-2 flex items-center gap-2 text-xs text-gray-700",children:[(0,r.jsx)("input",{type:"checkbox",checked:eI,onChange:e=>eF(e.target.checked),className:"h-4 w-4"}),"Horizontal flip before applying"]})]}),J.length>0&&(0,r.jsx)("div",{className:"text-sm text-gray-700 font-medium text-center",children:(null==tb?void 0:tb.title)||"Subpart"}),(0,r.jsxs)("div",{className:"flex items-start justify-center gap-3",children:[e2.length>0&&tw&&(0,r.jsx)("button",{onClick:()=>{let e=e2.findIndex(e=>e.id===z);e>0&&G(e2[e-1].id)},disabled:!z||0===e2.findIndex(e=>e.id===z),className:"px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 text-xs",children:"Prev"}),(0,r.jsxs)("div",{className:"space-y-3 w-48",children:[["start_side","end_side"].map(e=>(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded p-2",children:[(0,r.jsxs)("div",{className:"text-[11px] font-semibold text-gray-700 mb-1",children:["Stage Right ","start_side"===e?"Start":"End"]}),(0,r.jsx)("div",{className:"border border-dashed border-gray-300 rounded p-2 min-h-[64px]",onDragOver:e=>e.preventDefault(),onDrop:async()=>{if(!Y)return;let t=tC.map(t=>t.student_id===Y?{...t,[e]:"SR"}:t);J.length>0?await td(t):await tm(t),Q(null),$(null)},children:(0,r.jsx)("div",{className:"flex flex-wrap gap-2",children:tq(tC.filter(t=>"SR"===(t[e]||"OS"))).map((t,a,n)=>{let s=tD.has(t.student_id);return(0,r.jsxs)("span",{draggable:!0,onDragStart:()=>{Q(t.student_id),$({student_id:t.student_id,field:e,side:"SR"})},onDragOver:e=>e.preventDefault(),onDrop:async()=>{if(V&&V.field===e&&"SR"===V.side){let e=n.map(e=>e.student_id),a=e.indexOf(V.student_id),r=e.indexOf(t.student_id);if(a<0||r<0||a===r)return;let s=[...n],[i]=s.splice(a,1);s.splice(r,0,i);let l=new Map(s.map((e,t)=>[e.student_id,t])),d=tC.slice().sort((e,t)=>{let a=l.get(e.student_id),r=l.get(t.student_id);return void 0===a||void 0===r?0:a-r});J.length>0?await td(d):await tm(d),$(null)}},className:"px-2 py-0.5 rounded-full text-[10px] border cursor-move ".concat(s?"bg-emerald-100 text-emerald-700 border-emerald-300":"bg-gray-100 text-gray-700 border-gray-300"),children:[a+1,". ",t.student_name]},"sr-".concat(e,"-").concat(t.student_id,"-").concat(a))})})})]},"sr-".concat(e))),(0,r.jsxs)("div",{className:"text-[10px] text-gray-500",children:["Start not set: ",tE," • End not set: ",tT]})]}),(0,r.jsxs)("div",{ref:F,className:"w-full overflow-hidden",style:{height:576*U},children:[(0,r.jsx)("div",{className:"mb-2 bg-white border border-gray-200 rounded p-2",children:(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[11px] font-semibold text-gray-700 mb-1",children:"Start On Stage (OS)"}),(0,r.jsx)("div",{className:"border border-dashed border-gray-300 rounded p-2 min-h-[52px]",onDragOver:e=>e.preventDefault(),onDrop:async()=>{if(!Y)return;let e=tC.map(e=>e.student_id===Y?{...e,start_side:"OS"}:e);J.length>0?await td(e):await tm(e),Q(null),$(null)},children:(0,r.jsx)("div",{className:"flex flex-wrap gap-2",children:tq(tC.filter(e=>"OS"===(e.start_side||"OS"))).map((e,t)=>{let a=tD.has(e.student_id);return(0,r.jsxs)("span",{draggable:!0,onDragStart:()=>{Q(e.student_id),$({student_id:e.student_id,field:"start_side",side:"OS"})},className:"px-2 py-0.5 rounded-full text-[10px] border cursor-move ".concat(a?"bg-emerald-100 text-emerald-700 border-emerald-300":"bg-gray-100 text-gray-700 border-gray-300"),children:[t+1,". ",e.student_name]},"os-start-".concat(e.student_id,"-").concat(t))})})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[11px] font-semibold text-gray-700 mb-1",children:"End On Stage (OS)"}),(0,r.jsx)("div",{className:"border border-dashed border-gray-300 rounded p-2 min-h-[52px]",onDragOver:e=>e.preventDefault(),onDrop:async()=>{if(!Y)return;let e=tC.map(e=>e.student_id===Y?{...e,end_side:"OS"}:e);J.length>0?await td(e):await tm(e),Q(null),$(null)},children:(0,r.jsx)("div",{className:"flex flex-wrap gap-2",children:tq(tC.filter(e=>"OS"===(e.end_side||"OS"))).map((e,t)=>{let a=tD.has(e.student_id);return(0,r.jsxs)("span",{draggable:!0,onDragStart:()=>{Q(e.student_id),$({student_id:e.student_id,field:"end_side",side:"OS"})},className:"px-2 py-0.5 rounded-full text-[10px] border cursor-move ".concat(a?"bg-emerald-100 text-emerald-700 border-emerald-300":"bg-gray-100 text-gray-700 border-gray-300"),children:[t+1,". ",e.student_name]},"os-end-".concat(e.student_id,"-").concat(t))})})})]})]})}),(0,r.jsxs)("div",{className:"border-2 border-gray-400 bg-gradient-to-b from-amber-100 to-amber-50 relative mx-auto",style:{width:768,height:576,backgroundImage:"\n                  linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),\n                  linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px)\n                ",backgroundSize:"".concat(64,"px ").concat(64,"px"),transform:"scale(".concat(U,")"),transformOrigin:"top left"},onDragOver:te,children:["bottom"===P&&(0,r.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-red-500"}),"top"===P&&(0,r.jsx)("div",{className:"absolute top-0 left-0 right-0 h-1 bg-red-500"}),(0,r.jsx)("div",{className:"absolute text-red-600 font-bold text-xs bg-white bg-opacity-80 px-2 py-1 rounded",style:{..."bottom"===P&&{bottom:5,left:"50%",transform:"translateX(-50%)"},..."top"===P&&{top:5,left:"50%",transform:"translateX(-50%)"}},children:"FRONT"}),z&&J.length>0&&0===tk.length&&(0,r.jsx)("div",{className:"absolute top-8 left-0 right-0 text-center text-2xl font-bold text-gray-500",children:(null==tb?void 0:tb.title)||"Subpart"}),Array.from({length:9}).map((e,t)=>Array.from({length:12}).map((e,a)=>(0,r.jsx)("div",{onDrop:e=>ti(e,a,t),onDragOver:te,className:"absolute cursor-cell hover:bg-blue-100 hover:bg-opacity-30 transition-colors",style:{left:64*a,top:64*t,width:64,height:64}},"".concat(a,"-").concat(t)))),tk.map((e,t)=>{let a,n,s=g(e.name,tk.map(e=>e.name)),i=tS[e.student_id];return(0,r.jsxs)("div",{draggable:!0,onDragStart:()=>e8(e.student_id,!0),className:"absolute flex items-center justify-center group cursor-move",style:{left:(a=e.x,("top"===P?11-a:a)*64),top:(n=e.y,("top"===P?8-n:n)*64),width:64,height:64},children:[(0,r.jsxs)("div",{className:"relative w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg group-hover:bg-blue-600 transition-colors",children:[s,i?(0,r.jsx)("div",{className:"absolute -top-2 -left-2 w-5 h-5 rounded-full bg-amber-500 text-[10px] font-bold text-white flex items-center justify-center shadow",children:i}):null,(0,r.jsx)("button",{onClick:()=>(e=>{let t=async e=>{try{z&&J.length>0?await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:z,positions:e.map(e=>({subpart_id:z,student_id:e.student_id,x:e.x,y:e.y}))})}):await h(e),R.current=!1,I(Date.now())}catch(e){D(e instanceof Error?e.message:"Failed to save positions"),R.current=!0}};if(z&&J.length>0){let a=(Z[z]||[]).filter(t=>t.student_id!==e);B(e=>({...e,[z]:a})),t(a)}else{let a=y.filter(t=>t.student_id!==e);v(a),t(a)}R.current=!0})(e.student_id),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600",title:"Remove from stage",children:"x"})]}),(0,r.jsx)("div",{className:"absolute bottom-full mb-1 whitespace-nowrap bg-gray-900 text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:e.name})]},e.id||"".concat(e.student_id,"-").concat(e.x,"-").concat(e.y,"-").concat(t))})]})]}),(0,r.jsx)("div",{className:"space-y-3 w-48",children:["start_side","end_side"].map(e=>(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded p-2",children:[(0,r.jsxs)("div",{className:"text-[11px] font-semibold text-gray-700 mb-1",children:["Stage Left ","start_side"===e?"Start":"End"]}),(0,r.jsx)("div",{className:"border border-dashed border-gray-300 rounded p-2 min-h-[64px]",onDragOver:e=>e.preventDefault(),onDrop:async()=>{if(!Y)return;let t=tC.map(t=>t.student_id===Y?{...t,[e]:"SL"}:t);J.length>0?await td(t):await tm(t),Q(null),$(null)},children:(0,r.jsx)("div",{className:"flex flex-wrap gap-2",children:tq(tC.filter(t=>"SL"===(t[e]||"OS"))).map((t,a)=>{let n=tD.has(t.student_id);return(0,r.jsxs)("span",{draggable:!0,onDragStart:()=>{Q(t.student_id),$({student_id:t.student_id,field:e,side:"SL"})},onDragOver:e=>e.preventDefault(),onDrop:async()=>{if(V&&V.field===e&&"SL"===V.side){let a=tq(tC.filter(t=>"SL"===(t[e]||"OS"))),r=a.map(e=>e.student_id),n=r.indexOf(V.student_id),s=r.indexOf(t.student_id);if(n<0||s<0||n===s)return;let i=[...a],[l]=i.splice(n,1);i.splice(s,0,l);let d=new Map(i.map((e,t)=>[e.student_id,t])),o=tC.slice().sort((e,t)=>{let a=d.get(e.student_id),r=d.get(t.student_id);return void 0===a||void 0===r?0:a-r});J.length>0?await td(o):await tm(o),$(null)}},className:"px-2 py-0.5 rounded-full text-[10px] border cursor-move ".concat(n?"bg-emerald-100 text-emerald-700 border-emerald-300":"bg-gray-100 text-gray-700 border-gray-300"),children:[a+1,". ",t.student_name]},"sl-".concat(e,"-").concat(t.student_id,"-").concat(a))})})})]},"sl-".concat(e)))}),e2.length>0&&tw&&(0,r.jsx)("button",{onClick:()=>{let e=e2.findIndex(e=>e.id===z);e>=0&&e<e2.length-1&&G(e2[e+1].id)},disabled:!z||e2.findIndex(e=>e.id===z)===e2.length-1,className:"px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 text-xs",children:"Next"})]}),t_&&z&&null,(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mb-3",children:[(0,r.jsx)("h4",{className:"font-semibold text-gray-900",children:"Equipment"}),(0,r.jsxs)("div",{className:"ml-auto flex items-center gap-2",children:[(0,r.jsx)("input",{value:ez,onChange:e=>eG(e.target.value),placeholder:"Add equipment",className:"px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("button",{onClick:tz,className:"px-2 py-1 bg-gray-900 text-white rounded text-xs",children:"Add"})]})]}),(0,r.jsx)("div",{className:"text-[11px] text-gray-500 mb-3",children:"Active equipment shows at the top. Start side follows the previous active end. Set an initial side for first use."}),eZ?(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"Loading equipment…"}):0===tJ.length?(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"No equipment yet."}):(0,r.jsx)("div",{className:"space-y-3 max-h-80 overflow-y-auto pr-1",children:tJ.map(e=>{let t=eX[e.equipment.id]||"",a=tM.get(t)||"",n=a&&a===e.equipment.name;return(0,r.jsxs)("div",{className:"border rounded-lg p-3 ".concat(e.isActive?"border-emerald-300 bg-emerald-50":"border-gray-200"),children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,r.jsx)("input",{value:e.equipment.name,onChange:t=>eR(a=>a.map(a=>a.id===e.equipment.id?{...a,name:t.target.value}:a)),onBlur:()=>tG(e.equipment.id,{name:e.equipment.name}),className:"px-2 py-1 border border-gray-300 rounded text-xs flex-1"}),(0,r.jsxs)("select",{value:t,onChange:t=>{let a=t.target.value;eH(t=>({...t,[e.equipment.id]:a})),e.isActive&&a&&tB(e.equipment.id,a)},className:"px-2 py-1 border border-gray-300 rounded text-xs",children:[(0,r.jsx)("option",{value:"",children:"Select performer"}),b.map(e=>(0,r.jsx)("option",{value:e.student_id,children:e.name},e.student_id))]}),(0,r.jsxs)("label",{className:"text-xs text-gray-700 flex items-center gap-1",children:[(0,r.jsx)("input",{type:"checkbox",checked:e.isActive,onChange:t=>tZ(e.equipment.id,t.target.checked),className:"h-3 w-3"}),"Active"]})]}),(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mt-2 text-[11px] text-gray-600",children:[(0,r.jsx)("span",{className:"font-semibold text-gray-700",children:"Start:"})," ",(0,r.jsx)("span",{children:e.startSide||"Unset"}),(0,r.jsx)("span",{className:"font-semibold text-gray-700",children:"End:"})," ",(0,r.jsx)("span",{children:e.endSide||"—"}),e.activeStudentName&&(0,r.jsxs)("span",{className:"ml-auto text-[10px] text-gray-500",children:["Using: ",e.activeStudentName]})]}),(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[(0,r.jsx)("span",{className:"text-[10px] text-gray-500",children:"Initial side:"}),["OS","SL","SR"].map(t=>(0,r.jsx)("button",{type:"button",onClick:()=>tG(e.equipment.id,{initial_side:t}),className:"px-2 py-0.5 rounded-full text-[10px] border ".concat((e.equipment.initial_side||"")===t?"bg-gray-900 text-white border-gray-900":"bg-white text-gray-700 border-gray-300"),children:t},"".concat(e.equipment.id,"-").concat(t))),t&&(0,r.jsx)("button",{type:"button",onClick:()=>tG(e.equipment.id,{name:a}),className:"text-[10px] px-2 py-0.5 rounded border border-gray-300 text-gray-600",children:"Use performer name"})]}),n&&(0,r.jsx)("div",{className:"text-[10px] text-amber-600 mt-1",children:"Equipment name matches performer. Consider renaming."})]},e.equipment.id)})})]}),(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,r.jsxs)("h4",{className:"font-medium text-gray-900 mb-3",children:["Positioned (",tk.length,")"]}),(0,r.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:tk.map((e,t)=>(0,r.jsxs)("div",{className:"bg-white p-2 rounded border border-green-200 text-sm",children:[(0,r.jsx)("p",{className:"font-medium text-gray-900",children:e.name}),(0,r.jsxs)("p",{className:"text-xs text-gray-600",children:["(",e.x,", ",e.y,")"]})]},e.id||"".concat(e.student_id,"-").concat(e.x,"-").concat(e.y,"-").concat(t)))})]})]})})]})]})}function f(e){let{performanceId:t,performanceTitle:a,currentMusicFile:s,onUploadSuccess:i}=e,[l,d]=(0,n.useState)(!1),[o,c]=(0,n.useState)(null),[u,m]=(0,n.useState)(!1),p=async e=>{var a;let r=null==(a=e.currentTarget.files)?void 0:a[0];if(r){d(!0),c(null),m(!1);try{let a=new FormData;a.append("file",r);let n=await fetch("/api/performances/".concat(t,"/upload-music"),{method:"POST",body:a});if(!n.ok){let e=await n.json();throw Error(e.error||"Upload failed")}let s=await n.json();m(!0),null==i||i(s.filePath,s.publicUrl),e.currentTarget.value=""}catch(e){c(e instanceof Error?e.message:"Upload failed")}finally{d(!1)}}};return(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,r.jsx)("h3",{className:"font-bold text-lg text-gray-900 mb-4",children:"Performance Music"}),s&&(0,r.jsx)("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded",children:(0,r.jsxs)("p",{className:"text-sm text-green-900",children:[(0,r.jsx)("span",{className:"font-semibold",children:"✓ Music Uploaded:"})," ",s]})}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("label",{className:"block",children:[(0,r.jsx)("div",{className:"flex items-center justify-center w-full p-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors bg-gray-50 hover:bg-blue-50",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("p",{className:"text-2xl mb-2",children:"\uD83C\uDFB5"}),(0,r.jsx)("p",{className:"text-sm font-semibold text-gray-700",children:l?"Uploading...":"Click to upload music"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"MP3, WAV, OGG (max 15MB)"})]})}),(0,r.jsx)("input",{type:"file",accept:"audio/*",onChange:p,disabled:l,className:"hidden"})]}),o&&(0,r.jsx)("div",{className:"p-3 bg-red-50 border border-red-200 rounded",children:(0,r.jsxs)("p",{className:"text-sm text-red-900",children:["❌ ",o]})}),u&&(0,r.jsx)("div",{className:"p-3 bg-green-50 border border-green-200 rounded",children:(0,r.jsx)("p",{className:"text-sm text-green-900",children:"✓ Music uploaded successfully!"})})]})]})}function y(e){let{musicUrl:t,onTimeUpdate:a,performanceTitle:s,audioRef:i,onAudioReady:l}=e,d=(0,n.useRef)(null),o=null!=i?i:d,[c,u]=(0,n.useState)(!1),[m,p]=(0,n.useState)(0),[x,h]=(0,n.useState)(0),[g,b]=(0,n.useState)(1);(0,n.useEffect)(()=>{let e=o.current;if(!e)return;let t=()=>{p(e.currentTime),null==a||a(e.currentTime)},r=()=>{h(e.duration)};return e.addEventListener("timeupdate",t),e.addEventListener("loadedmetadata",r),e.addEventListener("play",()=>u(!0)),e.addEventListener("pause",()=>u(!1)),e.addEventListener("ended",()=>u(!1)),null==l||l(e),()=>{e.removeEventListener("timeupdate",t),e.removeEventListener("loadedmetadata",r),e.removeEventListener("play",()=>u(!0)),e.removeEventListener("pause",()=>u(!1)),e.removeEventListener("ended",()=>u(!1)),null==l||l(null)}},[o,a,l]);let f=e=>{if(!e||isNaN(e))return"0:00";let t=Math.floor(e/60),a=Math.floor(e%60);return"".concat(t,":").concat(a.toString().padStart(2,"0"))};return(0,r.jsxs)("div",{className:"bg-gray-900 text-white rounded-lg p-6 shadow-xl",children:[(0,r.jsx)("audio",{ref:o,src:t}),(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("h3",{className:"font-bold text-lg mb-1",children:s?"Music for ".concat(s):"Music Player"}),!t&&(0,r.jsx)("p",{className:"text-sm text-gray-400",children:"No music uploaded yet"})]}),t&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,r.jsx)("button",{onClick:()=>{o.current&&(c?o.current.pause():o.current.play())},disabled:!t,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 rounded-lg font-semibold transition-colors",children:c?"⏸ Pause":"▶ Play"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-400",children:"\uD83D\uDD0A"}),(0,r.jsx)("input",{type:"range",min:"0",max:"1",step:"0.1",value:g,onChange:e=>{let t=parseFloat(e.target.value);b(t),o.current&&(o.current.volume=t)},className:"w-20 cursor-pointer"}),(0,r.jsxs)("span",{className:"text-xs text-gray-400 w-6",children:[Math.round(100*g),"%"]})]})]}),(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,r.jsx)("span",{className:"text-sm text-gray-300 w-12 text-right",children:f(m)}),(0,r.jsx)("input",{type:"range",min:"0",max:x||0,value:m,onChange:e=>{var t;return t=parseFloat(e.target.value),void(o.current&&(o.current.currentTime=t,p(t)))},className:"flex-1 cursor-pointer"}),(0,r.jsx)("span",{className:"text-sm text-gray-300 w-12",children:f(x)})]}),(0,r.jsx)("div",{className:"w-full bg-gray-700 rounded-full h-1",children:(0,r.jsx)("div",{className:"bg-blue-500 h-1 rounded-full transition-all",style:{width:"".concat(x?m/x*100:0,"%")}})})]})]}),!t&&(0,r.jsx)("div",{className:"text-center py-8 text-gray-400",children:(0,r.jsx)("p",{children:"Upload music in the performance settings to enable playback"})})]})}function v(e){if(!e)return"?";let t=e.trim().split(/\s+/);return 1===t.length?t[0].slice(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function j(e){let{performanceId:t,parts:a,musicUrl:s,onClose:i,onUpdatePartTimepoints:l}=e,[d,o]=(0,n.useState)(0),[c,u]=(0,n.useState)({}),[m,p]=(0,n.useState)(!1),[h,g]=(0,n.useState)(!0),[b,f]=(0,n.useState)({}),[y,j]=(0,n.useState)({}),[N,w]=(0,n.useState)({}),[_,S]=(0,n.useState)({}),[k,C]=(0,n.useState)({}),[E,T]=(0,n.useState)({}),[D,P]=(0,n.useState)(""),[O,M]=(0,n.useState)({}),[I,F]=(0,n.useState)({}),[U,A]=(0,n.useState)({}),[L,R]=(0,n.useState)(null),[J,q]=(0,n.useState)(null),[z,G]=(0,n.useState)(null),[Z,B]=(0,n.useState)(""),[X,H]=(0,n.useState)(""),[W,K]=(0,n.useState)("bottom"),[Y,Q]=(0,n.useState)(null),[V,$]=(0,n.useState)(null),[ee,et]=(0,n.useState)(null),[ea,er]=(0,n.useState)(""),[en,es]=(0,n.useState)(""),[ei,el]=(0,n.useState)(""),[ed,eo]=(0,n.useState)(""),[ec,eu]=(0,n.useState)(null),[em,ep]=(0,n.useState)({}),[ex,eh]=(0,n.useState)(new Set),[eg,eb]=(0,n.useState)(!1),[ef,ey]=(0,n.useState)(0),[ev,ej]=(0,n.useState)(1),[eN,ew]=(0,n.useState)(!1),[e_,eS]=(0,n.useState)(null),[ek,eC]=(0,n.useState)(null),[eE,eT]=(0,n.useState)(!1),[eD,eP]=(0,n.useState)(null),[eO,eM]=(0,n.useState)(!1),eI=(0,n.useRef)(null),eF=(0,n.useRef)(null),eU=(0,n.useRef)(null),eA=(0,n.useRef)(null),[eL,eR]=(0,n.useState)(1),[eJ,eq]=(0,n.useState)(1),ez=(0,n.useRef)(null),eG=(0,n.useRef)(null),eZ=(0,n.useMemo)(()=>a.map(e=>{let t=em[e.id];return t?{...e,timepoint_seconds:t.start,timepoint_end_seconds:t.end}:e}),[a,em]),eB=(0,n.useMemo)(()=>[...eZ].sort((e,t)=>{let a="number"==typeof e.timepoint_seconds?e.timepoint_seconds:1/0,r="number"==typeof t.timepoint_seconds?t.timepoint_seconds:1/0;return a===r?(e.order||0)-(t.order||0):a-r}),[eZ]),eX=(0,n.useMemo)(()=>eB.filter(e=>"number"==typeof e.timepoint_seconds),[eB]),eH=(0,n.useMemo)(()=>{let e=[],t=[...eB].filter(e=>"number"==typeof e.timepoint_seconds).sort((e,t)=>(e.timepoint_seconds||0)-(t.timepoint_seconds||0));for(let a=0;a<t.length;a++){let r=t[a],n=r.timepoint_seconds||0,s=a<t.length-1?t[a+1].timepoint_seconds||n:null,i="number"==typeof r.timepoint_end_seconds?r.timepoint_end_seconds:null!==s?s:n+1;e.push({id:r.id,name:r.name,start:n,end:Math.max(i,n+.1),subparts:b[r.id]||[]})}return e},[eB,b]),eW=(0,n.useMemo)(()=>{let e=new Map;return eH.forEach(t=>{e.set(t.id,{start:t.start,end:t.end})}),e},[eH]),eK=(0,n.useMemo)(()=>Math.max(ef||0,eH.reduce((e,t)=>Math.max(e,t.end),0),1),[eH,ef]),eY=(0,n.useMemo)(()=>{if(0===eX.length)return -1;let e=0;for(let t=0;t<eX.length;t++){let a=eX[t].timepoint_seconds||0,r=eX[t].timepoint_end_seconds;d>=a&&(null==r||d<r)?e=t:d>=a&&(e=t)}return e},[eX,d]),eQ=eY>=0?eX[eY]:null,eV=eY>=0?eX[eY+1]:null,e$=eV?Math.max(0,(eV.timepoint_seconds||0)-d):null,e0=e=>{if(null==e||Number.isNaN(e))return"--:--";let t=Math.max(0,Math.floor(e)),a=Math.floor(t/60);return"".concat(a,":").concat((t%60).toString().padStart(2,"0"))},e1=(e,t)=>{if("number"!=typeof e||"number"!=typeof t||!Number.isFinite(e)||!Number.isFinite(t))return"";let a=Math.max(0,t-e),r=Math.floor(a/60),n=Math.round(a%60);return"".concat(r,"m ").concat(n,"s")},e2=e=>{if(null==e||Number.isNaN(e))return{min:"",sec:""};let t=Math.max(0,Math.floor(e));return{min:String(Math.floor(t/60)),sec:String(t%60)}},e3=(e,t)=>{if(!e&&!t)return null;let a=e?parseInt(e,10):0,r=t?parseFloat(t):0;return Number.isNaN(a)||Number.isNaN(r)?null:60*a+r},e6=function(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(!eF.current)return;let a=Math.max(0,e);eF.current.currentTime=a,o(a),t&&eF.current.play()},e5=()=>{eF.current&&(eg?eF.current.pause():eF.current.play())},e4=e=>{let t=eW.get(e);t&&eC(t)},e7=(0,n.useMemo)(()=>{let e=new Set;return Object.values(c).forEach(t=>{t.forEach(t=>e.add(t.student_name||"Unknown"))}),Object.values(y).forEach(t=>{t.forEach(t=>e.add(t.student_name||"Unknown"))}),Array.from(e).sort((e,t)=>e.localeCompare(t))},[c,y]),e9=(0,n.useMemo)(()=>D?eB.filter(e=>!!(c[e.id]||[]).map(e=>e.student_name).includes(D)||(b[e.id]||[]).some(e=>(y[e.id]||[]).some(e=>e.student_name===D))):eB,[eB,D,c,b,y]),e8=()=>{try{let e=window.AudioContext||window.webkitAudioContext;if(!e)return;let t=new e,a=t.createGain();a.gain.value=.3,a.connect(t.destination);let r=t.createOscillator();r.type="sine",r.frequency.value=880,r.connect(a);let n=t.currentTime;r.start(n),r.stop(n+.15),setTimeout(()=>t.close(),300)}catch(e){}},te=(e,t)=>{if(!eF.current)return;q(e),G(t),R(3),e8();let a=3,r=setInterval(()=>{if((a-=1)<=0){clearInterval(r),R(null),q(null),G(null),eF.current.currentTime=e,eF.current.play();return}R(a),e8()},1e3)};(0,n.useEffect)(()=>{let e=eF.current;if(!e)return;let t=()=>{o(e.currentTime)},a=()=>{ey(e.duration||0)},r=()=>eb(!0),n=()=>eb(!1);return e.addEventListener("timeupdate",t),e.addEventListener("loadedmetadata",a),e.addEventListener("play",r),e.addEventListener("pause",n),e.addEventListener("ended",n),()=>{e.removeEventListener("timeupdate",t),e.removeEventListener("loadedmetadata",a),e.removeEventListener("play",r),e.removeEventListener("pause",n),e.removeEventListener("ended",n)}},[]),(0,n.useEffect)(()=>{eF.current&&(eF.current.volume=ev)},[ev]),(0,n.useEffect)(()=>{let e=eU.current;if(!e)return;let t=()=>{let t=e.clientWidth;t&&eR(Math.min(1,t/408))};t();let a=new ResizeObserver(t);return a.observe(e),()=>a.disconnect()},[]),(0,n.useEffect)(()=>{let e=eA.current;if(!e)return;let t=()=>{let t=e.clientWidth;t&&eq(Math.min(1,t/960))};t();let a=new ResizeObserver(t);return a.observe(e),()=>a.disconnect()},[]),(0,n.useEffect)(()=>{eN&&e_&&eF.current&&d>=e_.end&&(eF.current.currentTime=e_.start,eF.current.paused||eF.current.play())},[d,eN,e_]),(0,n.useEffect)(()=>{if(!h||null===e$){ez.current=e$;return}let e=ez.current;(null===e||e>10)&&e$<=10&&(()=>{try{let e=window.AudioContext||window.webkitAudioContext;if(!e)return;let t=new e,a=t.createGain();a.gain.value=.35,a.connect(t.destination);let r=e=>{let r=t.createOscillator();r.type="sine",r.frequency.value=880,r.connect(a),r.start(e),r.stop(e+.18)},n=t.currentTime;r(n),r(n+.35),r(n+.7),setTimeout(()=>t.close(),1200)}catch(e){}})(),ez.current=e$},[e$,h]),(0,n.useEffect)(()=>{(async()=>{p(!0);try{let e=await Promise.all(a.map(async e=>{let t=await fetch("/api/stage-positions?partId=".concat(e.id));if(!t.ok)return[e.id,[]];let a=(await t.json()||[]).map(e=>({student_id:e.student_id,student_name:e.student_name||"Unknown",x:e.x,y:e.y}));return[e.id,a]})),t={};e.forEach(e=>{let[a,r]=e;t[a]=r}),u(t);let r=await Promise.all(a.map(async e=>{let t=await fetch("/api/subparts?partId=".concat(e.id));if(!t.ok)return[e.id,[]];let a=(await t.json()||[]).map(e=>{var t,a,r;return{id:e.id,part_id:e.part_id,title:e.title,description:null!=(t=e.description)?t:null,timepoint_seconds:null!=(a=e.timepoint_seconds)?a:null,timepoint_end_seconds:null!=(r=e.timepoint_end_seconds)?r:null}});return[e.id,a]})),n={};r.forEach(e=>{let[t,a]=e;n[t]=a}),f(n);let s=await Promise.all(a.map(async e=>{let t=await fetch("/api/part-sides?partId=".concat(e.id));if(!t.ok)return[e.id,[]];let a=(await t.json()||[]).map(e=>{var t,a;return{student_id:e.student_id,student_name:e.student_name||"Unknown",start_side:null!=(t=e.start_side)?t:null,end_side:null!=(a=e.end_side)?a:null}});return[e.id,a]})),i={};s.forEach(e=>{let[t,a]=e;i[t]=a}),w(i);let l=r.flatMap(e=>{let[,t]=e;return t.map(e=>e.id)}),d=await Promise.all(l.map(async e=>{let t=await fetch("/api/subpart-order?subpartId=".concat(e));if(!t.ok)return[e,[]];let a=(await t.json()||[]).map(e=>{var t,a;return{student_id:e.student_id,student_name:e.student_name||"Unknown",start_side:null!=(t=e.start_side)?t:null,end_side:null!=(a=e.end_side)?a:null}});return[e,a]})),o={};d.forEach(e=>{let[t,a]=e;o[t]=a}),j(o);let c=await Promise.all(l.map(async e=>{let t=await fetch("/api/subpart-positions?subpartId=".concat(e));if(!t.ok)return[e,!1];let a=await t.json();return[e,Array.isArray(a)&&a.length>0]})),m={};c.forEach(e=>{let[t,a]=e;m[t]=a}),S(m)}finally{p(!1)}})()},[a,t]);let tt=(0,n.useCallback)(async e=>{try{let t=await fetch("/api/subparts?partId=".concat(e));if(!t.ok)return;let a=(await t.json()||[]).map(e=>{var t,a,r;return{id:e.id,part_id:e.part_id,title:e.title,description:null!=(t=e.description)?t:null,timepoint_seconds:null!=(a=e.timepoint_seconds)?a:null,timepoint_end_seconds:null!=(r=e.timepoint_end_seconds)?r:null}});f(t=>({...t,[e]:a}))}catch(e){}},[]);(0,n.useEffect)(()=>{let e=e=>{let t=e.detail;(null==t?void 0:t.partId)&&tt(t.partId)};return window.addEventListener("subparts-updated",e),()=>window.removeEventListener("subparts-updated",e)},[tt]),(0,n.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/performances/".concat(t));if(!e.ok)return;let a=await e.json();B((null==a?void 0:a.call_time)||""),H((null==a?void 0:a.title)||""),(null==a?void 0:a.stage_orientation)&&K("top"===a.stage_orientation?"top":"bottom")}catch(e){}})()},[t]);let ta=(0,n.useCallback)((e,t)=>t?"subpart:".concat(t):"part:".concat(e),[]),tr=(0,n.useCallback)(async(e,a)=>{var r,n,s;let i=ta(e,a),l=(null!=(n=null!=(r=I[i])?r:O[i])?n:"").trim();if(l!==(null!=(s=O[i])?s:"").trim()){A(e=>({...e,[i]:!0}));try{if(!(await fetch("/api/rehearse-notes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:t,part_id:e,subpart_id:null!=a?a:null,note:l})})).ok)throw Error("Failed to save note");l?M(e=>({...e,[i]:l})):M(e=>{let t={...e};return delete t[i],t})}catch(e){console.error(e),alert("Failed to save note")}finally{A(e=>({...e,[i]:!1}))}}},[ta,O,I,t]);(0,n.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/rehearse-notes?performanceId=".concat(t));if(!e.ok)return;let a=await e.json(),r={};(a||[]).forEach(e=>{r[ta(e.part_id,e.subpart_id)]=e.note||""}),M(r)}catch(e){}})()},[t,ta]);let tn=e=>{if(!e)return null;let t=b[e.id]||[];if(0===t.length)return null;let a=t.map(e=>{let t=y[e.id]||[],a=_[e.id]||!1;return 0===t.length||a?null:{title:e.title,entries:t,description:e.description||null}}).filter(Boolean);return 0===a.length?null:(0,r.jsxs)("div",{className:"bg-white border border-indigo-200 rounded-lg p-5 shadow-sm min-h-[220px]",children:[(0,r.jsx)("div",{className:"text-sm uppercase tracking-wide text-indigo-600 font-semibold mb-2",children:"Subpart Assignments"}),(0,r.jsx)("div",{className:"space-y-3 text-base text-gray-700",children:a.map(e=>(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-semibold text-gray-900",children:e.title}),e.description&&(0,r.jsx)("div",{className:"text-sm text-gray-500",children:e.description}),(0,r.jsx)("div",{className:"text-gray-600",children:e.entries.map(e=>{let t=e.start_side||"OS",a=e.end_side||t,r=t===a?t:"".concat(t,"→").concat(a);return"".concat(e.student_name," (").concat(r,")")}).join(", ")})]},e.title))})]})},ts=e=>{if(!e||0===e.length)return(0,r.jsx)("div",{className:"text-[10px] text-gray-500",children:"No positions"});let t=e.map(e=>e.x),a=e.map(e=>e.y),n=Math.max(0,Math.min(...t)-1),s=Math.max(0,Math.min(...a)-1),i=Math.max(1,Math.min(11,Math.max(...t)+1)-n+1),l=Math.max(1,Math.min(7,Math.max(...a)+1)-s+1);return(0,r.jsx)("div",{className:"mt-2 border border-gray-200 bg-gray-50 p-2 rounded",children:(0,r.jsx)("div",{className:"relative",style:{width:18*i,height:18*l,backgroundImage:"\n              linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),\n              linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px)\n            ",backgroundSize:"".concat(18,"px ").concat(18,"px")},children:e.map(e=>(0,r.jsx)("div",{className:"absolute flex items-center justify-center",style:{left:(e.x-n)*18,top:(e.y-s)*18,width:18,height:18},children:(0,r.jsx)("div",{className:"bg-blue-600 text-white text-[9px] font-bold rounded-full w-4 h-4 flex items-center justify-center",children:v(e.student_name)})},"".concat(e.student_id,"-").concat(e.x,"-").concat(e.y)))})})},ti=(e,t,a,n)=>{let s=t&&c[t.id]||[],i=a?"text-5xl":"text-4xl",l=a?"text-base":"text-sm",d=a?"border-purple-700 bg-purple-100":"border-blue-700 bg-blue-100",o=a?"from-purple-200 to-purple-300":"from-blue-200 to-blue-300",u=Math.max(18,Math.round(.7*n)),m=n>=70?"text-base":"text-[10px]",p=12*n,x=8*n,h=a?eJ:eL,g=a?eA:eU,f=t&&b[t.id]||[],y=f.filter(e=>"number"==typeof e.timepoint_seconds).sort((e,t)=>(e.timepoint_seconds||0)-(t.timepoint_seconds||0)),j=t&&V?f.find(e=>e.id===V):null,N=a&&y[0]||null,w=j?y.findIndex(e=>e.id===j.id):-1,_=w>=0?y[w+1]||null:y[0]||null,S=e=>e.slice(0,7);return(0,r.jsxs)("div",{className:"rounded-lg border p-4 shadow-sm ".concat(d),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"".concat(l," uppercase tracking-wide text-gray-600"),children:e}),(0,r.jsx)("div",{className:"".concat(i," font-semibold text-gray-900"),children:t?t.name:"—"})]}),a&&null!==e$&&e$<=10&&(0,r.jsx)("div",{className:"text-7xl font-extrabold text-red-600 animate-pulse",children:Math.ceil(e$)})]}),a&&null!==e$&&e$<=10&&(0,r.jsx)("div",{className:"mb-2 text-3xl font-extrabold text-red-600 animate-pulse",children:"GET READY"}),(0,r.jsx)("div",{ref:g,className:"w-full overflow-hidden",style:{height:x*h},children:(0,r.jsxs)("div",{className:"border border-gray-300 bg-gradient-to-b ".concat(o," relative mx-auto"),style:{width:p,height:x,backgroundImage:"\n                linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),\n                linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px)\n              ",backgroundSize:"".concat(n,"px ").concat(n,"px"),transform:"scale(".concat(h,")"),transformOrigin:"top left"},children:["bottom"===W&&(0,r.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-red-500"}),"top"===W&&(0,r.jsx)("div",{className:"absolute top-0 left-0 right-0 h-1 bg-red-500"}),(0,r.jsx)("div",{className:"absolute text-red-600 font-bold text-xs bg-white bg-opacity-80 px-2 py-1 rounded",style:{..."bottom"===W&&{bottom:5,left:"50%",transform:"translateX(-50%)"},..."top"===W&&{top:5,left:"50%",transform:"translateX(-50%)"}},children:"FRONT"}),!a&&j&&(0,r.jsx)("div",{className:"absolute left-2 top-2 px-2 py-1 bg-white/80 text-amber-700 font-extrabold text-xl rounded shadow",children:S(j.title||"")}),Array.from({length:8}).map((e,t)=>Array.from({length:12}).map((e,a)=>(0,r.jsx)("div",{className:"absolute",style:{left:a*n,top:t*n,width:n,height:n}},"".concat(a,"-").concat(t)))),s.map(e=>(0,r.jsx)("div",{className:"absolute flex items-center justify-center",style:{left:e.x*n,top:e.y*n,width:n,height:n},children:(0,r.jsx)("div",{className:"bg-blue-600 text-white ".concat(m," font-bold rounded-full flex items-center justify-center shadow-md"),style:{width:u,height:u},children:v(e.student_name)})},"".concat(e.student_id,"-").concat(e.x,"-").concat(e.y)))]})}),a&&N&&(0,r.jsx)("div",{className:"mt-2 text-2xl font-extrabold text-purple-700",children:S(N.title||"")}),!a&&_&&(0,r.jsxs)("div",{className:"mt-2 text-xl font-extrabold text-blue-700",children:["Next up: ",S(_.title||"")]})]})},tl=(e,t)=>{let a=Array.from(new Map((e&&c[e.id]||[]).map(e=>[e.student_id,e.student_name||"Unknown"])).values()),n=e&&b[e.id]||[],s=e&&N[e.id]||[],i=e?e1(e.timepoint_seconds,e.timepoint_end_seconds):"";return(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 shadow-sm min-h-[72px]",children:[(0,r.jsx)("div",{className:"".concat(t?"text-sm":"text-xs"," uppercase tracking-wide text-gray-500 mb-2"),children:"INFO"}),(0,r.jsxs)("div",{className:"space-y-3",children:[i&&(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:["Duration: ",(0,r.jsx)("span",{className:"font-semibold text-gray-900",children:i})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-xs font-semibold text-gray-600 mb-2",children:"People"}),0===a.length?(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"No positions"}):(0,r.jsx)("div",{className:"flex flex-wrap gap-2 ".concat(t?"text-2xl":"text-base"," text-gray-800"),children:a.map(t=>(0,r.jsx)("span",{className:"px-2 py-1 bg-gray-100 rounded",children:t},"".concat((null==e?void 0:e.id)||"none","-").concat(t)))})]}),n.length>0&&(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-xs font-semibold text-gray-600 mb-2",children:"Subparts"}),(0,r.jsx)("div",{className:"space-y-2 text-sm text-gray-700",children:n.map((e,t)=>{let a=y[e.id]||[],n=e1(e.timepoint_seconds,e.timepoint_end_seconds);return(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"font-semibold text-gray-900",children:[t+1,". ",e.title]}),n&&(0,r.jsxs)("div",{className:"text-xs text-gray-500",children:["Duration: ",n]}),(0,r.jsx)("div",{className:"text-gray-600",children:0===a.length?(0,r.jsx)("span",{children:"Assigned: —"}):(0,r.jsxs)("span",{children:["Assigned:"," ",a.map((t,a)=>{let n=t.start_side||"OS",s=t.end_side||n,i=n===s?n:"".concat(n,"→").concat(s);return(0,r.jsxs)("span",{children:[a>0?", ":"",a+1,". ",t.student_name," ",(0,r.jsxs)("span",{className:"font-semibold",children:["(",i,")"]})]},"".concat(e.id,"-info-").concat(a))})]})})]},e.id)})})]}),0===n.length&&s.length>0&&(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-xs font-semibold text-gray-600 mb-2",children:"Sides"}),(0,r.jsx)("div",{className:"text-sm text-gray-700 flex flex-wrap gap-2",children:s.map(e=>{let t=e.start_side||"OS",a=e.end_side||t,n=t===a?t:"".concat(t,"→").concat(a);return(0,r.jsxs)("span",{className:"px-2 py-1 bg-gray-100 rounded",children:[e.student_name," ",(0,r.jsxs)("span",{className:"font-semibold",children:["(",n,")"]})]},"side-".concat(e.student_id))})})]})]})]})},td=e=>{let t=eI.current;if(!t)return 0;let a=t.getBoundingClientRect();return Math.min(1,Math.max(0,(e-a.left)/a.width))*eK},to=e=>{let t=td(e.clientX);eM(!0),e6(t,!1)},tc=e=>{eO&&e6(td(e.clientX),!1)},tu=e=>{eO&&(e6(td(e.clientX),!0),eM(!1))};return(0,n.useEffect)(()=>{if(!eQ)return;let e=b[eQ.id]||[];if(0===e.length)return;let t=e.map(e=>{let t="number"==typeof e.timepoint_seconds?e.timepoint_seconds:Number(e.timepoint_seconds),a="number"==typeof e.timepoint_end_seconds?e.timepoint_end_seconds:Number(e.timepoint_end_seconds),r=Number.isFinite(t)?t:NaN,n=Number.isFinite(a)?a:NaN;return Number.isFinite(r)?{id:e.id,start:r,end:Number.isFinite(n)?n:r}:null}).filter(Boolean);if(0===t.length)return;let a=t.find(e=>d>=e.start&&d<=e.end);$(a?a.id:null);let r=t.find(e=>d>=e.start&&d<e.start+.35);r&&eG.current!==r.id&&(eG.current=r.id,Q(r.id),setTimeout(()=>{Q(e=>e===r.id?null:e)},350))},[d,eQ,b]),(0,r.jsx)("div",{className:"fixed inset-0 z-50 bg-black bg-opacity-70 flex",children:(0,r.jsx)("div",{className:"flex-1 bg-gray-100 overflow-auto",children:(0,r.jsxs)("div",{className:"w-full h-full p-6",children:[(0,r.jsx)("audio",{ref:eF,src:s||void 0}),(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-1",children:[(0,r.jsx)(x.v,{className:"border border-gray-200 bg-white text-gray-400",size:32}),(0,r.jsx)("div",{className:"text-sm uppercase tracking-wide text-gray-500",children:"Rehearse Mode"})]}),(0,r.jsx)("div",{className:"text-3xl font-bold text-gray-900",children:"Live Stage View"}),X&&(0,r.jsxs)("div",{className:"text-sm text-gray-600 mt-1",children:["Performance: ",(0,r.jsx)("span",{className:"font-semibold text-gray-900",children:X})]})]}),(0,r.jsx)("div",{className:"flex items-center gap-4",children:(0,r.jsx)("button",{onClick:i,className:"px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-800",children:"Close"})})]}),(()=>{if(0===eH.length)return null;let e=100*Math.min(1,Math.max(0,d/eK)),t=e_?Math.min(e_.start,e_.end):null,a=e_?Math.max(e_.start,e_.end):null,n=["bg-blue-600","bg-emerald-600","bg-amber-600","bg-purple-600","bg-rose-600","bg-teal-600"],i=["bg-blue-200 text-blue-900","bg-emerald-200 text-emerald-900","bg-amber-200 text-amber-900","bg-purple-200 text-purple-900","bg-rose-200 text-rose-900","bg-teal-200 text-teal-900"],l=new Map(eH.map((e,t)=>[e.id,t])),o=eH.flatMap(e=>{var t;let a=b[e.id]||[],r=null!=(t=l.get(e.id))?t:0;return a.map(t=>{let a="number"==typeof t.timepoint_seconds?t.timepoint_seconds:Number(t.timepoint_seconds);if(!Number.isFinite(a))return null;let n=Math.min(Math.max(a,e.start),e.end-.1),s="number"==typeof t.timepoint_end_seconds?t.timepoint_end_seconds:Number(t.timepoint_end_seconds),i=Math.min(Math.max(Number.isFinite(s)?s:n+.1,n+.1),e.end);return i<=n?null:{id:t.id,partId:e.id,title:t.title,start:n,end:i,colorIdx:r}}).filter(Boolean)}).filter(Boolean);return(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4 shadow-sm mb-6",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-3 mb-3",children:[(0,r.jsx)("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Performance Timeline"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:e5,disabled:!s,className:"px-3 py-1 bg-gray-900 text-white rounded text-xs disabled:bg-gray-400",children:eg?"Pause":"Play"}),(0,r.jsxs)("div",{className:"text-xs text-gray-600",children:[e0(d)," / ",e0(eK)]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-xs text-gray-600",children:["Volume",(0,r.jsx)("input",{type:"range",min:"0",max:"1",step:"0.05",value:ev,onChange:e=>ej(parseFloat(e.target.value)),className:"w-20"})]}),(0,r.jsx)("button",{onClick:()=>{eE&&ek?(eS(ek),ew(!0),eT(!1)):(eT(!0),eC(null))},className:"px-3 py-1 rounded text-xs ".concat(eN||eE?"bg-emerald-600 text-white":"bg-gray-200 text-gray-700"),children:eE?ek?"Confirm Loop":"Select Part":eN?"Loop On":"Set Loop"}),eN&&(0,r.jsx)("button",{onClick:()=>{ew(!1),eS(null),eC(null),eT(!1)},className:"px-3 py-1 rounded text-xs bg-gray-200 text-gray-700",children:"Clear Loop"})]})]}),(0,r.jsxs)("div",{ref:eI,className:"relative h-24 rounded bg-slate-50 border border-slate-200 overflow-hidden cursor-pointer",onMouseDown:to,onMouseMove:tc,onMouseUp:tu,onMouseLeave:tu,children:[null!==t&&null!==a&&(0,r.jsx)("div",{className:"absolute top-0 h-full bg-emerald-200/70",style:{left:"".concat(t/eK*100,"%"),width:"".concat((a-t)/eK*100,"%")}}),(0,r.jsx)("div",{className:"absolute top-0 left-0 right-0 h-14",children:eH.map((e,t)=>{let a=e.start/eK*100,s=Math.max(1,(e.end-e.start)/eK*100),i=(null==eQ?void 0:eQ.id)===e.id;return(0,r.jsx)("button",{type:"button",onClick:()=>{eE?eC({start:e.start,end:e.end}):e6(e.start,!0)},className:"absolute top-0 h-full text-base font-semibold px-2 py-1 text-center truncate ".concat(i?"bg-blue-700 text-white":"".concat(n[t%n.length]," text-white")," ").concat(eE&&(null==ek?void 0:ek.start)===e.start?"ring-2 ring-emerald-300":""),style:{left:"".concat(a,"%"),width:"".concat(s,"%")},title:e.name,children:e.name},e.id)})}),(0,r.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-10 border-t border-slate-200 bg-slate-100/80",children:o.map((e,t)=>{let a=e.start/eK*100,n=Math.max(1,(e.end-e.start)/eK*100);return(0,r.jsx)("button",{type:"button",onClick:()=>e6(e.start,!0),className:"absolute top-0 h-full text-xs font-semibold px-2 py-1 text-center truncate ".concat(t%2==0?"border-l border-slate-300":"border-l border-white/60"," ").concat(i[e.colorIdx%i.length]),style:{left:"".concat(a,"%"),width:"".concat(n,"%")},title:e.title,children:e.title},e.id)})}),(0,r.jsx)("div",{className:"absolute top-0 h-full w-[3px] bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.7)]",style:{left:"".concat(e,"%")}})]}),eQ&&(b[eQ.id]||[]).length>0&&(0,r.jsx)("div",{className:"mt-3 flex flex-wrap gap-2",children:(b[eQ.id]||[]).map((e,t)=>{let a="number"==typeof e.timepoint_seconds?e.timepoint_seconds:null;return(0,r.jsxs)("button",{type:"button",onClick:()=>{null!==a&&e6(a,!0)},className:"px-3 py-1 rounded-full text-xs font-semibold bg-white border border-gray-200 hover:bg-gray-50",children:[t+1,". ",e.title]},e.id)})})]})})(),(0,r.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-[360px_1fr] gap-6",children:[(0,r.jsxs)("div",{className:"bg-white rounded-lg border border-gray-200 p-4 shadow-sm",children:[(0,r.jsx)("div",{className:"flex items-center justify-between mb-2",children:(0,r.jsx)("div",{className:"text-2xl font-semibold text-gray-900",children:"Parts"})}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-3",children:"Click a part name to play from its start time."}),(0,r.jsx)("div",{className:"space-y-5",children:e9.map((e,t)=>{var a,n;let s=(null==eQ?void 0:eQ.id)===e.id,i=(null==eV?void 0:eV.id)===e.id,d=ee===e.id,o="number"==typeof e.timepoint_seconds?e.timepoint_seconds:null,u=e1(o,"number"==typeof e.timepoint_end_seconds?e.timepoint_end_seconds:null),m=b[e.id]||[],p=ex.has(e.id);return(0,r.jsxs)("div",{className:"border rounded p-2 cursor-pointer transition-colors ".concat(s?"border-blue-500 bg-blue-50":"border-gray-200 bg-white"),onClick:()=>{eE&&e4(e.id)},onDoubleClick:()=>{null!==o&&e6(o,!0)},children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("button",{type:"button",onClick:()=>{if(eE)return void e4(e.id);null!==o&&e6(o,!0)},className:"font-semibold text-gray-900 text-xl text-left",children:e.name}),i&&(0,r.jsx)("span",{className:"text-base font-bold text-purple-700 bg-purple-100 px-2 py-0.5 rounded",children:"NEXT"})]}),(0,r.jsxs)("div",{className:"text-base text-gray-500",children:[null!==o?e0(o):"No timepoint",u&&(0,r.jsxs)("span",{className:"ml-2 text-sm text-gray-400",children:["(",u,")"]})]}),(0,r.jsxs)("div",{className:"mt-2 flex items-center gap-2",children:[null!==o&&(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),te(o,e.id)},className:"px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700",children:"Jump to part"}),(0,r.jsx)("button",{onClick:()=>{eh(t=>{let a=new Set(t);return a.has(e.id)?a.delete(e.id):a.add(e.id),a})},className:"px-3 py-1 text-xs rounded bg-gray-200 text-gray-700 hover:bg-gray-300",children:p?"Hide Details":"Expand Details"})]}),!p&&m.length>0&&(0,r.jsx)("div",{className:"mt-2 flex flex-wrap gap-2",children:m.map((e,t)=>{let a="number"==typeof e.timepoint_seconds?e.timepoint_seconds:null;return(0,r.jsxs)("button",{type:"button",onClick:()=>{null!==a&&e6(a,!0)},className:"px-2 py-0.5 rounded-full text-[11px] font-semibold bg-gray-100 text-gray-700",children:[t+1,". ",e.title]},e.id)})}),p&&(0,r.jsxs)(r.Fragment,{children:[d?(0,r.jsxs)("div",{className:"mt-2 space-y-2",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[11px] font-semibold text-gray-600",children:"Start (m / s)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:ea,onChange:e=>er(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:en,onChange:e=>es(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[11px] font-semibold text-gray-600",children:"End (m / s)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:ei,onChange:e=>el(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:ed,onChange:e=>eo(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]})]})]}),eD&&(0,r.jsx)("div",{className:"text-[11px] text-red-600",children:eD}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:async t=>{t.stopPropagation();let a=e3(ea,en),r=e3(ei,ed),n=(e=>{let t=b[e]||[],a=[],r=[];return t.forEach(e=>{"number"==typeof e.timepoint_seconds&&a.push(e.timepoint_seconds),"number"==typeof e.timepoint_end_seconds&&r.push(e.timepoint_end_seconds)}),{minStart:a.length>0?Math.min(...a):null,maxEnd:r.length>0?Math.max(...r):null}})(e.id);if(null!==n.minStart&&(null===a||a>n.minStart)&&(a=n.minStart),null!==n.maxEnd&&(null===r||r<n.maxEnd)&&(r=n.maxEnd),ef>0&&(null!==a&&a>ef||null!==r&&r>ef))return void eP("Time exceeds music length. Use a time within the track.");if(null!==a&&null!==r&&r<a)return void eP("End time must be after start time.");eP(null),eu(e.id);try{let t=await fetch("/api/parts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({timepoint_seconds:a,timepoint_end_seconds:r})});if(!t.ok){let e=await t.json().catch(()=>null);throw Error((null==e?void 0:e.details)||(null==e?void 0:e.error)||"Failed to update timepoints")}let n=await t.json();ep(t=>({...t,[e.id]:{start:a,end:r}})),null==l||l(n),et(null)}catch(e){console.error("Failed to update timepoints:",e),alert("Failed to update timepoints")}finally{eu(null)}},className:"px-2 py-1 bg-emerald-600 text-white rounded text-xs hover:bg-emerald-700 disabled:opacity-50",disabled:ec===e.id,children:ec===e.id?"Saving...":"Save"}),(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),et(null)},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs hover:bg-gray-400",children:"Cancel"})]})]}):(0,r.jsx)("div",{className:"mt-1",children:(0,r.jsx)("button",{onClick:t=>{t.stopPropagation();let a="number"==typeof e.timepoint_seconds?e.timepoint_seconds:null,r="number"==typeof e.timepoint_end_seconds?e.timepoint_end_seconds:null,n=e2(a),s=e2(r);er(n.min),es(n.sec),el(s.min),eo(s.sec),et(e.id),eP(null)},className:"text-[11px] text-indigo-600 hover:text-indigo-800 underline",children:"Edit start/end"})}),i&&null!==e$&&e$<=10&&(0,r.jsx)("div",{className:"text-4xl font-extrabold text-red-600 animate-pulse",children:Math.ceil(e$)}),p&&(0,r.jsxs)("div",{className:"mt-3",children:[(0,r.jsx)("div",{className:"text-[11px] font-semibold text-gray-600 mb-1",children:"Grid (compact)"}),ts(c[e.id]||[])]}),p&&(0,r.jsxs)("div",{className:"mt-3",children:[(0,r.jsx)("div",{className:"text-[11px] font-semibold text-gray-600 mb-1",children:"Notes"}),(0,r.jsx)("textarea",{value:null!=(n=null!=(a=I[ta(e.id)])?a:O[ta(e.id)])?n:"",onChange:t=>F(a=>({...a,[ta(e.id)]:t.target.value})),onBlur:()=>tr(e.id),rows:2,placeholder:"Add notes for this part...",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsxs)("div",{className:"mt-1 flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>tr(e.id),className:"px-2 py-0.5 bg-gray-900 text-white rounded text-[11px]",disabled:U[ta(e.id)],children:U[ta(e.id)]?"Saving...":"Save note"}),(0,r.jsx)("span",{className:"text-[10px] text-gray-400",children:"Auto-saves on blur"})]})]}),(0,r.jsx)("div",{className:"text-base text-gray-600 mt-1",children:0===(c[e.id]||[]).length?"No positions":(c[e.id]||[]).map((t,a)=>(0,r.jsxs)("span",{children:[a>0?", ":"",(0,r.jsx)("span",{className:t.student_name===D?"font-bold text-emerald-600":"",children:t.student_name})]},"".concat(e.id,"-pos-").concat(t.student_id,"-").concat(a)))}),(b[e.id]||[]).length>0&&(0,r.jsx)("div",{className:"mt-3 space-y-3 text-sm text-gray-700",children:(b[e.id]||[]).map((t,a)=>{var n,s;let i=y[t.id]||[],l="number"==typeof t.timepoint_seconds?t.timepoint_seconds:null!==t.timepoint_seconds&&void 0!==t.timepoint_seconds?parseFloat(String(t.timepoint_seconds)):NaN,d="number"==typeof t.timepoint_end_seconds?t.timepoint_end_seconds:null!==t.timepoint_end_seconds&&void 0!==t.timepoint_end_seconds?parseFloat(String(t.timepoint_end_seconds)):NaN,o=Number.isFinite(l);return(0,r.jsxs)("div",{className:"",children:[o?(0,r.jsxs)("button",{type:"button",onClick:()=>e6(l,!0),className:"font-semibold text-gray-900 text-left",children:[a+1,". ",t.title]}):(0,r.jsxs)("div",{className:"font-semibold text-gray-900",children:[a+1,". ",t.title]}),(0,r.jsxs)("div",{className:"text-gray-600",children:["Assigned:"," ",0===i.length?"—":i.map((e,a)=>{let n=e.start_side||"OS",s=e.end_side||n,i=n===s?n:"".concat(n,"→").concat(s);return(0,r.jsxs)("span",{children:[a>0?", ":"",(0,r.jsx)("span",{className:e.student_name===D?"font-bold text-emerald-600":"",children:e.student_name})," ",(0,r.jsxs)("span",{className:"font-semibold",children:["(",i,")"]})]},"".concat(t.id,"-assigned-").concat(a))})]}),(0,r.jsxs)("div",{className:"text-gray-500",children:["Notes: ",t.description?t.description:"—"]}),O[ta(e.id,t.id)]&&(0,r.jsxs)("div",{className:"text-[10px] text-gray-500 mt-1",children:["Note: ",O[ta(e.id,t.id)]]}),(0,r.jsxs)("div",{className:"mt-1",children:[(0,r.jsx)("textarea",{value:null!=(s=null!=(n=I[ta(e.id,t.id)])?n:O[ta(e.id,t.id)])?s:"",onChange:a=>F(r=>({...r,[ta(e.id,t.id)]:a.target.value})),onBlur:()=>tr(e.id,t.id),rows:2,placeholder:"Add rehearsal notes...",className:"w-full px-2 py-1 border border-gray-200 rounded text-[11px]"}),(0,r.jsx)("div",{className:"mt-1 flex items-center gap-2",children:(0,r.jsx)("button",{onClick:()=>tr(e.id,t.id),className:"px-2 py-0.5 bg-gray-900 text-white rounded text-[10px]",disabled:U[ta(e.id,t.id)],children:U[ta(e.id,t.id)]?"Saving...":"Save note"})})]}),(0,r.jsxs)("div",{className:"text-[11px] text-gray-500",children:["Time: ",Number.isFinite(l)?e0(l):"--:--"," / ",Number.isFinite(d)?e0(d):"--:--"]}),o&&(0,r.jsxs)("button",{onClick:t=>{t.stopPropagation(),te(l,e.id)},className:"mt-1 text-[11px] text-indigo-600 hover:text-indigo-800 underline",children:["Jump to ",t.title," subpart"]}),_[t.id]&&(0,r.jsxs)("div",{className:"mt-2",children:[(0,r.jsx)("button",{type:"button",onClick:async e=>{if(e.stopPropagation(),C(e=>({...e,[t.id]:!e[t.id]})),!E[t.id])try{let e=await fetch("/api/subpart-positions?subpartId=".concat(t.id));if(e.ok){let a=(await e.json()||[]).map(e=>({student_id:e.student_id,student_name:e.student_name||"Unknown",x:e.x,y:e.y}));T(e=>({...e,[t.id]:a}))}}catch(e){T(e=>({...e,[t.id]:[]}))}},className:"text-[11px] text-indigo-600 hover:text-indigo-800 underline",children:k[t.id]?"Hide grid":"Show grid"}),k[t.id]&&(0,r.jsx)("div",{className:"mt-1",children:ts(E[t.id]||[])})]})]},t.id)})}),z===e.id&&null!==L&&(0,r.jsx)("div",{className:"mt-2 text-center text-3xl font-extrabold text-red-600 animate-pulse",children:L})]})]},e.id)})})]}),(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-[minmax(260px,0.6fr)_minmax(420px,1fr)] gap-6 items-start",children:[(0,r.jsxs)("div",{className:"space-y-3",children:[ti("Current",eQ,!1,34),tl(eQ,!1)]}),(0,r.jsxs)("div",{className:"space-y-3",children:[ti("Next",eV,!0,80),tl(eV,!0)]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsx)("div",{className:"min-h-[180px]",children:tn(eQ)}),(0,r.jsx)("div",{className:"min-h-[180px]",children:tn(eV)})]}),(0,r.jsx)("div",{className:"max-w-xl space-y-3",children:(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-3 rounded-lg border-2 border-blue-600 bg-blue-50 p-3",children:[(0,r.jsx)("div",{className:"text-xs font-extrabold uppercase tracking-widest text-blue-700",children:"Filter by person"}),(0,r.jsxs)("select",{value:D,onChange:e=>P(e.target.value),className:"min-w-[160px] px-2 py-1 border border-blue-200 rounded text-sm bg-white",children:[(0,r.jsx)("option",{value:"",children:"All"}),e7.map(e=>(0,r.jsx)("option",{value:e,children:e},e))]}),(0,r.jsxs)("div",{className:"ml-auto flex items-center gap-3 text-xs font-semibold text-blue-700",children:[Z&&(0,r.jsxs)("div",{children:["Call Time: ",(0,r.jsx)("span",{className:"font-bold",children:Z})]}),(0,r.jsxs)("label",{className:"flex items-center gap-2",children:[(0,r.jsx)("input",{type:"checkbox",checked:h,onChange:e=>g(e.target.checked),className:"h-4 w-4"}),"Ring at T-10"]})]})]})})]})]})]})})})}var N=a(1517);function w(e){let{partId:t}=e,[a,s]=(0,n.useState)([]),[i,l]=(0,n.useState)(!1),[d,o]=(0,n.useState)(""),[c,u]=(0,n.useState)(""),[m,p]=(0,n.useState)(""),[x,h]=(0,n.useState)(""),[g,b]=(0,n.useState)(""),[f,y]=(0,n.useState)(""),[v,j]=(0,n.useState)(null),[N,w]=(0,n.useState)(""),[_,S]=(0,n.useState)(""),[k,C]=(0,n.useState)(""),[E,T]=(0,n.useState)(""),[D,P]=(0,n.useState)(""),[O,M]=(0,n.useState)(""),I=e=>{if(null==e||""===e)return{min:"",sec:""};let t=Number(e);if(!Number.isFinite(t))return{min:"",sec:""};let a=Math.floor(t/60),r=Math.floor(t%60);return{min:String(a),sec:String(r)}},F=(e,t)=>{if(!e&&!t)return null;let a=e?parseInt(e,10):0,r=t?parseFloat(t):0;return Number.isNaN(a)||Number.isNaN(r)?null:60*a+r},U=e=>{if(null==e||""===e)return"--:--";let t=Number(e);if(!Number.isFinite(t))return"--:--";let a=Math.floor(t/60),r=Math.floor(t%60);return"".concat(a,":").concat(r.toString().padStart(2,"0"))},A=(0,n.useCallback)(async()=>{if(!t)return void s([]);try{l(!0);let e=await fetch("/api/subparts?partId=".concat(t));if(!e.ok)throw Error("Failed to fetch subparts");let a=await e.json();s(a||[])}catch(e){console.error("Error fetching subparts:",e)}finally{l(!1)}},[t]);return((0,n.useEffect)(()=>{A()},[A]),(0,n.useEffect)(()=>{let e=e=>{let a=e.detail;(null==a?void 0:a.partId)&&a.partId!==t||A()};return window.addEventListener("subparts-updated",e),()=>window.removeEventListener("subparts-updated",e)},[A,t]),t)?(0,r.jsxs)("div",{className:"border-t border-gray-200 pt-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-900",children:"Subparts / Solos"}),(0,r.jsx)("button",{onClick:A,className:"text-xs text-blue-600 hover:text-blue-800",children:"Refresh"})]}),i&&(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-2",children:"Loading..."}),0===a.length&&!i&&(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-2",children:"No subparts yet."}),(0,r.jsx)("div",{className:"space-y-2",children:a.map(e=>(0,r.jsx)("div",{className:"border border-gray-200 rounded p-2 text-xs",children:v===e.id?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("input",{type:"text",value:N,onChange:e=>w(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("textarea",{value:_,onChange:e=>S(e.target.value),rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:k,onChange:e=>C(e.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:E,onChange:e=>T(e.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:D,onChange:e=>P(e.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:O,onChange:e=>M(e.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:async()=>{try{let a=await fetch("/api/subparts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:N,description:_,timepoint_seconds:F(k,E),timepoint_end_seconds:F(D,O)})});if(!a.ok)throw Error("Failed to update subpart");let r=await a.json();r&&(s(t=>t.map(t=>t.id===e.id?{...t,...r}:t)),window.dispatchEvent(new CustomEvent("subparts-updated",{detail:{partId:t}}))),j(null)}catch(e){alert(e instanceof Error?e.message:"Failed to update subpart")}},className:"px-2 py-1 bg-green-600 text-white rounded text-xs",children:"Save"}),(0,r.jsx)("button",{onClick:()=>j(null),className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]})]}):(0,r.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium text-gray-800",children:e.title}),e.mode&&(0,r.jsxs)("div",{className:"text-[10px] text-gray-400",children:["Mode: ",e.mode]}),e.description&&(0,r.jsx)("div",{className:"text-gray-600",children:e.description}),null!==e.timepoint_seconds||null!==e.timepoint_end_seconds?(0,r.jsxs)("div",{className:"text-[10px] text-gray-400",children:["Time: ",U(e.timepoint_seconds)," - ",U(e.timepoint_end_seconds)]}):(0,r.jsx)("div",{className:"text-[10px] text-gray-400",children:"Time: --:-- - --:--"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>{j(e.id),w(e.title),S(e.description||"");let t=I(e.timepoint_seconds),a=I(e.timepoint_end_seconds);C(t.min),T(t.sec),P(a.min),M(a.sec)},className:"text-[10px] text-blue-600 hover:text-blue-800",children:"Edit"}),(0,r.jsx)("button",{onClick:async()=>{if(window.confirm("Delete this subpart?"))try{if(!(await fetch("/api/subparts/".concat(e.id),{method:"DELETE"})).ok)throw Error("Failed to delete subpart");await A()}catch(e){alert(e instanceof Error?e.message:"Failed to delete subpart")}},className:"text-[10px] text-red-600 hover:text-red-800",children:"Delete"})]})]})},e.id))}),(0,r.jsxs)("div",{className:"mt-3 border-t border-gray-200 pt-3",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-700 text-xs mb-2",children:"Add Subpart"}),(0,r.jsx)("input",{type:"text",value:d,onChange:e=>o(e.target.value),placeholder:"Subpart title",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2"}),(0,r.jsx)("textarea",{value:c,onChange:e=>u(e.target.value),placeholder:"Description",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:m,onChange:e=>p(e.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:x,onChange:e=>h(e.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:g,onChange:e=>b(e.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:f,onChange:e=>y(e.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsx)("button",{onClick:async()=>{let e=d.trim(),a=c.trim();if(e)try{if(!(await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:t,title:e,description:a||null,mode:"position",timepoint_seconds:F(m,x),timepoint_end_seconds:F(g,f)})})).ok)throw Error("Failed to create subpart");o(""),u(""),p(""),h(""),b(""),y(""),await A()}catch(e){alert(e instanceof Error?e.message:"Failed to create subpart")}},className:"px-2 py-1 bg-blue-600 text-white rounded text-xs",children:"Add Subpart"})]})]}):null}var _=a(5959),S=a(701);function k(e){let t=Math.max(0,Math.floor(e)),a=Math.floor(t/60);return"".concat(a,":").concat((t%60).toString().padStart(2,"0"))}function C(e){if(!e)return null;let t=e.trim();if(!t)return null;if(/^\d+(\.\d+)?$/.test(t))return Math.max(0,parseFloat(t));let a=t.split(":");if(2===a.length){let e=parseInt(a[0],10),t=parseFloat(a[1]);return Number.isNaN(e)||Number.isNaN(t)?null:Math.max(0,60*e+t)}return null}function E(){return Math.random().toString(36).slice(2,10)+Date.now().toString(36)}function T(e){let{performanceId:t,parts:a,musicUrl:s,performanceTitle:i,onPartsUpdated:l}=e,[d,o]=(0,n.useState)([]),[u,m]=(0,n.useState)(null),[p,x]=(0,n.useState)(0),[h,g]=(0,n.useState)({}),[b,f]=(0,n.useState)({}),[v,j]=(0,n.useState)({}),[N,w]=(0,n.useState)(!1),[_,S]=(0,n.useState)("New Marking Session"),[T,D]=(0,n.useState)(!1),[P,O]=(0,n.useState)([]),[M,I]=(0,n.useState)(""),[F,U]=(0,n.useState)(!1),[A,L]=(0,n.useState)({}),[R,J]=(0,n.useState)(null),q=(0,n.useRef)(null),z=(0,n.useRef)(null),G=(0,n.useRef)(null),[Z,B]=(0,n.useState)(180),[X,H]=(0,n.useState)({}),[W,K]=(0,n.useState)({}),[Y,Q]=(0,n.useState)(null),V=(0,n.useRef)(null),[$,ee]=(0,n.useState)(null),[et,ea]=(0,n.useState)({}),[er,en]=(0,n.useState)({}),[es,ei]=(0,n.useState)({}),[el,ed]=(0,n.useState)({}),[eo,ec]=(0,n.useState)({}),[eu,em]=(0,n.useState)(null),[ep,ex]=(0,n.useState)(1),[eh,eg]=(0,n.useState)({}),[eb,ef]=(0,n.useState)({}),[ey,ev]=(0,n.useState)({}),[ej,eN]=(0,n.useState)(""),[ew,e_]=(0,n.useState)({}),[eS,ek]=(0,n.useState)(null),eC=(0,n.useMemo)(()=>{let e=[];a.forEach(t=>{var a,r,n,s;let i=X[t.id],l=null!=(r=null!=(a=null==i?void 0:i.start)?a:t.timepoint_seconds)?r:null,d=null!=(s=null!=(n=null==i?void 0:i.end)?n:t.timepoint_end_seconds)?s:null;null!==l&&e.push(l),null!==d&&e.push(d),null!==l&&null===d&&e.push(l+10)}),Object.values(b).flat().forEach(t=>{var a,r,n,s;let i=W[t.id],l=null!=(r=null!=(a=null==i?void 0:i.start)?a:t.timepoint_seconds)?r:null,d=null!=(s=null!=(n=null==i?void 0:i.end)?n:t.timepoint_end_seconds)?s:null;null!==l&&e.push(l),null!==d&&e.push(d),null!==l&&null===d&&e.push(l+10)});let t=e.length?Math.max(...e):0;return R&&Number.isFinite(R)?Math.max(R,t,10):Math.max(Z,t,10)},[R,Z,a,b,X,W]);(0,n.useEffect)(()=>()=>{var e;null==(e=q.current)||e.call(q)},[]),(0,n.useEffect)(()=>{if(!Y)return;let e=e=>{if(!G.current||!V.current)return;let t=G.current.getBoundingClientRect(),a=(e.clientX-t.left)/t.width*eC-V.current.offsetSec,r=V.current.duration,n=Math.round(Math.max(0,Math.min(eC-r,a)));eD(V.current.partId,n,n+r),ee({partId:V.current.partId,time:n})},t=()=>{Q(null),V.current=null,ee(null)};return window.addEventListener("mousemove",e),window.addEventListener("mouseup",t),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)}},[Y,eC]);let eE=(0,n.useMemo)(()=>{let e={};return Object.values(h).forEach(t=>{"string"==typeof t?e[t]=(e[t]||0)+1:(null==t?void 0:t.markId)&&(e[t.markId]=(e[t.markId]||0)+1)}),e},[h]);(0,n.useEffect)(()=>{if(0===d.length){let e={id:E(),label:"Row 1",note:"",marks:[]};o([e]),m(e.id)}},[d.length]),(0,n.useEffect)(()=>{T||S("".concat(new Date().toLocaleString(void 0,{timeZone:c.GI,timeZoneName:"short"})," \xb7 ").concat(i||"Performance"))},[i,T]);let eT=(0,n.useCallback)(e=>{var t,a,r,n;let s=X[e.id];return{start:null!=(a=null!=(t=null==s?void 0:s.start)?t:e.timepoint_seconds)?a:null,end:null!=(n=null!=(r=null==s?void 0:s.end)?r:e.timepoint_end_seconds)?n:null}},[X]),eD=(e,t,a)=>{H(r=>({...r,[e]:{start:t,end:a}}))},eP=(e,t,a)=>{K(r=>({...r,[e]:{start:t,end:a}}))},eO=(0,n.useCallback)(async(e,t)=>{let r=a.find(t=>t.id===e);if(!r||(r.description||"")===t)return;let n=await fetch("/api/parts/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:t})});if(!n.ok)return;let s=await n.json();l(a.map(t=>t.id===e?{...t,description:s.description||""}:t))},[l,a]),eM=(0,n.useCallback)(async(e,t)=>{let a=Object.values(b).flat().find(t=>t.id===e);if(!a||(a.description||"")===t)return;let r=await fetch("/api/subparts/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:t})});if(!r.ok)return;let n=await r.json();f(t=>{let r={...t};return r[a.part_id]=(r[a.part_id]||[]).map(t=>{var a;return t.id===e?{...t,description:null!=(a=n.description)?a:""}:t}),r})},[b]),eI=async(e,t,a)=>{var r,n;let s=null!=(r=e.timepoint_seconds)?r:null,i=null!=(n=e.timepoint_end_seconds)?n:null;eP(e.id,t,a),f(r=>{let n={...r},s=(n[e.part_id]||[]).map(r=>r.id===e.id?{...r,timepoint_seconds:t,timepoint_end_seconds:a}:r);return n[e.part_id]=s.sort((e,t)=>{var a,r;let n="number"==typeof e.timepoint_seconds?e.timepoint_seconds:1/0,s="number"==typeof t.timepoint_seconds?t.timepoint_seconds:1/0;return n!==s?n-s:(null!=(a=e.order)?a:0)-(null!=(r=t.order)?r:0)}),n});try{let r=await fetch("/api/subparts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({timepoint_seconds:t,timepoint_end_seconds:a})});if(!r.ok)throw Error("Failed to update timepoint");let n=await r.json();n&&f(t=>{let a={...t};return a[e.part_id]=(a[e.part_id]||[]).map(t=>t.id===e.id?{...t,...n}:t),a}),window.dispatchEvent(new CustomEvent("subparts-updated",{detail:{partId:e.part_id}}))}catch(t){eP(e.id,s,i),f(t=>{let a={...t},r=(a[e.part_id]||[]).map(t=>t.id===e.id?{...t,timepoint_seconds:s,timepoint_end_seconds:i}:t);return a[e.part_id]=r,a}),console.error(t),alert("Failed to update timepoints")}},eF=e=>{var t,r,n,s,i,l;let d=W[e.id],o=a.find(t=>t.id===e.part_id),c=o?eT(o):{start:null,end:null};return{start:null!=(n=null!=(r=null!=(t=null==d?void 0:d.start)?t:e.timepoint_seconds)?r:c.start)?n:null,end:null!=(l=null!=(i=null!=(s=null==d?void 0:d.end)?s:e.timepoint_end_seconds)?i:c.end)?l:null}};(0,n.useEffect)(()=>{t&&(async()=>{let e=await Promise.all(a.map(async e=>{let t=await fetch("/api/subparts?partId=".concat(e.id));if(!t.ok)return[e.id,[]];let a=await t.json();return[e.id,a||[]]})),t={};e.forEach(e=>{let[a,r]=e;t[a]=r}),f(t)})()},[t,a]),(0,n.useEffect)(()=>{a&&0!==a.length&&eg(e=>{let t={...e};return a.forEach(e=>{null!==e.timeline_row&&void 0!==e.timeline_row&&(t[e.id]=e.timeline_row)}),t})},[a]),(0,n.useEffect)(()=>{t&&(async()=>{let e=await fetch(F?"/api/marking-sessions?all=1":"/api/marking-sessions?performanceId=".concat(t));e.ok&&O(await e.json()||[])})()},[t,F]),(0,n.useEffect)(()=>{(async()=>{let e=await fetch("/api/performances");if(!e.ok)return;let t=await e.json(),a={};(t||[]).forEach(e=>{a[e.id]=e.title||"Performance"}),L(a)})()},[]),(0,n.useEffect)(()=>{let e=e=>{var t,a;let r=e.target,n=null==r||null==(t=r.tagName)?void 0:t.toLowerCase();if("input"!==n&&"textarea"!==n&&"select"!==n){if("Space"===e.code){e.preventDefault();let t=u||(null==(a=d[0])?void 0:a.id);if(!t)return;let r={id:E(),time:p,createdAt:new Date().toISOString()};o(e=>e.map(e=>e.id===t?{...e,marks:[...e.marks,r]}:e))}if("e"===e.key||"E"===e.key){e.preventDefault();let t=d.length+1,a={id:E(),label:"Row ".concat(t),note:"",marks:[]};o(e=>{let t=u?e.findIndex(e=>e.id===u):e.length-1;if(-1===t)return[...e,a];let r=[...e];return r.splice(t+1,0,a),r}),m(a.id)}}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[u,p,d]);let eU=e=>{for(let t of d){let a=t.marks.find(t=>t.id===e);if(a)return a.time}return null},eA=(0,n.useMemo)(()=>{let e=["bg-amber-50 border-amber-300 text-amber-950","bg-emerald-50 border-emerald-300 text-emerald-950","bg-sky-50 border-sky-300 text-sky-950","bg-rose-50 border-rose-300 text-rose-950","bg-lime-50 border-lime-300 text-lime-950","bg-fuchsia-50 border-fuchsia-300 text-fuchsia-950","bg-orange-50 border-orange-300 text-orange-950","bg-teal-50 border-teal-300 text-teal-950"],t={};return a.forEach((a,r)=>{t[a.id]=e[r%e.length]}),t},[a]),eL=async(e,t)=>{await Promise.all(t.map((e,t)=>fetch("/api/subparts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:t+1})})))},eR=(e,t,a)=>{f(r=>{let n={...r},s=[...n[e]||[]],i=s.findIndex(e=>e.id===t);if(-1===i)return r;let l="up"===a?i-1:i+1;if(l<0||l>=s.length)return r;let[d]=s.splice(i,1);return s.splice(l,0,d),n[e]=s,eL(e,s),n})},eJ=(0,n.useMemo)(()=>{let e=[],t=[];a.forEach(a=>{let{start:r,end:n}=eT(a);if(null===r)return void t.push(a);e.push({id:a.id,name:a.name,start:r,end:null!=n?n:r+10,missingEnd:null===n})}),e.sort((e,t)=>e.start-t.start);let r=[];e.forEach(e=>{var t,n;let s=a.find(t=>t.id===e.id),i=null!=(n=null!=(t=eh[e.id])?t:null==s?void 0:s.timeline_row)?n:void 0;if(void 0!==i){for(;r.length<=i;)r.push({id:E(),items:[]});r[i].items.push(e);return}let l=!1;for(let t of r){let a=t.items[t.items.length-1];if(!a||e.start>=a.end){t.items.push(e),l=!0;break}}l||r.push({id:E(),items:[e]})}),r.forEach(e=>e.items.sort((e,t)=>e.start-t.start));let n=r.length;if(ep>r.length)for(let e=r.length;e<ep;e+=1)r.push({id:E(),items:[],manual:!0});return{rows:r,unassigned:t,autoRowCount:n}},[a,ep,eh,eT]),eq=(0,n.useMemo)(()=>[...a].sort((e,t)=>{let a=eT(e).start,r=eT(t).start;return"number"==typeof a&&"number"==typeof r?a!==r?a-r:(e.order||0)-(t.order||0):"number"==typeof a?-1:"number"==typeof r?1:(e.order||0)-(t.order||0)}),[a,eT]),ez=e=>{var t;let a=h[e];if(!a)return null;if("string"==typeof a){for(let e of d){let t=e.marks.find(e=>e.id===a);if(t)return t.time}return null}return null!=(t=a.time)?t:null},eG=(e,t)=>{let[a,r,n]=e.split(":"),s=eZ(a,r,n),i=(e=>{var t;if(!e)return null;if("string"==typeof e){for(let t of d){let a=t.marks.find(t=>t.id===e);if(a)return a.time}return null}return null!=(t=e.time)?t:null})(t),l=null!=i?i:s,o=null!==l?k(l):"Unassigned",u=new Date().toLocaleString(void 0,{timeZone:c.GI,timeZoneName:"short"});e_(a=>({...a,[e]:[{prev:t,label:o,at:u},...a[e]||[]].slice(0,6)}))},eZ=(e,t,r)=>{var n,s,i,l;if("part"===e){let e=a.find(e=>e.id===t);return e?"start"===r?null!=(n=e.timepoint_seconds)?n:null:null!=(s=e.timepoint_end_seconds)?s:null:null}let d=Object.values(b).flat().find(e=>e.id===t);return d?"start"===r?null!=(i=d.timepoint_seconds)?i:null:null!=(l=d.timepoint_end_seconds)?l:null:null},eB=e=>{g(t=>{eG(e,t[e]);let a={...t};return delete a[e],a})},eX=(e,t,a)=>{var n;let s="".concat(e,":").concat(t,":").concat(a),i=h[s],l="string"==typeof i?i:null==i?void 0:i.markId,o=ez(s),c=eZ(e,t,a),u=null!==o?o:c,m=ew[s]||[];return(0,r.jsxs)("div",{className:"relative border border-dashed rounded px-2 py-1 text-xs flex flex-wrap items-center gap-2 ".concat(l?"border-emerald-400 bg-emerald-50":"border-gray-300 bg-white"),onDragOver:e=>e.preventDefault(),onDrop:e=>{let t=e.dataTransfer.getData("markId");t&&((e,t)=>{var a;let[r,n,s]=e.split(":"),i=null==(a=d.flatMap(e=>e.marks).find(e=>e.id===t))?void 0:a.time;if(void 0===i)return;let l="start"===s?"end":"start",o=ez("".concat(r,":").concat(n,":").concat(l)),c=eZ(r,n,l),u=null!=o?o:c;return"end"===s&&null!==u&&i<u?alert("End time cannot be before start time."):"start"===s&&null!==u&&i>u?alert("Start time cannot be after end time."):g(a=>(eG(e,a[e]),{...a,[e]:{markId:t,time:i}}))})(s,t)},children:[(0,r.jsx)("span",{className:"text-gray-500 uppercase",children:a}),(0,r.jsx)("span",{className:"font-semibold text-gray-800",children:null!==u?k(u):"--:--"}),(0,r.jsx)("input",{value:null!=(n=eo[s])?n:"",onChange:e=>ec(t=>({...t,[s]:e.target.value})),onKeyDown:e=>{var t;if("Enter"!==e.key)return;let a=C(null!=(t=eo[s])?t:"");null!==a&&(g(e=>({...e,[s]:{time:a}})),ec(e=>({...e,[s]:""})))},placeholder:"mm:ss",className:"px-1 py-0.5 border border-gray-200 rounded text-[10px] w-14"}),l&&(0,r.jsx)("button",{type:"button",onClick:e=>{e.stopPropagation(),confirm("Remove this chip assignment?")&&eB(s)},className:"px-2 py-0.5 rounded-full text-[10px] bg-emerald-600 text-white",title:"Remove assignment",children:"Chip"}),(0,r.jsxs)("div",{className:"ml-auto flex items-center gap-2",children:[m.length>0&&(0,r.jsx)("button",{onClick:()=>(e=>{let t=ew[e];if(!t||0===t.length)return;let[a,...r]=t;e_(t=>({...t,[e]:r})),g(t=>{let r={...t};return a.prev?r[e]=a.prev:delete r[e],r})})(s),className:"text-[10px] text-gray-700 hover:text-gray-900",title:"Undo last change",children:"Undo"}),(0,r.jsx)("button",{onClick:()=>ek(e=>e===s?null:s),className:"text-[10px] text-gray-500 hover:text-gray-700",title:"History",children:"Log"}),l&&(0,r.jsx)("button",{onClick:()=>eB(s),className:"text-red-600 hover:text-red-800",title:"Remove",children:"x"})]}),eS===s&&(0,r.jsxs)("div",{className:"absolute right-0 top-full mt-1 w-44 rounded border border-gray-200 bg-white shadow-lg p-2 text-[10px] text-gray-600 z-20",children:[0===m.length&&(0,r.jsx)("div",{children:"No history yet"}),m.map((e,t)=>(0,r.jsxs)("div",{className:"border-b border-gray-100 pb-1 mb-1 last:border-0 last:pb-0 last:mb-0",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-800",children:e.label}),(0,r.jsx)("div",{children:e.at})]},"".concat(e.at,"-").concat(t)))]})]})},eH=async()=>{let e=await fetch("/api/marking-sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:t,title:_||"Marking Session",rows:d,assignments:h})});if(e.ok){let t=await e.json();O(e=>[t,...e])}},eW=async()=>{w(!0);try{let e={},t={};Object.entries(h).forEach(a=>{var r;let[n,s]=a,[i,l,o]=n.split(":");"string"==typeof s||null==s||s.markId;let c="string"==typeof s?null==(r=d.flatMap(e=>e.marks).find(e=>e.id===s))?void 0:r.time:null==s?void 0:s.time;null!=c&&("part"===i?(e[l]=e[l]||{},e[l]["start"===o?"timepoint_seconds":"timepoint_end_seconds"]=c):(t[l]=t[l]||{},t[l]["start"===o?"timepoint_seconds":"timepoint_end_seconds"]=c))});let r=[],n=[];await Promise.all(Object.entries(e).map(async e=>{let[t,a]=e,n=await fetch("/api/parts/".concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(n.ok){let e=await n.json();r.push(e)}})),await Promise.all(Object.entries(t).map(async e=>{let[t,a]=e,r=await fetch("/api/subparts/".concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(r.ok){let e=await r.json();e&&n.push(e)}})),r.length>0&&l(a.map(e=>r.find(t=>t.id===e.id)||e)),n.length>0&&f(e=>{let t={...e};return n.forEach(e=>{t[e.part_id]=(t[e.part_id]||[]).map(t=>t.id===e.id?{...t,...e}:t)}),t})}finally{w(!1)}},eK=async()=>{w(!0);try{let e={},t={};a.forEach(t=>{var a,r;let{start:n,end:s}=eT(t),i=null!=(r=null!=(a=eh[t.id])?a:t.timeline_row)?r:null;null!==n||null!==i?e[t.id]={timepoint_seconds:n,timepoint_end_seconds:null!=s?s:null,timeline_row:i}:null!==t.timeline_row&&void 0!==t.timeline_row&&(e[t.id]={timeline_row:null})}),Object.values(b).flat().forEach(e=>{var a,r,n,s;let i=W[e.id],l=null!=(r=null!=(a=null==i?void 0:i.start)?a:e.timepoint_seconds)?r:null,d=null!=(s=null!=(n=null==i?void 0:i.end)?n:e.timepoint_end_seconds)?s:null;null!==l&&(t[e.id]={timepoint_seconds:l,timepoint_end_seconds:null!=d?d:null})});let r=[];await Promise.all(Object.entries(e).map(async e=>{let[t,a]=e,n=await fetch("/api/parts/".concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(n.ok){let e=await n.json();r.push(e)}})),await Promise.all(Object.entries(t).map(async e=>{let[t,a]=e;await fetch("/api/subparts/".concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})})),r.length>0&&l(a.map(e=>r.find(t=>t.id===e.id)||e))}finally{w(!1)}};return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)("div",{className:"w-full -mx-4 px-4",children:(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4 w-full",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,r.jsx)("div",{className:"text-lg font-semibold text-gray-900",children:"Timeline"}),(0,r.jsxs)("div",{className:"ml-auto flex items-center gap-2",children:[!R&&(0,r.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[(0,r.jsx)("span",{children:"Timeline length (sec)"}),(0,r.jsx)("input",{type:"number",min:10,value:Z,onChange:e=>B(parseInt(e.target.value||"0",10)||0),className:"w-20 px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsx)("button",{onClick:()=>ex(e=>e+1),className:"px-3 py-1 border border-gray-300 rounded text-xs text-gray-700 hover:bg-gray-50",children:"Add Row"}),(0,r.jsx)("button",{onClick:eK,disabled:N,className:"px-3 py-1 bg-indigo-600 text-white rounded text-sm disabled:bg-gray-400",children:N?"Saving...":"Save Timeline"})]})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"Drag parts to move them. Drop chips or type times to set Start/End."}),(0,r.jsxs)("div",{className:"mt-3 space-y-4",children:[eJ.rows.map((e,t)=>(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 text-xs font-semibold text-gray-600",children:[(0,r.jsxs)("span",{children:["Row ",t+1]}),t>=eJ.autoRowCount&&0===e.items.length&&(0,r.jsx)("button",{onClick:()=>ex(e=>Math.max(1,e-1)),className:"ml-auto text-[11px] text-gray-500 hover:text-gray-800",children:"Remove row"})]}),(0,r.jsx)("div",{ref:0===t?G:void 0,className:"relative h-36 border border-gray-200 rounded bg-gray-50 overflow-visible",onDragOver:e=>e.preventDefault(),onDrop:e=>{let r=e.dataTransfer.getData("partId");if(!r)return;let n=e.currentTarget.getBoundingClientRect(),s=Math.max(0,Math.min(eC-10,Math.round((e.clientX-n.left)/n.width*eC))),i=a.find(e=>e.id===r),{start:l,end:d}=i?eT(i):{start:null,end:null};eD(r,s,s+Math.max(1,null!==l&&null!==d?d-l:10)),eg(e=>({...e,[r]:t}))},children:e.items.map(e=>{var t,n;let s=e.start/eC*100,i=(e.end-e.start)/eC*100,l=a.find(t=>t.id===e.id),d=l&&b[l.id]||[],o=[...d].sort((e,t)=>{var a,r;let n=null!=(a=eF(e).start)?a:1/0,s=null!=(r=eF(t).start)?r:1/0;return n!==s?n-s:e.title.localeCompare(t.title)}),c=eA[e.id]||"bg-white border-gray-300 text-gray-900",{start:u,end:m}=l?eT(l):{start:null,end:null};return(0,r.jsxs)("div",{className:"absolute top-2 h-[120px] rounded border px-3 py-2 shadow-sm cursor-move ".concat(c," ").concat(e.missingEnd?"border-blue-400":""),style:{left:"".concat(s,"%"),width:"".concat(Math.max(4,i),"%")},onMouseDown:t=>{if(["INPUT","TEXTAREA","BUTTON"].includes(t.target.tagName)||!G.current)return;let a=G.current.getBoundingClientRect(),r=(t.clientX-a.left)/a.width*eC-e.start;V.current={partId:e.id,duration:e.end-e.start,offsetSec:r},Q(e.id),ee({partId:e.id,time:e.start})},children:[(null==$?void 0:$.partId)===e.id&&(0,r.jsx)("div",{className:"absolute -top-6 left-0 px-2 py-0.5 rounded bg-gray-900 text-white text-[10px]",children:function(e){let t=Math.max(0,Math.floor(e)),a=Math.floor(t/3600),r=Math.floor(t%3600/60),n=t%60;return a>0?"".concat(a,":").concat(r.toString().padStart(2,"0"),":").concat(n.toString().padStart(2,"0")):"".concat(r,":").concat(n.toString().padStart(2,"0"))}($.time)}),(0,r.jsx)("div",{className:"text-sm font-semibold truncate",children:e.name}),(0,r.jsxs)("div",{className:"mt-2 grid grid-cols-2 gap-1 text-[11px]",children:[(0,r.jsxs)("div",{className:"border border-dashed rounded px-1 py-0.5 ".concat(e.missingEnd?"border-blue-400 bg-blue-50":"border-gray-300 bg-white"),onDragOver:e=>e.preventDefault(),onDrop:t=>{let a=t.dataTransfer.getData("markId");if(!a)return;let r=eU(a);if(null===r)return;let n=null!==m&&r>m?r:m;eD(e.id,r,n)},children:["Start:",(0,r.jsx)("input",{className:"ml-1 w-12 bg-transparent",value:null!=(t=et[e.id])?t:null!==u?k(u):"",onChange:t=>{let a=t.target.value;ea(t=>({...t,[e.id]:a}));let r=C(a);null!==r&&(null!==m&&r>m||eD(e.id,r,m))},onKeyDown:t=>{var a;if("Enter"!==t.key)return;let r=C(null!=(a=et[e.id])?a:"");null!==r&&(null!==m&&r>m||(eD(e.id,r,m),ea(t=>({...t,[e.id]:""}))))}})]}),(0,r.jsxs)("div",{className:"border border-dashed rounded px-1 py-0.5 ".concat(e.missingEnd?"border-blue-400 bg-blue-50":"border-gray-300 bg-white"),onDragOver:e=>e.preventDefault(),onDrop:t=>{let a=t.dataTransfer.getData("markId");if(!a)return;let r=eU(a);null!==r&&(null!==u&&r<u||eD(e.id,u,r))},children:["End:",(0,r.jsx)("input",{className:"ml-1 w-12 bg-transparent",value:null!=(n=er[e.id])?n:null!==m?k(m):"",onChange:t=>{let a=t.target.value;en(t=>({...t,[e.id]:a}));let r=C(a);null!==r&&(null!==u&&r<u||eD(e.id,u,r))},onKeyDown:t=>{var a;if("Enter"!==t.key)return;let r=C(null!=(a=er[e.id])?a:"");null!==r&&(null!==u&&r<u||(eD(e.id,u,r),en(t=>({...t,[e.id]:""}))))}})]})]}),d.length>0&&(0,r.jsxs)("div",{className:"mt-2",children:[(0,r.jsx)("div",{className:"flex flex-wrap gap-1",children:o.map(e=>(0,r.jsx)("span",{className:"px-2 py-0.5 rounded-full bg-white/80 text-[10px] border border-gray-200",title:e.title,children:e.title},e.id))}),(0,r.jsx)("button",{onClick:()=>em(t=>t===e.id?null:e.id),className:"mt-2 text-[11px] text-blue-700 hover:text-blue-900 underline",children:eu===e.id?"Hide subparts":"Subparts"})]}),eu===e.id&&(0,r.jsxs)("div",{className:"absolute left-0 top-full mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg p-3 z-20 relative",children:[(0,r.jsx)("button",{onClick:()=>em(null),className:"absolute top-2 right-2 w-6 h-6 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 flex items-center justify-center text-sm","aria-label":"Close subparts",children:"\xd7"}),(0,r.jsxs)("div",{className:"text-xs font-semibold text-gray-800 mb-2 pr-6",children:["Subparts for ",e.name]}),(0,r.jsx)("div",{className:"space-y-2",children:o.map(t=>{var a,n;let s=eF(t);return(0,r.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-800 truncate",children:t.title}),(0,r.jsxs)("div",{className:"mt-1 flex items-center gap-1",children:[(0,r.jsx)("input",{className:"w-12 bg-white border border-gray-200 rounded px-1",value:null!=(a=es[t.id])?a:null!==s.start?k(s.start):"",onChange:e=>ei(a=>({...a,[t.id]:e.target.value})),onKeyDown:e=>{var a;if("Enter"!==e.key)return;let r=C(null!=(a=es[t.id])?a:"");null!==r&&(null!==s.end&&r>s.end||(eI(t,r,s.end),ei(e=>({...e,[t.id]:""}))))}}),(0,r.jsx)("input",{className:"w-12 bg-white border border-gray-200 rounded px-1",value:null!=(n=el[t.id])?n:null!==s.end?k(s.end):"",onChange:e=>ed(a=>({...a,[t.id]:e.target.value})),onKeyDown:e=>{var a;if("Enter"!==e.key)return;let r=C(null!=(a=el[t.id])?a:"");null!==r&&(null!==s.start&&r<s.start||(eI(t,s.start,r),ed(e=>({...e,[t.id]:""}))))}})]})]}),(0,r.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,r.jsx)("button",{onClick:()=>eR(e.id,t.id,"up"),className:"px-2 py-0.5 border border-gray-200 rounded text-[10px]",children:"Up"}),(0,r.jsx)("button",{onClick:()=>eR(e.id,t.id,"down"),className:"px-2 py-0.5 border border-gray-200 rounded text-[10px]",children:"Down"})]})]},t.id)})})]})]},e.id)})})]},e.id)),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("div",{className:"text-xs font-semibold text-gray-600",children:"Unassigned"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[0===eJ.unassigned.length&&(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"All parts assigned"}),eJ.unassigned.map(e=>(0,r.jsx)("div",{draggable:!0,onDragStart:t=>t.dataTransfer.setData("partId",e.id),className:"px-2 py-1 rounded text-xs cursor-move ".concat(eA[e.id]||"bg-gray-200 text-gray-800"),children:e.name},e.id))]})]})]})]})}),(0,r.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-[320px_1fr] gap-6",children:[(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,r.jsx)("div",{className:"text-xl font-bold text-gray-900 mb-2",children:"Parts & Subparts"}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-4",children:"Drop time chips onto Start/End. Only dropped chips change timepoints when saved."}),(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,r.jsx)("input",{type:"text",value:ej,onChange:e=>eN(e.target.value),placeholder:"Add part",className:"flex-1 px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("button",{onClick:async()=>{let e=ej.trim();if(!e)return;let r=((null==a?void 0:a.length)||0)+1,n=await fetch("/api/parts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:t,name:e,description:"",order:r})});n.ok&&(l([...a||[],await n.json()]),eN(""))},className:"px-2 py-1 bg-gray-900 text-white rounded text-xs",children:"Add"})]}),(0,r.jsx)("div",{className:"max-h-[70vh] overflow-y-auto pr-2 space-y-4",children:eq.map(e=>{var t,a;return(0,r.jsxs)("div",{className:"border border-gray-200 rounded-lg p-3",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-900 mb-2",children:e.name}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[eX("part",e.id,"start"),eX("part",e.id,"end")]}),(0,r.jsx)("input",{value:null!=(a=null!=(t=eb[e.id])?t:e.description)?a:"",onChange:t=>ef(a=>({...a,[e.id]:t.target.value})),onBlur:()=>{var t,a;return eO(e.id,null!=(a=null!=(t=eb[e.id])?t:e.description)?a:"")},placeholder:"Add part note...",className:"w-full px-2 py-1 border border-gray-200 rounded text-xs"}),(b[e.id]||[]).length>0&&(0,r.jsx)("div",{className:"mt-2 space-y-2",children:[...b[e.id]].sort((e,t)=>{var a,r;let n="number"==typeof e.timepoint_seconds?e.timepoint_seconds:1/0,s="number"==typeof t.timepoint_seconds?t.timepoint_seconds:1/0;return n!==s?n-s:(null!=(a=e.order)?a:0)-(null!=(r=t.order)?r:0)}).map(e=>{var t,a;return(0,r.jsxs)("div",{className:"border border-gray-100 rounded p-2 bg-gray-50",children:[(0,r.jsx)("div",{className:"text-sm font-semibold text-gray-800",children:e.title}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mt-2",children:[eX("subpart",e.id,"start"),eX("subpart",e.id,"end")]}),(0,r.jsx)("input",{value:null!=(a=null!=(t=ey[e.id])?t:e.description)?a:"",onChange:t=>ev(a=>({...a,[e.id]:t.target.value})),onBlur:()=>{var t,a;return eM(e.id,null!=(a=null!=(t=ey[e.id])?t:e.description)?a:"")},placeholder:"Add subpart note...",className:"w-full px-2 py-1 border border-gray-200 rounded text-xs mt-2"})]},e.id)})}),(0,r.jsxs)("div",{className:"mt-3 flex items-center gap-2",children:[(0,r.jsx)("input",{type:"text",value:v[e.id]||"",onChange:t=>j(a=>({...a,[e.id]:t.target.value})),placeholder:"Add subpart",className:"flex-1 px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("button",{onClick:async()=>{let t=(v[e.id]||"").trim();if(!t)return;let a=(b[e.id]||[]).length+1,r=await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:e.id,title:t,order:a})});if(r.ok){let t=await r.json();f(a=>({...a,[e.id]:[...a[e.id]||[],t].sort((e,t)=>{var a,r;let n="number"==typeof e.timepoint_seconds?e.timepoint_seconds:1/0,s="number"==typeof t.timepoint_seconds?t.timepoint_seconds:1/0;return n!==s?n-s:(null!=(a=e.order)?a:0)-(null!=(r=t.order)?r:0)})})),j(t=>({...t,[e.id]:""}))}},className:"px-2 py-1 bg-gray-900 text-white rounded text-xs",children:"Add"})]})]},e.id)})})]}),(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-3",children:[(0,r.jsx)("div",{className:"text-xl font-bold text-gray-900",children:"Marking Session"}),(0,r.jsxs)("div",{className:"ml-auto flex gap-2 items-center",children:[(0,r.jsx)("input",{value:_,onChange:e=>{S(e.target.value),D(!0)},className:"px-3 py-1 border border-gray-300 rounded text-sm",placeholder:"Session title"}),(0,r.jsx)("button",{onClick:eH,className:"px-3 py-1 bg-gray-900 text-white rounded text-sm",children:"Save Session"}),(0,r.jsx)("button",{onClick:eW,disabled:N,className:"px-3 py-1 bg-blue-600 text-white rounded text-sm disabled:bg-gray-400",children:N?"Saving...":"Apply Timepoints"})]})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-2",children:"Hotkeys: Space = mark time, E = new row. Works while music is playing or paused."}),(0,r.jsxs)("div",{className:"text-xs text-gray-500 mt-1",children:["Music length: ",R?k(R):"\xef\xbf\xbd"]}),(0,r.jsx)("div",{className:"mt-3 bg-gray-50 border border-dashed border-gray-300 rounded p-3 text-xs text-gray-500",children:"Waveform view: not available yet. We can add a waveform preview in a follow-up."}),(0,r.jsxs)("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[(0,r.jsxs)("select",{value:M,onChange:async e=>{let t=e.target.value;if(I(t),!t)return;let a=await fetch("/api/marking-sessions/".concat(t));if(!a.ok)return;let r=await a.json();S(r.title||"Marking Session"),D(!0);let n=(r.rows||[]).map(e=>({...e,note:e.note||""}));o(n),g(((e,t)=>{let a={};return Object.entries(t||{}).forEach(t=>{let[r,n]=t;if("string"==typeof n){let t=e.flatMap(e=>e.marks).find(e=>e.id===n);t&&(a[r]={markId:n,time:t.time})}else n&&"object"==typeof n&&(a[r]=n)}),a})(n,r.assignments||{}))},className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,r.jsx)("option",{value:"",children:"Load saved session..."}),P.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.title||"Untitled"," \xef\xbf\xbd ",A[e.performance_id]||"Performance"," \xef\xbf\xbd ",new Date(e.created_at).toLocaleString(void 0,{timeZone:c.GI,timeZoneName:"short"})]},e.id))]}),(0,r.jsxs)("label",{className:"text-xs text-gray-600 flex items-center gap-2",children:[(0,r.jsx)("input",{type:"checkbox",checked:F,onChange:e=>U(e.target.checked),className:"h-4 w-4"}),"Show sessions from all performances"]}),(0,r.jsx)("button",{onClick:()=>{let e={id:E(),label:"Row 1",note:"",marks:[]};o([e]),m(e.id),g({}),I(""),D(!1)},className:"px-2 py-1 border border-gray-300 rounded text-sm",children:"New Session"})]})]}),(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,r.jsx)("div",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Mark Chips"}),(0,r.jsx)("div",{className:"space-y-4",children:d.map(e=>(0,r.jsxs)("div",{onClick:()=>m(e.id),className:"border rounded-lg p-3 cursor-pointer ".concat(u===e.id?"border-blue-400 bg-blue-50":"border-gray-200"),children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,r.jsx)("button",{onClick:()=>m(e.id),className:"px-2 py-1 rounded text-xs font-semibold ".concat(u===e.id?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"),children:e.label}),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:"Drop chips into the empty slot to organize."}),d.length>1&&(0,r.jsx)("button",{onClick:t=>{if(t.stopPropagation(),o(t=>t.filter(t=>t.id!==e.id)),u===e.id){let t=d.find(t=>t.id!==e.id);m(t?t.id:null)}},className:"ml-auto text-xs text-red-600 hover:text-red-800",children:"Delete Row"})]}),(0,r.jsx)("input",{value:e.note||"",onChange:t=>o(a=>a.map(a=>a.id===e.id?{...a,note:t.target.value}:a)),placeholder:"Row notes...",className:"w-full px-2 py-1 border border-gray-200 rounded text-xs mb-2"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[e.marks.map(t=>{let a=eE[t.id]||0;return(0,r.jsx)("div",{draggable:!0,onDragStart:e=>{e.dataTransfer.setData("markId",t.id)},className:"px-2 py-1 rounded text-xs cursor-move ".concat(a>=2?"bg-gray-200 text-gray-700":1===a?"bg-yellow-200 text-yellow-900":"bg-indigo-100 text-indigo-800"),children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{children:k(t.time)}),(0,r.jsx)("button",{onClick:()=>{var a,r;return a=e.id,r=t.id,void o(e=>e.map(e=>e.id===a?{...e,marks:e.marks.filter(e=>e.id!==r)}:e))},className:"text-[10px] text-gray-600 hover:text-gray-800",title:"Remove chip",children:"\xef\xbf\xbd"})]})},t.id)}),(0,r.jsx)("div",{className:"px-2 py-1 border border-dashed border-gray-300 rounded text-xs text-gray-500",onDragOver:e=>e.preventDefault(),onDrop:t=>{let a=t.dataTransfer.getData("markId");if(a){var r;r=e.id,o(e=>{let t=null,n=e.map(e=>{let r=e.marks.filter(e=>e.id!==a||(t=e,!1));return{...e,marks:r}});return t?n.map(e=>e.id===r?{...e,marks:[...e.marks,t]}:e):e})}},children:"Empty slot"})]}),(0,r.jsxs)("div",{className:"mt-2 text-[11px] text-gray-500",children:["Times:"," ",0===e.marks.length?"\xef\xbf\xbd":e.marks.map(e=>k(e.time)).join(", ")]})]},e.id))})]}),(0,r.jsx)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:(0,r.jsx)(y,{musicUrl:s||void 0,onTimeUpdate:e=>x(e),onAudioReady:e=>{if(q.current&&q.current(),!e){J(null),q.current=null;return}let t=()=>{J(Number.isFinite(e.duration)?e.duration:null)};e.addEventListener("loadedmetadata",t),e.addEventListener("durationchange",t),t(),q.current=()=>{e.removeEventListener("loadedmetadata",t),e.removeEventListener("durationchange",t)}},audioRef:z})})]})]})]})}function D(e){let{performanceId:t}=e,[a,s]=(0,n.useState)([]),[i,l]=(0,n.useState)([]),[d,o]=(0,n.useState)([]),[u,m]=(0,n.useState)(!0),[p,x]=(0,n.useState)({}),[h,g]=(0,n.useState)(null),[b,f]=(0,n.useState)({}),y=(0,n.useCallback)(async()=>{m(!0);try{let[e,a,r,n]=await Promise.all([fetch("/api/uniform-types"),fetch("/api/uniform-items"),fetch("/api/performances/".concat(t,"/roster")),fetch("/api/performances")]),[i,d,c,u]=await Promise.all([e.ok?e.json():[],a.ok?a.json():[],r.ok?r.json():[],n.ok?n.json():[]]);s(i||[]),l(d||[]),o(c||[]);let m={};(u||[]).forEach(e=>{(null==e?void 0:e.id)&&(m[e.id]={title:e.title||e.name||e.id,date:e.date||null})}),f(m)}finally{m(!1)}},[t]);(0,n.useEffect)(()=>{y()},[y]);let v=(0,n.useMemo)(()=>{let e={};return i.forEach(t=>{e[t.uniform_type_id]=e[t.uniform_type_id]||[],e[t.uniform_type_id].push(t)}),Object.values(e).forEach(e=>e.sort((e,t)=>e.item_number.localeCompare(t.item_number))),e},[i]),j=(0,n.useMemo)(()=>[...d].sort((e,t)=>e.name.localeCompare(t.name)),[d]),N=(0,n.useMemo)(()=>{let e={};return i.forEach(t=>{e[t.id]=t}),e},[i]),w=(0,n.useMemo)(()=>{let e={};return a.forEach(t=>{e[t.id]=t}),e},[a]),_=(0,n.useMemo)(()=>{var e;let a=null==(e=b[t])?void 0:e.date;if(!a)return null;let r=new Date(a).getTime();return Number.isFinite(r)?r:null},[t,b]),S=e=>{var t;return e?(null==(t=b[e])?void 0:t.title)||e:"Unknown performance"},k=(0,n.useMemo)(()=>{let e={};return i.forEach(t=>{let a=(t.uniform_assignments||[]).find(e=>e.distributed_at&&!e.returned_at&&e.student_id);(null==a?void 0:a.student_id)&&(e[a.student_id]=e[a.student_id]||[],e[a.student_id].push(t))}),e},[i]),C=e=>e&&(e.uniform_assignments||[]).find(e=>!e.returned_at)||null,E=(e,t)=>(e.uniform_assignments||[]).find(e=>!e.returned_at&&e.performance_id===t)||null,T=e=>e?(e.uniform_assignments||[]).filter(e=>!e.returned_at):[],D=e=>{let t=new Map;return i.forEach(a=>{let r=(a.uniform_assignments||[]).filter(t=>t.student_id===e);r.length>0&&(r.sort((e,t)=>{let a=new Date(e.distributed_at||e.returned_at||0).getTime();return new Date(t.distributed_at||t.returned_at||0).getTime()-a}),t.set(a.id,r))}),t},P=async(e,a)=>{if(!a){let a=e.assigned_uniform_item_id&&N[e.assigned_uniform_item_id]||null;if(a){let r=(a.uniform_assignments||[]).find(a=>a.performance_id===t&&a.student_id===e.student_id&&!a.returned_at);if(null==r?void 0:r.distributed_at)return void alert("Cannot clear an assignment that is already distributed.");(null==r?void 0:r.id)&&await fetch("/api/uniform-assignments/".concat(r.id),{method:"DELETE"})}}if(a){let r=N[a];if(((null==r?void 0:r.uniform_assignments)||[]).find(a=>a.performance_id===t&&!a.returned_at&&a.student_id!==e.student_id))return void alert("Uniform already assigned for this performance.")}if(!(await fetch("/api/signups/".concat(e.signup_id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({assigned_uniform_item_id:a})})).ok)return void alert("Failed to assign uniform");if(o(t=>t.map(t=>t.signup_id===e.signup_id?{...t,assigned_uniform_item_id:a}:t)),a){let r=N[a],n=((null==r?void 0:r.uniform_assignments)||[]).find(a=>a.performance_id===t&&a.student_id===e.student_id&&!a.returned_at);if(n){if(!n.distributed_at){let t=T(r).find(t=>t.student_id===e.student_id&&!!t.distributed_at);(null==t?void 0:t.distributed_at)&&await fetch("/api/uniform-assignments/".concat(n.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({distributed_at:t.distributed_at,returned_at:null})})}}else{let n=T(r).find(t=>t.student_id===e.student_id&&!!t.distributed_at),s=(null==n?void 0:n.distributed_at)||null,i=await fetch("/api/uniform-assignments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uniform_item_id:a,student_id:e.student_id,student_name:e.name,performance_id:t,distributed_at:s})});if(!i.ok){let e=await i.json().catch(()=>({}));(null==e?void 0:e.error)&&alert(e.error)}}}},O=async(e,a)=>{let r=C(a),n=E(a,t);if(r){if(r.student_id!==e.student_id||r.performance_id!==t)return void alert("Uniform is already assigned to ".concat(r.student_name||"someone else",". Return it first."));else if(r.distributed_at)return void alert("Uniform is already marked as given to this student for this performance.")}if(window.confirm("Mark uniform #".concat(a.item_number," as given to ").concat(e.name,"?"))){if(!(n&&!n.distributed_at?await fetch("/api/uniform-assignments/".concat(n.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({distributed_at:new Date().toISOString(),returned_at:null})}):await fetch("/api/uniform-assignments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uniform_item_id:a.id,student_id:e.student_id,student_name:e.name,performance_id:t,distributed_at:new Date().toISOString()})})).ok)return void alert("Failed to mark as given");await y()}},M=async e=>{let a=E(e,t);if(a&&a.distributed_at&&window.confirm("Mark uniform #".concat(e.item_number," as returned from ").concat(a.student_name||"someone","?"))){if(!(await fetch("/api/uniform-assignments/".concat(a.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({returned_at:new Date().toISOString()})})).ok)return void alert("Failed to mark as returned");await y()}};return u?(0,r.jsx)("div",{className:"text-gray-600",children:"Loading uniforms..."}):(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,r.jsx)("div",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Uniform choices"}),(0,r.jsxs)("div",{className:"space-y-3",children:[0===a.length&&(0,r.jsx)("div",{className:"text-sm text-gray-500",children:"No uniform types yet."}),a.map(e=>(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-xs font-semibold text-gray-500 uppercase mb-2",children:e.name}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(v[e.id]||[]).slice().sort((e,t)=>e.item_number.localeCompare(t.item_number)).map(t=>{(e=>{if(!e)return;let t=(e.uniform_assignments||[]).slice();return t.sort((e,t)=>new Date(t.distributed_at||0).getTime()-new Date(e.distributed_at||0).getTime()),t[0]})(t);let a=C(t),n=a?a.distributed_at?"Distributed to ".concat(a.student_name||"Unknown"):"Assigned to ".concat(a.student_name||"Unknown"):"On hand",s=!!(a&&a.distributed_at),i=e.color||"#0f172a";return(0,r.jsxs)("span",{draggable:!0,onDragStart:e=>{e.dataTransfer.setData("uniformItemId",t.id)},title:n,className:"px-3 py-1 rounded-full text-xs font-semibold text-white cursor-grab ".concat(s?"bg-black ring-2 ring-yellow-400":""),style:s?void 0:{backgroundColor:i},children:[e.name," #",t.item_number,s&&(0,r.jsxs)("span",{className:"ml-2 text-[10px] font-semibold",children:["(Distributed to ",(null==a?void 0:a.student_name)||"Unknown",")"]})]},t.id)}),0===(v[e.id]||[]).length&&(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"No items"})]})]},e.id))]})]}),(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:[(0,r.jsxs)("div",{className:"grid grid-cols-6 gap-0 text-xs font-semibold uppercase tracking-wide text-gray-500 bg-gray-50 border-b border-gray-200",children:[(0,r.jsx)("div",{className:"px-3 py-2",children:"Student"}),(0,r.jsx)("div",{className:"px-3 py-2",children:"Assigned"}),(0,r.jsx)("div",{className:"px-3 py-2",children:"Status"}),(0,r.jsx)("div",{className:"px-3 py-2",children:"Next Use"}),(0,r.jsx)("div",{className:"px-3 py-2",children:"Given"}),(0,r.jsx)("div",{className:"px-3 py-2",children:"Returned"})]}),0===j.length&&(0,r.jsx)("div",{className:"p-4 text-sm text-gray-500",children:"No roster yet."}),(0,r.jsx)("div",{className:"max-h-[420px] overflow-y-auto",children:j.map(e=>{var a,n,s,l,d;let o=e.assigned_uniform_item_id&&N[e.assigned_uniform_item_id]||null,u=o?C(o):null,m=o?E(o,t):null,h=o?((e,t)=>{let a=(e.uniform_assignments||[]).filter(e=>e.performance_id===t);return a.sort((e,t)=>new Date(t.distributed_at||0).getTime()-new Date(e.distributed_at||0).getTime()),a[0]||null})(o,t):null,f=!!(o&&u&&u.student_id&&u.student_id!==e.student_id),y=T(o).find(t=>t.student_id===e.student_id&&!!t.distributed_at),v=(null==y?void 0:y.distributed_at)||null,j=!!(m&&m.distributed_at)||!!v,D=!!(h&&h.returned_at),I=!!(o&&!j&&!D),F=o?f?"bg-red-100 text-red-700 border-red-300":j?"bg-black text-white border-yellow-400 ring-2 ring-yellow-400":"text-white border-transparent":"bg-gray-100 text-gray-600 border-gray-200",U=o?D?"Returned":j?"Given to ".concat((null==m?void 0:m.student_name)||e.name):"Assigned":"Unassigned",A=o?D?"Returned ".concat((0,c.P9)(h.returned_at,c.GI)):j?"Given ".concat((0,c.P9)((null==m?void 0:m.distributed_at)||v,c.GI)):I?"Assigned":null:null,L=o?D?"bg-blue-100 text-blue-700 border-blue-300":j?"bg-gray-700 text-white border-gray-700":"bg-amber-100 text-amber-700 border-amber-300":"bg-gray-100 text-gray-600 border-gray-200",R=((e,t)=>{if(!e)return null;let a=null!=_?_:Date.now(),r=(e.uniform_assignments||[]).filter(e=>!e.returned_at&&e.performance_id).map(e=>({assign:e,time:(e=>{var t;if(!e)return null;let a=null==(t=b[e])?void 0:t.date;if(!a)return null;let r=new Date(a).getTime();return Number.isFinite(r)?r:null})(e.performance_id||null)})).filter(e=>null!==e.time&&e.time>a).sort((e,t)=>e.time-t.time);return 0===r.length?null:r[0].assign})(o,e.student_id),J=!!(R&&R.student_id===e.student_id),q=(null==R?void 0:R.performance_id)&&(null==(a=b[R.performance_id])?void 0:a.date)||null,z=R?J?"".concat(e.name," is assigned for ").concat(S(R.performance_id||null)).concat(q?" (".concat((0,c.P9)(q,c.GI),")"):""," coming up."):"Warning: ".concat(S(R.performance_id||null)).concat(q?" (".concat((0,c.P9)(q,c.GI),")"):""," needs this uniform for ").concat(R.student_name||"another student","."):"—";return(0,r.jsxs)("div",{className:"grid grid-cols-6 gap-0 border-b border-gray-200 last:border-b-0 text-sm",children:[(0,r.jsxs)("div",{className:"px-3 py-3 font-semibold text-gray-900 flex items-center gap-2",children:[(0,r.jsx)("span",{children:e.name}),!J&&R&&(0,r.jsx)("span",{className:"inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-700 text-xs font-bold",children:"!"}),(0,r.jsx)("button",{type:"button",onClick:()=>g(e),className:"text-[10px] px-2 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300",children:"History"})]}),(0,r.jsx)("div",{className:"px-3 py-3",onDragOver:e=>e.preventDefault(),onDrop:t=>{let a=t.dataTransfer.getData("uniformItemId");if(!a)return;let r=N[a],n=r?C(r):null;if(n&&n.distributed_at){let t=(n.student_name||"").trim().toLowerCase(),a=e.name.trim().toLowerCase();if(!t||t!==a)return void alert("Uniform #".concat((null==r?void 0:r.item_number)||""," is already distributed to ").concat(n.student_name||"someone","."))}P(e,a)},children:o?(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)("span",{className:"px-3 py-1 rounded-full text-xs font-semibold border ".concat(F),style:{backgroundColor:o&&!j&&(null==(n=w[o.uniform_type_id])?void 0:n.color)||void 0},children:[(null==(s=w[o.uniform_type_id])?void 0:s.name)||"Uniform"," #",o.item_number]}),f&&(0,r.jsx)("span",{className:"text-[10px] font-semibold text-red-600",children:"Not available"}),(0,r.jsx)("button",{onClick:()=>P(e,null),className:"text-[10px] text-gray-500 hover:text-gray-700",children:"Clear"})]}):(0,r.jsxs)("div",{className:"w-full",children:[(null==(l=k[e.student_id])?void 0:l.length)?(0,r.jsxs)("div",{className:"mb-2 text-[11px] text-amber-700",children:["Currently holding:"," ",k[e.student_id].map(e=>{var t;let a=(null==(t=w[e.uniform_type_id])?void 0:t.name)||"Uniform";return"".concat(a," #").concat(e.item_number)}).join(", ")]}):null,(0,r.jsx)("input",{value:p[e.signup_id]||"",onChange:t=>x(a=>({...a,[e.signup_id]:t.target.value})),list:"uniform-options-".concat(e.signup_id),placeholder:(null==(d=k[e.student_id])?void 0:d.length)?"Currently holding: ".concat(k[e.student_id].map(e=>e.item_number).join(", ")):"Drop uniform here or type code",className:"w-full px-2 py-1 border border-dashed border-gray-300 rounded text-xs text-gray-700"}),(0,r.jsx)("datalist",{id:"uniform-options-".concat(e.signup_id),children:i.map(e=>(0,r.jsx)("option",{value:e.item_number},e.id))}),(0,r.jsx)("div",{className:"mt-1 flex flex-wrap gap-2 text-[10px] text-gray-600",children:i.filter(t=>!!(p[e.signup_id]||"").trim()&&t.item_number.toLowerCase().includes((p[e.signup_id]||"").trim().toLowerCase())).slice(0,3).map(a=>(0,r.jsxs)("span",{className:"px-2 py-1 bg-gray-100 rounded-full",children:[a.item_number," (",(e=>{let a=T(e);if(0===a.length)return"On hand";if(a.length>1)return"Assigned in multiple performances";let r=a[0];return r.distributed_at?"Distributed to ".concat(r.student_name||"Unknown").concat(r.performance_id&&r.performance_id!==t?" (other performance)":""):"Assigned to ".concat(r.student_name||"Unknown").concat(r.performance_id&&r.performance_id!==t?" (other performance)":"")})(a),")"]},"".concat(e.signup_id,"-").concat(a.id)))}),(0,r.jsx)("div",{className:"mt-1",children:(0,r.jsx)("button",{type:"button",onClick:()=>{let t=(p[e.signup_id]||"").trim();if(!t)return;let a=i.find(e=>e.item_number.toLowerCase()===t.toLowerCase());if(!a)return void alert("Uniform not found.");P(e,a.id)},className:"px-2 py-1 text-xs rounded bg-gray-800 text-white",children:"Assign"})})]})}),(0,r.jsxs)("div",{className:"px-3 py-3 text-xs text-gray-700",children:[(0,r.jsx)("div",{children:(0,r.jsx)("span",{className:"inline-flex px-2 py-1 rounded-full border text-[10px] font-semibold ".concat(L),children:U})}),A&&(0,r.jsx)("div",{className:"text-[10px] text-gray-500",children:A})]}),(0,r.jsx)("div",{className:"px-3 py-3 text-[11px] text-gray-700",children:(0,r.jsx)("div",{className:R&&!J?"border border-red-300 bg-red-50 text-red-700 rounded px-2 py-1":"",children:z})}),(0,r.jsx)("div",{className:"px-3 py-3",children:(0,r.jsx)("button",{onClick:()=>o&&O(e,o),disabled:!o||!!(m&&m.student_id===e.student_id&&m.distributed_at),className:"px-3 py-1 rounded text-xs bg-emerald-600 text-white disabled:bg-gray-300",children:j?"Given":"Give to ".concat(e.name)})}),(0,r.jsxs)("div",{className:"px-3 py-3 flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>o&&M(o),disabled:!o||!m||!m.distributed_at,className:"px-3 py-1 rounded text-xs bg-blue-600 text-white disabled:bg-gray-300",children:D?"Returned ✓":"Not Returned"}),!D&&R&&!J&&(0,r.jsx)("span",{className:"inline-flex items-center justify-center w-5 h-5 rounded-full bg-amber-100 text-amber-700 text-xs font-bold",children:"!"})]})]},e.signup_id)})})]}),h&&(0,r.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4 w-full max-w-2xl shadow-lg",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Uniform History"}),(0,r.jsx)("div",{className:"text-lg font-semibold text-gray-900",children:h.name})]}),(0,r.jsx)("button",{type:"button",onClick:()=>g(null),className:"text-xs text-gray-500 hover:text-gray-700",children:"Close"})]}),(0,r.jsxs)("div",{className:"mt-3 max-h-[70vh] overflow-y-auto space-y-3 text-sm text-gray-700",children:[Array.from(D(h.student_id).entries()).map(e=>{let[t,a]=e,n=N[t];return(0,r.jsxs)("div",{className:"border border-gray-200 rounded p-3",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-900",children:n?"#".concat(n.item_number):"Uniform Item"}),(0,r.jsx)("div",{className:"mt-2 space-y-2",children:a.map(e=>{var t;return(0,r.jsxs)("div",{className:"text-xs text-gray-600",children:[e.performance_id&&(0,r.jsxs)("div",{children:["Performance: ",(null==(t=b[e.performance_id])?void 0:t.title)||e.performance_id]}),(0,r.jsxs)("div",{children:["Assigned:"," ",e.distributed_at||e.returned_at?(0,c.P9)(e.distributed_at||e.returned_at||"",c.GI):"—"]}),(0,r.jsxs)("div",{children:["Distributed:"," ",e.distributed_at?(0,c.P9)(e.distributed_at,c.GI):"—"]}),(0,r.jsxs)("div",{children:["Returned:"," ",e.returned_at?(0,c.P9)(e.returned_at,c.GI):"—"]})]},e.id)})})]},t)}),0===D(h.student_id).size&&(0,r.jsx)("div",{className:"text-sm text-gray-500",children:"No uniform history for this student."})]})]})})]})}var P=a(2992);function O(e){var t,a,s,o,u,m,x,g;let{params:v}=e,{id:k}=(0,n.use)(v),C="rehearse:performance-info:".concat(k),E=(0,P.C_)(C),[O,F]=(0,n.useState)(null),[U,A]=(0,n.useState)(!0),[L,R]=(0,n.useState)("rehearsals"),[J,q]=(0,n.useState)(!1),[z,G]=(0,n.useState)(!1),[Z,B]=(0,n.useState)(null),[X,H]=(0,n.useState)(null),[W,K]=(0,n.useState)(!1),[Y,Q]=(0,n.useState)(!1),[V,$]=(0,n.useState)(!1),[ee,et]=(0,n.useState)(!0),[ea,er]=(0,n.useState)(!1),[en,es]=(0,n.useState)(null),[ei,el]=(0,n.useState)((null==E?void 0:E.infoForm)||{title:"",call_time:"",timezone:"America/New_York",date:"",location:"",description:"",phone_numbers:""}),[ed,eo]=(0,n.useState)(null!=(m=null==E?void 0:E.callTimeManual)&&m),[ec,eu]=(0,n.useState)((null==E?void 0:E.savedAt)||null),em=(0,n.useRef)(null),ep=(0,n.useRef)(!!E),[ex,eh]=(0,n.useState)([]),[eg,eb]=(0,n.useState)(""),[ef,ey]=(0,n.useState)(""),[ev,ej]=(0,n.useState)([]),[eN,ew]=(0,n.useState)(""),{rehearsals:e_,createRehearsal:eS,deleteRehearsal:ek,updateRehearsal:eC}=l(k),{parts:eE,createPart:eT,deletePart:eD,setParts:eP}=function(e){let[t,a]=(0,n.useState)([]),[r,s]=(0,n.useState)(!0),[i,l]=(0,n.useState)(null);(0,n.useEffect)(()=>{if(!e){a([]),s(!1);return}!async function(){try{let t=await fetch("/api/parts?performanceId=".concat(e));if(!t.ok)throw Error("Failed to fetch parts");let r=await t.json();a(r)}catch(e){l(e instanceof Error?e.message:"An error occurred")}finally{s(!1)}}()},[e]);let d=async(r,n,s,i)=>{if(!e)throw Error("Performance ID is required");try{let l=await fetch("/api/parts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:e,name:r,description:n,order:s,is_group:i})});if(!l.ok)throw Error("Failed to create part");let d=await l.json();return a([...t,d]),d}catch(e){throw l(e instanceof Error?e.message:"An error occurred"),e}},o=async e=>{try{if(!(await fetch("/api/parts/".concat(e),{method:"DELETE"})).ok)throw Error("Failed to delete part");a(t.filter(t=>t.id!==e))}catch(e){throw l(e instanceof Error?e.message:"An error occurred"),e}};return{parts:t,loading:r,error:i,createPart:d,deletePart:o,setParts:a}}(k),{performances:eO}=(0,d.f)(),eM=(e,t)=>(0,c.y7)(e,t||"America/New_York");(0,n.useEffect)(()=>{!async function(){try{let e=await fetch("/api/performances/".concat(k));if(!e.ok)throw Error("Failed to fetch performance");let t=await e.json();F(t);let a=t.timezone||"America/New_York",r=t.date?eM(t.date,a):"";if(ep.current||(el({title:t.title||"",call_time:t.call_time||(r?(0,c.Kb)(r):""),timezone:a,date:r,location:t.location||"",description:t.description||"",phone_numbers:t.phone_numbers||""}),eo(!!t.call_time)),t.music_file_path){let e="".concat("https://quqvudqzztlmgrwqudho.supabase.co","/storage/v1/object/public/performance-music/").concat(t.music_file_path);H(e)}let n=await fetch("/api/performance-contacts?performanceId=".concat(k));if(n.ok){let e=await n.json();eh(e||[])}let s=await fetch("/api/performance-contacts/all");if(s.ok){let e=await s.json();ej(e||[])}}catch(e){console.error("Error fetching performance:",e)}finally{A(!1)}}()},[k]),(0,n.useEffect)(()=>(em.current&&clearTimeout(em.current),em.current=setTimeout(()=>{let e=new Date().toISOString();(0,P.J1)(C,{infoForm:ei,callTimeManual:ed,savedAt:e}),eu(e)},400),()=>{em.current&&clearTimeout(em.current)}),[ei,ed,C]),(0,n.useEffect)(()=>{"positioning"===L&&eE.length>0&&!Z&&B(eE[0].id)},[L,eE,Z]);let eI=(0,n.useMemo)(()=>(0,c.eL)(ei.date,ei.timezone),[ei.date,ei.timezone]),eF=async()=>{try{$(!0);let e=await fetch("/api/rehearse-export?performanceId=".concat(k,"&embedAudio=").concat(ee?"1":"0"));if(!e.ok){let t=await e.text();throw console.error("Export error:",e.status,t),Error("Failed to export rehearse HTML")}let t=await e.blob(),a=URL.createObjectURL(t),r=((null==O?void 0:O.title)||"rehearse-export").toString().replace(/[^a-z0-9]+/gi,"-").replace(/^-+|-+$/g,"").toLowerCase(),n=document.createElement("a");n.href=a,n.download="".concat(r||"rehearse-export",".html"),document.body.appendChild(n),n.click(),n.remove(),URL.revokeObjectURL(a)}catch(e){console.error("Export failed:",e),alert("Failed to export rehearse HTML")}finally{$(!1)}};return U?(0,r.jsx)("div",{className:"min-h-screen bg-gray-100 p-6",children:(0,r.jsx)("p",{className:"text-gray-600",children:"Loading..."})}):O?(0,r.jsxs)("div",{className:"min-h-screen bg-gray-100",children:[(0,r.jsx)("nav",{className:"bg-blue-900 text-white p-4 shadow-lg",children:(0,r.jsxs)("div",{className:"max-w-7xl mx-auto flex justify-between items-center",children:[(0,r.jsx)(N.AppBrand,{href:"/"}),(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsx)(i(),{href:"/admin",className:"hover:bg-blue-800 px-3 py-2 rounded",children:"Admin Panel"}),(0,r.jsx)(_.$,{className:"px-3 py-2 bg-blue-700 rounded hover:bg-blue-600 text-sm"})]})]})}),(0,r.jsxs)("div",{className:"flex min-h-[calc(100vh-64px)]",children:[(0,r.jsx)("div",{className:"hidden md:block w-64 bg-white shadow-md p-6 overflow-y-auto border-r border-gray-200",children:(0,r.jsx)(h,{performanceId:k})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0 p-6",children:[(0,r.jsxs)("div",{className:"md:hidden mb-4 flex items-center justify-between",children:[(0,r.jsx)("button",{onClick:()=>Q(!0),className:"px-3 py-2 bg-gray-900 text-white rounded text-sm",children:"Open Roster"}),(0,r.jsx)("div",{className:"text-[11px] text-gray-500",children:"Tip: Rotate your phone for a better view."})]}),(0,r.jsxs)("div",{className:"".concat("positioning"===L||"marking"===L?"max-w-none mx-0":"max-w-5xl mx-auto"),children:[(0,r.jsxs)("div",{className:"mb-8",children:[(0,r.jsx)(i(),{href:"/admin",className:"text-blue-600 hover:underline mb-4 block",children:"← Back to Dashboard"}),(0,r.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:O.title}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-gray-600",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-semibold",children:"Date:"})," ",(null==O?void 0:O.date)?(0,c.P9)(O.date,ei.timezone):"—"]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-semibold",children:"Location:"})," ",O.location]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-semibold",children:"Timezone:"})," ",ei.timezone]})]}),O.description&&(0,r.jsxs)("div",{className:"mt-4 text-gray-600",children:[(0,r.jsx)("span",{className:"font-semibold",children:"Description:"})," ",O.description]})]}),(0,r.jsxs)("div",{className:"flex gap-4 mb-8 flex-wrap",children:[(0,r.jsx)("button",{onClick:()=>R("rehearsals"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("rehearsals"===L?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Rehearsals"}),(0,r.jsx)("button",{onClick:()=>R("parts"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("parts"===L?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Parts/Choreography"}),(0,r.jsx)("button",{onClick:()=>{R("positioning"),eE.length>0&&!Z&&B(eE[0].id)},className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("positioning"===L?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Stage Positions"}),(0,r.jsx)("button",{onClick:()=>R("music"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("music"===L?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Music & Rehearse"}),(0,r.jsx)("button",{onClick:()=>R("marking"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("marking"===L?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Marking"}),(0,r.jsx)("button",{onClick:()=>R("uniforms"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("uniforms"===L?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Uniforms"}),(0,r.jsx)("button",{onClick:()=>R("info"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("info"===L?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Performance Info"})]}),"positioning"===L?(0,r.jsx)("div",{className:"flex flex-col gap-6",children:(0,r.jsx)("div",{className:"bg-white rounded-lg shadow-md p-8",children:0===eE.length?(0,r.jsxs)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:[(0,r.jsx)("p",{className:"text-gray-600 mb-4",children:"No parts created yet."}),(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"Create parts first before positioning students."})]}):Z&&(0,r.jsx)(b,{performanceId:k,partId:Z,partName:null==(t=eE.find(e=>e.id===Z))?void 0:t.name,partDescription:null==(a=eE.find(e=>e.id===Z))?void 0:a.description,partTimepointSeconds:null!=(x=null==(s=eE.find(e=>e.id===Z))?void 0:s.timepoint_seconds)?x:null,partTimepointEndSeconds:null!=(g=null==(o=eE.find(e=>e.id===Z))?void 0:o.timepoint_end_seconds)?g:null,isGroup:(null==(u=eE.find(e=>e.id===Z))?void 0:u.is_group)!==!1,onSavePositions:async e=>{let t=e.map(e=>({part_id:Z,student_id:e.student_id,x:e.x,y:e.y}));if(!(await fetch("/api/stage-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:Z,positions:t})})).ok)throw Error("Failed to save positions")}})})}):(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-8",children:["rehearsals"===L&&(0,r.jsx)(M,{rehearsals:e_,showForm:J,onToggleForm:()=>q(!J),onCreateRehearsal:eS,onDeleteRehearsal:ek,onUpdateRehearsal:eC}),"parts"===L&&(0,r.jsx)(I,{performanceId:k,parts:eE,performances:eO,showForm:z,onToggleForm:()=>G(!z),onCreatePart:eT,onDeletePart:eD,onReorderParts:eP,musicUrl:X}),"music"===L&&(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)(f,{performanceId:k,performanceTitle:O.title,currentMusicFile:O.music_file_name,onUploadSuccess:(e,t)=>{H(t),F({...O,music_file_name:e.split("/").pop()})}}),X&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Preview Music"}),(0,r.jsx)(y,{musicUrl:X,performanceTitle:O.title})]}),(0,r.jsxs)("div",{className:"bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-lg border-2 border-purple-200",children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"\uD83C\uDFAD Rehearse/Emulate Mode"}),(0,r.jsx)("p",{className:"text-gray-700 mb-4",children:"Use rehearse mode to play back your choreography with automatic grid transitions based on music timepoints."}),(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-3",children:[(0,r.jsx)("button",{disabled:!X||0===eE.length,onClick:()=>K(!0),className:"px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-semibold",children:"Start Rehearse Mode →"}),(0,r.jsx)("button",{disabled:!X||0===eE.length||V,onClick:eF,className:"px-6 py-3 bg-white text-purple-700 border border-purple-300 rounded-lg hover:bg-purple-50 disabled:bg-gray-100 disabled:text-gray-400 disabled:border-gray-200 font-semibold",children:V?"Exporting...":"Export Rehearse HTML"}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-purple-900",children:[(0,r.jsx)("input",{type:"checkbox",checked:ee,onChange:e=>et(e.target.checked),className:"h-4 w-4"}),"Embed audio in export"]})]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mt-2",children:[!X&&"⚠️ Upload music first",X&&0===eE.length&&"⚠️ Create parts and set timepoints",X&&eE.length>0&&"✓ Ready to rehearse"]})]}),eE.length>0&&(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Part Timepoints"}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("p",{className:"text-gray-600 text-sm",children:'Click "Edit" on a part to set its music timepoint (when the part should appear during rehearsal).'}),(0,r.jsxs)("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[(0,r.jsx)("p",{className:"font-semibold text-blue-900 mb-2",children:"\uD83D\uDCCB Parts Timeline:"}),(0,r.jsx)("div",{className:"space-y-2",children:eE.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,r.jsx)("span",{className:"font-medium text-gray-900",children:e.name}),e.timepoint_seconds?(0,r.jsxs)("span",{className:"text-amber-700 bg-amber-100 px-2 py-1 rounded",children:["Start: ",e.timepoint_seconds,"s",e.timepoint_end_seconds?" - End: ".concat(e.timepoint_end_seconds,"s"):""]}):(0,r.jsx)("span",{className:"text-gray-400 italic",children:"No timepoint set"})]},e.id))})]})]})]})]}),"marking"===L&&(0,r.jsx)(T,{performanceId:k,parts:eE,musicUrl:X,performanceTitle:null==O?void 0:O.title,onPartsUpdated:e=>eP(e)}),"uniforms"===L&&(0,r.jsx)(D,{performanceId:k}),"info"===L&&(0,r.jsx)("div",{className:"space-y-6",children:(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Performance Info"}),en&&(0,r.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:en}),ec&&(0,r.jsxs)("div",{className:"text-xs text-gray-500 mb-3",children:["Draft saved ",new Date(ec).toLocaleString(void 0,{timeZone:c.GI,timeZoneName:"short"}),"."]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Performance Name"}),(0,r.jsx)("input",{type:"text",value:ei.title,onChange:e=>el(t=>({...t,title:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Date & Time"}),(0,r.jsx)("input",{type:"datetime-local",value:ei.date,onChange:e=>{let t=e.target.value;el(e=>({...e,date:t,call_time:ed?e.call_time:(0,c.Kb)(t)})),ed||t||el(e=>({...e,call_time:""}))},className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Call Time"}),(0,r.jsx)("input",{type:"time",value:ei.call_time,onChange:e=>{eo(!0),el(t=>({...t,call_time:e.target.value}))},disabled:eI,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),eI&&(0,r.jsx)("div",{className:"text-xs text-amber-700 mt-1",children:"Call time is locked within 1 hour of the performance."})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Timezone"}),(0,r.jsx)("input",{type:"text",value:ei.timezone,onChange:e=>el(t=>({...t,timezone:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:"Use IANA format (e.g., America/New_York)"})]}),(0,r.jsxs)("div",{className:"md:col-span-2",children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Location"}),(0,r.jsx)(S.e,{value:ei.location,onChange:e=>el(t=>({...t,location:e})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Description"}),(0,r.jsx)("textarea",{rows:3,value:ei.description,onChange:e=>el(t=>({...t,description:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Important Phone Numbers"}),(0,r.jsx)("textarea",{rows:4,placeholder:"One per line",value:ei.phone_numbers,onChange:e=>el(t=>({...t,phone_numbers:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,r.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2 items-center",children:[(0,r.jsxs)("select",{value:eN,onChange:e=>ew(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,r.jsx)("option",{value:"",children:"Add saved contact..."}),ev.map(e=>(0,r.jsxs)("option",{value:"".concat(e.name,"||").concat(e.phone),children:[e.name," • ",e.phone]},"".concat(e.name,"-").concat(e.phone)))]}),(0,r.jsx)("button",{onClick:()=>{if(!eN)return;let[e,t]=eN.split("||"),a="".concat(e,": ").concat(t);el(e=>({...e,phone_numbers:e.phone_numbers?"".concat(e.phone_numbers,"\n").concat(a):a})),ew("")},className:"px-3 py-1 bg-gray-900 text-white rounded text-xs",children:"Add to phone list"})]})]}),(0,r.jsxs)("div",{className:"mt-6 border-t border-gray-200 pt-4",children:[(0,r.jsx)("h4",{className:"font-semibold text-gray-900 mb-2",children:"Contacts Directory"}),(0,r.jsx)("p",{className:"text-sm text-gray-600 mb-3",children:"Add contacts and select which ones appear in the export."}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2 items-center mb-3",children:[(0,r.jsxs)("select",{value:eN,onChange:e=>ew(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,r.jsx)("option",{value:"",children:"Add saved contact..."}),ev.map(e=>(0,r.jsxs)("option",{value:"".concat(e.name,"||").concat(e.phone),children:[e.name," • ",e.phone]},"".concat(e.name,"-").concat(e.phone)))]}),(0,r.jsx)("button",{onClick:async()=>{if(!eN)return;let[e,t]=eN.split("||"),a=await fetch("/api/performance-contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:k,name:e,phone:t,include_in_export:!0})});if(a.ok){let e=await a.json();eh(t=>[...t,e]),ew("")}},className:"px-3 py-1 bg-blue-600 text-white rounded text-xs",children:"Add to contacts"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[(0,r.jsx)("input",{type:"text",placeholder:"Name",value:eg,onChange:e=>eb(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg"}),(0,r.jsx)("input",{type:"text",placeholder:"Phone",value:ef,onChange:e=>ey(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg"}),(0,r.jsx)("button",{onClick:async()=>{if(!eg.trim()||!ef.trim())return;let e=await fetch("/api/performance-contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:k,name:eg.trim(),phone:ef.trim(),include_in_export:!0})});if(e.ok){let t=await e.json();eh(e=>[...e,t]),eb(""),ey("")}},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold",children:"Add Contact"})]}),(0,r.jsx)("div",{className:"space-y-2",children:ex.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("div",{className:"font-medium text-gray-900",children:e.name}),(0,r.jsx)("div",{className:"text-sm text-gray-600",children:e.phone})]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,r.jsx)("input",{type:"checkbox",checked:!!e.include_in_export,onChange:async t=>{(await fetch("/api/performance-contacts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({include_in_export:t.target.checked})})).ok&&eh(a=>a.map(a=>a.id===e.id?{...a,include_in_export:t.target.checked}:a))}}),"Include in export"]}),(0,r.jsx)("button",{onClick:async()=>{(await fetch("/api/performance-contacts/".concat(e.id),{method:"DELETE"})).ok&&eh(t=>t.filter(t=>t.id!==e.id))},className:"text-xs text-red-600 hover:text-red-800",children:"Remove"})]},e.id))})]}),(0,r.jsx)("div",{className:"mt-6",children:(0,r.jsx)("button",{onClick:async()=>{try{er(!0),es(null);let e=await fetch("/api/performances/".concat(k),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:ei.title,date:ei.date||null,call_time:ei.call_time,timezone:ei.timezone,location:ei.location,description:ei.description,phone_numbers:ei.phone_numbers})});if(!e.ok){let t=await e.json().catch(()=>null);throw Error((null==t?void 0:t.details)||(null==t?void 0:t.error)||"Failed to save info")}let t=await e.json();F(t),el(e=>({...e,title:t.title||"",call_time:t.call_time||"",timezone:t.timezone||e.timezone,date:t.date?eM(t.date,t.timezone||e.timezone):e.date}));let a=await fetch("/api/performance-contacts?performanceId=".concat(k));if(a.ok){let e=await a.json();eh(e||[])}}catch(e){es(e instanceof Error?e.message:"Failed to save info")}finally{er(!1)}},className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold disabled:bg-gray-400",disabled:ea,children:ea?"Saving...":"Save Info"})})]})})]})]})]}),"positioning"===L&&eE.length>0&&(0,r.jsx)("div",{className:"w-80 bg-white shadow-md p-4 border-l border-gray-200",children:(0,r.jsxs)("div",{className:"sticky top-20 space-y-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-900 mb-2",children:"Parts & Choreography"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mb-3",children:"Drag to reorder. Click a card to show positions."}),(0,r.jsx)(p,{parts:eE,performanceId:k,onDelete:eD,onReorder:eP,onSelect:e=>B(e),selectedPartId:Z,variant:"select",enableDrag:!0,showPositionedNames:!0,showDelete:!0})]}),(0,r.jsx)(w,{partId:Z})]})})]}),W&&(0,r.jsx)(j,{performanceId:k,parts:eE,musicUrl:X,onClose:()=>K(!1),onUpdatePartTimepoints:e=>{eP(t=>t.map(t=>t.id===e.id?{...t,...e}:t))}}),Y&&(0,r.jsx)("div",{className:"fixed inset-0 z-40 bg-black/40 md:hidden",onClick:()=>Q(!1),children:(0,r.jsxs)("div",{className:"absolute left-0 top-0 h-full w-72 bg-white shadow-xl p-4 overflow-y-auto",onClick:e=>e.stopPropagation(),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,r.jsx)("div",{className:"text-sm font-semibold text-gray-900",children:"Roster"}),(0,r.jsx)("button",{onClick:()=>Q(!1),className:"text-xs text-gray-600 hover:text-gray-900",children:"Close"})]}),(0,r.jsx)(h,{performanceId:k})]})})]}):(0,r.jsxs)("div",{className:"min-h-screen bg-gray-100 p-6",children:[(0,r.jsx)("p",{className:"text-red-600",children:"Performance not found"}),(0,r.jsx)(i(),{href:"/admin",className:"text-blue-600 hover:underline",children:"Back to Admin"})]})}function M(e){let{rehearsals:t,showForm:a,onToggleForm:n,onCreateRehearsal:s,onDeleteRehearsal:i,onUpdateRehearsal:l}=e;return(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold",children:"Schedule Rehearsals"}),(0,r.jsx)("button",{onClick:n,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold",children:a?"Cancel":"+ Schedule Rehearsal"})]}),a&&(0,r.jsx)("div",{className:"mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200",children:(0,r.jsx)(o,{onSubmit:async(e,t)=>{await s(e,t)}})}),0===t.length?(0,r.jsx)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:(0,r.jsx)("p",{className:"text-gray-600",children:"No rehearsals scheduled yet."})}):(0,r.jsx)(u,{rehearsals:t,onDelete:i,onUpdate:l})]})}function I(e){let{performanceId:t,parts:a,performances:s,showForm:i,onToggleForm:l,onCreatePart:d,onDeletePart:o,onReorderParts:c,musicUrl:u=null}=e,[x,h]=(0,n.useState)(""),[g,b]=(0,n.useState)(!0),[f,y]=(0,n.useState)(!1),[v,j]=(0,n.useState)(null),[N,w]=(0,n.useState)(null),[_,S]=(0,n.useState)(!0),k=(s||[]).filter(e=>e.id!==t);return(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[(0,r.jsx)("h3",{className:"text-lg font-bold text-blue-900 mb-2",children:"Copy Parts from Another Performance"}),(0,r.jsx)("p",{className:"text-sm text-blue-800 mb-3",children:"This copies part names/descriptions (and optionally music timepoints), plus stage positions, subparts, and assigned order."}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-3 items-center",children:[(0,r.jsxs)("select",{value:x,onChange:e=>h(e.target.value),className:"px-3 py-2 border border-blue-300 rounded-lg text-sm min-w-[220px]",children:[(0,r.jsx)("option",{value:"",children:"Select performance to copy from..."}),k.map(e=>(0,r.jsx)("option",{value:e.id,children:e.title},e.id))]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-blue-900",children:[(0,r.jsx)("input",{type:"checkbox",checked:g,onChange:e=>b(e.target.checked),className:"h-4 w-4"}),"Copy music timepoints"]}),(0,r.jsx)("button",{onClick:async()=>{if(x){y(!0),j(null),w(null);try{let e=await fetch("/api/parts/copy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_performance_id:x,target_performance_id:t,copy_timepoints:g})});if(!e.ok){let t=await e.json();throw Error(t.error||"Failed to copy parts")}let r=await e.json();Array.isArray(r)&&r.length>0?(null==c||c([...a,...r]),w("Copied ".concat(r.length," part(s)."))):w("No parts found to copy.")}catch(e){j(e instanceof Error?e.message:"Failed to copy parts")}finally{y(!1)}}},disabled:!x||f,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 font-semibold text-sm",children:f?"Copying...":"Copy Parts"})]}),v&&(0,r.jsx)("div",{className:"mt-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded px-3 py-2",children:v}),N&&(0,r.jsx)("div",{className:"mt-3 text-sm text-green-700 bg-green-50 border border-green-200 rounded px-3 py-2",children:N})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold",children:"Parts & Choreography"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>S(e=>!e),className:"px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold text-sm",children:_?"Expand Details":"Compact View"}),(0,r.jsx)("button",{onClick:l,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold",children:i?"Cancel":"+ Add Part"})]})]}),i&&(0,r.jsx)("div",{className:"mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200",children:(0,r.jsx)(m,{onSubmit:d})}),0===a.length?(0,r.jsx)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:(0,r.jsx)("p",{className:"text-gray-600",children:"No parts created yet."})}):(0,r.jsx)(p,{parts:a,performanceId:t,onDelete:o,onReorder:c,compact:_,musicUrl:u})]})}},9815:(e,t,a)=>{"use strict";a.d(t,{f:()=>n});var r=a(2115);function n(){let[e,t]=(0,r.useState)([]),[a,n]=(0,r.useState)(!0),[s,i]=(0,r.useState)(null);(0,r.useEffect)(()=>{!async function(){try{let e=await fetch("/api/performances");if(!e.ok)throw Error("Failed to fetch performances");let a=await e.json();t(a)}catch(e){i(e instanceof Error?e.message:"An error occurred")}finally{n(!1)}}()},[]);let l=async(a,r,n,s,l,d)=>{try{let i=await fetch("/api/performances",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:a,description:r,date:n,location:s,call_time:l,timezone:d})});if(!i.ok)throw Error("Failed to create performance");let o=await i.json();return t([...e,o]),o}catch(e){throw i(e instanceof Error?e.message:"An error occurred"),e}},d=async a=>{try{if(!(await fetch("/api/performances/".concat(a),{method:"DELETE"})).ok)throw Error("Failed to delete performance");t(e.filter(e=>e.id!==a))}catch(e){throw i(e instanceof Error?e.message:"An error occurred"),e}};return{performances:e,loading:a,error:s,createPerformance:l,deletePerformance:d}}}},e=>{e.O(0,[5481,2373,8441,1255,7358],()=>e(e.s=1712)),_N_E=e.O()}]);