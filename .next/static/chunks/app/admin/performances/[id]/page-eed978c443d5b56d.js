(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[670],{701:(e,t,a)=>{"use strict";a.d(t,{e:()=>i});var r=a(5155),s=a(2115);let n=null;var l=a(5704);function i(e){let{value:t,onChange:a,placeholder:i,className:o,disabled:d=!1}=e,c=(0,s.useRef)(null),[u,m]=(0,s.useState)(null);return(0,s.useEffect)(()=>{var e,t;let r=l.env.NEXT_PUBLIC_GOOGLE_PLACES_API_KEY||"";if(!r||!c.current)return;let s=null;return((null==(t=window.google)||null==(e=t.maps)?void 0:e.places)?Promise.resolve():n||(n=new Promise((e,t)=>{let a=document.querySelector("script[data-google-places]");if(a){a.addEventListener("load",()=>e()),a.addEventListener("error",()=>t(Error("Failed to load Google Places")));return}let s=document.createElement("script");s.src="https://maps.googleapis.com/maps/api/js?key=".concat(r,"&libraries=places"),s.async=!0,s.defer=!0,s.dataset.googlePlaces="true",s.onload=()=>e(),s.onerror=()=>t(Error("Failed to load Google Places")),document.head.appendChild(s)}))).then(()=>{if(!c.current)return;let e=new window.google.maps.places.Autocomplete(c.current,{types:["geocode"],fields:["formatted_address","name"]});s=e,e.addListener("place_changed",()=>{let t=e.getPlace(),r=(null==t?void 0:t.formatted_address)||(null==t?void 0:t.name)||"";r&&a(r)})}).catch(e=>{m(e instanceof Error?e.message:"Failed to load Google Places")}),()=>{s&&window.google.maps.event.clearInstanceListeners(s)}},[a]),(0,r.jsxs)("div",{children:[(0,r.jsx)("input",{ref:c,type:"text",value:t,onChange:e=>a(e.target.value),placeholder:i,className:o,disabled:d}),u&&(0,r.jsx)("div",{className:"text-xs text-amber-700 mt-1",children:"Location autocomplete unavailable."})]})}},1517:(e,t,a)=>{"use strict";a.d(t,{AppBrand:()=>i});var r=a(5155),s=a(2619),n=a.n(s),l=a(6979);function i(e){let{href:t="/",textClassName:a="text-2xl font-bold",logoClassName:s=""}=e,i=(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)(l.v,{className:"border border-white/30 bg-white/10 text-white/60 ".concat(s)}),(0,r.jsx)("span",{className:a,children:"Performance Tool"})]});return t?(0,r.jsx)(n(),{href:t,className:"flex items-center gap-3",children:i}):i}},1712:(e,t,a)=>{Promise.resolve().then(a.bind(a,2518))},2518:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>P});var r=a(5155),s=a(2115),n=a(2619),l=a.n(n);function i(e){let[t,a]=(0,s.useState)([]),[r,n]=(0,s.useState)(!0),[l,i]=(0,s.useState)(null);(0,s.useEffect)(()=>{if(!e){a([]),n(!1);return}!async function(){try{let t=await fetch("/api/rehearsals?performanceId=".concat(e));if(!t.ok)throw Error("Failed to fetch rehearsals");let r=await t.json();a(r)}catch(e){i(e instanceof Error?e.message:"An error occurred")}finally{n(!1)}}()},[e]);let o=async(r,s)=>{if(!e)throw Error("Performance ID is required");try{let n=await Promise.all(s.map(t=>fetch("/api/rehearsals",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:e,title:r,date:t.date,time:t.time,location:t.location})})));for(let e of n)if(!e.ok)throw Error("Failed to create rehearsal");let l=await Promise.all(n.map(e=>e.json()));return a([...t,...l]),l}catch(e){throw i(e instanceof Error?e.message:"An error occurred"),e}},d=async e=>{try{if(!(await fetch("/api/rehearsals/".concat(e),{method:"DELETE"})).ok)throw Error("Failed to delete rehearsal");a(t.filter(t=>t.id!==e))}catch(e){throw i(e instanceof Error?e.message:"An error occurred"),e}};return{rehearsals:t,loading:r,error:l,createRehearsal:o,deleteRehearsal:d,updateRehearsal:async(e,t)=>{try{let r=await fetch("/api/rehearsals/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw Error("Failed to update rehearsal");let s=await r.json();return a(t=>t.map(t=>t.id===e?s:t)),s}catch(e){throw i(e instanceof Error?e.message:"An error occurred"),e}}}}var o=a(9815);function d(e){let{onSubmit:t,isLoading:a=!1}=e,[n,l]=(0,s.useState)({title:"",dateEntries:[{date:"",time:"",location:""}]}),[i,o]=(0,s.useState)(null),d=(e,t,a)=>{let r=[...n.dateEntries];r[e]={...r[e],[t]:a},l({...n,dateEntries:r})},c=async e=>{e.preventDefault(),o(null);let a=n.dateEntries.filter(e=>e.date&&e.time&&e.location);if(!n.title||0===a.length)return void o("Please fill in title and at least one complete date/time/location entry");try{await t(n.title,a),l({title:"",dateEntries:[{date:"",time:"",location:""}]})}catch(e){o(e instanceof Error?e.message:"An error occurred")}};return(0,r.jsxs)("form",{onSubmit:c,className:"space-y-4",children:[i&&(0,r.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:i}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Title *"}),(0,r.jsx)("input",{type:"text",value:n.title,onChange:e=>{l({...n,title:e.target.value})},placeholder:"e.g., Full Cast Rehearsal",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-4",children:"Schedule Dates & Times * (Each date can have different time/location)"}),(0,r.jsx)("div",{className:"space-y-4",children:n.dateEntries.map((e,t)=>(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Date *"}),(0,r.jsx)("input",{type:"date",value:e.date,onChange:e=>d(t,"date",e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Time *"}),(0,r.jsx)("input",{type:"time",value:e.time,onChange:e=>d(t,"time",e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Location *"}),(0,r.jsx)("input",{type:"text",value:e.location,onChange:e=>d(t,"location",e.target.value),placeholder:"e.g., Studio A",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]})]}),n.dateEntries.length>1&&(0,r.jsx)("button",{type:"button",onClick:()=>{l({...n,dateEntries:n.dateEntries.filter((e,a)=>a!==t)})},className:"mt-2 px-3 py-1 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600",children:"Remove"})]},t))}),(0,r.jsx)("button",{type:"button",onClick:()=>{l({...n,dateEntries:[...n.dateEntries,{date:"",time:"",location:""}]})},className:"mt-3 px-4 py-2 bg-gray-300 text-gray-900 rounded-lg hover:bg-gray-400 font-medium",children:"+ Add Another Date"})]}),(0,r.jsx)("button",{type:"submit",disabled:a,className:"w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors",children:a?"Scheduling...":"Schedule Rehearsal"})]})}function c(e){let{rehearsals:t,onDelete:a,onUpdate:n}=e,[l,i]=(0,s.useState)(null),[o,d]=(0,s.useState)({title:"",date:"",time:"",location:""}),c=e=>e?e.split("T")[0]:"",u=()=>{i(null)},m=async e=>{await n(e,o),i(null)};return(0,r.jsx)("div",{className:"space-y-3",children:t.map(e=>(0,r.jsxs)("div",{className:"flex justify-between items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50",children:[(0,r.jsx)("div",{className:"flex-1",children:l===e.id?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("input",{type:"text",value:o.title,onChange:e=>d(t=>({...t,title:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,r.jsx)("input",{type:"date",value:o.date,onChange:e=>d(t=>({...t,date:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsx)("input",{type:"time",value:o.time,onChange:e=>d(t=>({...t,time:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsx)("input",{type:"text",value:o.location,onChange:e=>d(t=>({...t,location:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",placeholder:"Location"})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-900",children:e.title}),(0,r.jsxs)("div",{className:"grid grid-cols-2 text-sm text-gray-600 mt-1",children:[(0,r.jsxs)("span",{children:["\uD83D\uDCC5 ",(e=>{if(!e)return"";let t=c(e);if(t){let[e,a,r]=t.split("-").map(Number);if(e&&a&&r)return new Date(e,a-1,r).toLocaleDateString()}return new Date(e).toLocaleDateString()})(e.date)]}),(0,r.jsxs)("span",{children:["\uD83D\uDD50 ",e.time]})]}),(0,r.jsxs)("div",{className:"text-sm text-gray-600 mt-1",children:["\uD83D\uDCCD ",e.location]})]})}),(0,r.jsx)("div",{className:"flex items-center gap-2 ml-4",children:l===e.id?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:()=>m(e.id),className:"px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm",children:"Save"}),(0,r.jsx)("button",{onClick:u,className:"px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm",children:"Cancel"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:()=>(e=>{let t=c(e.date);i(e.id),d({title:e.title||"",date:t,time:e.time||"",location:e.location||""})})(e),className:"px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm",children:"Edit"}),(0,r.jsx)("button",{onClick:()=>{window.confirm("Delete this rehearsal?")&&a(e.id)},className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm",children:"Delete"})]})})]},e.id))})}function u(e){let{onSubmit:t,isLoading:a=!1}=e,[n,l]=(0,s.useState)({name:"",description:"",order:0,is_group:!0}),[i,o]=(0,s.useState)("group"),[d,c]=(0,s.useState)([]),[u,m]=(0,s.useState)(null),p=e=>{l({...n,[e.target.name]:"number"===e.target.type?Number(e.target.value):e.target.value})},x=async e=>{if(e.preventDefault(),m(null),!n.name)return void m("Part name is required");try{let e="group"===i,a=d.map(e=>({title:e.title.trim(),notes:e.notes.trim()})).filter(e=>e.title.length>0);if(!e&&0===a.length)return void m("Add at least one subpart for this part.");let r=await t(n.name,n.description,n.order,e);e||await Promise.all(a.map(e=>fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:r.id,title:e.title,description:e.notes||null,mode:"position"})}))),l({name:"",description:"",order:0,is_group:!0}),o("group"),c([])}catch(e){m(e instanceof Error?e.message:"An error occurred")}};return(0,r.jsxs)("form",{onSubmit:x,className:"space-y-4",children:[u&&(0,r.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:u}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Part Name *"}),(0,r.jsx)("input",{type:"text",name:"name",value:n.name,onChange:p,placeholder:"e.g., Lead Dancers, Background Chorus",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Description"}),(0,r.jsx)("textarea",{name:"description",value:n.description,onChange:p,placeholder:"Details about this part/choreography...",rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,r.jsx)("input",{type:"radio",checked:"group"===i,onChange:()=>o("group"),className:"h-4 w-4"}),"Group part"]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,r.jsx)("input",{type:"radio",checked:"subparts"===i,onChange:()=>o("subparts"),className:"h-4 w-4"}),"Part with subparts / solos"]}),"subparts"===i&&(0,r.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2",children:[(0,r.jsx)("div",{className:"text-sm font-semibold text-gray-700",children:"Subparts"}),0===d.length&&(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"Add at least one subpart."}),(0,r.jsx)("div",{className:"space-y-2",children:d.map((e,t)=>(0,r.jsxs)("div",{className:"border border-gray-200 rounded p-2",children:[(0,r.jsx)("input",{type:"text",value:e.title,onChange:e=>{let a=[...d];a[t]={...a[t],title:e.target.value},c(a)},placeholder:"Subpart ".concat(t+1," title"),className:"w-full px-2 py-1 border border-gray-300 rounded text-sm mb-2"}),(0,r.jsx)("textarea",{value:e.notes,onChange:e=>{let a=[...d];a[t]={...a[t],notes:e.target.value},c(a)},placeholder:"Notes",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(0,r.jsx)("button",{type:"button",onClick:()=>c(d.filter((e,a)=>a!==t)),className:"mt-2 text-xs text-red-600 hover:text-red-800",children:"Remove"})]},"subpart-".concat(t)))}),(0,r.jsx)("button",{type:"button",onClick:()=>c([...d,{title:"",notes:""}]),className:"px-2 py-1 bg-blue-600 text-white rounded text-xs",children:"Add Subpart"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Order"}),(0,r.jsx)("input",{type:"number",name:"order",value:n.order,onChange:p,min:"0",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsx)("button",{type:"submit",disabled:a,className:"w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors",children:a?"Adding...":"Add Part"})]})}function m(e){let{parts:t,performanceId:a,onDelete:n,onReorder:l,onSelect:i,selectedPartId:o,variant:d="manage",enableDrag:c=!0,showPositionedNames:u=!0,compact:m=!1}=e,[p,x]=(0,s.useState)(null),[h,g]=(0,s.useState)(""),[b,f]=(0,s.useState)(""),[y,v]=(0,s.useState)(""),[j,N]=(0,s.useState)(""),[w,S]=(0,s.useState)(""),[_,k]=(0,s.useState)(""),[C,E]=(0,s.useState)(!0),[T,D]=(0,s.useState)({}),[P,F]=(0,s.useState)({}),[I,O]=(0,s.useState)(null),[M,A]=(0,s.useState)({}),[L,U]=(0,s.useState)({}),[R,J]=(0,s.useState)({}),[z,B]=(0,s.useState)({}),[G,q]=(0,s.useState)({}),[X,H]=(0,s.useState)({}),[K,Y]=(0,s.useState)({}),[Z,Q]=(0,s.useState)(null),[W,V]=(0,s.useState)(""),[$,ee]=(0,s.useState)(""),[et,ea]=(0,s.useState)(""),[er,es]=(0,s.useState)(""),[en,el]=(0,s.useState)(""),[ei,eo]=(0,s.useState)(""),[ed,ec]=(0,s.useState)(null),[eu,em]=(0,s.useState)(null),ep=(0,s.useMemo)(()=>[...t].sort((e,t)=>{let a="number"==typeof e.timepoint_seconds,r="number"==typeof t.timepoint_seconds;if(a&&r){let a=e.timepoint_seconds,r=t.timepoint_seconds;return a!==r?a-r:(e.order||0)-(t.order||0)}return a!==r?a?-1:1:(e.order||0)-(t.order||0)}),[t]),ex=e=>{if(null==e||""===e)return{min:"",sec:""};let t=Number(e);if(!Number.isFinite(t))return{min:"",sec:""};let a=Math.floor(t/60),r=Math.floor(t%60);return{min:String(a),sec:String(r)}},eh=(e,t)=>{if(!e&&!t)return null;let a=e?parseInt(e,10):0,r=t?parseFloat(t):0;return Number.isNaN(a)||Number.isNaN(r)?null:60*a+r},eg=e=>{if(null==e||""===e)return"--:--";let t=Number(e);if(!Number.isFinite(t))return"--:--";let a=Math.floor(t/60),r=Math.floor(t%60);return"".concat(a,":").concat(r.toString().padStart(2,"0"))};(0,s.useEffect)(()=>{t.forEach(e=>{eb(e.id),ef(e.id)})},[t]);let eb=async e=>{try{let t=await fetch("/api/stage-positions?partId=".concat(e)),a=await t.json();D(t=>({...t,[e]:a.length})),F(t=>({...t,[e]:a.map(e=>e.student_name||"Unknown")}))}catch(e){console.error("Error fetching positions:",e)}},ef=async e=>{try{let t=await fetch("/api/subparts?partId=".concat(e));if(!t.ok)throw Error("Failed to fetch subparts");let a=await t.json();A(t=>({...t,[e]:a||[]}))}catch(e){console.error("Error fetching subparts:",e)}},ey=async e=>{let t=(L[e]||"").trim(),a=(R[e]||"").trim(),r=eh(z[e]||"",G[e]||""),s=eh(X[e]||"",K[e]||"");if(t)try{let n=await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:e,title:t,description:a||null,mode:"position",timepoint_seconds:r,timepoint_end_seconds:s})});if(!n.ok){let e=await n.json().catch(()=>null);throw Error((null==e?void 0:e.details)||(null==e?void 0:e.error)||"Failed to create subpart")}await ef(e),U(t=>({...t,[e]:""})),J(t=>({...t,[e]:""})),B(t=>({...t,[e]:""})),q(t=>({...t,[e]:""})),H(t=>({...t,[e]:""})),Y(t=>({...t,[e]:""}))}catch(e){console.error("Error creating subpart:",e)}},ev=async(e,t)=>{try{if(!(await fetch("/api/subparts/".concat(e),{method:"DELETE"})).ok)throw Error("Failed to delete subpart");await ef(t)}catch(e){console.error("Error deleting subpart:",e)}},ej=()=>{Q(null),V(""),ee(""),ea(""),es(""),el(""),eo("")},eN=async(e,t)=>{try{let a=await fetch("/api/subparts/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:W,description:$,timepoint_seconds:eh(et,er),timepoint_end_seconds:eh(en,ei)})});if(!a.ok){let e=await a.json().catch(()=>null);throw Error((null==e?void 0:e.details)||(null==e?void 0:e.error)||"Failed to update subpart")}await ef(t),ej()}catch(e){console.error("Error updating subpart:",e)}},ew=async(e,t,a)=>{var r;if(a<0||a>=((null==(r=M[e])?void 0:r.length)||0))return;let s=[...M[e]||[]],[n]=s.splice(t,1);s.splice(a,0,n),A(t=>({...t,[e]:s}));try{await Promise.all(s.map((e,t)=>fetch("/api/subparts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:t+1})})))}catch(t){console.error("Error reordering subparts:",t),await ef(e)}},eS=e=>{x(e.id),g(e.name),f(e.description||"");let t=ex(e.timepoint_seconds),a=ex(e.timepoint_end_seconds);v(t.min),N(t.sec),S(a.min),k(a.sec),E(!1!==e.is_group)},e_=async e=>{try{let t=await fetch("/api/parts/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:h,description:b,timepoint_seconds:eh(y,j),timepoint_end_seconds:eh(w,_),is_group:C})});if(!t.ok){let e=await t.json();throw console.error("API Error:",e),Error(e.details||"Failed to update part")}x(null)}catch(e){console.error("Error updating part:",e),alert("Error updating part: ".concat(e instanceof Error?e.message:String(e)))}},ek=async(e,t)=>{if(t<0||t>=ep.length)return;let a=[...ep],[r]=a.splice(e,1);a.splice(t,0,r);try{let e=a.map((e,t)=>fetch("/api/parts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:t+1})}));if(!(await Promise.all(e)).every(e=>e.ok))throw Error("Some updates failed");let t=a.map((e,t)=>({...e,order:t+1}));l&&l(t)}catch(e){console.error("Error reordering parts:",e)}};return(0,r.jsx)("div",{className:"space-y-3",children:ep.map((e,t)=>{var a,s,l;let D=m&&p!==e.id,F=!1===e.is_group?"Subparts/Solos":"Group";return(0,r.jsx)("div",{draggable:c,onDragStart:()=>O(e.id),onDragOver:e=>{c&&e.preventDefault()},onDrop:()=>{if(c&&I&&I!==e.id)ek(ep.findIndex(e=>e.id===I),ep.findIndex(t=>t.id===e.id)),O(null)},onClick:()=>null==i?void 0:i(e.id),className:"p-4 border rounded-lg hover:bg-gray-50 ".concat(c?"cursor-move":""," ").concat(o===e.id?"border-blue-500 bg-blue-50":"border-gray-200"),children:p===e.id?(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("input",{type:"text",value:h,onChange:e=>g(e.target.value),placeholder:"Part name",className:"w-full px-3 py-2 border border-gray-300 rounded-lg"}),(0,r.jsx)("textarea",{value:b,onChange:e=>f(e.target.value),placeholder:"Part description (optional)",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",rows:2}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,r.jsx)("input",{type:"checkbox",checked:C,onChange:e=>E(e.target.checked),className:"h-4 w-4"}),"Group part (unchecked = has subparts/solos)"]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-semibold text-gray-700 mb-1",children:"Start Time (m / s)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:y,onChange:e=>v(e.target.value),placeholder:"min",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:j,onChange:e=>N(e.target.value),placeholder:"sec",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-semibold text-gray-700 mb-1",children:"End Time (m / s)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:w,onChange:e=>S(e.target.value),placeholder:"min",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:_,onChange:e=>k(e.target.value),placeholder:"sec",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]})]})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>e_(e.id),className:"px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm",children:"Save"}),(0,r.jsx)("button",{onClick:()=>x(null),className:"px-3 py-1 bg-gray-400 text-white rounded hover:bg-gray-500 text-sm",children:"Cancel"})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex justify-between items-start ".concat(D?"":"mb-3"),children:[(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("h3",{className:"font-bold text-gray-900 truncate",children:e.name}),!D&&e.description&&(0,r.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:e.description}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:F})]}),"manage"===d&&!D&&(0,r.jsxs)("div",{className:"flex gap-2 ml-4",children:[(0,r.jsx)("button",{onClick:()=>ek(t,t-1),disabled:0===t,className:"px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 text-sm",title:"Move up",children:"↑"}),(0,r.jsx)("button",{onClick:()=>ek(t,t+1),disabled:t===ep.length-1,className:"px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 text-sm",title:"Move down",children:"↓"})]})]}),D&&(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[(0,r.jsx)("span",{className:"text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded",children:F}),(0,r.jsxs)("span",{className:"text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded",children:["Positioned: ",null!=(l=T[e.id])?l:"-"]}),(0,r.jsxs)("span",{className:"text-xs bg-purple-50 text-purple-700 px-2 py-1 rounded",children:["Order: ",e.order]}),"manage"===d&&(0,r.jsxs)("div",{className:"flex gap-2 ml-auto",children:[(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),eS(e)},className:"px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-xs",children:"Edit"}),(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),window.confirm("Delete this part?")&&n(e.id)},className:"px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs",children:"Delete"})]})]}),!D&&"manage"===d&&(void 0!==e.timepoint_seconds||void 0!==e.timepoint_end_seconds)&&(0,r.jsxs)("div",{className:"bg-amber-50 p-2 rounded mb-3 text-sm",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Music Timepoint:"}),(0,r.jsxs)("span",{className:"font-bold text-amber-700 ml-2",children:[eg(e.timepoint_seconds)," - ",eg(e.timepoint_end_seconds)]})]}),!D&&u&&(null==(a=P[e.id])?void 0:a.length)>0&&(0,r.jsx)("div",{className:"bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:P[e.id].join(", ")}),!D&&(null==(s=M[e.id])?void 0:s.length)>0&&(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-600 mb-1",children:"Subparts / Solos"}),(0,r.jsx)("div",{className:"space-y-1",children:M[e.id].map(t=>(0,r.jsx)("div",{className:"flex items-start justify-between gap-2 ".concat("manage"===d?"cursor-move":""),draggable:"manage"===d,onDragStart:()=>{ec(t.id),em(e.id)},onDragOver:e=>{"manage"===d&&e.preventDefault()},onDrop:()=>{if("manage"!==d||!ed||eu!==e.id)return;let a=M[e.id].findIndex(e=>e.id===ed),r=M[e.id].findIndex(e=>e.id===t.id);ew(e.id,a,r),ec(null),em(null)},children:Z===t.id?(0,r.jsxs)("div",{className:"w-full space-y-2",children:[(0,r.jsx)("input",{type:"text",value:W,onChange:e=>V(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("textarea",{value:$,onChange:e=>ee(e.target.value),rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:et,onChange:e=>ea(e.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:er,onChange:e=>es(e.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:en,onChange:e=>el(e.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:ei,onChange:e=>eo(e.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]}),(0,r.jsxs)("select",{value:t.mode||"position",onChange:a=>fetch("/api/subparts/".concat(t.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:a.target.value})}).then(()=>ef(e.id)),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation(),children:[(0,r.jsx)("option",{value:"position",children:"Position"}),(0,r.jsx)("option",{value:"order",children:"Order"}),(0,r.jsx)("option",{value:"both",children:"Both"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:a=>{a.stopPropagation(),eN(t.id,e.id)},className:"px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700",children:"Save"}),(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),ej()},className:"px-2 py-1 bg-gray-400 text-white rounded text-xs hover:bg-gray-500",children:"Cancel"})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium text-gray-800",children:t.title}),t.description&&(0,r.jsx)("div",{className:"text-gray-500",children:t.description}),t.mode&&(0,r.jsxs)("div",{className:"text-gray-400 text-[10px] mt-1",children:["Mode: ",t.mode]}),(0,r.jsxs)("div",{className:"text-gray-400 text-[10px] mt-1",children:["Time: ",eg(t.timepoint_seconds)," - ",eg(t.timepoint_end_seconds)]})]}),(0,r.jsx)("div",{className:"flex items-center gap-2",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:e=>{e.stopPropagation();Q(t.id),V(t.title),ee(t.description||"");let a=ex(t.timepoint_seconds),r=ex(t.timepoint_end_seconds);ea(a.min),es(a.sec),el(r.min),eo(r.sec)},className:"text-[10px] text-blue-600 hover:text-blue-800",children:"Edit"}),(0,r.jsx)("button",{onClick:a=>{a.stopPropagation(),ev(t.id,e.id)},className:"text-[10px] text-red-600 hover:text-red-800",children:"Remove"})]})})]})},t.id))})]}),!D&&(0,r.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-600 mb-1",children:"Add Subpart"}),(0,r.jsx)("input",{type:"text",value:L[e.id]||"",onChange:t=>U(a=>({...a,[e.id]:t.target.value})),placeholder:"Subpart title",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2",onClick:e=>e.stopPropagation()}),(0,r.jsx)("textarea",{value:R[e.id]||"",onChange:t=>J(a=>({...a,[e.id]:t.target.value})),placeholder:"Description",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2",onClick:e=>e.stopPropagation()}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:z[e.id]||"",onChange:t=>B(a=>({...a,[e.id]:t.target.value})),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:G[e.id]||"",onChange:t=>q(a=>({...a,[e.id]:t.target.value})),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:X[e.id]||"",onChange:t=>H(a=>({...a,[e.id]:t.target.value})),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:K[e.id]||"",onChange:t=>Y(a=>({...a,[e.id]:t.target.value})),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]}),(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),ey(e.id)},className:"px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700",children:"Add"})]}),!D&&"manage"===d&&(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>eS(e),className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm",children:"Edit"}),(0,r.jsx)("button",{onClick:()=>eb(e.id),className:"px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm",children:"Refresh Count"}),(0,r.jsx)("button",{onClick:()=>{window.confirm("Delete this part?")&&n(e.id)},className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm",children:"Delete"})]})]})},e.id)})})}var p=a(6979);function x(e){let{performanceId:t}=e,[a,n]=(0,s.useState)([]),[l,o]=(0,s.useState)(!0),[d,c]=(0,s.useState)(null),[u,m]=(0,s.useState)(!1),[x,h]=(0,s.useState)(""),[g,b]=(0,s.useState)(""),[f,y]=(0,s.useState)(!1),[v,j]=(0,s.useState)([]),[N,w]=(0,s.useState)([]),[S,_]=(0,s.useState)([]),[k,C]=(0,s.useState)([]),[E,T]=(0,s.useState)(!1),[D,P]=(0,s.useState)(""),{rehearsals:F}=i(t),I=(0,s.useCallback)(async()=>{try{o(!0);let e=await fetch("/api/performances/".concat(t,"/roster"));if(!e.ok)throw Error("Failed to fetch roster");let a=await e.json();n(a)}catch(e){console.error("Error fetching roster:",e),c(e instanceof Error?e.message:"Failed to load roster")}finally{o(!1)}},[t]),O=(0,s.useCallback)(async()=>{if(t)try{T(!0);let e=await fetch("/api/rehearsal-attendance?performanceId=".concat(t));if(!e.ok){let t=await e.text();throw console.error("Attendance fetch failed:",e.status,t),Error("Failed to fetch attendance")}let a=await e.json();C(a)}catch(e){console.error("Error fetching attendance:",e)}finally{T(!1)}},[t]);(0,s.useEffect)(()=>{I()},[I]),(0,s.useEffect)(()=>{O()},[O]),(0,s.useEffect)(()=>{(async()=>{if(t)try{let e=await fetch("/api/performances/".concat(t));if(!e.ok)return;let a=await e.json();P((null==a?void 0:a.date)||"")}catch(e){console.error("Error fetching performance date:",e)}})()},[t]);let M=(0,s.useCallback)(async()=>{try{let e=await fetch("/api/students");if(!e.ok)throw Error("Failed to fetch students");let t=await e.json();_(t)}catch(e){console.error("Error fetching students:",e)}},[]);(0,s.useEffect)(()=>{u&&M()},[u,M]);let A=async e=>{try{if(!(await fetch("/api/signups/".concat(e),{method:"DELETE"})).ok)throw Error("Failed to remove student");n(a.filter(t=>t.signup_id!==e))}catch(e){console.error("Error removing student:",e),c(e instanceof Error?e.message:"Failed to remove student")}},L=e=>{w(t=>[...t,e]),h(""),b("")},U=async e=>{e.preventDefault();let a=x.trim().length>0?[...v,x.trim()]:[...v];if(0===a.length&&0===N.length)return void c("Please enter at least one name");y(!0);try{for(let e of N)if(!(await fetch("/api/signups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:t,student_id:e.id,status:"registered"})})).ok)throw Error("Failed to add to roster");for(let e of a){let a=await fetch("/api/students",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:g.trim()?g.trim():null})});if(!a.ok)throw Error("Failed to create student");let r=await a.json();if(!(await fetch("/api/signups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:t,student_id:r.id,status:"registered"})})).ok)throw Error("Failed to add to roster")}h(""),b(""),j([]),w([]),m(!1),await I()}catch(e){c(e instanceof Error?e.message:"Failed to add student")}finally{y(!1)}},R=(0,s.useMemo)(()=>{let e=new Map;for(let t of k)e.set("".concat(t.rehearsal_id,":").concat(t.student_id),t);return e},[k]),J=(0,s.useCallback)(e=>e?e.split("T")[0]:"",[]),z=(0,s.useCallback)(e=>{let t=J(e);if(!t)return new Date(e);let[a,r,s]=t.split("-").map(Number);return new Date(a,(r||1)-1,s||1)},[J]),B=(0,s.useMemo)(()=>[...F].sort((e,t)=>z(e.date).getTime()-z(t.date).getTime()),[F,z]),G=e=>z(e).toLocaleDateString(void 0,{month:"numeric",day:"numeric"}),q=(0,s.useMemo)(()=>new Set(a.map(e=>e.student_id)),[a]),X=(0,s.useMemo)(()=>new Set(N.map(e=>e.id)),[N]),H=(0,s.useMemo)(()=>{let e=x.trim().toLowerCase();return e?S.filter(t=>!(q.has(t.id)||X.has(t.id))&&t.name.toLowerCase().includes(e)).slice(0,8):[]},[S,x,q,X]),K=async(e,t,a)=>{if(a)return;let r="".concat(e,":").concat(t),s=R.get(r);try{if(!s){let a=await fetch("/api/rehearsal-attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rehearsal_id:e,student_id:t,status:"present"})});if(!a.ok)throw Error("Failed to save attendance");let r=await a.json();C(e=>[...e,r]);return}if("present"===s.status){let a=await fetch("/api/rehearsal-attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rehearsal_id:e,student_id:t,status:"absent"})});if(!a.ok)throw Error("Failed to save attendance");let r=await a.json();C(e=>e.map(e=>e.id===r.id?r:e));return}if(!(await fetch("/api/rehearsal-attendance?rehearsalId=".concat(e,"&studentId=").concat(t),{method:"DELETE"})).ok)throw Error("Failed to clear attendance");C(a=>a.filter(a=>a.rehearsal_id!==e||a.student_id!==t))}catch(e){console.error("Error updating attendance:",e),c(e instanceof Error?e.message:"Failed to update attendance")}};return l?(0,r.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,r.jsx)("p",{className:"text-gray-500",children:"Loading roster..."})}):(0,r.jsx)("div",{className:"h-full flex flex-col",children:(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(p.v,{size:22,className:"border border-gray-200 bg-white text-gray-400"}),(0,r.jsxs)("h3",{className:"font-semibold text-gray-900",children:["Roster (",a.length,")"]})]}),(0,r.jsx)("button",{onClick:()=>m(!u),className:"px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700",children:u?"Cancel":"+ Add"})]}),B.length>0&&(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mb-3 text-xs text-gray-600",children:[(0,r.jsx)("span",{children:"Attendance:"}),(0,r.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,r.jsx)("span",{className:"h-3 w-3 rounded bg-green-500 inline-block"}),"Present"]}),(0,r.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,r.jsx)("span",{className:"h-3 w-3 rounded bg-red-500 inline-block"}),"Missed"]}),(0,r.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,r.jsx)("span",{className:"h-3 w-3 rounded bg-gray-300 inline-block"}),"Pending"]}),(0,r.jsx)("span",{className:"text-gray-500",children:"Click boxes to toggle."})]}),d&&(0,r.jsx)("div",{className:"bg-yellow-100 border border-yellow-400 text-yellow-700 px-3 py-2 rounded mb-4 text-sm",children:d}),u&&(0,r.jsxs)("form",{onSubmit:U,className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg space-y-2",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("input",{type:"text",value:x,onChange:e=>h(e.target.value),onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=H.find(e=>e.name.toLowerCase()===x.trim().toLowerCase());if(t)return void L(t);let a=x.trim();a&&(j(e=>[...e,a]),h(""),b(""))}},placeholder:"Name (press Enter to add)",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),H.length>0&&(0,r.jsx)("div",{className:"absolute z-10 mt-1 w-full rounded border border-gray-200 bg-white shadow-sm text-sm",children:H.map(e=>(0,r.jsxs)("button",{type:"button",onClick:()=>L(e),className:"w-full text-left px-2 py-1 hover:bg-blue-50",children:[(0,r.jsx)("span",{className:"font-medium text-gray-900",children:e.name}),e.email&&(0,r.jsxs)("span",{className:"text-gray-500",children:[" • ",e.email]})]},e.id))})]}),(0,r.jsx)("input",{type:"email",value:g,onChange:e=>b(e.target.value),placeholder:"Email (optional)",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(v.length>0||N.length>0)&&(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[N.map(e=>(0,r.jsxs)("span",{className:"inline-flex items-center gap-1 bg-green-50 border border-green-200 text-green-800 px-2 py-1 rounded text-xs",children:[e.name,(0,r.jsx)("button",{type:"button",onClick:()=>{var t;return t=e.id,void w(e=>e.filter(e=>e.id!==t))},className:"text-green-800 hover:text-green-900","aria-label":"Remove ".concat(e.name),children:"\xd7"})]},e.id)),v.map((e,t)=>(0,r.jsxs)("span",{className:"inline-flex items-center gap-1 bg-white border border-blue-200 text-blue-700 px-2 py-1 rounded text-xs",children:[e,(0,r.jsx)("button",{type:"button",onClick:()=>{j(e=>e.filter((e,a)=>a!==t))},className:"text-blue-700 hover:text-blue-900","aria-label":"Remove ".concat(e),children:"\xd7"})]},"".concat(e,"-").concat(t)))]}),(0,r.jsx)("button",{type:"submit",disabled:f,className:"w-full px-2 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400",children:f?"Adding...":"Add to Roster"})]}),0===a.length?(0,r.jsx)("p",{className:"text-gray-500 text-sm",children:"No students registered yet"}):(0,r.jsx)("div",{className:"space-y-2",children:a.map(e=>(0,r.jsxs)("div",{className:"bg-gray-50 p-2 rounded-md border border-gray-200 flex justify-between items-start group",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"font-medium text-gray-900 text-xs",children:e.name}),e.email&&(0,r.jsx)("p",{className:"text-gray-600 text-[10px]",children:e.email}),e.part_name&&(0,r.jsx)("div",{className:"mt-1",children:(0,r.jsx)("span",{className:"inline-block bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-medium",children:e.part_name})}),B.length>0&&(0,r.jsxs)("div",{className:"mt-1 flex flex-wrap gap-1",children:[D&&(0,r.jsxs)("div",{title:"Performance \xe2€\xa2 ".concat(z(D).toLocaleDateString()),className:"h-7 w-9 border bg-gray-200 text-gray-700 border-gray-300 text-[9px] leading-tight rounded flex flex-col items-center justify-center font-semibold opacity-90",children:[(0,r.jsx)("span",{children:G(D)}),(0,r.jsx)("span",{children:"P"})]}),B.map(t=>{var a;let s=R.get("".concat(t.id,":").concat(e.student_id)),n=(e=>{let t=z(e.date),a=new Date,r=new Date(a.getFullYear(),a.getMonth(),a.getDate());return t.getTime()>r.getTime()})(t),l=null!=(a=null==s?void 0:s.status)?a:"pending";return(0,r.jsxs)("button",{type:"button",onClick:()=>K(t.id,e.student_id,n),disabled:E,title:"".concat(t.title," • ").concat(z(t.date).toLocaleDateString()," ").concat(t.time),className:"h-7 w-9 border text-[9px] leading-tight rounded flex flex-col items-center justify-center font-semibold ".concat("present"===l?"bg-green-500 text-white border-green-600":"absent"===l?"bg-red-500 text-white border-red-600":"bg-gray-300 text-gray-700 border-gray-400"," ").concat(n?"opacity-70 cursor-not-allowed":"hover:opacity-90"),children:[(0,r.jsx)("span",{children:G(t.date)}),(0,r.jsx)("span",{children:"R"})]},t.id)})]})]}),(0,r.jsx)("button",{onClick:()=>A(e.signup_id),className:"ml-2 px-2 py-0.5 bg-red-500 text-white rounded text-[10px] opacity-0 group-hover:opacity-100 hover:bg-red-600 transition-opacity",title:"Remove from roster",children:"Remove"})]},e.signup_id))})]})})}function h(e,t){if(!e||0===e.length)return"?";let a=e.charAt(0).toUpperCase();return t.filter(t=>t!==e&&t.charAt(0).toUpperCase()===a).length>0?e.slice(0,2).toUpperCase():a}function g(e){let{performanceId:t,partId:a,partName:n=null,partDescription:l=null,isGroup:i=!0,onSavePositions:o}=e,[d,c]=(0,s.useState)([]),[u,m]=(0,s.useState)([]),[x,g]=(0,s.useState)(null),[b,f]=(0,s.useState)(!1),[y,v]=(0,s.useState)(!0),[j,N]=(0,s.useState)(!1),[w,S]=(0,s.useState)(null),[_,k]=(0,s.useState)("bottom"),[C,E]=(0,s.useState)(Date.now()),T=s.useRef(null),D=s.useRef(!1),[P,F]=(0,s.useState)([]),[I,O]=(0,s.useState)(null),[M,A]=(0,s.useState)({}),[L,U]=(0,s.useState)({}),[R,J]=(0,s.useState)(null),[z,B]=(0,s.useState)(!1),[G,q]=(0,s.useState)(n||""),[X,H]=(0,s.useState)(!1),[K,Y]=(0,s.useState)(!1),[Z,Q]=(0,s.useState)(l||""),[W,V]=(0,s.useState)(!1),[$,ee]=(0,s.useState)([]),[et,ea]=(0,s.useState)(""),[er,es]=(0,s.useState)(!1),[en,el]=(0,s.useState)(!1),ei=(0,s.useCallback)(async()=>{try{let e=await fetch("/api/subparts?partId=".concat(a));if(e.ok){let t=await e.json();F(t||[]),0===(t||[]).length&&O(null)}}catch(e){console.error("Error fetching subparts:",e)}},[a]);(0,s.useEffect)(()=>{!async function(){try{let e=await fetch("/api/performances/".concat(t));if(e.ok){let t=await e.json();t.stage_orientation&&k("top"===t.stage_orientation?"top":"bottom")}let r=await fetch("/api/performances/".concat(t,"/roster"));if(!r.ok)throw Error("Failed to fetch roster");let s=(await r.json()).filter(e=>e.part_id===a||!e.part_id);c(s),await ei();let n=await fetch("/api/stage-positions?partId=".concat(a));if(!n.ok)throw Error("Failed to fetch positions");let l=await n.json();m(l.map(e=>({student_id:e.student_id||"",name:e.student_name||"Unknown",x:e.x,y:e.y,id:e.id})))}catch(e){S(e instanceof Error?e.message:"Failed to load data")}finally{v(!1)}}()},[t,a,i,ei]),(0,s.useEffect)(()=>{q(n||"")},[n]),(0,s.useEffect)(()=>{Q(l||"")},[l]);let eo=(0,s.useCallback)(async()=>{try{let e=await fetch("/api/parts?performanceId=".concat(t));if(!e.ok)return;let a=await e.json(),r=(a||[]).map(e=>({key:"part:".concat(e.id),label:"Part: ".concat(e.name)})),s=(await Promise.all((a||[]).map(async e=>{let t=await fetch("/api/subparts?partId=".concat(e.id));return t.ok?(await t.json()||[]).map(t=>({key:"subpart:".concat(t.id),label:"Subpart: ".concat(e.name," - ").concat(t.title)})):[]}))).flat();ee([...r,...s])}catch(e){console.error("Error loading position sources:",e)}},[t]);(0,s.useEffect)(()=>{eo()},[eo]);let ed=(0,s.useCallback)(async()=>{await ei(),await eo()},[ei,eo]);(0,s.useEffect)(()=>{let e=()=>{ed()},t=()=>{"visible"===document.visibilityState&&ed()};return window.addEventListener("focus",e),document.addEventListener("visibilitychange",t),()=>{window.removeEventListener("focus",e),document.removeEventListener("visibilitychange",t)}},[ed]),(0,s.useEffect)(()=>{let e=window.setInterval(()=>{ed()},3e3);return()=>window.clearInterval(e)},[ed]),(0,s.useEffect)(()=>{I&&(async()=>{try{let[e,t]=await Promise.all([fetch("/api/subpart-positions?subpartId=".concat(I)),fetch("/api/subpart-order?subpartId=".concat(I))]);if(e.ok){let t=await e.json();A(e=>({...e,[I]:(t||[]).map(e=>({student_id:e.student_id||"",name:e.student_name||"Unknown",x:e.x,y:e.y,id:e.id}))}))}if(t.ok){let e=await t.json();U(t=>({...t,[I]:(e||[]).map(e=>({id:e.id,student_id:e.student_id,student_name:e.student_name||"Unknown"}))}))}}catch(e){console.error("Error fetching subpart data:",e)}})()},[I]),(0,s.useEffect)(()=>(T.current=setInterval(async()=>{if(D.current)try{if(N(!0),I&&P.length>0){let e=(M[I]||[]).map(e=>({subpart_id:I,student_id:e.student_id,x:e.x,y:e.y}));await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:I,positions:e})})}else await o(u);await fetch("/api/performances/".concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({stage_orientation:_})}),D.current=!1,E(Date.now()),S(null)}catch(e){console.error("Auto-save error:",e)}finally{N(!1)}},6e3),()=>{T.current&&clearInterval(T.current)}),[u,_,t,o,I,P,M]);let ec=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];g(e),f(t)},eu=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},em=(e,t)=>Number.isNaN(e)||e<0?0:e>t?t:e,ep=async(e,t,a)=>{if(e.preventDefault(),!x||P.length>0&&!eN)return;let r=d.find(e=>e.student_id===x);if(b&&!r){let e=u.find(e=>e.student_id===x);e&&(r={student_id:x,name:e.name,part_name:null})}if(!r)return;let s=[...(I&&P.length>0?M[I]||[]:u).filter(e=>e.student_id!==x),{student_id:x,name:r.name,x:"top"===_?11-t:t,y:"top"===_?8-a:a}];I&&P.length>0?(A(e=>({...e,[I]:s})),await eb(s,L[I]||[])):m(s),D.current=!0,g(null),f(!1)},ex=async()=>{try{if(N(!0),I&&P.length>0){let e=(M[I]||[]).map(e=>({subpart_id:I,student_id:e.student_id,x:e.x,y:e.y}));await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:I,positions:e})})}else await o(u);await fetch("/api/performances/".concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({stage_orientation:_})}),S(null)}catch(e){S(e instanceof Error?e.message:"Failed to save positions")}finally{N(!1)}},eh=(0,s.useCallback)(async e=>{I&&(U(t=>({...t,[I]:e})),await fetch("/api/subpart-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.map((e,t)=>({subpart_id:I,student_id:e.student_id,order:t+1})))}))},[I]),eg=async(e,t)=>{if(!I)return;let a=[...eS,{id:"temp-".concat(Date.now()),student_id:e,student_name:t}];await eh(a)},eb=(0,s.useCallback)(async(e,t)=>{if(!I)return;let a=new Set(t.map(e=>e.student_id)),r=e.filter(e=>e.student_id&&!a.has(e.student_id)).map(e=>({id:"temp-".concat(Date.now(),"-").concat(e.student_id),student_id:e.student_id,student_name:e.name}));if(0===r.length)return;let s=[...t,...r];await eh(s)},[eh,I]);(0,s.useEffect)(()=>{if(!I)return;let e=M[I]||[],t=L[I]||[];0!==e.length&&eb(e,t)},[I,M,L,eb]);let ef=async()=>{if(!et)return[];let[e,t]=et.split(":");if(!t)return[];let a=await fetch("subpart"===e?"/api/subpart-positions?subpartId=".concat(t):"/api/stage-positions?partId=".concat(t));if(!a.ok)throw Error(await a.text()||"Failed to fetch source positions");return(await a.json()||[]).map(e=>({student_id:e.student_id||"",name:e.student_name||"Unknown",x:e.x,y:e.y}))},ey=async()=>{if(et){el(!0);try{let e=(await ef()).map(e=>{let t=er?11-e.x:e.x;return{...e,x:em(t,11),y:em(e.y,8)}});I&&P.length>0?(A(t=>({...t,[I]:e})),await eb(e,L[I]||[]),await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:I,positions:e.map(e=>({subpart_id:I,student_id:e.student_id,x:e.x,y:e.y}))})})):(m(e),await o(e)),D.current=!1,E(Date.now()),S(null)}catch(e){S(e instanceof Error?e.message:"Failed to apply positions")}finally{el(!1)}}},ev=P.find(e=>e.id===I),ej=(null==ev?void 0:ev.mode)||"position",eN=0===P.length||"order"!==ej,ew=P.length>0,eS=I&&L[I]||[],e_=I&&P.length>0?M[I]||[]:u,ek=new Set(e_.map(e=>e.student_id)),eC=new Map;e_.forEach(e=>{eC.has(e.student_id)||eC.set(e.student_id,e)});let eE=Array.from(eC.values()).map(e=>({student_id:e.student_id,name:e.name,initials:h(e.name,Array.from(eC.values()).map(e=>e.name))}));return y?(0,r.jsx)("div",{className:"text-center py-8",children:"Loading..."}):(0,r.jsxs)("div",{className:"space-y-6",children:[w&&(0,r.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:w}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-[220px_1fr] gap-6",children:[(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,r.jsxs)("h3",{className:"font-semibold text-gray-900 mb-2",children:["Students (",d.length,")"]}),(0,r.jsx)("p",{className:"text-[11px] text-gray-500 mb-3",children:"Positioned students stay here so you can assign them to subparts."}),(0,r.jsx)("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:0===d.length?(0,r.jsx)("p",{className:"text-gray-500 text-sm",children:"No students yet."}):d.map(e=>{let t=ek.has(e.student_id);return(0,r.jsxs)("div",{draggable:!0,onDragStart:()=>ec(e.student_id,!1),className:"p-3 rounded border cursor-move hover:shadow-md transition-all ".concat(t?"bg-emerald-50 border-emerald-200 hover:border-emerald-300":"bg-white border-blue-200 hover:border-blue-400"),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,r.jsx)("p",{className:"font-medium text-sm text-gray-900",children:e.name}),t&&(0,r.jsx)("span",{className:"text-[10px] px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 font-semibold",children:"Positioned"})]}),e.part_name&&(0,r.jsx)("p",{className:"text-xs text-gray-600",children:e.part_name})]},e.student_id)})}),ew&&I&&(0,r.jsxs)("div",{className:"mt-4 border-t border-gray-200 pt-4",children:[(0,r.jsx)("h4",{className:"font-medium text-gray-900 mb-2 text-sm",children:"Assigned Students"}),(0,r.jsx)("p",{className:"text-[11px] text-gray-500 mb-2",children:"Drag students here to assign them to this subpart."}),(0,r.jsx)("div",{className:"bg-white p-2 rounded border border-gray-200",onDragOver:e=>e.preventDefault(),onDrop:async()=>{if(!x)return;let e=d.find(e=>e.student_id===x);e&&await eg(e.student_id,e.name)},children:(0,r.jsx)("div",{className:"space-y-2",children:0===eS.length?(0,r.jsx)("div",{className:"text-xs text-gray-500 border border-dashed border-gray-300 rounded p-2 text-center",children:"Drop students here"}):eS.map((e,t)=>(0,r.jsxs)("div",{draggable:!0,onDragStart:()=>J(e.id),onDragOver:e=>e.preventDefault(),onDrop:async()=>{if(!R)return;let t=eS.findIndex(e=>e.id===R),a=eS.findIndex(t=>t.id===e.id);if(t<0||a<0)return;let r=[...eS],[s]=r.splice(t,1);r.splice(a,0,s),await eh(r),J(null)},className:"flex items-center justify-between bg-gray-50 border border-gray-200 rounded px-2 py-1",children:[(0,r.jsxs)("div",{className:"text-xs text-gray-900",children:[(0,r.jsxs)("span",{className:"text-gray-500 mr-1",children:[t+1,"."]}),e.student_name]}),(0,r.jsx)("button",{onClick:async()=>{let t=eS.filter(t=>t.id!==e.id);await eh(t)},className:"text-[10px] text-red-600 hover:text-red-800",children:"Remove"})]},e.id))})})]})]}),(0,r.jsx)("div",{children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-start justify-between gap-3 mb-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(p.v,{size:24,className:"border border-gray-200 bg-white text-gray-400"}),(0,r.jsx)("h3",{className:"font-semibold text-gray-900",children:"Stage Layout"}),z?(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("input",{type:"text",value:G,onChange:e=>q(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm"}),(0,r.jsx)("button",{onClick:async()=>{if(!a)return;let e=G.trim();if(e){H(!0);try{if(!(await fetch("/api/parts/".concat(a),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})})).ok)throw Error("Failed to update part name");B(!1)}catch(e){alert(e instanceof Error?e.message:"Failed to update part name")}finally{H(!1)}}},disabled:X,className:"px-2 py-1 bg-green-600 text-white rounded text-xs disabled:bg-gray-400",children:X?"Saving...":"Save"}),(0,r.jsx)("button",{onClick:()=>{B(!1),q(n||"")},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("span",{className:"text-sm text-gray-700",children:n?"- ".concat(n):""}),(0,r.jsx)("button",{onClick:()=>B(!0),className:"text-xs text-blue-600 hover:text-blue-800",children:"Edit name"})]})]}),(0,r.jsx)("div",{className:"mt-2",children:K?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("textarea",{value:Z,onChange:e=>Q(e.target.value),rows:2,placeholder:"Add part notes...",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:async()=>{if(a){V(!0);try{if(!(await fetch("/api/parts/".concat(a),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:Z||null})})).ok)throw Error("Failed to update part notes");Y(!1)}catch(e){alert(e instanceof Error?e.message:"Failed to update part notes")}finally{V(!1)}}},disabled:W,className:"px-2 py-1 bg-green-600 text-white rounded text-xs disabled:bg-gray-400",children:W?"Saving...":"Save notes"}),(0,r.jsx)("button",{onClick:()=>{Y(!1),Q(l||"")},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]})]}):(0,r.jsxs)("div",{className:"flex items-start gap-2",children:[(0,r.jsx)("p",{className:"text-sm text-gray-600",children:l||"No notes yet."}),(0,r.jsx)("button",{onClick:()=>Y(!0),className:"text-xs text-blue-600 hover:text-blue-800",children:"Edit notes"})]})}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mt-1",children:["Front of stage: ","bottom"===_?"Bottom":"Top"]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-600",children:"Subpart"}),(0,r.jsxs)("select",{value:I||"",onChange:e=>O(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-xs",disabled:0===P.length,children:[(0,r.jsx)("option",{value:"",children:"Part positions"}),0===P.length&&(0,r.jsx)("option",{value:"",disabled:!0,children:"No subparts yet"}),P.map(e=>(0,r.jsx)("option",{value:e.id,children:e.title},e.id))]}),(null==ev?void 0:ev.description)&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500",children:ev.description})]}),(0,r.jsxs)("div",{className:"flex flex-col items-end gap-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 text-xs",children:[j&&(0,r.jsx)("span",{className:"text-blue-600 font-semibold",children:"Auto-saving..."}),!j&&D.current&&(0,r.jsx)("span",{className:"text-orange-600 font-semibold",children:"Unsaved changes (auto-saves in 6s)"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsxs)("select",{value:_,onChange:e=>k(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,r.jsx)("option",{value:"bottom",children:"Front - Bottom"}),(0,r.jsx)("option",{value:"top",children:"Front - Top"})]}),(0,r.jsx)("button",{onClick:()=>{I&&P.length>0?A(e=>({...e,[I]:[]})):m([]),D.current=!0},className:"px-4 py-2 bg-gray-300 text-gray-900 rounded-lg hover:bg-gray-400 font-medium text-sm",children:"Reset All"}),(0,r.jsx)("button",{onClick:ex,disabled:j,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 font-medium text-sm",children:j?"Saving...":"Save Positions"})]})]})]}),e_.length>0&&(0,r.jsxs)("div",{className:"bg-blue-50 p-3 rounded-lg border border-blue-200",children:[(0,r.jsx)("h4",{className:"font-medium text-gray-900 mb-2 text-sm",children:"Legend"}),(0,r.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:eE.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,r.jsx)("div",{className:"w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold",children:e.initials}),(0,r.jsx)("span",{className:"text-gray-700 truncate",children:e.name})]},e.student_id))})]}),(0,r.jsxs)("div",{className:"bg-white p-3 rounded-lg border border-gray-200",children:[(0,r.jsx)("div",{className:"font-medium text-gray-900 text-sm mb-2",children:"Quick Position"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2 items-center",children:[(0,r.jsxs)("select",{value:et,onChange:e=>ea(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,r.jsx)("option",{value:"",children:"Select a part or subpart..."}),$.map(e=>(0,r.jsx)("option",{value:e.key,children:e.label},e.key))]}),(0,r.jsx)("button",{onClick:ey,disabled:!et||en,className:"px-3 py-1 bg-blue-600 text-white rounded text-sm disabled:bg-gray-400",children:en?"Applying...":"Apply"})]}),(0,r.jsxs)("label",{className:"mt-2 flex items-center gap-2 text-xs text-gray-700",children:[(0,r.jsx)("input",{type:"checkbox",checked:er,onChange:e=>es(e.target.checked),className:"h-4 w-4"}),"Horizontal flip before applying"]})]}),P.length>0&&(0,r.jsx)("div",{className:"text-sm text-gray-700 font-medium text-center",children:(null==ev?void 0:ev.title)||"Subpart"}),(0,r.jsxs)("div",{className:"flex items-center justify-center gap-3",children:[P.length>0&&eN&&(0,r.jsx)("button",{onClick:()=>{let e=P.findIndex(e=>e.id===I);e>0&&O(P[e-1].id)},disabled:!I||0===P.findIndex(e=>e.id===I),className:"px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 text-xs",children:"Prev"}),(0,r.jsxs)("div",{className:"border-2 border-gray-400 bg-gradient-to-b from-amber-100 to-amber-50 relative mx-auto",style:{width:768,height:576,backgroundImage:"\n                  linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),\n                  linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px)\n                ",backgroundSize:"".concat(64,"px ").concat(64,"px")},onDragOver:eu,children:["bottom"===_&&(0,r.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-red-500"}),"top"===_&&(0,r.jsx)("div",{className:"absolute top-0 left-0 right-0 h-1 bg-red-500"}),(0,r.jsx)("div",{className:"absolute text-red-600 font-bold text-xs bg-white bg-opacity-80 px-2 py-1 rounded",style:{..."bottom"===_&&{bottom:5,left:"50%",transform:"translateX(-50%)"},..."top"===_&&{top:5,left:"50%",transform:"translateX(-50%)"}},children:"FRONT"}),I&&P.length>0&&0===e_.length&&(0,r.jsx)("div",{className:"absolute top-8 left-0 right-0 text-center text-2xl font-bold text-gray-500",children:(null==ev?void 0:ev.title)||"Subpart"}),Array.from({length:9}).map((e,t)=>Array.from({length:12}).map((e,a)=>(0,r.jsx)("div",{onDrop:e=>ep(e,a,t),onDragOver:eu,className:"absolute cursor-cell hover:bg-blue-100 hover:bg-opacity-30 transition-colors",style:{left:64*a,top:64*t,width:64,height:64}},"".concat(a,"-").concat(t)))),e_.map((e,t)=>{let a,s,n=h(e.name,e_.map(e=>e.name));return(0,r.jsxs)("div",{draggable:!0,onDragStart:()=>ec(e.student_id,!0),className:"absolute flex items-center justify-center group cursor-move",style:{left:(a=e.x,("top"===_?11-a:a)*64),top:(s=e.y,("top"===_?8-s:s)*64),width:64,height:64},children:[(0,r.jsxs)("div",{className:"relative w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg group-hover:bg-blue-600 transition-colors",children:[n,(0,r.jsx)("button",{onClick:()=>(e=>{let t=async e=>{try{I&&P.length>0?await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:I,positions:e.map(e=>({subpart_id:I,student_id:e.student_id,x:e.x,y:e.y}))})}):await o(e),D.current=!1,E(Date.now())}catch(e){S(e instanceof Error?e.message:"Failed to save positions"),D.current=!0}};if(I&&P.length>0){let a=(M[I]||[]).filter(t=>t.student_id!==e);A(e=>({...e,[I]:a})),t(a)}else{let a=u.filter(t=>t.student_id!==e);m(a),t(a)}D.current=!0})(e.student_id),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600",title:"Remove from stage",children:"x"})]}),(0,r.jsx)("div",{className:"absolute bottom-full mb-1 whitespace-nowrap bg-gray-900 text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:e.name})]},e.id||"".concat(e.student_id,"-").concat(e.x,"-").concat(e.y,"-").concat(t))})]}),P.length>0&&eN&&(0,r.jsx)("button",{onClick:()=>{let e=P.findIndex(e=>e.id===I);e>=0&&e<P.length-1&&O(P[e+1].id)},disabled:!I||P.findIndex(e=>e.id===I)===P.length-1,className:"px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 text-xs",children:"Next"})]}),ew&&I&&null,(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,r.jsxs)("h4",{className:"font-medium text-gray-900 mb-3",children:["Positioned (",e_.length,")"]}),(0,r.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:e_.map((e,t)=>(0,r.jsxs)("div",{className:"bg-white p-2 rounded border border-green-200 text-sm",children:[(0,r.jsx)("p",{className:"font-medium text-gray-900",children:e.name}),(0,r.jsxs)("p",{className:"text-xs text-gray-600",children:["(",e.x,", ",e.y,")"]})]},e.id||"".concat(e.student_id,"-").concat(e.x,"-").concat(e.y,"-").concat(t)))})]})]})})]})]})}function b(e){let{performanceId:t,performanceTitle:a,currentMusicFile:n,onUploadSuccess:l}=e,[i,o]=(0,s.useState)(!1),[d,c]=(0,s.useState)(null),[u,m]=(0,s.useState)(!1),p=async e=>{var a;let r=null==(a=e.currentTarget.files)?void 0:a[0];if(r){o(!0),c(null),m(!1);try{let a=new FormData;a.append("file",r);let s=await fetch("/api/performances/".concat(t,"/upload-music"),{method:"POST",body:a});if(!s.ok){let e=await s.json();throw Error(e.error||"Upload failed")}let n=await s.json();m(!0),null==l||l(n.filePath,n.publicUrl),e.currentTarget.value=""}catch(e){c(e instanceof Error?e.message:"Upload failed")}finally{o(!1)}}};return(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,r.jsx)("h3",{className:"font-bold text-lg text-gray-900 mb-4",children:"Performance Music"}),n&&(0,r.jsx)("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded",children:(0,r.jsxs)("p",{className:"text-sm text-green-900",children:[(0,r.jsx)("span",{className:"font-semibold",children:"✓ Music Uploaded:"})," ",n]})}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("label",{className:"block",children:[(0,r.jsx)("div",{className:"flex items-center justify-center w-full p-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors bg-gray-50 hover:bg-blue-50",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("p",{className:"text-2xl mb-2",children:"\uD83C\uDFB5"}),(0,r.jsx)("p",{className:"text-sm font-semibold text-gray-700",children:i?"Uploading...":"Click to upload music"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"MP3, WAV, OGG (max 50MB)"})]})}),(0,r.jsx)("input",{type:"file",accept:"audio/*",onChange:p,disabled:i,className:"hidden"})]}),d&&(0,r.jsx)("div",{className:"p-3 bg-red-50 border border-red-200 rounded",children:(0,r.jsxs)("p",{className:"text-sm text-red-900",children:["❌ ",d]})}),u&&(0,r.jsx)("div",{className:"p-3 bg-green-50 border border-green-200 rounded",children:(0,r.jsx)("p",{className:"text-sm text-green-900",children:"✓ Music uploaded successfully!"})})]})]})}function f(e){let{musicUrl:t,onTimeUpdate:a,performanceTitle:n,audioRef:l,onAudioReady:i}=e,o=(0,s.useRef)(null),d=null!=l?l:o,[c,u]=(0,s.useState)(!1),[m,p]=(0,s.useState)(0),[x,h]=(0,s.useState)(0),[g,b]=(0,s.useState)(1);(0,s.useEffect)(()=>{let e=d.current;if(!e)return;let t=()=>{p(e.currentTime),null==a||a(e.currentTime)},r=()=>{h(e.duration)};return e.addEventListener("timeupdate",t),e.addEventListener("loadedmetadata",r),e.addEventListener("play",()=>u(!0)),e.addEventListener("pause",()=>u(!1)),e.addEventListener("ended",()=>u(!1)),null==i||i(e),()=>{e.removeEventListener("timeupdate",t),e.removeEventListener("loadedmetadata",r),e.removeEventListener("play",()=>u(!0)),e.removeEventListener("pause",()=>u(!1)),e.removeEventListener("ended",()=>u(!1)),null==i||i(null)}},[d,a,i]);let f=e=>{if(!e||isNaN(e))return"0:00";let t=Math.floor(e/60),a=Math.floor(e%60);return"".concat(t,":").concat(a.toString().padStart(2,"0"))};return(0,r.jsxs)("div",{className:"bg-gray-900 text-white rounded-lg p-6 shadow-xl",children:[(0,r.jsx)("audio",{ref:d,src:t}),(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("h3",{className:"font-bold text-lg mb-1",children:n?"Music for ".concat(n):"Music Player"}),!t&&(0,r.jsx)("p",{className:"text-sm text-gray-400",children:"No music uploaded yet"})]}),t&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,r.jsx)("button",{onClick:()=>{d.current&&(c?d.current.pause():d.current.play())},disabled:!t,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 rounded-lg font-semibold transition-colors",children:c?"⏸ Pause":"▶ Play"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-400",children:"\uD83D\uDD0A"}),(0,r.jsx)("input",{type:"range",min:"0",max:"1",step:"0.1",value:g,onChange:e=>{let t=parseFloat(e.target.value);b(t),d.current&&(d.current.volume=t)},className:"w-20 cursor-pointer"}),(0,r.jsxs)("span",{className:"text-xs text-gray-400 w-6",children:[Math.round(100*g),"%"]})]})]}),(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,r.jsx)("span",{className:"text-sm text-gray-300 w-12 text-right",children:f(m)}),(0,r.jsx)("input",{type:"range",min:"0",max:x||0,value:m,onChange:e=>{var t;return t=parseFloat(e.target.value),void(d.current&&(d.current.currentTime=t,p(t)))},className:"flex-1 cursor-pointer"}),(0,r.jsx)("span",{className:"text-sm text-gray-300 w-12",children:f(x)})]}),(0,r.jsx)("div",{className:"w-full bg-gray-700 rounded-full h-1",children:(0,r.jsx)("div",{className:"bg-blue-500 h-1 rounded-full transition-all",style:{width:"".concat(x?m/x*100:0,"%")}})})]})]}),!t&&(0,r.jsx)("div",{className:"text-center py-8 text-gray-400",children:(0,r.jsx)("p",{children:"Upload music in the performance settings to enable playback"})})]})}function y(e){if(!e)return"?";let t=e.trim().split(/\s+/);return 1===t.length?t[0].slice(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function v(e){let{performanceId:t,parts:a,musicUrl:n,onClose:l,onUpdatePartTimepoints:i}=e,[o,d]=(0,s.useState)(0),[c,u]=(0,s.useState)({}),[m,x]=(0,s.useState)(!1),[h,g]=(0,s.useState)(!0),[b,v]=(0,s.useState)({}),[j,N]=(0,s.useState)({}),[w,S]=(0,s.useState)({}),[_,k]=(0,s.useState)(""),[C,E]=(0,s.useState)(null),[T,D]=(0,s.useState)(null),[P,F]=(0,s.useState)(null),[I,O]=(0,s.useState)(""),[M,A]=(0,s.useState)("bottom"),[L,U]=(0,s.useState)(null),[R,J]=(0,s.useState)(null),[z,B]=(0,s.useState)(null),[G,q]=(0,s.useState)(""),[X,H]=(0,s.useState)(""),[K,Y]=(0,s.useState)(""),[Z,Q]=(0,s.useState)(""),[W,V]=(0,s.useState)(null),[$,ee]=(0,s.useState)({}),et=(0,s.useRef)(null),ea=(0,s.useRef)(null),er=(0,s.useRef)(null),es=(0,s.useMemo)(()=>a.map(e=>{let t=$[e.id];return t?{...e,timepoint_seconds:t.start,timepoint_end_seconds:t.end}:e}),[a,$]),en=(0,s.useMemo)(()=>[...es].sort((e,t)=>{let a="number"==typeof e.timepoint_seconds?e.timepoint_seconds:1/0,r="number"==typeof t.timepoint_seconds?t.timepoint_seconds:1/0;return a===r?(e.order||0)-(t.order||0):a-r}),[es]),el=(0,s.useMemo)(()=>en.filter(e=>"number"==typeof e.timepoint_seconds),[en]),ei=(0,s.useMemo)(()=>{if(0===el.length)return -1;let e=0;for(let t=0;t<el.length;t++){let a=el[t].timepoint_seconds||0,r=el[t].timepoint_end_seconds;o>=a&&(null==r||o<r)?e=t:o>=a&&(e=t)}return e},[el,o]),eo=ei>=0?el[ei]:null,ed=ei>=0?el[ei+1]:null,ec=ed?Math.max(0,(ed.timepoint_seconds||0)-o):null,eu=e=>{if(null==e||Number.isNaN(e))return"--:--";let t=Math.max(0,Math.floor(e)),a=Math.floor(t/60);return"".concat(a,":").concat((t%60).toString().padStart(2,"0"))},em=e=>{if(null==e||Number.isNaN(e))return{min:"",sec:""};let t=Math.max(0,Math.floor(e));return{min:String(Math.floor(t/60)),sec:String(t%60)}},ep=(e,t)=>{if(!e&&!t)return null;let a=e?parseInt(e,10):0,r=t?parseFloat(t):0;return Number.isNaN(a)||Number.isNaN(r)?null:60*a+r},ex=(0,s.useMemo)(()=>{let e=new Set;return Object.values(c).forEach(t=>{t.forEach(t=>e.add(t.student_name||"Unknown"))}),Object.values(j).forEach(t=>{t.forEach(t=>e.add(t||"Unknown"))}),Array.from(e).sort((e,t)=>e.localeCompare(t))},[c,j]),eh=(0,s.useMemo)(()=>_?en.filter(e=>!!(c[e.id]||[]).map(e=>e.student_name).includes(_)||(b[e.id]||[]).some(e=>(j[e.id]||[]).includes(_))):en,[en,_,c,b,j]),eg=()=>{try{let e=window.AudioContext||window.webkitAudioContext;if(!e)return;let t=new e,a=t.createGain();a.gain.value=.3,a.connect(t.destination);let r=t.createOscillator();r.type="sine",r.frequency.value=880,r.connect(a);let s=t.currentTime;r.start(s),r.stop(s+.15),setTimeout(()=>t.close(),300)}catch(e){}},eb=(e,t)=>{if(!et.current)return;D(e),F(t),E(5),eg();let a=5,r=setInterval(()=>{if((a-=1)<=0){clearInterval(r),E(null),D(null),F(null),et.current.currentTime=e,et.current.play();return}E(a),eg()},1e3)};(0,s.useEffect)(()=>{if(!h||null===ec){ea.current=ec;return}let e=ea.current;(null===e||e>10)&&ec<=10&&(()=>{try{let e=window.AudioContext||window.webkitAudioContext;if(!e)return;let t=new e,a=t.createGain();a.gain.value=.35,a.connect(t.destination);let r=e=>{let r=t.createOscillator();r.type="sine",r.frequency.value=880,r.connect(a),r.start(e),r.stop(e+.18)},s=t.currentTime;r(s),r(s+.35),r(s+.7),setTimeout(()=>t.close(),1200)}catch(e){}})(),ea.current=ec},[ec,h]),(0,s.useEffect)(()=>{(async()=>{x(!0);try{let e=await Promise.all(a.map(async e=>{let t=await fetch("/api/stage-positions?partId=".concat(e.id));if(!t.ok)return[e.id,[]];let a=(await t.json()||[]).map(e=>({student_id:e.student_id,student_name:e.student_name||"Unknown",x:e.x,y:e.y}));return[e.id,a]})),t={};e.forEach(e=>{let[a,r]=e;t[a]=r}),u(t);let r=await Promise.all(a.map(async e=>{let t=await fetch("/api/subparts?partId=".concat(e.id));if(!t.ok)return[e.id,[]];let a=(await t.json()||[]).map(e=>{var t,a,r;return{id:e.id,part_id:e.part_id,title:e.title,description:null!=(t=e.description)?t:null,timepoint_seconds:null!=(a=e.timepoint_seconds)?a:null,timepoint_end_seconds:null!=(r=e.timepoint_end_seconds)?r:null}});return[e.id,a]})),s={};r.forEach(e=>{let[t,a]=e;s[t]=a}),v(s);let n=r.flatMap(e=>{let[,t]=e;return t.map(e=>e.id)}),l=await Promise.all(n.map(async e=>{let t=await fetch("/api/subpart-order?subpartId=".concat(e));if(!t.ok)return[e,[]];let a=(await t.json()||[]).map(e=>e.student_name||"Unknown");return[e,a]})),i={};l.forEach(e=>{let[t,a]=e;i[t]=a}),N(i);let o=await Promise.all(n.map(async e=>{let t=await fetch("/api/subpart-positions?subpartId=".concat(e));if(!t.ok)return[e,!1];let a=await t.json();return[e,Array.isArray(a)&&a.length>0]})),d={};o.forEach(e=>{let[t,a]=e;d[t]=a}),S(d)}finally{x(!1)}})()},[a,t]),(0,s.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/performances/".concat(t));if(!e.ok)return;let a=await e.json();O((null==a?void 0:a.call_time)||""),(null==a?void 0:a.stage_orientation)&&A("top"===a.stage_orientation?"top":"bottom")}catch(e){}})()},[t]);let ef=e=>{if(!e)return null;let t=b[e.id]||[];if(0===t.length)return null;let a=t.map(e=>{let t=j[e.id]||[],a=w[e.id]||!1;return 0===t.length||a?null:{title:e.title,names:t,description:e.description||null}}).filter(Boolean);return 0===a.length?null:(0,r.jsxs)("div",{className:"bg-white border border-indigo-200 rounded-lg p-5 shadow-sm min-h-[220px]",children:[(0,r.jsx)("div",{className:"text-sm uppercase tracking-wide text-indigo-600 font-semibold mb-2",children:"Subpart Assignments"}),(0,r.jsx)("div",{className:"space-y-3 text-base text-gray-700",children:a.map(e=>(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-semibold text-gray-900",children:e.title}),e.description&&(0,r.jsx)("div",{className:"text-sm text-gray-500",children:e.description}),(0,r.jsx)("div",{className:"text-gray-600",children:e.names.join(", ")})]},e.title))})]})},ey=(e,t,a)=>{let s=t&&c[t.id]||[],n=a?"text-5xl":"text-4xl",l=a?"text-base":"text-sm",i=a?"border-purple-700 bg-purple-100":"border-blue-700 bg-blue-100",o=a?"from-purple-200 to-purple-300":"from-blue-200 to-blue-300";return(0,r.jsxs)("div",{className:"rounded-lg border p-4 shadow-sm ".concat(i),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"".concat(l," uppercase tracking-wide text-gray-600"),children:e}),(0,r.jsx)("div",{className:"".concat(n," font-semibold text-gray-900"),children:t?t.name:"—"})]}),a&&null!==ec&&ec<=10&&(0,r.jsx)("div",{className:"text-7xl font-extrabold text-red-600 animate-pulse",children:Math.ceil(ec)})]}),a&&null!==ec&&ec<=10&&(0,r.jsx)("div",{className:"mb-2 text-3xl font-extrabold text-red-600 animate-pulse",children:"GET READY"}),(0,r.jsxs)("div",{className:"border border-gray-300 bg-gradient-to-b ".concat(o," relative mx-auto"),style:{width:816,height:544,backgroundImage:"\n              linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),\n              linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px)\n            ",backgroundSize:"".concat(68,"px ").concat(68,"px")},children:["bottom"===M&&(0,r.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-red-500"}),"top"===M&&(0,r.jsx)("div",{className:"absolute top-0 left-0 right-0 h-1 bg-red-500"}),(0,r.jsx)("div",{className:"absolute text-red-600 font-bold text-xs bg-white bg-opacity-80 px-2 py-1 rounded",style:{..."bottom"===M&&{bottom:5,left:"50%",transform:"translateX(-50%)"},..."top"===M&&{top:5,left:"50%",transform:"translateX(-50%)"}},children:"FRONT"}),Array.from({length:8}).map((e,t)=>Array.from({length:12}).map((e,a)=>(0,r.jsx)("div",{className:"absolute",style:{left:68*a,top:68*t,width:68,height:68}},"".concat(a,"-").concat(t)))),s.map(e=>(0,r.jsx)("div",{className:"absolute flex items-center justify-center",style:{left:68*e.x,top:68*e.y,width:68,height:68},children:(0,r.jsx)("div",{className:"w-14 h-14 bg-blue-600 text-white text-base font-bold rounded-full flex items-center justify-center shadow-md",children:y(e.student_name)})},"".concat(e.student_id,"-").concat(e.x,"-").concat(e.y)))]})]})};return(0,s.useEffect)(()=>{if(!eo)return;let e=b[eo.id]||[];if(0===e.length)return;let t=e.map(e=>{let t="number"==typeof e.timepoint_seconds?e.timepoint_seconds:Number(e.timepoint_seconds),a="number"==typeof e.timepoint_end_seconds?e.timepoint_end_seconds:Number(e.timepoint_end_seconds),r=Number.isFinite(t)?t:NaN,s=Number.isFinite(a)?a:NaN;return Number.isFinite(r)?{id:e.id,start:r,end:Number.isFinite(s)?s:r}:null}).filter(Boolean);if(0===t.length)return;let a=t.find(e=>o>=e.start&&o<=e.end);J(a?a.id:null);let r=t.find(e=>o>=e.start&&o<e.start+.35);r&&er.current!==r.id&&(er.current=r.id,U(r.id),setTimeout(()=>{U(e=>e===r.id?null:e)},350))},[o,eo,b]),(0,r.jsx)("div",{className:"fixed inset-0 z-50 bg-black bg-opacity-70 flex",children:(0,r.jsx)("div",{className:"flex-1 bg-gray-100 overflow-auto",children:(0,r.jsxs)("div",{className:"w-full h-full p-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-1",children:[(0,r.jsx)(p.v,{className:"border border-gray-200 bg-white text-gray-400",size:32}),(0,r.jsx)("div",{className:"text-sm uppercase tracking-wide text-gray-500",children:"Rehearse Mode"})]}),(0,r.jsx)("div",{className:"text-3xl font-bold text-gray-900",children:"Live Stage View"})]}),(0,r.jsx)("div",{className:"flex items-center gap-4",children:(0,r.jsx)("button",{onClick:l,className:"px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-800",children:"Close"})})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-[360px_1fr] gap-6",children:[(0,r.jsxs)("div",{className:"bg-white rounded-lg border border-gray-200 p-4 shadow-sm",children:[(0,r.jsx)("div",{className:"text-2xl font-semibold text-gray-900 mb-4",children:"Parts"}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-3",children:"Select a part to jump to that timepoint."}),(0,r.jsx)("div",{className:"space-y-5",children:eh.map((e,t)=>{let a=(null==eo?void 0:eo.id)===e.id,s=(null==ed?void 0:ed.id)===e.id,n=z===e.id;return(0,r.jsxs)("div",{className:"border rounded p-2 cursor-pointer transition-colors ".concat(a?"border-blue-500 bg-blue-50":"border-gray-200 bg-white"),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-900 text-xl",children:e.name}),s&&(0,r.jsx)("span",{className:"text-base font-bold text-purple-700 bg-purple-100 px-2 py-0.5 rounded",children:"NEXT"})]}),(0,r.jsx)("div",{className:"text-base text-gray-500",children:"number"==typeof e.timepoint_seconds?eu(e.timepoint_seconds):"No timepoint"}),n?(0,r.jsxs)("div",{className:"mt-2 space-y-2",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[11px] font-semibold text-gray-600",children:"Start (m / s)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:G,onChange:e=>q(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:X,onChange:e=>H(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[11px] font-semibold text-gray-600",children:"End (m / s)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:K,onChange:e=>Y(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:Z,onChange:e=>Q(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:e=>e.stopPropagation()})]})]})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:async t=>{t.stopPropagation();let a=ep(G,X),r=ep(K,Z);V(e.id);try{let t=await fetch("/api/parts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({timepoint_seconds:a,timepoint_end_seconds:r})});if(!t.ok){let e=await t.json().catch(()=>null);throw Error((null==e?void 0:e.details)||(null==e?void 0:e.error)||"Failed to update timepoints")}let s=await t.json();ee(t=>({...t,[e.id]:{start:a,end:r}})),null==i||i(s),B(null)}catch(e){console.error("Failed to update timepoints:",e),alert("Failed to update timepoints")}finally{V(null)}},className:"px-2 py-1 bg-emerald-600 text-white rounded text-xs hover:bg-emerald-700 disabled:opacity-50",disabled:W===e.id,children:W===e.id?"Saving...":"Save"}),(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),B(null)},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs hover:bg-gray-400",children:"Cancel"})]})]}):(0,r.jsx)("div",{className:"mt-1",children:(0,r.jsx)("button",{onClick:t=>{t.stopPropagation();let a="number"==typeof e.timepoint_seconds?e.timepoint_seconds:null,r="number"==typeof e.timepoint_end_seconds?e.timepoint_end_seconds:null,s=em(a),n=em(r);q(s.min),H(s.sec),Y(n.min),Q(n.sec),B(e.id)},className:"text-[11px] text-indigo-600 hover:text-indigo-800 underline",children:"Edit start/end"})}),s&&null!==ec&&ec<=10&&(0,r.jsx)("div",{className:"text-4xl font-extrabold text-red-600 animate-pulse",children:Math.ceil(ec)}),(0,r.jsx)("div",{className:"text-base text-gray-600 mt-1",children:0===(c[e.id]||[]).length?"No positions":(c[e.id]||[]).map((t,a)=>(0,r.jsxs)("span",{children:[a>0?", ":"",(0,r.jsx)("span",{className:t.student_name===_?"font-bold text-emerald-600":"",children:t.student_name})]},"".concat(e.id,"-pos-").concat(t.student_id,"-").concat(a)))}),(b[e.id]||[]).length>0&&(0,r.jsx)("div",{className:"mt-3 space-y-3 text-sm text-gray-700",children:(b[e.id]||[]).map((t,a)=>{let s=j[t.id]||[],n="number"==typeof t.timepoint_seconds?t.timepoint_seconds:null!==t.timepoint_seconds&&void 0!==t.timepoint_seconds?parseFloat(String(t.timepoint_seconds)):NaN,l="number"==typeof t.timepoint_end_seconds?t.timepoint_end_seconds:null!==t.timepoint_end_seconds&&void 0!==t.timepoint_end_seconds?parseFloat(String(t.timepoint_end_seconds)):NaN,i=Number.isFinite(n);return(0,r.jsxs)("div",{className:"",children:[(0,r.jsxs)("div",{className:"font-semibold text-gray-900",children:[a+1,". ",t.title]}),(0,r.jsxs)("div",{className:"text-gray-600",children:["Assigned:"," ",0===s.length?"—":s.map((e,a)=>(0,r.jsxs)("span",{children:[a>0?", ":"",(0,r.jsx)("span",{className:e===_?"font-bold text-emerald-600":"",children:e})]},"".concat(t.id,"-assigned-").concat(a)))]}),(0,r.jsxs)("div",{className:"text-gray-500",children:["Notes: ",t.description?t.description:"—"]}),(0,r.jsxs)("div",{className:"text-[11px] text-gray-500",children:["Time: ",Number.isFinite(n)?eu(n):"--:--"," / ",Number.isFinite(l)?eu(l):"--:--"]}),i&&(0,r.jsxs)("button",{onClick:t=>{t.stopPropagation(),eb(n,e.id)},className:"mt-1 text-[11px] text-indigo-600 hover:text-indigo-800 underline",children:["Jump to ",t.title," subpart"]})]},t.id)})}),(0,r.jsx)("div",{className:"mt-3",children:(0,r.jsx)("button",{onClick:t=>{t.stopPropagation();let a=e.timepoint_seconds,r="number"==typeof a?a:null!=a?parseFloat(a):null;null===r||Number.isNaN(r)||eb(r,e.id)},className:"text-xs text-blue-700 hover:text-blue-900 underline",children:"Jump to part"})}),P===e.id&&null!==C&&(0,r.jsx)("div",{className:"mt-2 text-center text-3xl font-extrabold text-red-600 animate-pulse",children:C})]},e.id)})})]}),(0,r.jsxs)("div",{className:"space-y-6",children:[(e=>{if(!e)return null;let t=b[e.id]||[];if(0===t.length)return null;let a=t.map(e=>{let t="number"==typeof e.timepoint_seconds?e.timepoint_seconds:Number(e.timepoint_seconds),a="number"==typeof e.timepoint_end_seconds?e.timepoint_end_seconds:Number(e.timepoint_end_seconds),r=Number.isFinite(t)?t:NaN,s=Number.isFinite(a)?a:NaN;return Number.isFinite(r)?{id:e.id,title:e.title,start:r,end:Number.isFinite(s)?s:r}:null}).filter(Boolean);if(0===a.length)return null;let s="number"==typeof e.timepoint_seconds?e.timepoint_seconds:Math.min(...a.map(e=>e.start)),n="number"==typeof e.timepoint_end_seconds?e.timepoint_end_seconds:Math.max(...a.map(e=>e.end)),l=Math.max(1,n-s),i=100*Math.min(1,Math.max(0,(o-s)/l));return(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 shadow-sm",children:[(0,r.jsx)("div",{className:"text-xs uppercase tracking-wide text-gray-500 mb-2",children:"Subpart Timeline"}),(0,r.jsxs)("div",{className:"relative h-16 rounded bg-slate-50 border border-slate-200 overflow-hidden",children:[a.map((e,t)=>{let n=(e.start-s)/l*100,i=Math.max(2,(e.end-e.start)/l*100),o=R===e.id;return(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"absolute top-0 h-full text-white text-base font-bold px-2 py-1 flex flex-col items-center justify-center text-center overflow-hidden leading-tight transition-all ".concat(L===e.id?"bg-emerald-500 border-2 border-emerald-700":o?"bg-emerald-600 border-2 border-emerald-800 shadow-[0_0_12px_rgba(16,185,129,0.85)] animate-pulse":"bg-orange-700 border-2 border-orange-900"),style:{left:"".concat(n,"%"),width:"".concat(i,"%")},children:[(0,r.jsx)("div",{children:e.title}),(0,r.jsx)("div",{className:"text-sm opacity-90",children:"Subpart"})]}),t<a.length-1&&(0,r.jsx)("div",{className:"absolute top-0 h-full w-[4px] bg-orange-900",style:{left:"".concat(n+i,"%")}})]},e.id)}),(0,r.jsx)("div",{className:"absolute top-0 h-full w-[3px] bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.7)]",style:{left:"".concat(i,"%")}})]}),(0,r.jsxs)("div",{className:"mt-1 text-[11px] text-gray-500",children:[eu(s)," - ",eu(n)]})]})})(eo),(0,r.jsxs)("div",{className:"grid grid-cols-1 2xl:grid-cols-2 gap-6",children:[ey("Next",ed,!0),ey("Current",eo,!1)]}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-4 text-xs text-gray-600",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"inline-block h-3 w-3 rounded-full bg-blue-600"}),"Current part"]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"inline-block h-3 w-3 rounded-full bg-purple-600"}),"Next part"]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"inline-block h-3 w-3 rounded-full bg-blue-600 border border-blue-800"}),"Student position"]})]}),(eo||ed)&&(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 text-xs text-gray-700",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-900 mb-2",children:"Legend"}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[11px] font-semibold text-blue-700 uppercase tracking-wide mb-2",children:"Current Part"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2",children:[Array.from(new Map((eo&&c[eo.id]||[]).map(e=>[e.student_id,e])).values()).map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("div",{className:"w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-[10px] font-bold",children:y(e.student_name)}),(0,r.jsx)("span",{className:"truncate",children:e.student_name})]},"current-".concat(null==eo?void 0:eo.id,"-").concat(e.student_id))),0===(eo&&c[eo.id]||[]).length&&(0,r.jsx)("div",{className:"text-[11px] text-gray-500",children:"No positions"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[11px] font-semibold text-purple-700 uppercase tracking-wide mb-2",children:"Next Part"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2",children:[Array.from(new Map((ed&&c[ed.id]||[]).map(e=>[e.student_id,e])).values()).map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("div",{className:"w-6 h-6 bg-purple-600 text-white rounded-full flex items-center justify-center text-[10px] font-bold",children:y(e.student_name)}),(0,r.jsx)("span",{className:"truncate",children:e.student_name})]},"next-".concat(null==ed?void 0:ed.id,"-").concat(e.student_id))),0===(ed&&c[ed.id]||[]).length&&(0,r.jsx)("div",{className:"text-[11px] text-gray-500",children:"No positions"})]})]})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsx)("div",{className:"min-h-[180px]",children:ef(eo)}),(0,r.jsx)("div",{className:"min-h-[180px]",children:ef(ed)})]}),(0,r.jsxs)("div",{className:"max-w-xl space-y-3",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-3 rounded-lg border-2 border-blue-600 bg-blue-50 p-3",children:[(0,r.jsx)("div",{className:"text-xs font-extrabold uppercase tracking-widest text-blue-700",children:"Filter by person"}),(0,r.jsxs)("select",{value:_,onChange:e=>k(e.target.value),className:"min-w-[160px] px-2 py-1 border border-blue-200 rounded text-sm bg-white",children:[(0,r.jsx)("option",{value:"",children:"All"}),ex.map(e=>(0,r.jsx)("option",{value:e,children:e},e))]}),(0,r.jsxs)("div",{className:"ml-auto flex items-center gap-3 text-xs font-semibold text-blue-700",children:[I&&(0,r.jsxs)("div",{children:["Call Time: ",(0,r.jsx)("span",{className:"font-bold",children:I})]}),(0,r.jsxs)("label",{className:"flex items-center gap-2",children:[(0,r.jsx)("input",{type:"checkbox",checked:h,onChange:e=>g(e.target.checked),className:"h-4 w-4"}),"Ring at T-10"]})]})]}),(0,r.jsx)(f,{musicUrl:n||void 0,onTimeUpdate:e=>d(e),audioRef:et})]})]})]})]})})})}var j=a(1517);function N(e){let{partId:t}=e,[a,n]=(0,s.useState)([]),[l,i]=(0,s.useState)(!1),[o,d]=(0,s.useState)(""),[c,u]=(0,s.useState)(""),[m,p]=(0,s.useState)(""),[x,h]=(0,s.useState)(""),[g,b]=(0,s.useState)(""),[f,y]=(0,s.useState)(""),[v,j]=(0,s.useState)(null),[N,w]=(0,s.useState)(""),[S,_]=(0,s.useState)(""),[k,C]=(0,s.useState)(""),[E,T]=(0,s.useState)(""),[D,P]=(0,s.useState)(""),[F,I]=(0,s.useState)(""),O=e=>{if(null==e||""===e)return{min:"",sec:""};let t=Number(e);if(!Number.isFinite(t))return{min:"",sec:""};let a=Math.floor(t/60),r=Math.floor(t%60);return{min:String(a),sec:String(r)}},M=(e,t)=>{if(!e&&!t)return null;let a=e?parseInt(e,10):0,r=t?parseFloat(t):0;return Number.isNaN(a)||Number.isNaN(r)?null:60*a+r},A=e=>{if(null==e||""===e)return"--:--";let t=Number(e);if(!Number.isFinite(t))return"--:--";let a=Math.floor(t/60),r=Math.floor(t%60);return"".concat(a,":").concat(r.toString().padStart(2,"0"))},L=(0,s.useCallback)(async()=>{if(!t)return void n([]);try{i(!0);let e=await fetch("/api/subparts?partId=".concat(t));if(!e.ok)throw Error("Failed to fetch subparts");let a=await e.json();n(a||[])}catch(e){console.error("Error fetching subparts:",e)}finally{i(!1)}},[t]);return((0,s.useEffect)(()=>{L()},[L]),t)?(0,r.jsxs)("div",{className:"border-t border-gray-200 pt-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-900",children:"Subparts / Solos"}),(0,r.jsx)("button",{onClick:L,className:"text-xs text-blue-600 hover:text-blue-800",children:"Refresh"})]}),l&&(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-2",children:"Loading..."}),0===a.length&&!l&&(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-2",children:"No subparts yet."}),(0,r.jsx)("div",{className:"space-y-2",children:a.map(e=>(0,r.jsx)("div",{className:"border border-gray-200 rounded p-2 text-xs",children:v===e.id?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("input",{type:"text",value:N,onChange:e=>w(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("textarea",{value:S,onChange:e=>_(e.target.value),rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:k,onChange:e=>C(e.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:E,onChange:e=>T(e.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:D,onChange:e=>P(e.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:F,onChange:e=>I(e.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:async()=>{try{if(!(await fetch("/api/subparts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:N,description:S,timepoint_seconds:M(k,E),timepoint_end_seconds:M(D,F)})})).ok)throw Error("Failed to update subpart");j(null),await L()}catch(e){alert(e instanceof Error?e.message:"Failed to update subpart")}},className:"px-2 py-1 bg-green-600 text-white rounded text-xs",children:"Save"}),(0,r.jsx)("button",{onClick:()=>j(null),className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]})]}):(0,r.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium text-gray-800",children:e.title}),e.mode&&(0,r.jsxs)("div",{className:"text-[10px] text-gray-400",children:["Mode: ",e.mode]}),e.description&&(0,r.jsx)("div",{className:"text-gray-600",children:e.description}),null!==e.timepoint_seconds||null!==e.timepoint_end_seconds?(0,r.jsxs)("div",{className:"text-[10px] text-gray-400",children:["Time: ",A(e.timepoint_seconds)," - ",A(e.timepoint_end_seconds)]}):(0,r.jsx)("div",{className:"text-[10px] text-gray-400",children:"Time: --:-- - --:--"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>{j(e.id),w(e.title),_(e.description||"");let t=O(e.timepoint_seconds),a=O(e.timepoint_end_seconds);C(t.min),T(t.sec),P(a.min),I(a.sec)},className:"text-[10px] text-blue-600 hover:text-blue-800",children:"Edit"}),(0,r.jsx)("button",{onClick:async()=>{if(window.confirm("Delete this subpart?"))try{if(!(await fetch("/api/subparts/".concat(e.id),{method:"DELETE"})).ok)throw Error("Failed to delete subpart");await L()}catch(e){alert(e instanceof Error?e.message:"Failed to delete subpart")}},className:"text-[10px] text-red-600 hover:text-red-800",children:"Delete"})]})]})},e.id))}),(0,r.jsxs)("div",{className:"mt-3 border-t border-gray-200 pt-3",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-700 text-xs mb-2",children:"Add Subpart"}),(0,r.jsx)("input",{type:"text",value:o,onChange:e=>d(e.target.value),placeholder:"Subpart title",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2"}),(0,r.jsx)("textarea",{value:c,onChange:e=>u(e.target.value),placeholder:"Description",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:m,onChange:e=>p(e.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:x,onChange:e=>h(e.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,r.jsx)("input",{type:"number",min:"0",value:g,onChange:e=>b(e.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",value:f,onChange:e=>y(e.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsx)("button",{onClick:async()=>{let e=o.trim(),a=c.trim();if(e)try{if(!(await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:t,title:e,description:a||null,mode:"position",timepoint_seconds:M(m,x),timepoint_end_seconds:M(g,f)})})).ok)throw Error("Failed to create subpart");d(""),u(""),p(""),h(""),b(""),y(""),await L()}catch(e){alert(e instanceof Error?e.message:"Failed to create subpart")}},className:"px-2 py-1 bg-blue-600 text-white rounded text-xs",children:"Add Subpart"})]})]}):null}var w=a(5959),S=a(701);function _(e){let t=Math.max(0,Math.floor(e)),a=Math.floor(t/60);return"".concat(a,":").concat((t%60).toString().padStart(2,"0"))}function k(e){if(!e)return null;let t=e.trim();if(!t)return null;if(/^\d+(\.\d+)?$/.test(t))return Math.max(0,parseFloat(t));let a=t.split(":");if(2===a.length){let e=parseInt(a[0],10),t=parseFloat(a[1]);return Number.isNaN(e)||Number.isNaN(t)?null:Math.max(0,60*e+t)}return null}function C(){return Math.random().toString(36).slice(2,10)+Date.now().toString(36)}function E(e){let{performanceId:t,parts:a,musicUrl:n,performanceTitle:l,onPartsUpdated:i}=e,[o,d]=(0,s.useState)([]),[c,u]=(0,s.useState)(null),[m,p]=(0,s.useState)(0),[x,h]=(0,s.useState)({}),[g,b]=(0,s.useState)({}),[y,v]=(0,s.useState)({}),[j,N]=(0,s.useState)(!1),[w,S]=(0,s.useState)("New Marking Session"),[E,T]=(0,s.useState)(!1),[D,P]=(0,s.useState)([]),[F,I]=(0,s.useState)(""),[O,M]=(0,s.useState)(!1),[A,L]=(0,s.useState)({}),[U,R]=(0,s.useState)(null),J=(0,s.useRef)(null),z=(0,s.useRef)(null),B=(0,s.useRef)(null),[G,q]=(0,s.useState)(180),[X,H]=(0,s.useState)({}),[K,Y]=(0,s.useState)({}),[Z,Q]=(0,s.useState)(null),W=(0,s.useRef)(null),[V,$]=(0,s.useState)(null),[ee,et]=(0,s.useState)({}),[ea,er]=(0,s.useState)({}),[es,en]=(0,s.useState)({}),[el,ei]=(0,s.useState)({}),[eo,ed]=(0,s.useState)(null),[ec,eu]=(0,s.useState)(1),[em,ep]=(0,s.useState)({}),[ex,eh]=(0,s.useState)({}),[eg,eb]=(0,s.useState)(null),ef=(0,s.useMemo)(()=>{let e=[];a.forEach(t=>{var a,r,s,n;let l=X[t.id],i=null!=(r=null!=(a=null==l?void 0:l.start)?a:t.timepoint_seconds)?r:null,o=null!=(n=null!=(s=null==l?void 0:l.end)?s:t.timepoint_end_seconds)?n:null;null!==i&&e.push(i),null!==o&&e.push(o),null!==i&&null===o&&e.push(i+10)}),Object.values(g).flat().forEach(t=>{var a,r,s,n;let l=K[t.id],i=null!=(r=null!=(a=null==l?void 0:l.start)?a:t.timepoint_seconds)?r:null,o=null!=(n=null!=(s=null==l?void 0:l.end)?s:t.timepoint_end_seconds)?n:null;null!==i&&e.push(i),null!==o&&e.push(o),null!==i&&null===o&&e.push(i+10)});let t=e.length?Math.max(...e):0;return U&&Number.isFinite(U)?Math.max(U,t,10):Math.max(G,t,10)},[U,G,a,g,X,K]);(0,s.useEffect)(()=>()=>{var e;null==(e=J.current)||e.call(J)},[]),(0,s.useEffect)(()=>{if(!Z)return;let e=e=>{if(!B.current||!W.current)return;let t=B.current.getBoundingClientRect(),a=(e.clientX-t.left)/t.width*ef-W.current.offsetSec,r=W.current.duration,s=Math.round(Math.max(0,Math.min(ef-r,a)));ej(W.current.partId,s,s+r),$({partId:W.current.partId,time:s})},t=()=>{Q(null),W.current=null,$(null)};return window.addEventListener("mousemove",e),window.addEventListener("mouseup",t),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)}},[Z,ef]);let ey=(0,s.useMemo)(()=>{let e={};return Object.values(x).forEach(t=>{"string"==typeof t?e[t]=(e[t]||0)+1:(null==t?void 0:t.markId)&&(e[t.markId]=(e[t.markId]||0)+1)}),e},[x]);(0,s.useEffect)(()=>{if(0===o.length){let e={id:C(),label:"Row 1",note:"",marks:[]};d([e]),u(e.id)}},[o.length]),(0,s.useEffect)(()=>{E||S("".concat(new Date().toLocaleString()," \xb7 ").concat(l||"Performance"))},[l,E]);let ev=(0,s.useCallback)(e=>{var t,a,r,s;let n=X[e.id];return{start:null!=(a=null!=(t=null==n?void 0:n.start)?t:e.timepoint_seconds)?a:null,end:null!=(s=null!=(r=null==n?void 0:n.end)?r:e.timepoint_end_seconds)?s:null}},[X]),ej=(e,t,a)=>{H(r=>({...r,[e]:{start:t,end:a}}))},eN=(e,t,a)=>{Y(r=>({...r,[e]:{start:t,end:a}}))};(0,s.useEffect)(()=>{t&&(async()=>{let e=await Promise.all(a.map(async e=>{let t=await fetch("/api/subparts?partId=".concat(e.id));if(!t.ok)return[e.id,[]];let a=await t.json();return[e.id,a||[]]})),t={};e.forEach(e=>{let[a,r]=e;t[a]=r}),b(t)})()},[t,a]),(0,s.useEffect)(()=>{a&&0!==a.length&&ep(e=>{let t={...e};return a.forEach(e=>{null!==e.timeline_row&&void 0!==e.timeline_row&&(t[e.id]=e.timeline_row)}),t})},[a]),(0,s.useEffect)(()=>{t&&(async()=>{let e=await fetch(O?"/api/marking-sessions?all=1":"/api/marking-sessions?performanceId=".concat(t));e.ok&&P(await e.json()||[])})()},[t,O]),(0,s.useEffect)(()=>{(async()=>{let e=await fetch("/api/performances");if(!e.ok)return;let t=await e.json(),a={};(t||[]).forEach(e=>{a[e.id]=e.title||"Performance"}),L(a)})()},[]),(0,s.useEffect)(()=>{let e=e=>{var t,a;let r=e.target,s=null==r||null==(t=r.tagName)?void 0:t.toLowerCase();if("input"!==s&&"textarea"!==s&&"select"!==s){if("Space"===e.code){e.preventDefault();let t=c||(null==(a=o[0])?void 0:a.id);if(!t)return;let r={id:C(),time:m,createdAt:new Date().toISOString()};d(e=>e.map(e=>e.id===t?{...e,marks:[...e.marks,r]}:e))}if("e"===e.key||"E"===e.key){e.preventDefault();let t=o.length+1,a={id:C(),label:"Row ".concat(t),note:"",marks:[]};d(e=>{let t=c?e.findIndex(e=>e.id===c):e.length-1;if(-1===t)return[...e,a];let r=[...e];return r.splice(t+1,0,a),r}),u(a.id)}}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[c,m,o]);let ew=e=>{for(let t of o){let a=t.marks.find(t=>t.id===e);if(a)return a.time}return null},eS=(0,s.useMemo)(()=>{let e=["bg-amber-50 border-amber-300 text-amber-950","bg-emerald-50 border-emerald-300 text-emerald-950","bg-sky-50 border-sky-300 text-sky-950","bg-rose-50 border-rose-300 text-rose-950","bg-lime-50 border-lime-300 text-lime-950","bg-fuchsia-50 border-fuchsia-300 text-fuchsia-950","bg-orange-50 border-orange-300 text-orange-950","bg-teal-50 border-teal-300 text-teal-950"],t={};return a.forEach((a,r)=>{t[a.id]=e[r%e.length]}),t},[a]),e_=async(e,t)=>{await Promise.all(t.map((e,t)=>fetch("/api/subparts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:t+1})})))},ek=(e,t,a)=>{b(r=>{let s={...r},n=[...s[e]||[]],l=n.findIndex(e=>e.id===t);if(-1===l)return r;let i="up"===a?l-1:l+1;if(i<0||i>=n.length)return r;let[o]=n.splice(l,1);return n.splice(i,0,o),s[e]=n,e_(e,n),s})},eC=(0,s.useMemo)(()=>{let e=[],t=[];a.forEach(a=>{let{start:r,end:s}=ev(a);if(null===r)return void t.push(a);e.push({id:a.id,name:a.name,start:r,end:null!=s?s:r+10,missingEnd:null===s})}),e.sort((e,t)=>e.start-t.start);let r=[];e.forEach(e=>{var t,s;let n=a.find(t=>t.id===e.id),l=null!=(s=null!=(t=em[e.id])?t:null==n?void 0:n.timeline_row)?s:void 0;if(void 0!==l){for(;r.length<=l;)r.push({id:C(),items:[]});r[l].items.push(e);return}let i=!1;for(let t of r){let a=t.items[t.items.length-1];if(!a||e.start>=a.end){t.items.push(e),i=!0;break}}i||r.push({id:C(),items:[e]})}),r.forEach(e=>e.items.sort((e,t)=>e.start-t.start));let s=r.length;if(ec>r.length)for(let e=r.length;e<ec;e+=1)r.push({id:C(),items:[],manual:!0});return{rows:r,unassigned:t,autoRowCount:s}},[a,ec,em,ev]),eE=e=>{var t;let a=x[e];if(!a)return null;if("string"==typeof a){for(let e of o){let t=e.marks.find(e=>e.id===a);if(t)return t.time}return null}return null!=(t=a.time)?t:null},eT=(e,t)=>{let[a,r,s]=e.split(":"),n=eD(a,r,s),l=(e=>{var t;if(!e)return null;if("string"==typeof e){for(let t of o){let a=t.marks.find(t=>t.id===e);if(a)return a.time}return null}return null!=(t=e.time)?t:null})(t),i=null!=l?l:n,d=null!==i?_(i):"Unassigned",c=new Date().toLocaleString();eh(a=>({...a,[e]:[{prev:t,label:d,at:c},...a[e]||[]].slice(0,6)}))},eD=(e,t,r)=>{var s,n,l,i;if("part"===e){let e=a.find(e=>e.id===t);return e?"start"===r?null!=(s=e.timepoint_seconds)?s:null:null!=(n=e.timepoint_end_seconds)?n:null:null}let o=Object.values(g).flat().find(e=>e.id===t);return o?"start"===r?null!=(l=o.timepoint_seconds)?l:null:null!=(i=o.timepoint_end_seconds)?i:null:null},eP=(e,t,a)=>{let s="".concat(e,":").concat(t,":").concat(a),n=x[s],l="string"==typeof n?n:null==n?void 0:n.markId,i=eE(s),d=eD(e,t,a),c=null!==i?i:d,u=ex[s]||[];return(0,r.jsxs)("div",{className:"relative border border-dashed rounded px-2 py-1 text-xs flex items-center gap-2 ".concat(l?"border-emerald-400 bg-emerald-50":"border-gray-300 bg-white"),onDragOver:e=>e.preventDefault(),onDrop:e=>{let t=e.dataTransfer.getData("markId");t&&((e,t)=>{var a;let[r,s,n]=e.split(":"),l=null==(a=o.flatMap(e=>e.marks).find(e=>e.id===t))?void 0:a.time;if(void 0===l)return;let i="start"===n?"end":"start",d=eE("".concat(r,":").concat(s,":").concat(i)),c=eD(r,s,i),u=null!=d?d:c;return"end"===n&&null!==u&&l<u?alert("End time cannot be before start time."):"start"===n&&null!==u&&l>u?alert("Start time cannot be after end time."):h(a=>(eT(e,a[e]),{...a,[e]:{markId:t,time:l}}))})(s,t)},children:[(0,r.jsx)("span",{className:"text-gray-500 uppercase",children:a}),(0,r.jsx)("span",{className:"font-semibold text-gray-800",children:null!==c?_(c):"--:--"}),l&&(0,r.jsx)("span",{className:"ml-1 px-2 py-0.5 rounded-full text-[10px] bg-emerald-600 text-white",children:"Chip"}),u.length>0&&(0,r.jsx)("button",{onClick:()=>(e=>{let t=ex[e];if(!t||0===t.length)return;let[a,...r]=t;eh(t=>({...t,[e]:r})),h(t=>{let r={...t};return a.prev?r[e]=a.prev:delete r[e],r})})(s),className:"ml-auto text-[10px] text-gray-700 hover:text-gray-900",title:"Undo last change",children:"Undo"}),(0,r.jsx)("button",{onClick:()=>eb(e=>e===s?null:s),className:"text-[10px] text-gray-500 hover:text-gray-700",title:"History",children:"Log"}),l&&(0,r.jsx)("button",{onClick:()=>{h(e=>{eT(s,e[s]);let t={...e};return delete t[s],t})},className:"ml-auto text-red-600 hover:text-red-800",title:"Remove",children:"x"}),eg===s&&(0,r.jsxs)("div",{className:"absolute right-0 top-full mt-1 w-44 rounded border border-gray-200 bg-white shadow-lg p-2 text-[10px] text-gray-600 z-20",children:[0===u.length&&(0,r.jsx)("div",{children:"No history yet"}),u.map((e,t)=>(0,r.jsxs)("div",{className:"border-b border-gray-100 pb-1 mb-1 last:border-0 last:pb-0 last:mb-0",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-800",children:e.label}),(0,r.jsx)("div",{children:e.at})]},"".concat(e.at,"-").concat(t)))]})]})},eF=async()=>{let e=await fetch("/api/marking-sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:t,title:w||"Marking Session",rows:o,assignments:x})});if(e.ok){let t=await e.json();P(e=>[t,...e])}},eI=async()=>{N(!0);try{let e={},t={};Object.entries(x).forEach(a=>{var r;let[s,n]=a,[l,i,d]=s.split(":");"string"==typeof n||null==n||n.markId;let c="string"==typeof n?null==(r=o.flatMap(e=>e.marks).find(e=>e.id===n))?void 0:r.time:null==n?void 0:n.time;null!=c&&("part"===l?(e[i]=e[i]||{},e[i]["start"===d?"timepoint_seconds":"timepoint_end_seconds"]=c):(t[i]=t[i]||{},t[i]["start"===d?"timepoint_seconds":"timepoint_end_seconds"]=c))});let r=[],s=[];await Promise.all(Object.entries(e).map(async e=>{let[t,a]=e,s=await fetch("/api/parts/".concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(s.ok){let e=await s.json();r.push(e)}})),await Promise.all(Object.entries(t).map(async e=>{let[t,a]=e,r=await fetch("/api/subparts/".concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(r.ok){let e=await r.json();e&&s.push(e)}})),r.length>0&&i(a.map(e=>r.find(t=>t.id===e.id)||e)),s.length>0&&b(e=>{let t={...e};return s.forEach(e=>{t[e.part_id]=(t[e.part_id]||[]).map(t=>t.id===e.id?{...t,...e}:t)}),t})}finally{N(!1)}},eO=async()=>{N(!0);try{let e={},t={};a.forEach(t=>{var a,r;let{start:s,end:n}=ev(t),l=null!=(r=null!=(a=em[t.id])?a:t.timeline_row)?r:null;null!==s||null!==l?e[t.id]={timepoint_seconds:s,timepoint_end_seconds:null!=n?n:null,timeline_row:l}:null!==t.timeline_row&&void 0!==t.timeline_row&&(e[t.id]={timeline_row:null})}),Object.values(g).flat().forEach(e=>{var a,r,s,n;let l=K[e.id],i=null!=(r=null!=(a=null==l?void 0:l.start)?a:e.timepoint_seconds)?r:null,o=null!=(n=null!=(s=null==l?void 0:l.end)?s:e.timepoint_end_seconds)?n:null;null!==i&&(t[e.id]={timepoint_seconds:i,timepoint_end_seconds:null!=o?o:null})});let r=[];await Promise.all(Object.entries(e).map(async e=>{let[t,a]=e,s=await fetch("/api/parts/".concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(s.ok){let e=await s.json();r.push(e)}})),await Promise.all(Object.entries(t).map(async e=>{let[t,a]=e;await fetch("/api/subparts/".concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})})),r.length>0&&i(a.map(e=>r.find(t=>t.id===e.id)||e))}finally{N(!1)}};return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)("div",{className:"w-full -mx-4 px-4",children:(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4 w-full",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,r.jsx)("div",{className:"text-lg font-semibold text-gray-900",children:"Timeline"}),(0,r.jsxs)("div",{className:"ml-auto flex items-center gap-2",children:[!U&&(0,r.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[(0,r.jsx)("span",{children:"Timeline length (sec)"}),(0,r.jsx)("input",{type:"number",min:10,value:G,onChange:e=>q(parseInt(e.target.value||"0",10)||0),className:"w-20 px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,r.jsx)("button",{onClick:()=>eu(e=>e+1),className:"px-3 py-1 border border-gray-300 rounded text-xs text-gray-700 hover:bg-gray-50",children:"Add Row"}),(0,r.jsx)("button",{onClick:eO,disabled:j,className:"px-3 py-1 bg-indigo-600 text-white rounded text-sm disabled:bg-gray-400",children:j?"Saving...":"Save Timeline"})]})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"Drag parts to move them. Drop chips or type times to set Start/End."}),(0,r.jsxs)("div",{className:"mt-3 space-y-4",children:[eC.rows.map((e,t)=>(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 text-xs font-semibold text-gray-600",children:[(0,r.jsxs)("span",{children:["Row ",t+1]}),t>=eC.autoRowCount&&0===e.items.length&&(0,r.jsx)("button",{onClick:()=>eu(e=>Math.max(1,e-1)),className:"ml-auto text-[11px] text-gray-500 hover:text-gray-800",children:"Remove row"})]}),(0,r.jsx)("div",{ref:0===t?B:void 0,className:"relative h-36 border border-gray-200 rounded bg-gray-50 overflow-visible",onDragOver:e=>e.preventDefault(),onDrop:e=>{let r=e.dataTransfer.getData("partId");if(!r)return;let s=e.currentTarget.getBoundingClientRect(),n=Math.max(0,Math.min(ef-10,Math.round((e.clientX-s.left)/s.width*ef))),l=a.find(e=>e.id===r),{start:i,end:o}=l?ev(l):{start:null,end:null};ej(r,n,n+Math.max(1,null!==i&&null!==o?o-i:10)),ep(e=>({...e,[r]:t}))},children:e.items.map(e=>{var t,s;let n=e.start/ef*100,l=(e.end-e.start)/ef*100,i=a.find(t=>t.id===e.id),o=i&&g[i.id]||[],d=eS[e.id]||"bg-white border-gray-300 text-gray-900",{start:c,end:u}=i?ev(i):{start:null,end:null};return(0,r.jsxs)("div",{className:"absolute top-2 h-[120px] rounded border px-3 py-2 shadow-sm cursor-move ".concat(d," ").concat(e.missingEnd?"border-blue-400":""),style:{left:"".concat(n,"%"),width:"".concat(Math.max(4,l),"%")},onMouseDown:t=>{if(["INPUT","TEXTAREA","BUTTON"].includes(t.target.tagName)||!B.current)return;let a=B.current.getBoundingClientRect(),r=(t.clientX-a.left)/a.width*ef-e.start;W.current={partId:e.id,duration:e.end-e.start,offsetSec:r},Q(e.id),$({partId:e.id,time:e.start})},children:[(null==V?void 0:V.partId)===e.id&&(0,r.jsx)("div",{className:"absolute -top-6 left-0 px-2 py-0.5 rounded bg-gray-900 text-white text-[10px]",children:function(e){let t=Math.max(0,Math.floor(e)),a=Math.floor(t/3600),r=Math.floor(t%3600/60),s=t%60;return a>0?"".concat(a,":").concat(r.toString().padStart(2,"0"),":").concat(s.toString().padStart(2,"0")):"".concat(r,":").concat(s.toString().padStart(2,"0"))}(V.time)}),(0,r.jsx)("div",{className:"text-sm font-semibold truncate",children:e.name}),(0,r.jsxs)("div",{className:"mt-2 grid grid-cols-2 gap-1 text-[11px]",children:[(0,r.jsxs)("div",{className:"border border-dashed rounded px-1 py-0.5 ".concat(e.missingEnd?"border-blue-400 bg-blue-50":"border-gray-300 bg-white"),onDragOver:e=>e.preventDefault(),onDrop:t=>{let a=t.dataTransfer.getData("markId");if(!a)return;let r=ew(a);if(null===r)return;let s=null!==u&&r>u?r:u;ej(e.id,r,s)},children:["Start:",(0,r.jsx)("input",{className:"ml-1 w-12 bg-transparent",value:null!=(t=ee[e.id])?t:null!==c?_(c):"",onChange:t=>et(a=>({...a,[e.id]:t.target.value})),onKeyDown:t=>{var a;if("Enter"!==t.key)return;let r=k(null!=(a=ee[e.id])?a:"");null!==r&&(null!==u&&r>u||(ej(e.id,r,u),et(t=>({...t,[e.id]:""}))))}})]}),(0,r.jsxs)("div",{className:"border border-dashed rounded px-1 py-0.5 ".concat(e.missingEnd?"border-blue-400 bg-blue-50":"border-gray-300 bg-white"),onDragOver:e=>e.preventDefault(),onDrop:t=>{let a=t.dataTransfer.getData("markId");if(!a)return;let r=ew(a);null!==r&&(null!==c&&r<c||ej(e.id,c,r))},children:["End:",(0,r.jsx)("input",{className:"ml-1 w-12 bg-transparent",value:null!=(s=ea[e.id])?s:null!==u?_(u):"",onChange:t=>er(a=>({...a,[e.id]:t.target.value})),onKeyDown:t=>{var a;if("Enter"!==t.key)return;let r=k(null!=(a=ea[e.id])?a:"");null!==r&&(null!==c&&r<c||(ej(e.id,c,r),er(t=>({...t,[e.id]:""}))))}})]})]}),o.length>0&&(0,r.jsxs)("div",{className:"mt-2",children:[(0,r.jsx)("div",{className:"flex flex-wrap gap-1",children:o.map(e=>(0,r.jsx)("span",{className:"px-2 py-0.5 rounded-full bg-white/80 text-[10px] border border-gray-200",title:e.title,children:e.title},e.id))}),(0,r.jsx)("button",{onClick:()=>ed(t=>t===e.id?null:e.id),className:"mt-2 text-[11px] text-blue-700 hover:text-blue-900 underline",children:eo===e.id?"Hide subparts":"Subparts"})]}),eo===e.id&&(0,r.jsxs)("div",{className:"absolute left-0 top-full mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg p-3 z-20",children:[(0,r.jsxs)("div",{className:"text-xs font-semibold text-gray-800 mb-2",children:["Subparts for ",e.name]}),(0,r.jsx)("div",{className:"space-y-2",children:o.map(t=>{var a,s;let n=(e=>{var t,a,r,s;let n=K[e.id];return{start:null!=(a=null!=(t=null==n?void 0:n.start)?t:e.timepoint_seconds)?a:null,end:null!=(s=null!=(r=null==n?void 0:n.end)?r:e.timepoint_end_seconds)?s:null}})(t);return(0,r.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-800 truncate",children:t.title}),(0,r.jsxs)("div",{className:"mt-1 flex items-center gap-1",children:[(0,r.jsx)("input",{className:"w-12 bg-white border border-gray-200 rounded px-1",value:null!=(a=es[t.id])?a:null!==n.start?_(n.start):"",onChange:e=>en(a=>({...a,[t.id]:e.target.value})),onKeyDown:e=>{var a;if("Enter"!==e.key)return;let r=k(null!=(a=es[t.id])?a:"");null!==r&&(null!==n.end&&r>n.end||(eN(t.id,r,n.end),en(e=>({...e,[t.id]:""}))))}}),(0,r.jsx)("input",{className:"w-12 bg-white border border-gray-200 rounded px-1",value:null!=(s=el[t.id])?s:null!==n.end?_(n.end):"",onChange:e=>ei(a=>({...a,[t.id]:e.target.value})),onKeyDown:e=>{var a;if("Enter"!==e.key)return;let r=k(null!=(a=el[t.id])?a:"");null!==r&&(null!==n.start&&r<n.start||(eN(t.id,n.start,r),ei(e=>({...e,[t.id]:""}))))}})]})]}),(0,r.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,r.jsx)("button",{onClick:()=>ek(e.id,t.id,"up"),className:"px-2 py-0.5 border border-gray-200 rounded text-[10px]",children:"Up"}),(0,r.jsx)("button",{onClick:()=>ek(e.id,t.id,"down"),className:"px-2 py-0.5 border border-gray-200 rounded text-[10px]",children:"Down"})]})]},t.id)})})]})]},e.id)})})]},e.id)),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("div",{className:"text-xs font-semibold text-gray-600",children:"Unassigned"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[0===eC.unassigned.length&&(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"All parts assigned"}),eC.unassigned.map(e=>(0,r.jsx)("div",{draggable:!0,onDragStart:t=>t.dataTransfer.setData("partId",e.id),className:"px-2 py-1 rounded text-xs cursor-move ".concat(eS[e.id]||"bg-gray-200 text-gray-800"),children:e.name},e.id))]})]})]})]})}),(0,r.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-[320px_1fr] gap-6",children:[(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,r.jsx)("div",{className:"text-xl font-bold text-gray-900 mb-2",children:"Parts & Subparts"}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-4",children:"Drop time chips onto Start/End. Only dropped chips change timepoints when saved."}),(0,r.jsx)("div",{className:"space-y-4",children:a.map(e=>(0,r.jsxs)("div",{className:"border border-gray-200 rounded-lg p-3",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-900 mb-2",children:e.name}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[eP("part",e.id,"start"),eP("part",e.id,"end")]}),(g[e.id]||[]).length>0&&(0,r.jsx)("div",{className:"mt-2 space-y-2",children:(g[e.id]||[]).map(e=>(0,r.jsxs)("div",{className:"border border-gray-100 rounded p-2 bg-gray-50",children:[(0,r.jsx)("div",{className:"text-sm font-semibold text-gray-800",children:e.title}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 mt-2",children:[eP("subpart",e.id,"start"),eP("subpart",e.id,"end")]})]},e.id))}),(0,r.jsxs)("div",{className:"mt-3 flex items-center gap-2",children:[(0,r.jsx)("input",{type:"text",value:y[e.id]||"",onChange:t=>v(a=>({...a,[e.id]:t.target.value})),placeholder:"Add subpart",className:"flex-1 px-2 py-1 border border-gray-300 rounded text-xs"}),(0,r.jsx)("button",{onClick:async()=>{let t=(y[e.id]||"").trim();if(!t)return;let a=(g[e.id]||[]).length+1,r=await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:e.id,title:t,order:a})});if(r.ok){let t=await r.json();b(a=>({...a,[e.id]:[...a[e.id]||[],t]})),v(t=>({...t,[e.id]:""}))}},className:"px-2 py-1 bg-gray-900 text-white rounded text-xs",children:"Add"})]})]},e.id))})]}),(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-3",children:[(0,r.jsx)("div",{className:"text-xl font-bold text-gray-900",children:"Marking Session"}),(0,r.jsxs)("div",{className:"ml-auto flex gap-2 items-center",children:[(0,r.jsx)("input",{value:w,onChange:e=>{S(e.target.value),T(!0)},className:"px-3 py-1 border border-gray-300 rounded text-sm",placeholder:"Session title"}),(0,r.jsx)("button",{onClick:eF,className:"px-3 py-1 bg-gray-900 text-white rounded text-sm",children:"Save Session"}),(0,r.jsx)("button",{onClick:eI,disabled:j,className:"px-3 py-1 bg-blue-600 text-white rounded text-sm disabled:bg-gray-400",children:j?"Saving...":"Apply Timepoints"})]})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-2",children:"Hotkeys: Space = mark time, E = new row. Works while music is playing or paused."}),(0,r.jsxs)("div",{className:"text-xs text-gray-500 mt-1",children:["Music length: ",U?_(U):"\xef\xbf\xbd"]}),(0,r.jsx)("div",{className:"mt-3 bg-gray-50 border border-dashed border-gray-300 rounded p-3 text-xs text-gray-500",children:"Waveform view: not available yet. We can add a waveform preview in a follow-up."}),(0,r.jsxs)("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[(0,r.jsxs)("select",{value:F,onChange:async e=>{let t=e.target.value;if(I(t),!t)return;let a=await fetch("/api/marking-sessions/".concat(t));if(!a.ok)return;let r=await a.json();S(r.title||"Marking Session"),T(!0);let s=(r.rows||[]).map(e=>({...e,note:e.note||""}));d(s),h(((e,t)=>{let a={};return Object.entries(t||{}).forEach(t=>{let[r,s]=t;if("string"==typeof s){let t=e.flatMap(e=>e.marks).find(e=>e.id===s);t&&(a[r]={markId:s,time:t.time})}else s&&"object"==typeof s&&(a[r]=s)}),a})(s,r.assignments||{}))},className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,r.jsx)("option",{value:"",children:"Load saved session..."}),D.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.title||"Untitled"," \xef\xbf\xbd ",A[e.performance_id]||"Performance"," \xef\xbf\xbd ",new Date(e.created_at).toLocaleString()]},e.id))]}),(0,r.jsxs)("label",{className:"text-xs text-gray-600 flex items-center gap-2",children:[(0,r.jsx)("input",{type:"checkbox",checked:O,onChange:e=>M(e.target.checked),className:"h-4 w-4"}),"Show sessions from all performances"]}),(0,r.jsx)("button",{onClick:()=>{let e={id:C(),label:"Row 1",note:"",marks:[]};d([e]),u(e.id),h({}),I(""),T(!1)},className:"px-2 py-1 border border-gray-300 rounded text-sm",children:"New Session"})]})]}),(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,r.jsx)("div",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Mark Chips"}),(0,r.jsx)("div",{className:"space-y-4",children:o.map(e=>(0,r.jsxs)("div",{onClick:()=>u(e.id),className:"border rounded-lg p-3 cursor-pointer ".concat(c===e.id?"border-blue-400 bg-blue-50":"border-gray-200"),children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,r.jsx)("button",{onClick:()=>u(e.id),className:"px-2 py-1 rounded text-xs font-semibold ".concat(c===e.id?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"),children:e.label}),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:"Drop chips into the empty slot to organize."}),o.length>1&&(0,r.jsx)("button",{onClick:t=>{if(t.stopPropagation(),d(t=>t.filter(t=>t.id!==e.id)),c===e.id){let t=o.find(t=>t.id!==e.id);u(t?t.id:null)}},className:"ml-auto text-xs text-red-600 hover:text-red-800",children:"Delete Row"})]}),(0,r.jsx)("input",{value:e.note||"",onChange:t=>d(a=>a.map(a=>a.id===e.id?{...a,note:t.target.value}:a)),placeholder:"Row notes...",className:"w-full px-2 py-1 border border-gray-200 rounded text-xs mb-2"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[e.marks.map(t=>{let a=ey[t.id]||0;return(0,r.jsx)("div",{draggable:!0,onDragStart:e=>{e.dataTransfer.setData("markId",t.id)},className:"px-2 py-1 rounded text-xs cursor-move ".concat(a>=2?"bg-gray-200 text-gray-700":1===a?"bg-yellow-200 text-yellow-900":"bg-indigo-100 text-indigo-800"),children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{children:_(t.time)}),(0,r.jsx)("button",{onClick:()=>{var a,r;return a=e.id,r=t.id,void d(e=>e.map(e=>e.id===a?{...e,marks:e.marks.filter(e=>e.id!==r)}:e))},className:"text-[10px] text-gray-600 hover:text-gray-800",title:"Remove chip",children:"\xef\xbf\xbd"})]})},t.id)}),(0,r.jsx)("div",{className:"px-2 py-1 border border-dashed border-gray-300 rounded text-xs text-gray-500",onDragOver:e=>e.preventDefault(),onDrop:t=>{let a=t.dataTransfer.getData("markId");if(a){var r;r=e.id,d(e=>{let t=null,s=e.map(e=>{let r=e.marks.filter(e=>e.id!==a||(t=e,!1));return{...e,marks:r}});return t?s.map(e=>e.id===r?{...e,marks:[...e.marks,t]}:e):e})}},children:"Empty slot"})]}),(0,r.jsxs)("div",{className:"mt-2 text-[11px] text-gray-500",children:["Times:"," ",0===e.marks.length?"\xef\xbf\xbd":e.marks.map(e=>_(e.time)).join(", ")]})]},e.id))})]}),(0,r.jsx)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:(0,r.jsx)(f,{musicUrl:n||void 0,onTimeUpdate:e=>p(e),onAudioReady:e=>{if(J.current&&J.current(),!e){R(null),J.current=null;return}let t=()=>{R(Number.isFinite(e.duration)?e.duration:null)};e.addEventListener("loadedmetadata",t),e.addEventListener("durationchange",t),t(),J.current=()=>{e.removeEventListener("loadedmetadata",t),e.removeEventListener("durationchange",t)}},audioRef:z})})]})]})]})}var T=a(2992),D=a(9157);function P(e){var t,a,n,d;let{params:c}=e,{id:u}=(0,s.use)(c),p="rehearse:performance-info:".concat(u),h=(0,T.C_)(p),[y,_]=(0,s.useState)(null),[k,C]=(0,s.useState)(!0),[P,O]=(0,s.useState)("rehearsals"),[M,A]=(0,s.useState)(!1),[L,U]=(0,s.useState)(!1),[R,J]=(0,s.useState)(null),[z,B]=(0,s.useState)(null),[G,q]=(0,s.useState)(!1),[X,H]=(0,s.useState)(!1),[K,Y]=(0,s.useState)(!0),[Z,Q]=(0,s.useState)(!1),[W,V]=(0,s.useState)(null),[$,ee]=(0,s.useState)((null==h?void 0:h.infoForm)||{title:"",call_time:"",timezone:"America/New_York",date:"",location:"",description:"",phone_numbers:""}),[et,ea]=(0,s.useState)(null!=(d=null==h?void 0:h.callTimeManual)&&d),[er,es]=(0,s.useState)((null==h?void 0:h.savedAt)||null),en=(0,s.useRef)(null),el=(0,s.useRef)(!!h),[ei,eo]=(0,s.useState)([]),[ed,ec]=(0,s.useState)(""),[eu,em]=(0,s.useState)(""),[ep,ex]=(0,s.useState)([]),[eh,eg]=(0,s.useState)(""),{rehearsals:eb,createRehearsal:ef,deleteRehearsal:ey,updateRehearsal:ev}=i(u),{parts:ej,createPart:eN,deletePart:ew,setParts:eS}=function(e){let[t,a]=(0,s.useState)([]),[r,n]=(0,s.useState)(!0),[l,i]=(0,s.useState)(null);(0,s.useEffect)(()=>{if(!e){a([]),n(!1);return}!async function(){try{let t=await fetch("/api/parts?performanceId=".concat(e));if(!t.ok)throw Error("Failed to fetch parts");let r=await t.json();a(r)}catch(e){i(e instanceof Error?e.message:"An error occurred")}finally{n(!1)}}()},[e]);let o=async(r,s,n,l)=>{if(!e)throw Error("Performance ID is required");try{let i=await fetch("/api/parts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:e,name:r,description:s,order:n,is_group:l})});if(!i.ok)throw Error("Failed to create part");let o=await i.json();return a([...t,o]),o}catch(e){throw i(e instanceof Error?e.message:"An error occurred"),e}},d=async e=>{try{if(!(await fetch("/api/parts/".concat(e),{method:"DELETE"})).ok)throw Error("Failed to delete part");a(t.filter(t=>t.id!==e))}catch(e){throw i(e instanceof Error?e.message:"An error occurred"),e}};return{parts:t,loading:r,error:l,createPart:o,deletePart:d,setParts:a}}(u),{performances:e_}=(0,o.f)(),ek=(e,t)=>(0,D.y7)(e,t||"America/New_York");(0,s.useEffect)(()=>{!async function(){try{let e=await fetch("/api/performances/".concat(u));if(!e.ok)throw Error("Failed to fetch performance");let t=await e.json();_(t);let a=t.timezone||"America/New_York",r=t.date?ek(t.date,a):"";if(el.current||(ee({title:t.title||"",call_time:t.call_time||(r?(0,D.Kb)(r):""),timezone:a,date:r,location:t.location||"",description:t.description||"",phone_numbers:t.phone_numbers||""}),ea(!!t.call_time)),t.music_file_path){let e="".concat("https://quqvudqzztlmgrwqudho.supabase.co","/storage/v1/object/public/performance-music/").concat(t.music_file_path);B(e)}let s=await fetch("/api/performance-contacts?performanceId=".concat(u));if(s.ok){let e=await s.json();eo(e||[])}let n=await fetch("/api/performance-contacts/all");if(n.ok){let e=await n.json();ex(e||[])}}catch(e){console.error("Error fetching performance:",e)}finally{C(!1)}}()},[u]),(0,s.useEffect)(()=>(en.current&&clearTimeout(en.current),en.current=setTimeout(()=>{let e=new Date().toISOString();(0,T.J1)(p,{infoForm:$,callTimeManual:et,savedAt:e}),es(e)},400),()=>{en.current&&clearTimeout(en.current)}),[$,et,p]),(0,s.useEffect)(()=>{"positioning"===P&&ej.length>0&&!R&&J(ej[0].id)},[P,ej,R]);let eC=(0,s.useMemo)(()=>(0,D.eL)($.date,$.timezone),[$.date,$.timezone]),eE=async()=>{try{H(!0);let e=await fetch("/api/rehearse-export?performanceId=".concat(u,"&embedAudio=").concat(K?"1":"0"));if(!e.ok){let t=await e.text();throw console.error("Export error:",e.status,t),Error("Failed to export rehearse HTML")}let t=await e.blob(),a=URL.createObjectURL(t),r=((null==y?void 0:y.title)||"rehearse-export").toString().replace(/[^a-z0-9]+/gi,"-").replace(/^-+|-+$/g,"").toLowerCase(),s=document.createElement("a");s.href=a,s.download="".concat(r||"rehearse-export",".html"),document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(a)}catch(e){console.error("Export failed:",e),alert("Failed to export rehearse HTML")}finally{H(!1)}};return k?(0,r.jsx)("div",{className:"min-h-screen bg-gray-100 p-6",children:(0,r.jsx)("p",{className:"text-gray-600",children:"Loading..."})}):y?(0,r.jsxs)("div",{className:"min-h-screen bg-gray-100",children:[(0,r.jsx)("nav",{className:"bg-blue-900 text-white p-4 shadow-lg",children:(0,r.jsxs)("div",{className:"max-w-7xl mx-auto flex justify-between items-center",children:[(0,r.jsx)(j.AppBrand,{href:"/"}),(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsx)(l(),{href:"/admin",className:"hover:bg-blue-800 px-3 py-2 rounded",children:"Admin Panel"}),(0,r.jsx)(w.$,{className:"px-3 py-2 bg-blue-700 rounded hover:bg-blue-600 text-sm"})]})]})}),(0,r.jsxs)("div",{className:"flex min-h-[calc(100vh-64px)]",children:[(0,r.jsx)("div",{className:"w-64 bg-white shadow-md p-6 overflow-y-auto border-r border-gray-200",children:(0,r.jsx)(x,{performanceId:u})}),(0,r.jsx)("div",{className:"flex-1 min-w-0 p-6",children:(0,r.jsxs)("div",{className:"".concat("positioning"===P||"marking"===P?"max-w-none mx-0":"max-w-5xl mx-auto"),children:[(0,r.jsxs)("div",{className:"mb-8",children:[(0,r.jsx)(l(),{href:"/admin",className:"text-blue-600 hover:underline mb-4 block",children:"← Back to Dashboard"}),(0,r.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:y.title}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-gray-600",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-semibold",children:"Date:"})," ",(null==y?void 0:y.date)?(0,D.P9)(y.date,$.timezone):"—"]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-semibold",children:"Location:"})," ",y.location]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-semibold",children:"Timezone:"})," ",$.timezone]})]}),y.description&&(0,r.jsxs)("div",{className:"mt-4 text-gray-600",children:[(0,r.jsx)("span",{className:"font-semibold",children:"Description:"})," ",y.description]})]}),(0,r.jsxs)("div",{className:"flex gap-4 mb-8 flex-wrap",children:[(0,r.jsx)("button",{onClick:()=>O("rehearsals"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("rehearsals"===P?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Rehearsals"}),(0,r.jsx)("button",{onClick:()=>O("parts"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("parts"===P?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Parts/Choreography"}),(0,r.jsx)("button",{onClick:()=>{O("positioning"),ej.length>0&&!R&&J(ej[0].id)},className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("positioning"===P?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Stage Positions"}),(0,r.jsx)("button",{onClick:()=>O("music"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("music"===P?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Music & Rehearse"}),(0,r.jsx)("button",{onClick:()=>O("marking"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("marking"===P?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Marking"}),(0,r.jsx)("button",{onClick:()=>O("info"),className:"px-6 py-3 rounded-lg font-semibold transition-colors ".concat("info"===P?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"),children:"Performance Info"})]}),"positioning"===P?(0,r.jsx)("div",{className:"flex flex-col gap-6",children:(0,r.jsx)("div",{className:"bg-white rounded-lg shadow-md p-8",children:0===ej.length?(0,r.jsxs)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:[(0,r.jsx)("p",{className:"text-gray-600 mb-4",children:"No parts created yet."}),(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"Create parts first before positioning students."})]}):R&&(0,r.jsx)(g,{performanceId:u,partId:R,partName:null==(t=ej.find(e=>e.id===R))?void 0:t.name,partDescription:null==(a=ej.find(e=>e.id===R))?void 0:a.description,isGroup:(null==(n=ej.find(e=>e.id===R))?void 0:n.is_group)!==!1,onSavePositions:async e=>{let t=e.map(e=>({part_id:R,student_id:e.student_id,x:e.x,y:e.y}));if(!(await fetch("/api/stage-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:R,positions:t})})).ok)throw Error("Failed to save positions")}})})}):(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-8",children:["rehearsals"===P&&(0,r.jsx)(F,{rehearsals:eb,showForm:M,onToggleForm:()=>A(!M),onCreateRehearsal:ef,onDeleteRehearsal:ey,onUpdateRehearsal:ev}),"parts"===P&&(0,r.jsx)(I,{performanceId:u,parts:ej,performances:e_,showForm:L,onToggleForm:()=>U(!L),onCreatePart:eN,onDeletePart:ew,onReorderParts:eS}),"music"===P&&(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)(b,{performanceId:u,performanceTitle:y.title,currentMusicFile:y.music_file_name,onUploadSuccess:(e,t)=>{B(t),_({...y,music_file_name:e.split("/").pop()})}}),z&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Preview Music"}),(0,r.jsx)(f,{musicUrl:z,performanceTitle:y.title})]}),(0,r.jsxs)("div",{className:"bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-lg border-2 border-purple-200",children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"\uD83C\uDFAD Rehearse/Emulate Mode"}),(0,r.jsx)("p",{className:"text-gray-700 mb-4",children:"Use rehearse mode to play back your choreography with automatic grid transitions based on music timepoints."}),(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-3",children:[(0,r.jsx)("button",{disabled:!z||0===ej.length,onClick:()=>q(!0),className:"px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-semibold",children:"Start Rehearse Mode →"}),(0,r.jsx)("button",{disabled:!z||0===ej.length||X,onClick:eE,className:"px-6 py-3 bg-white text-purple-700 border border-purple-300 rounded-lg hover:bg-purple-50 disabled:bg-gray-100 disabled:text-gray-400 disabled:border-gray-200 font-semibold",children:X?"Exporting...":"Export Rehearse HTML"}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-purple-900",children:[(0,r.jsx)("input",{type:"checkbox",checked:K,onChange:e=>Y(e.target.checked),className:"h-4 w-4"}),"Embed audio in export"]})]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mt-2",children:[!z&&"⚠️ Upload music first",z&&0===ej.length&&"⚠️ Create parts and set timepoints",z&&ej.length>0&&"✓ Ready to rehearse"]})]}),ej.length>0&&(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Part Timepoints"}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("p",{className:"text-gray-600 text-sm",children:'Click "Edit" on a part to set its music timepoint (when the part should appear during rehearsal).'}),(0,r.jsxs)("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[(0,r.jsx)("p",{className:"font-semibold text-blue-900 mb-2",children:"\uD83D\uDCCB Parts Timeline:"}),(0,r.jsx)("div",{className:"space-y-2",children:ej.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,r.jsx)("span",{className:"font-medium text-gray-900",children:e.name}),e.timepoint_seconds?(0,r.jsxs)("span",{className:"text-amber-700 bg-amber-100 px-2 py-1 rounded",children:["Start: ",e.timepoint_seconds,"s",e.timepoint_end_seconds?" - End: ".concat(e.timepoint_end_seconds,"s"):""]}):(0,r.jsx)("span",{className:"text-gray-400 italic",children:"No timepoint set"})]},e.id))})]})]})]})]}),"marking"===P&&(0,r.jsx)(E,{performanceId:u,parts:ej,musicUrl:z,performanceTitle:null==y?void 0:y.title,onPartsUpdated:e=>eS(e)}),"info"===P&&(0,r.jsx)("div",{className:"space-y-6",children:(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Performance Info"}),W&&(0,r.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:W}),er&&(0,r.jsxs)("div",{className:"text-xs text-gray-500 mb-3",children:["Draft saved ",new Date(er).toLocaleString(),"."]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Performance Name"}),(0,r.jsx)("input",{type:"text",value:$.title,onChange:e=>ee(t=>({...t,title:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Date & Time"}),(0,r.jsx)("input",{type:"datetime-local",value:$.date,onChange:e=>{let t=e.target.value;ee(e=>({...e,date:t,call_time:et?e.call_time:(0,D.Kb)(t)})),et||t||ee(e=>({...e,call_time:""}))},className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Call Time"}),(0,r.jsx)("input",{type:"time",value:$.call_time,onChange:e=>{ea(!0),ee(t=>({...t,call_time:e.target.value}))},disabled:eC,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),eC&&(0,r.jsx)("div",{className:"text-xs text-amber-700 mt-1",children:"Call time is locked within 1 hour of the performance."})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Timezone"}),(0,r.jsx)("input",{type:"text",value:$.timezone,onChange:e=>ee(t=>({...t,timezone:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:"Use IANA format (e.g., America/New_York)"})]}),(0,r.jsxs)("div",{className:"md:col-span-2",children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Location"}),(0,r.jsx)(S.e,{value:$.location,onChange:e=>ee(t=>({...t,location:e})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Description"}),(0,r.jsx)("textarea",{rows:3,value:$.description,onChange:e=>ee(t=>({...t,description:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Important Phone Numbers"}),(0,r.jsx)("textarea",{rows:4,placeholder:"One per line",value:$.phone_numbers,onChange:e=>ee(t=>({...t,phone_numbers:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,r.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2 items-center",children:[(0,r.jsxs)("select",{value:eh,onChange:e=>eg(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,r.jsx)("option",{value:"",children:"Add saved contact..."}),ep.map(e=>(0,r.jsxs)("option",{value:"".concat(e.name,"||").concat(e.phone),children:[e.name," • ",e.phone]},"".concat(e.name,"-").concat(e.phone)))]}),(0,r.jsx)("button",{onClick:()=>{if(!eh)return;let[e,t]=eh.split("||"),a="".concat(e,": ").concat(t);ee(e=>({...e,phone_numbers:e.phone_numbers?"".concat(e.phone_numbers,"\n").concat(a):a})),eg("")},className:"px-3 py-1 bg-gray-900 text-white rounded text-xs",children:"Add to phone list"})]})]}),(0,r.jsxs)("div",{className:"mt-6 border-t border-gray-200 pt-4",children:[(0,r.jsx)("h4",{className:"font-semibold text-gray-900 mb-2",children:"Contacts Directory"}),(0,r.jsx)("p",{className:"text-sm text-gray-600 mb-3",children:"Add contacts and select which ones appear in the export."}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2 items-center mb-3",children:[(0,r.jsxs)("select",{value:eh,onChange:e=>eg(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,r.jsx)("option",{value:"",children:"Add saved contact..."}),ep.map(e=>(0,r.jsxs)("option",{value:"".concat(e.name,"||").concat(e.phone),children:[e.name," • ",e.phone]},"".concat(e.name,"-").concat(e.phone)))]}),(0,r.jsx)("button",{onClick:async()=>{if(!eh)return;let[e,t]=eh.split("||"),a=await fetch("/api/performance-contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:u,name:e,phone:t,include_in_export:!0})});if(a.ok){let e=await a.json();eo(t=>[...t,e]),eg("")}},className:"px-3 py-1 bg-blue-600 text-white rounded text-xs",children:"Add to contacts"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[(0,r.jsx)("input",{type:"text",placeholder:"Name",value:ed,onChange:e=>ec(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg"}),(0,r.jsx)("input",{type:"text",placeholder:"Phone",value:eu,onChange:e=>em(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg"}),(0,r.jsx)("button",{onClick:async()=>{if(!ed.trim()||!eu.trim())return;let e=await fetch("/api/performance-contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:u,name:ed.trim(),phone:eu.trim(),include_in_export:!0})});if(e.ok){let t=await e.json();eo(e=>[...e,t]),ec(""),em("")}},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold",children:"Add Contact"})]}),(0,r.jsx)("div",{className:"space-y-2",children:ei.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("div",{className:"font-medium text-gray-900",children:e.name}),(0,r.jsx)("div",{className:"text-sm text-gray-600",children:e.phone})]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,r.jsx)("input",{type:"checkbox",checked:!!e.include_in_export,onChange:async t=>{(await fetch("/api/performance-contacts/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({include_in_export:t.target.checked})})).ok&&eo(a=>a.map(a=>a.id===e.id?{...a,include_in_export:t.target.checked}:a))}}),"Include in export"]}),(0,r.jsx)("button",{onClick:async()=>{(await fetch("/api/performance-contacts/".concat(e.id),{method:"DELETE"})).ok&&eo(t=>t.filter(t=>t.id!==e.id))},className:"text-xs text-red-600 hover:text-red-800",children:"Remove"})]},e.id))})]}),(0,r.jsx)("div",{className:"mt-6",children:(0,r.jsx)("button",{onClick:async()=>{try{Q(!0),V(null);let e=await fetch("/api/performances/".concat(u),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:$.title,date:$.date?(0,D.Xr)($.date,$.timezone):null,call_time:$.call_time,timezone:$.timezone,location:$.location,description:$.description,phone_numbers:$.phone_numbers})});if(!e.ok){let t=await e.json().catch(()=>null);throw Error((null==t?void 0:t.details)||(null==t?void 0:t.error)||"Failed to save info")}let t=await e.json();_(t),ee(e=>({...e,title:t.title||"",call_time:t.call_time||"",timezone:t.timezone||e.timezone,date:t.date?ek(t.date,t.timezone||e.timezone):e.date}));let a=await fetch("/api/performance-contacts?performanceId=".concat(u));if(a.ok){let e=await a.json();eo(e||[])}}catch(e){V(e instanceof Error?e.message:"Failed to save info")}finally{Q(!1)}},className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold disabled:bg-gray-400",disabled:Z,children:Z?"Saving...":"Save Info"})})]})})]})]})}),"positioning"===P&&ej.length>0&&(0,r.jsx)("div",{className:"w-80 bg-white shadow-md p-4 border-l border-gray-200",children:(0,r.jsxs)("div",{className:"sticky top-20 space-y-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-900 mb-2",children:"Parts & Choreography"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mb-3",children:"Drag to reorder. Click a card to show positions."}),(0,r.jsx)(m,{parts:ej,performanceId:u,onDelete:ew,onReorder:eS,onSelect:e=>J(e),selectedPartId:R,variant:"select",enableDrag:!0,showPositionedNames:!0})]}),(0,r.jsx)(N,{partId:R})]})})]}),G&&(0,r.jsx)(v,{performanceId:u,parts:ej,musicUrl:z,onClose:()=>q(!1),onUpdatePartTimepoints:e=>{eS(t=>t.map(t=>t.id===e.id?{...t,...e}:t))}})]}):(0,r.jsxs)("div",{className:"min-h-screen bg-gray-100 p-6",children:[(0,r.jsx)("p",{className:"text-red-600",children:"Performance not found"}),(0,r.jsx)(l(),{href:"/admin",className:"text-blue-600 hover:underline",children:"Back to Admin"})]})}function F(e){let{rehearsals:t,showForm:a,onToggleForm:s,onCreateRehearsal:n,onDeleteRehearsal:l,onUpdateRehearsal:i}=e;return(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold",children:"Schedule Rehearsals"}),(0,r.jsx)("button",{onClick:s,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold",children:a?"Cancel":"+ Schedule Rehearsal"})]}),a&&(0,r.jsx)("div",{className:"mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200",children:(0,r.jsx)(d,{onSubmit:async(e,t)=>{await n(e,t)}})}),0===t.length?(0,r.jsx)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:(0,r.jsx)("p",{className:"text-gray-600",children:"No rehearsals scheduled yet."})}):(0,r.jsx)(c,{rehearsals:t,onDelete:l,onUpdate:i})]})}function I(e){let{performanceId:t,parts:a,performances:n,showForm:l,onToggleForm:i,onCreatePart:o,onDeletePart:d,onReorderParts:c}=e,[p,x]=(0,s.useState)(""),[h,g]=(0,s.useState)(!0),[b,f]=(0,s.useState)(!1),[y,v]=(0,s.useState)(null),[j,N]=(0,s.useState)(null),[w,S]=(0,s.useState)(!0),_=(n||[]).filter(e=>e.id!==t);return(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[(0,r.jsx)("h3",{className:"text-lg font-bold text-blue-900 mb-2",children:"Copy Parts from Another Performance"}),(0,r.jsx)("p",{className:"text-sm text-blue-800 mb-3",children:"This copies part names/descriptions (and optionally music timepoints). It does not copy grid positions or subparts."}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-3 items-center",children:[(0,r.jsxs)("select",{value:p,onChange:e=>x(e.target.value),className:"px-3 py-2 border border-blue-300 rounded-lg text-sm min-w-[220px]",children:[(0,r.jsx)("option",{value:"",children:"Select performance to copy from..."}),_.map(e=>(0,r.jsx)("option",{value:e.id,children:e.title},e.id))]}),(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm text-blue-900",children:[(0,r.jsx)("input",{type:"checkbox",checked:h,onChange:e=>g(e.target.checked),className:"h-4 w-4"}),"Copy music timepoints"]}),(0,r.jsx)("button",{onClick:async()=>{if(p){f(!0),v(null),N(null);try{let e=await fetch("/api/parts/copy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_performance_id:p,target_performance_id:t,copy_timepoints:h})});if(!e.ok){let t=await e.json();throw Error(t.error||"Failed to copy parts")}let r=await e.json();Array.isArray(r)&&r.length>0?(null==c||c([...a,...r]),N("Copied ".concat(r.length," part(s)."))):N("No parts found to copy.")}catch(e){v(e instanceof Error?e.message:"Failed to copy parts")}finally{f(!1)}}},disabled:!p||b,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 font-semibold text-sm",children:b?"Copying...":"Copy Parts"})]}),y&&(0,r.jsx)("div",{className:"mt-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded px-3 py-2",children:y}),j&&(0,r.jsx)("div",{className:"mt-3 text-sm text-green-700 bg-green-50 border border-green-200 rounded px-3 py-2",children:j})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold",children:"Parts & Choreography"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>S(e=>!e),className:"px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold text-sm",children:w?"Expand Details":"Compact View"}),(0,r.jsx)("button",{onClick:i,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold",children:l?"Cancel":"+ Add Part"})]})]}),l&&(0,r.jsx)("div",{className:"mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200",children:(0,r.jsx)(u,{onSubmit:o})}),0===a.length?(0,r.jsx)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:(0,r.jsx)("p",{className:"text-gray-600",children:"No parts created yet."})}):(0,r.jsx)(m,{parts:a,performanceId:t,onDelete:d,onReorder:c,compact:w})]})}},2890:(e,t,a)=>{"use strict";a.d(t,{N:()=>r});let r=(0,a(2373).UU)("https://quqvudqzztlmgrwqudho.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1cXZ1ZHF6enRsbWdyd3F1ZGhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MzQ1NjQsImV4cCI6MjA4NDAxMDU2NH0.NwxDWyz7vQiM1r3SqMn62iLjBJQGEO1-K6qgsP74hYg")},2992:(e,t,a)=>{"use strict";function r(e){try{let t=window.localStorage.getItem(e);if(!t)return null;return JSON.parse(t)}catch(e){return null}}function s(e,t){try{window.localStorage.setItem(e,JSON.stringify(t))}catch(e){}}function n(e){try{window.localStorage.removeItem(e)}catch(e){}}a.d(t,{C_:()=>r,J1:()=>s,nr:()=>n})},5959:(e,t,a)=>{"use strict";a.d(t,{$:()=>l});var r=a(5155),s=a(2115),n=a(2890);function l(e){let{className:t}=e,[a,l]=(0,s.useState)(!1);return(0,r.jsx)("button",{onClick:async()=>{l(!0),await n.N.auth.signOut(),l(!1)},disabled:a,className:t,children:a?"Signing out...":"Sign Out"})}},6979:(e,t,a)=>{"use strict";a.d(t,{v:()=>l});var r=a(5155),s=a(5239),n=a(2115);function l(e){let{size:t=36,className:a="",imgClassName:l=""}=e,[i,o]=(0,n.useState)(null);return(0,n.useEffect)(()=>{let e=!0;return(async()=>{try{let t=await fetch("/api/app-logo");if(!t.ok)return;let a=await t.json();e&&o(a.logoUrl||null)}catch(e){}})(),()=>{e=!1}},[]),(0,r.jsx)("div",{className:"flex items-center justify-center overflow-hidden ".concat(a),style:{width:t,height:t,borderRadius:8},children:i?(0,r.jsx)(s.default,{src:i,alt:"App logo",width:t,height:t,unoptimized:!0,className:"max-w-full max-h-full object-contain ".concat(l)}):(0,r.jsx)("span",{className:"text-[10px] font-semibold uppercase tracking-wide",children:"Logo"})})}},9157:(e,t,a)=>{"use strict";function r(e){if(!e)return null;let[t,a]=e.split("T");if(!t||!a)return null;let[r,s,n]=t.split("-"),[l,i]=a.split(":"),o=Number(r),d=Number(s),c=Number(n),u=Number(l),m=Number(i);return Number.isFinite(o)&&Number.isFinite(d)&&Number.isFinite(c)&&Number.isFinite(u)&&Number.isFinite(m)?{year:o,month:d,day:c,hour:u,minute:m}:null}function s(e,t){let a=r(e);if(!a)return"";let s=new Date(Date.UTC(a.year,a.month-1,a.day,a.hour,a.minute,0)),n=function(e,t){let a=new Intl.DateTimeFormat("en-US",{timeZone:e,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(t),r={};for(let e of a)"literal"!==e.type&&(r[e.type]=e.value);return Date.UTC(Number(r.year),Number(r.month)-1,Number(r.day),Number(r.hour),Number(r.minute),Number(r.second))-t.getTime()}(t,s);return new Date(s.getTime()-n).toISOString()}function n(e,t){if(!e)return"";let a=new Date(e);if(Number.isNaN(a.getTime()))return"";let r=new Intl.DateTimeFormat("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(a),s={};for(let e of r)"literal"!==e.type&&(s[e.type]=e.value);return"".concat(s.year,"-").concat(s.month,"-").concat(s.day,"T").concat(s.hour,":").concat(s.minute)}function l(e,t){if(!e)return"—";let a=new Date(e);return Number.isNaN(a.getTime())?"—":a.toLocaleString(void 0,{timeZone:t,timeZoneName:"short"})}function i(e,t){if(!e)return"—";let a=new Date(e);return Number.isNaN(a.getTime())?"—":a.toLocaleTimeString(void 0,{timeZone:t,hour:"numeric",minute:"2-digit"})}function o(e,t){if(!e)return"";let a=new Date(e);if(Number.isNaN(a.getTime()))return"";let r=new Intl.DateTimeFormat("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(a),s={};for(let e of r)"literal"!==e.type&&(s[e.type]=e.value);return"".concat(s.year,"-").concat(s.month,"-").concat(s.day)}function d(e){if(!e)return"—";let[t,a]=e.split(":"),r=Number(t),s=Number(a);return Number.isFinite(r)&&Number.isFinite(s)?new Date(Date.UTC(2e3,0,1,r,s,0)).toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit"}):e}function c(e){let t=r(e);if(!t)return"";let a=new Date(Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,0));a.setUTCHours(a.getUTCHours()-1);let s=String(a.getUTCHours()).padStart(2,"0"),n=String(a.getUTCMinutes()).padStart(2,"0");return"".concat(s,":").concat(n)}function u(e,t){if(!e)return!1;let a=new Date(s(e,t));if(Number.isNaN(a.getTime()))return!1;let r=a.getTime()-36e5;return Date.now()>=r}a.d(t,{Kb:()=>c,P9:()=>l,Xr:()=>s,Z5:()=>i,a7:()=>d,eL:()=>u,so:()=>o,y7:()=>n})},9815:(e,t,a)=>{"use strict";a.d(t,{f:()=>s});var r=a(2115);function s(){let[e,t]=(0,r.useState)([]),[a,s]=(0,r.useState)(!0),[n,l]=(0,r.useState)(null);(0,r.useEffect)(()=>{!async function(){try{let e=await fetch("/api/performances");if(!e.ok)throw Error("Failed to fetch performances");let a=await e.json();t(a)}catch(e){l(e instanceof Error?e.message:"An error occurred")}finally{s(!1)}}()},[]);let i=async(a,r,s,n,i,o)=>{try{let l=await fetch("/api/performances",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:a,description:r,date:s,location:n,call_time:i,timezone:o})});if(!l.ok)throw Error("Failed to create performance");let d=await l.json();return t([...e,d]),d}catch(e){throw l(e instanceof Error?e.message:"An error occurred"),e}},o=async a=>{try{if(!(await fetch("/api/performances/".concat(a),{method:"DELETE"})).ok)throw Error("Failed to delete performance");t(e.filter(e=>e.id!==a))}catch(e){throw l(e instanceof Error?e.message:"An error occurred"),e}};return{performances:e,loading:a,error:n,createPerformance:i,deletePerformance:o}}}},e=>{e.O(0,[5481,2373,8441,1255,7358],()=>e(e.s=1712)),_N_E=e.O()}]);