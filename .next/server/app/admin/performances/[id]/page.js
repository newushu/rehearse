(()=>{var a={};a.id=670,a.ids=[670],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},20309:(a,b,c)=>{"use strict";c.d(b,{$H:()=>k,GI:()=>d,Kb:()=>o,P9:()=>j,Xr:()=>h,Z5:()=>l,a7:()=>n,eL:()=>p,so:()=>m,y7:()=>i});let d="America/New_York",e=a=>/[zZ]|[+-]\d{2}:\d{2}$/.test(a),f=a=>{if(!a)return null;let[b,c]=a.split(/[T ]/);if(!b||!c)return null;let d=c.slice(0,5),[e,f,g]=b.split("-"),[h,i]=d.split(":"),j=Number(e),k=Number(f),l=Number(g),m=Number(h),n=Number(i);return Number.isFinite(j)&&Number.isFinite(k)&&Number.isFinite(l)&&Number.isFinite(m)&&Number.isFinite(n)?{datePart:b,timePart:d,year:j,month:k,day:l,hour:m,minute:n}:null};function g(a){if(!a)return null;let[b,c]=a.split("T");if(!b||!c)return null;let[d,e,f]=b.split("-"),[g,h]=c.split(":"),i=Number(d),j=Number(e),k=Number(f),l=Number(g),m=Number(h);return Number.isFinite(i)&&Number.isFinite(j)&&Number.isFinite(k)&&Number.isFinite(l)&&Number.isFinite(m)?{year:i,month:j,day:k,hour:l,minute:m}:null}function h(a,b){let c=g(a);if(!c)return"";let d=new Date(Date.UTC(c.year,c.month-1,c.day,c.hour,c.minute,0)),e=function(a,b){let c=new Intl.DateTimeFormat("en-US",{timeZone:a,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(b),d={};for(let a of c)"literal"!==a.type&&(d[a.type]=a.value);return Date.UTC(Number(d.year),Number(d.month)-1,Number(d.day),Number(d.hour),Number(d.minute),Number(d.second))-b.getTime()}(b,d);return new Date(d.getTime()-e).toISOString()}function i(a,b){if(!a)return"";if(!e(a)){let b=f(a);return b?`${b.datePart}T${b.timePart}`:a}let c=new Date(a);if(Number.isNaN(c.getTime()))return"";let d=new Intl.DateTimeFormat("en-US",{timeZone:b,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(c),g={};for(let a of d)"literal"!==a.type&&(g[a.type]=a.value);return`${g.year}-${g.month}-${g.day}T${g.hour}:${g.minute}`}function j(a,b){if(!a)return"—";if(!e(a)){let b=f(a);if(!b)return a;let c=new Date(Date.UTC(b.year,b.month-1,b.day,b.hour,b.minute,0)),d=c.toLocaleDateString(void 0,{timeZone:"UTC"}),e=c.toLocaleTimeString(void 0,{timeZone:"UTC",hour:"numeric",minute:"2-digit"});return`${d}, ${e} ET`}let c=new Date(a);return Number.isNaN(c.getTime())?"—":c.toLocaleString(void 0,{timeZone:b||d,timeZoneName:"short"})}function k(a,b){if(!a)return"\xe2€”";if(!e(a)){let b=f(a);if(!b)return a;let c=new Date(Date.UTC(b.year,b.month-1,b.day,b.hour,b.minute,0)).toLocaleString(void 0,{timeZone:"UTC",weekday:"long",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"});return`${c} ET`}let c=new Date(a);return Number.isNaN(c.getTime())?"\xe2€”":c.toLocaleString(void 0,{timeZone:b||d,weekday:"long",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",timeZoneName:"short"})}function l(a,b){if(!a)return"—";if(!e(a)){let b=f(a);return b?n(b.timePart):a}let c=new Date(a);return Number.isNaN(c.getTime())?"—":c.toLocaleTimeString(void 0,{timeZone:b||d,hour:"numeric",minute:"2-digit"})}function m(a,b){if(!a)return"";if(!e(a)){let b=f(a);return b?b.datePart:""}let c=new Date(a);if(Number.isNaN(c.getTime()))return"";let g=new Intl.DateTimeFormat("en-US",{timeZone:b||d,year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(c),h={};for(let a of g)"literal"!==a.type&&(h[a.type]=a.value);return`${h.year}-${h.month}-${h.day}`}function n(a){if(!a)return"—";let[b,c]=a.split(":"),d=Number(b),e=Number(c);return Number.isFinite(d)&&Number.isFinite(e)?new Date(Date.UTC(2e3,0,1,d,e,0)).toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit",timeZone:"UTC"}):a}function o(a){let b=g(a);if(!b)return"";let c=new Date(Date.UTC(b.year,b.month-1,b.day,b.hour,b.minute,0));c.setUTCHours(c.getUTCHours()-1);let d=String(c.getUTCHours()).padStart(2,"0"),e=String(c.getUTCMinutes()).padStart(2,"0");return`${d}:${e}`}function p(a,b){if(!a)return!1;let c=new Date(h(a,b));if(Number.isNaN(c.getTime()))return!1;let d=c.getTime()-36e5;return Date.now()>=d}},21649:(a,b,c)=>{"use strict";c.d(b,{f:()=>e});var d=c(38301);function e(){let[a,b]=(0,d.useState)([]),[c,e]=(0,d.useState)(!0),[f,g]=(0,d.useState)(null),h=async(c,d,e,f,h,i)=>{try{let g=await fetch("/api/performances",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:c,description:d,date:e,location:f,call_time:h,timezone:i})});if(!g.ok)throw Error("Failed to create performance");let j=await g.json();return b([...a,j]),j}catch(a){throw g(a instanceof Error?a.message:"An error occurred"),a}},i=async c=>{try{if(!(await fetch(`/api/performances/${c}`,{method:"DELETE"})).ok)throw Error("Failed to delete performance");b(a.filter(a=>a.id!==c))}catch(a){throw g(a instanceof Error?a.message:"An error occurred"),a}};return{performances:a,loading:c,error:f,createPerformance:h,deletePerformance:i}}},26713:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/is-bot")},27721:(a,b,c)=>{Promise.resolve().then(c.bind(c,93972))},28354:a=>{"use strict";a.exports=require("util")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:a=>{"use strict";a.exports=require("path")},35269:(a,b,c)=>{"use strict";c.d(b,{v:()=>g});var d=c(21124),e=c(24515),f=c(38301);function g({size:a=36,className:b="",imgClassName:c=""}){let[g,h]=(0,f.useState)(null);return(0,d.jsx)("div",{className:`flex items-center justify-center overflow-hidden ${b}`,style:{width:a,height:a,borderRadius:8},children:g?(0,d.jsx)(e.default,{src:g,alt:"App logo",width:a,height:a,unoptimized:!0,className:`max-w-full max-h-full object-contain ${c}`}):(0,d.jsx)("span",{className:"text-[10px] font-semibold uppercase tracking-wide",children:"Logo"})})}},39796:()=>{},40924:(a,b,c)=>{"use strict";c.r(b),c.d(b,{default:()=>H});var d=c(21124),e=c(38301),f=c.n(e),g=c(3991),h=c.n(g);function i(a){let[b,c]=(0,e.useState)([]),[d,f]=(0,e.useState)(!0),[g,h]=(0,e.useState)(null),i=async(d,e)=>{if(!a)throw Error("Performance ID is required");try{let f=await Promise.all(e.map(b=>fetch("/api/rehearsals",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:a,title:d,date:b.date,time:b.time,location:b.location})})));for(let a of f)if(!a.ok)throw Error("Failed to create rehearsal");let g=await Promise.all(f.map(a=>a.json()));return c([...b,...g]),g}catch(a){throw h(a instanceof Error?a.message:"An error occurred"),a}},j=async a=>{try{if(!(await fetch(`/api/rehearsals/${a}`,{method:"DELETE"})).ok)throw Error("Failed to delete rehearsal");c(b.filter(b=>b.id!==a))}catch(a){throw h(a instanceof Error?a.message:"An error occurred"),a}};return{rehearsals:b,loading:d,error:g,createRehearsal:i,deleteRehearsal:j,updateRehearsal:async(a,b)=>{try{let d=await fetch(`/api/rehearsals/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(!d.ok)throw Error("Failed to update rehearsal");let e=await d.json();return c(b=>b.map(b=>b.id===a?e:b)),e}catch(a){throw h(a instanceof Error?a.message:"An error occurred"),a}}}}var j=c(21649);function k({onSubmit:a,isLoading:b=!1}){let[c,f]=(0,e.useState)({title:"",dateEntries:[{date:"",time:"",location:""}]}),[g,h]=(0,e.useState)(null),i=(a,b,d)=>{let e=[...c.dateEntries];e[a]={...e[a],[b]:d},f({...c,dateEntries:e})},j=async b=>{b.preventDefault(),h(null);let d=c.dateEntries.filter(a=>a.date&&a.time&&a.location);if(!c.title||0===d.length)return void h("Please fill in title and at least one complete date/time/location entry");try{await a(c.title,d),f({title:"",dateEntries:[{date:"",time:"",location:""}]})}catch(a){h(a instanceof Error?a.message:"An error occurred")}};return(0,d.jsxs)("form",{onSubmit:j,className:"space-y-4",children:[g&&(0,d.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:g}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Title *"}),(0,d.jsx)("input",{type:"text",value:c.title,onChange:a=>{f({...c,title:a.target.value})},placeholder:"e.g., Full Cast Rehearsal",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-4",children:"Schedule Dates & Times * (Each date can have different time/location)"}),(0,d.jsx)("div",{className:"space-y-4",children:c.dateEntries.map((a,b)=>(0,d.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,d.jsxs)("div",{className:"grid grid-cols-3 gap-3",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Date *"}),(0,d.jsx)("input",{type:"date",value:a.date,onChange:a=>i(b,"date",a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Time *"}),(0,d.jsx)("input",{type:"time",value:a.time,onChange:a=>i(b,"time",a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Location *"}),(0,d.jsx)("input",{type:"text",value:a.location,onChange:a=>i(b,"location",a.target.value),placeholder:"e.g., Studio A",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]})]}),c.dateEntries.length>1&&(0,d.jsx)("button",{type:"button",onClick:()=>{f({...c,dateEntries:c.dateEntries.filter((a,c)=>c!==b)})},className:"mt-2 px-3 py-1 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600",children:"Remove"})]},b))}),(0,d.jsx)("button",{type:"button",onClick:()=>{f({...c,dateEntries:[...c.dateEntries,{date:"",time:"",location:""}]})},className:"mt-3 px-4 py-2 bg-gray-300 text-gray-900 rounded-lg hover:bg-gray-400 font-medium",children:"+ Add Another Date"})]}),(0,d.jsx)("button",{type:"submit",disabled:b,className:"w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors",children:b?"Scheduling...":"Schedule Rehearsal"})]})}var l=c(20309);function m({rehearsals:a,onDelete:b,onUpdate:c}){let[f,g]=(0,e.useState)(null),[h,i]=(0,e.useState)({title:"",date:"",time:"",location:""}),j=a=>a?a.split("T")[0]:"",k=()=>{g(null)},m=async a=>{await c(a,h),g(null)};return(0,d.jsx)("div",{className:"space-y-3",children:a.map(a=>(0,d.jsxs)("div",{className:"flex justify-between items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50",children:[(0,d.jsx)("div",{className:"flex-1",children:f===a.id?(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("input",{type:"text",value:h.title,onChange:a=>i(b=>({...b,title:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,d.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,d.jsx)("input",{type:"date",value:h.date,onChange:a=>i(b=>({...b,date:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,d.jsx)("input",{type:"time",value:h.time,onChange:a=>i(b=>({...b,time:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,d.jsx)("input",{type:"text",value:h.location,onChange:a=>i(b=>({...b,location:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",placeholder:"Location"})]})]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("h3",{className:"font-semibold text-gray-900",children:a.title}),(0,d.jsxs)("div",{className:"grid grid-cols-2 text-sm text-gray-600 mt-1",children:[(0,d.jsxs)("span",{children:["\uD83D\uDCC5 ",(a=>{if(!a)return"";let b=j(a);if(b){let[a,c,d]=b.split("-").map(Number);if(a&&c&&d)return new Date(Date.UTC(a,c-1,d,12,0,0)).toLocaleDateString(void 0,{timeZone:l.GI})}return new Date(a).toLocaleDateString(void 0,{timeZone:l.GI})})(a.date)]}),(0,d.jsxs)("span",{children:["\uD83D\uDD50 ",(0,l.a7)(a.time)," ET"]})]}),(0,d.jsxs)("div",{className:"text-sm text-gray-600 mt-1",children:["\uD83D\uDCCD ",a.location]})]})}),(0,d.jsx)("div",{className:"flex items-center gap-2 ml-4",children:f===a.id?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("button",{onClick:()=>m(a.id),className:"px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm",children:"Save"}),(0,d.jsx)("button",{onClick:k,className:"px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm",children:"Cancel"})]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("button",{onClick:()=>(a=>{let b=j(a.date);g(a.id),i({title:a.title||"",date:b,time:a.time||"",location:a.location||""})})(a),className:"px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm",children:"Edit"}),(0,d.jsx)("button",{onClick:()=>{window.confirm("Delete this rehearsal?")&&b(a.id)},className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm",children:"Delete"})]})})]},a.id))})}function n({onSubmit:a,isLoading:b=!1}){let[c,f]=(0,e.useState)({name:"",description:"",order:0,is_group:!0}),[g,h]=(0,e.useState)("group"),[i,j]=(0,e.useState)([]),[k,l]=(0,e.useState)(null),m=a=>{f({...c,[a.target.name]:"number"===a.target.type?Number(a.target.value):a.target.value})},n=async b=>{if(b.preventDefault(),l(null),!c.name)return void l("Part name is required");try{let b="group"===g,d=i.map(a=>({title:a.title.trim(),notes:a.notes.trim()})).filter(a=>a.title.length>0);if(!b&&0===d.length)return void l("Add at least one subpart for this part.");let e=await a(c.name,c.description,c.order,b);b||await Promise.all(d.map(a=>fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:e.id,title:a.title,description:a.notes||null,mode:"position"})}))),f({name:"",description:"",order:0,is_group:!0}),h("group"),j([])}catch(a){l(a instanceof Error?a.message:"An error occurred")}};return(0,d.jsxs)("form",{onSubmit:n,className:"space-y-4",children:[k&&(0,d.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:k}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Part Name *"}),(0,d.jsx)("input",{type:"text",name:"name",value:c.name,onChange:m,placeholder:"e.g., Lead Dancers, Background Chorus",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Description"}),(0,d.jsx)("textarea",{name:"description",value:c.description,onChange:m,placeholder:"Details about this part/choreography...",rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,d.jsx)("input",{type:"radio",checked:"group"===g,onChange:()=>h("group"),className:"h-4 w-4"}),"Group part"]}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,d.jsx)("input",{type:"radio",checked:"subparts"===g,onChange:()=>h("subparts"),className:"h-4 w-4"}),"Part with subparts / solos"]}),"subparts"===g&&(0,d.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2",children:[(0,d.jsx)("div",{className:"text-sm font-semibold text-gray-700",children:"Subparts"}),0===i.length&&(0,d.jsx)("div",{className:"text-xs text-gray-500",children:"Add at least one subpart."}),(0,d.jsx)("div",{className:"space-y-2",children:i.map((a,b)=>(0,d.jsxs)("div",{className:"border border-gray-200 rounded p-2",children:[(0,d.jsx)("input",{type:"text",value:a.title,onChange:a=>{let c=[...i];c[b]={...c[b],title:a.target.value},j(c)},placeholder:`Subpart ${b+1} title`,className:"w-full px-2 py-1 border border-gray-300 rounded text-sm mb-2"}),(0,d.jsx)("textarea",{value:a.notes,onChange:a=>{let c=[...i];c[b]={...c[b],notes:a.target.value},j(c)},placeholder:"Notes",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(0,d.jsx)("button",{type:"button",onClick:()=>j(i.filter((a,c)=>c!==b)),className:"mt-2 text-xs text-red-600 hover:text-red-800",children:"Remove"})]},`subpart-${b}`))}),(0,d.jsx)("button",{type:"button",onClick:()=>j([...i,{title:"",notes:""}]),className:"px-2 py-1 bg-blue-600 text-white rounded text-xs",children:"Add Subpart"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Order"}),(0,d.jsx)("input",{type:"number",name:"order",value:c.order,onChange:m,min:"0",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsx)("button",{type:"submit",disabled:b,className:"w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors",children:b?"Adding...":"Add Part"})]})}function o({parts:a,performanceId:b,onDelete:c,onReorder:f,onSelect:g,selectedPartId:h,variant:i="manage",enableDrag:j=!0,showPositionedNames:k=!0,compact:l=!1,showDelete:m=!1,musicUrl:n=null}){let[o,p]=(0,e.useState)(null),[q,r]=(0,e.useState)(""),[s,t]=(0,e.useState)(""),[u,v]=(0,e.useState)(""),[w,x]=(0,e.useState)(""),[y,z]=(0,e.useState)(""),[A,B]=(0,e.useState)(""),[C,D]=(0,e.useState)(!0),[E,F]=(0,e.useState)({}),[G,H]=(0,e.useState)({}),[I,J]=(0,e.useState)(null),[K,L]=(0,e.useState)({}),[M,N]=(0,e.useState)({}),[O,P]=(0,e.useState)({}),[Q,R]=(0,e.useState)({}),[S,T]=(0,e.useState)({}),[U,V]=(0,e.useState)({}),[W,X]=(0,e.useState)({}),[Y,Z]=(0,e.useState)(null),[$,_]=(0,e.useState)(""),[aa,ab]=(0,e.useState)(""),[ac,ad]=(0,e.useState)(""),[ae,af]=(0,e.useState)(""),[ag,ah]=(0,e.useState)(""),[ai,aj]=(0,e.useState)(""),[ak,al]=(0,e.useState)(null),[am,an]=(0,e.useState)(null),ao=(0,e.useMemo)(()=>[...a].sort((a,b)=>{let c="number"==typeof a.timepoint_seconds,d="number"==typeof b.timepoint_seconds;if(c&&d){let c=a.timepoint_seconds,d=b.timepoint_seconds;return c!==d?c-d:(a.order||0)-(b.order||0)}return c!==d?c?-1:1:(a.order||0)-(b.order||0)}),[a]),ap=a=>{if(null==a||""===a)return{min:"",sec:""};let b=Number(a);if(!Number.isFinite(b))return{min:"",sec:""};let c=Math.floor(b/60),d=Math.floor(b%60);return{min:String(c),sec:String(d)}},aq=(a,b)=>{if(!a&&!b)return null;let c=a?parseInt(a,10):0,d=b?parseFloat(b):0;return Number.isNaN(c)||Number.isNaN(d)?null:60*c+d},ar=a=>{if(null==a||""===a)return"--:--";let b=Number(a);if(!Number.isFinite(b))return"--:--";let c=Math.floor(b/60),d=Math.floor(b%60);return`${c}:${d.toString().padStart(2,"0")}`},as=(a,b)=>{if(null==a||null==b)return"";let c=Number(a),d=Number(b);if(!Number.isFinite(c)||!Number.isFinite(d))return"";let e=Math.max(0,Math.floor(d-c)),f=Math.floor(e/60);return`${f}:${(e%60).toString().padStart(2,"0")}`},at=async a=>{try{let b=await fetch(`/api/stage-positions?partId=${a}`),c=await b.json();F(b=>({...b,[a]:c.length})),H(b=>({...b,[a]:c.map(a=>a.student_name||"Unknown")}))}catch(a){console.error("Error fetching positions:",a)}},au=async a=>{try{let b=await fetch(`/api/subparts?partId=${a}`);if(!b.ok)throw Error("Failed to fetch subparts");let c=await b.json();L(b=>({...b,[a]:c||[]}))}catch(a){console.error("Error fetching subparts:",a)}},av=async a=>{let b=(M[a]||"").trim(),c=(O[a]||"").trim(),d=aq(Q[a]||"",S[a]||""),e=aq(U[a]||"",W[a]||"");if(b)try{let f=await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:a,title:b,description:c||null,mode:"position",timepoint_seconds:d,timepoint_end_seconds:e})});if(!f.ok){let a=await f.json().catch(()=>null);throw Error(a?.details||a?.error||"Failed to create subpart")}await au(a),N(b=>({...b,[a]:""})),P(b=>({...b,[a]:""})),R(b=>({...b,[a]:""})),T(b=>({...b,[a]:""})),V(b=>({...b,[a]:""})),X(b=>({...b,[a]:""}))}catch(a){console.error("Error creating subpart:",a)}},aw=async(a,b)=>{try{if(!(await fetch(`/api/subparts/${a}`,{method:"DELETE"})).ok)throw Error("Failed to delete subpart");await au(b)}catch(a){console.error("Error deleting subpart:",a)}},ax=()=>{Z(null),_(""),ab(""),ad(""),af(""),ah(""),aj("")},ay=async(a,b)=>{try{let c=await fetch(`/api/subparts/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:$,description:aa,timepoint_seconds:aq(ac,ae),timepoint_end_seconds:aq(ag,ai)})});if(!c.ok){let a=await c.json().catch(()=>null);throw Error(a?.details||a?.error||"Failed to update subpart")}await au(b),ax()}catch(a){console.error("Error updating subpart:",a)}},az=async(a,b,c)=>{if(c<0||c>=(K[a]?.length||0))return;let d=[...K[a]||[]],[e]=d.splice(b,1);d.splice(c,0,e),L(b=>({...b,[a]:d}));try{await Promise.all(d.map((a,b)=>fetch(`/api/subparts/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:b+1})})))}catch(b){console.error("Error reordering subparts:",b),await au(a)}},aA=a=>{p(a.id),r(a.name),t(a.description||"");let b=ap(a.timepoint_seconds),c=ap(a.timepoint_end_seconds);v(b.min),x(b.sec),z(c.min),B(c.sec),D(!1!==a.is_group)},aB=async b=>{try{let c=await fetch(`/api/parts/${b}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:q,description:s,timepoint_seconds:aq(u,w),timepoint_end_seconds:aq(y,A),is_group:C})});if(!c.ok){let a=await c.json();throw console.error("API Error:",a),Error(a.details||"Failed to update part")}let d=await c.json();d&&f&&f(a.map(a=>a.id===b?{...a,...d}:a)),p(null)}catch(a){console.error("Error updating part:",a),alert(`Error updating part: ${a instanceof Error?a.message:String(a)}`)}},aC=async(a,b)=>{if(b<0||b>=ao.length)return;let c=[...ao],[d]=c.splice(a,1);c.splice(b,0,d);try{let a=c.map((a,b)=>fetch(`/api/parts/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:b+1})}));if(!(await Promise.all(a)).every(a=>a.ok))throw Error("Some updates failed");let b=c.map((a,b)=>({...a,order:b+1}));f&&f(b)}catch(a){console.error("Error reordering parts:",a)}};return(0,d.jsx)("div",{className:"space-y-3",children:ao.map((a,b)=>{let e=l&&o!==a.id,f=!1===a.is_group?"Subparts/Solos":"Group";return(0,d.jsx)("div",{draggable:j,onDragStart:()=>J(a.id),onDragOver:a=>{j&&a.preventDefault()},onDrop:()=>{if(j&&I&&I!==a.id)aC(ao.findIndex(a=>a.id===I),ao.findIndex(b=>b.id===a.id)),J(null)},onClick:()=>g?.(a.id),className:`p-4 border rounded-lg hover:bg-gray-50 ${j?"cursor-move":""} ${h===a.id?"border-blue-500 bg-blue-50":"border-gray-200"}`,children:o===a.id?(0,d.jsxs)("div",{className:"space-y-3",children:[(0,d.jsx)("input",{type:"text",value:q,onChange:a=>r(a.target.value),placeholder:"Part name",className:"w-full px-3 py-2 border border-gray-300 rounded-lg"}),(0,d.jsx)("textarea",{value:s,onChange:a=>t(a.target.value),placeholder:"Part description (optional)",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",rows:2}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,d.jsx)("input",{type:"checkbox",checked:C,onChange:a=>D(a.target.checked),className:"h-4 w-4"}),"Group part (unchecked = has subparts/solos)"]}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-xs font-semibold text-gray-700 mb-1",children:"Start Time (m / s)"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:u,onChange:a=>v(a.target.value),placeholder:"min",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:w,onChange:a=>x(a.target.value),placeholder:"sec",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-xs font-semibold text-gray-700 mb-1",children:"End Time (m / s)"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:y,onChange:a=>z(a.target.value),placeholder:"min",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:A,onChange:a=>B(a.target.value),placeholder:"sec",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]})]})]}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{onClick:()=>aB(a.id),className:"px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm",children:"Save"}),(0,d.jsx)("button",{onClick:()=>p(null),className:"px-3 py-1 bg-gray-400 text-white rounded hover:bg-gray-500 text-sm",children:"Cancel"})]})]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{className:`flex justify-between items-start ${e?"":"mb-3"}`,children:[(0,d.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,d.jsx)("h3",{className:"font-bold text-gray-900 truncate",children:a.name}),!e&&a.description&&(0,d.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:a.description}),(0,d.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:f})]}),("manage"===i&&!e||m)&&(0,d.jsxs)("div",{className:"flex gap-2 ml-4",children:["manage"===i&&!e&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("button",{onClick:()=>aC(b,b-1),disabled:0===b,className:"px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 text-sm",title:"Move up",children:"↑"}),(0,d.jsx)("button",{onClick:()=>aC(b,b+1),disabled:b===ao.length-1,className:"px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 text-sm",title:"Move down",children:"↓"})]}),m&&(0,d.jsx)("button",{onClick:b=>{b.stopPropagation(),window.confirm("Delete this part?")&&c(a.id)},className:"px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm",title:"Delete",children:"Delete"})]})]}),e&&(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[(0,d.jsx)("span",{className:"text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded",children:f}),(0,d.jsxs)("span",{className:"text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded",children:["Positioned: ",E[a.id]??"-"]}),(0,d.jsxs)("span",{className:"text-xs bg-purple-50 text-purple-700 px-2 py-1 rounded",children:["Order: ",a.order]}),(void 0!==a.timepoint_seconds||void 0!==a.timepoint_end_seconds)&&(0,d.jsxs)("span",{className:"text-xs bg-amber-50 text-amber-700 px-2 py-1 rounded",children:[ar(a.timepoint_seconds)," - ",ar(a.timepoint_end_seconds)]}),(void 0!==a.timepoint_seconds||void 0!==a.timepoint_end_seconds)&&(0,d.jsxs)("span",{className:"text-xs bg-emerald-50 text-emerald-700 px-2 py-1 rounded",children:["Duration: ",as(a.timepoint_seconds,a.timepoint_end_seconds)]}),n&&(void 0!==a.timepoint_seconds||void 0!==a.timepoint_end_seconds)&&(0,d.jsx)("audio",{controls:!0,preload:"metadata",className:"h-8",onPlay:b=>{let c=Number(a.timepoint_seconds||0);Number.isFinite(c)&&(b.currentTarget.currentTime=c)},children:(0,d.jsx)("source",{src:n})}),"manage"===i&&(0,d.jsxs)("div",{className:"flex gap-2 ml-auto",children:[(0,d.jsx)("button",{onClick:b=>{b.stopPropagation(),aA(a)},className:"px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-xs",children:"Edit"}),(0,d.jsx)("button",{onClick:b=>{b.stopPropagation(),window.confirm("Delete this part?")&&c(a.id)},className:"px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs",children:"Delete"})]})]}),e&&K[a.id]?.length>0&&(0,d.jsxs)("div",{className:"mt-2 text-xs text-gray-600",children:["Subparts: ",[...K[a.id]].sort((a,b)=>{let c="number"==typeof a.timepoint_seconds?a.timepoint_seconds:1/0,d="number"==typeof b.timepoint_seconds?b.timepoint_seconds:1/0;return c!==d?c-d:(a.title||"").localeCompare(b.title||"")}).map(a=>a.title).join(", ")]}),!e&&"manage"===i&&(void 0!==a.timepoint_seconds||void 0!==a.timepoint_end_seconds)&&(0,d.jsxs)("div",{className:"bg-amber-50 p-2 rounded mb-3 text-sm",children:[(0,d.jsx)("span",{className:"text-gray-600",children:"Music Timepoint:"}),(0,d.jsxs)("span",{className:"font-bold text-amber-700 ml-2",children:[ar(a.timepoint_seconds)," - ",ar(a.timepoint_end_seconds)]}),(0,d.jsxs)("span",{className:"ml-2 text-emerald-700",children:["(Duration ",as(a.timepoint_seconds,a.timepoint_end_seconds),")"]})]}),!e&&k&&G[a.id]?.length>0&&(0,d.jsx)("div",{className:"bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:G[a.id].join(", ")}),!e&&K[a.id]?.length>0&&(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:[(0,d.jsx)("div",{className:"font-semibold text-gray-600 mb-1",children:"Subparts / Solos"}),(0,d.jsx)("div",{className:"space-y-1",children:K[a.id].map(b=>(0,d.jsx)("div",{className:`flex items-start justify-between gap-2 ${"manage"===i?"cursor-move":""}`,draggable:"manage"===i,onDragStart:()=>{al(b.id),an(a.id)},onDragOver:a=>{"manage"===i&&a.preventDefault()},onDrop:()=>{if("manage"!==i||!ak||am!==a.id)return;let c=K[a.id].findIndex(a=>a.id===ak),d=K[a.id].findIndex(a=>a.id===b.id);az(a.id,c,d),al(null),an(null)},children:Y===b.id?(0,d.jsxs)("div",{className:"w-full space-y-2",children:[(0,d.jsx)("input",{type:"text",value:$,onChange:a=>_(a.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsx)("textarea",{value:aa,onChange:a=>ab(a.target.value),rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:ac,onChange:a=>ad(a.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:ae,onChange:a=>af(a.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()})]}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:ag,onChange:a=>ah(a.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:ai,onChange:a=>aj(a.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()})]}),(0,d.jsxs)("select",{value:b.mode||"position",onChange:c=>fetch(`/api/subparts/${b.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:c.target.value})}).then(()=>au(a.id)),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation(),children:[(0,d.jsx)("option",{value:"position",children:"Position"}),(0,d.jsx)("option",{value:"order",children:"Order"}),(0,d.jsx)("option",{value:"both",children:"Both"})]}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{onClick:c=>{c.stopPropagation(),ay(b.id,a.id)},className:"px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700",children:"Save"}),(0,d.jsx)("button",{onClick:a=>{a.stopPropagation(),ax()},className:"px-2 py-1 bg-gray-400 text-white rounded text-xs hover:bg-gray-500",children:"Cancel"})]})]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"font-medium text-gray-800",children:b.title}),b.description&&(0,d.jsx)("div",{className:"text-gray-500",children:b.description}),b.mode&&(0,d.jsxs)("div",{className:"text-gray-400 text-[10px] mt-1",children:["Mode: ",b.mode]}),(0,d.jsxs)("div",{className:"text-gray-400 text-[10px] mt-1",children:["Time: ",ar(b.timepoint_seconds)," - ",ar(b.timepoint_end_seconds)]})]}),(0,d.jsx)("div",{className:"flex items-center gap-2",children:(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("button",{onClick:a=>{a.stopPropagation();Z(b.id),_(b.title),ab(b.description||"");let c=ap(b.timepoint_seconds),d=ap(b.timepoint_end_seconds);ad(c.min),af(c.sec),ah(d.min),aj(d.sec)},className:"text-[10px] text-blue-600 hover:text-blue-800",children:"Edit"}),(0,d.jsx)("button",{onClick:c=>{c.stopPropagation(),aw(b.id,a.id)},className:"text-[10px] text-red-600 hover:text-red-800",children:"Remove"})]})})]})},b.id))})]}),!e&&(0,d.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:[(0,d.jsx)("div",{className:"font-semibold text-gray-600 mb-1",children:"Add Subpart"}),(0,d.jsx)("input",{type:"text",value:M[a.id]||"",onChange:b=>N(c=>({...c,[a.id]:b.target.value})),placeholder:"Subpart title",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2",onClick:a=>a.stopPropagation()}),(0,d.jsx)("textarea",{value:O[a.id]||"",onChange:b=>P(c=>({...c,[a.id]:b.target.value})),placeholder:"Description",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2",onClick:a=>a.stopPropagation()}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:Q[a.id]||"",onChange:b=>R(c=>({...c,[a.id]:b.target.value})),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:S[a.id]||"",onChange:b=>T(c=>({...c,[a.id]:b.target.value})),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()})]}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:U[a.id]||"",onChange:b=>V(c=>({...c,[a.id]:b.target.value})),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:W[a.id]||"",onChange:b=>X(c=>({...c,[a.id]:b.target.value})),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()})]}),(0,d.jsx)("button",{onClick:b=>{b.stopPropagation(),av(a.id)},className:"px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700",children:"Add"})]}),!e&&"manage"===i&&(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{onClick:()=>aA(a),className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm",children:"Edit"}),(0,d.jsx)("button",{onClick:()=>at(a.id),className:"px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm",children:"Refresh Count"}),(0,d.jsx)("button",{onClick:()=>{window.confirm("Delete this part?")&&c(a.id)},className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm",children:"Delete"})]})]})},a.id)})})}var p=c(35269);function q({performanceId:a}){let[b,c]=(0,e.useState)([]),[f,g]=(0,e.useState)(!0),[h,j]=(0,e.useState)(null),[k,m]=(0,e.useState)(!1),[n,o]=(0,e.useState)(""),[q,r]=(0,e.useState)(""),[s,t]=(0,e.useState)(!1),[u,v]=(0,e.useState)([]),[w,x]=(0,e.useState)([]),[y,z]=(0,e.useState)([]),[A,B]=(0,e.useState)([]),[C,D]=(0,e.useState)(!1),[E,F]=(0,e.useState)(""),{rehearsals:G}=i(a),H=(0,e.useCallback)(async()=>{try{g(!0);let b=await fetch(`/api/performances/${a}/roster`);if(!b.ok)throw Error("Failed to fetch roster");let d=await b.json();c(d)}catch(a){console.error("Error fetching roster:",a),j(a instanceof Error?a.message:"Failed to load roster")}finally{g(!1)}},[a]);(0,e.useCallback)(async()=>{if(a)try{D(!0);let b=await fetch(`/api/rehearsal-attendance?performanceId=${a}`);if(!b.ok){let a=await b.text();throw console.error("Attendance fetch failed:",b.status,a),Error("Failed to fetch attendance")}let c=await b.json();B(c)}catch(a){console.error("Error fetching attendance:",a)}finally{D(!1)}},[a]),(0,e.useCallback)(async()=>{try{let a=await fetch("/api/students");if(!a.ok)throw Error("Failed to fetch students");let b=await a.json();z(b)}catch(a){console.error("Error fetching students:",a)}},[]);let I=async a=>{try{if(!(await fetch(`/api/signups/${a}`,{method:"DELETE"})).ok)throw Error("Failed to remove student");c(b.filter(b=>b.signup_id!==a))}catch(a){console.error("Error removing student:",a),j(a instanceof Error?a.message:"Failed to remove student")}},J=a=>{x(b=>[...b,a]),o(""),r("")},K=async b=>{b.preventDefault();let c=n.trim().length>0?[...u,n.trim()]:[...u];if(0===c.length&&0===w.length)return void j("Please enter at least one name");t(!0);try{for(let b of w)if(!(await fetch("/api/signups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:a,student_id:b.id,status:"registered"})})).ok)throw Error("Failed to add to roster");for(let b of c){let c=await fetch("/api/students",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:b,email:q.trim()?q.trim():null})});if(!c.ok)throw Error("Failed to create student");let d=await c.json();if(!(await fetch("/api/signups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:a,student_id:d.id,status:"registered"})})).ok)throw Error("Failed to add to roster")}o(""),r(""),v([]),x([]),m(!1),await H()}catch(a){j(a instanceof Error?a.message:"Failed to add student")}finally{t(!1)}},L=(0,e.useMemo)(()=>{let a=new Map;for(let b of A)a.set(`${b.rehearsal_id}:${b.student_id}`,b);return a},[A]),M=(0,e.useCallback)(a=>a?a.split("T")[0]:"",[]),N=(0,e.useCallback)(a=>{let b=M(a);if(!b)return new Date(a);let[c,d,e]=b.split("-").map(Number);return new Date(Date.UTC(c,(d||1)-1,e||1,12,0,0))},[M]),O=(0,e.useMemo)(()=>[...G].sort((a,b)=>N(a.date).getTime()-N(b.date).getTime()),[G,N]),P=a=>N(a).toLocaleDateString(void 0,{month:"numeric",day:"numeric",timeZone:l.GI}),Q=(0,e.useMemo)(()=>new Set(b.map(a=>a.student_id)),[b]),R=(0,e.useMemo)(()=>new Set(w.map(a=>a.id)),[w]),S=(0,e.useMemo)(()=>{let a=n.trim().toLowerCase();return a?y.filter(b=>!(Q.has(b.id)||R.has(b.id))&&b.name.toLowerCase().includes(a)).slice(0,8):[]},[y,n,Q,R]),T=async(a,b,c)=>{if(c)return;let d=`${a}:${b}`,e=L.get(d);try{if(!e){let c=await fetch("/api/rehearsal-attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rehearsal_id:a,student_id:b,status:"present"})});if(!c.ok)throw Error("Failed to save attendance");let d=await c.json();B(a=>[...a,d]);return}if("present"===e.status){let c=await fetch("/api/rehearsal-attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rehearsal_id:a,student_id:b,status:"absent"})});if(!c.ok)throw Error("Failed to save attendance");let d=await c.json();B(a=>a.map(a=>a.id===d.id?d:a));return}if(!(await fetch(`/api/rehearsal-attendance?rehearsalId=${a}&studentId=${b}`,{method:"DELETE"})).ok)throw Error("Failed to clear attendance");B(c=>c.filter(c=>c.rehearsal_id!==a||c.student_id!==b))}catch(a){console.error("Error updating attendance:",a),j(a instanceof Error?a.message:"Failed to update attendance")}};return f?(0,d.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,d.jsx)("p",{className:"text-gray-500",children:"Loading roster..."})}):(0,d.jsx)("div",{className:"h-full flex flex-col",children:(0,d.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[(0,d.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)(p.v,{size:22,className:"border border-gray-200 bg-white text-gray-400"}),(0,d.jsxs)("h3",{className:"font-semibold text-gray-900",children:["Roster (",b.length,")"]})]}),(0,d.jsx)("button",{onClick:()=>m(!k),className:"px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700",children:k?"Cancel":"+ Add"})]}),O.length>0&&(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mb-3 text-xs text-gray-600",children:[(0,d.jsx)("span",{children:"Attendance:"}),(0,d.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,d.jsx)("span",{className:"h-3 w-3 rounded bg-green-500 inline-block"}),"Present"]}),(0,d.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,d.jsx)("span",{className:"h-3 w-3 rounded bg-red-500 inline-block"}),"Missed"]}),(0,d.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,d.jsx)("span",{className:"h-3 w-3 rounded bg-gray-300 inline-block"}),"Pending"]}),(0,d.jsx)("span",{className:"text-gray-500",children:"Click boxes to toggle."})]}),h&&(0,d.jsx)("div",{className:"bg-yellow-100 border border-yellow-400 text-yellow-700 px-3 py-2 rounded mb-4 text-sm",children:h}),k&&(0,d.jsxs)("form",{onSubmit:K,className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg space-y-2",children:[(0,d.jsxs)("div",{className:"relative",children:[(0,d.jsx)("input",{type:"text",value:n,onChange:a=>o(a.target.value),onKeyDown:a=>{if("Enter"===a.key){a.preventDefault();let b=S.find(a=>a.name.toLowerCase()===n.trim().toLowerCase());if(b)return void J(b);let c=n.trim();c&&(v(a=>[...a,c]),o(""),r(""))}},placeholder:"Name (press Enter to add)",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),S.length>0&&(0,d.jsx)("div",{className:"absolute z-10 mt-1 w-full rounded border border-gray-200 bg-white shadow-sm text-sm",children:S.map(a=>(0,d.jsxs)("button",{type:"button",onClick:()=>J(a),className:"w-full text-left px-2 py-1 hover:bg-blue-50",children:[(0,d.jsx)("span",{className:"font-medium text-gray-900",children:a.name}),a.email&&(0,d.jsxs)("span",{className:"text-gray-500",children:[" • ",a.email]})]},a.id))})]}),(0,d.jsx)("input",{type:"email",value:q,onChange:a=>r(a.target.value),placeholder:"Email (optional)",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(u.length>0||w.length>0)&&(0,d.jsxs)("div",{className:"flex flex-wrap gap-2",children:[w.map(a=>(0,d.jsxs)("span",{className:"inline-flex items-center gap-1 bg-green-50 border border-green-200 text-green-800 px-2 py-1 rounded text-xs",children:[a.name,(0,d.jsx)("button",{type:"button",onClick:()=>{var b;return b=a.id,void x(a=>a.filter(a=>a.id!==b))},className:"text-green-800 hover:text-green-900","aria-label":`Remove ${a.name}`,children:"\xd7"})]},a.id)),u.map((a,b)=>(0,d.jsxs)("span",{className:"inline-flex items-center gap-1 bg-white border border-blue-200 text-blue-700 px-2 py-1 rounded text-xs",children:[a,(0,d.jsx)("button",{type:"button",onClick:()=>{v(a=>a.filter((a,c)=>c!==b))},className:"text-blue-700 hover:text-blue-900","aria-label":`Remove ${a}`,children:"\xd7"})]},`${a}-${b}`))]}),(0,d.jsx)("button",{type:"submit",disabled:s,className:"w-full px-2 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400",children:s?"Adding...":"Add to Roster"})]}),0===b.length?(0,d.jsx)("p",{className:"text-gray-500 text-sm",children:"No students registered yet"}):(0,d.jsx)("div",{className:"space-y-2",children:b.map(a=>(0,d.jsxs)("div",{className:"bg-gray-50 p-2 rounded-md border border-gray-200 flex justify-between items-start group",children:[(0,d.jsxs)("div",{className:"flex-1",children:[(0,d.jsx)("p",{className:"font-medium text-gray-900 text-xs",children:a.name}),a.email&&(0,d.jsx)("p",{className:"text-gray-600 text-[10px]",children:a.email}),a.part_name&&(0,d.jsx)("div",{className:"mt-1",children:(0,d.jsx)("span",{className:"inline-block bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-medium",children:a.part_name})}),O.length>0&&(0,d.jsxs)("div",{className:"mt-1 flex flex-wrap gap-1",children:[E&&(0,d.jsxs)("div",{title:`Performance \xe2€\xa2 ${P(E)} ET`,className:"h-7 w-9 border bg-gray-200 text-gray-700 border-gray-300 text-[9px] leading-tight rounded flex flex-col items-center justify-center font-semibold opacity-90",children:[(0,d.jsx)("span",{children:P(E)}),(0,d.jsx)("span",{children:"P"})]}),O.map(b=>{let c=L.get(`${b.id}:${a.student_id}`),e=(a=>{let b=(0,l.so)(new Date().toISOString(),l.GI);return M(a.date)>b})(b),f=c?.status??"pending";return(0,d.jsxs)("button",{type:"button",onClick:()=>T(b.id,a.student_id,e),disabled:C,title:`${b.title} • ${P(b.date)} ${(0,l.a7)(b.time)} ET`,className:`h-7 w-9 border text-[9px] leading-tight rounded flex flex-col items-center justify-center font-semibold ${"present"===f?"bg-green-500 text-white border-green-600":"absent"===f?"bg-red-500 text-white border-red-600":"bg-gray-300 text-gray-700 border-gray-400"} ${e?"opacity-70 cursor-not-allowed":"hover:opacity-90"}`,children:[(0,d.jsx)("span",{children:P(b.date)}),(0,d.jsx)("span",{children:"R"})]},b.id)})]})]}),(0,d.jsx)("button",{onClick:()=>I(a.signup_id),className:"ml-2 px-2 py-0.5 bg-red-500 text-white rounded text-[10px] opacity-0 group-hover:opacity-100 hover:bg-red-600 transition-opacity",title:"Remove from roster",children:"Remove"})]},a.signup_id))})]})})}function r(a,b){if(!a||0===a.length)return"?";let c=a.charAt(0).toUpperCase();return b.filter(b=>b!==a&&b.charAt(0).toUpperCase()===c).length>0?a.slice(0,2).toUpperCase():c}function s({performanceId:a,partId:b,partName:c=null,partDescription:g=null,partTimepointSeconds:h=null,partTimepointEndSeconds:i=null,isGroup:j=!0,onSavePositions:k}){let[l,m]=(0,e.useState)([]),[n,o]=(0,e.useState)([]),[q,s]=(0,e.useState)(null),[t,u]=(0,e.useState)(!1),[v,w]=(0,e.useState)(!0),[x,y]=(0,e.useState)(!1),[z,A]=(0,e.useState)(null),[B,C]=(0,e.useState)("bottom"),[D,E]=(0,e.useState)(Date.now()),F=(0,e.useRef)(null),[G,H]=(0,e.useState)(1);f().useRef(null);let I=f().useRef(!1),[J,K]=(0,e.useState)([]),[L,M]=(0,e.useState)(null),[N,O]=(0,e.useState)({}),[P,Q]=(0,e.useState)({}),[R,S]=(0,e.useState)({}),[T,U]=(0,e.useState)(null),[V,W]=(0,e.useState)(null),[X,Y]=(0,e.useState)(null),[Z,$]=(0,e.useState)(null),[_,aa]=(0,e.useState)(!1),[ab,ac]=(0,e.useState)(c||""),[ad,ae]=(0,e.useState)(!1),[af,ag]=(0,e.useState)(!1),[ah,ai]=(0,e.useState)(g||""),[aj,ak]=(0,e.useState)(!1),[al,am]=(0,e.useState)(!1),[an,ao]=(0,e.useState)(""),[ap,aq]=(0,e.useState)(""),[ar,as]=(0,e.useState)(""),[at,au]=(0,e.useState)(""),[av,aw]=(0,e.useState)(!1),[ax,ay]=(0,e.useState)(null),[az,aA]=(0,e.useState)([]),[aB,aC]=(0,e.useState)(""),[aD,aE]=(0,e.useState)(!1),[aF,aG]=(0,e.useState)(!1),[aH,aI]=(0,e.useState)([]),[aJ,aK]=(0,e.useState)([]),[aL,aM]=(0,e.useState)(""),[aN,aO]=(0,e.useState)(!1),[aP,aQ]=(0,e.useState)({}),[aR,aS]=(0,e.useState)([]),[aT,aU]=(0,e.useState)({}),[aV,aW]=(0,e.useState)({}),[aX,aY]=(0,e.useState)({}),aZ=(0,e.useMemo)(()=>[...J].sort((a,b)=>{let c="number"==typeof a.timepoint_seconds?a.timepoint_seconds:1/0,d="number"==typeof b.timepoint_seconds?b.timepoint_seconds:1/0;return c!==d?c-d:(a.title||"").localeCompare(b.title||"")}),[J]),a$=(0,e.useCallback)(async()=>{try{let a=await fetch(`/api/subparts?partId=${b}`);if(a.ok){let b=await a.json();K(b||[]);let c=new Set((b||[]).map(a=>a.id));(0===(b||[]).length||L&&!c.has(L))&&M(null)}}catch(a){console.error("Error fetching subparts:",a)}},[b,L]);(0,e.useCallback)(async()=>{try{let c=await fetch(`/api/performances/${a}/roster`);if(!c.ok)throw Error("Failed to fetch roster");let d=(await c.json()).filter(a=>a.part_id===b||!a.part_id);m(d)}catch(a){console.error("Error fetching roster:",a)}},[a,b]),(0,e.useCallback)(async()=>{if(a){aO(!0);try{let[b,c]=await Promise.all([fetch(`/api/equipment?performanceId=${a}`),fetch(`/api/equipment-usage?performanceId=${a}`)]);if(b.ok){let a=await b.json();aI(a||[])}if(c.ok){let a=await c.json();aK(a||[])}}catch(a){console.error("Error fetching equipment:",a)}finally{aO(!1)}}},[a]),(0,e.useCallback)(async()=>{if(a)try{let b=await fetch(`/api/parts?performanceId=${a}`);if(!b.ok)return;let c=await b.json();aS(c||[]);let d=await Promise.all((c||[]).map(async a=>{let b=await fetch(`/api/subparts?partId=${a.id}`);if(!b.ok)return[a.id,[]];let c=await b.json();return[a.id,c||[]]})),e={};d.forEach(([a,b])=>{e[a]=b}),aU(e);let f=await Promise.all((c||[]).map(async a=>{let b=await fetch(`/api/part-sides?partId=${a.id}`);if(!b.ok)return[a.id,[]];let c=await b.json();return[a.id,c||[]]})),g={};f.forEach(([a,b])=>{g[a]=b}),aW(g);let h=Object.values(e).flat().map(a=>a.id),i=await Promise.all(h.map(async a=>{let b=await fetch(`/api/subpart-order?subpartId=${a}`);if(!b.ok)return[a,[]];let c=await b.json();return[a,c||[]]})),j={};i.forEach(([a,b])=>{j[a]=b}),aY(j)}catch(a){console.error("Error fetching equipment parts:",a)}},[a]);let a_=(0,e.useCallback)(async()=>{try{let b=await fetch(`/api/parts?performanceId=${a}`);if(!b.ok)return;let c=await b.json(),d=(c||[]).map(a=>({key:`part:${a.id}`,label:`Part: ${a.name}`})),e=(await Promise.all((c||[]).map(async a=>{let b=await fetch(`/api/subparts?partId=${a.id}`);return b.ok?(await b.json()||[]).map(b=>({key:`subpart:${b.id}`,label:`Subpart: ${a.name} - ${b.title}`})):[]}))).flat();aA([...d,...e])}catch(a){console.error("Error loading position sources:",a)}},[a]);(0,e.useCallback)(async()=>{await a$(),await a_()},[a$,a_]);let a0=(a,b=!1)=>{s(a),u(b),Y(null)},a1=a=>{a.preventDefault(),a.dataTransfer.dropEffect="move"},a2=(a,b)=>Number.isNaN(a)||a<0?0:a>b?b:a,a3=(a,b)=>{if("number"!=typeof a||"number"!=typeof b||!Number.isFinite(a)||!Number.isFinite(b))return"";let c=Math.max(0,b-a),d=Math.floor(c/60),e=Math.round(c%60);return`${d}m ${e}s`},a4=a=>{if(null==a||Number.isNaN(a))return"--:--";let b=Math.max(0,Math.floor(a)),c=Math.floor(b/60);return`${c}:${(b%60).toString().padStart(2,"0")}`},a5=a=>{if(null==a||Number.isNaN(a))return{min:"",sec:""};let b=Math.max(0,Math.floor(a));return{min:String(Math.floor(b/60)),sec:String(b%60)}},a6=(a,b)=>{if(!a&&!b)return null;let c=a?parseInt(a,10):0,d=b?parseFloat(b):0;return Number.isNaN(c)||Number.isNaN(d)?null:60*c+d},a7=async(a,b,c)=>{if(a.preventDefault(),!q||J.length>0&&!bn)return;let d=l.find(a=>a.student_id===q);if(t&&!d){let a=n.find(a=>a.student_id===q);a&&(d={student_id:q,name:a.name,part_name:null})}if(!d)return;let e=[...(L&&J.length>0?N[L]||[]:n).filter(a=>a.student_id!==q),{student_id:q,name:d.name,x:"top"===B?11-b:b,y:"top"===B?8-c:c}];L&&J.length>0?(O(a=>({...a,[L]:e})),await ba(e,P[L]||[])):o(e),I.current=!0,s(null),u(!1)},a8=async()=>{try{if(y(!0),L&&J.length>0){let a=(N[L]||[]).map(a=>({subpart_id:L,student_id:a.student_id,x:a.x,y:a.y}));await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:L,positions:a})})}else await k(n);await fetch(`/api/performances/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({stage_orientation:B})}),A(null)}catch(a){A(a instanceof Error?a.message:"Failed to save positions")}finally{y(!1)}},a9=(0,e.useCallback)(async a=>{L&&(Q(b=>({...b,[L]:a})),aY(b=>({...b,[L]:a})),await fetch("/api/subpart-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a.map((a,b)=>({subpart_id:L,student_id:a.student_id,order:b+1,start_side:a.start_side??"OS",end_side:a.end_side??"OS"})))}))},[L]),ba=(0,e.useCallback)(async(a,b)=>{if(!L)return;let c=new Set(b.map(a=>a.student_id)),d=a.filter(a=>a.student_id&&!c.has(a.student_id)).map(a=>({id:`temp-${Date.now()}-${a.student_id}`,student_id:a.student_id,student_name:a.name,start_side:"OS",end_side:"OS"}));if(0===d.length)return;let e=[...b,...d];await a9(e)},[a9,L]),bb=(0,e.useMemo)(()=>L&&P[L]||[],[L,P]),bc=(0,e.useMemo)(()=>0===J.length&&R[b]||[],[R,b,J.length]),bd=(0,e.useCallback)(async a=>{S(c=>({...c,[b]:a})),aW(c=>({...c,[b]:a})),await fetch("/api/part-sides",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a.map(a=>({part_id:b,student_id:a.student_id,start_side:a.start_side??"OS",end_side:a.end_side??"OS"})))})},[b]);(0,e.useCallback)(async()=>{let a=J.length>0?bb:bc;if(0===l.length)return;let b=new Map(a.map(a=>[a.student_id,a])),c=[...a],d=new Map;if(J.length>0&&L){let a=aZ.findIndex(a=>a.id===L);if(a>0){let b=aZ[a-1]?.id;d=new Map((b&&P[b]||[]).map(a=>[a.student_id,a.end_side||"OS"]))}}l.forEach(a=>{if(b.has(a.student_id))return;let e=d.get(a.student_id)||"OS";c.push({id:`temp-${Date.now()}-${a.student_id}`,student_id:a.student_id,student_name:a.name,start_side:e,end_side:e})}),c.length!==a.length&&(J.length>0?await a9(c):await bd(c))},[bb,bc,l,J.length,L,aZ,P,a9,bd]);let be=(0,e.useCallback)(async(a,b)=>{if(b<0||b>=J.length)return;let c=[...J],[d]=c.splice(a,1);c.splice(b,0,d),K(c);try{await Promise.all(c.map((a,b)=>fetch(`/api/subparts/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:b+1})})))}catch(a){console.error("Error reordering subparts:",a),await a$()}},[J,a$]),bf=async()=>{if(!aB)return[];let[a,b]=aB.split(":");if(!b)return[];let c="subpart"===a?`/api/subpart-positions?subpartId=${b}`:`/api/stage-positions?partId=${b}`,d=await fetch(c);if(!d.ok)throw Error(await d.text()||"Failed to fetch source positions");return(await d.json()||[]).map(a=>({student_id:a.student_id||"",name:a.student_name||"Unknown",x:a.x,y:a.y}))},bg=async()=>{if(aB){aG(!0);try{let a=(await bf()).map(a=>{let b=aD?11-a.x:a.x;return{...a,x:a2(b,11),y:a2(a.y,8)}});L&&J.length>0?(O(b=>({...b,[L]:a})),await ba(a,P[L]||[]),await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:L,positions:a.map(a=>({subpart_id:L,student_id:a.student_id,x:a.x,y:a.y}))})})):(o(a),await k(a)),I.current=!1,E(Date.now()),A(null)}catch(a){A(a instanceof Error?a.message:"Failed to apply positions")}finally{aG(!1)}}},bh=J.find(a=>a.id===L),bi=bh?a3(bh.timepoint_seconds,bh.timepoint_end_seconds):"",bj=ax?.start??h??null,bk=ax?.end??i??null,bl=a3(bj,bk),bm=bh?.mode||"position",bn=0===J.length||"order"!==bm,bo=J.length>0,bp=(0,e.useMemo)(()=>{let a={};return bb.forEach((b,c)=>{b.student_id&&(a[b.student_id]=c+1)}),a},[bb]),bq=L&&J.length>0?N[L]||[]:n,br=J.length>0?bb:bc,bs=br.filter(a=>!a.start_side).length,bt=br.filter(a=>!a.end_side).length,bu=new Set(bq.map(a=>a.student_id)),bv=new Map;bq.forEach(a=>{bv.has(a.student_id)||bv.set(a.student_id,a)});let bw=Array.from(bv.values()).map(a=>({student_id:a.student_id,name:a.name,initials:r(a.name,Array.from(bv.values()).map(a=>a.name))})),bx=(0,e.useMemo)(()=>{let a=new Map;return l.forEach(b=>a.set(b.student_id,b.name)),a},[l]),by=L&&J.length>0?`subpart:${L}`:`part:${b}`,bz=(0,e.useMemo)(()=>{let a=[];return aR.forEach((b,c)=>{let d=aT[b.id]||[];d.length>0?d.forEach((d,e)=>{a.push({key:`subpart:${d.id}`,part_id:b.id,subpart_id:d.id,label:d.title||b.name,timepoint:d.timepoint_seconds??null,orderFallback:100*c+e})}):a.push({key:`part:${b.id}`,part_id:b.id,subpart_id:null,label:b.name,timepoint:b.timepoint_seconds??null,orderFallback:100*c})}),a.sort((a,b)=>{let c="number"==typeof a.timepoint?a.timepoint:1/0,d="number"==typeof b.timepoint?b.timepoint:1/0;return c!==d?c-d:a.orderFallback-b.orderFallback})},[aR,aT]),bA=(0,e.useMemo)(()=>{let a=new Map;return bz.forEach((b,c)=>a.set(b.key,c)),a},[bz]),bB=(0,e.useMemo)(()=>{let a=new Map;return bz.forEach(b=>{let c=b.subpart_id&&aX[b.subpart_id]?aX[b.subpart_id]:aV[b.part_id]||[],d=new Map;c.forEach(a=>{d.set(a.student_id,{start_side:a.start_side??null,end_side:a.end_side??null})}),a.set(b.key,d)}),a},[bz,aV,aX]),bC=(0,e.useMemo)(()=>{let a=new Map;return aJ.forEach(b=>{let c=b.subpart_id?`subpart:${b.subpart_id}`:`part:${b.part_id}`,d=a.get(c)||[];d.push(b),a.set(c,d)}),a},[aJ]),bD=(0,e.useMemo)(()=>{let a=new Map;return aJ.forEach(b=>{let c=a.get(b.equipment_id)||[];c.push(b),a.set(b.equipment_id,c)}),a},[aJ]),bE=(0,e.useMemo)(()=>{let a=bA.get(by)??-1;return aH.map(b=>{let c=(bD.get(b.id)||[]).find(a=>(a.subpart_id?`subpart:${a.subpart_id}`:`part:${a.part_id}`)===by),d=null,e=null,f=c?.student_name||c&&bx.get(c.student_id)||"";if(c){let a=bB.get(by),b=a?.get(c.student_id);d=b?.start_side||null,e=b?.end_side||null}else if(a>=0){let c=b.initial_side??null;for(let d=a-1;d>=0;d-=1){let a=bz[d],e=(bC.get(a.key)||[]).find(a=>a.equipment_id===b.id);if(!e)continue;let f=bB.get(a.key),g=f?.get(e.student_id);c=g?.end_side||c;break}d=c,e=null}return{equipment:b,activeUsage:c,activeStudentName:f,startSide:d,endSide:e,isActive:!!c}}).sort((a,b)=>Number(b.isActive)-Number(a.isActive))},[aH,bz,bD,bC,bB,bA,by,bx]),bF=(0,e.useCallback)(a=>{let b=new Set;return a.filter(a=>!b.has(a.student_id)&&(b.add(a.student_id),!0))},[]),bG=(0,e.useCallback)(async()=>{let b=aL.trim();if(!b)return;let c=await fetch("/api/equipment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:a,name:b,initial_side:null})});if(!c.ok)return;let d=await c.json();aI(a=>[...a,d]),aM("")},[aL,a]),bH=(0,e.useCallback)(async(a,b)=>{let c=await fetch(`/api/equipment/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(!c.ok)return;let d=await c.json();aI(b=>b.map(b=>b.id===a?{...b,...d}:b))},[]),bI=(0,e.useCallback)(async(a,c)=>{let d=by.startsWith("subpart:")?by.replace("subpart:",""):null,e=aP[a];if(c){if(!e)return;let c=await fetch("/api/equipment-usage",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({equipment_id:a,part_id:b,subpart_id:d,student_id:e})});if(!c.ok)return;let f=await c.json();aK(c=>[...c.filter(c=>c.equipment_id!==a||c.part_id!==b||(c.subpart_id||null)!==(d||null)),{...f,student_name:bx.get(e)||f.student_name}])}else{let c=new URLSearchParams({equipment_id:a,part_id:b});if(d&&c.set("subpart_id",d),!(await fetch(`/api/equipment-usage?${c.toString()}`,{method:"DELETE"})).ok)return;aK(c=>c.filter(c=>c.equipment_id!==a||c.part_id!==b||(c.subpart_id||null)!==(d||null)))}},[by,aP,b,bx]),bJ=(0,e.useCallback)(async(a,c)=>{let d=by.startsWith("subpart:")?by.replace("subpart:",""):null;if(!c)return;let e=await fetch("/api/equipment-usage",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({equipment_id:a,part_id:b,subpart_id:d,student_id:c})});if(!e.ok)return;let f=await e.json();aK(e=>[...e.filter(c=>c.equipment_id!==a||c.part_id!==b||(c.subpart_id||null)!==(d||null)),{...f,student_name:bx.get(c)||f.student_name}])},[by,b,bx]);return v?(0,d.jsx)("div",{className:"text-center py-8",children:"Loading..."}):(0,d.jsxs)("div",{className:"space-y-6",children:[z&&(0,d.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:z}),(0,d.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-[220px_1fr] gap-6",children:[(0,d.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200 hidden lg:block",children:[(0,d.jsxs)("h3",{className:"font-semibold text-gray-900 mb-2",children:["Students (",l.length,")"]}),(0,d.jsx)("p",{className:"text-[11px] text-gray-500 mb-3",children:"Positioned students stay here so you can assign them to subparts."}),(0,d.jsx)("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:0===l.length?(0,d.jsx)("p",{className:"text-gray-500 text-sm",children:"No students yet."}):l.map(a=>{let b=bu.has(a.student_id),c=br.find(b=>b.student_id===a.student_id),e=c?.start_side||"OS",f=c?.end_side||"OS";return(0,d.jsxs)("div",{draggable:!0,onDragStart:()=>{a0(a.student_id,!1),U(a.student_id)},className:`p-3 rounded border cursor-move hover:shadow-md transition-all ${b?"bg-emerald-50 border-emerald-200 hover:border-emerald-300":"bg-white border-blue-200 hover:border-blue-400"}`,children:[(0,d.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,d.jsx)("p",{className:"font-medium text-sm text-gray-900",children:a.name}),b&&(0,d.jsx)("span",{className:"text-[10px] px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 font-semibold",children:"Positioned"})]}),(0,d.jsxs)("div",{className:"text-[10px] text-gray-500 mt-1",children:["Start: ",(0,d.jsx)("span",{className:"font-semibold text-gray-700",children:e})," ","End: ",(0,d.jsx)("span",{className:"font-semibold text-gray-700",children:f})]}),a.part_name&&(0,d.jsx)("p",{className:"text-xs text-gray-600",children:a.part_name})]},a.student_id)})}),bo&&L&&(0,d.jsx)("div",{className:"mt-4 border-t border-gray-200 pt-4",children:(0,d.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-2 mb-2",children:[(0,d.jsx)("p",{className:"text-[11px] text-gray-500",children:"Everyone has a start and end side (OS, SL, SR)."}),J.length>0&&(0,d.jsx)("button",{type:"button",onClick:async()=>{if(!L)return;let a=aZ.findIndex(a=>a.id===L);if(a<=0)return;let b=aZ[a-1]?.id;if(!b)return;let c=new Map((P[b]||[]).map(a=>[a.student_id,a.end_side||"OS"])),d=bb.map(a=>({...a,start_side:c.get(a.student_id)||a.start_side||"OS"}));await a9(d)},className:"text-[10px] px-2 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300",children:"Set start from previous end"})]})}),!L&&(0,d.jsxs)("div",{className:"mt-4 border-t border-gray-200 pt-4",children:[(0,d.jsx)("h4",{className:"font-medium text-gray-900 mb-2 text-sm",children:"Assigned Students (Part)"}),(0,d.jsx)("div",{className:"bg-white p-2 rounded border border-gray-200",children:0===n.length?(0,d.jsx)("div",{className:"text-xs text-gray-500 text-center",children:"No positioned students"}):(0,d.jsx)("div",{className:"space-y-2",children:n.map((a,b)=>(0,d.jsx)("div",{className:"flex items-center justify-between bg-gray-50 border border-gray-200 rounded px-2 py-1",children:(0,d.jsx)("div",{className:"text-xs text-gray-900",children:a.name})},a.id||`${a.student_id}-${b}`))})})]})]}),(0,d.jsx)("div",{children:(0,d.jsxs)("div",{className:"space-y-4",children:[(0,d.jsxs)("div",{className:"flex flex-wrap items-start justify-between gap-3 mb-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)(p.v,{size:24,className:"border border-gray-200 bg-white text-gray-400"}),(0,d.jsx)("h3",{className:"font-semibold text-gray-900",children:"Stage Layout"}),_?(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("input",{type:"text",value:ab,onChange:a=>ac(a.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm"}),(0,d.jsx)("button",{onClick:async()=>{if(!b)return;let a=ab.trim();if(a){ae(!0);try{if(!(await fetch(`/api/parts/${b}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a})})).ok)throw Error("Failed to update part name");aa(!1)}catch(a){alert(a instanceof Error?a.message:"Failed to update part name")}finally{ae(!1)}}},disabled:ad,className:"px-2 py-1 bg-green-600 text-white rounded text-xs disabled:bg-gray-400",children:ad?"Saving...":"Save"}),(0,d.jsx)("button",{onClick:()=>{aa(!1),ac(c||"")},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("span",{className:"text-xl font-semibold text-gray-900",children:c||""}),(0,d.jsx)("button",{onClick:()=>aa(!0),className:"text-xs text-blue-600 hover:text-blue-800",children:"Edit name"})]})]}),(0,d.jsxs)("div",{className:"mt-2",children:[af?(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("textarea",{value:ah,onChange:a=>ai(a.target.value),rows:2,placeholder:"Add part notes...",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("button",{onClick:async()=>{if(b){ak(!0);try{if(!(await fetch(`/api/parts/${b}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:ah||null})})).ok)throw Error("Failed to update part notes");ag(!1)}catch(a){alert(a instanceof Error?a.message:"Failed to update part notes")}finally{ak(!1)}}},disabled:aj,className:"px-2 py-1 bg-green-600 text-white rounded text-xs disabled:bg-gray-400",children:aj?"Saving...":"Save notes"}),(0,d.jsx)("button",{onClick:()=>{ag(!1),ai(g||"")},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]})]}):(0,d.jsxs)("div",{className:"flex items-start gap-2",children:[(0,d.jsx)("p",{className:"text-sm text-gray-600",children:g||"No notes yet."}),(0,d.jsx)("button",{onClick:()=>ag(!0),className:"text-xs text-blue-600 hover:text-blue-800",children:"Edit notes"})]}),bl&&(0,d.jsxs)("div",{className:"mt-1 text-xs text-gray-500",children:["Duration: ",bl]}),(0,d.jsxs)("div",{className:"mt-3",children:[(0,d.jsxs)("div",{className:"flex items-center justify-between",children:[(0,d.jsx)("div",{className:"text-xs font-semibold text-gray-600",children:"Timepoint"}),!al&&(0,d.jsx)("button",{onClick:()=>am(!0),className:"text-xs text-blue-600 hover:text-blue-800",children:"Edit time"})]}),al?(0,d.jsxs)("div",{className:"mt-2 space-y-2",children:[(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-[10px] text-gray-500",children:"Start (m / s)"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:an,onChange:a=>ao(a.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:ap,onChange:a=>aq(a.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-[10px] text-gray-500",children:"End (m / s)"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:ar,onChange:a=>as(a.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:at,onChange:a=>au(a.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]})]})]}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{onClick:async()=>{let a=a6(an,ap),c=a6(ar,at);if(null!==a&&null!==c&&c<a)return void alert("End time must be after start time.");aw(!0);try{if(!(await fetch(`/api/parts/${b}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({timepoint_seconds:a,timepoint_end_seconds:c})})).ok)throw Error("Failed to update timepoint");ay({start:a,end:c}),am(!1)}catch(a){alert(a instanceof Error?a.message:"Failed to update timepoint")}finally{aw(!1)}},disabled:av,className:"px-2 py-1 bg-emerald-600 text-white rounded text-xs disabled:bg-gray-400",children:av?"Saving...":"Save"}),(0,d.jsx)("button",{onClick:()=>{let a=a5(bj),b=a5(bk);ao(a.min),aq(a.sec),as(b.min),au(b.sec),am(!1)},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]})]}):(0,d.jsxs)("div",{className:"mt-1 text-xs text-gray-600",children:[a4(bj)," - ",a4(bk)]})]})]}),(0,d.jsxs)("p",{className:"text-sm text-gray-600 mt-1",children:["Front of stage: ","bottom"===B?"Bottom":"Top"]})]}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("span",{className:"text-xs text-gray-600",children:"Subpart"}),(0,d.jsxs)("select",{value:L||"",onChange:a=>M(a.target.value),className:"px-2 py-1 border border-gray-300 rounded text-xs",disabled:0===J.length,children:[(0,d.jsx)("option",{value:"",children:"Part positions"}),0===J.length&&(0,d.jsx)("option",{value:"",disabled:!0,children:"No subparts yet"}),aZ.map(a=>(0,d.jsx)("option",{value:a.id,children:a.title},a.id))]}),bh?.description&&(0,d.jsx)("span",{className:"text-[10px] text-gray-500",children:bh.description}),bi&&(0,d.jsxs)("span",{className:"text-[10px] text-gray-500",children:["Duration: ",bi]})]}),(0,d.jsxs)("div",{className:"flex flex-col items-end gap-2",children:[(0,d.jsxs)("div",{className:"flex items-center gap-3 text-xs",children:[x&&(0,d.jsx)("span",{className:"text-blue-600 font-semibold",children:"Auto-saving..."}),!x&&I.current&&(0,d.jsx)("span",{className:"text-orange-600 font-semibold",children:"Unsaved changes (auto-saves in 6s)"})]}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsxs)("select",{value:B,onChange:a=>C(a.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,d.jsx)("option",{value:"bottom",children:"Front - Bottom"}),(0,d.jsx)("option",{value:"top",children:"Front - Top"})]}),(0,d.jsx)("button",{onClick:()=>{L&&J.length>0?O(a=>({...a,[L]:[]})):o([]),I.current=!0},className:"px-4 py-2 bg-gray-300 text-gray-900 rounded-lg hover:bg-gray-400 font-medium text-sm",children:"Reset All"}),(0,d.jsx)("button",{onClick:a8,disabled:x,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 font-medium text-sm",children:x?"Saving...":"Save Positions"})]})]})]}),J.length>0&&(0,d.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3",children:[(0,d.jsx)("div",{className:"text-xs font-semibold text-gray-700 mb-2",children:"Subparts"}),(0,d.jsx)("div",{className:"flex flex-wrap gap-2",children:aZ.map((a,b)=>(0,d.jsxs)("button",{draggable:!0,onDragStart:()=>$(a.id),onDragOver:a=>a.preventDefault(),onDrop:()=>{if(!Z)return;let b=J.findIndex(a=>a.id===Z),c=J.findIndex(b=>b.id===a.id);b<0||c<0||(be(b,c),$(null))},onClick:()=>M(a.id),className:`px-3 py-1 rounded-full text-xs font-semibold border transition-colors ${L===a.id?"bg-blue-600 text-white border-blue-700":"bg-white text-gray-700 border-gray-300 hover:bg-gray-100"}`,title:"Drag to reorder",children:[b+1,". ",a.title]},a.id))})]}),bq.length>0&&(0,d.jsxs)("div",{className:"bg-blue-50 p-3 rounded-lg border border-blue-200",children:[(0,d.jsx)("h4",{className:"font-medium text-gray-900 mb-2 text-sm",children:"Legend"}),(0,d.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:bw.map(a=>(0,d.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,d.jsx)("div",{className:"w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold",children:a.initials}),(0,d.jsx)("span",{className:"text-gray-700 truncate",children:a.name})]},a.student_id))})]}),(0,d.jsxs)("div",{className:"bg-white p-3 rounded-lg border border-gray-200",children:[(0,d.jsx)("div",{className:"font-medium text-gray-900 text-sm mb-2",children:"Quick Position"}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2 items-center",children:[(0,d.jsxs)("select",{value:aB,onChange:a=>aC(a.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,d.jsx)("option",{value:"",children:"Select a part or subpart..."}),az.map(a=>(0,d.jsx)("option",{value:a.key,children:a.label},a.key))]}),(0,d.jsx)("button",{onClick:bg,disabled:!aB||aF,className:"px-3 py-1 bg-blue-600 text-white rounded text-sm disabled:bg-gray-400",children:aF?"Applying...":"Apply"})]}),(0,d.jsxs)("label",{className:"mt-2 flex items-center gap-2 text-xs text-gray-700",children:[(0,d.jsx)("input",{type:"checkbox",checked:aD,onChange:a=>aE(a.target.checked),className:"h-4 w-4"}),"Horizontal flip before applying"]})]}),J.length>0&&(0,d.jsx)("div",{className:"text-sm text-gray-700 font-medium text-center",children:bh?.title||"Subpart"}),(0,d.jsxs)("div",{className:"flex items-start justify-center gap-3",children:[aZ.length>0&&bn&&(0,d.jsx)("button",{onClick:()=>{let a=aZ.findIndex(a=>a.id===L);a>0&&M(aZ[a-1].id)},disabled:!L||0===aZ.findIndex(a=>a.id===L),className:"px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 text-xs",children:"Prev"}),(0,d.jsxs)("div",{className:"space-y-3 w-48",children:[["start_side","end_side"].map(a=>(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded p-2",children:[(0,d.jsxs)("div",{className:"text-[11px] font-semibold text-gray-700 mb-1",children:["Stage Right ","start_side"===a?"Start":"End"]}),(0,d.jsx)("div",{className:"border border-dashed border-gray-300 rounded p-2 min-h-[64px]",onDragOver:a=>a.preventDefault(),onDrop:async()=>{if(!T)return;let b=br.map(b=>b.student_id===T?{...b,[a]:"SR"}:b);J.length>0?await a9(b):await bd(b),U(null),W(null)},children:(0,d.jsx)("div",{className:"flex flex-wrap gap-2",children:bF(br.filter(b=>"SR"===(b[a]||"OS"))).map((b,c,e)=>{let f=bu.has(b.student_id);return(0,d.jsxs)("span",{draggable:!0,onDragStart:()=>{U(b.student_id),W({student_id:b.student_id,field:a,side:"SR"})},onDragOver:a=>a.preventDefault(),onDrop:async()=>{if(V&&V.field===a&&"SR"===V.side){let a=e.map(a=>a.student_id),c=a.indexOf(V.student_id),d=a.indexOf(b.student_id);if(c<0||d<0||c===d)return;let f=[...e],[g]=f.splice(c,1);f.splice(d,0,g);let h=new Map(f.map((a,b)=>[a.student_id,b])),i=br.slice().sort((a,b)=>{let c=h.get(a.student_id),d=h.get(b.student_id);return void 0===c||void 0===d?0:c-d});J.length>0?await a9(i):await bd(i),W(null)}},className:`px-2 py-0.5 rounded-full text-[10px] border cursor-move ${f?"bg-emerald-100 text-emerald-700 border-emerald-300":"bg-gray-100 text-gray-700 border-gray-300"}`,children:[c+1,". ",b.student_name]},`sr-${a}-${b.student_id}-${c}`)})})})]},`sr-${a}`)),(0,d.jsxs)("div",{className:"text-[10px] text-gray-500",children:["Start not set: ",bs," • End not set: ",bt]})]}),(0,d.jsxs)("div",{ref:F,className:"w-full overflow-hidden",style:{height:576*G},children:[(0,d.jsx)("div",{className:"mb-2 bg-white border border-gray-200 rounded p-2",children:(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-[11px] font-semibold text-gray-700 mb-1",children:"Start On Stage (OS)"}),(0,d.jsx)("div",{className:"border border-dashed border-gray-300 rounded p-2 min-h-[52px]",onDragOver:a=>a.preventDefault(),onDrop:async()=>{if(!T)return;let a=br.map(a=>a.student_id===T?{...a,start_side:"OS"}:a);J.length>0?await a9(a):await bd(a),U(null),W(null)},children:(0,d.jsx)("div",{className:"flex flex-wrap gap-2",children:bF(br.filter(a=>"OS"===(a.start_side||"OS"))).map((a,b)=>{let c=bu.has(a.student_id);return(0,d.jsxs)("span",{draggable:!0,onDragStart:()=>{U(a.student_id),W({student_id:a.student_id,field:"start_side",side:"OS"})},className:`px-2 py-0.5 rounded-full text-[10px] border cursor-move ${c?"bg-emerald-100 text-emerald-700 border-emerald-300":"bg-gray-100 text-gray-700 border-gray-300"}`,children:[b+1,". ",a.student_name]},`os-start-${a.student_id}-${b}`)})})})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-[11px] font-semibold text-gray-700 mb-1",children:"End On Stage (OS)"}),(0,d.jsx)("div",{className:"border border-dashed border-gray-300 rounded p-2 min-h-[52px]",onDragOver:a=>a.preventDefault(),onDrop:async()=>{if(!T)return;let a=br.map(a=>a.student_id===T?{...a,end_side:"OS"}:a);J.length>0?await a9(a):await bd(a),U(null),W(null)},children:(0,d.jsx)("div",{className:"flex flex-wrap gap-2",children:bF(br.filter(a=>"OS"===(a.end_side||"OS"))).map((a,b)=>{let c=bu.has(a.student_id);return(0,d.jsxs)("span",{draggable:!0,onDragStart:()=>{U(a.student_id),W({student_id:a.student_id,field:"end_side",side:"OS"})},className:`px-2 py-0.5 rounded-full text-[10px] border cursor-move ${c?"bg-emerald-100 text-emerald-700 border-emerald-300":"bg-gray-100 text-gray-700 border-gray-300"}`,children:[b+1,". ",a.student_name]},`os-end-${a.student_id}-${b}`)})})})]})]})}),(0,d.jsxs)("div",{className:"border-2 border-gray-400 bg-gradient-to-b from-amber-100 to-amber-50 relative mx-auto",style:{width:768,height:576,backgroundImage:`
                  linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),
                  linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px)
                `,backgroundSize:"64px 64px",transform:`scale(${G})`,transformOrigin:"top left"},onDragOver:a1,children:["bottom"===B&&(0,d.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-red-500"}),"top"===B&&(0,d.jsx)("div",{className:"absolute top-0 left-0 right-0 h-1 bg-red-500"}),(0,d.jsx)("div",{className:"absolute text-red-600 font-bold text-xs bg-white bg-opacity-80 px-2 py-1 rounded",style:{..."bottom"===B&&{bottom:5,left:"50%",transform:"translateX(-50%)"},..."top"===B&&{top:5,left:"50%",transform:"translateX(-50%)"}},children:"FRONT"}),L&&J.length>0&&0===bq.length&&(0,d.jsx)("div",{className:"absolute top-8 left-0 right-0 text-center text-2xl font-bold text-gray-500",children:bh?.title||"Subpart"}),Array.from({length:9}).map((a,b)=>Array.from({length:12}).map((a,c)=>(0,d.jsx)("div",{onDrop:a=>a7(a,c,b),onDragOver:a1,className:"absolute cursor-cell hover:bg-blue-100 hover:bg-opacity-30 transition-colors",style:{left:64*c,top:64*b,width:64,height:64}},`${c}-${b}`))),bq.map((a,b)=>{let c,e,f=r(a.name,bq.map(a=>a.name)),g=bp[a.student_id];return(0,d.jsxs)("div",{draggable:!0,onDragStart:()=>a0(a.student_id,!0),className:"absolute flex items-center justify-center group cursor-move",style:{left:(c=a.x,("top"===B?11-c:c)*64),top:(e=a.y,("top"===B?8-e:e)*64),width:64,height:64},children:[(0,d.jsxs)("div",{className:"relative w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg group-hover:bg-blue-600 transition-colors",children:[f,g?(0,d.jsx)("div",{className:"absolute -top-2 -left-2 w-5 h-5 rounded-full bg-amber-500 text-[10px] font-bold text-white flex items-center justify-center shadow",children:g}):null,(0,d.jsx)("button",{onClick:()=>(a=>{let b=async a=>{try{L&&J.length>0?await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:L,positions:a.map(a=>({subpart_id:L,student_id:a.student_id,x:a.x,y:a.y}))})}):await k(a),I.current=!1,E(Date.now())}catch(a){A(a instanceof Error?a.message:"Failed to save positions"),I.current=!0}};if(L&&J.length>0){let c=(N[L]||[]).filter(b=>b.student_id!==a);O(a=>({...a,[L]:c})),b(c)}else{let c=n.filter(b=>b.student_id!==a);o(c),b(c)}I.current=!0})(a.student_id),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600",title:"Remove from stage",children:"x"})]}),(0,d.jsx)("div",{className:"absolute bottom-full mb-1 whitespace-nowrap bg-gray-900 text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:a.name})]},a.id||`${a.student_id}-${a.x}-${a.y}-${b}`)})]})]}),(0,d.jsx)("div",{className:"space-y-3 w-48",children:["start_side","end_side"].map(a=>(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded p-2",children:[(0,d.jsxs)("div",{className:"text-[11px] font-semibold text-gray-700 mb-1",children:["Stage Left ","start_side"===a?"Start":"End"]}),(0,d.jsx)("div",{className:"border border-dashed border-gray-300 rounded p-2 min-h-[64px]",onDragOver:a=>a.preventDefault(),onDrop:async()=>{if(!T)return;let b=br.map(b=>b.student_id===T?{...b,[a]:"SL"}:b);J.length>0?await a9(b):await bd(b),U(null),W(null)},children:(0,d.jsx)("div",{className:"flex flex-wrap gap-2",children:bF(br.filter(b=>"SL"===(b[a]||"OS"))).map((b,c)=>{let e=bu.has(b.student_id);return(0,d.jsxs)("span",{draggable:!0,onDragStart:()=>{U(b.student_id),W({student_id:b.student_id,field:a,side:"SL"})},onDragOver:a=>a.preventDefault(),onDrop:async()=>{if(V&&V.field===a&&"SL"===V.side){let c=bF(br.filter(b=>"SL"===(b[a]||"OS"))),d=c.map(a=>a.student_id),e=d.indexOf(V.student_id),f=d.indexOf(b.student_id);if(e<0||f<0||e===f)return;let g=[...c],[h]=g.splice(e,1);g.splice(f,0,h);let i=new Map(g.map((a,b)=>[a.student_id,b])),j=br.slice().sort((a,b)=>{let c=i.get(a.student_id),d=i.get(b.student_id);return void 0===c||void 0===d?0:c-d});J.length>0?await a9(j):await bd(j),W(null)}},className:`px-2 py-0.5 rounded-full text-[10px] border cursor-move ${e?"bg-emerald-100 text-emerald-700 border-emerald-300":"bg-gray-100 text-gray-700 border-gray-300"}`,children:[c+1,". ",b.student_name]},`sl-${a}-${b.student_id}-${c}`)})})})]},`sl-${a}`))}),aZ.length>0&&bn&&(0,d.jsx)("button",{onClick:()=>{let a=aZ.findIndex(a=>a.id===L);a>=0&&a<aZ.length-1&&M(aZ[a+1].id)},disabled:!L||aZ.findIndex(a=>a.id===L)===aZ.length-1,className:"px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 text-xs",children:"Next"})]}),bo&&L&&null,(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mb-3",children:[(0,d.jsx)("h4",{className:"font-semibold text-gray-900",children:"Equipment"}),(0,d.jsxs)("div",{className:"ml-auto flex items-center gap-2",children:[(0,d.jsx)("input",{value:aL,onChange:a=>aM(a.target.value),placeholder:"Add equipment",className:"px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("button",{onClick:bG,className:"px-2 py-1 bg-gray-900 text-white rounded text-xs",children:"Add"})]})]}),(0,d.jsx)("div",{className:"text-[11px] text-gray-500 mb-3",children:"Active equipment shows at the top. Start side follows the previous active end. Set an initial side for first use."}),aN?(0,d.jsx)("div",{className:"text-xs text-gray-500",children:"Loading equipment…"}):0===bE.length?(0,d.jsx)("div",{className:"text-xs text-gray-500",children:"No equipment yet."}):(0,d.jsx)("div",{className:"space-y-3 max-h-80 overflow-y-auto pr-1",children:bE.map(a=>{let b=aP[a.equipment.id]||"",c=bx.get(b)||"",e=c&&c===a.equipment.name;return(0,d.jsxs)("div",{className:`border rounded-lg p-3 ${a.isActive?"border-emerald-300 bg-emerald-50":"border-gray-200"}`,children:[(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,d.jsx)("input",{value:a.equipment.name,onChange:b=>aI(c=>c.map(c=>c.id===a.equipment.id?{...c,name:b.target.value}:c)),onBlur:()=>bH(a.equipment.id,{name:a.equipment.name}),className:"px-2 py-1 border border-gray-300 rounded text-xs flex-1"}),(0,d.jsxs)("select",{value:b,onChange:b=>{let c=b.target.value;aQ(b=>({...b,[a.equipment.id]:c})),a.isActive&&c&&bJ(a.equipment.id,c)},className:"px-2 py-1 border border-gray-300 rounded text-xs",children:[(0,d.jsx)("option",{value:"",children:"Select performer"}),l.map(a=>(0,d.jsx)("option",{value:a.student_id,children:a.name},a.student_id))]}),(0,d.jsxs)("label",{className:"text-xs text-gray-700 flex items-center gap-1",children:[(0,d.jsx)("input",{type:"checkbox",checked:a.isActive,onChange:b=>bI(a.equipment.id,b.target.checked),className:"h-3 w-3"}),"Active"]})]}),(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mt-2 text-[11px] text-gray-600",children:[(0,d.jsx)("span",{className:"font-semibold text-gray-700",children:"Start:"})," ",(0,d.jsx)("span",{children:a.startSide||"Unset"}),(0,d.jsx)("span",{className:"font-semibold text-gray-700",children:"End:"})," ",(0,d.jsx)("span",{children:a.endSide||"—"}),a.activeStudentName&&(0,d.jsxs)("span",{className:"ml-auto text-[10px] text-gray-500",children:["Using: ",a.activeStudentName]})]}),(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[(0,d.jsx)("span",{className:"text-[10px] text-gray-500",children:"Initial side:"}),["OS","SL","SR"].map(b=>(0,d.jsx)("button",{type:"button",onClick:()=>bH(a.equipment.id,{initial_side:b}),className:`px-2 py-0.5 rounded-full text-[10px] border ${(a.equipment.initial_side||"")===b?"bg-gray-900 text-white border-gray-900":"bg-white text-gray-700 border-gray-300"}`,children:b},`${a.equipment.id}-${b}`)),b&&(0,d.jsx)("button",{type:"button",onClick:()=>bH(a.equipment.id,{name:c}),className:"text-[10px] px-2 py-0.5 rounded border border-gray-300 text-gray-600",children:"Use performer name"})]}),e&&(0,d.jsx)("div",{className:"text-[10px] text-amber-600 mt-1",children:"Equipment name matches performer. Consider renaming."})]},a.equipment.id)})})]}),(0,d.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,d.jsxs)("h4",{className:"font-medium text-gray-900 mb-3",children:["Positioned (",bq.length,")"]}),(0,d.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:bq.map((a,b)=>(0,d.jsxs)("div",{className:"bg-white p-2 rounded border border-green-200 text-sm",children:[(0,d.jsx)("p",{className:"font-medium text-gray-900",children:a.name}),(0,d.jsxs)("p",{className:"text-xs text-gray-600",children:["(",a.x,", ",a.y,")"]})]},a.id||`${a.student_id}-${a.x}-${a.y}-${b}`))})]})]})})]})]})}function t({performanceId:a,performanceTitle:b,currentMusicFile:c,onUploadSuccess:f}){let[g,h]=(0,e.useState)(!1),[i,j]=(0,e.useState)(null),[k,l]=(0,e.useState)(!1),m=async b=>{let c=b.currentTarget.files?.[0];if(c){h(!0),j(null),l(!1);try{let d=new FormData;d.append("file",c);let e=await fetch(`/api/performances/${a}/upload-music`,{method:"POST",body:d});if(!e.ok){let a=await e.json();throw Error(a.error||"Upload failed")}let g=await e.json();l(!0),f?.(g.filePath,g.publicUrl),b.currentTarget.value=""}catch(a){j(a instanceof Error?a.message:"Upload failed")}finally{h(!1)}}};return(0,d.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,d.jsx)("h3",{className:"font-bold text-lg text-gray-900 mb-4",children:"Performance Music"}),c&&(0,d.jsx)("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded",children:(0,d.jsxs)("p",{className:"text-sm text-green-900",children:[(0,d.jsx)("span",{className:"font-semibold",children:"✓ Music Uploaded:"})," ",c]})}),(0,d.jsxs)("div",{className:"space-y-3",children:[(0,d.jsxs)("label",{className:"block",children:[(0,d.jsx)("div",{className:"flex items-center justify-center w-full p-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors bg-gray-50 hover:bg-blue-50",children:(0,d.jsxs)("div",{className:"text-center",children:[(0,d.jsx)("p",{className:"text-2xl mb-2",children:"\uD83C\uDFB5"}),(0,d.jsx)("p",{className:"text-sm font-semibold text-gray-700",children:g?"Uploading...":"Click to upload music"}),(0,d.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"MP3, WAV, OGG (max 15MB)"})]})}),(0,d.jsx)("input",{type:"file",accept:"audio/*",onChange:m,disabled:g,className:"hidden"})]}),i&&(0,d.jsx)("div",{className:"p-3 bg-red-50 border border-red-200 rounded",children:(0,d.jsxs)("p",{className:"text-sm text-red-900",children:["❌ ",i]})}),k&&(0,d.jsx)("div",{className:"p-3 bg-green-50 border border-green-200 rounded",children:(0,d.jsx)("p",{className:"text-sm text-green-900",children:"✓ Music uploaded successfully!"})})]})]})}function u({musicUrl:a,onTimeUpdate:b,performanceTitle:c,audioRef:f,onAudioReady:g}){let h=(0,e.useRef)(null),i=f??h,[j,k]=(0,e.useState)(!1),[l,m]=(0,e.useState)(0),[n,o]=(0,e.useState)(0),[p,q]=(0,e.useState)(1),r=a=>{if(!a||isNaN(a))return"0:00";let b=Math.floor(a/60),c=Math.floor(a%60);return`${b}:${c.toString().padStart(2,"0")}`};return(0,d.jsxs)("div",{className:"bg-gray-900 text-white rounded-lg p-6 shadow-xl",children:[(0,d.jsx)("audio",{ref:i,src:a}),(0,d.jsxs)("div",{className:"mb-4",children:[(0,d.jsx)("h3",{className:"font-bold text-lg mb-1",children:c?`Music for ${c}`:"Music Player"}),!a&&(0,d.jsx)("p",{className:"text-sm text-gray-400",children:"No music uploaded yet"})]}),a&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,d.jsx)("button",{onClick:()=>{i.current&&(j?i.current.pause():i.current.play())},disabled:!a,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 rounded-lg font-semibold transition-colors",children:j?"⏸ Pause":"▶ Play"}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("span",{className:"text-xs text-gray-400",children:"\uD83D\uDD0A"}),(0,d.jsx)("input",{type:"range",min:"0",max:"1",step:"0.1",value:p,onChange:a=>{let b=parseFloat(a.target.value);q(b),i.current&&(i.current.volume=b)},className:"w-20 cursor-pointer"}),(0,d.jsxs)("span",{className:"text-xs text-gray-400 w-6",children:[Math.round(100*p),"%"]})]})]}),(0,d.jsxs)("div",{className:"mb-4",children:[(0,d.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,d.jsx)("span",{className:"text-sm text-gray-300 w-12 text-right",children:r(l)}),(0,d.jsx)("input",{type:"range",min:"0",max:n||0,value:l,onChange:a=>{var b;return b=parseFloat(a.target.value),void(i.current&&(i.current.currentTime=b,m(b)))},className:"flex-1 cursor-pointer"}),(0,d.jsx)("span",{className:"text-sm text-gray-300 w-12",children:r(n)})]}),(0,d.jsx)("div",{className:"w-full bg-gray-700 rounded-full h-1",children:(0,d.jsx)("div",{className:"bg-blue-500 h-1 rounded-full transition-all",style:{width:`${n?l/n*100:0}%`}})})]})]}),!a&&(0,d.jsx)("div",{className:"text-center py-8 text-gray-400",children:(0,d.jsx)("p",{children:"Upload music in the performance settings to enable playback"})})]})}function v(a){if(!a)return"?";let b=a.trim().split(/\s+/);return 1===b.length?b[0].slice(0,2).toUpperCase():(b[0][0]+b[b.length-1][0]).toUpperCase()}function w({performanceId:a,parts:b,musicUrl:c,onClose:f,onUpdatePartTimepoints:g}){let[h,i]=(0,e.useState)(0),[j,k]=(0,e.useState)({}),[l,m]=(0,e.useState)(!1),[n,o]=(0,e.useState)(!0),[q,r]=(0,e.useState)({}),[s,t]=(0,e.useState)({}),[u,w]=(0,e.useState)({}),[x,y]=(0,e.useState)({}),[z,A]=(0,e.useState)({}),[B,C]=(0,e.useState)({}),[D,E]=(0,e.useState)(""),[F,G]=(0,e.useState)({}),[H,I]=(0,e.useState)({}),[J,K]=(0,e.useState)({}),[L,M]=(0,e.useState)(null),[N,O]=(0,e.useState)(null),[P,Q]=(0,e.useState)(null),[R,S]=(0,e.useState)(""),[T,U]=(0,e.useState)(""),[V,W]=(0,e.useState)("bottom"),[X,Y]=(0,e.useState)(null),[Z,$]=(0,e.useState)(null),[_,aa]=(0,e.useState)(null),[ab,ac]=(0,e.useState)(""),[ad,ae]=(0,e.useState)(""),[af,ag]=(0,e.useState)(""),[ah,ai]=(0,e.useState)(""),[aj,ak]=(0,e.useState)(null),[al,am]=(0,e.useState)({}),[an,ao]=(0,e.useState)(new Set),[ap,aq]=(0,e.useState)(!1),[ar,as]=(0,e.useState)(0),[at,au]=(0,e.useState)(1),[av,aw]=(0,e.useState)(!1),[ax,ay]=(0,e.useState)(null),[az,aA]=(0,e.useState)(null),[aB,aC]=(0,e.useState)(!1),[aD,aE]=(0,e.useState)(null),[aF,aG]=(0,e.useState)(!1),aH=(0,e.useRef)(null),aI=(0,e.useRef)(null),aJ=(0,e.useRef)(null),aK=(0,e.useRef)(null),[aL,aM]=(0,e.useState)(1),[aN,aO]=(0,e.useState)(1);(0,e.useRef)(null),(0,e.useRef)(null);let aP=(0,e.useMemo)(()=>b.map(a=>{let b=al[a.id];return b?{...a,timepoint_seconds:b.start,timepoint_end_seconds:b.end}:a}),[b,al]),aQ=(0,e.useMemo)(()=>[...aP].sort((a,b)=>{let c="number"==typeof a.timepoint_seconds?a.timepoint_seconds:1/0,d="number"==typeof b.timepoint_seconds?b.timepoint_seconds:1/0;return c===d?(a.order||0)-(b.order||0):c-d}),[aP]),aR=(0,e.useMemo)(()=>aQ.filter(a=>"number"==typeof a.timepoint_seconds),[aQ]),aS=(0,e.useMemo)(()=>{let a=[],b=[...aQ].filter(a=>"number"==typeof a.timepoint_seconds).sort((a,b)=>(a.timepoint_seconds||0)-(b.timepoint_seconds||0));for(let c=0;c<b.length;c++){let d=b[c],e=d.timepoint_seconds||0,f=c<b.length-1?b[c+1].timepoint_seconds||e:null,g="number"==typeof d.timepoint_end_seconds?d.timepoint_end_seconds:null!==f?f:e+1;a.push({id:d.id,name:d.name,start:e,end:Math.max(g,e+.1),subparts:q[d.id]||[]})}return a},[aQ,q]),aT=(0,e.useMemo)(()=>{let a=new Map;return aS.forEach(b=>{a.set(b.id,{start:b.start,end:b.end})}),a},[aS]),aU=(0,e.useMemo)(()=>Math.max(ar||0,aS.reduce((a,b)=>Math.max(a,b.end),0),1),[aS,ar]),aV=(0,e.useMemo)(()=>{if(0===aR.length)return -1;let a=0;for(let b=0;b<aR.length;b++){let c=aR[b].timepoint_seconds||0,d=aR[b].timepoint_end_seconds;h>=c&&(null==d||h<d)?a=b:h>=c&&(a=b)}return a},[aR,h]),aW=aV>=0?aR[aV]:null,aX=aV>=0?aR[aV+1]:null,aY=aX?Math.max(0,(aX.timepoint_seconds||0)-h):null,aZ=a=>{if(null==a||Number.isNaN(a))return"--:--";let b=Math.max(0,Math.floor(a)),c=Math.floor(b/60);return`${c}:${(b%60).toString().padStart(2,"0")}`},a$=(a,b)=>{if("number"!=typeof a||"number"!=typeof b||!Number.isFinite(a)||!Number.isFinite(b))return"";let c=Math.max(0,b-a),d=Math.floor(c/60),e=Math.round(c%60);return`${d}m ${e}s`},a_=a=>{if(null==a||Number.isNaN(a))return{min:"",sec:""};let b=Math.max(0,Math.floor(a));return{min:String(Math.floor(b/60)),sec:String(b%60)}},a0=(a,b)=>{if(!a&&!b)return null;let c=a?parseInt(a,10):0,d=b?parseFloat(b):0;return Number.isNaN(c)||Number.isNaN(d)?null:60*c+d},a1=(a,b=!0)=>{if(!aI.current)return;let c=Math.max(0,a);aI.current.currentTime=c,i(c),b&&aI.current.play()},a2=()=>{aI.current&&(ap?aI.current.pause():aI.current.play())},a3=a=>{let b=aT.get(a);b&&aA(b)},a4=(0,e.useMemo)(()=>{let a=new Set;return Object.values(j).forEach(b=>{b.forEach(b=>a.add(b.student_name||"Unknown"))}),Object.values(s).forEach(b=>{b.forEach(b=>a.add(b.student_name||"Unknown"))}),Array.from(a).sort((a,b)=>a.localeCompare(b))},[j,s]),a5=(0,e.useMemo)(()=>D?aQ.filter(a=>!!(j[a.id]||[]).map(a=>a.student_name).includes(D)||(q[a.id]||[]).some(a=>(s[a.id]||[]).some(a=>a.student_name===D))):aQ,[aQ,D,j,q,s]),a6=()=>{try{let a=window.AudioContext||window.webkitAudioContext;if(!a)return;let b=new a,c=b.createGain();c.gain.value=.3,c.connect(b.destination);let d=b.createOscillator();d.type="sine",d.frequency.value=880,d.connect(c);let e=b.currentTime;d.start(e),d.stop(e+.15),setTimeout(()=>b.close(),300)}catch{}},a7=(a,b)=>{if(!aI.current)return;O(a),Q(b),M(3),a6();let c=3,d=setInterval(()=>{if((c-=1)<=0){clearInterval(d),M(null),O(null),Q(null),aI.current.currentTime=a,aI.current.play();return}M(c),a6()},1e3)};(0,e.useCallback)(async a=>{try{let b=await fetch(`/api/subparts?partId=${a}`);if(!b.ok)return;let c=(await b.json()||[]).map(a=>({id:a.id,part_id:a.part_id,title:a.title,description:a.description??null,timepoint_seconds:a.timepoint_seconds??null,timepoint_end_seconds:a.timepoint_end_seconds??null}));r(b=>({...b,[a]:c}))}catch{}},[]);let a8=(0,e.useCallback)((a,b)=>b?`subpart:${b}`:`part:${a}`,[]),a9=(0,e.useCallback)(async(b,c)=>{let d=a8(b,c),e=(H[d]??F[d]??"").trim();if(e!==(F[d]??"").trim()){K(a=>({...a,[d]:!0}));try{if(!(await fetch("/api/rehearse-notes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:a,part_id:b,subpart_id:c??null,note:e})})).ok)throw Error("Failed to save note");e?G(a=>({...a,[d]:e})):G(a=>{let b={...a};return delete b[d],b})}catch(a){console.error(a),alert("Failed to save note")}finally{K(a=>({...a,[d]:!1}))}}},[a8,F,H,a]),ba=a=>{if(!a)return null;let b=q[a.id]||[];if(0===b.length)return null;let c=b.map(a=>{let b=s[a.id]||[],c=x[a.id]||!1;return 0===b.length||c?null:{title:a.title,entries:b,description:a.description||null}}).filter(Boolean);return 0===c.length?null:(0,d.jsxs)("div",{className:"bg-white border border-indigo-200 rounded-lg p-5 shadow-sm min-h-[220px]",children:[(0,d.jsx)("div",{className:"text-sm uppercase tracking-wide text-indigo-600 font-semibold mb-2",children:"Subpart Assignments"}),(0,d.jsx)("div",{className:"space-y-3 text-base text-gray-700",children:c.map(a=>(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"font-semibold text-gray-900",children:a.title}),a.description&&(0,d.jsx)("div",{className:"text-sm text-gray-500",children:a.description}),(0,d.jsx)("div",{className:"text-gray-600",children:a.entries.map(a=>{let b=a.start_side||"OS",c=a.end_side||b,d=b===c?b:`${b}→${c}`;return`${a.student_name} (${d})`}).join(", ")})]},a.title))})]})},bb=a=>{if(!a||0===a.length)return(0,d.jsx)("div",{className:"text-[10px] text-gray-500",children:"No positions"});let b=a.map(a=>a.x),c=a.map(a=>a.y),e=Math.max(0,Math.min(...b)-1),f=Math.max(0,Math.min(...c)-1),g=Math.max(1,Math.min(11,Math.max(...b)+1)-e+1),h=Math.max(1,Math.min(7,Math.max(...c)+1)-f+1);return(0,d.jsx)("div",{className:"mt-2 border border-gray-200 bg-gray-50 p-2 rounded",children:(0,d.jsx)("div",{className:"relative",style:{width:18*g,height:18*h,backgroundImage:`
              linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),
              linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px)
            `,backgroundSize:"18px 18px"},children:a.map(a=>(0,d.jsx)("div",{className:"absolute flex items-center justify-center",style:{left:(a.x-e)*18,top:(a.y-f)*18,width:18,height:18},children:(0,d.jsx)("div",{className:"bg-blue-600 text-white text-[9px] font-bold rounded-full w-4 h-4 flex items-center justify-center",children:v(a.student_name)})},`${a.student_id}-${a.x}-${a.y}`))})})},bc=(a,b,c,e)=>{let f=b&&j[b.id]||[],g=c?"text-5xl":"text-4xl",h=c?"text-base":"text-sm",i=c?"border-purple-700 bg-purple-100":"border-blue-700 bg-blue-100",k=c?"from-purple-200 to-purple-300":"from-blue-200 to-blue-300",l=Math.max(18,Math.round(.7*e)),m=e>=70?"text-base":"text-[10px]",n=12*e,o=8*e,p=c?aN:aL,r=c?aK:aJ,s=b&&q[b.id]||[],t=s.filter(a=>"number"==typeof a.timepoint_seconds).sort((a,b)=>(a.timepoint_seconds||0)-(b.timepoint_seconds||0)),u=b&&Z?s.find(a=>a.id===Z):null,w=c&&t[0]||null,x=u?t.findIndex(a=>a.id===u.id):-1,y=x>=0?t[x+1]||null:t[0]||null,z=a=>a.slice(0,7);return(0,d.jsxs)("div",{className:`rounded-lg border p-4 shadow-sm ${i}`,children:[(0,d.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:`${h} uppercase tracking-wide text-gray-600`,children:a}),(0,d.jsx)("div",{className:`${g} font-semibold text-gray-900`,children:b?b.name:"—"})]}),c&&null!==aY&&aY<=10&&(0,d.jsx)("div",{className:"text-7xl font-extrabold text-red-600 animate-pulse",children:Math.ceil(aY)})]}),c&&null!==aY&&aY<=10&&(0,d.jsx)("div",{className:"mb-2 text-3xl font-extrabold text-red-600 animate-pulse",children:"GET READY"}),(0,d.jsx)("div",{ref:r,className:"w-full overflow-hidden",style:{height:o*p},children:(0,d.jsxs)("div",{className:`border border-gray-300 bg-gradient-to-b ${k} relative mx-auto`,style:{width:n,height:o,backgroundImage:`
                linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px)
              `,backgroundSize:`${e}px ${e}px`,transform:`scale(${p})`,transformOrigin:"top left"},children:["bottom"===V&&(0,d.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-red-500"}),"top"===V&&(0,d.jsx)("div",{className:"absolute top-0 left-0 right-0 h-1 bg-red-500"}),(0,d.jsx)("div",{className:"absolute text-red-600 font-bold text-xs bg-white bg-opacity-80 px-2 py-1 rounded",style:{..."bottom"===V&&{bottom:5,left:"50%",transform:"translateX(-50%)"},..."top"===V&&{top:5,left:"50%",transform:"translateX(-50%)"}},children:"FRONT"}),!c&&u&&(0,d.jsx)("div",{className:"absolute left-2 top-2 px-2 py-1 bg-white/80 text-amber-700 font-extrabold text-xl rounded shadow",children:z(u.title||"")}),Array.from({length:8}).map((a,b)=>Array.from({length:12}).map((a,c)=>(0,d.jsx)("div",{className:"absolute",style:{left:c*e,top:b*e,width:e,height:e}},`${c}-${b}`))),f.map(a=>(0,d.jsx)("div",{className:"absolute flex items-center justify-center",style:{left:a.x*e,top:a.y*e,width:e,height:e},children:(0,d.jsx)("div",{className:`bg-blue-600 text-white ${m} font-bold rounded-full flex items-center justify-center shadow-md`,style:{width:l,height:l},children:v(a.student_name)})},`${a.student_id}-${a.x}-${a.y}`))]})}),c&&w&&(0,d.jsx)("div",{className:"mt-2 text-2xl font-extrabold text-purple-700",children:z(w.title||"")}),!c&&y&&(0,d.jsxs)("div",{className:"mt-2 text-xl font-extrabold text-blue-700",children:["Next up: ",z(y.title||"")]})]})},bd=(a,b)=>{let c=Array.from(new Map((a&&j[a.id]||[]).map(a=>[a.student_id,a.student_name||"Unknown"])).values()),e=a&&q[a.id]||[],f=a&&u[a.id]||[],g=a?a$(a.timepoint_seconds,a.timepoint_end_seconds):"";return(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 shadow-sm min-h-[72px]",children:[(0,d.jsx)("div",{className:`${b?"text-sm":"text-xs"} uppercase tracking-wide text-gray-500 mb-2`,children:"INFO"}),(0,d.jsxs)("div",{className:"space-y-3",children:[g&&(0,d.jsxs)("div",{className:"text-sm text-gray-600",children:["Duration: ",(0,d.jsx)("span",{className:"font-semibold text-gray-900",children:g})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-xs font-semibold text-gray-600 mb-2",children:"People"}),0===c.length?(0,d.jsx)("div",{className:"text-xs text-gray-500",children:"No positions"}):(0,d.jsx)("div",{className:`flex flex-wrap gap-2 ${b?"text-2xl":"text-base"} text-gray-800`,children:c.map(b=>(0,d.jsx)("span",{className:"px-2 py-1 bg-gray-100 rounded",children:b},`${a?.id||"none"}-${b}`))})]}),e.length>0&&(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-xs font-semibold text-gray-600 mb-2",children:"Subparts"}),(0,d.jsx)("div",{className:"space-y-2 text-sm text-gray-700",children:e.map((a,b)=>{let c=s[a.id]||[],e=a$(a.timepoint_seconds,a.timepoint_end_seconds);return(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:"font-semibold text-gray-900",children:[b+1,". ",a.title]}),e&&(0,d.jsxs)("div",{className:"text-xs text-gray-500",children:["Duration: ",e]}),(0,d.jsx)("div",{className:"text-gray-600",children:0===c.length?(0,d.jsx)("span",{children:"Assigned: —"}):(0,d.jsxs)("span",{children:["Assigned:"," ",c.map((b,c)=>{let e=b.start_side||"OS",f=b.end_side||e,g=e===f?e:`${e}→${f}`;return(0,d.jsxs)("span",{children:[c>0?", ":"",c+1,". ",b.student_name," ",(0,d.jsxs)("span",{className:"font-semibold",children:["(",g,")"]})]},`${a.id}-info-${c}`)})]})})]},a.id)})})]}),0===e.length&&f.length>0&&(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-xs font-semibold text-gray-600 mb-2",children:"Sides"}),(0,d.jsx)("div",{className:"text-sm text-gray-700 flex flex-wrap gap-2",children:f.map(a=>{let b=a.start_side||"OS",c=a.end_side||b,e=b===c?b:`${b}→${c}`;return(0,d.jsxs)("span",{className:"px-2 py-1 bg-gray-100 rounded",children:[a.student_name," ",(0,d.jsxs)("span",{className:"font-semibold",children:["(",e,")"]})]},`side-${a.student_id}`)})})]})]})]})},be=a=>{let b=aH.current;if(!b)return 0;let c=b.getBoundingClientRect();return Math.min(1,Math.max(0,(a-c.left)/c.width))*aU},bf=a=>{let b=be(a.clientX);aG(!0),a1(b,!1)},bg=a=>{aF&&a1(be(a.clientX),!1)},bh=a=>{aF&&(a1(be(a.clientX),!0),aG(!1))};return(0,d.jsx)("div",{className:"fixed inset-0 z-50 bg-black bg-opacity-70 flex",children:(0,d.jsx)("div",{className:"flex-1 bg-gray-100 overflow-auto",children:(0,d.jsxs)("div",{className:"w-full h-full p-6",children:[(0,d.jsx)("audio",{ref:aI,src:c||void 0}),(0,d.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:"flex items-center gap-3 mb-1",children:[(0,d.jsx)(p.v,{className:"border border-gray-200 bg-white text-gray-400",size:32}),(0,d.jsx)("div",{className:"text-sm uppercase tracking-wide text-gray-500",children:"Rehearse Mode"})]}),(0,d.jsx)("div",{className:"text-3xl font-bold text-gray-900",children:"Live Stage View"}),T&&(0,d.jsxs)("div",{className:"text-sm text-gray-600 mt-1",children:["Performance: ",(0,d.jsx)("span",{className:"font-semibold text-gray-900",children:T})]})]}),(0,d.jsx)("div",{className:"flex items-center gap-4",children:(0,d.jsx)("button",{onClick:f,className:"px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-800",children:"Close"})})]}),(()=>{if(0===aS.length)return null;let a=100*Math.min(1,Math.max(0,h/aU)),b=ax?Math.min(ax.start,ax.end):null,e=ax?Math.max(ax.start,ax.end):null,f=["bg-blue-600","bg-emerald-600","bg-amber-600","bg-purple-600","bg-rose-600","bg-teal-600"],g=["bg-blue-200 text-blue-900","bg-emerald-200 text-emerald-900","bg-amber-200 text-amber-900","bg-purple-200 text-purple-900","bg-rose-200 text-rose-900","bg-teal-200 text-teal-900"],i=new Map(aS.map((a,b)=>[a.id,b])),j=aS.flatMap(a=>{let b=q[a.id]||[],c=i.get(a.id)??0;return b.map(b=>{let d="number"==typeof b.timepoint_seconds?b.timepoint_seconds:Number(b.timepoint_seconds);if(!Number.isFinite(d))return null;let e=Math.min(Math.max(d,a.start),a.end-.1),f="number"==typeof b.timepoint_end_seconds?b.timepoint_end_seconds:Number(b.timepoint_end_seconds),g=Math.min(Math.max(Number.isFinite(f)?f:e+.1,e+.1),a.end);return g<=e?null:{id:b.id,partId:a.id,title:b.title,start:e,end:g,colorIdx:c}}).filter(Boolean)}).filter(Boolean);return(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4 shadow-sm mb-6",children:[(0,d.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-3 mb-3",children:[(0,d.jsx)("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Performance Timeline"}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("button",{onClick:a2,disabled:!c,className:"px-3 py-1 bg-gray-900 text-white rounded text-xs disabled:bg-gray-400",children:ap?"Pause":"Play"}),(0,d.jsxs)("div",{className:"text-xs text-gray-600",children:[aZ(h)," / ",aZ(aU)]}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-xs text-gray-600",children:["Volume",(0,d.jsx)("input",{type:"range",min:"0",max:"1",step:"0.05",value:at,onChange:a=>au(parseFloat(a.target.value)),className:"w-20"})]}),(0,d.jsx)("button",{onClick:()=>{aB&&az?(ay(az),aw(!0),aC(!1)):(aC(!0),aA(null))},className:`px-3 py-1 rounded text-xs ${av||aB?"bg-emerald-600 text-white":"bg-gray-200 text-gray-700"}`,children:aB?az?"Confirm Loop":"Select Part":av?"Loop On":"Set Loop"}),av&&(0,d.jsx)("button",{onClick:()=>{aw(!1),ay(null),aA(null),aC(!1)},className:"px-3 py-1 rounded text-xs bg-gray-200 text-gray-700",children:"Clear Loop"})]})]}),(0,d.jsxs)("div",{ref:aH,className:"relative h-24 rounded bg-slate-50 border border-slate-200 overflow-hidden cursor-pointer",onMouseDown:bf,onMouseMove:bg,onMouseUp:bh,onMouseLeave:bh,children:[null!==b&&null!==e&&(0,d.jsx)("div",{className:"absolute top-0 h-full bg-emerald-200/70",style:{left:`${b/aU*100}%`,width:`${(e-b)/aU*100}%`}}),(0,d.jsx)("div",{className:"absolute top-0 left-0 right-0 h-14",children:aS.map((a,b)=>{let c=a.start/aU*100,e=Math.max(1,(a.end-a.start)/aU*100),g=aW?.id===a.id;return(0,d.jsx)("button",{type:"button",onClick:()=>{aB?aA({start:a.start,end:a.end}):a1(a.start,!0)},className:`absolute top-0 h-full text-base font-semibold px-2 py-1 text-center truncate ${g?"bg-blue-700 text-white":`${f[b%f.length]} text-white`} ${aB&&az?.start===a.start?"ring-2 ring-emerald-300":""}`,style:{left:`${c}%`,width:`${e}%`},title:a.name,children:a.name},a.id)})}),(0,d.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-10 border-t border-slate-200 bg-slate-100/80",children:j.map((a,b)=>{let c=a.start/aU*100,e=Math.max(1,(a.end-a.start)/aU*100);return(0,d.jsx)("button",{type:"button",onClick:()=>a1(a.start,!0),className:`absolute top-0 h-full text-xs font-semibold px-2 py-1 text-center truncate ${b%2==0?"border-l border-slate-300":"border-l border-white/60"} ${g[a.colorIdx%g.length]}`,style:{left:`${c}%`,width:`${e}%`},title:a.title,children:a.title},a.id)})}),(0,d.jsx)("div",{className:"absolute top-0 h-full w-[3px] bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.7)]",style:{left:`${a}%`}})]}),aW&&(q[aW.id]||[]).length>0&&(0,d.jsx)("div",{className:"mt-3 flex flex-wrap gap-2",children:(q[aW.id]||[]).map((a,b)=>{let c="number"==typeof a.timepoint_seconds?a.timepoint_seconds:null;return(0,d.jsxs)("button",{type:"button",onClick:()=>{null!==c&&a1(c,!0)},className:"px-3 py-1 rounded-full text-xs font-semibold bg-white border border-gray-200 hover:bg-gray-50",children:[b+1,". ",a.title]},a.id)})})]})})(),(0,d.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-[360px_1fr] gap-6",children:[(0,d.jsxs)("div",{className:"bg-white rounded-lg border border-gray-200 p-4 shadow-sm",children:[(0,d.jsx)("div",{className:"flex items-center justify-between mb-2",children:(0,d.jsx)("div",{className:"text-2xl font-semibold text-gray-900",children:"Parts"})}),(0,d.jsx)("div",{className:"text-xs text-gray-500 mb-3",children:"Click a part name to play from its start time."}),(0,d.jsx)("div",{className:"space-y-5",children:a5.map((a,b)=>{let c=aW?.id===a.id,e=aX?.id===a.id,f=_===a.id,h="number"==typeof a.timepoint_seconds?a.timepoint_seconds:null,i=a$(h,"number"==typeof a.timepoint_end_seconds?a.timepoint_end_seconds:null),k=q[a.id]||[],l=an.has(a.id);return(0,d.jsxs)("div",{className:`border rounded p-2 cursor-pointer transition-colors ${c?"border-blue-500 bg-blue-50":"border-gray-200 bg-white"}`,onClick:()=>{aB&&a3(a.id)},onDoubleClick:()=>{null!==h&&a1(h,!0)},children:[(0,d.jsxs)("div",{className:"flex items-center justify-between",children:[(0,d.jsx)("button",{type:"button",onClick:()=>{if(aB)return void a3(a.id);null!==h&&a1(h,!0)},className:"font-semibold text-gray-900 text-xl text-left",children:a.name}),e&&(0,d.jsx)("span",{className:"text-base font-bold text-purple-700 bg-purple-100 px-2 py-0.5 rounded",children:"NEXT"})]}),(0,d.jsxs)("div",{className:"text-base text-gray-500",children:[null!==h?aZ(h):"No timepoint",i&&(0,d.jsxs)("span",{className:"ml-2 text-sm text-gray-400",children:["(",i,")"]})]}),(0,d.jsxs)("div",{className:"mt-2 flex items-center gap-2",children:[null!==h&&(0,d.jsx)("button",{onClick:b=>{b.stopPropagation(),a7(h,a.id)},className:"px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700",children:"Jump to part"}),(0,d.jsx)("button",{onClick:()=>{ao(b=>{let c=new Set(b);return c.has(a.id)?c.delete(a.id):c.add(a.id),c})},className:"px-3 py-1 text-xs rounded bg-gray-200 text-gray-700 hover:bg-gray-300",children:l?"Hide Details":"Expand Details"})]}),!l&&k.length>0&&(0,d.jsx)("div",{className:"mt-2 flex flex-wrap gap-2",children:k.map((a,b)=>{let c="number"==typeof a.timepoint_seconds?a.timepoint_seconds:null;return(0,d.jsxs)("button",{type:"button",onClick:()=>{null!==c&&a1(c,!0)},className:"px-2 py-0.5 rounded-full text-[11px] font-semibold bg-gray-100 text-gray-700",children:[b+1,". ",a.title]},a.id)})}),l&&(0,d.jsxs)(d.Fragment,{children:[f?(0,d.jsxs)("div",{className:"mt-2 space-y-2",children:[(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-[11px] font-semibold text-gray-600",children:"Start (m / s)"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:ab,onChange:a=>ac(a.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:ad,onChange:a=>ae(a.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()})]})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-[11px] font-semibold text-gray-600",children:"End (m / s)"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:af,onChange:a=>ag(a.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:ah,onChange:a=>ai(a.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()})]})]})]}),aD&&(0,d.jsx)("div",{className:"text-[11px] text-red-600",children:aD}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{onClick:async b=>{b.stopPropagation();let c=a0(ab,ad),d=a0(af,ah),e=(a=>{let b=q[a]||[],c=[],d=[];return b.forEach(a=>{"number"==typeof a.timepoint_seconds&&c.push(a.timepoint_seconds),"number"==typeof a.timepoint_end_seconds&&d.push(a.timepoint_end_seconds)}),{minStart:c.length>0?Math.min(...c):null,maxEnd:d.length>0?Math.max(...d):null}})(a.id);if(null!==e.minStart&&(null===c||c>e.minStart)&&(c=e.minStart),null!==e.maxEnd&&(null===d||d<e.maxEnd)&&(d=e.maxEnd),ar>0&&(null!==c&&c>ar||null!==d&&d>ar))return void aE("Time exceeds music length. Use a time within the track.");if(null!==c&&null!==d&&d<c)return void aE("End time must be after start time.");aE(null),ak(a.id);try{let b=await fetch(`/api/parts/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({timepoint_seconds:c,timepoint_end_seconds:d})});if(!b.ok){let a=await b.json().catch(()=>null);throw Error(a?.details||a?.error||"Failed to update timepoints")}let e=await b.json();am(b=>({...b,[a.id]:{start:c,end:d}})),g?.(e),aa(null)}catch(a){console.error("Failed to update timepoints:",a),alert("Failed to update timepoints")}finally{ak(null)}},className:"px-2 py-1 bg-emerald-600 text-white rounded text-xs hover:bg-emerald-700 disabled:opacity-50",disabled:aj===a.id,children:aj===a.id?"Saving...":"Save"}),(0,d.jsx)("button",{onClick:a=>{a.stopPropagation(),aa(null)},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs hover:bg-gray-400",children:"Cancel"})]})]}):(0,d.jsx)("div",{className:"mt-1",children:(0,d.jsx)("button",{onClick:b=>{b.stopPropagation();let c="number"==typeof a.timepoint_seconds?a.timepoint_seconds:null,d="number"==typeof a.timepoint_end_seconds?a.timepoint_end_seconds:null,e=a_(c),f=a_(d);ac(e.min),ae(e.sec),ag(f.min),ai(f.sec),aa(a.id),aE(null)},className:"text-[11px] text-indigo-600 hover:text-indigo-800 underline",children:"Edit start/end"})}),e&&null!==aY&&aY<=10&&(0,d.jsx)("div",{className:"text-4xl font-extrabold text-red-600 animate-pulse",children:Math.ceil(aY)}),l&&(0,d.jsxs)("div",{className:"mt-3",children:[(0,d.jsx)("div",{className:"text-[11px] font-semibold text-gray-600 mb-1",children:"Grid (compact)"}),bb(j[a.id]||[])]}),l&&(0,d.jsxs)("div",{className:"mt-3",children:[(0,d.jsx)("div",{className:"text-[11px] font-semibold text-gray-600 mb-1",children:"Notes"}),(0,d.jsx)("textarea",{value:H[a8(a.id)]??F[a8(a.id)]??"",onChange:b=>I(c=>({...c,[a8(a.id)]:b.target.value})),onBlur:()=>a9(a.id),rows:2,placeholder:"Add notes for this part...",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsxs)("div",{className:"mt-1 flex items-center gap-2",children:[(0,d.jsx)("button",{onClick:()=>a9(a.id),className:"px-2 py-0.5 bg-gray-900 text-white rounded text-[11px]",disabled:J[a8(a.id)],children:J[a8(a.id)]?"Saving...":"Save note"}),(0,d.jsx)("span",{className:"text-[10px] text-gray-400",children:"Auto-saves on blur"})]})]}),(0,d.jsx)("div",{className:"text-base text-gray-600 mt-1",children:0===(j[a.id]||[]).length?"No positions":(j[a.id]||[]).map((b,c)=>(0,d.jsxs)("span",{children:[c>0?", ":"",(0,d.jsx)("span",{className:b.student_name===D?"font-bold text-emerald-600":"",children:b.student_name})]},`${a.id}-pos-${b.student_id}-${c}`))}),(q[a.id]||[]).length>0&&(0,d.jsx)("div",{className:"mt-3 space-y-3 text-sm text-gray-700",children:(q[a.id]||[]).map((b,c)=>{let e=s[b.id]||[],f="number"==typeof b.timepoint_seconds?b.timepoint_seconds:null!==b.timepoint_seconds&&void 0!==b.timepoint_seconds?parseFloat(String(b.timepoint_seconds)):NaN,g="number"==typeof b.timepoint_end_seconds?b.timepoint_end_seconds:null!==b.timepoint_end_seconds&&void 0!==b.timepoint_end_seconds?parseFloat(String(b.timepoint_end_seconds)):NaN,h=Number.isFinite(f);return(0,d.jsxs)("div",{className:"",children:[h?(0,d.jsxs)("button",{type:"button",onClick:()=>a1(f,!0),className:"font-semibold text-gray-900 text-left",children:[c+1,". ",b.title]}):(0,d.jsxs)("div",{className:"font-semibold text-gray-900",children:[c+1,". ",b.title]}),(0,d.jsxs)("div",{className:"text-gray-600",children:["Assigned:"," ",0===e.length?"—":e.map((a,c)=>{let e=a.start_side||"OS",f=a.end_side||e,g=e===f?e:`${e}→${f}`;return(0,d.jsxs)("span",{children:[c>0?", ":"",(0,d.jsx)("span",{className:a.student_name===D?"font-bold text-emerald-600":"",children:a.student_name})," ",(0,d.jsxs)("span",{className:"font-semibold",children:["(",g,")"]})]},`${b.id}-assigned-${c}`)})]}),(0,d.jsxs)("div",{className:"text-gray-500",children:["Notes: ",b.description?b.description:"—"]}),F[a8(a.id,b.id)]&&(0,d.jsxs)("div",{className:"text-[10px] text-gray-500 mt-1",children:["Note: ",F[a8(a.id,b.id)]]}),(0,d.jsxs)("div",{className:"mt-1",children:[(0,d.jsx)("textarea",{value:H[a8(a.id,b.id)]??F[a8(a.id,b.id)]??"",onChange:c=>I(d=>({...d,[a8(a.id,b.id)]:c.target.value})),onBlur:()=>a9(a.id,b.id),rows:2,placeholder:"Add rehearsal notes...",className:"w-full px-2 py-1 border border-gray-200 rounded text-[11px]"}),(0,d.jsx)("div",{className:"mt-1 flex items-center gap-2",children:(0,d.jsx)("button",{onClick:()=>a9(a.id,b.id),className:"px-2 py-0.5 bg-gray-900 text-white rounded text-[10px]",disabled:J[a8(a.id,b.id)],children:J[a8(a.id,b.id)]?"Saving...":"Save note"})})]}),(0,d.jsxs)("div",{className:"text-[11px] text-gray-500",children:["Time: ",Number.isFinite(f)?aZ(f):"--:--"," / ",Number.isFinite(g)?aZ(g):"--:--"]}),h&&(0,d.jsxs)("button",{onClick:b=>{b.stopPropagation(),a7(f,a.id)},className:"mt-1 text-[11px] text-indigo-600 hover:text-indigo-800 underline",children:["Jump to ",b.title," subpart"]}),x[b.id]&&(0,d.jsxs)("div",{className:"mt-2",children:[(0,d.jsx)("button",{type:"button",onClick:async a=>{if(a.stopPropagation(),A(a=>({...a,[b.id]:!a[b.id]})),!B[b.id])try{let a=await fetch(`/api/subpart-positions?subpartId=${b.id}`);if(a.ok){let c=(await a.json()||[]).map(a=>({student_id:a.student_id,student_name:a.student_name||"Unknown",x:a.x,y:a.y}));C(a=>({...a,[b.id]:c}))}}catch{C(a=>({...a,[b.id]:[]}))}},className:"text-[11px] text-indigo-600 hover:text-indigo-800 underline",children:z[b.id]?"Hide grid":"Show grid"}),z[b.id]&&(0,d.jsx)("div",{className:"mt-1",children:bb(B[b.id]||[])})]})]},b.id)})}),P===a.id&&null!==L&&(0,d.jsx)("div",{className:"mt-2 text-center text-3xl font-extrabold text-red-600 animate-pulse",children:L})]})]},a.id)})})]}),(0,d.jsxs)("div",{className:"space-y-6",children:[(0,d.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-[minmax(260px,0.6fr)_minmax(420px,1fr)] gap-6 items-start",children:[(0,d.jsxs)("div",{className:"space-y-3",children:[bc("Current",aW,!1,34),bd(aW,!1)]}),(0,d.jsxs)("div",{className:"space-y-3",children:[bc("Next",aX,!0,80),bd(aX,!0)]})]}),(0,d.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,d.jsx)("div",{className:"min-h-[180px]",children:ba(aW)}),(0,d.jsx)("div",{className:"min-h-[180px]",children:ba(aX)})]}),(0,d.jsx)("div",{className:"max-w-xl space-y-3",children:(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-3 rounded-lg border-2 border-blue-600 bg-blue-50 p-3",children:[(0,d.jsx)("div",{className:"text-xs font-extrabold uppercase tracking-widest text-blue-700",children:"Filter by person"}),(0,d.jsxs)("select",{value:D,onChange:a=>E(a.target.value),className:"min-w-[160px] px-2 py-1 border border-blue-200 rounded text-sm bg-white",children:[(0,d.jsx)("option",{value:"",children:"All"}),a4.map(a=>(0,d.jsx)("option",{value:a,children:a},a))]}),(0,d.jsxs)("div",{className:"ml-auto flex items-center gap-3 text-xs font-semibold text-blue-700",children:[R&&(0,d.jsxs)("div",{children:["Call Time: ",(0,d.jsx)("span",{className:"font-bold",children:R})]}),(0,d.jsxs)("label",{className:"flex items-center gap-2",children:[(0,d.jsx)("input",{type:"checkbox",checked:n,onChange:a=>o(a.target.checked),className:"h-4 w-4"}),"Ring at T-10"]})]})]})})]})]})]})})})}var x=c(88281);function y({partId:a}){let[b,c]=(0,e.useState)([]),[f,g]=(0,e.useState)(!1),[h,i]=(0,e.useState)(""),[j,k]=(0,e.useState)(""),[l,m]=(0,e.useState)(""),[n,o]=(0,e.useState)(""),[p,q]=(0,e.useState)(""),[r,s]=(0,e.useState)(""),[t,u]=(0,e.useState)(null),[v,w]=(0,e.useState)(""),[x,y]=(0,e.useState)(""),[z,A]=(0,e.useState)(""),[B,C]=(0,e.useState)(""),[D,E]=(0,e.useState)(""),[F,G]=(0,e.useState)(""),H=a=>{if(null==a||""===a)return{min:"",sec:""};let b=Number(a);if(!Number.isFinite(b))return{min:"",sec:""};let c=Math.floor(b/60),d=Math.floor(b%60);return{min:String(c),sec:String(d)}},I=(a,b)=>{if(!a&&!b)return null;let c=a?parseInt(a,10):0,d=b?parseFloat(b):0;return Number.isNaN(c)||Number.isNaN(d)?null:60*c+d},J=a=>{if(null==a||""===a)return"--:--";let b=Number(a);if(!Number.isFinite(b))return"--:--";let c=Math.floor(b/60),d=Math.floor(b%60);return`${c}:${d.toString().padStart(2,"0")}`},K=(0,e.useCallback)(async()=>{if(!a)return void c([]);try{g(!0);let b=await fetch(`/api/subparts?partId=${a}`);if(!b.ok)throw Error("Failed to fetch subparts");let d=await b.json();c(d||[])}catch(a){console.error("Error fetching subparts:",a)}finally{g(!1)}},[a]);return a?(0,d.jsxs)("div",{className:"border-t border-gray-200 pt-4",children:[(0,d.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,d.jsx)("h3",{className:"font-semibold text-gray-900",children:"Subparts / Solos"}),(0,d.jsx)("button",{onClick:K,className:"text-xs text-blue-600 hover:text-blue-800",children:"Refresh"})]}),f&&(0,d.jsx)("div",{className:"text-xs text-gray-500 mb-2",children:"Loading..."}),0===b.length&&!f&&(0,d.jsx)("div",{className:"text-xs text-gray-500 mb-2",children:"No subparts yet."}),(0,d.jsx)("div",{className:"space-y-2",children:b.map(b=>(0,d.jsx)("div",{className:"border border-gray-200 rounded p-2 text-xs",children:t===b.id?(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("input",{type:"text",value:v,onChange:a=>w(a.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("textarea",{value:x,onChange:a=>y(a.target.value),rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:z,onChange:a=>A(a.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:B,onChange:a=>C(a.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:D,onChange:a=>E(a.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:F,onChange:a=>G(a.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{onClick:async()=>{try{let d=await fetch(`/api/subparts/${b.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:v,description:x,timepoint_seconds:I(z,B),timepoint_end_seconds:I(D,F)})});if(!d.ok)throw Error("Failed to update subpart");let e=await d.json();e&&(c(a=>a.map(a=>a.id===b.id?{...a,...e}:a)),window.dispatchEvent(new CustomEvent("subparts-updated",{detail:{partId:a}}))),u(null)}catch(a){alert(a instanceof Error?a.message:"Failed to update subpart")}},className:"px-2 py-1 bg-green-600 text-white rounded text-xs",children:"Save"}),(0,d.jsx)("button",{onClick:()=>u(null),className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]})]}):(0,d.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"font-medium text-gray-800",children:b.title}),b.mode&&(0,d.jsxs)("div",{className:"text-[10px] text-gray-400",children:["Mode: ",b.mode]}),b.description&&(0,d.jsx)("div",{className:"text-gray-600",children:b.description}),null!==b.timepoint_seconds||null!==b.timepoint_end_seconds?(0,d.jsxs)("div",{className:"text-[10px] text-gray-400",children:["Time: ",J(b.timepoint_seconds)," - ",J(b.timepoint_end_seconds)]}):(0,d.jsx)("div",{className:"text-[10px] text-gray-400",children:"Time: --:-- - --:--"})]}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("button",{onClick:()=>{u(b.id),w(b.title),y(b.description||"");let a=H(b.timepoint_seconds),c=H(b.timepoint_end_seconds);A(a.min),C(a.sec),E(c.min),G(c.sec)},className:"text-[10px] text-blue-600 hover:text-blue-800",children:"Edit"}),(0,d.jsx)("button",{onClick:async()=>{if(window.confirm("Delete this subpart?"))try{if(!(await fetch(`/api/subparts/${b.id}`,{method:"DELETE"})).ok)throw Error("Failed to delete subpart");await K()}catch(a){alert(a instanceof Error?a.message:"Failed to delete subpart")}},className:"text-[10px] text-red-600 hover:text-red-800",children:"Delete"})]})]})},b.id))}),(0,d.jsxs)("div",{className:"mt-3 border-t border-gray-200 pt-3",children:[(0,d.jsx)("div",{className:"font-semibold text-gray-700 text-xs mb-2",children:"Add Subpart"}),(0,d.jsx)("input",{type:"text",value:h,onChange:a=>i(a.target.value),placeholder:"Subpart title",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2"}),(0,d.jsx)("textarea",{value:j,onChange:a=>k(a.target.value),placeholder:"Description",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:l,onChange:a=>m(a.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:n,onChange:a=>o(a.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:p,onChange:a=>q(a.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:r,onChange:a=>s(a.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,d.jsx)("button",{onClick:async()=>{let b=h.trim(),c=j.trim();if(b)try{if(!(await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:a,title:b,description:c||null,mode:"position",timepoint_seconds:I(l,n),timepoint_end_seconds:I(p,r)})})).ok)throw Error("Failed to create subpart");i(""),k(""),m(""),o(""),q(""),s(""),await K()}catch(a){alert(a instanceof Error?a.message:"Failed to create subpart")}},className:"px-2 py-1 bg-blue-600 text-white rounded text-xs",children:"Add Subpart"})]})]}):null}var z=c(80303),A=c(58320);function B(a){let b=Math.max(0,Math.floor(a)),c=Math.floor(b/60);return`${c}:${(b%60).toString().padStart(2,"0")}`}function C(a){if(!a)return null;let b=a.trim();if(!b)return null;if(/^\d+(\.\d+)?$/.test(b))return Math.max(0,parseFloat(b));let c=b.split(":");if(2===c.length){let a=parseInt(c[0],10),b=parseFloat(c[1]);return Number.isNaN(a)||Number.isNaN(b)?null:Math.max(0,60*a+b)}return null}function D(){return Math.random().toString(36).slice(2,10)+Date.now().toString(36)}function E({performanceId:a,parts:b,musicUrl:c,performanceTitle:f,onPartsUpdated:g}){let[h,i]=(0,e.useState)([]),[j,k]=(0,e.useState)(null),[m,n]=(0,e.useState)(0),[o,p]=(0,e.useState)({}),[q,r]=(0,e.useState)({}),[s,t]=(0,e.useState)({}),[v,w]=(0,e.useState)(!1),[x,y]=(0,e.useState)("New Marking Session"),[z,A]=(0,e.useState)(!1),[E,F]=(0,e.useState)([]),[G,H]=(0,e.useState)(""),[I,J]=(0,e.useState)(!1),[K,L]=(0,e.useState)({}),[M,N]=(0,e.useState)(null),O=(0,e.useRef)(null),P=(0,e.useRef)(null),Q=(0,e.useRef)(null),[R,S]=(0,e.useState)(180),[T,U]=(0,e.useState)({}),[V,W]=(0,e.useState)({}),[X,Y]=(0,e.useState)(null),Z=(0,e.useRef)(null),[$,_]=(0,e.useState)(null),[aa,ab]=(0,e.useState)({}),[ac,ad]=(0,e.useState)({}),[ae,af]=(0,e.useState)({}),[ag,ah]=(0,e.useState)({}),[ai,aj]=(0,e.useState)({}),[ak,al]=(0,e.useState)(null),[am,an]=(0,e.useState)(1),[ao,ap]=(0,e.useState)({}),[aq,ar]=(0,e.useState)({}),[as,at]=(0,e.useState)({}),[au,av]=(0,e.useState)(""),[aw,ax]=(0,e.useState)({}),[ay,az]=(0,e.useState)(null),aA=(0,e.useMemo)(()=>{let a=[];b.forEach(b=>{let c=T[b.id],d=c?.start??b.timepoint_seconds??null,e=c?.end??b.timepoint_end_seconds??null;null!==d&&a.push(d),null!==e&&a.push(e),null!==d&&null===e&&a.push(d+10)}),Object.values(q).flat().forEach(b=>{let c=V[b.id],d=c?.start??b.timepoint_seconds??null,e=c?.end??b.timepoint_end_seconds??null;null!==d&&a.push(d),null!==e&&a.push(e),null!==d&&null===e&&a.push(d+10)});let c=a.length?Math.max(...a):0;return M&&Number.isFinite(M)?Math.max(M,c,10):Math.max(R,c,10)},[M,R,b,q,T,V]),aB=(0,e.useMemo)(()=>{let a={};return Object.values(o).forEach(b=>{"string"==typeof b?a[b]=(a[b]||0)+1:b?.markId&&(a[b.markId]=(a[b.markId]||0)+1)}),a},[o]),aC=(0,e.useCallback)(a=>{let b=T[a.id];return{start:b?.start??a.timepoint_seconds??null,end:b?.end??a.timepoint_end_seconds??null}},[T]),aD=(a,b,c)=>{U(d=>({...d,[a]:{start:b,end:c}}))},aE=(a,b,c)=>{W(d=>({...d,[a]:{start:b,end:c}}))},aF=(0,e.useCallback)(async(a,c)=>{let d=b.find(b=>b.id===a);if(!d||(d.description||"")===c)return;let e=await fetch(`/api/parts/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:c})});if(!e.ok)return;let f=await e.json();g(b.map(b=>b.id===a?{...b,description:f.description||""}:b))},[g,b]),aG=(0,e.useCallback)(async(a,b)=>{let c=Object.values(q).flat().find(b=>b.id===a);if(!c||(c.description||"")===b)return;let d=await fetch(`/api/subparts/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:b})});if(!d.ok)return;let e=await d.json();r(b=>{let d={...b};return d[c.part_id]=(d[c.part_id]||[]).map(b=>b.id===a?{...b,description:e.description??""}:b),d})},[q]),aH=async(a,b,c)=>{let d=a.timepoint_seconds??null,e=a.timepoint_end_seconds??null;aE(a.id,b,c),r(d=>{let e={...d},f=(e[a.part_id]||[]).map(d=>d.id===a.id?{...d,timepoint_seconds:b,timepoint_end_seconds:c}:d);return e[a.part_id]=f.sort((a,b)=>{let c="number"==typeof a.timepoint_seconds?a.timepoint_seconds:1/0,d="number"==typeof b.timepoint_seconds?b.timepoint_seconds:1/0;return c!==d?c-d:(a.order??0)-(b.order??0)}),e});try{let d=await fetch(`/api/subparts/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({timepoint_seconds:b,timepoint_end_seconds:c})});if(!d.ok)throw Error("Failed to update timepoint");let e=await d.json();e&&r(b=>{let c={...b};return c[a.part_id]=(c[a.part_id]||[]).map(b=>b.id===a.id?{...b,...e}:b),c}),window.dispatchEvent(new CustomEvent("subparts-updated",{detail:{partId:a.part_id}}))}catch(b){aE(a.id,d,e),r(b=>{let c={...b},f=(c[a.part_id]||[]).map(b=>b.id===a.id?{...b,timepoint_seconds:d,timepoint_end_seconds:e}:b);return c[a.part_id]=f,c}),console.error(b),alert("Failed to update timepoints")}},aI=a=>{let c=V[a.id],d=b.find(b=>b.id===a.part_id),e=d?aC(d):{start:null,end:null};return{start:c?.start??a.timepoint_seconds??e.start??null,end:c?.end??a.timepoint_end_seconds??e.end??null}},aJ=a=>{for(let b of h){let c=b.marks.find(b=>b.id===a);if(c)return c.time}return null},aK=(0,e.useMemo)(()=>{let a=["bg-amber-50 border-amber-300 text-amber-950","bg-emerald-50 border-emerald-300 text-emerald-950","bg-sky-50 border-sky-300 text-sky-950","bg-rose-50 border-rose-300 text-rose-950","bg-lime-50 border-lime-300 text-lime-950","bg-fuchsia-50 border-fuchsia-300 text-fuchsia-950","bg-orange-50 border-orange-300 text-orange-950","bg-teal-50 border-teal-300 text-teal-950"],c={};return b.forEach((b,d)=>{c[b.id]=a[d%a.length]}),c},[b]),aL=async(a,b)=>{await Promise.all(b.map((a,b)=>fetch(`/api/subparts/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:b+1})})))},aM=(a,b,c)=>{r(d=>{let e={...d},f=[...e[a]||[]],g=f.findIndex(a=>a.id===b);if(-1===g)return d;let h="up"===c?g-1:g+1;if(h<0||h>=f.length)return d;let[i]=f.splice(g,1);return f.splice(h,0,i),e[a]=f,aL(a,f),e})},aN=(0,e.useMemo)(()=>{let a=[],c=[];b.forEach(b=>{let{start:d,end:e}=aC(b);if(null===d)return void c.push(b);a.push({id:b.id,name:b.name,start:d,end:e??d+10,missingEnd:null===e})}),a.sort((a,b)=>a.start-b.start);let d=[];a.forEach(a=>{let c=b.find(b=>b.id===a.id),e=ao[a.id]??c?.timeline_row??void 0;if(void 0!==e){for(;d.length<=e;)d.push({id:D(),items:[]});d[e].items.push(a);return}let f=!1;for(let b of d){let c=b.items[b.items.length-1];if(!c||a.start>=c.end){b.items.push(a),f=!0;break}}f||d.push({id:D(),items:[a]})}),d.forEach(a=>a.items.sort((a,b)=>a.start-b.start));let e=d.length;if(am>d.length)for(let a=d.length;a<am;a+=1)d.push({id:D(),items:[],manual:!0});return{rows:d,unassigned:c,autoRowCount:e}},[b,am,ao,aC]),aO=(0,e.useMemo)(()=>[...b].sort((a,b)=>{let c=aC(a).start,d=aC(b).start;return"number"==typeof c&&"number"==typeof d?c!==d?c-d:(a.order||0)-(b.order||0):"number"==typeof c?-1:"number"==typeof d?1:(a.order||0)-(b.order||0)}),[b,aC]),aP=a=>{let b=o[a];if(!b)return null;if("string"==typeof b){for(let a of h){let c=a.marks.find(a=>a.id===b);if(c)return c.time}return null}return b.time??null},aQ=(a,b)=>{let[c,d,e]=a.split(":"),f=aR(c,d,e),g=(a=>{if(!a)return null;if("string"==typeof a){for(let b of h){let c=b.marks.find(b=>b.id===a);if(c)return c.time}return null}return a.time??null})(b)??f,i=null!==g?B(g):"Unassigned",j=new Date().toLocaleString(void 0,{timeZone:l.GI,timeZoneName:"short"});ax(c=>({...c,[a]:[{prev:b,label:i,at:j},...c[a]||[]].slice(0,6)}))},aR=(a,c,d)=>{if("part"===a){let a=b.find(a=>a.id===c);return a?"start"===d?a.timepoint_seconds??null:a.timepoint_end_seconds??null:null}let e=Object.values(q).flat().find(a=>a.id===c);return e?"start"===d?e.timepoint_seconds??null:e.timepoint_end_seconds??null:null},aS=a=>{p(b=>{aQ(a,b[a]);let c={...b};return delete c[a],c})},aT=(a,b,c)=>{let e=`${a}:${b}:${c}`,f=o[e],g="string"==typeof f?f:f?.markId,i=aP(e),j=aR(a,b,c),k=null!==i?i:j,l=aw[e]||[];return(0,d.jsxs)("div",{className:`relative border border-dashed rounded px-2 py-1 text-xs flex flex-wrap items-center gap-2 ${g?"border-emerald-400 bg-emerald-50":"border-gray-300 bg-white"}`,onDragOver:a=>a.preventDefault(),onDrop:a=>{let b=a.dataTransfer.getData("markId");b&&((a,b)=>{let[c,d,e]=a.split(":"),f=h.flatMap(a=>a.marks).find(a=>a.id===b)?.time;if(void 0===f)return;let g="start"===e?"end":"start",i=aP(`${c}:${d}:${g}`),j=aR(c,d,g),k=i??j;return"end"===e&&null!==k&&f<k?alert("End time cannot be before start time."):"start"===e&&null!==k&&f>k?alert("Start time cannot be after end time."):p(c=>(aQ(a,c[a]),{...c,[a]:{markId:b,time:f}}))})(e,b)},children:[(0,d.jsx)("span",{className:"text-gray-500 uppercase",children:c}),(0,d.jsx)("span",{className:"font-semibold text-gray-800",children:null!==k?B(k):"--:--"}),(0,d.jsx)("input",{value:ai[e]??"",onChange:a=>aj(b=>({...b,[e]:a.target.value})),onKeyDown:a=>{if("Enter"!==a.key)return;let b=C(ai[e]??"");null!==b&&(p(a=>({...a,[e]:{time:b}})),aj(a=>({...a,[e]:""})))},placeholder:"mm:ss",className:"px-1 py-0.5 border border-gray-200 rounded text-[10px] w-14"}),g&&(0,d.jsx)("button",{type:"button",onClick:a=>{a.stopPropagation(),confirm("Remove this chip assignment?")&&aS(e)},className:"px-2 py-0.5 rounded-full text-[10px] bg-emerald-600 text-white",title:"Remove assignment",children:"Chip"}),(0,d.jsxs)("div",{className:"ml-auto flex items-center gap-2",children:[l.length>0&&(0,d.jsx)("button",{onClick:()=>(a=>{let b=aw[a];if(!b||0===b.length)return;let[c,...d]=b;ax(b=>({...b,[a]:d})),p(b=>{let d={...b};return c.prev?d[a]=c.prev:delete d[a],d})})(e),className:"text-[10px] text-gray-700 hover:text-gray-900",title:"Undo last change",children:"Undo"}),(0,d.jsx)("button",{onClick:()=>az(a=>a===e?null:e),className:"text-[10px] text-gray-500 hover:text-gray-700",title:"History",children:"Log"}),g&&(0,d.jsx)("button",{onClick:()=>aS(e),className:"text-red-600 hover:text-red-800",title:"Remove",children:"x"})]}),ay===e&&(0,d.jsxs)("div",{className:"absolute right-0 top-full mt-1 w-44 rounded border border-gray-200 bg-white shadow-lg p-2 text-[10px] text-gray-600 z-20",children:[0===l.length&&(0,d.jsx)("div",{children:"No history yet"}),l.map((a,b)=>(0,d.jsxs)("div",{className:"border-b border-gray-100 pb-1 mb-1 last:border-0 last:pb-0 last:mb-0",children:[(0,d.jsx)("div",{className:"font-semibold text-gray-800",children:a.label}),(0,d.jsx)("div",{children:a.at})]},`${a.at}-${b}`))]})]})},aU=async()=>{let b=await fetch("/api/marking-sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:a,title:x||"Marking Session",rows:h,assignments:o})});if(b.ok){let a=await b.json();F(b=>[a,...b])}},aV=async()=>{w(!0);try{let a={},c={};Object.entries(o).forEach(([b,d])=>{let[e,f,g]=b.split(":");"string"==typeof d||d?.markId;let i="string"==typeof d?h.flatMap(a=>a.marks).find(a=>a.id===d)?.time:d?.time;null!=i&&("part"===e?(a[f]=a[f]||{},a[f]["start"===g?"timepoint_seconds":"timepoint_end_seconds"]=i):(c[f]=c[f]||{},c[f]["start"===g?"timepoint_seconds":"timepoint_end_seconds"]=i))});let d=[],e=[];await Promise.all(Object.entries(a).map(async([a,b])=>{let c=await fetch(`/api/parts/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(c.ok){let a=await c.json();d.push(a)}})),await Promise.all(Object.entries(c).map(async([a,b])=>{let c=await fetch(`/api/subparts/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(c.ok){let a=await c.json();a&&e.push(a)}})),d.length>0&&g(b.map(a=>d.find(b=>b.id===a.id)||a)),e.length>0&&r(a=>{let b={...a};return e.forEach(a=>{b[a.part_id]=(b[a.part_id]||[]).map(b=>b.id===a.id?{...b,...a}:b)}),b})}finally{w(!1)}},aW=async()=>{w(!0);try{let a={},c={};b.forEach(b=>{let{start:c,end:d}=aC(b),e=ao[b.id]??b.timeline_row??null;null!==c||null!==e?a[b.id]={timepoint_seconds:c,timepoint_end_seconds:d??null,timeline_row:e}:null!==b.timeline_row&&void 0!==b.timeline_row&&(a[b.id]={timeline_row:null})}),Object.values(q).flat().forEach(a=>{let b=V[a.id],d=b?.start??a.timepoint_seconds??null,e=b?.end??a.timepoint_end_seconds??null;null!==d&&(c[a.id]={timepoint_seconds:d,timepoint_end_seconds:e??null})});let d=[];await Promise.all(Object.entries(a).map(async([a,b])=>{let c=await fetch(`/api/parts/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(c.ok){let a=await c.json();d.push(a)}})),await Promise.all(Object.entries(c).map(async([a,b])=>{await fetch(`/api/subparts/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)})})),d.length>0&&g(b.map(a=>d.find(b=>b.id===a.id)||a))}finally{w(!1)}};return(0,d.jsxs)("div",{className:"space-y-6",children:[(0,d.jsx)("div",{className:"w-full -mx-4 px-4",children:(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4 w-full",children:[(0,d.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,d.jsx)("div",{className:"text-lg font-semibold text-gray-900",children:"Timeline"}),(0,d.jsxs)("div",{className:"ml-auto flex items-center gap-2",children:[!M&&(0,d.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[(0,d.jsx)("span",{children:"Timeline length (sec)"}),(0,d.jsx)("input",{type:"number",min:10,value:R,onChange:a=>S(parseInt(a.target.value||"0",10)||0),className:"w-20 px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,d.jsx)("button",{onClick:()=>an(a=>a+1),className:"px-3 py-1 border border-gray-300 rounded text-xs text-gray-700 hover:bg-gray-50",children:"Add Row"}),(0,d.jsx)("button",{onClick:aW,disabled:v,className:"px-3 py-1 bg-indigo-600 text-white rounded text-sm disabled:bg-gray-400",children:v?"Saving...":"Save Timeline"})]})]}),(0,d.jsx)("div",{className:"text-xs text-gray-500",children:"Drag parts to move them. Drop chips or type times to set Start/End."}),(0,d.jsxs)("div",{className:"mt-3 space-y-4",children:[aN.rows.map((a,c)=>(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsxs)("div",{className:"flex items-center gap-2 text-xs font-semibold text-gray-600",children:[(0,d.jsxs)("span",{children:["Row ",c+1]}),c>=aN.autoRowCount&&0===a.items.length&&(0,d.jsx)("button",{onClick:()=>an(a=>Math.max(1,a-1)),className:"ml-auto text-[11px] text-gray-500 hover:text-gray-800",children:"Remove row"})]}),(0,d.jsx)("div",{ref:0===c?Q:void 0,className:"relative h-36 border border-gray-200 rounded bg-gray-50 overflow-visible",onDragOver:a=>a.preventDefault(),onDrop:a=>{let d=a.dataTransfer.getData("partId");if(!d)return;let e=a.currentTarget.getBoundingClientRect(),f=Math.max(0,Math.min(aA-10,Math.round((a.clientX-e.left)/e.width*aA))),g=b.find(a=>a.id===d),{start:h,end:i}=g?aC(g):{start:null,end:null};aD(d,f,f+Math.max(1,null!==h&&null!==i?i-h:10)),ap(a=>({...a,[d]:c}))},children:a.items.map(a=>{let c=a.start/aA*100,e=(a.end-a.start)/aA*100,f=b.find(b=>b.id===a.id),g=f&&q[f.id]||[],h=[...g].sort((a,b)=>{let c=aI(a).start??1/0,d=aI(b).start??1/0;return c!==d?c-d:a.title.localeCompare(b.title)}),i=aK[a.id]||"bg-white border-gray-300 text-gray-900",{start:j,end:k}=f?aC(f):{start:null,end:null};return(0,d.jsxs)("div",{className:`absolute top-2 h-[120px] rounded border px-3 py-2 shadow-sm cursor-move ${i} ${a.missingEnd?"border-blue-400":""}`,style:{left:`${c}%`,width:`${Math.max(4,e)}%`},onMouseDown:b=>{if(["INPUT","TEXTAREA","BUTTON"].includes(b.target.tagName)||!Q.current)return;let c=Q.current.getBoundingClientRect(),d=(b.clientX-c.left)/c.width*aA-a.start;Z.current={partId:a.id,duration:a.end-a.start,offsetSec:d},Y(a.id),_({partId:a.id,time:a.start})},children:[$?.partId===a.id&&(0,d.jsx)("div",{className:"absolute -top-6 left-0 px-2 py-0.5 rounded bg-gray-900 text-white text-[10px]",children:function(a){let b=Math.max(0,Math.floor(a)),c=Math.floor(b/3600),d=Math.floor(b%3600/60),e=b%60;return c>0?`${c}:${d.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`:`${d}:${e.toString().padStart(2,"0")}`}($.time)}),(0,d.jsx)("div",{className:"text-sm font-semibold truncate",children:a.name}),(0,d.jsxs)("div",{className:"mt-2 grid grid-cols-2 gap-1 text-[11px]",children:[(0,d.jsxs)("div",{className:`border border-dashed rounded px-1 py-0.5 ${a.missingEnd?"border-blue-400 bg-blue-50":"border-gray-300 bg-white"}`,onDragOver:a=>a.preventDefault(),onDrop:b=>{let c=b.dataTransfer.getData("markId");if(!c)return;let d=aJ(c);if(null===d)return;let e=null!==k&&d>k?d:k;aD(a.id,d,e)},children:["Start:",(0,d.jsx)("input",{className:"ml-1 w-12 bg-transparent",value:aa[a.id]??(null!==j?B(j):""),onChange:b=>{let c=b.target.value;ab(b=>({...b,[a.id]:c}));let d=C(c);null!==d&&(null!==k&&d>k||aD(a.id,d,k))},onKeyDown:b=>{if("Enter"!==b.key)return;let c=C(aa[a.id]??"");null!==c&&(null!==k&&c>k||(aD(a.id,c,k),ab(b=>({...b,[a.id]:""}))))}})]}),(0,d.jsxs)("div",{className:`border border-dashed rounded px-1 py-0.5 ${a.missingEnd?"border-blue-400 bg-blue-50":"border-gray-300 bg-white"}`,onDragOver:a=>a.preventDefault(),onDrop:b=>{let c=b.dataTransfer.getData("markId");if(!c)return;let d=aJ(c);null!==d&&(null!==j&&d<j||aD(a.id,j,d))},children:["End:",(0,d.jsx)("input",{className:"ml-1 w-12 bg-transparent",value:ac[a.id]??(null!==k?B(k):""),onChange:b=>{let c=b.target.value;ad(b=>({...b,[a.id]:c}));let d=C(c);null!==d&&(null!==j&&d<j||aD(a.id,j,d))},onKeyDown:b=>{if("Enter"!==b.key)return;let c=C(ac[a.id]??"");null!==c&&(null!==j&&c<j||(aD(a.id,j,c),ad(b=>({...b,[a.id]:""}))))}})]})]}),g.length>0&&(0,d.jsxs)("div",{className:"mt-2",children:[(0,d.jsx)("div",{className:"flex flex-wrap gap-1",children:h.map(a=>(0,d.jsx)("span",{className:"px-2 py-0.5 rounded-full bg-white/80 text-[10px] border border-gray-200",title:a.title,children:a.title},a.id))}),(0,d.jsx)("button",{onClick:()=>al(b=>b===a.id?null:a.id),className:"mt-2 text-[11px] text-blue-700 hover:text-blue-900 underline",children:ak===a.id?"Hide subparts":"Subparts"})]}),ak===a.id&&(0,d.jsxs)("div",{className:"absolute left-0 top-full mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg p-3 z-20 relative",children:[(0,d.jsx)("button",{onClick:()=>al(null),className:"absolute top-2 right-2 w-6 h-6 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 flex items-center justify-center text-sm","aria-label":"Close subparts",children:"\xd7"}),(0,d.jsxs)("div",{className:"text-xs font-semibold text-gray-800 mb-2 pr-6",children:["Subparts for ",a.name]}),(0,d.jsx)("div",{className:"space-y-2",children:h.map(b=>{let c=aI(b);return(0,d.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[(0,d.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,d.jsx)("div",{className:"font-semibold text-gray-800 truncate",children:b.title}),(0,d.jsxs)("div",{className:"mt-1 flex items-center gap-1",children:[(0,d.jsx)("input",{className:"w-12 bg-white border border-gray-200 rounded px-1",value:ae[b.id]??(null!==c.start?B(c.start):""),onChange:a=>af(c=>({...c,[b.id]:a.target.value})),onKeyDown:a=>{if("Enter"!==a.key)return;let d=C(ae[b.id]??"");null!==d&&(null!==c.end&&d>c.end||(aH(b,d,c.end),af(a=>({...a,[b.id]:""}))))}}),(0,d.jsx)("input",{className:"w-12 bg-white border border-gray-200 rounded px-1",value:ag[b.id]??(null!==c.end?B(c.end):""),onChange:a=>ah(c=>({...c,[b.id]:a.target.value})),onKeyDown:a=>{if("Enter"!==a.key)return;let d=C(ag[b.id]??"");null!==d&&(null!==c.start&&d<c.start||(aH(b,c.start,d),ah(a=>({...a,[b.id]:""}))))}})]})]}),(0,d.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,d.jsx)("button",{onClick:()=>aM(a.id,b.id,"up"),className:"px-2 py-0.5 border border-gray-200 rounded text-[10px]",children:"Up"}),(0,d.jsx)("button",{onClick:()=>aM(a.id,b.id,"down"),className:"px-2 py-0.5 border border-gray-200 rounded text-[10px]",children:"Down"})]})]},b.id)})})]})]},a.id)})})]},a.id)),(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("div",{className:"text-xs font-semibold text-gray-600",children:"Unassigned"}),(0,d.jsxs)("div",{className:"flex flex-wrap gap-2",children:[0===aN.unassigned.length&&(0,d.jsx)("div",{className:"text-xs text-gray-500",children:"All parts assigned"}),aN.unassigned.map(a=>(0,d.jsx)("div",{draggable:!0,onDragStart:b=>b.dataTransfer.setData("partId",a.id),className:`px-2 py-1 rounded text-xs cursor-move ${aK[a.id]||"bg-gray-200 text-gray-800"}`,children:a.name},a.id))]})]})]})]})}),(0,d.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-[320px_1fr] gap-6",children:[(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,d.jsx)("div",{className:"text-xl font-bold text-gray-900 mb-2",children:"Parts & Subparts"}),(0,d.jsx)("div",{className:"text-xs text-gray-500 mb-4",children:"Drop time chips onto Start/End. Only dropped chips change timepoints when saved."}),(0,d.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,d.jsx)("input",{type:"text",value:au,onChange:a=>av(a.target.value),placeholder:"Add part",className:"flex-1 px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("button",{onClick:async()=>{let c=au.trim();if(!c)return;let d=(b?.length||0)+1,e=await fetch("/api/parts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:a,name:c,description:"",order:d})});e.ok&&(g([...b||[],await e.json()]),av(""))},className:"px-2 py-1 bg-gray-900 text-white rounded text-xs",children:"Add"})]}),(0,d.jsx)("div",{className:"max-h-[70vh] overflow-y-auto pr-2 space-y-4",children:aO.map(a=>(0,d.jsxs)("div",{className:"border border-gray-200 rounded-lg p-3",children:[(0,d.jsx)("div",{className:"font-semibold text-gray-900 mb-2",children:a.name}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[aT("part",a.id,"start"),aT("part",a.id,"end")]}),(0,d.jsx)("input",{value:aq[a.id]??a.description??"",onChange:b=>ar(c=>({...c,[a.id]:b.target.value})),onBlur:()=>aF(a.id,aq[a.id]??a.description??""),placeholder:"Add part note...",className:"w-full px-2 py-1 border border-gray-200 rounded text-xs"}),(q[a.id]||[]).length>0&&(0,d.jsx)("div",{className:"mt-2 space-y-2",children:[...q[a.id]].sort((a,b)=>{let c="number"==typeof a.timepoint_seconds?a.timepoint_seconds:1/0,d="number"==typeof b.timepoint_seconds?b.timepoint_seconds:1/0;return c!==d?c-d:(a.order??0)-(b.order??0)}).map(a=>(0,d.jsxs)("div",{className:"border border-gray-100 rounded p-2 bg-gray-50",children:[(0,d.jsx)("div",{className:"text-sm font-semibold text-gray-800",children:a.title}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2 mt-2",children:[aT("subpart",a.id,"start"),aT("subpart",a.id,"end")]}),(0,d.jsx)("input",{value:as[a.id]??a.description??"",onChange:b=>at(c=>({...c,[a.id]:b.target.value})),onBlur:()=>aG(a.id,as[a.id]??a.description??""),placeholder:"Add subpart note...",className:"w-full px-2 py-1 border border-gray-200 rounded text-xs mt-2"})]},a.id))}),(0,d.jsxs)("div",{className:"mt-3 flex items-center gap-2",children:[(0,d.jsx)("input",{type:"text",value:s[a.id]||"",onChange:b=>t(c=>({...c,[a.id]:b.target.value})),placeholder:"Add subpart",className:"flex-1 px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("button",{onClick:async()=>{let b=(s[a.id]||"").trim();if(!b)return;let c=(q[a.id]||[]).length+1,d=await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:a.id,title:b,order:c})});if(d.ok){let b=await d.json();r(c=>({...c,[a.id]:[...c[a.id]||[],b].sort((a,b)=>{let c="number"==typeof a.timepoint_seconds?a.timepoint_seconds:1/0,d="number"==typeof b.timepoint_seconds?b.timepoint_seconds:1/0;return c!==d?c-d:(a.order??0)-(b.order??0)})})),t(b=>({...b,[a.id]:""}))}},className:"px-2 py-1 bg-gray-900 text-white rounded text-xs",children:"Add"})]})]},a.id))})]}),(0,d.jsxs)("div",{className:"space-y-6",children:[(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-3",children:[(0,d.jsx)("div",{className:"text-xl font-bold text-gray-900",children:"Marking Session"}),(0,d.jsxs)("div",{className:"ml-auto flex gap-2 items-center",children:[(0,d.jsx)("input",{value:x,onChange:a=>{y(a.target.value),A(!0)},className:"px-3 py-1 border border-gray-300 rounded text-sm",placeholder:"Session title"}),(0,d.jsx)("button",{onClick:aU,className:"px-3 py-1 bg-gray-900 text-white rounded text-sm",children:"Save Session"}),(0,d.jsx)("button",{onClick:aV,disabled:v,className:"px-3 py-1 bg-blue-600 text-white rounded text-sm disabled:bg-gray-400",children:v?"Saving...":"Apply Timepoints"})]})]}),(0,d.jsx)("div",{className:"text-xs text-gray-500 mt-2",children:"Hotkeys: Space = mark time, E = new row. Works while music is playing or paused."}),(0,d.jsxs)("div",{className:"text-xs text-gray-500 mt-1",children:["Music length: ",M?B(M):"\xef\xbf\xbd"]}),(0,d.jsx)("div",{className:"mt-3 bg-gray-50 border border-dashed border-gray-300 rounded p-3 text-xs text-gray-500",children:"Waveform view: not available yet. We can add a waveform preview in a follow-up."}),(0,d.jsxs)("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[(0,d.jsxs)("select",{value:G,onChange:async a=>{let b=a.target.value;if(H(b),!b)return;let c=await fetch(`/api/marking-sessions/${b}`);if(!c.ok)return;let d=await c.json();y(d.title||"Marking Session"),A(!0);let e=(d.rows||[]).map(a=>({...a,note:a.note||""}));i(e),p(((a,b)=>{let c={};return Object.entries(b||{}).forEach(([b,d])=>{if("string"==typeof d){let e=a.flatMap(a=>a.marks).find(a=>a.id===d);e&&(c[b]={markId:d,time:e.time})}else d&&"object"==typeof d&&(c[b]=d)}),c})(e,d.assignments||{}))},className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,d.jsx)("option",{value:"",children:"Load saved session..."}),E.map(a=>(0,d.jsxs)("option",{value:a.id,children:[a.title||"Untitled"," \xef\xbf\xbd ",K[a.performance_id]||"Performance"," \xef\xbf\xbd ",new Date(a.created_at).toLocaleString(void 0,{timeZone:l.GI,timeZoneName:"short"})]},a.id))]}),(0,d.jsxs)("label",{className:"text-xs text-gray-600 flex items-center gap-2",children:[(0,d.jsx)("input",{type:"checkbox",checked:I,onChange:a=>J(a.target.checked),className:"h-4 w-4"}),"Show sessions from all performances"]}),(0,d.jsx)("button",{onClick:()=>{let a={id:D(),label:"Row 1",note:"",marks:[]};i([a]),k(a.id),p({}),H(""),A(!1)},className:"px-2 py-1 border border-gray-300 rounded text-sm",children:"New Session"})]})]}),(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,d.jsx)("div",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Mark Chips"}),(0,d.jsx)("div",{className:"space-y-4",children:h.map(a=>(0,d.jsxs)("div",{onClick:()=>k(a.id),className:`border rounded-lg p-3 cursor-pointer ${j===a.id?"border-blue-400 bg-blue-50":"border-gray-200"}`,children:[(0,d.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,d.jsx)("button",{onClick:()=>k(a.id),className:`px-2 py-1 rounded text-xs font-semibold ${j===a.id?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,children:a.label}),(0,d.jsx)("span",{className:"text-xs text-gray-500",children:"Drop chips into the empty slot to organize."}),h.length>1&&(0,d.jsx)("button",{onClick:b=>{if(b.stopPropagation(),i(b=>b.filter(b=>b.id!==a.id)),j===a.id){let b=h.find(b=>b.id!==a.id);k(b?b.id:null)}},className:"ml-auto text-xs text-red-600 hover:text-red-800",children:"Delete Row"})]}),(0,d.jsx)("input",{value:a.note||"",onChange:b=>i(c=>c.map(c=>c.id===a.id?{...c,note:b.target.value}:c)),placeholder:"Row notes...",className:"w-full px-2 py-1 border border-gray-200 rounded text-xs mb-2"}),(0,d.jsxs)("div",{className:"flex flex-wrap gap-2",children:[a.marks.map(b=>{let c=aB[b.id]||0;return(0,d.jsx)("div",{draggable:!0,onDragStart:a=>{a.dataTransfer.setData("markId",b.id)},className:`px-2 py-1 rounded text-xs cursor-move ${c>=2?"bg-gray-200 text-gray-700":1===c?"bg-yellow-200 text-yellow-900":"bg-indigo-100 text-indigo-800"}`,children:(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("span",{children:B(b.time)}),(0,d.jsx)("button",{onClick:()=>{var c,d;return c=a.id,d=b.id,void i(a=>a.map(a=>a.id===c?{...a,marks:a.marks.filter(a=>a.id!==d)}:a))},className:"text-[10px] text-gray-600 hover:text-gray-800",title:"Remove chip",children:"\xef\xbf\xbd"})]})},b.id)}),(0,d.jsx)("div",{className:"px-2 py-1 border border-dashed border-gray-300 rounded text-xs text-gray-500",onDragOver:a=>a.preventDefault(),onDrop:b=>{let c=b.dataTransfer.getData("markId");if(c){var d;d=a.id,i(a=>{let b=null,e=a.map(a=>{let d=a.marks.filter(a=>a.id!==c||(b=a,!1));return{...a,marks:d}});return b?e.map(a=>a.id===d?{...a,marks:[...a.marks,b]}:a):a})}},children:"Empty slot"})]}),(0,d.jsxs)("div",{className:"mt-2 text-[11px] text-gray-500",children:["Times:"," ",0===a.marks.length?"\xef\xbf\xbd":a.marks.map(a=>B(a.time)).join(", ")]})]},a.id))})]}),(0,d.jsx)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:(0,d.jsx)(u,{musicUrl:c||void 0,onTimeUpdate:a=>n(a),onAudioReady:a=>{if(O.current&&O.current(),!a){N(null),O.current=null;return}let b=()=>{N(Number.isFinite(a.duration)?a.duration:null)};a.addEventListener("loadedmetadata",b),a.addEventListener("durationchange",b),b(),O.current=()=>{a.removeEventListener("loadedmetadata",b),a.removeEventListener("durationchange",b)}},audioRef:P})})]})]})]})}function F({performanceId:a}){let[b,c]=(0,e.useState)([]),[f,g]=(0,e.useState)([]),[h,i]=(0,e.useState)([]),[j,k]=(0,e.useState)(!0),[m,n]=(0,e.useState)({}),[o,p]=(0,e.useState)(null),[q,r]=(0,e.useState)({}),s=(0,e.useCallback)(async()=>{k(!0);try{let[b,d,e,f]=await Promise.all([fetch("/api/uniform-types"),fetch("/api/uniform-items"),fetch(`/api/performances/${a}/roster`),fetch("/api/performances")]),[h,j,k,l]=await Promise.all([b.ok?b.json():[],d.ok?d.json():[],e.ok?e.json():[],f.ok?f.json():[]]);c(h||[]),g(j||[]),i(k||[]);let m={};(l||[]).forEach(a=>{a?.id&&(m[a.id]={title:a.title||a.name||a.id,date:a.date||null})}),r(m)}finally{k(!1)}},[a]),t=(0,e.useMemo)(()=>{let a={};return f.forEach(b=>{a[b.uniform_type_id]=a[b.uniform_type_id]||[],a[b.uniform_type_id].push(b)}),Object.values(a).forEach(a=>a.sort((a,b)=>a.item_number.localeCompare(b.item_number))),a},[f]),u=(0,e.useMemo)(()=>[...h].sort((a,b)=>a.name.localeCompare(b.name)),[h]),v=(0,e.useMemo)(()=>{let a={};return f.forEach(b=>{a[b.id]=b}),a},[f]),w=(0,e.useMemo)(()=>{let a={};return b.forEach(b=>{a[b.id]=b}),a},[b]),x=(0,e.useMemo)(()=>{let b=q[a]?.date;if(!b)return null;let c=new Date(b).getTime();return Number.isFinite(c)?c:null},[a,q]),y=a=>a?q[a]?.title||a:"Unknown performance",z=(0,e.useMemo)(()=>{let a={};return f.forEach(b=>{let c=(b.uniform_assignments||[]).find(a=>a.distributed_at&&!a.returned_at&&a.student_id);c?.student_id&&(a[c.student_id]=a[c.student_id]||[],a[c.student_id].push(b))}),a},[f]),A=a=>a&&(a.uniform_assignments||[]).find(a=>!a.returned_at)||null,B=(a,b)=>(a.uniform_assignments||[]).find(a=>!a.returned_at&&a.performance_id===b)||null,C=a=>a?(a.uniform_assignments||[]).filter(a=>!a.returned_at):[],D=a=>{let b=new Map;return f.forEach(c=>{let d=(c.uniform_assignments||[]).filter(b=>b.student_id===a);d.length>0&&(d.sort((a,b)=>{let c=new Date(a.distributed_at||a.returned_at||0).getTime();return new Date(b.distributed_at||b.returned_at||0).getTime()-c}),b.set(c.id,d))}),b},E=async(b,c)=>{if(!c){let c=b.assigned_uniform_item_id&&v[b.assigned_uniform_item_id]||null;if(c){let d=(c.uniform_assignments||[]).find(c=>c.performance_id===a&&c.student_id===b.student_id&&!c.returned_at);if(d?.distributed_at)return void alert("Cannot clear an assignment that is already distributed.");d?.id&&await fetch(`/api/uniform-assignments/${d.id}`,{method:"DELETE"})}}if(c){let d=v[c];if((d?.uniform_assignments||[]).find(c=>c.performance_id===a&&!c.returned_at&&c.student_id!==b.student_id))return void alert("Uniform already assigned for this performance.")}if(!(await fetch(`/api/signups/${b.signup_id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({assigned_uniform_item_id:c})})).ok)return void alert("Failed to assign uniform");if(i(a=>a.map(a=>a.signup_id===b.signup_id?{...a,assigned_uniform_item_id:c}:a)),c){let d=v[c],e=(d?.uniform_assignments||[]).find(c=>c.performance_id===a&&c.student_id===b.student_id&&!c.returned_at);if(e){if(!e.distributed_at){let a=C(d).find(a=>a.student_id===b.student_id&&!!a.distributed_at);a?.distributed_at&&await fetch(`/api/uniform-assignments/${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({distributed_at:a.distributed_at,returned_at:null})})}}else{let e=C(d).find(a=>a.student_id===b.student_id&&!!a.distributed_at),f=e?.distributed_at||null,g=await fetch("/api/uniform-assignments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uniform_item_id:c,student_id:b.student_id,student_name:b.name,performance_id:a,distributed_at:f})});if(!g.ok){let a=await g.json().catch(()=>({}));a?.error&&alert(a.error)}}}},F=async(b,c)=>{let d=A(c),e=B(c,a);if(d){if(d.student_id!==b.student_id||d.performance_id!==a)return void alert(`Uniform is already assigned to ${d.student_name||"someone else"}. Return it first.`);else if(d.distributed_at)return void alert("Uniform is already marked as given to this student for this performance.")}if(window.confirm(`Mark uniform #${c.item_number} as given to ${b.name}?`)){if(!(e&&!e.distributed_at?await fetch(`/api/uniform-assignments/${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({distributed_at:new Date().toISOString(),returned_at:null})}):await fetch("/api/uniform-assignments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uniform_item_id:c.id,student_id:b.student_id,student_name:b.name,performance_id:a,distributed_at:new Date().toISOString()})})).ok)return void alert("Failed to mark as given");await s()}},G=async b=>{let c=B(b,a);if(c&&c.distributed_at&&window.confirm(`Mark uniform #${b.item_number} as returned from ${c.student_name||"someone"}?`)){if(!(await fetch(`/api/uniform-assignments/${c.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({returned_at:new Date().toISOString()})})).ok)return void alert("Failed to mark as returned");await s()}};return j?(0,d.jsx)("div",{className:"text-gray-600",children:"Loading uniforms..."}):(0,d.jsxs)("div",{className:"space-y-6",children:[(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,d.jsx)("div",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Uniform choices"}),(0,d.jsxs)("div",{className:"space-y-3",children:[0===b.length&&(0,d.jsx)("div",{className:"text-sm text-gray-500",children:"No uniform types yet."}),b.map(a=>(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-xs font-semibold text-gray-500 uppercase mb-2",children:a.name}),(0,d.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(t[a.id]||[]).slice().sort((a,b)=>a.item_number.localeCompare(b.item_number)).map(b=>{(a=>{if(!a)return;let b=(a.uniform_assignments||[]).slice();return b.sort((a,b)=>new Date(b.distributed_at||0).getTime()-new Date(a.distributed_at||0).getTime()),b[0]})(b);let c=A(b),e=c?c.distributed_at?`Distributed to ${c.student_name||"Unknown"}`:`Assigned to ${c.student_name||"Unknown"}`:"On hand",f=!!(c&&c.distributed_at),g=a.color||"#0f172a";return(0,d.jsxs)("span",{draggable:!0,onDragStart:a=>{a.dataTransfer.setData("uniformItemId",b.id)},title:e,className:`px-3 py-1 rounded-full text-xs font-semibold text-white cursor-grab ${f?"bg-black ring-2 ring-yellow-400":""}`,style:f?void 0:{backgroundColor:g},children:[a.name," #",b.item_number,f&&(0,d.jsxs)("span",{className:"ml-2 text-[10px] font-semibold",children:["(Distributed to ",c?.student_name||"Unknown",")"]})]},b.id)}),0===(t[a.id]||[]).length&&(0,d.jsx)("div",{className:"text-xs text-gray-500",children:"No items"})]})]},a.id))]})]}),(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:[(0,d.jsxs)("div",{className:"grid grid-cols-6 gap-0 text-xs font-semibold uppercase tracking-wide text-gray-500 bg-gray-50 border-b border-gray-200",children:[(0,d.jsx)("div",{className:"px-3 py-2",children:"Student"}),(0,d.jsx)("div",{className:"px-3 py-2",children:"Assigned"}),(0,d.jsx)("div",{className:"px-3 py-2",children:"Status"}),(0,d.jsx)("div",{className:"px-3 py-2",children:"Next Use"}),(0,d.jsx)("div",{className:"px-3 py-2",children:"Given"}),(0,d.jsx)("div",{className:"px-3 py-2",children:"Returned"})]}),0===u.length&&(0,d.jsx)("div",{className:"p-4 text-sm text-gray-500",children:"No roster yet."}),(0,d.jsx)("div",{className:"max-h-[420px] overflow-y-auto",children:u.map(b=>{let c=b.assigned_uniform_item_id&&v[b.assigned_uniform_item_id]||null,e=c?A(c):null,g=c?B(c,a):null,h=c?((a,b)=>{let c=(a.uniform_assignments||[]).filter(a=>a.performance_id===b);return c.sort((a,b)=>new Date(b.distributed_at||0).getTime()-new Date(a.distributed_at||0).getTime()),c[0]||null})(c,a):null,i=!!(c&&e&&e.student_id&&e.student_id!==b.student_id),j=C(c).find(a=>a.student_id===b.student_id&&!!a.distributed_at),k=j?.distributed_at||null,o=!!(g&&g.distributed_at)||!!k,r=!!(h&&h.returned_at),s=!!(c&&!o&&!r),t=c?i?"bg-red-100 text-red-700 border-red-300":o?"bg-black text-white border-yellow-400 ring-2 ring-yellow-400":"text-white border-transparent":"bg-gray-100 text-gray-600 border-gray-200",u=c?r?"Returned":o?`Given to ${g?.student_name||b.name}`:"Assigned":"Unassigned",D=c?r?`Returned ${(0,l.P9)(h.returned_at,l.GI)}`:o?`Given ${(0,l.P9)(g?.distributed_at||k,l.GI)}`:s?"Assigned":null:null,H=c?r?"bg-blue-100 text-blue-700 border-blue-300":o?"bg-gray-700 text-white border-gray-700":"bg-amber-100 text-amber-700 border-amber-300":"bg-gray-100 text-gray-600 border-gray-200",I=((a,b)=>{if(!a)return null;let c=x??Date.now(),d=(a.uniform_assignments||[]).filter(a=>!a.returned_at&&a.performance_id).map(a=>({assign:a,time:(a=>{if(!a)return null;let b=q[a]?.date;if(!b)return null;let c=new Date(b).getTime();return Number.isFinite(c)?c:null})(a.performance_id||null)})).filter(a=>null!==a.time&&a.time>c).sort((a,b)=>a.time-b.time);return 0===d.length?null:d[0].assign})(c,b.student_id),J=!!(I&&I.student_id===b.student_id),K=I?.performance_id&&q[I.performance_id]?.date||null,L=I?J?`${b.name} is assigned for ${y(I.performance_id||null)}${K?` (${(0,l.P9)(K,l.GI)})`:""} coming up.`:`Warning: ${y(I.performance_id||null)}${K?` (${(0,l.P9)(K,l.GI)})`:""} needs this uniform for ${I.student_name||"another student"}.`:"—";return(0,d.jsxs)("div",{className:"grid grid-cols-6 gap-0 border-b border-gray-200 last:border-b-0 text-sm",children:[(0,d.jsxs)("div",{className:"px-3 py-3 font-semibold text-gray-900 flex items-center gap-2",children:[(0,d.jsx)("span",{children:b.name}),!J&&I&&(0,d.jsx)("span",{className:"inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-700 text-xs font-bold",children:"!"}),(0,d.jsx)("button",{type:"button",onClick:()=>p(b),className:"text-[10px] px-2 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300",children:"History"})]}),(0,d.jsx)("div",{className:"px-3 py-3",onDragOver:a=>a.preventDefault(),onDrop:a=>{let c=a.dataTransfer.getData("uniformItemId");if(!c)return;let d=v[c],e=d?A(d):null;if(e&&e.distributed_at){let a=(e.student_name||"").trim().toLowerCase(),c=b.name.trim().toLowerCase();if(!a||a!==c)return void alert(`Uniform #${d?.item_number||""} is already distributed to ${e.student_name||"someone"}.`)}E(b,c)},children:c?(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsxs)("span",{className:`px-3 py-1 rounded-full text-xs font-semibold border ${t}`,style:{backgroundColor:c&&!o&&w[c.uniform_type_id]?.color||void 0},children:[w[c.uniform_type_id]?.name||"Uniform"," #",c.item_number]}),i&&(0,d.jsx)("span",{className:"text-[10px] font-semibold text-red-600",children:"Not available"}),(0,d.jsx)("button",{onClick:()=>E(b,null),className:"text-[10px] text-gray-500 hover:text-gray-700",children:"Clear"})]}):(0,d.jsxs)("div",{className:"w-full",children:[z[b.student_id]?.length?(0,d.jsxs)("div",{className:"mb-2 text-[11px] text-amber-700",children:["Currently holding:"," ",z[b.student_id].map(a=>{let b=w[a.uniform_type_id]?.name||"Uniform";return`${b} #${a.item_number}`}).join(", ")]}):null,(0,d.jsx)("input",{value:m[b.signup_id]||"",onChange:a=>n(c=>({...c,[b.signup_id]:a.target.value})),list:`uniform-options-${b.signup_id}`,placeholder:z[b.student_id]?.length?`Currently holding: ${z[b.student_id].map(a=>a.item_number).join(", ")}`:"Drop uniform here or type code",className:"w-full px-2 py-1 border border-dashed border-gray-300 rounded text-xs text-gray-700"}),(0,d.jsx)("datalist",{id:`uniform-options-${b.signup_id}`,children:f.map(a=>(0,d.jsx)("option",{value:a.item_number},a.id))}),(0,d.jsx)("div",{className:"mt-1 flex flex-wrap gap-2 text-[10px] text-gray-600",children:f.filter(a=>!!(m[b.signup_id]||"").trim()&&a.item_number.toLowerCase().includes((m[b.signup_id]||"").trim().toLowerCase())).slice(0,3).map(c=>(0,d.jsxs)("span",{className:"px-2 py-1 bg-gray-100 rounded-full",children:[c.item_number," (",(b=>{let c=C(b);if(0===c.length)return"On hand";if(c.length>1)return"Assigned in multiple performances";let d=c[0];return d.distributed_at?`Distributed to ${d.student_name||"Unknown"}${d.performance_id&&d.performance_id!==a?" (other performance)":""}`:`Assigned to ${d.student_name||"Unknown"}${d.performance_id&&d.performance_id!==a?" (other performance)":""}`})(c),")"]},`${b.signup_id}-${c.id}`))}),(0,d.jsx)("div",{className:"mt-1",children:(0,d.jsx)("button",{type:"button",onClick:()=>{let a=(m[b.signup_id]||"").trim();if(!a)return;let c=f.find(b=>b.item_number.toLowerCase()===a.toLowerCase());if(!c)return void alert("Uniform not found.");E(b,c.id)},className:"px-2 py-1 text-xs rounded bg-gray-800 text-white",children:"Assign"})})]})}),(0,d.jsxs)("div",{className:"px-3 py-3 text-xs text-gray-700",children:[(0,d.jsx)("div",{children:(0,d.jsx)("span",{className:`inline-flex px-2 py-1 rounded-full border text-[10px] font-semibold ${H}`,children:u})}),D&&(0,d.jsx)("div",{className:"text-[10px] text-gray-500",children:D})]}),(0,d.jsx)("div",{className:"px-3 py-3 text-[11px] text-gray-700",children:(0,d.jsx)("div",{className:I&&!J?"border border-red-300 bg-red-50 text-red-700 rounded px-2 py-1":"",children:L})}),(0,d.jsx)("div",{className:"px-3 py-3",children:(0,d.jsx)("button",{onClick:()=>c&&F(b,c),disabled:!c||!!(g&&g.student_id===b.student_id&&g.distributed_at),className:"px-3 py-1 rounded text-xs bg-emerald-600 text-white disabled:bg-gray-300",children:o?"Given":`Give to ${b.name}`})}),(0,d.jsxs)("div",{className:"px-3 py-3 flex items-center gap-2",children:[(0,d.jsx)("button",{onClick:()=>c&&G(c),disabled:!c||!g||!g.distributed_at,className:"px-3 py-1 rounded text-xs bg-blue-600 text-white disabled:bg-gray-300",children:r?"Returned ✓":"Not Returned"}),!r&&I&&!J&&(0,d.jsx)("span",{className:"inline-flex items-center justify-center w-5 h-5 rounded-full bg-amber-100 text-amber-700 text-xs font-bold",children:"!"})]})]},b.signup_id)})})]}),o&&(0,d.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4 w-full max-w-2xl shadow-lg",children:[(0,d.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Uniform History"}),(0,d.jsx)("div",{className:"text-lg font-semibold text-gray-900",children:o.name})]}),(0,d.jsx)("button",{type:"button",onClick:()=>p(null),className:"text-xs text-gray-500 hover:text-gray-700",children:"Close"})]}),(0,d.jsxs)("div",{className:"mt-3 max-h-[70vh] overflow-y-auto space-y-3 text-sm text-gray-700",children:[Array.from(D(o.student_id).entries()).map(([a,b])=>{let c=v[a];return(0,d.jsxs)("div",{className:"border border-gray-200 rounded p-3",children:[(0,d.jsx)("div",{className:"font-semibold text-gray-900",children:c?`#${c.item_number}`:"Uniform Item"}),(0,d.jsx)("div",{className:"mt-2 space-y-2",children:b.map(a=>(0,d.jsxs)("div",{className:"text-xs text-gray-600",children:[a.performance_id&&(0,d.jsxs)("div",{children:["Performance: ",q[a.performance_id]?.title||a.performance_id]}),(0,d.jsxs)("div",{children:["Assigned:"," ",a.distributed_at||a.returned_at?(0,l.P9)(a.distributed_at||a.returned_at||"",l.GI):"—"]}),(0,d.jsxs)("div",{children:["Distributed:"," ",a.distributed_at?(0,l.P9)(a.distributed_at,l.GI):"—"]}),(0,d.jsxs)("div",{children:["Returned:"," ",a.returned_at?(0,l.P9)(a.returned_at,l.GI):"—"]})]},a.id))})]},a)}),0===D(o.student_id).size&&(0,d.jsx)("div",{className:"text-sm text-gray-500",children:"No uniform history for this student."})]})]})})]})}var G=c(45224);function H({params:a}){let{id:b}=(0,e.use)(a),c=`rehearse:performance-info:${b}`,f=(0,G.C_)(c),[g,k]=(0,e.useState)(null),[m,n]=(0,e.useState)(!0),[p,r]=(0,e.useState)("rehearsals"),[v,B]=(0,e.useState)(!1),[C,D]=(0,e.useState)(!1),[H,K]=(0,e.useState)(null),[L,M]=(0,e.useState)(null),[N,O]=(0,e.useState)(!1),[P,Q]=(0,e.useState)(!1),[R,S]=(0,e.useState)(!1),[T,U]=(0,e.useState)(!0),[V,W]=(0,e.useState)(!1),[X,Y]=(0,e.useState)(null),[Z,$]=(0,e.useState)(f?.infoForm||{title:"",call_time:"",timezone:"America/New_York",date:"",location:"",description:"",phone_numbers:""}),[_,aa]=(0,e.useState)(f?.callTimeManual??!1),[ab,ac]=(0,e.useState)(f?.savedAt||null);(0,e.useRef)(null),(0,e.useRef)(!!f);let[ad,ae]=(0,e.useState)([]),[af,ag]=(0,e.useState)(""),[ah,ai]=(0,e.useState)(""),[aj,ak]=(0,e.useState)([]),[al,am]=(0,e.useState)(""),{rehearsals:an,createRehearsal:ao,deleteRehearsal:ap,updateRehearsal:aq}=i(b),{parts:ar,createPart:as,deletePart:at,setParts:au}=function(a){let[b,c]=(0,e.useState)([]),[d,f]=(0,e.useState)(!0),[g,h]=(0,e.useState)(null),i=async(d,e,f,g)=>{if(!a)throw Error("Performance ID is required");try{let h=await fetch("/api/parts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:a,name:d,description:e,order:f,is_group:g})});if(!h.ok)throw Error("Failed to create part");let i=await h.json();return c([...b,i]),i}catch(a){throw h(a instanceof Error?a.message:"An error occurred"),a}},j=async a=>{try{if(!(await fetch(`/api/parts/${a}`,{method:"DELETE"})).ok)throw Error("Failed to delete part");c(b.filter(b=>b.id!==a))}catch(a){throw h(a instanceof Error?a.message:"An error occurred"),a}};return{parts:b,loading:d,error:g,createPart:i,deletePart:j,setParts:c}}(b),{performances:av}=(0,j.f)(),aw=(0,e.useMemo)(()=>(0,l.eL)(Z.date,Z.timezone),[Z.date,Z.timezone]),ax=async()=>{try{S(!0);let a=await fetch(`/api/rehearse-export?performanceId=${b}&embedAudio=${T?"1":"0"}`);if(!a.ok){let b=await a.text();throw console.error("Export error:",a.status,b),Error("Failed to export rehearse HTML")}let c=await a.blob(),d=URL.createObjectURL(c),e=(g?.title||"rehearse-export").toString().replace(/[^a-z0-9]+/gi,"-").replace(/^-+|-+$/g,"").toLowerCase(),f=document.createElement("a");f.href=d,f.download=`${e||"rehearse-export"}.html`,document.body.appendChild(f),f.click(),f.remove(),URL.revokeObjectURL(d)}catch(a){console.error("Export failed:",a),alert("Failed to export rehearse HTML")}finally{S(!1)}};return m?(0,d.jsx)("div",{className:"min-h-screen bg-gray-100 p-6",children:(0,d.jsx)("p",{className:"text-gray-600",children:"Loading..."})}):g?(0,d.jsxs)("div",{className:"min-h-screen bg-gray-100",children:[(0,d.jsx)("nav",{className:"bg-blue-900 text-white p-4 shadow-lg",children:(0,d.jsxs)("div",{className:"max-w-7xl mx-auto flex justify-between items-center",children:[(0,d.jsx)(x.AppBrand,{href:"/"}),(0,d.jsxs)("div",{className:"flex gap-4",children:[(0,d.jsx)(h(),{href:"/admin",className:"hover:bg-blue-800 px-3 py-2 rounded",children:"Admin Panel"}),(0,d.jsx)(z.$,{className:"px-3 py-2 bg-blue-700 rounded hover:bg-blue-600 text-sm"})]})]})}),(0,d.jsxs)("div",{className:"flex min-h-[calc(100vh-64px)]",children:[(0,d.jsx)("div",{className:"hidden md:block w-64 bg-white shadow-md p-6 overflow-y-auto border-r border-gray-200",children:(0,d.jsx)(q,{performanceId:b})}),(0,d.jsxs)("div",{className:"flex-1 min-w-0 p-6",children:[(0,d.jsxs)("div",{className:"md:hidden mb-4 flex items-center justify-between",children:[(0,d.jsx)("button",{onClick:()=>Q(!0),className:"px-3 py-2 bg-gray-900 text-white rounded text-sm",children:"Open Roster"}),(0,d.jsx)("div",{className:"text-[11px] text-gray-500",children:"Tip: Rotate your phone for a better view."})]}),(0,d.jsxs)("div",{className:`${"positioning"===p||"marking"===p?"max-w-none mx-0":"max-w-5xl mx-auto"}`,children:[(0,d.jsxs)("div",{className:"mb-8",children:[(0,d.jsx)(h(),{href:"/admin",className:"text-blue-600 hover:underline mb-4 block",children:"← Back to Dashboard"}),(0,d.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:g.title}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-gray-600",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("span",{className:"font-semibold",children:"Date:"})," ",g?.date?(0,l.P9)(g.date,Z.timezone):"—"]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("span",{className:"font-semibold",children:"Location:"})," ",g.location]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("span",{className:"font-semibold",children:"Timezone:"})," ",Z.timezone]})]}),g.description&&(0,d.jsxs)("div",{className:"mt-4 text-gray-600",children:[(0,d.jsx)("span",{className:"font-semibold",children:"Description:"})," ",g.description]})]}),(0,d.jsxs)("div",{className:"flex gap-4 mb-8 flex-wrap",children:[(0,d.jsx)("button",{onClick:()=>r("rehearsals"),className:`px-6 py-3 rounded-lg font-semibold transition-colors ${"rehearsals"===p?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"}`,children:"Rehearsals"}),(0,d.jsx)("button",{onClick:()=>r("parts"),className:`px-6 py-3 rounded-lg font-semibold transition-colors ${"parts"===p?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"}`,children:"Parts/Choreography"}),(0,d.jsx)("button",{onClick:()=>{r("positioning"),ar.length>0&&!H&&K(ar[0].id)},className:`px-6 py-3 rounded-lg font-semibold transition-colors ${"positioning"===p?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"}`,children:"Stage Positions"}),(0,d.jsx)("button",{onClick:()=>r("music"),className:`px-6 py-3 rounded-lg font-semibold transition-colors ${"music"===p?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"}`,children:"Music & Rehearse"}),(0,d.jsx)("button",{onClick:()=>r("marking"),className:`px-6 py-3 rounded-lg font-semibold transition-colors ${"marking"===p?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"}`,children:"Marking"}),(0,d.jsx)("button",{onClick:()=>r("uniforms"),className:`px-6 py-3 rounded-lg font-semibold transition-colors ${"uniforms"===p?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"}`,children:"Uniforms"}),(0,d.jsx)("button",{onClick:()=>r("info"),className:`px-6 py-3 rounded-lg font-semibold transition-colors ${"info"===p?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"}`,children:"Performance Info"})]}),"positioning"===p?(0,d.jsx)("div",{className:"flex flex-col gap-6",children:(0,d.jsx)("div",{className:"bg-white rounded-lg shadow-md p-8",children:0===ar.length?(0,d.jsxs)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:[(0,d.jsx)("p",{className:"text-gray-600 mb-4",children:"No parts created yet."}),(0,d.jsx)("p",{className:"text-sm text-gray-500",children:"Create parts first before positioning students."})]}):H&&(0,d.jsx)(s,{performanceId:b,partId:H,partName:ar.find(a=>a.id===H)?.name,partDescription:ar.find(a=>a.id===H)?.description,partTimepointSeconds:ar.find(a=>a.id===H)?.timepoint_seconds??null,partTimepointEndSeconds:ar.find(a=>a.id===H)?.timepoint_end_seconds??null,isGroup:ar.find(a=>a.id===H)?.is_group!==!1,onSavePositions:async a=>{let b=a.map(a=>({part_id:H,student_id:a.student_id,x:a.x,y:a.y}));if(!(await fetch("/api/stage-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:H,positions:b})})).ok)throw Error("Failed to save positions")}})})}):(0,d.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-8",children:["rehearsals"===p&&(0,d.jsx)(I,{rehearsals:an,showForm:v,onToggleForm:()=>B(!v),onCreateRehearsal:ao,onDeleteRehearsal:ap,onUpdateRehearsal:aq}),"parts"===p&&(0,d.jsx)(J,{performanceId:b,parts:ar,performances:av,showForm:C,onToggleForm:()=>D(!C),onCreatePart:as,onDeletePart:at,onReorderParts:au,musicUrl:L}),"music"===p&&(0,d.jsxs)("div",{className:"space-y-6",children:[(0,d.jsx)(t,{performanceId:b,performanceTitle:g.title,currentMusicFile:g.music_file_name,onUploadSuccess:(a,b)=>{M(b),k({...g,music_file_name:a.split("/").pop()})}}),L&&(0,d.jsxs)("div",{children:[(0,d.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Preview Music"}),(0,d.jsx)(u,{musicUrl:L,performanceTitle:g.title})]}),(0,d.jsxs)("div",{className:"bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-lg border-2 border-purple-200",children:[(0,d.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"\uD83C\uDFAD Rehearse/Emulate Mode"}),(0,d.jsx)("p",{className:"text-gray-700 mb-4",children:"Use rehearse mode to play back your choreography with automatic grid transitions based on music timepoints."}),(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-3",children:[(0,d.jsx)("button",{disabled:!L||0===ar.length,onClick:()=>O(!0),className:"px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-semibold",children:"Start Rehearse Mode →"}),(0,d.jsx)("button",{disabled:!L||0===ar.length||R,onClick:ax,className:"px-6 py-3 bg-white text-purple-700 border border-purple-300 rounded-lg hover:bg-purple-50 disabled:bg-gray-100 disabled:text-gray-400 disabled:border-gray-200 font-semibold",children:R?"Exporting...":"Export Rehearse HTML"}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm text-purple-900",children:[(0,d.jsx)("input",{type:"checkbox",checked:T,onChange:a=>U(a.target.checked),className:"h-4 w-4"}),"Embed audio in export"]})]}),(0,d.jsxs)("p",{className:"text-sm text-gray-600 mt-2",children:[!L&&"⚠️ Upload music first",L&&0===ar.length&&"⚠️ Create parts and set timepoints",L&&ar.length>0&&"✓ Ready to rehearse"]})]}),ar.length>0&&(0,d.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,d.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Part Timepoints"}),(0,d.jsxs)("div",{className:"space-y-3",children:[(0,d.jsx)("p",{className:"text-gray-600 text-sm",children:'Click "Edit" on a part to set its music timepoint (when the part should appear during rehearsal).'}),(0,d.jsxs)("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[(0,d.jsx)("p",{className:"font-semibold text-blue-900 mb-2",children:"\uD83D\uDCCB Parts Timeline:"}),(0,d.jsx)("div",{className:"space-y-2",children:ar.map(a=>(0,d.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,d.jsx)("span",{className:"font-medium text-gray-900",children:a.name}),a.timepoint_seconds?(0,d.jsxs)("span",{className:"text-amber-700 bg-amber-100 px-2 py-1 rounded",children:["Start: ",a.timepoint_seconds,"s",a.timepoint_end_seconds?` - End: ${a.timepoint_end_seconds}s`:""]}):(0,d.jsx)("span",{className:"text-gray-400 italic",children:"No timepoint set"})]},a.id))})]})]})]})]}),"marking"===p&&(0,d.jsx)(E,{performanceId:b,parts:ar,musicUrl:L,performanceTitle:g?.title,onPartsUpdated:a=>au(a)}),"uniforms"===p&&(0,d.jsx)(F,{performanceId:b}),"info"===p&&(0,d.jsx)("div",{className:"space-y-6",children:(0,d.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,d.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Performance Info"}),X&&(0,d.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:X}),ab&&(0,d.jsxs)("div",{className:"text-xs text-gray-500 mb-3",children:["Draft saved ",new Date(ab).toLocaleString(void 0,{timeZone:l.GI,timeZoneName:"short"}),"."]}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Performance Name"}),(0,d.jsx)("input",{type:"text",value:Z.title,onChange:a=>$(b=>({...b,title:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Date & Time"}),(0,d.jsx)("input",{type:"datetime-local",value:Z.date,onChange:a=>{let b=a.target.value;$(a=>({...a,date:b,call_time:_?a.call_time:(0,l.Kb)(b)})),_||b||$(a=>({...a,call_time:""}))},className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Call Time"}),(0,d.jsx)("input",{type:"time",value:Z.call_time,onChange:a=>{aa(!0),$(b=>({...b,call_time:a.target.value}))},disabled:aw,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),aw&&(0,d.jsx)("div",{className:"text-xs text-amber-700 mt-1",children:"Call time is locked within 1 hour of the performance."})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Timezone"}),(0,d.jsx)("input",{type:"text",value:Z.timezone,onChange:a=>$(b=>({...b,timezone:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,d.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:"Use IANA format (e.g., America/New_York)"})]}),(0,d.jsxs)("div",{className:"md:col-span-2",children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Location"}),(0,d.jsx)(A.e,{value:Z.location,onChange:a=>$(b=>({...b,location:a})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),(0,d.jsxs)("div",{className:"mt-4",children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Description"}),(0,d.jsx)("textarea",{rows:3,value:Z.description,onChange:a=>$(b=>({...b,description:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("div",{className:"mt-4",children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Important Phone Numbers"}),(0,d.jsx)("textarea",{rows:4,placeholder:"One per line",value:Z.phone_numbers,onChange:a=>$(b=>({...b,phone_numbers:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,d.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2 items-center",children:[(0,d.jsxs)("select",{value:al,onChange:a=>am(a.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,d.jsx)("option",{value:"",children:"Add saved contact..."}),aj.map(a=>(0,d.jsxs)("option",{value:`${a.name}||${a.phone}`,children:[a.name," • ",a.phone]},`${a.name}-${a.phone}`))]}),(0,d.jsx)("button",{onClick:()=>{if(!al)return;let[a,b]=al.split("||"),c=`${a}: ${b}`;$(a=>({...a,phone_numbers:a.phone_numbers?`${a.phone_numbers}
${c}`:c})),am("")},className:"px-3 py-1 bg-gray-900 text-white rounded text-xs",children:"Add to phone list"})]})]}),(0,d.jsxs)("div",{className:"mt-6 border-t border-gray-200 pt-4",children:[(0,d.jsx)("h4",{className:"font-semibold text-gray-900 mb-2",children:"Contacts Directory"}),(0,d.jsx)("p",{className:"text-sm text-gray-600 mb-3",children:"Add contacts and select which ones appear in the export."}),(0,d.jsxs)("div",{className:"flex flex-wrap gap-2 items-center mb-3",children:[(0,d.jsxs)("select",{value:al,onChange:a=>am(a.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,d.jsx)("option",{value:"",children:"Add saved contact..."}),aj.map(a=>(0,d.jsxs)("option",{value:`${a.name}||${a.phone}`,children:[a.name," • ",a.phone]},`${a.name}-${a.phone}`))]}),(0,d.jsx)("button",{onClick:async()=>{if(!al)return;let[a,c]=al.split("||"),d=await fetch("/api/performance-contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:b,name:a,phone:c,include_in_export:!0})});if(d.ok){let a=await d.json();ae(b=>[...b,a]),am("")}},className:"px-3 py-1 bg-blue-600 text-white rounded text-xs",children:"Add to contacts"})]}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[(0,d.jsx)("input",{type:"text",placeholder:"Name",value:af,onChange:a=>ag(a.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg"}),(0,d.jsx)("input",{type:"text",placeholder:"Phone",value:ah,onChange:a=>ai(a.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg"}),(0,d.jsx)("button",{onClick:async()=>{if(!af.trim()||!ah.trim())return;let a=await fetch("/api/performance-contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:b,name:af.trim(),phone:ah.trim(),include_in_export:!0})});if(a.ok){let b=await a.json();ae(a=>[...a,b]),ag(""),ai("")}},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold",children:"Add Contact"})]}),(0,d.jsx)("div",{className:"space-y-2",children:ad.map(a=>(0,d.jsxs)("div",{className:"flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2",children:[(0,d.jsxs)("div",{className:"flex-1",children:[(0,d.jsx)("div",{className:"font-medium text-gray-900",children:a.name}),(0,d.jsx)("div",{className:"text-sm text-gray-600",children:a.phone})]}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,d.jsx)("input",{type:"checkbox",checked:!!a.include_in_export,onChange:async b=>{(await fetch(`/api/performance-contacts/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({include_in_export:b.target.checked})})).ok&&ae(c=>c.map(c=>c.id===a.id?{...c,include_in_export:b.target.checked}:c))}}),"Include in export"]}),(0,d.jsx)("button",{onClick:async()=>{(await fetch(`/api/performance-contacts/${a.id}`,{method:"DELETE"})).ok&&ae(b=>b.filter(b=>b.id!==a.id))},className:"text-xs text-red-600 hover:text-red-800",children:"Remove"})]},a.id))})]}),(0,d.jsx)("div",{className:"mt-6",children:(0,d.jsx)("button",{onClick:async()=>{try{W(!0),Y(null);let a=await fetch(`/api/performances/${b}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:Z.title,date:Z.date||null,call_time:Z.call_time,timezone:Z.timezone,location:Z.location,description:Z.description,phone_numbers:Z.phone_numbers})});if(!a.ok){let b=await a.json().catch(()=>null);throw Error(b?.details||b?.error||"Failed to save info")}let c=await a.json();k(c),$(a=>{let b,d;return{...a,title:c.title||"",call_time:c.call_time||"",timezone:c.timezone||a.timezone,date:c.date?(b=c.date,d=c.timezone||a.timezone,(0,l.y7)(b,d||"America/New_York")):a.date}});let d=await fetch(`/api/performance-contacts?performanceId=${b}`);if(d.ok){let a=await d.json();ae(a||[])}}catch(a){Y(a instanceof Error?a.message:"Failed to save info")}finally{W(!1)}},className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold disabled:bg-gray-400",disabled:V,children:V?"Saving...":"Save Info"})})]})})]})]})]}),"positioning"===p&&ar.length>0&&(0,d.jsx)("div",{className:"w-80 bg-white shadow-md p-4 border-l border-gray-200",children:(0,d.jsxs)("div",{className:"sticky top-20 space-y-6",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("h3",{className:"font-semibold text-gray-900 mb-2",children:"Parts & Choreography"}),(0,d.jsx)("p",{className:"text-xs text-gray-500 mb-3",children:"Drag to reorder. Click a card to show positions."}),(0,d.jsx)(o,{parts:ar,performanceId:b,onDelete:at,onReorder:au,onSelect:a=>K(a),selectedPartId:H,variant:"select",enableDrag:!0,showPositionedNames:!0,showDelete:!0})]}),(0,d.jsx)(y,{partId:H})]})})]}),N&&(0,d.jsx)(w,{performanceId:b,parts:ar,musicUrl:L,onClose:()=>O(!1),onUpdatePartTimepoints:a=>{au(b=>b.map(b=>b.id===a.id?{...b,...a}:b))}}),P&&(0,d.jsx)("div",{className:"fixed inset-0 z-40 bg-black/40 md:hidden",onClick:()=>Q(!1),children:(0,d.jsxs)("div",{className:"absolute left-0 top-0 h-full w-72 bg-white shadow-xl p-4 overflow-y-auto",onClick:a=>a.stopPropagation(),children:[(0,d.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,d.jsx)("div",{className:"text-sm font-semibold text-gray-900",children:"Roster"}),(0,d.jsx)("button",{onClick:()=>Q(!1),className:"text-xs text-gray-600 hover:text-gray-900",children:"Close"})]}),(0,d.jsx)(q,{performanceId:b})]})})]}):(0,d.jsxs)("div",{className:"min-h-screen bg-gray-100 p-6",children:[(0,d.jsx)("p",{className:"text-red-600",children:"Performance not found"}),(0,d.jsx)(h(),{href:"/admin",className:"text-blue-600 hover:underline",children:"Back to Admin"})]})}function I({rehearsals:a,showForm:b,onToggleForm:c,onCreateRehearsal:e,onDeleteRehearsal:f,onUpdateRehearsal:g}){return(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,d.jsx)("h2",{className:"text-2xl font-bold",children:"Schedule Rehearsals"}),(0,d.jsx)("button",{onClick:c,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold",children:b?"Cancel":"+ Schedule Rehearsal"})]}),b&&(0,d.jsx)("div",{className:"mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200",children:(0,d.jsx)(k,{onSubmit:async(a,b)=>{await e(a,b)}})}),0===a.length?(0,d.jsx)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:(0,d.jsx)("p",{className:"text-gray-600",children:"No rehearsals scheduled yet."})}):(0,d.jsx)(m,{rehearsals:a,onDelete:f,onUpdate:g})]})}function J({performanceId:a,parts:b,performances:c,showForm:f,onToggleForm:g,onCreatePart:h,onDeletePart:i,onReorderParts:j,musicUrl:k=null}){let[l,m]=(0,e.useState)(""),[p,q]=(0,e.useState)(!0),[r,s]=(0,e.useState)(!1),[t,u]=(0,e.useState)(null),[v,w]=(0,e.useState)(null),[x,y]=(0,e.useState)(!0),z=(c||[]).filter(b=>b.id!==a);return(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[(0,d.jsx)("h3",{className:"text-lg font-bold text-blue-900 mb-2",children:"Copy Parts from Another Performance"}),(0,d.jsx)("p",{className:"text-sm text-blue-800 mb-3",children:"This copies part names/descriptions (and optionally music timepoints), plus stage positions, subparts, and assigned order."}),(0,d.jsxs)("div",{className:"flex flex-wrap gap-3 items-center",children:[(0,d.jsxs)("select",{value:l,onChange:a=>m(a.target.value),className:"px-3 py-2 border border-blue-300 rounded-lg text-sm min-w-[220px]",children:[(0,d.jsx)("option",{value:"",children:"Select performance to copy from..."}),z.map(a=>(0,d.jsx)("option",{value:a.id,children:a.title},a.id))]}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm text-blue-900",children:[(0,d.jsx)("input",{type:"checkbox",checked:p,onChange:a=>q(a.target.checked),className:"h-4 w-4"}),"Copy music timepoints"]}),(0,d.jsx)("button",{onClick:async()=>{if(l){s(!0),u(null),w(null);try{let c=await fetch("/api/parts/copy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_performance_id:l,target_performance_id:a,copy_timepoints:p})});if(!c.ok){let a=await c.json();throw Error(a.error||"Failed to copy parts")}let d=await c.json();Array.isArray(d)&&d.length>0?(j?.([...b,...d]),w(`Copied ${d.length} part(s).`)):w("No parts found to copy.")}catch(a){u(a instanceof Error?a.message:"Failed to copy parts")}finally{s(!1)}}},disabled:!l||r,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 font-semibold text-sm",children:r?"Copying...":"Copy Parts"})]}),t&&(0,d.jsx)("div",{className:"mt-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded px-3 py-2",children:t}),v&&(0,d.jsx)("div",{className:"mt-3 text-sm text-green-700 bg-green-50 border border-green-200 rounded px-3 py-2",children:v})]}),(0,d.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,d.jsx)("h2",{className:"text-2xl font-bold",children:"Parts & Choreography"}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{onClick:()=>y(a=>!a),className:"px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold text-sm",children:x?"Expand Details":"Compact View"}),(0,d.jsx)("button",{onClick:g,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold",children:f?"Cancel":"+ Add Part"})]})]}),f&&(0,d.jsx)("div",{className:"mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200",children:(0,d.jsx)(n,{onSubmit:h})}),0===b.length?(0,d.jsx)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:(0,d.jsx)("p",{className:"text-gray-600",children:"No parts created yet."})}):(0,d.jsx)(o,{parts:b,performanceId:a,onDelete:i,onReorder:j,compact:x,musicUrl:k})]})}},41025:a=>{"use strict";a.exports=require("next/dist/server/app-render/dynamic-access-async-storage.external.js")},42520:(a,b,c)=>{Promise.resolve().then(c.bind(c,67031))},44694:(a,b,c)=>{"use strict";c.r(b),c.d(b,{default:()=>h});var d=c(21124),e=c(38301),f=c(70798);function g({children:a}){let[b,c]=(0,e.useState)(!0),[g,h]=(0,e.useState)(null),[i,j]=(0,e.useState)(""),[k,l]=(0,e.useState)(""),[m,n]=(0,e.useState)(null);return b?(0,d.jsx)("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:(0,d.jsx)("p",{className:"text-gray-600",children:"Checking admin session..."})}):g?(0,d.jsx)(d.Fragment,{children:a}):(0,d.jsx)("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center p-6",children:(0,d.jsxs)("div",{className:"w-full max-w-md bg-white border border-gray-200 rounded-lg shadow-sm p-6",children:[(0,d.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Admin Login"}),(0,d.jsx)("p",{className:"text-sm text-gray-600 mb-6",children:"Sign in with your Supabase admin account to access the dashboard."}),m&&(0,d.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-4 text-sm",children:m}),(0,d.jsxs)("div",{className:"space-y-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Email"}),(0,d.jsx)("input",{type:"email",value:i,onChange:a=>j(a.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"admin@yourstudio.com"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Password"}),(0,d.jsx)("input",{type:"password",value:k,onChange:a=>l(a.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"••••••••"})]}),(0,d.jsx)("button",{onClick:async()=>{n(null);let{error:a}=await f.N.auth.signInWithPassword({email:i,password:k});a&&n(a.message)},className:"w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700",children:"Sign In"}),(0,d.jsx)("div",{className:"text-xs text-gray-500",children:"Need an admin account? Create one in Supabase Auth users."})]})]})})}function h({children:a}){return(0,d.jsx)(g,{children:a})}},45224:(a,b,c)=>{"use strict";function d(a){return null}function e(a,b){}function f(a){}c.d(b,{C_:()=>d,J1:()=>e,nr:()=>f})},51472:(a,b,c)=>{"use strict";c.r(b),c.d(b,{default:()=>f,metadata:()=>e});var d=c(75338);c(61135);let e={title:"Performance Tool",description:"Performance signup and management system"};function f({children:a}){return(0,d.jsx)("html",{lang:"en",children:(0,d.jsx)("body",{className:"bg-gray-50",children:(0,d.jsxs)("div",{className:"min-h-screen flex flex-col",children:[(0,d.jsx)("div",{className:"flex-1",children:a}),(0,d.jsx)("footer",{className:"text-center text-xs text-gray-400 py-4",children:"Rehearse by Origin Media"})]})})})}},52248:(a,b,c)=>{Promise.resolve().then(c.bind(c,40924))},58320:(a,b,c)=>{"use strict";c.d(b,{e:()=>f});var d=c(21124),e=c(38301);function f({value:a,onChange:b,placeholder:c,className:f,disabled:g=!1}){let h=(0,e.useRef)(null),[i,j]=(0,e.useState)(null);return(0,d.jsxs)("div",{children:[(0,d.jsx)("input",{ref:h,type:"text",value:a,onChange:a=>b(a.target.value),placeholder:c,className:f,disabled:g}),i&&(0,d.jsx)("div",{className:"text-xs text-amber-700 mt-1",children:"Location autocomplete unavailable."})]})}},59530:(a,b,c)=>{"use strict";c.r(b),c.d(b,{GlobalError:()=>D.a,__next_app__:()=>J,handler:()=>L,pages:()=>I,routeModule:()=>K,tree:()=>H});var d=c(49754),e=c(9117),f=c(46595),g=c(32324),h=c(39326),i=c(38928),j=c(20175),k=c(12),l=c(54290),m=c(12696),n=c(82802),o=c(77533),p=c(45229),q=c(32822),r=c(261),s=c(26453),t=c(52474),u=c(26713),v=c(51356),w=c(62685),x=c(36225),y=c(63446),z=c(2762),A=c(45742),B=c(86439),C=c(81170),D=c.n(C),E=c(62506),F=c(91203),G={};for(let a in E)0>["default","tree","pages","GlobalError","__next_app__","routeModule","handler"].indexOf(a)&&(G[a]=()=>E[a]);c.d(b,G);let H={children:["",{children:["admin",{children:["performances",{children:["[id]",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(c.bind(c,67031)),"C:\\Users\\calvi\\Desktop\\PerfTool\\src\\app\\admin\\performances\\[id]\\page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(c.bind(c,93972)),"C:\\Users\\calvi\\Desktop\\PerfTool\\src\\app\\admin\\layout.tsx"]}]},{layout:[()=>Promise.resolve().then(c.bind(c,51472)),"C:\\Users\\calvi\\Desktop\\PerfTool\\src\\app\\layout.tsx"],"global-error":[()=>Promise.resolve().then(c.t.bind(c,81170,23)),"next/dist/client/components/builtin/global-error.js"],"not-found":[()=>Promise.resolve().then(c.t.bind(c,87028,23)),"next/dist/client/components/builtin/not-found.js"],forbidden:[()=>Promise.resolve().then(c.t.bind(c,90461,23)),"next/dist/client/components/builtin/forbidden.js"],unauthorized:[()=>Promise.resolve().then(c.t.bind(c,32768,23)),"next/dist/client/components/builtin/unauthorized.js"]}]}.children,I=["C:\\Users\\calvi\\Desktop\\PerfTool\\src\\app\\admin\\performances\\[id]\\page.tsx"],J={require:c,loadChunk:()=>Promise.resolve()},K=new d.AppPageRouteModule({definition:{kind:e.RouteKind.APP_PAGE,page:"/admin/performances/[id]/page",pathname:"/admin/performances/[id]",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:H},distDir:".next",relativeProjectDir:""});async function L(a,b,d){var C;let G="/admin/performances/[id]/page";"/index"===G&&(G="/");let M=(0,h.getRequestMeta)(a,"postponed"),N=(0,h.getRequestMeta)(a,"minimalMode"),O=await K.prepare(a,b,{srcPage:G,multiZoneDraftMode:!1});if(!O)return b.statusCode=400,b.end("Bad Request"),null==d.waitUntil||d.waitUntil.call(d,Promise.resolve()),null;let{buildId:P,query:Q,params:R,parsedUrl:S,pageIsDynamic:T,buildManifest:U,nextFontManifest:V,reactLoadableManifest:W,serverActionsManifest:X,clientReferenceManifest:Y,subresourceIntegrityManifest:Z,prerenderManifest:$,isDraftMode:_,resolvedPathname:aa,revalidateOnlyGenerated:ab,routerServerContext:ac,nextConfig:ad,interceptionRoutePatterns:ae}=O,af=S.pathname||"/",ag=(0,r.normalizeAppPath)(G),{isOnDemandRevalidate:ah}=O,ai=K.match(af,$),aj=!!$.routes[aa],ak=!!(ai||aj||$.routes[ag]),al=a.headers["user-agent"]||"",am=(0,u.getBotType)(al),an=(0,p.isHtmlBotRequest)(a),ao=(0,h.getRequestMeta)(a,"isPrefetchRSCRequest")??"1"===a.headers[t.NEXT_ROUTER_PREFETCH_HEADER],ap=(0,h.getRequestMeta)(a,"isRSCRequest")??!!a.headers[t.RSC_HEADER],aq=(0,s.getIsPossibleServerAction)(a),ar=(0,m.checkIsAppPPREnabled)(ad.experimental.ppr)&&(null==(C=$.routes[ag]??$.dynamicRoutes[ag])?void 0:C.renderingMode)==="PARTIALLY_STATIC",as=!1,at=!1,au=ar?M:void 0,av=ar&&ap&&!ao,aw=(0,h.getRequestMeta)(a,"segmentPrefetchRSCRequest"),ax=!al||(0,p.shouldServeStreamingMetadata)(al,ad.htmlLimitedBots);an&&ar&&(ak=!1,ax=!1);let ay=!0===K.isDev||!ak||"string"==typeof M||av,az=an&&ar,aA=null;_||!ak||ay||aq||au||av||(aA=aa);let aB=aA;!aB&&K.isDev&&(aB=aa),K.isDev||_||!ak||!ap||av||(0,k.d)(a.headers);let aC={...E,tree:H,pages:I,GlobalError:D(),handler:L,routeModule:K,__next_app__:J};X&&Y&&(0,o.setReferenceManifestsSingleton)({page:G,clientReferenceManifest:Y,serverActionsManifest:X,serverModuleMap:(0,q.createServerModuleMap)({serverActionsManifest:X})});let aD=a.method||"GET",aE=(0,g.getTracer)(),aF=aE.getActiveScopeSpan();try{let f=K.getVaryHeader(aa,ae);b.setHeader("Vary",f);let k=async(c,d)=>{let e=new l.NodeNextRequest(a),f=new l.NodeNextResponse(b);return K.render(e,f,d).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=aE.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==i.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${aD} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${aD} ${a.url}`)})},m=async({span:e,postponed:f,fallbackRouteParams:g})=>{let i={query:Q,params:R,page:ag,sharedContext:{buildId:P},serverComponentsHmrCache:(0,h.getRequestMeta)(a,"serverComponentsHmrCache"),fallbackRouteParams:g,renderOpts:{App:()=>null,Document:()=>null,pageConfig:{},ComponentMod:aC,Component:(0,j.T)(aC),params:R,routeModule:K,page:G,postponed:f,shouldWaitOnAllReady:az,serveStreamingMetadata:ax,supportsDynamicResponse:"string"==typeof f||ay,buildManifest:U,nextFontManifest:V,reactLoadableManifest:W,subresourceIntegrityManifest:Z,serverActionsManifest:X,clientReferenceManifest:Y,setIsrStatus:null==ac?void 0:ac.setIsrStatus,dir:c(33873).join(process.cwd(),K.relativeProjectDir),isDraftMode:_,isRevalidate:ak&&!f&&!av,botType:am,isOnDemandRevalidate:ah,isPossibleServerAction:aq,assetPrefix:ad.assetPrefix,nextConfigOutput:ad.output,crossOrigin:ad.crossOrigin,trailingSlash:ad.trailingSlash,previewProps:$.preview,deploymentId:ad.deploymentId,enableTainting:ad.experimental.taint,htmlLimitedBots:ad.htmlLimitedBots,devtoolSegmentExplorer:ad.experimental.devtoolSegmentExplorer,reactMaxHeadersLength:ad.reactMaxHeadersLength,multiZoneDraftMode:!1,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:ad.experimental.cacheLife,basePath:ad.basePath,serverActions:ad.experimental.serverActions,...as?{nextExport:!0,supportsDynamicResponse:!1,isStaticGeneration:!0,isRevalidate:!0,isDebugDynamicAccesses:as}:{},experimental:{isRoutePPREnabled:ar,expireTime:ad.expireTime,staleTimes:ad.experimental.staleTimes,cacheComponents:!!ad.experimental.cacheComponents,clientSegmentCache:!!ad.experimental.clientSegmentCache,clientParamParsing:!!ad.experimental.clientParamParsing,dynamicOnHover:!!ad.experimental.dynamicOnHover,inlineCss:!!ad.experimental.inlineCss,authInterrupts:!!ad.experimental.authInterrupts,clientTraceMetadata:ad.experimental.clientTraceMetadata||[]},waitUntil:d.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:()=>{},onInstrumentationRequestError:(b,c,d)=>K.onRequestError(a,b,d,ac),err:(0,h.getRequestMeta)(a,"invokeError"),dev:K.isDev}},l=await k(e,i),{metadata:m}=l,{cacheControl:n,headers:o={},fetchTags:p}=m;if(p&&(o[y.NEXT_CACHE_TAGS_HEADER]=p),a.fetchMetrics=m.fetchMetrics,ak&&(null==n?void 0:n.revalidate)===0&&!K.isDev&&!ar){let a=m.staticBailoutInfo,b=Object.defineProperty(Error(`Page changed from static to dynamic at runtime ${aa}${(null==a?void 0:a.description)?`, reason: ${a.description}`:""}
see more here https://nextjs.org/docs/messages/app-static-to-dynamic-error`),"__NEXT_ERROR_CODE",{value:"E132",enumerable:!1,configurable:!0});if(null==a?void 0:a.stack){let c=a.stack;b.stack=b.message+c.substring(c.indexOf("\n"))}throw b}return{value:{kind:v.CachedRouteKind.APP_PAGE,html:l,headers:o,rscData:m.flightData,postponed:m.postponed,status:m.statusCode,segmentData:m.segmentData},cacheControl:n}},o=async({hasResolved:c,previousCacheEntry:f,isRevalidating:g,span:i})=>{let j,k=!1===K.isDev,l=c||b.writableEnded;if(ah&&ab&&!f&&!N)return(null==ac?void 0:ac.render404)?await ac.render404(a,b):(b.statusCode=404,b.end("This page could not be found")),null;if(ai&&(j=(0,w.parseFallbackField)(ai.fallback)),j===w.FallbackMode.PRERENDER&&(0,u.isBot)(al)&&(!ar||an)&&(j=w.FallbackMode.BLOCKING_STATIC_RENDER),(null==f?void 0:f.isStale)===-1&&(ah=!0),ah&&(j!==w.FallbackMode.NOT_FOUND||f)&&(j=w.FallbackMode.BLOCKING_STATIC_RENDER),!N&&j!==w.FallbackMode.BLOCKING_STATIC_RENDER&&aB&&!l&&!_&&T&&(k||!aj)){let b;if((k||ai)&&j===w.FallbackMode.NOT_FOUND)throw new B.NoFallbackError;if(ar&&!ap){let c="string"==typeof(null==ai?void 0:ai.fallback)?ai.fallback:k?ag:null;if(b=await K.handleResponse({cacheKey:c,req:a,nextConfig:ad,routeKind:e.RouteKind.APP_PAGE,isFallback:!0,prerenderManifest:$,isRoutePPREnabled:ar,responseGenerator:async()=>m({span:i,postponed:void 0,fallbackRouteParams:k||at?(0,n.u)(ag):null}),waitUntil:d.waitUntil}),null===b)return null;if(b)return delete b.cacheControl,b}}let o=ah||g||!au?void 0:au;if(as&&void 0!==o)return{cacheControl:{revalidate:1,expire:void 0},value:{kind:v.CachedRouteKind.PAGES,html:x.default.EMPTY,pageData:{},headers:void 0,status:void 0}};let p=T&&ar&&((0,h.getRequestMeta)(a,"renderFallbackShell")||at)?(0,n.u)(af):null;return m({span:i,postponed:o,fallbackRouteParams:p})},p=async c=>{var f,g,i,j,k;let l,n=await K.handleResponse({cacheKey:aA,responseGenerator:a=>o({span:c,...a}),routeKind:e.RouteKind.APP_PAGE,isOnDemandRevalidate:ah,isRoutePPREnabled:ar,req:a,nextConfig:ad,prerenderManifest:$,waitUntil:d.waitUntil});if(_&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate"),K.isDev&&b.setHeader("Cache-Control","no-store, must-revalidate"),!n){if(aA)throw Object.defineProperty(Error("invariant: cache entry required but not generated"),"__NEXT_ERROR_CODE",{value:"E62",enumerable:!1,configurable:!0});return null}if((null==(f=n.value)?void 0:f.kind)!==v.CachedRouteKind.APP_PAGE)throw Object.defineProperty(Error(`Invariant app-page handler received invalid cache entry ${null==(i=n.value)?void 0:i.kind}`),"__NEXT_ERROR_CODE",{value:"E707",enumerable:!1,configurable:!0});let p="string"==typeof n.value.postponed;ak&&!av&&(!p||ao)&&(N||b.setHeader("x-nextjs-cache",ah?"REVALIDATED":n.isMiss?"MISS":n.isStale?"STALE":"HIT"),b.setHeader(t.NEXT_IS_PRERENDER_HEADER,"1"));let{value:q}=n;if(au)l={revalidate:0,expire:void 0};else if(N&&ap&&!ao&&ar)l={revalidate:0,expire:void 0};else if(!K.isDev)if(_)l={revalidate:0,expire:void 0};else if(ak){if(n.cacheControl)if("number"==typeof n.cacheControl.revalidate){if(n.cacheControl.revalidate<1)throw Object.defineProperty(Error(`Invalid revalidate configuration provided: ${n.cacheControl.revalidate} < 1`),"__NEXT_ERROR_CODE",{value:"E22",enumerable:!1,configurable:!0});l={revalidate:n.cacheControl.revalidate,expire:(null==(j=n.cacheControl)?void 0:j.expire)??ad.expireTime}}else l={revalidate:y.CACHE_ONE_YEAR,expire:void 0}}else b.getHeader("Cache-Control")||(l={revalidate:0,expire:void 0});if(n.cacheControl=l,"string"==typeof aw&&(null==q?void 0:q.kind)===v.CachedRouteKind.APP_PAGE&&q.segmentData){b.setHeader(t.NEXT_DID_POSTPONE_HEADER,"2");let c=null==(k=q.headers)?void 0:k[y.NEXT_CACHE_TAGS_HEADER];N&&ak&&c&&"string"==typeof c&&b.setHeader(y.NEXT_CACHE_TAGS_HEADER,c);let d=q.segmentData.get(aw);return void 0!==d?(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:x.default.fromStatic(d,t.RSC_CONTENT_TYPE_HEADER),cacheControl:n.cacheControl}):(b.statusCode=204,(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:x.default.EMPTY,cacheControl:n.cacheControl}))}let r=(0,h.getRequestMeta)(a,"onCacheEntry");if(r&&await r({...n,value:{...n.value,kind:"PAGE"}},{url:(0,h.getRequestMeta)(a,"initURL")}))return null;if(p&&au)throw Object.defineProperty(Error("Invariant: postponed state should not be present on a resume request"),"__NEXT_ERROR_CODE",{value:"E396",enumerable:!1,configurable:!0});if(q.headers){let a={...q.headers};for(let[c,d]of(N&&ak||delete a[y.NEXT_CACHE_TAGS_HEADER],Object.entries(a)))if(void 0!==d)if(Array.isArray(d))for(let a of d)b.appendHeader(c,a);else"number"==typeof d&&(d=d.toString()),b.appendHeader(c,d)}let s=null==(g=q.headers)?void 0:g[y.NEXT_CACHE_TAGS_HEADER];if(N&&ak&&s&&"string"==typeof s&&b.setHeader(y.NEXT_CACHE_TAGS_HEADER,s),!q.status||ap&&ar||(b.statusCode=q.status),!N&&q.status&&F.RedirectStatusCode[q.status]&&ap&&(b.statusCode=200),p&&b.setHeader(t.NEXT_DID_POSTPONE_HEADER,"1"),ap&&!_){if(void 0===q.rscData){if(q.postponed)throw Object.defineProperty(Error("Invariant: Expected postponed to be undefined"),"__NEXT_ERROR_CODE",{value:"E372",enumerable:!1,configurable:!0});return(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:q.html,cacheControl:av?{revalidate:0,expire:void 0}:n.cacheControl})}return(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:x.default.fromStatic(q.rscData,t.RSC_CONTENT_TYPE_HEADER),cacheControl:n.cacheControl})}let u=q.html;if(!p||N||ap)return(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:u,cacheControl:n.cacheControl});if(as)return u.push(new ReadableStream({start(a){a.enqueue(z.ENCODED_TAGS.CLOSED.BODY_AND_HTML),a.close()}})),(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:u,cacheControl:{revalidate:0,expire:void 0}});let w=new TransformStream;return u.push(w.readable),m({span:c,postponed:q.postponed,fallbackRouteParams:null}).then(async a=>{var b,c;if(!a)throw Object.defineProperty(Error("Invariant: expected a result to be returned"),"__NEXT_ERROR_CODE",{value:"E463",enumerable:!1,configurable:!0});if((null==(b=a.value)?void 0:b.kind)!==v.CachedRouteKind.APP_PAGE)throw Object.defineProperty(Error(`Invariant: expected a page response, got ${null==(c=a.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E305",enumerable:!1,configurable:!0});await a.value.html.pipeTo(w.writable)}).catch(a=>{w.writable.abort(a).catch(a=>{console.error("couldn't abort transformer",a)})}),(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:u,cacheControl:{revalidate:0,expire:void 0}})};if(!aF)return await aE.withPropagatedContext(a.headers,()=>aE.trace(i.BaseServerSpan.handleRequest,{spanName:`${aD} ${a.url}`,kind:g.SpanKind.SERVER,attributes:{"http.method":aD,"http.target":a.url}},p));await p(aF)}catch(b){throw b instanceof B.NoFallbackError||await K.onRequestError(a,b,{routerKind:"App Router",routePath:G,routeType:"render",revalidateReason:(0,f.c)({isRevalidate:ak,isOnDemandRevalidate:ah})},ac),b}}},61135:()=>{},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},67031:(a,b,c)=>{"use strict";c.r(b),c.d(b,{default:()=>d});let d=(0,c(97954).registerClientReference)(function(){throw Error("Attempted to call the default export of \"C:\\\\Users\\\\calvi\\\\Desktop\\\\PerfTool\\\\src\\\\app\\\\admin\\\\performances\\\\[id]\\\\page.tsx\" from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"C:\\Users\\calvi\\Desktop\\PerfTool\\src\\app\\admin\\performances\\[id]\\page.tsx","default")},68920:(a,b,c)=>{Promise.resolve().then(c.t.bind(c,81170,23)),Promise.resolve().then(c.t.bind(c,23597,23)),Promise.resolve().then(c.t.bind(c,36893,23)),Promise.resolve().then(c.t.bind(c,89748,23)),Promise.resolve().then(c.t.bind(c,6060,23)),Promise.resolve().then(c.t.bind(c,7184,23)),Promise.resolve().then(c.t.bind(c,69576,23)),Promise.resolve().then(c.t.bind(c,73041,23)),Promise.resolve().then(c.t.bind(c,51384,23))},69592:(a,b,c)=>{Promise.resolve().then(c.t.bind(c,54160,23)),Promise.resolve().then(c.t.bind(c,31603,23)),Promise.resolve().then(c.t.bind(c,68495,23)),Promise.resolve().then(c.t.bind(c,75170,23)),Promise.resolve().then(c.t.bind(c,77526,23)),Promise.resolve().then(c.t.bind(c,78922,23)),Promise.resolve().then(c.t.bind(c,29234,23)),Promise.resolve().then(c.t.bind(c,12263,23)),Promise.resolve().then(c.bind(c,82146))},70798:(a,b,c)=>{"use strict";c.d(b,{N:()=>d});let d=(0,c(53861).UU)("https://quqvudqzztlmgrwqudho.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1cXZ1ZHF6enRsbWdyd3F1ZGhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MzQ1NjQsImV4cCI6MjA4NDAxMDU2NH0.NwxDWyz7vQiM1r3SqMn62iLjBJQGEO1-K6qgsP74hYg")},80303:(a,b,c)=>{"use strict";c.d(b,{$:()=>g});var d=c(21124),e=c(38301),f=c(70798);function g({className:a}){let[b,c]=(0,e.useState)(!1);return(0,d.jsx)("button",{onClick:async()=>{c(!0),await f.N.auth.signOut(),c(!1)},disabled:b,className:a,children:b?"Signing out...":"Sign Out"})}},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},87060:()=>{},88281:(a,b,c)=>{"use strict";c.d(b,{AppBrand:()=>h});var d=c(21124),e=c(3991),f=c.n(e),g=c(35269);function h({href:a="/",textClassName:b="text-2xl font-bold",logoClassName:c=""}){let e=(0,d.jsxs)("div",{className:"flex items-center gap-3",children:[(0,d.jsx)(g.v,{className:`border border-white/30 bg-white/10 text-white/60 ${c}`}),(0,d.jsx)("span",{className:b,children:"Performance Tool"})]});return a?(0,d.jsx)(f(),{href:a,className:"flex items-center gap-3",children:e}):e}},92873:(a,b,c)=>{Promise.resolve().then(c.bind(c,44694))},93972:(a,b,c)=>{"use strict";c.r(b),c.d(b,{default:()=>d});let d=(0,c(97954).registerClientReference)(function(){throw Error("Attempted to call the default export of \"C:\\\\Users\\\\calvi\\\\Desktop\\\\PerfTool\\\\src\\\\app\\\\admin\\\\layout.tsx\" from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"C:\\Users\\calvi\\Desktop\\PerfTool\\src\\app\\admin\\layout.tsx","default")}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[4586,8361,1413,3861],()=>b(b.s=59530));module.exports=c})();