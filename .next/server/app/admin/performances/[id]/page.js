(()=>{var a={};a.id=670,a.ids=[670],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},948:(a,b,c)=>{"use strict";c.r(b),c.d(b,{default:()=>y});var d=c(1124),e=c(8301),f=c.n(e),g=c(3991),h=c.n(g);function i(a){let[b,c]=(0,e.useState)([]),[d,f]=(0,e.useState)(!0),[g,h]=(0,e.useState)(null),i=async(d,e)=>{if(!a)throw Error("Performance ID is required");try{let f=await Promise.all(e.map(b=>fetch("/api/rehearsals",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:a,title:d,date:b.date,time:b.time,location:b.location})})));for(let a of f)if(!a.ok)throw Error("Failed to create rehearsal");let g=await Promise.all(f.map(a=>a.json()));return c([...b,...g]),g}catch(a){throw h(a instanceof Error?a.message:"An error occurred"),a}},j=async a=>{try{if(!(await fetch(`/api/rehearsals/${a}`,{method:"DELETE"})).ok)throw Error("Failed to delete rehearsal");c(b.filter(b=>b.id!==a))}catch(a){throw h(a instanceof Error?a.message:"An error occurred"),a}};return{rehearsals:b,loading:d,error:g,createRehearsal:i,deleteRehearsal:j,updateRehearsal:async(a,b)=>{try{let d=await fetch(`/api/rehearsals/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(!d.ok)throw Error("Failed to update rehearsal");let e=await d.json();return c(b=>b.map(b=>b.id===a?e:b)),e}catch(a){throw h(a instanceof Error?a.message:"An error occurred"),a}}}}var j=c(1649);function k({onSubmit:a,isLoading:b=!1}){let[c,f]=(0,e.useState)({title:"",dateEntries:[{date:"",time:"",location:""}]}),[g,h]=(0,e.useState)(null),i=(a,b,d)=>{let e=[...c.dateEntries];e[a]={...e[a],[b]:d},f({...c,dateEntries:e})},j=async b=>{b.preventDefault(),h(null);let d=c.dateEntries.filter(a=>a.date&&a.time&&a.location);if(!c.title||0===d.length)return void h("Please fill in title and at least one complete date/time/location entry");try{await a(c.title,d),f({title:"",dateEntries:[{date:"",time:"",location:""}]})}catch(a){h(a instanceof Error?a.message:"An error occurred")}};return(0,d.jsxs)("form",{onSubmit:j,className:"space-y-4",children:[g&&(0,d.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:g}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Title *"}),(0,d.jsx)("input",{type:"text",value:c.title,onChange:a=>{f({...c,title:a.target.value})},placeholder:"e.g., Full Cast Rehearsal",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-4",children:"Schedule Dates & Times * (Each date can have different time/location)"}),(0,d.jsx)("div",{className:"space-y-4",children:c.dateEntries.map((a,b)=>(0,d.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,d.jsxs)("div",{className:"grid grid-cols-3 gap-3",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Date *"}),(0,d.jsx)("input",{type:"date",value:a.date,onChange:a=>i(b,"date",a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Time *"}),(0,d.jsx)("input",{type:"time",value:a.time,onChange:a=>i(b,"time",a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm text-gray-600 font-medium mb-1",children:"Location *"}),(0,d.jsx)("input",{type:"text",value:a.location,onChange:a=>i(b,"location",a.target.value),placeholder:"e.g., Studio A",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]})]}),c.dateEntries.length>1&&(0,d.jsx)("button",{type:"button",onClick:()=>{f({...c,dateEntries:c.dateEntries.filter((a,c)=>c!==b)})},className:"mt-2 px-3 py-1 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600",children:"Remove"})]},b))}),(0,d.jsx)("button",{type:"button",onClick:()=>{f({...c,dateEntries:[...c.dateEntries,{date:"",time:"",location:""}]})},className:"mt-3 px-4 py-2 bg-gray-300 text-gray-900 rounded-lg hover:bg-gray-400 font-medium",children:"+ Add Another Date"})]}),(0,d.jsx)("button",{type:"submit",disabled:b,className:"w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors",children:b?"Scheduling...":"Schedule Rehearsal"})]})}function l({rehearsals:a,onDelete:b,onUpdate:c}){let[f,g]=(0,e.useState)(null),[h,i]=(0,e.useState)({title:"",date:"",time:"",location:""}),j=a=>a?a.split("T")[0]:"",k=()=>{g(null)},l=async a=>{await c(a,h),g(null)};return(0,d.jsx)("div",{className:"space-y-3",children:a.map(a=>(0,d.jsxs)("div",{className:"flex justify-between items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50",children:[(0,d.jsx)("div",{className:"flex-1",children:f===a.id?(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("input",{type:"text",value:h.title,onChange:a=>i(b=>({...b,title:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,d.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,d.jsx)("input",{type:"date",value:h.date,onChange:a=>i(b=>({...b,date:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,d.jsx)("input",{type:"time",value:h.time,onChange:a=>i(b=>({...b,time:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,d.jsx)("input",{type:"text",value:h.location,onChange:a=>i(b=>({...b,location:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",placeholder:"Location"})]})]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("h3",{className:"font-semibold text-gray-900",children:a.title}),(0,d.jsxs)("div",{className:"grid grid-cols-2 text-sm text-gray-600 mt-1",children:[(0,d.jsxs)("span",{children:["\uD83D\uDCC5 ",(a=>{if(!a)return"";let b=j(a);if(b){let[a,c,d]=b.split("-").map(Number);if(a&&c&&d)return new Date(a,c-1,d).toLocaleDateString()}return new Date(a).toLocaleDateString()})(a.date)]}),(0,d.jsxs)("span",{children:["\uD83D\uDD50 ",a.time]})]}),(0,d.jsxs)("div",{className:"text-sm text-gray-600 mt-1",children:["\uD83D\uDCCD ",a.location]})]})}),(0,d.jsx)("div",{className:"flex items-center gap-2 ml-4",children:f===a.id?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("button",{onClick:()=>l(a.id),className:"px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm",children:"Save"}),(0,d.jsx)("button",{onClick:k,className:"px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm",children:"Cancel"})]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("button",{onClick:()=>(a=>{let b=j(a.date);g(a.id),i({title:a.title||"",date:b,time:a.time||"",location:a.location||""})})(a),className:"px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm",children:"Edit"}),(0,d.jsx)("button",{onClick:()=>{window.confirm("Delete this rehearsal?")&&b(a.id)},className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm",children:"Delete"})]})})]},a.id))})}function m({onSubmit:a,isLoading:b=!1}){let[c,f]=(0,e.useState)({name:"",description:"",order:0,is_group:!0}),[g,h]=(0,e.useState)("group"),[i,j]=(0,e.useState)([]),[k,l]=(0,e.useState)(null),m=a=>{f({...c,[a.target.name]:"number"===a.target.type?Number(a.target.value):a.target.value})},n=async b=>{if(b.preventDefault(),l(null),!c.name)return void l("Part name is required");try{let b="group"===g,d=i.map(a=>({title:a.title.trim(),notes:a.notes.trim()})).filter(a=>a.title.length>0);if(!b&&0===d.length)return void l("Add at least one subpart for this part.");let e=await a(c.name,c.description,c.order,b);b||await Promise.all(d.map(a=>fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:e.id,title:a.title,description:a.notes||null,mode:"position"})}))),f({name:"",description:"",order:0,is_group:!0}),h("group"),j([])}catch(a){l(a instanceof Error?a.message:"An error occurred")}};return(0,d.jsxs)("form",{onSubmit:n,className:"space-y-4",children:[k&&(0,d.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:k}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Part Name *"}),(0,d.jsx)("input",{type:"text",name:"name",value:c.name,onChange:m,placeholder:"e.g., Lead Dancers, Background Chorus",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Description"}),(0,d.jsx)("textarea",{name:"description",value:c.description,onChange:m,placeholder:"Details about this part/choreography...",rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,d.jsx)("input",{type:"radio",checked:"group"===g,onChange:()=>h("group"),className:"h-4 w-4"}),"Group part"]}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,d.jsx)("input",{type:"radio",checked:"subparts"===g,onChange:()=>h("subparts"),className:"h-4 w-4"}),"Part with subparts / solos"]}),"subparts"===g&&(0,d.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2",children:[(0,d.jsx)("div",{className:"text-sm font-semibold text-gray-700",children:"Subparts"}),0===i.length&&(0,d.jsx)("div",{className:"text-xs text-gray-500",children:"Add at least one subpart."}),(0,d.jsx)("div",{className:"space-y-2",children:i.map((a,b)=>(0,d.jsxs)("div",{className:"border border-gray-200 rounded p-2",children:[(0,d.jsx)("input",{type:"text",value:a.title,onChange:a=>{let c=[...i];c[b]={...c[b],title:a.target.value},j(c)},placeholder:`Subpart ${b+1} title`,className:"w-full px-2 py-1 border border-gray-300 rounded text-sm mb-2"}),(0,d.jsx)("textarea",{value:a.notes,onChange:a=>{let c=[...i];c[b]={...c[b],notes:a.target.value},j(c)},placeholder:"Notes",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(0,d.jsx)("button",{type:"button",onClick:()=>j(i.filter((a,c)=>c!==b)),className:"mt-2 text-xs text-red-600 hover:text-red-800",children:"Remove"})]},`subpart-${b}`))}),(0,d.jsx)("button",{type:"button",onClick:()=>j([...i,{title:"",notes:""}]),className:"px-2 py-1 bg-blue-600 text-white rounded text-xs",children:"Add Subpart"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Order"}),(0,d.jsx)("input",{type:"number",name:"order",value:c.order,onChange:m,min:"0",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsx)("button",{type:"submit",disabled:b,className:"w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors",children:b?"Adding...":"Add Part"})]})}function n({parts:a,performanceId:b,onDelete:c,onReorder:f,onSelect:g,selectedPartId:h,variant:i="manage",enableDrag:j=!0,showPositionedNames:k=!0}){let[l,m]=(0,e.useState)(null),[n,o]=(0,e.useState)(""),[p,q]=(0,e.useState)(""),[r,s]=(0,e.useState)(""),[t,u]=(0,e.useState)(""),[v,w]=(0,e.useState)(""),[x,y]=(0,e.useState)(""),[z,A]=(0,e.useState)(!0),[B,C]=(0,e.useState)({}),[D,E]=(0,e.useState)({}),[F,G]=(0,e.useState)(null),[H,I]=(0,e.useState)({}),[J,K]=(0,e.useState)({}),[L,M]=(0,e.useState)({}),[N,O]=(0,e.useState)({}),[P,Q]=(0,e.useState)({}),[R,S]=(0,e.useState)({}),[T,U]=(0,e.useState)({}),[V,W]=(0,e.useState)(null),[X,Y]=(0,e.useState)(""),[Z,$]=(0,e.useState)(""),[_,aa]=(0,e.useState)(""),[ab,ac]=(0,e.useState)(""),[ad,ae]=(0,e.useState)(""),[af,ag]=(0,e.useState)(""),[ah,ai]=(0,e.useState)(null),[aj,ak]=(0,e.useState)(null),al=a=>{if(null==a||""===a)return{min:"",sec:""};let b=Number(a);if(!Number.isFinite(b))return{min:"",sec:""};let c=Math.floor(b/60),d=Math.floor(b%60);return{min:String(c),sec:String(d)}},am=(a,b)=>{if(!a&&!b)return null;let c=a?parseInt(a,10):0,d=b?parseFloat(b):0;return Number.isNaN(c)||Number.isNaN(d)?null:60*c+d},an=a=>{if(null==a||""===a)return"--:--";let b=Number(a);if(!Number.isFinite(b))return"--:--";let c=Math.floor(b/60),d=Math.floor(b%60);return`${c}:${d.toString().padStart(2,"0")}`},ao=async a=>{try{let b=await fetch(`/api/stage-positions?partId=${a}`),c=await b.json();C(b=>({...b,[a]:c.length})),E(b=>({...b,[a]:c.map(a=>a.student_name||"Unknown")}))}catch(a){console.error("Error fetching positions:",a)}},ap=async a=>{try{let b=await fetch(`/api/subparts?partId=${a}`);if(!b.ok)throw Error("Failed to fetch subparts");let c=await b.json();I(b=>({...b,[a]:c||[]}))}catch(a){console.error("Error fetching subparts:",a)}},aq=async a=>{let b=(J[a]||"").trim(),c=(L[a]||"").trim(),d=am(N[a]||"",P[a]||""),e=am(R[a]||"",T[a]||"");if(b)try{let f=await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:a,title:b,description:c||null,mode:"position",timepoint_seconds:d,timepoint_end_seconds:e})});if(!f.ok){let a=await f.json().catch(()=>null);throw Error(a?.details||a?.error||"Failed to create subpart")}await ap(a),K(b=>({...b,[a]:""})),M(b=>({...b,[a]:""})),O(b=>({...b,[a]:""})),Q(b=>({...b,[a]:""})),S(b=>({...b,[a]:""})),U(b=>({...b,[a]:""}))}catch(a){console.error("Error creating subpart:",a)}},ar=async(a,b)=>{try{if(!(await fetch(`/api/subparts/${a}`,{method:"DELETE"})).ok)throw Error("Failed to delete subpart");await ap(b)}catch(a){console.error("Error deleting subpart:",a)}},as=()=>{W(null),Y(""),$(""),aa(""),ac(""),ae(""),ag("")},at=async(a,b)=>{try{let c=await fetch(`/api/subparts/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:X,description:Z,timepoint_seconds:am(_,ab),timepoint_end_seconds:am(ad,af)})});if(!c.ok){let a=await c.json().catch(()=>null);throw Error(a?.details||a?.error||"Failed to update subpart")}await ap(b),as()}catch(a){console.error("Error updating subpart:",a)}},au=async(a,b,c)=>{if(c<0||c>=(H[a]?.length||0))return;let d=[...H[a]||[]],[e]=d.splice(b,1);d.splice(c,0,e),I(b=>({...b,[a]:d}));try{await Promise.all(d.map((a,b)=>fetch(`/api/subparts/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:b+1})})))}catch(b){console.error("Error reordering subparts:",b),await ap(a)}},av=async a=>{try{let b=await fetch(`/api/parts/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,description:p,timepoint_seconds:am(r,t),timepoint_end_seconds:am(v,x),is_group:z})});if(!b.ok){let a=await b.json();throw console.error("API Error:",a),Error(a.details||"Failed to update part")}m(null)}catch(a){console.error("Error updating part:",a),alert(`Error updating part: ${a instanceof Error?a.message:String(a)}`)}},aw=async(b,c)=>{if(c<0||c>=a.length)return;let d=[...a],[e]=d.splice(b,1);d.splice(c,0,e);try{let a=d.map((a,b)=>fetch(`/api/parts/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:b+1})}));if(!(await Promise.all(a)).every(a=>a.ok))throw Error("Some updates failed");let b=d.map((a,b)=>({...a,order:b+1}));f&&f(b)}catch(a){console.error("Error reordering parts:",a)}};return(0,d.jsx)("div",{className:"space-y-3",children:a.map((b,e)=>(0,d.jsx)("div",{draggable:j,onDragStart:()=>G(b.id),onDragOver:a=>{j&&a.preventDefault()},onDrop:()=>{if(j&&F&&F!==b.id)aw(a.findIndex(a=>a.id===F),a.findIndex(a=>a.id===b.id)),G(null)},onClick:()=>g?.(b.id),className:`p-4 border rounded-lg hover:bg-gray-50 ${j?"cursor-move":""} ${h===b.id?"border-blue-500 bg-blue-50":"border-gray-200"}`,children:l===b.id?(0,d.jsxs)("div",{className:"space-y-3",children:[(0,d.jsx)("input",{type:"text",value:n,onChange:a=>o(a.target.value),placeholder:"Part name",className:"w-full px-3 py-2 border border-gray-300 rounded-lg"}),(0,d.jsx)("textarea",{value:p,onChange:a=>q(a.target.value),placeholder:"Part description (optional)",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",rows:2}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,d.jsx)("input",{type:"checkbox",checked:z,onChange:a=>A(a.target.checked),className:"h-4 w-4"}),"Group part (unchecked = has subparts/solos)"]}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-xs font-semibold text-gray-700 mb-1",children:"Start Time (m / s)"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:r,onChange:a=>s(a.target.value),placeholder:"min",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:t,onChange:a=>u(a.target.value),placeholder:"sec",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-xs font-semibold text-gray-700 mb-1",children:"End Time (m / s)"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:v,onChange:a=>w(a.target.value),placeholder:"min",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:x,onChange:a=>y(a.target.value),placeholder:"sec",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]})]})]}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{onClick:()=>av(b.id),className:"px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm",children:"Save"}),(0,d.jsx)("button",{onClick:()=>m(null),className:"px-3 py-1 bg-gray-400 text-white rounded hover:bg-gray-500 text-sm",children:"Cancel"})]})]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{className:"flex justify-between items-start mb-3",children:[(0,d.jsxs)("div",{className:"flex-1",children:[(0,d.jsx)("h3",{className:"font-bold text-gray-900",children:b.name}),b.description&&(0,d.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:b.description}),(0,d.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:!1===b.is_group?"Subparts/Solos":"Group"})]}),"manage"===i&&(0,d.jsxs)("div",{className:"flex gap-2 ml-4",children:[(0,d.jsx)("button",{onClick:()=>aw(e,e-1),disabled:0===e,className:"px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 text-sm",title:"Move up",children:"↑"}),(0,d.jsx)("button",{onClick:()=>aw(e,e+1),disabled:e===a.length-1,className:"px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 text-sm",title:"Move down",children:"↓"})]})]}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm mb-3",children:[(0,d.jsxs)("div",{className:"bg-blue-50 p-2 rounded",children:[(0,d.jsx)("span",{className:"text-gray-600",children:"Positioned:"}),(0,d.jsx)("span",{className:"font-bold text-blue-600 ml-2",children:B[b.id]??"-"})]}),(0,d.jsxs)("div",{className:"bg-purple-50 p-2 rounded",children:[(0,d.jsx)("span",{className:"text-gray-600",children:"Order:"}),(0,d.jsx)("span",{className:"font-bold text-purple-600 ml-2",children:b.order})]})]}),"manage"===i&&(void 0!==b.timepoint_seconds||void 0!==b.timepoint_end_seconds)&&(0,d.jsxs)("div",{className:"bg-amber-50 p-2 rounded mb-3 text-sm",children:[(0,d.jsx)("span",{className:"text-gray-600",children:"Music Timepoint:"}),(0,d.jsxs)("span",{className:"font-bold text-amber-700 ml-2",children:[an(b.timepoint_seconds)," - ",an(b.timepoint_end_seconds)]})]}),k&&D[b.id]?.length>0&&(0,d.jsx)("div",{className:"bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:D[b.id].join(", ")}),H[b.id]?.length>0&&(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:[(0,d.jsx)("div",{className:"font-semibold text-gray-600 mb-1",children:"Subparts / Solos"}),(0,d.jsx)("div",{className:"space-y-1",children:H[b.id].map(a=>(0,d.jsx)("div",{className:`flex items-start justify-between gap-2 ${"manage"===i?"cursor-move":""}`,draggable:"manage"===i,onDragStart:()=>{ai(a.id),ak(b.id)},onDragOver:a=>{"manage"===i&&a.preventDefault()},onDrop:()=>{if("manage"!==i||!ah||aj!==b.id)return;let c=H[b.id].findIndex(a=>a.id===ah),d=H[b.id].findIndex(b=>b.id===a.id);au(b.id,c,d),ai(null),ak(null)},children:V===a.id?(0,d.jsxs)("div",{className:"w-full space-y-2",children:[(0,d.jsx)("input",{type:"text",value:X,onChange:a=>Y(a.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsx)("textarea",{value:Z,onChange:a=>$(a.target.value),rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:_,onChange:a=>aa(a.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:ab,onChange:a=>ac(a.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()})]}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:ad,onChange:a=>ae(a.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:af,onChange:a=>ag(a.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()})]}),(0,d.jsxs)("select",{value:a.mode||"position",onChange:c=>fetch(`/api/subparts/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:c.target.value})}).then(()=>ap(b.id)),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation(),children:[(0,d.jsx)("option",{value:"position",children:"Position"}),(0,d.jsx)("option",{value:"order",children:"Order"}),(0,d.jsx)("option",{value:"both",children:"Both"})]}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{onClick:c=>{c.stopPropagation(),at(a.id,b.id)},className:"px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700",children:"Save"}),(0,d.jsx)("button",{onClick:a=>{a.stopPropagation(),as()},className:"px-2 py-1 bg-gray-400 text-white rounded text-xs hover:bg-gray-500",children:"Cancel"})]})]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"font-medium text-gray-800",children:a.title}),a.description&&(0,d.jsx)("div",{className:"text-gray-500",children:a.description}),a.mode&&(0,d.jsxs)("div",{className:"text-gray-400 text-[10px] mt-1",children:["Mode: ",a.mode]}),(0,d.jsxs)("div",{className:"text-gray-400 text-[10px] mt-1",children:["Time: ",an(a.timepoint_seconds)," - ",an(a.timepoint_end_seconds)]})]}),(0,d.jsx)("div",{className:"flex items-center gap-2",children:(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("button",{onClick:b=>{b.stopPropagation();W(a.id),Y(a.title),$(a.description||"");let c=al(a.timepoint_seconds),d=al(a.timepoint_end_seconds);aa(c.min),ac(c.sec),ae(d.min),ag(d.sec)},className:"text-[10px] text-blue-600 hover:text-blue-800",children:"Edit"}),(0,d.jsx)("button",{onClick:c=>{c.stopPropagation(),ar(a.id,b.id)},className:"text-[10px] text-red-600 hover:text-red-800",children:"Remove"})]})})]})},a.id))})]}),(0,d.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 mb-3",children:[(0,d.jsx)("div",{className:"font-semibold text-gray-600 mb-1",children:"Add Subpart"}),(0,d.jsx)("input",{type:"text",value:J[b.id]||"",onChange:a=>K(c=>({...c,[b.id]:a.target.value})),placeholder:"Subpart title",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2",onClick:a=>a.stopPropagation()}),(0,d.jsx)("textarea",{value:L[b.id]||"",onChange:a=>M(c=>({...c,[b.id]:a.target.value})),placeholder:"Description",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2",onClick:a=>a.stopPropagation()}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:N[b.id]||"",onChange:a=>O(c=>({...c,[b.id]:a.target.value})),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:P[b.id]||"",onChange:a=>Q(c=>({...c,[b.id]:a.target.value})),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()})]}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:R[b.id]||"",onChange:a=>S(c=>({...c,[b.id]:a.target.value})),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:T[b.id]||"",onChange:a=>U(c=>({...c,[b.id]:a.target.value})),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",onClick:a=>a.stopPropagation()})]}),(0,d.jsx)("button",{onClick:a=>{a.stopPropagation(),aq(b.id)},className:"px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700",children:"Add"})]}),"manage"===i&&(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{onClick:()=>(a=>{m(a.id),o(a.name),q(a.description||"");let b=al(a.timepoint_seconds),c=al(a.timepoint_end_seconds);s(b.min),u(b.sec),w(c.min),y(c.sec),A(!1!==a.is_group)})(b),className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm",children:"Edit"}),(0,d.jsx)("button",{onClick:()=>ao(b.id),className:"px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm",children:"Refresh Count"}),(0,d.jsx)("button",{onClick:()=>{window.confirm("Delete this part?")&&c(b.id)},className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm",children:"Delete"})]})]})},b.id))})}var o=c(5269);function p({performanceId:a}){let[b,c]=(0,e.useState)([]),[f,g]=(0,e.useState)(!0),[h,j]=(0,e.useState)(null),[k,l]=(0,e.useState)(!1),[m,n]=(0,e.useState)(""),[p,q]=(0,e.useState)(""),[r,s]=(0,e.useState)(!1),[t,u]=(0,e.useState)([]),[v,w]=(0,e.useState)([]),[x,y]=(0,e.useState)([]),[z,A]=(0,e.useState)([]),[B,C]=(0,e.useState)(!1),[D,E]=(0,e.useState)(""),{rehearsals:F}=i(a),G=(0,e.useCallback)(async()=>{try{g(!0);let b=await fetch(`/api/performances/${a}/roster`);if(!b.ok)throw Error("Failed to fetch roster");let d=await b.json();c(d)}catch(a){console.error("Error fetching roster:",a),j(a instanceof Error?a.message:"Failed to load roster")}finally{g(!1)}},[a]);(0,e.useCallback)(async()=>{if(a)try{C(!0);let b=await fetch(`/api/rehearsal-attendance?performanceId=${a}`);if(!b.ok){let a=await b.text();throw console.error("Attendance fetch failed:",b.status,a),Error("Failed to fetch attendance")}let c=await b.json();A(c)}catch(a){console.error("Error fetching attendance:",a)}finally{C(!1)}},[a]),(0,e.useCallback)(async()=>{try{let a=await fetch("/api/students");if(!a.ok)throw Error("Failed to fetch students");let b=await a.json();y(b)}catch(a){console.error("Error fetching students:",a)}},[]);let H=async a=>{try{if(!(await fetch(`/api/signups/${a}`,{method:"DELETE"})).ok)throw Error("Failed to remove student");c(b.filter(b=>b.signup_id!==a))}catch(a){console.error("Error removing student:",a),j(a instanceof Error?a.message:"Failed to remove student")}},I=a=>{w(b=>[...b,a]),n(""),q("")},J=async b=>{b.preventDefault();let c=m.trim().length>0?[...t,m.trim()]:[...t];if(0===c.length&&0===v.length)return void j("Please enter at least one name");s(!0);try{for(let b of v)if(!(await fetch("/api/signups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:a,student_id:b.id,status:"registered"})})).ok)throw Error("Failed to add to roster");for(let b of c){let c=await fetch("/api/students",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:b,email:p.trim()?p.trim():null})});if(!c.ok)throw Error("Failed to create student");let d=await c.json();if(!(await fetch("/api/signups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:a,student_id:d.id,status:"registered"})})).ok)throw Error("Failed to add to roster")}n(""),q(""),u([]),w([]),l(!1),await G()}catch(a){j(a instanceof Error?a.message:"Failed to add student")}finally{s(!1)}},K=(0,e.useMemo)(()=>{let a=new Map;for(let b of z)a.set(`${b.rehearsal_id}:${b.student_id}`,b);return a},[z]),L=(0,e.useCallback)(a=>a?a.split("T")[0]:"",[]),M=(0,e.useCallback)(a=>{let b=L(a);if(!b)return new Date(a);let[c,d,e]=b.split("-").map(Number);return new Date(c,(d||1)-1,e||1)},[L]),N=(0,e.useMemo)(()=>[...F].sort((a,b)=>M(a.date).getTime()-M(b.date).getTime()),[F,M]),O=a=>M(a).toLocaleDateString(void 0,{month:"numeric",day:"numeric"}),P=(0,e.useMemo)(()=>new Set(b.map(a=>a.student_id)),[b]),Q=(0,e.useMemo)(()=>new Set(v.map(a=>a.id)),[v]),R=(0,e.useMemo)(()=>{let a=m.trim().toLowerCase();return a?x.filter(b=>!(P.has(b.id)||Q.has(b.id))&&b.name.toLowerCase().includes(a)).slice(0,8):[]},[x,m,P,Q]),S=async(a,b,c)=>{if(c)return;let d=`${a}:${b}`,e=K.get(d);try{if(!e){let c=await fetch("/api/rehearsal-attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rehearsal_id:a,student_id:b,status:"present"})});if(!c.ok)throw Error("Failed to save attendance");let d=await c.json();A(a=>[...a,d]);return}if("present"===e.status){let c=await fetch("/api/rehearsal-attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rehearsal_id:a,student_id:b,status:"absent"})});if(!c.ok)throw Error("Failed to save attendance");let d=await c.json();A(a=>a.map(a=>a.id===d.id?d:a));return}if(!(await fetch(`/api/rehearsal-attendance?rehearsalId=${a}&studentId=${b}`,{method:"DELETE"})).ok)throw Error("Failed to clear attendance");A(c=>c.filter(c=>c.rehearsal_id!==a||c.student_id!==b))}catch(a){console.error("Error updating attendance:",a),j(a instanceof Error?a.message:"Failed to update attendance")}};return f?(0,d.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,d.jsx)("p",{className:"text-gray-500",children:"Loading roster..."})}):(0,d.jsx)("div",{className:"h-full flex flex-col",children:(0,d.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[(0,d.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)(o.v,{size:22,className:"border border-gray-200 bg-white text-gray-400"}),(0,d.jsxs)("h3",{className:"font-semibold text-gray-900",children:["Roster (",b.length,")"]})]}),(0,d.jsx)("button",{onClick:()=>l(!k),className:"px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700",children:k?"Cancel":"+ Add"})]}),N.length>0&&(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mb-3 text-xs text-gray-600",children:[(0,d.jsx)("span",{children:"Attendance:"}),(0,d.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,d.jsx)("span",{className:"h-3 w-3 rounded bg-green-500 inline-block"}),"Present"]}),(0,d.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,d.jsx)("span",{className:"h-3 w-3 rounded bg-red-500 inline-block"}),"Missed"]}),(0,d.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,d.jsx)("span",{className:"h-3 w-3 rounded bg-gray-300 inline-block"}),"Pending"]}),(0,d.jsx)("span",{className:"text-gray-500",children:"Click boxes to toggle."})]}),h&&(0,d.jsx)("div",{className:"bg-yellow-100 border border-yellow-400 text-yellow-700 px-3 py-2 rounded mb-4 text-sm",children:h}),k&&(0,d.jsxs)("form",{onSubmit:J,className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg space-y-2",children:[(0,d.jsxs)("div",{className:"relative",children:[(0,d.jsx)("input",{type:"text",value:m,onChange:a=>n(a.target.value),onKeyDown:a=>{if("Enter"===a.key){a.preventDefault();let b=R.find(a=>a.name.toLowerCase()===m.trim().toLowerCase());if(b)return void I(b);let c=m.trim();c&&(u(a=>[...a,c]),n(""),q(""))}},placeholder:"Name (press Enter to add)",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),R.length>0&&(0,d.jsx)("div",{className:"absolute z-10 mt-1 w-full rounded border border-gray-200 bg-white shadow-sm text-sm",children:R.map(a=>(0,d.jsxs)("button",{type:"button",onClick:()=>I(a),className:"w-full text-left px-2 py-1 hover:bg-blue-50",children:[(0,d.jsx)("span",{className:"font-medium text-gray-900",children:a.name}),a.email&&(0,d.jsxs)("span",{className:"text-gray-500",children:[" • ",a.email]})]},a.id))})]}),(0,d.jsx)("input",{type:"email",value:p,onChange:a=>q(a.target.value),placeholder:"Email (optional)",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(t.length>0||v.length>0)&&(0,d.jsxs)("div",{className:"flex flex-wrap gap-2",children:[v.map(a=>(0,d.jsxs)("span",{className:"inline-flex items-center gap-1 bg-green-50 border border-green-200 text-green-800 px-2 py-1 rounded text-xs",children:[a.name,(0,d.jsx)("button",{type:"button",onClick:()=>{var b;return b=a.id,void w(a=>a.filter(a=>a.id!==b))},className:"text-green-800 hover:text-green-900","aria-label":`Remove ${a.name}`,children:"\xd7"})]},a.id)),t.map((a,b)=>(0,d.jsxs)("span",{className:"inline-flex items-center gap-1 bg-white border border-blue-200 text-blue-700 px-2 py-1 rounded text-xs",children:[a,(0,d.jsx)("button",{type:"button",onClick:()=>{u(a=>a.filter((a,c)=>c!==b))},className:"text-blue-700 hover:text-blue-900","aria-label":`Remove ${a}`,children:"\xd7"})]},`${a}-${b}`))]}),(0,d.jsx)("button",{type:"submit",disabled:r,className:"w-full px-2 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400",children:r?"Adding...":"Add to Roster"})]}),0===b.length?(0,d.jsx)("p",{className:"text-gray-500 text-sm",children:"No students registered yet"}):(0,d.jsx)("div",{className:"space-y-2",children:b.map(a=>(0,d.jsxs)("div",{className:"bg-gray-50 p-2 rounded-md border border-gray-200 flex justify-between items-start group",children:[(0,d.jsxs)("div",{className:"flex-1",children:[(0,d.jsx)("p",{className:"font-medium text-gray-900 text-xs",children:a.name}),a.email&&(0,d.jsx)("p",{className:"text-gray-600 text-[10px]",children:a.email}),a.part_name&&(0,d.jsx)("div",{className:"mt-1",children:(0,d.jsx)("span",{className:"inline-block bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-medium",children:a.part_name})}),N.length>0&&(0,d.jsxs)("div",{className:"mt-1 flex flex-wrap gap-1",children:[D&&(0,d.jsxs)("div",{title:`Performance \xe2€\xa2 ${M(D).toLocaleDateString()}`,className:"h-7 w-9 border bg-gray-200 text-gray-700 border-gray-300 text-[9px] leading-tight rounded flex flex-col items-center justify-center font-semibold opacity-90",children:[(0,d.jsx)("span",{children:O(D)}),(0,d.jsx)("span",{children:"P"})]}),N.map(b=>{let c=K.get(`${b.id}:${a.student_id}`),e=(a=>{let b=M(a.date),c=new Date,d=new Date(c.getFullYear(),c.getMonth(),c.getDate());return b.getTime()>d.getTime()})(b),f=c?.status??"pending";return(0,d.jsxs)("button",{type:"button",onClick:()=>S(b.id,a.student_id,e),disabled:B,title:`${b.title} • ${M(b.date).toLocaleDateString()} ${b.time}`,className:`h-7 w-9 border text-[9px] leading-tight rounded flex flex-col items-center justify-center font-semibold ${"present"===f?"bg-green-500 text-white border-green-600":"absent"===f?"bg-red-500 text-white border-red-600":"bg-gray-300 text-gray-700 border-gray-400"} ${e?"opacity-70 cursor-not-allowed":"hover:opacity-90"}`,children:[(0,d.jsx)("span",{children:O(b.date)}),(0,d.jsx)("span",{children:"R"})]},b.id)})]})]}),(0,d.jsx)("button",{onClick:()=>H(a.signup_id),className:"ml-2 px-2 py-0.5 bg-red-500 text-white rounded text-[10px] opacity-0 group-hover:opacity-100 hover:bg-red-600 transition-opacity",title:"Remove from roster",children:"Remove"})]},a.signup_id))})]})})}function q(a,b){if(!a||0===a.length)return"?";let c=a.charAt(0).toUpperCase();return b.filter(b=>b!==a&&b.charAt(0).toUpperCase()===c).length>0?a.slice(0,2).toUpperCase():c}function r({performanceId:a,partId:b,partName:c=null,partDescription:g=null,isGroup:h=!0,onSavePositions:i}){let[j,k]=(0,e.useState)([]),[l,m]=(0,e.useState)([]),[n,p]=(0,e.useState)(null),[r,s]=(0,e.useState)(!1),[t,u]=(0,e.useState)(!0),[v,w]=(0,e.useState)(!1),[x,y]=(0,e.useState)(null),[z,A]=(0,e.useState)("bottom"),[B,C]=(0,e.useState)(Date.now());f().useRef(null);let D=f().useRef(!1),[E,F]=(0,e.useState)([]),[G,H]=(0,e.useState)(null),[I,J]=(0,e.useState)({}),[K,L]=(0,e.useState)({}),[M,N]=(0,e.useState)(null),[O,P]=(0,e.useState)(!1),[Q,R]=(0,e.useState)(c||""),[S,T]=(0,e.useState)(!1),[U,V]=(0,e.useState)(!1),[W,X]=(0,e.useState)(g||""),[Y,Z]=(0,e.useState)(!1),[$,_]=(0,e.useState)([]),[aa,ab]=(0,e.useState)(""),[ac,ad]=(0,e.useState)(!1),[ae,af]=(0,e.useState)(!1);(0,e.useCallback)(async()=>{try{let a=await fetch(`/api/subparts?partId=${b}`);if(a.ok){let b=await a.json();F(b||[]),0===(b||[]).length&&H(null)}}catch(a){console.error("Error fetching subparts:",a)}},[b]);let ag=(a,b=!1)=>{p(a),s(b)},ah=a=>{a.preventDefault(),a.dataTransfer.dropEffect="move"},ai=(a,b)=>Number.isNaN(a)||a<0?0:a>b?b:a,aj=async(a,b,c)=>{if(a.preventDefault(),!n||E.length>0&&!as)return;let d=j.find(a=>a.student_id===n);if(r&&!d){let a=l.find(a=>a.student_id===n);a&&(d={student_id:n,name:a.name,part_name:null})}if(!d)return;let e=[...(G&&E.length>0?I[G]||[]:l).filter(a=>a.student_id!==n),{student_id:n,name:d.name,x:"top"===z?11-b:b,y:"top"===z?8-c:c}];G&&E.length>0?(J(a=>({...a,[G]:e})),await an(e,K[G]||[])):m(e),D.current=!0,p(null),s(!1)},ak=async()=>{try{if(w(!0),G&&E.length>0){let a=(I[G]||[]).map(a=>({subpart_id:G,student_id:a.student_id,x:a.x,y:a.y}));await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:G,positions:a})})}else await i(l);await fetch(`/api/performances/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({stage_orientation:z})}),y(null)}catch(a){y(a instanceof Error?a.message:"Failed to save positions")}finally{w(!1)}},al=(0,e.useCallback)(async a=>{G&&(L(b=>({...b,[G]:a})),await fetch("/api/subpart-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a.map((a,b)=>({subpart_id:G,student_id:a.student_id,order:b+1})))}))},[G]),am=async(a,b)=>{if(!G)return;let c=[...au,{id:`temp-${Date.now()}`,student_id:a,student_name:b}];await al(c)},an=(0,e.useCallback)(async(a,b)=>{if(!G)return;let c=new Set(b.map(a=>a.student_id)),d=a.filter(a=>a.student_id&&!c.has(a.student_id)).map(a=>({id:`temp-${Date.now()}-${a.student_id}`,student_id:a.student_id,student_name:a.name}));if(0===d.length)return;let e=[...b,...d];await al(e)},[al,G]),ao=async()=>{if(!aa)return[];let[a,b]=aa.split(":");if(!b)return[];let c="subpart"===a?`/api/subpart-positions?subpartId=${b}`:`/api/stage-positions?partId=${b}`,d=await fetch(c);if(!d.ok)throw Error(await d.text()||"Failed to fetch source positions");return(await d.json()||[]).map(a=>({student_id:a.student_id||"",name:a.student_name||"Unknown",x:a.x,y:a.y}))},ap=async()=>{if(aa){af(!0);try{let a=(await ao()).map(a=>{let b=ac?11-a.x:a.x;return{...a,x:ai(b,11),y:ai(a.y,8)}});G&&E.length>0?(J(b=>({...b,[G]:a})),await an(a,K[G]||[]),await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:G,positions:a.map(a=>({subpart_id:G,student_id:a.student_id,x:a.x,y:a.y}))})})):(m(a),await i(a)),D.current=!1,C(Date.now()),y(null)}catch(a){y(a instanceof Error?a.message:"Failed to apply positions")}finally{af(!1)}}},aq=E.find(a=>a.id===G),ar=aq?.mode||"position",as=0===E.length||"order"!==ar,at=E.length>0,au=G&&K[G]||[],av=G&&E.length>0?I[G]||[]:l,aw=new Set(av.map(a=>a.student_id)),ax=new Map;av.forEach(a=>{ax.has(a.student_id)||ax.set(a.student_id,a)});let ay=Array.from(ax.values()).map(a=>({student_id:a.student_id,name:a.name,initials:q(a.name,Array.from(ax.values()).map(a=>a.name))}));return t?(0,d.jsx)("div",{className:"text-center py-8",children:"Loading..."}):(0,d.jsxs)("div",{className:"space-y-6",children:[x&&(0,d.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:x}),(0,d.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-[220px_1fr] gap-6",children:[(0,d.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,d.jsxs)("h3",{className:"font-semibold text-gray-900 mb-2",children:["Students (",j.length,")"]}),(0,d.jsx)("p",{className:"text-[11px] text-gray-500 mb-3",children:"Positioned students stay here so you can assign them to subparts."}),(0,d.jsx)("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:0===j.length?(0,d.jsx)("p",{className:"text-gray-500 text-sm",children:"No students yet."}):j.map(a=>{let b=aw.has(a.student_id);return(0,d.jsxs)("div",{draggable:!0,onDragStart:()=>ag(a.student_id,!1),className:`p-3 rounded border cursor-move hover:shadow-md transition-all ${b?"bg-emerald-50 border-emerald-200 hover:border-emerald-300":"bg-white border-blue-200 hover:border-blue-400"}`,children:[(0,d.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,d.jsx)("p",{className:"font-medium text-sm text-gray-900",children:a.name}),b&&(0,d.jsx)("span",{className:"text-[10px] px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 font-semibold",children:"Positioned"})]}),a.part_name&&(0,d.jsx)("p",{className:"text-xs text-gray-600",children:a.part_name})]},a.student_id)})}),at&&G&&(0,d.jsxs)("div",{className:"mt-4 border-t border-gray-200 pt-4",children:[(0,d.jsx)("h4",{className:"font-medium text-gray-900 mb-2 text-sm",children:"Assigned Students"}),(0,d.jsx)("p",{className:"text-[11px] text-gray-500 mb-2",children:"Drag students here to assign them to this subpart."}),(0,d.jsx)("div",{className:"bg-white p-2 rounded border border-gray-200",onDragOver:a=>a.preventDefault(),onDrop:async()=>{if(!n)return;let a=j.find(a=>a.student_id===n);a&&await am(a.student_id,a.name)},children:(0,d.jsx)("div",{className:"space-y-2",children:0===au.length?(0,d.jsx)("div",{className:"text-xs text-gray-500 border border-dashed border-gray-300 rounded p-2 text-center",children:"Drop students here"}):au.map((a,b)=>(0,d.jsxs)("div",{draggable:!0,onDragStart:()=>N(a.id),onDragOver:a=>a.preventDefault(),onDrop:async()=>{if(!M)return;let b=au.findIndex(a=>a.id===M),c=au.findIndex(b=>b.id===a.id);if(b<0||c<0)return;let d=[...au],[e]=d.splice(b,1);d.splice(c,0,e),await al(d),N(null)},className:"flex items-center justify-between bg-gray-50 border border-gray-200 rounded px-2 py-1",children:[(0,d.jsxs)("div",{className:"text-xs text-gray-900",children:[(0,d.jsxs)("span",{className:"text-gray-500 mr-1",children:[b+1,"."]}),a.student_name]}),(0,d.jsx)("button",{onClick:async()=>{let b=au.filter(b=>b.id!==a.id);await al(b)},className:"text-[10px] text-red-600 hover:text-red-800",children:"Remove"})]},a.id))})})]})]}),(0,d.jsx)("div",{children:(0,d.jsxs)("div",{className:"space-y-4",children:[(0,d.jsxs)("div",{className:"flex flex-wrap items-start justify-between gap-3 mb-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)(o.v,{size:24,className:"border border-gray-200 bg-white text-gray-400"}),(0,d.jsx)("h3",{className:"font-semibold text-gray-900",children:"Stage Layout"}),O?(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("input",{type:"text",value:Q,onChange:a=>R(a.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm"}),(0,d.jsx)("button",{onClick:async()=>{if(!b)return;let a=Q.trim();if(a){T(!0);try{if(!(await fetch(`/api/parts/${b}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a})})).ok)throw Error("Failed to update part name");P(!1)}catch(a){alert(a instanceof Error?a.message:"Failed to update part name")}finally{T(!1)}}},disabled:S,className:"px-2 py-1 bg-green-600 text-white rounded text-xs disabled:bg-gray-400",children:S?"Saving...":"Save"}),(0,d.jsx)("button",{onClick:()=>{P(!1),R(c||"")},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("span",{className:"text-sm text-gray-700",children:c?`- ${c}`:""}),(0,d.jsx)("button",{onClick:()=>P(!0),className:"text-xs text-blue-600 hover:text-blue-800",children:"Edit name"})]})]}),(0,d.jsx)("div",{className:"mt-2",children:U?(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("textarea",{value:W,onChange:a=>X(a.target.value),rows:2,placeholder:"Add part notes...",className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("button",{onClick:async()=>{if(b){Z(!0);try{if(!(await fetch(`/api/parts/${b}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:W||null})})).ok)throw Error("Failed to update part notes");V(!1)}catch(a){alert(a instanceof Error?a.message:"Failed to update part notes")}finally{Z(!1)}}},disabled:Y,className:"px-2 py-1 bg-green-600 text-white rounded text-xs disabled:bg-gray-400",children:Y?"Saving...":"Save notes"}),(0,d.jsx)("button",{onClick:()=>{V(!1),X(g||"")},className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]})]}):(0,d.jsxs)("div",{className:"flex items-start gap-2",children:[(0,d.jsx)("p",{className:"text-sm text-gray-600",children:g||"No notes yet."}),(0,d.jsx)("button",{onClick:()=>V(!0),className:"text-xs text-blue-600 hover:text-blue-800",children:"Edit notes"})]})}),(0,d.jsxs)("p",{className:"text-sm text-gray-600 mt-1",children:["Front of stage: ","bottom"===z?"Bottom":"Top"]})]}),E.length>0&&(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("span",{className:"text-xs text-gray-600",children:"Subpart"}),(0,d.jsxs)("select",{value:G||"",onChange:a=>H(a.target.value),className:"px-2 py-1 border border-gray-300 rounded text-xs",children:[(0,d.jsx)("option",{value:"",children:"Part positions"}),E.map(a=>(0,d.jsx)("option",{value:a.id,children:a.title},a.id))]}),aq?.description&&(0,d.jsx)("span",{className:"text-[10px] text-gray-500",children:aq.description})]}),(0,d.jsxs)("div",{className:"flex flex-col items-end gap-2",children:[(0,d.jsxs)("div",{className:"flex items-center gap-3 text-xs",children:[v&&(0,d.jsx)("span",{className:"text-blue-600 font-semibold",children:"Auto-saving..."}),!v&&D.current&&(0,d.jsx)("span",{className:"text-orange-600 font-semibold",children:"Unsaved changes (auto-saves in 6s)"})]}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsxs)("select",{value:z,onChange:a=>A(a.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,d.jsx)("option",{value:"bottom",children:"Front - Bottom"}),(0,d.jsx)("option",{value:"top",children:"Front - Top"})]}),(0,d.jsx)("button",{onClick:()=>{G&&E.length>0?J(a=>({...a,[G]:[]})):m([]),D.current=!0},className:"px-4 py-2 bg-gray-300 text-gray-900 rounded-lg hover:bg-gray-400 font-medium text-sm",children:"Reset All"}),(0,d.jsx)("button",{onClick:ak,disabled:v,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 font-medium text-sm",children:v?"Saving...":"Save Positions"})]})]})]}),av.length>0&&(0,d.jsxs)("div",{className:"bg-blue-50 p-3 rounded-lg border border-blue-200",children:[(0,d.jsx)("h4",{className:"font-medium text-gray-900 mb-2 text-sm",children:"Legend"}),(0,d.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:ay.map(a=>(0,d.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,d.jsx)("div",{className:"w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold",children:a.initials}),(0,d.jsx)("span",{className:"text-gray-700 truncate",children:a.name})]},a.student_id))})]}),(0,d.jsxs)("div",{className:"bg-white p-3 rounded-lg border border-gray-200",children:[(0,d.jsx)("div",{className:"font-medium text-gray-900 text-sm mb-2",children:"Quick Position"}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2 items-center",children:[(0,d.jsxs)("select",{value:aa,onChange:a=>ab(a.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,d.jsx)("option",{value:"",children:"Select a part or subpart..."}),$.map(a=>(0,d.jsx)("option",{value:a.key,children:a.label},a.key))]}),(0,d.jsx)("button",{onClick:ap,disabled:!aa||ae,className:"px-3 py-1 bg-blue-600 text-white rounded text-sm disabled:bg-gray-400",children:ae?"Applying...":"Apply"})]}),(0,d.jsxs)("label",{className:"mt-2 flex items-center gap-2 text-xs text-gray-700",children:[(0,d.jsx)("input",{type:"checkbox",checked:ac,onChange:a=>ad(a.target.checked),className:"h-4 w-4"}),"Horizontal flip before applying"]})]}),E.length>0&&(0,d.jsx)("div",{className:"text-sm text-gray-700 font-medium text-center",children:aq?.title||"Subpart"}),(0,d.jsxs)("div",{className:"flex items-center justify-center gap-3",children:[E.length>0&&as&&(0,d.jsx)("button",{onClick:()=>{let a=E.findIndex(a=>a.id===G);a>0&&H(E[a-1].id)},disabled:!G||0===E.findIndex(a=>a.id===G),className:"px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 text-xs",children:"Prev"}),(0,d.jsxs)("div",{className:"border-2 border-gray-400 bg-gradient-to-b from-amber-100 to-amber-50 relative mx-auto",style:{width:768,height:576,backgroundImage:`
                  linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),
                  linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px)
                `,backgroundSize:"64px 64px"},onDragOver:ah,children:["bottom"===z&&(0,d.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-red-500"}),"top"===z&&(0,d.jsx)("div",{className:"absolute top-0 left-0 right-0 h-1 bg-red-500"}),(0,d.jsx)("div",{className:"absolute text-red-600 font-bold text-xs bg-white bg-opacity-80 px-2 py-1 rounded",style:{..."bottom"===z&&{bottom:5,left:"50%",transform:"translateX(-50%)"},..."top"===z&&{top:5,left:"50%",transform:"translateX(-50%)"}},children:"FRONT"}),G&&E.length>0&&0===av.length&&(0,d.jsx)("div",{className:"absolute top-8 left-0 right-0 text-center text-2xl font-bold text-gray-500",children:aq?.title||"Subpart"}),Array.from({length:9}).map((a,b)=>Array.from({length:12}).map((a,c)=>(0,d.jsx)("div",{onDrop:a=>aj(a,c,b),onDragOver:ah,className:"absolute cursor-cell hover:bg-blue-100 hover:bg-opacity-30 transition-colors",style:{left:64*c,top:64*b,width:64,height:64}},`${c}-${b}`))),av.map((a,b)=>{let c,e,f=q(a.name,av.map(a=>a.name));return(0,d.jsxs)("div",{draggable:!0,onDragStart:()=>ag(a.student_id,!0),className:"absolute flex items-center justify-center group cursor-move",style:{left:(c=a.x,("top"===z?11-c:c)*64),top:(e=a.y,("top"===z?8-e:e)*64),width:64,height:64},children:[(0,d.jsxs)("div",{className:"relative w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg group-hover:bg-blue-600 transition-colors",children:[f,(0,d.jsx)("button",{onClick:()=>(a=>{let b=async a=>{try{G&&E.length>0?await fetch("/api/subpart-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subpart_id:G,positions:a.map(a=>({subpart_id:G,student_id:a.student_id,x:a.x,y:a.y}))})}):await i(a),D.current=!1,C(Date.now())}catch(a){y(a instanceof Error?a.message:"Failed to save positions"),D.current=!0}};if(G&&E.length>0){let c=(I[G]||[]).filter(b=>b.student_id!==a);J(a=>({...a,[G]:c})),b(c)}else{let c=l.filter(b=>b.student_id!==a);m(c),b(c)}D.current=!0})(a.student_id),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600",title:"Remove from stage",children:"x"})]}),(0,d.jsx)("div",{className:"absolute bottom-full mb-1 whitespace-nowrap bg-gray-900 text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:a.name})]},a.id||`${a.student_id}-${a.x}-${a.y}-${b}`)})]}),E.length>0&&as&&(0,d.jsx)("button",{onClick:()=>{let a=E.findIndex(a=>a.id===G);a>=0&&a<E.length-1&&H(E[a+1].id)},disabled:!G||E.findIndex(a=>a.id===G)===E.length-1,className:"px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 text-xs",children:"Next"})]}),at&&G&&null,(0,d.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[(0,d.jsxs)("h4",{className:"font-medium text-gray-900 mb-3",children:["Positioned (",av.length,")"]}),(0,d.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:av.map((a,b)=>(0,d.jsxs)("div",{className:"bg-white p-2 rounded border border-green-200 text-sm",children:[(0,d.jsx)("p",{className:"font-medium text-gray-900",children:a.name}),(0,d.jsxs)("p",{className:"text-xs text-gray-600",children:["(",a.x,", ",a.y,")"]})]},a.id||`${a.student_id}-${a.x}-${a.y}-${b}`))})]})]})})]})]})}function s({performanceId:a,performanceTitle:b,currentMusicFile:c,onUploadSuccess:f}){let[g,h]=(0,e.useState)(!1),[i,j]=(0,e.useState)(null),[k,l]=(0,e.useState)(!1),m=async b=>{let c=b.currentTarget.files?.[0];if(c){h(!0),j(null),l(!1);try{let d=new FormData;d.append("file",c);let e=await fetch(`/api/performances/${a}/upload-music`,{method:"POST",body:d});if(!e.ok){let a=await e.json();throw Error(a.error||"Upload failed")}let g=await e.json();l(!0),f?.(g.filePath,g.publicUrl),b.currentTarget.value=""}catch(a){j(a instanceof Error?a.message:"Upload failed")}finally{h(!1)}}};return(0,d.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,d.jsx)("h3",{className:"font-bold text-lg text-gray-900 mb-4",children:"Performance Music"}),c&&(0,d.jsx)("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded",children:(0,d.jsxs)("p",{className:"text-sm text-green-900",children:[(0,d.jsx)("span",{className:"font-semibold",children:"✓ Music Uploaded:"})," ",c]})}),(0,d.jsxs)("div",{className:"space-y-3",children:[(0,d.jsxs)("label",{className:"block",children:[(0,d.jsx)("div",{className:"flex items-center justify-center w-full p-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors bg-gray-50 hover:bg-blue-50",children:(0,d.jsxs)("div",{className:"text-center",children:[(0,d.jsx)("p",{className:"text-2xl mb-2",children:"\uD83C\uDFB5"}),(0,d.jsx)("p",{className:"text-sm font-semibold text-gray-700",children:g?"Uploading...":"Click to upload music"}),(0,d.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"MP3, WAV, OGG (max 50MB)"})]})}),(0,d.jsx)("input",{type:"file",accept:"audio/*",onChange:m,disabled:g,className:"hidden"})]}),i&&(0,d.jsx)("div",{className:"p-3 bg-red-50 border border-red-200 rounded",children:(0,d.jsxs)("p",{className:"text-sm text-red-900",children:["❌ ",i]})}),k&&(0,d.jsx)("div",{className:"p-3 bg-green-50 border border-green-200 rounded",children:(0,d.jsx)("p",{className:"text-sm text-green-900",children:"✓ Music uploaded successfully!"})})]})]})}function t({musicUrl:a,onTimeUpdate:b,performanceTitle:c,audioRef:f,onAudioReady:g}){let h=(0,e.useRef)(null),i=f??h,[j,k]=(0,e.useState)(!1),[l,m]=(0,e.useState)(0),[n,o]=(0,e.useState)(0),[p,q]=(0,e.useState)(1),r=a=>{if(!a||isNaN(a))return"0:00";let b=Math.floor(a/60),c=Math.floor(a%60);return`${b}:${c.toString().padStart(2,"0")}`};return(0,d.jsxs)("div",{className:"bg-gray-900 text-white rounded-lg p-6 shadow-xl",children:[(0,d.jsx)("audio",{ref:i,src:a}),(0,d.jsxs)("div",{className:"mb-4",children:[(0,d.jsx)("h3",{className:"font-bold text-lg mb-1",children:c?`Music for ${c}`:"Music Player"}),!a&&(0,d.jsx)("p",{className:"text-sm text-gray-400",children:"No music uploaded yet"})]}),a&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,d.jsx)("button",{onClick:()=>{i.current&&(j?i.current.pause():i.current.play())},disabled:!a,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 rounded-lg font-semibold transition-colors",children:j?"⏸ Pause":"▶ Play"}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("span",{className:"text-xs text-gray-400",children:"\uD83D\uDD0A"}),(0,d.jsx)("input",{type:"range",min:"0",max:"1",step:"0.1",value:p,onChange:a=>{let b=parseFloat(a.target.value);q(b),i.current&&(i.current.volume=b)},className:"w-20 cursor-pointer"}),(0,d.jsxs)("span",{className:"text-xs text-gray-400 w-6",children:[Math.round(100*p),"%"]})]})]}),(0,d.jsxs)("div",{className:"mb-4",children:[(0,d.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,d.jsx)("span",{className:"text-sm text-gray-300 w-12 text-right",children:r(l)}),(0,d.jsx)("input",{type:"range",min:"0",max:n||0,value:l,onChange:a=>{var b;return b=parseFloat(a.target.value),void(i.current&&(i.current.currentTime=b,m(b)))},className:"flex-1 cursor-pointer"}),(0,d.jsx)("span",{className:"text-sm text-gray-300 w-12",children:r(n)})]}),(0,d.jsx)("div",{className:"w-full bg-gray-700 rounded-full h-1",children:(0,d.jsx)("div",{className:"bg-blue-500 h-1 rounded-full transition-all",style:{width:`${n?l/n*100:0}%`}})})]})]}),!a&&(0,d.jsx)("div",{className:"text-center py-8 text-gray-400",children:(0,d.jsx)("p",{children:"Upload music in the performance settings to enable playback"})})]})}function u(a){if(!a)return"?";let b=a.trim().split(/\s+/);return 1===b.length?b[0].slice(0,2).toUpperCase():(b[0][0]+b[b.length-1][0]).toUpperCase()}function v({performanceId:a,parts:b,musicUrl:c,onClose:f}){let[g,h]=(0,e.useState)(0),[i,j]=(0,e.useState)({}),[k,l]=(0,e.useState)(!1),[m,n]=(0,e.useState)(!0),[p,q]=(0,e.useState)({}),[r,s]=(0,e.useState)({}),[v,w]=(0,e.useState)({}),[x,y]=(0,e.useState)(""),[z,A]=(0,e.useState)(null),[B,C]=(0,e.useState)(null),[D,E]=(0,e.useState)(null),[F,G]=(0,e.useState)(""),[H,I]=(0,e.useState)("bottom"),[J,K]=(0,e.useState)(null),[L,M]=(0,e.useState)(null),N=(0,e.useRef)(null);(0,e.useRef)(null),(0,e.useRef)(null);let O=(0,e.useMemo)(()=>[...b].sort((a,b)=>{let c="number"==typeof a.timepoint_seconds?a.timepoint_seconds:1/0,d="number"==typeof b.timepoint_seconds?b.timepoint_seconds:1/0;return c===d?(a.order||0)-(b.order||0):c-d}),[b]),P=(0,e.useMemo)(()=>O.filter(a=>"number"==typeof a.timepoint_seconds),[O]),Q=(0,e.useMemo)(()=>{if(0===P.length)return -1;let a=0;for(let b=0;b<P.length;b++){let c=P[b].timepoint_seconds||0,d=P[b].timepoint_end_seconds;g>=c&&(null==d||g<d)?a=b:g>=c&&(a=b)}return a},[P,g]),R=Q>=0?P[Q]:null,S=Q>=0?P[Q+1]:null,T=S?Math.max(0,(S.timepoint_seconds||0)-g):null,U=a=>{if(null==a||Number.isNaN(a))return"--:--";let b=Math.max(0,Math.floor(a)),c=Math.floor(b/60);return`${c}:${(b%60).toString().padStart(2,"0")}`},V=(0,e.useMemo)(()=>{let a=new Set;return Object.values(i).forEach(b=>{b.forEach(b=>a.add(b.student_name||"Unknown"))}),Object.values(r).forEach(b=>{b.forEach(b=>a.add(b||"Unknown"))}),Array.from(a).sort((a,b)=>a.localeCompare(b))},[i,r]),W=(0,e.useMemo)(()=>x?O.filter(a=>!!(i[a.id]||[]).map(a=>a.student_name).includes(x)||(p[a.id]||[]).some(a=>(r[a.id]||[]).includes(x))):O,[O,x,i,p,r]),X=()=>{try{let a=window.AudioContext||window.webkitAudioContext;if(!a)return;let b=new a,c=b.createGain();c.gain.value=.3,c.connect(b.destination);let d=b.createOscillator();d.type="sine",d.frequency.value=880,d.connect(c);let e=b.currentTime;d.start(e),d.stop(e+.15),setTimeout(()=>b.close(),300)}catch{}},Y=(a,b)=>{if(!N.current)return;C(a),E(b),A(5),X();let c=5,d=setInterval(()=>{if((c-=1)<=0){clearInterval(d),A(null),C(null),E(null),N.current.currentTime=a,N.current.play();return}A(c),X()},1e3)},Z=a=>{if(!a)return null;let b=p[a.id]||[];if(0===b.length)return null;let c=b.map(a=>{let b=r[a.id]||[],c=v[a.id]||!1;return 0===b.length||c?null:{title:a.title,names:b,description:a.description||null}}).filter(Boolean);return 0===c.length?null:(0,d.jsxs)("div",{className:"bg-white border border-indigo-200 rounded-lg p-5 shadow-sm min-h-[220px]",children:[(0,d.jsx)("div",{className:"text-sm uppercase tracking-wide text-indigo-600 font-semibold mb-2",children:"Subpart Assignments"}),(0,d.jsx)("div",{className:"space-y-3 text-base text-gray-700",children:c.map(a=>(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"font-semibold text-gray-900",children:a.title}),a.description&&(0,d.jsx)("div",{className:"text-sm text-gray-500",children:a.description}),(0,d.jsx)("div",{className:"text-gray-600",children:a.names.join(", ")})]},a.title))})]})},$=(a,b,c)=>{let e=b&&i[b.id]||[],f=c?"text-5xl":"text-4xl",g=c?"text-base":"text-sm",h=c?"border-purple-700 bg-purple-100":"border-blue-700 bg-blue-100",j=c?"from-purple-200 to-purple-300":"from-blue-200 to-blue-300";return(0,d.jsxs)("div",{className:`rounded-lg border p-4 shadow-sm ${h}`,children:[(0,d.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:`${g} uppercase tracking-wide text-gray-600`,children:a}),(0,d.jsx)("div",{className:`${f} font-semibold text-gray-900`,children:b?b.name:"—"})]}),c&&null!==T&&T<=10&&(0,d.jsx)("div",{className:"text-7xl font-extrabold text-red-600 animate-pulse",children:Math.ceil(T)})]}),c&&null!==T&&T<=10&&(0,d.jsx)("div",{className:"mb-2 text-3xl font-extrabold text-red-600 animate-pulse",children:"GET READY"}),(0,d.jsxs)("div",{className:`border border-gray-300 bg-gradient-to-b ${j} relative mx-auto`,style:{width:816,height:544,backgroundImage:`
              linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),
              linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px)
            `,backgroundSize:"68px 68px"},children:["bottom"===H&&(0,d.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-red-500"}),"top"===H&&(0,d.jsx)("div",{className:"absolute top-0 left-0 right-0 h-1 bg-red-500"}),(0,d.jsx)("div",{className:"absolute text-red-600 font-bold text-xs bg-white bg-opacity-80 px-2 py-1 rounded",style:{..."bottom"===H&&{bottom:5,left:"50%",transform:"translateX(-50%)"},..."top"===H&&{top:5,left:"50%",transform:"translateX(-50%)"}},children:"FRONT"}),Array.from({length:8}).map((a,b)=>Array.from({length:12}).map((a,c)=>(0,d.jsx)("div",{className:"absolute",style:{left:68*c,top:68*b,width:68,height:68}},`${c}-${b}`))),e.map(a=>(0,d.jsx)("div",{className:"absolute flex items-center justify-center",style:{left:68*a.x,top:68*a.y,width:68,height:68},children:(0,d.jsx)("div",{className:"w-14 h-14 bg-blue-600 text-white text-base font-bold rounded-full flex items-center justify-center shadow-md",children:u(a.student_name)})},`${a.student_id}-${a.x}-${a.y}`))]})]})};return(0,d.jsx)("div",{className:"fixed inset-0 z-50 bg-black bg-opacity-70 flex",children:(0,d.jsx)("div",{className:"flex-1 bg-gray-100 overflow-auto",children:(0,d.jsxs)("div",{className:"w-full h-full p-6",children:[(0,d.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:"flex items-center gap-3 mb-1",children:[(0,d.jsx)(o.v,{className:"border border-gray-200 bg-white text-gray-400",size:32}),(0,d.jsx)("div",{className:"text-sm uppercase tracking-wide text-gray-500",children:"Rehearse Mode"})]}),(0,d.jsx)("div",{className:"text-3xl font-bold text-gray-900",children:"Live Stage View"})]}),(0,d.jsx)("div",{className:"flex items-center gap-4",children:(0,d.jsx)("button",{onClick:f,className:"px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-800",children:"Close"})})]}),(0,d.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-[360px_1fr] gap-6",children:[(0,d.jsxs)("div",{className:"bg-white rounded-lg border border-gray-200 p-4 shadow-sm",children:[(0,d.jsx)("div",{className:"text-2xl font-semibold text-gray-900 mb-4",children:"Parts"}),(0,d.jsx)("div",{className:"text-xs text-gray-500 mb-3",children:"Select a part to jump to that timepoint."}),(0,d.jsx)("div",{className:"space-y-5",children:W.map((a,b)=>{let c=R?.id===a.id,e=S?.id===a.id;return(0,d.jsxs)("div",{className:`border rounded p-2 cursor-pointer transition-colors ${c?"border-blue-500 bg-blue-50":"border-gray-200 bg-white"}`,children:[(0,d.jsxs)("div",{className:"flex items-center justify-between",children:[(0,d.jsx)("div",{className:"font-semibold text-gray-900 text-xl",children:a.name}),e&&(0,d.jsx)("span",{className:"text-base font-bold text-purple-700 bg-purple-100 px-2 py-0.5 rounded",children:"NEXT"})]}),(0,d.jsx)("div",{className:"text-base text-gray-500",children:"number"==typeof a.timepoint_seconds?U(a.timepoint_seconds):"No timepoint"}),e&&null!==T&&T<=10&&(0,d.jsx)("div",{className:"text-4xl font-extrabold text-red-600 animate-pulse",children:Math.ceil(T)}),(0,d.jsx)("div",{className:"text-base text-gray-600 mt-1",children:0===(i[a.id]||[]).length?"No positions":(i[a.id]||[]).map((b,c)=>(0,d.jsxs)("span",{children:[c>0?", ":"",(0,d.jsx)("span",{className:b.student_name===x?"font-bold text-emerald-600":"",children:b.student_name})]},`${a.id}-pos-${b.student_id}-${c}`))}),(p[a.id]||[]).length>0&&(0,d.jsx)("div",{className:"mt-3 space-y-3 text-sm text-gray-700",children:(p[a.id]||[]).map((b,c)=>{let e=r[b.id]||[],f="number"==typeof b.timepoint_seconds?b.timepoint_seconds:null!==b.timepoint_seconds&&void 0!==b.timepoint_seconds?parseFloat(String(b.timepoint_seconds)):NaN,g="number"==typeof b.timepoint_end_seconds?b.timepoint_end_seconds:null!==b.timepoint_end_seconds&&void 0!==b.timepoint_end_seconds?parseFloat(String(b.timepoint_end_seconds)):NaN,h=Number.isFinite(f);return(0,d.jsxs)("div",{className:"",children:[(0,d.jsxs)("div",{className:"font-semibold text-gray-900",children:[c+1,". ",b.title]}),(0,d.jsxs)("div",{className:"text-gray-600",children:["Assigned:"," ",0===e.length?"—":e.map((a,c)=>(0,d.jsxs)("span",{children:[c>0?", ":"",(0,d.jsx)("span",{className:a===x?"font-bold text-emerald-600":"",children:a})]},`${b.id}-assigned-${c}`))]}),(0,d.jsxs)("div",{className:"text-gray-500",children:["Notes: ",b.description?b.description:"—"]}),(0,d.jsxs)("div",{className:"text-[11px] text-gray-500",children:["Time: ",Number.isFinite(f)?U(f):"--:--"," / ",Number.isFinite(g)?U(g):"--:--"]}),h&&(0,d.jsxs)("button",{onClick:b=>{b.stopPropagation(),Y(f,a.id)},className:"mt-1 text-[11px] text-indigo-600 hover:text-indigo-800 underline",children:["Jump to ",b.title," subpart"]})]},b.id)})}),(0,d.jsx)("div",{className:"mt-3",children:(0,d.jsx)("button",{onClick:b=>{b.stopPropagation();let c=a.timepoint_seconds,d="number"==typeof c?c:null!=c?parseFloat(c):null;null===d||Number.isNaN(d)||Y(d,a.id)},className:"text-xs text-blue-700 hover:text-blue-900 underline",children:"Jump to part"})}),D===a.id&&null!==z&&(0,d.jsx)("div",{className:"mt-2 text-center text-3xl font-extrabold text-red-600 animate-pulse",children:z})]},a.id)})})]}),(0,d.jsxs)("div",{className:"space-y-6",children:[(a=>{if(!a)return null;let b=p[a.id]||[];if(0===b.length)return null;let c=b.map(a=>{let b="number"==typeof a.timepoint_seconds?a.timepoint_seconds:Number(a.timepoint_seconds),c="number"==typeof a.timepoint_end_seconds?a.timepoint_end_seconds:Number(a.timepoint_end_seconds),d=Number.isFinite(b)?b:NaN,e=Number.isFinite(c)?c:NaN;return Number.isFinite(d)?{id:a.id,title:a.title,start:d,end:Number.isFinite(e)?e:d}:null}).filter(Boolean);if(0===c.length)return null;let e="number"==typeof a.timepoint_seconds?a.timepoint_seconds:Math.min(...c.map(a=>a.start)),f="number"==typeof a.timepoint_end_seconds?a.timepoint_end_seconds:Math.max(...c.map(a=>a.end)),h=Math.max(1,f-e),i=100*Math.min(1,Math.max(0,(g-e)/h));return(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 shadow-sm",children:[(0,d.jsx)("div",{className:"text-xs uppercase tracking-wide text-gray-500 mb-2",children:"Subpart Timeline"}),(0,d.jsxs)("div",{className:"relative h-16 rounded bg-slate-50 border border-slate-200 overflow-hidden",children:[c.map((a,b)=>{let f=(a.start-e)/h*100,g=Math.max(2,(a.end-a.start)/h*100),i=L===a.id;return(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:`absolute top-0 h-full text-white text-base font-bold px-2 py-1 flex flex-col items-center justify-center text-center overflow-hidden leading-tight transition-all ${J===a.id?"bg-emerald-500 border-2 border-emerald-700":i?"bg-emerald-600 border-2 border-emerald-800 shadow-[0_0_12px_rgba(16,185,129,0.85)] animate-pulse":"bg-orange-700 border-2 border-orange-900"}`,style:{left:`${f}%`,width:`${g}%`},children:[(0,d.jsx)("div",{children:a.title}),(0,d.jsx)("div",{className:"text-sm opacity-90",children:"Subpart"})]}),b<c.length-1&&(0,d.jsx)("div",{className:"absolute top-0 h-full w-[4px] bg-orange-900",style:{left:`${f+g}%`}})]},a.id)}),(0,d.jsx)("div",{className:"absolute top-0 h-full w-[3px] bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.7)]",style:{left:`${i}%`}})]}),(0,d.jsxs)("div",{className:"mt-1 text-[11px] text-gray-500",children:[U(e)," - ",U(f)]})]})})(R),(0,d.jsxs)("div",{className:"grid grid-cols-1 2xl:grid-cols-2 gap-6",children:[$("Next",S,!0),$("Current",R,!1)]}),(0,d.jsxs)("div",{className:"flex flex-wrap gap-4 text-xs text-gray-600",children:[(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("span",{className:"inline-block h-3 w-3 rounded-full bg-blue-600"}),"Current part"]}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("span",{className:"inline-block h-3 w-3 rounded-full bg-purple-600"}),"Next part"]}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("span",{className:"inline-block h-3 w-3 rounded-full bg-blue-600 border border-blue-800"}),"Student position"]})]}),(R||S)&&(0,d.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 text-xs text-gray-700",children:[(0,d.jsx)("div",{className:"font-semibold text-gray-900 mb-2",children:"Legend"}),(0,d.jsxs)("div",{className:"space-y-3",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-[11px] font-semibold text-blue-700 uppercase tracking-wide mb-2",children:"Current Part"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2",children:[Array.from(new Map((R&&i[R.id]||[]).map(a=>[a.student_id,a])).values()).map(a=>(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("div",{className:"w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-[10px] font-bold",children:u(a.student_name)}),(0,d.jsx)("span",{className:"truncate",children:a.student_name})]},`current-${R?.id}-${a.student_id}`)),0===(R&&i[R.id]||[]).length&&(0,d.jsx)("div",{className:"text-[11px] text-gray-500",children:"No positions"})]})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"text-[11px] font-semibold text-purple-700 uppercase tracking-wide mb-2",children:"Next Part"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2",children:[Array.from(new Map((S&&i[S.id]||[]).map(a=>[a.student_id,a])).values()).map(a=>(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("div",{className:"w-6 h-6 bg-purple-600 text-white rounded-full flex items-center justify-center text-[10px] font-bold",children:u(a.student_name)}),(0,d.jsx)("span",{className:"truncate",children:a.student_name})]},`next-${S?.id}-${a.student_id}`)),0===(S&&i[S.id]||[]).length&&(0,d.jsx)("div",{className:"text-[11px] text-gray-500",children:"No positions"})]})]})]})]}),(0,d.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,d.jsx)("div",{className:"min-h-[180px]",children:Z(R)}),(0,d.jsx)("div",{className:"min-h-[180px]",children:Z(S)})]}),(0,d.jsxs)("div",{className:"max-w-xl space-y-3",children:[(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-3 rounded-lg border-2 border-blue-600 bg-blue-50 p-3",children:[(0,d.jsx)("div",{className:"text-xs font-extrabold uppercase tracking-widest text-blue-700",children:"Filter by person"}),(0,d.jsxs)("select",{value:x,onChange:a=>y(a.target.value),className:"min-w-[160px] px-2 py-1 border border-blue-200 rounded text-sm bg-white",children:[(0,d.jsx)("option",{value:"",children:"All"}),V.map(a=>(0,d.jsx)("option",{value:a,children:a},a))]}),(0,d.jsxs)("div",{className:"ml-auto flex items-center gap-3 text-xs font-semibold text-blue-700",children:[F&&(0,d.jsxs)("div",{children:["Call Time: ",(0,d.jsx)("span",{className:"font-bold",children:F})]}),(0,d.jsxs)("label",{className:"flex items-center gap-2",children:[(0,d.jsx)("input",{type:"checkbox",checked:m,onChange:a=>n(a.target.checked),className:"h-4 w-4"}),"Ring at T-10"]})]})]}),(0,d.jsx)(t,{musicUrl:c||void 0,onTimeUpdate:a=>h(a),audioRef:N})]})]})]})]})})})}var w=c(8281);function x({partId:a}){let[b,c]=(0,e.useState)([]),[f,g]=(0,e.useState)(!1),[h,i]=(0,e.useState)(""),[j,k]=(0,e.useState)(""),[l,m]=(0,e.useState)(""),[n,o]=(0,e.useState)(""),[p,q]=(0,e.useState)(""),[r,s]=(0,e.useState)(""),[t,u]=(0,e.useState)(null),[v,w]=(0,e.useState)(""),[x,y]=(0,e.useState)(""),[z,A]=(0,e.useState)(""),[B,C]=(0,e.useState)(""),[D,E]=(0,e.useState)(""),[F,G]=(0,e.useState)(""),H=a=>{if(null==a||""===a)return{min:"",sec:""};let b=Number(a);if(!Number.isFinite(b))return{min:"",sec:""};let c=Math.floor(b/60),d=Math.floor(b%60);return{min:String(c),sec:String(d)}},I=(a,b)=>{if(!a&&!b)return null;let c=a?parseInt(a,10):0,d=b?parseFloat(b):0;return Number.isNaN(c)||Number.isNaN(d)?null:60*c+d},J=a=>{if(null==a||""===a)return"--:--";let b=Number(a);if(!Number.isFinite(b))return"--:--";let c=Math.floor(b/60),d=Math.floor(b%60);return`${c}:${d.toString().padStart(2,"0")}`},K=(0,e.useCallback)(async()=>{if(!a)return void c([]);try{g(!0);let b=await fetch(`/api/subparts?partId=${a}`);if(!b.ok)throw Error("Failed to fetch subparts");let d=await b.json();c(d||[])}catch(a){console.error("Error fetching subparts:",a)}finally{g(!1)}},[a]);return a?(0,d.jsxs)("div",{className:"border-t border-gray-200 pt-4",children:[(0,d.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,d.jsx)("h3",{className:"font-semibold text-gray-900",children:"Subparts / Solos"}),(0,d.jsx)("button",{onClick:K,className:"text-xs text-blue-600 hover:text-blue-800",children:"Refresh"})]}),f&&(0,d.jsx)("div",{className:"text-xs text-gray-500 mb-2",children:"Loading..."}),0===b.length&&!f&&(0,d.jsx)("div",{className:"text-xs text-gray-500 mb-2",children:"No subparts yet."}),(0,d.jsx)("div",{className:"space-y-2",children:b.map(a=>(0,d.jsx)("div",{className:"border border-gray-200 rounded p-2 text-xs",children:t===a.id?(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("input",{type:"text",value:v,onChange:a=>w(a.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("textarea",{value:x,onChange:a=>y(a.target.value),rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:z,onChange:a=>A(a.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:B,onChange:a=>C(a.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:D,onChange:a=>E(a.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:F,onChange:a=>G(a.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{onClick:async()=>{try{if(!(await fetch(`/api/subparts/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:v,description:x,timepoint_seconds:I(z,B),timepoint_end_seconds:I(D,F)})})).ok)throw Error("Failed to update subpart");u(null),await K()}catch(a){alert(a instanceof Error?a.message:"Failed to update subpart")}},className:"px-2 py-1 bg-green-600 text-white rounded text-xs",children:"Save"}),(0,d.jsx)("button",{onClick:()=>u(null),className:"px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs",children:"Cancel"})]})]}):(0,d.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"font-medium text-gray-800",children:a.title}),a.mode&&(0,d.jsxs)("div",{className:"text-[10px] text-gray-400",children:["Mode: ",a.mode]}),a.description&&(0,d.jsx)("div",{className:"text-gray-600",children:a.description}),null!==a.timepoint_seconds||null!==a.timepoint_end_seconds?(0,d.jsxs)("div",{className:"text-[10px] text-gray-400",children:["Time: ",J(a.timepoint_seconds)," - ",J(a.timepoint_end_seconds)]}):(0,d.jsx)("div",{className:"text-[10px] text-gray-400",children:"Time: --:-- - --:--"})]}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("button",{onClick:()=>{u(a.id),w(a.title),y(a.description||"");let b=H(a.timepoint_seconds),c=H(a.timepoint_end_seconds);A(b.min),C(b.sec),E(c.min),G(c.sec)},className:"text-[10px] text-blue-600 hover:text-blue-800",children:"Edit"}),(0,d.jsx)("button",{onClick:async()=>{if(window.confirm("Delete this subpart?"))try{if(!(await fetch(`/api/subparts/${a.id}`,{method:"DELETE"})).ok)throw Error("Failed to delete subpart");await K()}catch(a){alert(a instanceof Error?a.message:"Failed to delete subpart")}},className:"text-[10px] text-red-600 hover:text-red-800",children:"Delete"})]})]})},a.id))}),(0,d.jsxs)("div",{className:"mt-3 border-t border-gray-200 pt-3",children:[(0,d.jsx)("div",{className:"font-semibold text-gray-700 text-xs mb-2",children:"Add Subpart"}),(0,d.jsx)("input",{type:"text",value:h,onChange:a=>i(a.target.value),placeholder:"Subpart title",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2"}),(0,d.jsx)("textarea",{value:j,onChange:a=>k(a.target.value),placeholder:"Description",rows:2,className:"w-full px-2 py-1 border border-gray-300 rounded text-xs mb-2"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:l,onChange:a=>m(a.target.value),placeholder:"Start m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:n,onChange:a=>o(a.target.value),placeholder:"Start s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[(0,d.jsx)("input",{type:"number",min:"0",value:p,onChange:a=>q(a.target.value),placeholder:"End m",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"}),(0,d.jsx)("input",{type:"number",step:"0.1",min:"0",value:r,onChange:a=>s(a.target.value),placeholder:"End s",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs"})]}),(0,d.jsx)("button",{onClick:async()=>{let b=h.trim(),c=j.trim();if(b)try{if(!(await fetch("/api/subparts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:a,title:b,description:c||null,mode:"position",timepoint_seconds:I(l,n),timepoint_end_seconds:I(p,r)})})).ok)throw Error("Failed to create subpart");i(""),k(""),m(""),o(""),q(""),s(""),await K()}catch(a){alert(a instanceof Error?a.message:"Failed to create subpart")}},className:"px-2 py-1 bg-blue-600 text-white rounded text-xs",children:"Add Subpart"})]})]}):null}function y({params:a}){let{id:b}=(0,e.use)(a),[c,f]=(0,e.useState)(null),[g,k]=(0,e.useState)(!0),[l,m]=(0,e.useState)("rehearsals"),[o,q]=(0,e.useState)(!1),[u,y]=(0,e.useState)(!1),[B,C]=(0,e.useState)(null),[D,E]=(0,e.useState)(null),[F,G]=(0,e.useState)(!1),[H,I]=(0,e.useState)(!1),[J,K]=(0,e.useState)(!0),[L,M]=(0,e.useState)(!1),[N,O]=(0,e.useState)(null),[P,Q]=(0,e.useState)({title:"",call_time:"",timezone:"America/New_York",date:"",location:"",description:"",phone_numbers:""}),[R,S]=(0,e.useState)([]),[T,U]=(0,e.useState)(""),[V,W]=(0,e.useState)(""),[X,Y]=(0,e.useState)([]),[Z,$]=(0,e.useState)(""),{rehearsals:_,createRehearsal:aa,deleteRehearsal:ab,updateRehearsal:ac}=i(b),{parts:ad,createPart:ae,deletePart:af,setParts:ag}=function(a){let[b,c]=(0,e.useState)([]),[d,f]=(0,e.useState)(!0),[g,h]=(0,e.useState)(null),i=async(d,e,f,g)=>{if(!a)throw Error("Performance ID is required");try{let h=await fetch("/api/parts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:a,name:d,description:e,order:f,is_group:g})});if(!h.ok)throw Error("Failed to create part");let i=await h.json();return c([...b,i]),i}catch(a){throw h(a instanceof Error?a.message:"An error occurred"),a}},j=async a=>{try{if(!(await fetch(`/api/parts/${a}`,{method:"DELETE"})).ok)throw Error("Failed to delete part");c(b.filter(b=>b.id!==a))}catch(a){throw h(a instanceof Error?a.message:"An error occurred"),a}};return{parts:b,loading:d,error:g,createPart:i,deletePart:j,setParts:c}}(b),{performances:ah}=(0,j.f)(),ai=async()=>{try{I(!0);let a=await fetch(`/api/rehearse-export?performanceId=${b}&embedAudio=${J?"1":"0"}`);if(!a.ok){let b=await a.text();throw console.error("Export error:",a.status,b),Error("Failed to export rehearse HTML")}let d=await a.blob(),e=URL.createObjectURL(d),f=(c?.title||"rehearse-export").toString().replace(/[^a-z0-9]+/gi,"-").replace(/^-+|-+$/g,"").toLowerCase(),g=document.createElement("a");g.href=e,g.download=`${f||"rehearse-export"}.html`,document.body.appendChild(g),g.click(),g.remove(),URL.revokeObjectURL(e)}catch(a){console.error("Export failed:",a),alert("Failed to export rehearse HTML")}finally{I(!1)}};return g?(0,d.jsx)("div",{className:"min-h-screen bg-gray-100 p-6",children:(0,d.jsx)("p",{className:"text-gray-600",children:"Loading..."})}):c?(0,d.jsxs)("div",{className:"min-h-screen bg-gray-100",children:[(0,d.jsx)("nav",{className:"bg-blue-900 text-white p-4 shadow-lg",children:(0,d.jsxs)("div",{className:"max-w-7xl mx-auto flex justify-between items-center",children:[(0,d.jsx)(w.AppBrand,{href:"/"}),(0,d.jsx)("div",{className:"flex gap-4",children:(0,d.jsx)(h(),{href:"/admin",className:"hover:bg-blue-800 px-3 py-2 rounded",children:"Admin Panel"})})]})}),(0,d.jsxs)("div",{className:"flex min-h-[calc(100vh-64px)]",children:[(0,d.jsx)("div",{className:"w-64 bg-white shadow-md p-6 overflow-y-auto border-r border-gray-200",children:(0,d.jsx)(p,{performanceId:b})}),(0,d.jsx)("div",{className:"flex-1 min-w-0 p-6",children:(0,d.jsxs)("div",{className:`${"positioning"===l?"max-w-none mx-0":"max-w-5xl mx-auto"}`,children:[(0,d.jsxs)("div",{className:"mb-8",children:[(0,d.jsx)(h(),{href:"/admin",className:"text-blue-600 hover:underline mb-4 block",children:"← Back to Dashboard"}),(0,d.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:c.title}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-gray-600",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("span",{className:"font-semibold",children:"Date:"})," ",P.date?((a,b)=>{if(!a)return"—";let c=new Date(a);return Number.isNaN(c.getTime())?"—":c.toLocaleString(void 0,{timeZone:b||"America/New_York",timeZoneName:"short"})})(P.date,P.timezone):"—"]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("span",{className:"font-semibold",children:"Location:"})," ",c.location]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("span",{className:"font-semibold",children:"Timezone:"})," ",P.timezone]})]}),c.description&&(0,d.jsxs)("div",{className:"mt-4 text-gray-600",children:[(0,d.jsx)("span",{className:"font-semibold",children:"Description:"})," ",c.description]})]}),(0,d.jsxs)("div",{className:"flex gap-4 mb-8 flex-wrap",children:[(0,d.jsx)("button",{onClick:()=>m("rehearsals"),className:`px-6 py-3 rounded-lg font-semibold transition-colors ${"rehearsals"===l?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"}`,children:"Rehearsals"}),(0,d.jsx)("button",{onClick:()=>m("parts"),className:`px-6 py-3 rounded-lg font-semibold transition-colors ${"parts"===l?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"}`,children:"Parts/Choreography"}),(0,d.jsx)("button",{onClick:()=>{m("positioning"),ad.length>0&&!B&&C(ad[0].id)},className:`px-6 py-3 rounded-lg font-semibold transition-colors ${"positioning"===l?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"}`,children:"Stage Positions"}),(0,d.jsx)("button",{onClick:()=>m("music"),className:`px-6 py-3 rounded-lg font-semibold transition-colors ${"music"===l?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"}`,children:"Music & Rehearse"}),(0,d.jsx)("button",{onClick:()=>m("info"),className:`px-6 py-3 rounded-lg font-semibold transition-colors ${"info"===l?"bg-blue-600 text-white":"bg-white text-gray-900 hover:bg-gray-50"}`,children:"Performance Info"})]}),"positioning"===l?(0,d.jsx)("div",{className:"flex flex-col gap-6",children:(0,d.jsx)("div",{className:"bg-white rounded-lg shadow-md p-8",children:0===ad.length?(0,d.jsxs)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:[(0,d.jsx)("p",{className:"text-gray-600 mb-4",children:"No parts created yet."}),(0,d.jsx)("p",{className:"text-sm text-gray-500",children:"Create parts first before positioning students."})]}):B&&(0,d.jsx)(r,{performanceId:b,partId:B,partName:ad.find(a=>a.id===B)?.name,partDescription:ad.find(a=>a.id===B)?.description,isGroup:ad.find(a=>a.id===B)?.is_group!==!1,onSavePositions:async a=>{let b=a.map(a=>({part_id:B,student_id:a.student_id,x:a.x,y:a.y}));if(!(await fetch("/api/stage-positions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_id:B,positions:b})})).ok)throw Error("Failed to save positions")}})})}):(0,d.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-8",children:["rehearsals"===l&&(0,d.jsx)(z,{rehearsals:_,showForm:o,onToggleForm:()=>q(!o),onCreateRehearsal:aa,onDeleteRehearsal:ab,onUpdateRehearsal:ac}),"parts"===l&&(0,d.jsx)(A,{performanceId:b,parts:ad,performances:ah,showForm:u,onToggleForm:()=>y(!u),onCreatePart:ae,onDeletePart:af,onReorderParts:ag}),"music"===l&&(0,d.jsxs)("div",{className:"space-y-6",children:[(0,d.jsx)(s,{performanceId:b,performanceTitle:c.title,currentMusicFile:c.music_file_name,onUploadSuccess:(a,b)=>{E(b),f({...c,music_file_name:a.split("/").pop()})}}),D&&(0,d.jsxs)("div",{children:[(0,d.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Preview Music"}),(0,d.jsx)(t,{musicUrl:D,performanceTitle:c.title})]}),(0,d.jsxs)("div",{className:"bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-lg border-2 border-purple-200",children:[(0,d.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"\uD83C\uDFAD Rehearse/Emulate Mode"}),(0,d.jsx)("p",{className:"text-gray-700 mb-4",children:"Use rehearse mode to play back your choreography with automatic grid transitions based on music timepoints."}),(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-3",children:[(0,d.jsx)("button",{disabled:!D||0===ad.length,onClick:()=>G(!0),className:"px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-semibold",children:"Start Rehearse Mode →"}),(0,d.jsx)("button",{disabled:!D||0===ad.length||H,onClick:ai,className:"px-6 py-3 bg-white text-purple-700 border border-purple-300 rounded-lg hover:bg-purple-50 disabled:bg-gray-100 disabled:text-gray-400 disabled:border-gray-200 font-semibold",children:H?"Exporting...":"Export Rehearse HTML"}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm text-purple-900",children:[(0,d.jsx)("input",{type:"checkbox",checked:J,onChange:a=>K(a.target.checked),className:"h-4 w-4"}),"Embed audio in export"]})]}),(0,d.jsxs)("p",{className:"text-sm text-gray-600 mt-2",children:[!D&&"⚠️ Upload music first",D&&0===ad.length&&"⚠️ Create parts and set timepoints",D&&ad.length>0&&"✓ Ready to rehearse"]})]}),ad.length>0&&(0,d.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,d.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Part Timepoints"}),(0,d.jsxs)("div",{className:"space-y-3",children:[(0,d.jsx)("p",{className:"text-gray-600 text-sm",children:'Click "Edit" on a part to set its music timepoint (when the part should appear during rehearsal).'}),(0,d.jsxs)("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[(0,d.jsx)("p",{className:"font-semibold text-blue-900 mb-2",children:"\uD83D\uDCCB Parts Timeline:"}),(0,d.jsx)("div",{className:"space-y-2",children:ad.map(a=>(0,d.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,d.jsx)("span",{className:"font-medium text-gray-900",children:a.name}),a.timepoint_seconds?(0,d.jsxs)("span",{className:"text-amber-700 bg-amber-100 px-2 py-1 rounded",children:["Start: ",a.timepoint_seconds,"s",a.timepoint_end_seconds?` - End: ${a.timepoint_end_seconds}s`:""]}):(0,d.jsx)("span",{className:"text-gray-400 italic",children:"No timepoint set"})]},a.id))})]})]})]})]}),"info"===l&&(0,d.jsx)("div",{className:"space-y-6",children:(0,d.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,d.jsx)("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Performance Info"}),N&&(0,d.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:N}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Performance Name"}),(0,d.jsx)("input",{type:"text",value:P.title,onChange:a=>Q(b=>({...b,title:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Date & Time"}),(0,d.jsx)("input",{type:"datetime-local",value:P.date,onChange:a=>Q(b=>({...b,date:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Call Time"}),(0,d.jsx)("input",{type:"time",value:P.call_time,onChange:a=>Q(b=>({...b,call_time:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Timezone"}),(0,d.jsx)("input",{type:"text",value:P.timezone,onChange:a=>Q(b=>({...b,timezone:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,d.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:"Use IANA format (e.g., America/New_York)"})]}),(0,d.jsxs)("div",{className:"md:col-span-2",children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Location"}),(0,d.jsx)("input",{type:"text",value:P.location,onChange:a=>Q(b=>({...b,location:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),(0,d.jsxs)("div",{className:"mt-4",children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Description"}),(0,d.jsx)("textarea",{rows:3,value:P.description,onChange:a=>Q(b=>({...b,description:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,d.jsxs)("div",{className:"mt-4",children:[(0,d.jsx)("label",{className:"block text-gray-700 font-semibold mb-2",children:"Important Phone Numbers"}),(0,d.jsx)("textarea",{rows:4,placeholder:"One per line",value:P.phone_numbers,onChange:a=>Q(b=>({...b,phone_numbers:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,d.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2 items-center",children:[(0,d.jsxs)("select",{value:Z,onChange:a=>$(a.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,d.jsx)("option",{value:"",children:"Add saved contact..."}),X.map(a=>(0,d.jsxs)("option",{value:`${a.name}||${a.phone}`,children:[a.name," • ",a.phone]},`${a.name}-${a.phone}`))]}),(0,d.jsx)("button",{onClick:()=>{if(!Z)return;let[a,b]=Z.split("||"),c=`${a}: ${b}`;Q(a=>({...a,phone_numbers:a.phone_numbers?`${a.phone_numbers}
${c}`:c})),$("")},className:"px-3 py-1 bg-gray-900 text-white rounded text-xs",children:"Add to phone list"})]})]}),(0,d.jsxs)("div",{className:"mt-6 border-t border-gray-200 pt-4",children:[(0,d.jsx)("h4",{className:"font-semibold text-gray-900 mb-2",children:"Contacts Directory"}),(0,d.jsx)("p",{className:"text-sm text-gray-600 mb-3",children:"Add contacts and select which ones appear in the export."}),(0,d.jsxs)("div",{className:"flex flex-wrap gap-2 items-center mb-3",children:[(0,d.jsxs)("select",{value:Z,onChange:a=>$(a.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,d.jsx)("option",{value:"",children:"Add saved contact..."}),X.map(a=>(0,d.jsxs)("option",{value:`${a.name}||${a.phone}`,children:[a.name," • ",a.phone]},`${a.name}-${a.phone}`))]}),(0,d.jsx)("button",{onClick:async()=>{if(!Z)return;let[a,c]=Z.split("||"),d=await fetch("/api/performance-contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:b,name:a,phone:c,include_in_export:!0})});if(d.ok){let a=await d.json();S(b=>[...b,a]),$("")}},className:"px-3 py-1 bg-blue-600 text-white rounded text-xs",children:"Add to contacts"})]}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[(0,d.jsx)("input",{type:"text",placeholder:"Name",value:T,onChange:a=>U(a.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg"}),(0,d.jsx)("input",{type:"text",placeholder:"Phone",value:V,onChange:a=>W(a.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg"}),(0,d.jsx)("button",{onClick:async()=>{if(!T.trim()||!V.trim())return;let a=await fetch("/api/performance-contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({performance_id:b,name:T.trim(),phone:V.trim(),include_in_export:!0})});if(a.ok){let b=await a.json();S(a=>[...a,b]),U(""),W("")}},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold",children:"Add Contact"})]}),(0,d.jsx)("div",{className:"space-y-2",children:R.map(a=>(0,d.jsxs)("div",{className:"flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2",children:[(0,d.jsxs)("div",{className:"flex-1",children:[(0,d.jsx)("div",{className:"font-medium text-gray-900",children:a.name}),(0,d.jsx)("div",{className:"text-sm text-gray-600",children:a.phone})]}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,d.jsx)("input",{type:"checkbox",checked:!!a.include_in_export,onChange:async b=>{(await fetch(`/api/performance-contacts/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({include_in_export:b.target.checked})})).ok&&S(c=>c.map(c=>c.id===a.id?{...c,include_in_export:b.target.checked}:c))}}),"Include in export"]}),(0,d.jsx)("button",{onClick:async()=>{(await fetch(`/api/performance-contacts/${a.id}`,{method:"DELETE"})).ok&&S(b=>b.filter(b=>b.id!==a.id))},className:"text-xs text-red-600 hover:text-red-800",children:"Remove"})]},a.id))})]}),(0,d.jsx)("div",{className:"mt-6",children:(0,d.jsx)("button",{onClick:async()=>{try{M(!0),O(null);let a=await fetch(`/api/performances/${b}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:P.title,date:P.date?new Date(P.date).toISOString():null,call_time:P.call_time,timezone:P.timezone,location:P.location,description:P.description,phone_numbers:P.phone_numbers})});if(!a.ok){let b=await a.json().catch(()=>null);throw Error(b?.details||b?.error||"Failed to save info")}let c=await a.json();f(c),Q(a=>({...a,title:c.title||"",call_time:c.call_time||"",timezone:c.timezone||a.timezone}));let d=await fetch(`/api/performance-contacts?performanceId=${b}`);if(d.ok){let a=await d.json();S(a||[])}}catch(a){O(a instanceof Error?a.message:"Failed to save info")}finally{M(!1)}},className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold disabled:bg-gray-400",disabled:L,children:L?"Saving...":"Save Info"})})]})})]})]})}),"positioning"===l&&ad.length>0&&(0,d.jsx)("div",{className:"w-80 bg-white shadow-md p-4 border-l border-gray-200",children:(0,d.jsxs)("div",{className:"sticky top-20 space-y-6",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("h3",{className:"font-semibold text-gray-900 mb-2",children:"Parts & Choreography"}),(0,d.jsx)("p",{className:"text-xs text-gray-500 mb-3",children:"Drag to reorder. Click a card to show positions."}),(0,d.jsx)(n,{parts:ad,performanceId:b,onDelete:af,onReorder:ag,onSelect:a=>C(a),selectedPartId:B,variant:"select",enableDrag:!0,showPositionedNames:!0})]}),(0,d.jsx)(x,{partId:B})]})})]}),F&&(0,d.jsx)(v,{performanceId:b,parts:ad,musicUrl:D,onClose:()=>G(!1)})]}):(0,d.jsxs)("div",{className:"min-h-screen bg-gray-100 p-6",children:[(0,d.jsx)("p",{className:"text-red-600",children:"Performance not found"}),(0,d.jsx)(h(),{href:"/admin",className:"text-blue-600 hover:underline",children:"Back to Admin"})]})}function z({rehearsals:a,showForm:b,onToggleForm:c,onCreateRehearsal:e,onDeleteRehearsal:f,onUpdateRehearsal:g}){return(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,d.jsx)("h2",{className:"text-2xl font-bold",children:"Schedule Rehearsals"}),(0,d.jsx)("button",{onClick:c,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold",children:b?"Cancel":"+ Schedule Rehearsal"})]}),b&&(0,d.jsx)("div",{className:"mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200",children:(0,d.jsx)(k,{onSubmit:async(a,b)=>{await e(a,b)}})}),0===a.length?(0,d.jsx)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:(0,d.jsx)("p",{className:"text-gray-600",children:"No rehearsals scheduled yet."})}):(0,d.jsx)(l,{rehearsals:a,onDelete:f,onUpdate:g})]})}function A({performanceId:a,parts:b,performances:c,showForm:f,onToggleForm:g,onCreatePart:h,onDeletePart:i,onReorderParts:j}){let[k,l]=(0,e.useState)(""),[o,p]=(0,e.useState)(!0),[q,r]=(0,e.useState)(!1),[s,t]=(0,e.useState)(null),[u,v]=(0,e.useState)(null),w=(c||[]).filter(b=>b.id!==a);return(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[(0,d.jsx)("h3",{className:"text-lg font-bold text-blue-900 mb-2",children:"Copy Parts from Another Performance"}),(0,d.jsx)("p",{className:"text-sm text-blue-800 mb-3",children:"This copies part names/descriptions (and optionally music timepoints). It does not copy grid positions or subparts."}),(0,d.jsxs)("div",{className:"flex flex-wrap gap-3 items-center",children:[(0,d.jsxs)("select",{value:k,onChange:a=>l(a.target.value),className:"px-3 py-2 border border-blue-300 rounded-lg text-sm min-w-[220px]",children:[(0,d.jsx)("option",{value:"",children:"Select performance to copy from..."}),w.map(a=>(0,d.jsx)("option",{value:a.id,children:a.title},a.id))]}),(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm text-blue-900",children:[(0,d.jsx)("input",{type:"checkbox",checked:o,onChange:a=>p(a.target.checked),className:"h-4 w-4"}),"Copy music timepoints"]}),(0,d.jsx)("button",{onClick:async()=>{if(k){r(!0),t(null),v(null);try{let c=await fetch("/api/parts/copy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_performance_id:k,target_performance_id:a,copy_timepoints:o})});if(!c.ok){let a=await c.json();throw Error(a.error||"Failed to copy parts")}let d=await c.json();Array.isArray(d)&&d.length>0?(j?.([...b,...d]),v(`Copied ${d.length} part(s).`)):v("No parts found to copy.")}catch(a){t(a instanceof Error?a.message:"Failed to copy parts")}finally{r(!1)}}},disabled:!k||q,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 font-semibold text-sm",children:q?"Copying...":"Copy Parts"})]}),s&&(0,d.jsx)("div",{className:"mt-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded px-3 py-2",children:s}),u&&(0,d.jsx)("div",{className:"mt-3 text-sm text-green-700 bg-green-50 border border-green-200 rounded px-3 py-2",children:u})]}),(0,d.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,d.jsx)("h2",{className:"text-2xl font-bold",children:"Parts & Choreography"}),(0,d.jsx)("button",{onClick:g,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold",children:f?"Cancel":"+ Add Part"})]}),f&&(0,d.jsx)("div",{className:"mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200",children:(0,d.jsx)(m,{onSubmit:h})}),0===b.length?(0,d.jsx)("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:(0,d.jsx)("p",{className:"text-gray-600",children:"No parts created yet."})}):(0,d.jsx)(n,{parts:b,performanceId:a,onDelete:i,onReorder:j})]})}},1025:a=>{"use strict";a.exports=require("next/dist/server/app-render/dynamic-access-async-storage.external.js")},1135:()=>{},1472:(a,b,c)=>{"use strict";c.r(b),c.d(b,{default:()=>f,metadata:()=>e});var d=c(5338);c(1135);let e={title:"Performance Tool",description:"Performance signup and management system"};function f({children:a}){return(0,d.jsx)("html",{lang:"en",children:(0,d.jsx)("body",{className:"bg-gray-50",children:(0,d.jsxs)("div",{className:"min-h-screen flex flex-col",children:[(0,d.jsx)("div",{className:"flex-1",children:a}),(0,d.jsx)("footer",{className:"text-center text-xs text-gray-400 py-4",children:"Rehearse by Origin Media"})]})})})}},1649:(a,b,c)=>{"use strict";c.d(b,{f:()=>e});var d=c(8301);function e(){let[a,b]=(0,d.useState)([]),[c,e]=(0,d.useState)(!0),[f,g]=(0,d.useState)(null),h=async(c,d,e,f,h,i)=>{try{let g=await fetch("/api/performances",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:c,description:d,date:e,location:f,call_time:h,timezone:i})});if(!g.ok)throw Error("Failed to create performance");let j=await g.json();return b([...a,j]),j}catch(a){throw g(a instanceof Error?a.message:"An error occurred"),a}},i=async c=>{try{if(!(await fetch(`/api/performances/${c}`,{method:"DELETE"})).ok)throw Error("Failed to delete performance");b(a.filter(a=>a.id!==c))}catch(a){throw g(a instanceof Error?a.message:"An error occurred"),a}};return{performances:a,loading:c,error:f,createPerformance:h,deletePerformance:i}}},2248:(a,b,c)=>{Promise.resolve().then(c.bind(c,948))},2520:(a,b,c)=>{Promise.resolve().then(c.bind(c,7031))},3033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5269:(a,b,c)=>{"use strict";c.d(b,{v:()=>g});var d=c(1124),e=c(2134),f=c(8301);function g({size:a=36,className:b="",imgClassName:c=""}){let[g,h]=(0,f.useState)(null);return(0,d.jsx)("div",{className:`flex items-center justify-center overflow-hidden ${b}`,style:{width:a,height:a,borderRadius:8},children:g?(0,d.jsx)(e.default,{src:g,alt:"App logo",width:a,height:a,unoptimized:!0,className:`max-w-full max-h-full object-contain ${c}`}):(0,d.jsx)("span",{className:"text-[10px] font-semibold uppercase tracking-wide",children:"Logo"})})}},6439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},6713:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/is-bot")},7031:(a,b,c)=>{"use strict";c.r(b),c.d(b,{default:()=>d});let d=(0,c(7954).registerClientReference)(function(){throw Error("Attempted to call the default export of \"C:\\\\Users\\\\calvi\\\\Desktop\\\\PerfTool\\\\src\\\\app\\\\admin\\\\performances\\\\[id]\\\\page.tsx\" from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"C:\\Users\\calvi\\Desktop\\PerfTool\\src\\app\\admin\\performances\\[id]\\page.tsx","default")},7060:()=>{},8281:(a,b,c)=>{"use strict";c.d(b,{AppBrand:()=>h});var d=c(1124),e=c(3991),f=c.n(e),g=c(5269);function h({href:a="/",textClassName:b="text-2xl font-bold",logoClassName:c=""}){let e=(0,d.jsxs)("div",{className:"flex items-center gap-3",children:[(0,d.jsx)(g.v,{className:`border border-white/30 bg-white/10 text-white/60 ${c}`}),(0,d.jsx)("span",{className:b,children:"Performance Tool"})]});return a?(0,d.jsx)(f(),{href:a,className:"flex items-center gap-3",children:e}):e}},8354:a=>{"use strict";a.exports=require("util")},8920:(a,b,c)=>{Promise.resolve().then(c.t.bind(c,1170,23)),Promise.resolve().then(c.t.bind(c,3597,23)),Promise.resolve().then(c.t.bind(c,6893,23)),Promise.resolve().then(c.t.bind(c,9748,23)),Promise.resolve().then(c.t.bind(c,6060,23)),Promise.resolve().then(c.t.bind(c,7184,23)),Promise.resolve().then(c.t.bind(c,9576,23)),Promise.resolve().then(c.t.bind(c,3041,23)),Promise.resolve().then(c.t.bind(c,1384,23))},9121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},9294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9530:(a,b,c)=>{"use strict";c.r(b),c.d(b,{GlobalError:()=>D.a,__next_app__:()=>J,handler:()=>L,pages:()=>I,routeModule:()=>K,tree:()=>H});var d=c(9754),e=c(9117),f=c(6595),g=c(2324),h=c(9326),i=c(8928),j=c(175),k=c(12),l=c(4290),m=c(2696),n=c(2802),o=c(7533),p=c(5229),q=c(2822),r=c(261),s=c(6453),t=c(2474),u=c(6713),v=c(1356),w=c(2685),x=c(6225),y=c(3446),z=c(2762),A=c(5742),B=c(6439),C=c(1170),D=c.n(C),E=c(2506),F=c(1203),G={};for(let a in E)0>["default","tree","pages","GlobalError","__next_app__","routeModule","handler"].indexOf(a)&&(G[a]=()=>E[a]);c.d(b,G);let H={children:["",{children:["admin",{children:["performances",{children:["[id]",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(c.bind(c,7031)),"C:\\Users\\calvi\\Desktop\\PerfTool\\src\\app\\admin\\performances\\[id]\\page.tsx"]}]},{}]},{}]},{}]},{layout:[()=>Promise.resolve().then(c.bind(c,1472)),"C:\\Users\\calvi\\Desktop\\PerfTool\\src\\app\\layout.tsx"],"global-error":[()=>Promise.resolve().then(c.t.bind(c,1170,23)),"next/dist/client/components/builtin/global-error.js"],"not-found":[()=>Promise.resolve().then(c.t.bind(c,7028,23)),"next/dist/client/components/builtin/not-found.js"],forbidden:[()=>Promise.resolve().then(c.t.bind(c,461,23)),"next/dist/client/components/builtin/forbidden.js"],unauthorized:[()=>Promise.resolve().then(c.t.bind(c,2768,23)),"next/dist/client/components/builtin/unauthorized.js"]}]}.children,I=["C:\\Users\\calvi\\Desktop\\PerfTool\\src\\app\\admin\\performances\\[id]\\page.tsx"],J={require:c,loadChunk:()=>Promise.resolve()},K=new d.AppPageRouteModule({definition:{kind:e.RouteKind.APP_PAGE,page:"/admin/performances/[id]/page",pathname:"/admin/performances/[id]",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:H},distDir:".next",relativeProjectDir:""});async function L(a,b,d){var C;let G="/admin/performances/[id]/page";"/index"===G&&(G="/");let M=(0,h.getRequestMeta)(a,"postponed"),N=(0,h.getRequestMeta)(a,"minimalMode"),O=await K.prepare(a,b,{srcPage:G,multiZoneDraftMode:!1});if(!O)return b.statusCode=400,b.end("Bad Request"),null==d.waitUntil||d.waitUntil.call(d,Promise.resolve()),null;let{buildId:P,query:Q,params:R,parsedUrl:S,pageIsDynamic:T,buildManifest:U,nextFontManifest:V,reactLoadableManifest:W,serverActionsManifest:X,clientReferenceManifest:Y,subresourceIntegrityManifest:Z,prerenderManifest:$,isDraftMode:_,resolvedPathname:aa,revalidateOnlyGenerated:ab,routerServerContext:ac,nextConfig:ad,interceptionRoutePatterns:ae}=O,af=S.pathname||"/",ag=(0,r.normalizeAppPath)(G),{isOnDemandRevalidate:ah}=O,ai=K.match(af,$),aj=!!$.routes[aa],ak=!!(ai||aj||$.routes[ag]),al=a.headers["user-agent"]||"",am=(0,u.getBotType)(al),an=(0,p.isHtmlBotRequest)(a),ao=(0,h.getRequestMeta)(a,"isPrefetchRSCRequest")??"1"===a.headers[t.NEXT_ROUTER_PREFETCH_HEADER],ap=(0,h.getRequestMeta)(a,"isRSCRequest")??!!a.headers[t.RSC_HEADER],aq=(0,s.getIsPossibleServerAction)(a),ar=(0,m.checkIsAppPPREnabled)(ad.experimental.ppr)&&(null==(C=$.routes[ag]??$.dynamicRoutes[ag])?void 0:C.renderingMode)==="PARTIALLY_STATIC",as=!1,at=!1,au=ar?M:void 0,av=ar&&ap&&!ao,aw=(0,h.getRequestMeta)(a,"segmentPrefetchRSCRequest"),ax=!al||(0,p.shouldServeStreamingMetadata)(al,ad.htmlLimitedBots);an&&ar&&(ak=!1,ax=!1);let ay=!0===K.isDev||!ak||"string"==typeof M||av,az=an&&ar,aA=null;_||!ak||ay||aq||au||av||(aA=aa);let aB=aA;!aB&&K.isDev&&(aB=aa),K.isDev||_||!ak||!ap||av||(0,k.d)(a.headers);let aC={...E,tree:H,pages:I,GlobalError:D(),handler:L,routeModule:K,__next_app__:J};X&&Y&&(0,o.setReferenceManifestsSingleton)({page:G,clientReferenceManifest:Y,serverActionsManifest:X,serverModuleMap:(0,q.createServerModuleMap)({serverActionsManifest:X})});let aD=a.method||"GET",aE=(0,g.getTracer)(),aF=aE.getActiveScopeSpan();try{let f=K.getVaryHeader(aa,ae);b.setHeader("Vary",f);let k=async(c,d)=>{let e=new l.NodeNextRequest(a),f=new l.NodeNextResponse(b);return K.render(e,f,d).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=aE.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==i.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${aD} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${aD} ${a.url}`)})},m=async({span:e,postponed:f,fallbackRouteParams:g})=>{let i={query:Q,params:R,page:ag,sharedContext:{buildId:P},serverComponentsHmrCache:(0,h.getRequestMeta)(a,"serverComponentsHmrCache"),fallbackRouteParams:g,renderOpts:{App:()=>null,Document:()=>null,pageConfig:{},ComponentMod:aC,Component:(0,j.T)(aC),params:R,routeModule:K,page:G,postponed:f,shouldWaitOnAllReady:az,serveStreamingMetadata:ax,supportsDynamicResponse:"string"==typeof f||ay,buildManifest:U,nextFontManifest:V,reactLoadableManifest:W,subresourceIntegrityManifest:Z,serverActionsManifest:X,clientReferenceManifest:Y,setIsrStatus:null==ac?void 0:ac.setIsrStatus,dir:c(9902).join(process.cwd(),K.relativeProjectDir),isDraftMode:_,isRevalidate:ak&&!f&&!av,botType:am,isOnDemandRevalidate:ah,isPossibleServerAction:aq,assetPrefix:ad.assetPrefix,nextConfigOutput:ad.output,crossOrigin:ad.crossOrigin,trailingSlash:ad.trailingSlash,previewProps:$.preview,deploymentId:ad.deploymentId,enableTainting:ad.experimental.taint,htmlLimitedBots:ad.htmlLimitedBots,devtoolSegmentExplorer:ad.experimental.devtoolSegmentExplorer,reactMaxHeadersLength:ad.reactMaxHeadersLength,multiZoneDraftMode:!1,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:ad.experimental.cacheLife,basePath:ad.basePath,serverActions:ad.experimental.serverActions,...as?{nextExport:!0,supportsDynamicResponse:!1,isStaticGeneration:!0,isRevalidate:!0,isDebugDynamicAccesses:as}:{},experimental:{isRoutePPREnabled:ar,expireTime:ad.expireTime,staleTimes:ad.experimental.staleTimes,cacheComponents:!!ad.experimental.cacheComponents,clientSegmentCache:!!ad.experimental.clientSegmentCache,clientParamParsing:!!ad.experimental.clientParamParsing,dynamicOnHover:!!ad.experimental.dynamicOnHover,inlineCss:!!ad.experimental.inlineCss,authInterrupts:!!ad.experimental.authInterrupts,clientTraceMetadata:ad.experimental.clientTraceMetadata||[]},waitUntil:d.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:()=>{},onInstrumentationRequestError:(b,c,d)=>K.onRequestError(a,b,d,ac),err:(0,h.getRequestMeta)(a,"invokeError"),dev:K.isDev}},l=await k(e,i),{metadata:m}=l,{cacheControl:n,headers:o={},fetchTags:p}=m;if(p&&(o[y.NEXT_CACHE_TAGS_HEADER]=p),a.fetchMetrics=m.fetchMetrics,ak&&(null==n?void 0:n.revalidate)===0&&!K.isDev&&!ar){let a=m.staticBailoutInfo,b=Object.defineProperty(Error(`Page changed from static to dynamic at runtime ${aa}${(null==a?void 0:a.description)?`, reason: ${a.description}`:""}
see more here https://nextjs.org/docs/messages/app-static-to-dynamic-error`),"__NEXT_ERROR_CODE",{value:"E132",enumerable:!1,configurable:!0});if(null==a?void 0:a.stack){let c=a.stack;b.stack=b.message+c.substring(c.indexOf("\n"))}throw b}return{value:{kind:v.CachedRouteKind.APP_PAGE,html:l,headers:o,rscData:m.flightData,postponed:m.postponed,status:m.statusCode,segmentData:m.segmentData},cacheControl:n}},o=async({hasResolved:c,previousCacheEntry:f,isRevalidating:g,span:i})=>{let j,k=!1===K.isDev,l=c||b.writableEnded;if(ah&&ab&&!f&&!N)return(null==ac?void 0:ac.render404)?await ac.render404(a,b):(b.statusCode=404,b.end("This page could not be found")),null;if(ai&&(j=(0,w.parseFallbackField)(ai.fallback)),j===w.FallbackMode.PRERENDER&&(0,u.isBot)(al)&&(!ar||an)&&(j=w.FallbackMode.BLOCKING_STATIC_RENDER),(null==f?void 0:f.isStale)===-1&&(ah=!0),ah&&(j!==w.FallbackMode.NOT_FOUND||f)&&(j=w.FallbackMode.BLOCKING_STATIC_RENDER),!N&&j!==w.FallbackMode.BLOCKING_STATIC_RENDER&&aB&&!l&&!_&&T&&(k||!aj)){let b;if((k||ai)&&j===w.FallbackMode.NOT_FOUND)throw new B.NoFallbackError;if(ar&&!ap){let c="string"==typeof(null==ai?void 0:ai.fallback)?ai.fallback:k?ag:null;if(b=await K.handleResponse({cacheKey:c,req:a,nextConfig:ad,routeKind:e.RouteKind.APP_PAGE,isFallback:!0,prerenderManifest:$,isRoutePPREnabled:ar,responseGenerator:async()=>m({span:i,postponed:void 0,fallbackRouteParams:k||at?(0,n.u)(ag):null}),waitUntil:d.waitUntil}),null===b)return null;if(b)return delete b.cacheControl,b}}let o=ah||g||!au?void 0:au;if(as&&void 0!==o)return{cacheControl:{revalidate:1,expire:void 0},value:{kind:v.CachedRouteKind.PAGES,html:x.default.EMPTY,pageData:{},headers:void 0,status:void 0}};let p=T&&ar&&((0,h.getRequestMeta)(a,"renderFallbackShell")||at)?(0,n.u)(af):null;return m({span:i,postponed:o,fallbackRouteParams:p})},p=async c=>{var f,g,i,j,k;let l,n=await K.handleResponse({cacheKey:aA,responseGenerator:a=>o({span:c,...a}),routeKind:e.RouteKind.APP_PAGE,isOnDemandRevalidate:ah,isRoutePPREnabled:ar,req:a,nextConfig:ad,prerenderManifest:$,waitUntil:d.waitUntil});if(_&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate"),K.isDev&&b.setHeader("Cache-Control","no-store, must-revalidate"),!n){if(aA)throw Object.defineProperty(Error("invariant: cache entry required but not generated"),"__NEXT_ERROR_CODE",{value:"E62",enumerable:!1,configurable:!0});return null}if((null==(f=n.value)?void 0:f.kind)!==v.CachedRouteKind.APP_PAGE)throw Object.defineProperty(Error(`Invariant app-page handler received invalid cache entry ${null==(i=n.value)?void 0:i.kind}`),"__NEXT_ERROR_CODE",{value:"E707",enumerable:!1,configurable:!0});let p="string"==typeof n.value.postponed;ak&&!av&&(!p||ao)&&(N||b.setHeader("x-nextjs-cache",ah?"REVALIDATED":n.isMiss?"MISS":n.isStale?"STALE":"HIT"),b.setHeader(t.NEXT_IS_PRERENDER_HEADER,"1"));let{value:q}=n;if(au)l={revalidate:0,expire:void 0};else if(N&&ap&&!ao&&ar)l={revalidate:0,expire:void 0};else if(!K.isDev)if(_)l={revalidate:0,expire:void 0};else if(ak){if(n.cacheControl)if("number"==typeof n.cacheControl.revalidate){if(n.cacheControl.revalidate<1)throw Object.defineProperty(Error(`Invalid revalidate configuration provided: ${n.cacheControl.revalidate} < 1`),"__NEXT_ERROR_CODE",{value:"E22",enumerable:!1,configurable:!0});l={revalidate:n.cacheControl.revalidate,expire:(null==(j=n.cacheControl)?void 0:j.expire)??ad.expireTime}}else l={revalidate:y.CACHE_ONE_YEAR,expire:void 0}}else b.getHeader("Cache-Control")||(l={revalidate:0,expire:void 0});if(n.cacheControl=l,"string"==typeof aw&&(null==q?void 0:q.kind)===v.CachedRouteKind.APP_PAGE&&q.segmentData){b.setHeader(t.NEXT_DID_POSTPONE_HEADER,"2");let c=null==(k=q.headers)?void 0:k[y.NEXT_CACHE_TAGS_HEADER];N&&ak&&c&&"string"==typeof c&&b.setHeader(y.NEXT_CACHE_TAGS_HEADER,c);let d=q.segmentData.get(aw);return void 0!==d?(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:x.default.fromStatic(d,t.RSC_CONTENT_TYPE_HEADER),cacheControl:n.cacheControl}):(b.statusCode=204,(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:x.default.EMPTY,cacheControl:n.cacheControl}))}let r=(0,h.getRequestMeta)(a,"onCacheEntry");if(r&&await r({...n,value:{...n.value,kind:"PAGE"}},{url:(0,h.getRequestMeta)(a,"initURL")}))return null;if(p&&au)throw Object.defineProperty(Error("Invariant: postponed state should not be present on a resume request"),"__NEXT_ERROR_CODE",{value:"E396",enumerable:!1,configurable:!0});if(q.headers){let a={...q.headers};for(let[c,d]of(N&&ak||delete a[y.NEXT_CACHE_TAGS_HEADER],Object.entries(a)))if(void 0!==d)if(Array.isArray(d))for(let a of d)b.appendHeader(c,a);else"number"==typeof d&&(d=d.toString()),b.appendHeader(c,d)}let s=null==(g=q.headers)?void 0:g[y.NEXT_CACHE_TAGS_HEADER];if(N&&ak&&s&&"string"==typeof s&&b.setHeader(y.NEXT_CACHE_TAGS_HEADER,s),!q.status||ap&&ar||(b.statusCode=q.status),!N&&q.status&&F.RedirectStatusCode[q.status]&&ap&&(b.statusCode=200),p&&b.setHeader(t.NEXT_DID_POSTPONE_HEADER,"1"),ap&&!_){if(void 0===q.rscData){if(q.postponed)throw Object.defineProperty(Error("Invariant: Expected postponed to be undefined"),"__NEXT_ERROR_CODE",{value:"E372",enumerable:!1,configurable:!0});return(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:q.html,cacheControl:av?{revalidate:0,expire:void 0}:n.cacheControl})}return(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:x.default.fromStatic(q.rscData,t.RSC_CONTENT_TYPE_HEADER),cacheControl:n.cacheControl})}let u=q.html;if(!p||N||ap)return(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:u,cacheControl:n.cacheControl});if(as)return u.push(new ReadableStream({start(a){a.enqueue(z.ENCODED_TAGS.CLOSED.BODY_AND_HTML),a.close()}})),(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:u,cacheControl:{revalidate:0,expire:void 0}});let w=new TransformStream;return u.push(w.readable),m({span:c,postponed:q.postponed,fallbackRouteParams:null}).then(async a=>{var b,c;if(!a)throw Object.defineProperty(Error("Invariant: expected a result to be returned"),"__NEXT_ERROR_CODE",{value:"E463",enumerable:!1,configurable:!0});if((null==(b=a.value)?void 0:b.kind)!==v.CachedRouteKind.APP_PAGE)throw Object.defineProperty(Error(`Invariant: expected a page response, got ${null==(c=a.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E305",enumerable:!1,configurable:!0});await a.value.html.pipeTo(w.writable)}).catch(a=>{w.writable.abort(a).catch(a=>{console.error("couldn't abort transformer",a)})}),(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:u,cacheControl:{revalidate:0,expire:void 0}})};if(!aF)return await aE.withPropagatedContext(a.headers,()=>aE.trace(i.BaseServerSpan.handleRequest,{spanName:`${aD} ${a.url}`,kind:g.SpanKind.SERVER,attributes:{"http.method":aD,"http.target":a.url}},p));await p(aF)}catch(b){throw b instanceof B.NoFallbackError||await K.onRequestError(a,b,{routerKind:"App Router",routePath:G,routeType:"render",revalidateReason:(0,f.c)({isRevalidate:ak,isOnDemandRevalidate:ah})},ac),b}}},9592:(a,b,c)=>{Promise.resolve().then(c.t.bind(c,4160,23)),Promise.resolve().then(c.t.bind(c,1603,23)),Promise.resolve().then(c.t.bind(c,8495,23)),Promise.resolve().then(c.t.bind(c,5170,23)),Promise.resolve().then(c.t.bind(c,7526,23)),Promise.resolve().then(c.t.bind(c,8922,23)),Promise.resolve().then(c.t.bind(c,9234,23)),Promise.resolve().then(c.t.bind(c,2263,23)),Promise.resolve().then(c.bind(c,2146))},9796:()=>{},9902:a=>{"use strict";a.exports=require("path")}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[586,361,413],()=>b(b.s=9530));module.exports=c})();